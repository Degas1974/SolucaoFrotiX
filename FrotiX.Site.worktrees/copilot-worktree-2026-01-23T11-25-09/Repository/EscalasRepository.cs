// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                                                                                   â•‘
// â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â•‘
// â•‘   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•— â•‘
// â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•‘
// â•‘   â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•‘
// â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•‘
// â•‘   â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•    â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•      â•šâ•â•â•â•â•â•  â•‘
// â•‘                                                                                                   â•‘
// â•‘   ğŸ“‹ ARQUIVO: EscalasRepository.cs                                                                â•‘
// â•‘   ğŸ“‚ LOCALIZAÃ‡ÃƒO: Repository/                                                                     â•‘
// â•‘   ğŸ“… DOCUMENTADO EM: 2026-01-14                                                                   â•‘
// â•‘   ğŸ‘¤ AUTOR: GitHub Copilot (DocumentaÃ§Ã£o INTRA-CODE)                                              â•‘
// â•‘   âš™ï¸ TECNOLOGIAS: C#, .NET 10, EF Core, Repository Pattern                                       â•‘
// â•‘                                                                                                   â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“– DESCRIÃ‡ÃƒO GERAL                                                                                â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘                                                                                                   â•‘
// â•‘ Arquivo consolidado contendo 11 REPOSITÃ“RIOS relacionados ao sistema de ESCALAS e GESTÃƒO DE      â•‘
// â•‘ MOTORISTAS. Este arquivo concentra toda a lÃ³gica de acesso a dados para o mÃ³dulo de escalas      â•‘
// â•‘ (scheduling) do sistema FrotiX, incluindo:                                                        â•‘
// â•‘                                                                                                   â•‘
// â•‘ 1. TipoServicoRepository        - Tipos de serviÃ§o (Escolta, Atendimento, EmergÃªncia...)         â•‘
// â•‘ 2. TurnoRepository              - Turnos de trabalho (Diurno, Noturno, Integral...)              â•‘
// â•‘ 3. VAssociadoRepository         - AssociaÃ§Ãµes Motorista â†” VeÃ­culo ativas/histÃ³ricas              â•‘
// â•‘ 4. EscalaDiariaRepository       - CORE: Escalas diÃ¡rias dos motoristas (COMPLEXO)                â•‘
// â•‘ 5. FolgaRecessoRepository       - Folgas e recessos dos motoristas                               â•‘
// â•‘ 6. FeriasRepository             - PerÃ­odos de fÃ©rias dos motoristas                              â•‘
// â•‘ 7. CoberturaFolgaRepository     - SubstituiÃ§Ãµes de motoristas em folga                           â•‘
// â•‘ 8. ObservacoesEscalaRepository  - ObservaÃ§Ãµes gerais nas escalas diÃ¡rias                         â•‘
// â•‘ 9. ViewEscalasCompletasRepository   - View consolidada (leitura) de escalas completas            â•‘
// â•‘ 10. ViewMotoristasVezRepository     - View "Motoristas da Vez" (menor nÂº viagens)                â•‘
// â•‘ 11. ViewStatusMotoristasRepository  - View status atual de todos motoristas                      â•‘
// â•‘                                                                                                   â•‘
// â•‘ Este arquivo implementa o padrÃ£o AGGREGATE ROOT: EscalaDiaria Ã© o coraÃ§Ã£o do sistema de escalas, â•‘
// â•‘ coordenando todos os demais conceitos (Turno, TipoServico, FolgaRecesso, Ferias, Coberturas).    â•‘
// â•‘                                                                                                   â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ¯ FUNCIONALIDADES PRINCIPAIS                                                                     â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘                                                                                                   â•‘
// â•‘ âœ… GestÃ£o de Escalas DiÃ¡rias                                                                      â•‘
// â•‘    â€¢ Criar/Editar/Excluir escalas para motoristas                                                â•‘
// â•‘    â€¢ ValidaÃ§Ã£o de conflitos de horÃ¡rios (motorista/veÃ­culo)                                      â•‘
// â•‘    â€¢ Controle de status (DisponÃ­vel/Em ServiÃ§o/Encerrado)                                        â•‘
// â•‘    â€¢ Consultas complexas com mÃºltiplos JOINs (ViewEscalasCompletas)                              â•‘
// â•‘                                                                                                   â•‘
// â•‘ âœ… Sistema de "Motoristas da Vez"                                                                 â•‘
// â•‘    â€¢ Listar motoristas disponÃ­veis no momento (turno ativo)                                      â•‘
// â•‘    â€¢ OrdenaÃ§Ã£o por menor nÃºmero de viagens (justiÃ§a distributiva)                                â•‘
// â•‘    â€¢ IntegraÃ§Ã£o com tabela Viagem para contagem em tempo real                                    â•‘
// â•‘                                                                                                   â•‘
// â•‘ âœ… Controle de Folgas, FÃ©rias e Coberturas                                                        â•‘
// â•‘    â€¢ Folgas/Recessos programados                                                                 â•‘
// â•‘    â€¢ PerÃ­odos de fÃ©rias com validaÃ§Ã£o de conflitos                                               â•‘
// â•‘    â€¢ Sistema de cobertura (motorista substituto)                                                 â•‘
// â•‘                                                                                                   â•‘
// â•‘ âœ… ValidaÃ§Ãµes de NegÃ³cio                                                                          â•‘
// â•‘    â€¢ Motorista disponÃ­vel (sem conflito + nÃ£o em fÃ©rias/folga)                                   â•‘
// â•‘    â€¢ VeÃ­culo disponÃ­vel (sem conflito de horÃ¡rios)                                               â•‘
// â•‘    â€¢ Turno existe e estÃ¡ ativo                                                                   â•‘
// â•‘    â€¢ ValidaÃ§Ã£o de sobreposiÃ§Ã£o de horÃ¡rios                                                       â•‘
// â•‘                                                                                                   â•‘
// â•‘ âœ… Consultas de VisualizaÃ§Ã£o (Views)                                                              â•‘
// â•‘    â€¢ ViewEscalasCompletas: JOIN completo com Motorista, VeÃ­culo, TipoServico, Turno             â•‘
// â•‘    â€¢ ViewMotoristasVez: PrÃ³ximos motoristas disponÃ­veis (menor fila)                             â•‘
// â•‘    â€¢ ViewStatusMotoristas: Status consolidado (Escala/FÃ©rias/Folga/Sem Escala)                   â•‘
// â•‘                                                                                                   â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Š ARQUITETURA DO SISTEMA DE ESCALAS                                                              â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘                                                                                                   â•‘
// â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
// â•‘  â”‚                          ESCALA DIÃRIA (Core)                                  â”‚              â•‘
// â•‘  â”‚  - Data, Hora InÃ­cio/Fim, Intervalo                                            â”‚              â•‘
// â•‘  â”‚  - Status (DisponÃ­vel, Em ServiÃ§o, Encerrado)                                  â”‚              â•‘
// â•‘  â”‚  - NumeroSaidas (contador de viagens realizadas)                               â”‚              â•‘
// â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
// â•‘            â”‚                                                        â”‚                            â•‘
// â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â•‘
// â•‘    â”‚  ASSOCIAÃ‡ÃƒO   â”‚                                      â”‚   TIPO SERVIÃ‡O     â”‚                â•‘
// â•‘    â”‚ Motorista <-> â”‚                                      â”‚   + TURNO          â”‚                â•‘
// â•‘    â”‚    VeÃ­culo    â”‚                                      â”‚   + REQUISITANTE   â”‚                â•‘
// â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â•‘
// â•‘            â”‚                                                                                     â•‘
// â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â•‘
// â•‘    â”‚        RESTRIÃ‡Ã•ES (FÃ©rias, Folgas, Coberturas)             â”‚                               â•‘
// â•‘    â”‚  - FeriasRepository: PerÃ­odo de fÃ©rias                     â”‚                               â•‘
// â•‘    â”‚  - FolgaRecessoRepository: Folgas programadas              â”‚                               â•‘
// â•‘    â”‚  - CoberturaFolgaRepository: Motorista substituto          â”‚                               â•‘
// â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â•‘
// â•‘                                                                                                   â•‘
// â•‘  FLUXO DE VALIDAÃ‡ÃƒO:                                                                             â•‘
// â•‘  1. MotoristaDisponivelAsync() â†’ Verifica conflitos de horÃ¡rio + fÃ©rias + folgas                 â•‘
// â•‘  2. VeiculoDisponivelAsync() â†’ Verifica conflito de horÃ¡rio do veÃ­culo                          â•‘
// â•‘  3. ExisteEscalaConflitanteAsync() â†’ Valida sobreposiÃ§Ã£o com outras escalas                     â•‘
// â•‘  4. Se OK, cria EscalaDiaria                                                                     â•‘
// â•‘                                                                                                   â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ âš ï¸ PADRÃ•ES E OBSERVAÃ‡Ã•ES                                                                          â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘                                                                                                   â•‘
// â•‘ âœ… BOA PRÃTICA: Update() NÃƒO chama SaveChanges()                                                 â•‘
// â•‘    â†’ Respeita o padrÃ£o Unit of Work (diferente de outros repositÃ³rios)                           â•‘
// â•‘    â†’ TransaÃ§Ãµes devem ser gerenciadas pelo Controller/Service                                    â•‘
// â•‘                                                                                                   â•‘
// â•‘ âœ… BOA PRÃTICA: Uso correto de AsTracking()                                                      â•‘
// â•‘    â†’ Apenas em Update() para rastreamento de mudanÃ§as                                            â•‘
// â•‘    â†’ Consultas usam AsNoTracking() implÃ­cito (performance)                                       â•‘
// â•‘                                                                                                   â•‘
// â•‘ âœ… BOA PRÃTICA: ValidaÃ§Ã£o antes de persistÃªncia                                                  â•‘
// â•‘    â†’ ExisteNomeServicoAsync(excludeId) permite validaÃ§Ã£o em ediÃ§Ã£o                               â•‘
// â•‘    â†’ VerificarConflitoHorarioAsync() impede sobreposiÃ§Ãµes                                        â•‘
// â•‘                                                                                                   â•‘
// â•‘ ğŸ” OBSERVAÃ‡ÃƒO: GetMotoristasVezAsync() - LÃ³gica Complexa                                         â•‘
// â•‘    â€¢ Busca escalas ativas no momento (DataEscala = Hoje, HoraInicio <= Agora, HoraFim >= Agora) â•‘
// â•‘    â€¢ Conta viagens realizadas HOJE na tabela Viagem                                              â•‘
// â•‘    â€¢ Ordena por MENOR nÃºmero de viagens (justiÃ§a distributiva)                                   â•‘
// â•‘    â€¢ Retorna TOP N motoristas (default = 5)                                                      â•‘
// â•‘    â†’ Usado em tela "Despachante" para alocar viagens                                             â•‘
// â•‘                                                                                                   â•‘
// â•‘ ğŸ” OBSERVAÃ‡ÃƒO: GetStatusMotoristasAsync() - Status Consolidado                                   â•‘
// â•‘    â€¢ JOIN com FolgaRecesso, Ferias, EscalaDiaria                                                 â•‘
// â•‘    â€¢ Prioridade: FÃ©rias > Folga > Escala > "Sem Escala"                                          â•‘
// â•‘    â€¢ Usado em dashboards e telas de gestÃ£o                                                       â•‘
// â•‘                                                                                                   â•‘
// â•‘ ğŸ” OBSERVAÃ‡ÃƒO: IncrementarContadorViagemAsync() - MÃ©todo Depreciado                              â•‘
// â•‘    â€¢ ComentÃ¡rio indica que contador agora vem da tabela Viagem                                   â•‘
// â•‘    â€¢ Mantido por compatibilidade (retorna true sempre)                                           â•‘
// â•‘    â†’ Refatorar: Remover mÃ©todo e atualizar chamadas                                              â•‘
// â•‘                                                                                                   â•‘
// â•‘ ğŸ“Š OBSERVAÃ‡ÃƒO: Views (Read-Only Repositories)                                                     â•‘
// â•‘    â€¢ ViewEscalasCompletasRepository: Escala completa (todos relacionamentos)                     â•‘
// â•‘    â€¢ ViewMotoristasVezRepository: Fila de motoristas disponÃ­veis                                 â•‘
// â•‘    â€¢ ViewStatusMotoristasRepository: Status atual de todos motoristas                            â•‘
// â•‘    â†’ Views sÃ£o mapeadas para entidades EF (sem tabela fÃ­sica, baseadas em queries)               â•‘
// â•‘                                                                                                   â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ”— RELACIONAMENTOS                                                                                â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘                                                                                                   â•‘
// â•‘ EscalaDiaria (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) VAssociado (Motorista + VeÃ­culo)                               â•‘
// â•‘ EscalaDiaria (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) TipoServico                                                    â•‘
// â•‘ EscalaDiaria (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Turno                                                          â•‘
// â•‘ EscalaDiaria (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Requisitante [Opcional]                                        â•‘
// â•‘                                                                                                   â•‘
// â•‘ FolgaRecesso (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Motorista                                                      â•‘
// â•‘ Ferias       (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Motorista                                                      â•‘
// â•‘                                                                                                   â•‘
// â•‘ CoberturaFolga (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Motorista (MotoristaFolgaId)                                  â•‘
// â•‘ CoberturaFolga (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Motorista (MotoristaCoberturaId) [Substituto]                 â•‘
// â•‘                                                                                                   â•‘
// â•‘ ObservacoesEscala â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [DataEscala] (associaÃ§Ã£o lÃ³gica por data)                       â•‘
// â•‘                                                                                                   â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘ ğŸ“Œ ESTRUTURA DO ARQUIVO (11 RepositÃ³rios)                                                         â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘                                                                                                   â•‘
// â•‘ 1ï¸âƒ£ TipoServicoRepository (Linhas ~15-60)           â†’ Tipos de serviÃ§o (dropdown + validaÃ§Ã£o)    â•‘
// â•‘ 2ï¸âƒ£ TurnoRepository (Linhas ~62-119)                 â†’ Turnos de trabalho (com validaÃ§Ã£o horÃ¡rio) â•‘
// â•‘ 3ï¸âƒ£ VAssociadoRepository (Linhas ~120-186)          â†’ AssociaÃ§Ãµes Motorista<->VeÃ­culo            â•‘
// â•‘ 4ï¸âƒ£ EscalaDiariaRepository (Linhas ~187-621) â­     â†’ CORE - Escalas diÃ¡rias (COMPLEXO)          â•‘
// â•‘ 5ï¸âƒ£ FolgaRecessoRepository (Linhas ~622-664)        â†’ Folgas e recessos                          â•‘
// â•‘ 6ï¸âƒ£ FeriasRepository (Linhas ~665-712)              â†’ FÃ©rias dos motoristas                       â•‘
// â•‘ 7ï¸âƒ£ CoberturaFolgaRepository (Linhas ~713-759)      â†’ SubstituiÃ§Ãµes de folga                      â•‘
// â•‘ 8ï¸âƒ£ ObservacoesEscalaRepository (Linhas ~760-797)   â†’ ObservaÃ§Ãµes nas escalas                     â•‘
// â•‘ 9ï¸âƒ£ ViewEscalasCompletasRepository (Linhas ~798-825) â†’ View consolidada (leitura)                 â•‘
// â•‘ ğŸ”Ÿ ViewMotoristasVezRepository (Linhas ~826-838)    â†’ View "motoristas da vez"                    â•‘
// â•‘ 1ï¸âƒ£1ï¸âƒ£ ViewStatusMotoristasRepository (Linhas ~839-854) â†’ View status atual                          â•‘
// â•‘                                                                                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Threading.Tasks;
using FrotiX.Data;
using FrotiX.Models;
using FrotiX.Repository.IRepository;
using Microsoft.AspNetCore.Mvc.Rendering;

namespace FrotiX.Repository
{
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // [REPOSITÃ“RIO 1/11] TIPO SERVIÃ‡O
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Gerencia os tipos de serviÃ§o que podem ser atribuÃ­dos Ã s escalas (Escolta, Atendimento, EmergÃªncia, etc.)
    // MÃ©todos: GetListForDropDown (ativos), Update, ExisteNomeServicoAsync (validaÃ§Ã£o unicidade)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public class TipoServicoRepository : Repository<TipoServico>, ITipoServicoRepository
    {
        private readonly FrotiXDbContext _db;

        public TipoServicoRepository(FrotiXDbContext db) : base(db)
        {
            _db = db;
        }

        public IEnumerable<SelectListItem> GetTipoServicoListForDropDown()
        {
            return _db.Set<TipoServico>()
                .Where(x => x.Ativo)
                .Select(i => new SelectListItem()
                {
                    Text = i.NomeServico,
                    Value = i.TipoServicoId.ToString()
                });
        }

        public void Update(TipoServico tipoServico)
        {
            var objFromDb = _db.Set<TipoServico>().AsTracking().FirstOrDefault(s => s.TipoServicoId == tipoServico.TipoServicoId);
            if (objFromDb != null)
            {
                objFromDb.NomeServico = tipoServico.NomeServico;
                objFromDb.Descricao = tipoServico.Descricao;
                objFromDb.Ativo = tipoServico.Ativo;
                objFromDb.DataAlteracao = DateTime.Now;
                objFromDb.UsuarioIdAlteracao = tipoServico.UsuarioIdAlteracao;
            }
        }

        public async Task<bool> ExisteNomeServicoAsync(string nomeServico, Guid? excludeId = null)
        {
            var query = _db.Set<TipoServico>().Where(x => x.NomeServico == nomeServico && x.Ativo);

            if (excludeId.HasValue)
            {
                query = query.Where(x => x.TipoServicoId != excludeId.Value);
            }

            return await query.AnyAsync();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // [REPOSITÃ“RIO 2/11] TURNO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Gerencia os turnos de trabalho (Diurno, Noturno, Integral, etc.) com controle de horÃ¡rios
    // MÃ©todos: GetListForDropDown, Update, GetTurnoByNomeAsync, VerificarConflitoHorarioAsync
    // ValidaÃ§Ã£o complexa: Detecta sobreposiÃ§Ã£o de horÃ¡rios entre turnos
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public class TurnoRepository : Repository<Turno>, ITurnoRepository
    {
        private readonly FrotiXDbContext _db;

        public TurnoRepository(FrotiXDbContext db) : base(db)
        {
            _db = db;
        }

        // [ETAPA] Busca turnos ATIVOS para popular dropdown
        // Retorna SelectListItem com TurnoId (GUID) e NomeTurno
        public IEnumerable<SelectListItem> GetTurnoListForDropDown()
        {
            return _db.Set<Turno>()
                .Where(x => x.Ativo)
                .Select(i => new SelectListItem()
                {
                    Text = i.NomeTurno,
                    Value = i.TurnoId.ToString()
                });
        }

        // [ETAPA] Atualiza turno existente
        // Atualiza campos de horÃ¡rio (HoraInicio, HoraFim) + campos de controle
        // NÃƒO chama SaveChanges() (respeita Unit of Work)
        public void Update(Turno turno)
        {
            var objFromDb = _db.Set<Turno>().AsTracking().FirstOrDefault(s => s.TurnoId == turno.TurnoId);
            if (objFromDb != null)
            {
                objFromDb.NomeTurno = turno.NomeTurno;
                objFromDb.HoraInicio = turno.HoraInicio;
                objFromDb.HoraFim = turno.HoraFim;
                objFromDb.Ativo = turno.Ativo;
                objFromDb.DataAlteracao = DateTime.Now;
                objFromDb.UsuarioIdAlteracao = turno.UsuarioIdAlteracao;
            }
        }

        // [ETAPA] Busca turno por nome (apenas ativos)
        // Usado para validaÃ§Ã£o de nomes duplicados ou busca rÃ¡pida
        public async Task<Turno> GetTurnoByNomeAsync(string nomeTurno)
        {
            return await _db.Set<Turno>()
                .FirstOrDefaultAsync(x => x.NomeTurno == nomeTurno && x.Ativo);
        }

        // [ETAPA] Verifica se hÃ¡ conflito de horÃ¡rio entre turnos
        // LÃ³gica complexa: Detecta sobreposiÃ§Ã£o de intervalos de tempo
        // Casos: InÃ­cio dentro do turno OU Fim dentro do turno OU Envolvendo completamente
        // ParÃ¢metro excludeId: Ignora o prÃ³prio turno (validaÃ§Ã£o em ediÃ§Ã£o)
        public async Task<bool> VerificarConflitoHorarioAsync(TimeSpan horaInicio, TimeSpan horaFim, Guid? excludeId = null)
        {
            var query = _db.Set<Turno>().Where(x => x.Ativo);

            if (excludeId.HasValue)
            {
                query = query.Where(x => x.TurnoId != excludeId.Value);
            }

            return await query.AnyAsync(x =>
                (horaInicio >= x.HoraInicio && horaInicio < x.HoraFim) ||
                (horaFim > x.HoraInicio && horaFim <= x.HoraFim) ||
                (horaInicio <= x.HoraInicio && horaFim >= x.HoraFim)
            );
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // [REPOSITÃ“RIO 3/11] VASSOCIADO (AssociaÃ§Ã£o Motorista â†” VeÃ­culo)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Gerencia associaÃ§Ãµes entre motoristas e veÃ­culos (ativas e histÃ³ricas)
    // MÃ©todos: Update, GetAssociacaoAtivaAsync, GetHistoricoAssociacoesAsync, MotoristaTemVeiculoAsync
    // Controla DataInicio, DataFim, Ativo para rastreamento temporal das associaÃ§Ãµes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public class VAssociadoRepository : Repository<VAssociado>, IVAssociadoRepository
    {
        private readonly FrotiXDbContext _db;

        public VAssociadoRepository(FrotiXDbContext db) : base(db)
        {
            _db = db;
        }

        // [ETAPA] Atualiza associaÃ§Ã£o Motorista-VeÃ­culo
        // Campos: MotoristaId, VeiculoId, DataInicio, DataFim, Observacoes, Ativo
        // NÃƒO chama SaveChanges() (respeita Unit of Work)
        public void Update(VAssociado vAssociado)
        {
            var objFromDb = _db.Set<VAssociado>().AsTracking().FirstOrDefault(s => s.AssociacaoId == vAssociado.AssociacaoId);
            if (objFromDb != null)
            {
                objFromDb.MotoristaId = vAssociado.MotoristaId;
                objFromDb.VeiculoId = vAssociado.VeiculoId;
                objFromDb.DataInicio = vAssociado.DataInicio;
                objFromDb.DataFim = vAssociado.DataFim;
                objFromDb.Observacoes = vAssociado.Observacoes;
                objFromDb.Ativo = vAssociado.Ativo;
                objFromDb.DataAlteracao = DateTime.Now;
                objFromDb.UsuarioIdAlteracao = vAssociado.UsuarioIdAlteracao;
            }
        }

        // [ETAPA] Busca associaÃ§Ã£o ATIVA de um motorista
        // Include: Motorista + Veiculo (eager loading)
        // Filtros: Ativo=true, DataFim=null OU DataFim > Agora (associaÃ§Ã£o vigente)
        public async Task<VAssociado> GetAssociacaoAtivaAsync(Guid motoristaId)
        {
            return await _db.Set<VAssociado>()
                .Include(x => x.Motorista)
                .Include(x => x.Veiculo)
                .FirstOrDefaultAsync(x => x.MotoristaId == motoristaId &&
                                         x.Ativo &&
                                         (x.DataFim == null || x.DataFim > DateTime.Now));
        }

        // [ETAPA] Busca HISTÃ“RICO completo de associaÃ§Ãµes de um motorista
        // Include: Motorista + Veiculo
        // OrdenaÃ§Ã£o: DataInicio DESC (mais recentes primeiro)
        public async Task<List<VAssociado>> GetHistoricoAssociacoesAsync(Guid motoristaId)
        {
            return await _db.Set<VAssociado>()
                .Include(x => x.Motorista)
                .Include(x => x.Veiculo)
                .Where(x => x.MotoristaId == motoristaId)
                .OrderByDescending(x => x.DataInicio)
                .ToListAsync();
        }

        // [ETAPA] Verifica se motorista tem veÃ­culo associado em uma data especÃ­fica
        // ValidaÃ§Ã£o: Ativo=true, DataInicio <= data, DataFim=null OU DataFim > data
        // Retorna bool (usado em validaÃ§Ãµes de negÃ³cio)
        public async Task<bool> MotoristaTemVeiculoAsync(Guid motoristaId, DateTime data)
        {
            return await _db.Set<VAssociado>()
                .AnyAsync(x => x.MotoristaId == motoristaId &&
                              x.Ativo &&
                              x.DataInicio <= data &&
                              (x.DataFim == null || x.DataFim > data));
        }

        // [ETAPA] Busca associaÃ§Ã£o VIGENTE em uma data especÃ­fica
        // Similar a GetAssociacaoAtivaAsync, mas permite consultar datas histÃ³ricas
        // Include: Motorista + Veiculo
        public async Task<VAssociado> GetAssociacaoPorDataAsync(Guid motoristaId, DateTime data)
        {
            return await _db.Set<VAssociado>()
                .Include(x => x.Motorista)
                .Include(x => x.Veiculo)
                .FirstOrDefaultAsync(x => x.MotoristaId == motoristaId &&
                                         x.Ativo &&
                                         x.DataInicio <= data &&
                                         (x.DataFim == null || x.DataFim > data));
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // [REPOSITÃ“RIO 4/11] ESCALA DIÃRIA â­ CORE DO SISTEMA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš ï¸ REPOSITÃ“RIO MAIS COMPLEXO DO ARQUIVO (435 LINHAS)
    // Gerencia as escalas diÃ¡rias dos motoristas - coraÃ§Ã£o do sistema de scheduling
    //
    // MÃ‰TODOS PRINCIPAIS:
    // â€¢ Update() - AtualizaÃ§Ã£o de escala
    // â€¢ GetEscalasCompletasAsync() - Escalas do dia com JOIN completo (Motorista+VeÃ­culo+TipoServico+Turno)
    // â€¢ GetEscalaCompletaByIdAsync() - Escala individual completa
    // â€¢ GetEscalasPorFiltroAsync() - Busca avanÃ§ada com mÃºltiplos filtros
    // â€¢ GetMotoristasVezAsync() - ALGORITMO DE FILA: Motoristas disponÃ­veis ordenados por menor nÂº viagens
    // â€¢ GetStatusMotoristasAsync() - Status consolidado (JOIN com Folgas, FÃ©rias, Escalas)
    // â€¢ AtualizarStatusMotoristaAsync() - Altera status (DisponÃ­vel/Em ServiÃ§o/Encerrado)
    // â€¢ MotoristaDisponivelAsync() - Valida disponibilidade (horÃ¡rio + fÃ©rias + folgas)
    // â€¢ VeiculoDisponivelAsync() - Valida disponibilidade do veÃ­culo
    // â€¢ ExisteEscalaConflitanteAsync() - Detecta conflitos de horÃ¡rio
    // â€¢ GetEscalasPorPeriodoAsync() - Consulta por intervalo de datas
    // â€¢ GetEscalasMotoristaAsync() - Escalas de um motorista especÃ­fico
    //
    // REGRAS DE NEGÃ“CIO:
    // 1. Motorista sÃ³ pode ter 1 escala ativa por horÃ¡rio (sem sobreposiÃ§Ã£o)
    // 2. VeÃ­culo sÃ³ pode ter 1 escala ativa por horÃ¡rio
    // 3. Motorista em fÃ©rias/folga nÃ£o pode ter escala
    // 4. Status: "DisponÃ­vel" â†’ "Em ServiÃ§o" â†’ "Encerrado"
    // 5. NumeroSaidas: Contador de viagens realizadas (vem da tabela Viagem)
    //
    // VIEWS CONSTRUÃDAS:
    // â€¢ ViewEscalasCompletas: JOIN Motorista+VeÃ­culo+TipoServico+Turno+Requisitante
    // â€¢ ViewMotoristasVez: Algoritmo de fila (menor NumeroSaidas + HoraInicio)
    // â€¢ ViewStatusMotoristas: Status consolidado com prioridade (FÃ©rias > Folga > Escala)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public class EscalaDiariaRepository : Repository<EscalaDiaria>, IEscalaDiariaRepository
    {
        private readonly FrotiXDbContext _db;

        public EscalaDiariaRepository(FrotiXDbContext db) : base(db)
        {
            _db = db;
        }

        // [ETAPA] Atualiza escala diÃ¡ria existente
        // Campos atualizados: AssociaÃ§Ã£o, Tipo ServiÃ§o, Turno, HorÃ¡rios (InÃ­cio/Fim/Intervalo),
        //                     LotaÃ§Ã£o, NumeroSaidas, Status, Requisitante, ObservaÃ§Ãµes
        // NÃƒO chama SaveChanges() (respeita Unit of Work)
        public void Update(EscalaDiaria escalaDiaria)
        {
            var objFromDb = _db.Set<EscalaDiaria>().AsTracking().FirstOrDefault(s => s.EscalaDiaId == escalaDiaria.EscalaDiaId);
            if (objFromDb != null)
            {
                objFromDb.AssociacaoId = escalaDiaria.AssociacaoId;
                objFromDb.TipoServicoId = escalaDiaria.TipoServicoId;
                objFromDb.TurnoId = escalaDiaria.TurnoId;
                objFromDb.DataEscala = escalaDiaria.DataEscala;
                objFromDb.HoraInicio = escalaDiaria.HoraInicio;
                objFromDb.HoraFim = escalaDiaria.HoraFim;
                objFromDb.HoraIntervaloInicio = escalaDiaria.HoraIntervaloInicio;
                objFromDb.HoraIntervaloFim = escalaDiaria.HoraIntervaloFim;
                objFromDb.Lotacao = escalaDiaria.Lotacao;
                objFromDb.NumeroSaidas = escalaDiaria.NumeroSaidas;
                objFromDb.StatusMotorista = escalaDiaria.StatusMotorista;
                objFromDb.RequisitanteId = escalaDiaria.RequisitanteId;
                objFromDb.Observacoes = escalaDiaria.Observacoes;
                objFromDb.DataAlteracao = DateTime.Now;
                objFromDb.UsuarioIdAlteracao = escalaDiaria.UsuarioIdAlteracao;
            }
        }

        // [ETAPA] Busca escalas completas do dia com JOIN COMPLETO
        // JOIN: EscalaDiaria â†’ VAssociado â†’ Motorista + ViewVeiculos + TipoServico + Turno + Requisitante
        // ConstrÃ³i ViewModel ViewEscalasCompletas com TODOS os dados necessÃ¡rios para exibiÃ§Ã£o
        // Filtro: data (default = Hoje), Ativo = true
        // OrdenaÃ§Ã£o: HoraInicio ASC
        // FormataÃ§Ã£o: TimeSpan â†’ string "hh:mm"
        public async Task<List<ViewEscalasCompletas>> GetEscalasCompletasAsync(DateTime? data = null)
        {
            var dataEscala = data ?? DateTime.Today;

            var query = from ed in _db.Set<EscalaDiaria>()
                        join va in _db.Set<VAssociado>() on ed.AssociacaoId equals va.AssociacaoId into vaLeft
                        from va in vaLeft.DefaultIfEmpty()
                        join m in _db.Set<Motorista>() on va.MotoristaId equals m.MotoristaId into mLeft
                        from m in mLeft.DefaultIfEmpty()
                        join v in _db.Set<ViewVeiculos>() on va.VeiculoId equals v.VeiculoId into vLeft
                        from v in vLeft.DefaultIfEmpty()
                        join ts in _db.Set<TipoServico>() on ed.TipoServicoId equals ts.TipoServicoId
                        join t in _db.Set<Turno>() on ed.TurnoId equals t.TurnoId
                        join r in _db.Set<Requisitante>() on ed.RequisitanteId equals r.RequisitanteId into rLeft
                        from r in rLeft.DefaultIfEmpty()
                        where ed.DataEscala == dataEscala && ed.Ativo
                        orderby ed.HoraInicio
                        select new ViewEscalasCompletas
                        {
                            EscalaDiaId = ed.EscalaDiaId,
                            DataEscala = ed.DataEscala,
                            HoraInicio = ed.HoraInicio.ToString(@"hh\:mm"),
                            HoraFim = ed.HoraFim.ToString(@"hh\:mm"),
                            HoraIntervaloInicio = ed.HoraIntervaloInicio.HasValue ?
                                ed.HoraIntervaloInicio.Value.ToString(@"hh\:mm") : null,
                            HoraIntervaloFim = ed.HoraIntervaloFim.HasValue ?
                                ed.HoraIntervaloFim.Value.ToString(@"hh\:mm") : null,
                            NumeroSaidas = ed.NumeroSaidas,
                            StatusMotorista = ed.StatusMotorista,
                            Lotacao = ed.Lotacao,
                            Observacoes = ed.Observacoes,
                            MotoristaId = m.MotoristaId,
                            NomeMotorista = m.Nome,
                            Ponto = m.Ponto,
                            CPF = m.CPF,
                            CNH = m.CNH,
                            Celular01 = m.Celular01,
                            Foto = m.Foto,
                            VeiculoId = v.VeiculoId,
                            VeiculoDescricao = v.Descricao,
                            Placa = v.Placa,
                            Modelo = v.MarcaModelo,
                            TipoServicoId = ts.TipoServicoId,
                            NomeServico = ts.NomeServico,
                            TurnoId = t.TurnoId,
                            NomeTurno = t.NomeTurno,
                            RequisitanteId = r.RequisitanteId,
                            NomeRequisitante = r.Nome
                        };

            return await query.ToListAsync();
        }

        public async Task<ViewEscalasCompletas> GetEscalaCompletaByIdAsync(Guid id)
        {
            var query = from ed in _db.Set<EscalaDiaria>()
                        join va in _db.Set<VAssociado>() on ed.AssociacaoId equals va.AssociacaoId into vaLeft
                        from va in vaLeft.DefaultIfEmpty()
                        join m in _db.Set<Motorista>() on va.MotoristaId equals m.MotoristaId into mLeft
                        from m in mLeft.DefaultIfEmpty()
                        join v in _db.Set<ViewVeiculos>() on va.VeiculoId equals v.VeiculoId into vLeft
                        from v in vLeft.DefaultIfEmpty()
                        join ts in _db.Set<TipoServico>() on ed.TipoServicoId equals ts.TipoServicoId
                        join t in _db.Set<Turno>() on ed.TurnoId equals t.TurnoId
                        join r in _db.Set<Requisitante>() on ed.RequisitanteId equals r.RequisitanteId into rLeft
                        from r in rLeft.DefaultIfEmpty()
                        where ed.EscalaDiaId == id && ed.Ativo
                        select new ViewEscalasCompletas
                        {
                            EscalaDiaId = ed.EscalaDiaId,
                            DataEscala = ed.DataEscala,
                            HoraInicio = ed.HoraInicio.ToString(@"hh\:mm"),
                            HoraFim = ed.HoraFim.ToString(@"hh\:mm"),
                            HoraIntervaloInicio = ed.HoraIntervaloInicio.HasValue ?
                                ed.HoraIntervaloInicio.Value.ToString(@"hh\:mm") : null,
                            HoraIntervaloFim = ed.HoraIntervaloFim.HasValue ?
                                ed.HoraIntervaloFim.Value.ToString(@"hh\:mm") : null,
                            NumeroSaidas = ed.NumeroSaidas,
                            StatusMotorista = ed.StatusMotorista,
                            Lotacao = ed.Lotacao,
                            Observacoes = ed.Observacoes,
                            MotoristaId = m.MotoristaId,
                            NomeMotorista = m.Nome,
                            Ponto = m.Ponto,
                            CPF = m.CPF,
                            CNH = m.CNH,
                            Celular01 = m.Celular01,
                            Foto = m.Foto,
                            VeiculoId = v.VeiculoId,
                            VeiculoDescricao = v.Descricao,
                            Placa = v.Placa,
                            Modelo = v.MarcaModelo,
                            TipoServicoId = ts.TipoServicoId,
                            NomeServico = ts.NomeServico,
                            TurnoId = t.TurnoId,
                            NomeTurno = t.NomeTurno,
                            RequisitanteId = r.RequisitanteId,
                            NomeRequisitante = r.Nome
                        };

            return await query.FirstOrDefaultAsync();
        }

        // [ETAPA] Busca escalas por FILTROS AVANÃ‡ADOS
        // Filtros possÃ­veis: DataFiltro, TipoServicoId, Lotacao, VeiculoId, MotoristaId, StatusMotorista, TurnoId, TextoPesquisa
        // TextoPesquisa busca em: Nome Motorista, Placa VeÃ­culo, ObservaÃ§Ãµes
        // JOIN completo: EscalaDiaria â†’ VAssociado â†’ Motorista + ViewVeiculos + TipoServico + Turno + Requisitante
        // OrdenaÃ§Ã£o: DataEscala ASC, HoraInicio ASC
        public async Task<List<ViewEscalasCompletas>> GetEscalasPorFiltroAsync(FiltroEscalaViewModel filtro)
        {
            var query = from ed in _db.Set<EscalaDiaria>()
                        join va in _db.Set<VAssociado>() on ed.AssociacaoId equals va.AssociacaoId into vaLeft
                        from va in vaLeft.DefaultIfEmpty()
                        join m in _db.Set<Motorista>() on va.MotoristaId equals m.MotoristaId into mLeft
                        from m in mLeft.DefaultIfEmpty()
                        join v in _db.Set<ViewVeiculos>() on va.VeiculoId equals v.VeiculoId into vLeft
                        from v in vLeft.DefaultIfEmpty()
                        join ts in _db.Set<TipoServico>() on ed.TipoServicoId equals ts.TipoServicoId
                        join t in _db.Set<Turno>() on ed.TurnoId equals t.TurnoId
                        join r in _db.Set<Requisitante>() on ed.RequisitanteId equals r.RequisitanteId into rLeft
                        from r in rLeft.DefaultIfEmpty()
                        where ed.Ativo
                        select new { ed, va, m, v, ts, t, r };

            // Aplicar filtros
            if (filtro.DataFiltro.HasValue)
                query = query.Where(x => x.ed.DataEscala == filtro.DataFiltro.Value);

            if (filtro.TipoServicoId.HasValue)
                query = query.Where(x => x.ed.TipoServicoId == filtro.TipoServicoId.Value);

            if (!string.IsNullOrWhiteSpace(filtro.Lotacao))
                query = query.Where(x => x.ed.Lotacao == filtro.Lotacao);

            if (filtro.VeiculoId.HasValue)
                query = query.Where(x => x.v != null && x.v.VeiculoId == filtro.VeiculoId.Value);

            if (filtro.MotoristaId.HasValue)
                query = query.Where(x => x.m != null && x.m.MotoristaId == filtro.MotoristaId.Value);

            if (!string.IsNullOrWhiteSpace(filtro.StatusMotorista))
                query = query.Where(x => x.ed.StatusMotorista == filtro.StatusMotorista);

            if (filtro.TurnoId.HasValue)
                query = query.Where(x => x.ed.TurnoId == filtro.TurnoId.Value);

            if (!string.IsNullOrWhiteSpace(filtro.TextoPesquisa))
            {
                query = query.Where(x =>
                    (x.m != null && x.m.Nome.Contains(filtro.TextoPesquisa)) ||
                    (x.v != null && x.v.Placa.Contains(filtro.TextoPesquisa)) ||
                    (x.ed.Observacoes != null && x.ed.Observacoes.Contains(filtro.TextoPesquisa))
                );
            }

            var result = await query.OrderBy(x => x.ed.DataEscala)
                                   .ThenBy(x => x.ed.HoraInicio)
                                   .Select(x => new ViewEscalasCompletas
                                   {
                                       EscalaDiaId = x.ed.EscalaDiaId,
                                       DataEscala = x.ed.DataEscala,
                                       HoraInicio = x.ed.HoraInicio.ToString(@"hh\:mm"),
                                       HoraFim = x.ed.HoraFim.ToString(@"hh\:mm"),
                                       NumeroSaidas = x.ed.NumeroSaidas,
                                       StatusMotorista = x.ed.StatusMotorista,
                                       Lotacao = x.ed.Lotacao,
                                       Observacoes = x.ed.Observacoes,
                                       MotoristaId = x.m.MotoristaId,
                                       NomeMotorista = x.m.Nome,
                                       Ponto = x.m.Ponto,
                                       VeiculoId = x.v.VeiculoId,
                                       VeiculoDescricao = x.v.Descricao,
                                       Placa = x.v.Placa,
                                       NomeServico = x.ts.NomeServico,
                                       NomeTurno = x.t.NomeTurno,
                                       NomeRequisitante = x.r.Nome
                                   }).ToListAsync();

            return result;
        }

        // [ETAPA] â­ ALGORITMO DE FILA: Busca motoristas disponÃ­veis no momento
        // LÃ“GICA COMPLEXA:
        // 1. Busca escalas do DIA de hoje com Status = "DisponÃ­vel"
        // 2. Filtra apenas motoristas cujo turno estÃ¡ ATIVO no momento (HoraInicio <= Agora <= HoraFim)
        // 3. Conta viagens realizadas HOJE na tabela Viagem (Status = "Realizada", DataFinalizacao = Hoje)
        // 4. Ordena por MENOR nÃºmero de viagens (justiÃ§a distributiva)
        // 5. Desempate: HoraInicio ASC (quem comeÃ§ou primeiro)
        // 6. Retorna TOP N motoristas (default = 5)
        // Usado em: Tela Despachante para alocar viagens
        public async Task<List<ViewMotoristasVez>> GetMotoristasVezAsync(int quantidade = 5)
        {
            var hoje = DateTime.Today;
            var agora = DateTime.Now.TimeOfDay;

            // Primeiro, buscar contagem de viagens realizadas hoje
            var viagensHoje = await _db.Set<Viagem>()
                .Where(v => v.DataFinalizacao == hoje && v.Status == "Realizada")
                .GroupBy(v => v.MotoristaId)
                .Select(g => new
                {
                    MotoristaId = g.Key,
                    NumeroViagens = g.Count()
                })
                .ToListAsync();

            var query = from ed in _db.Set<EscalaDiaria>()
                        join va in _db.Set<VAssociado>() on ed.AssociacaoId equals va.AssociacaoId
                        join m in _db.Set<Motorista>() on va.MotoristaId equals m.MotoristaId
                        join v in _db.Set<ViewVeiculos>() on va.VeiculoId equals v.VeiculoId into vLeft
                        from v in vLeft.DefaultIfEmpty()
                        where ed.DataEscala == hoje &&
                              ed.Ativo &&
                              ed.StatusMotorista == "DisponÃ­vel" &&
                              ed.HoraInicio <= agora &&
                              ed.HoraFim >= agora
                        select new
                        {
                            ed,
                            m,
                            v
                        };

            var escalas = await query.ToListAsync();

            var resultado = escalas
                .Select(x => new ViewMotoristasVez
                {
                    MotoristaId = x.m.MotoristaId,
                    NomeMotorista = x.m.Nome,
                    Ponto = x.m.Ponto,
                    Foto = x.m.Foto,
                    DataEscala = x.ed.DataEscala,
                    NumeroSaidas = viagensHoje.FirstOrDefault(vh => vh.MotoristaId == x.m.MotoristaId)?.NumeroViagens ?? 0,
                    StatusMotorista = x.ed.StatusMotorista,
                    Lotacao = x.ed.Lotacao,
                    VeiculoDescricao = x.v?.Descricao,
                    Placa = x.v?.Placa,
                    HoraInicio = x.ed.HoraInicio.ToString(@"hh\:mm"),
                    HoraFim = x.ed.HoraFim.ToString(@"hh\:mm")
                })
                .OrderBy(x => x.NumeroSaidas)
                .ThenBy(x => x.HoraInicio)
                .Take(quantidade)
                .ToList();

            return resultado;
        }

        // [ETAPA] â­ STATUS CONSOLIDADO: Busca status atual de TODOS os motoristas
        // JOIN COMPLEXO com priorizaÃ§Ã£o de status:
        // 1. Motorista ativo (Status = true)
        // 2. JOIN LEFT com VAssociado ativo (veÃ­culo atual)
        // 3. JOIN LEFT com ViewVeiculos (dados do veÃ­culo)
        // 4. JOIN LEFT com EscalaDiaria do DIA (DataEscala = Hoje, Ativo = true)
        // 5. JOIN LEFT com FolgaRecesso (Hoje >= DataInicio AND Hoje <= DataFim, Ativo = true)
        // 6. JOIN LEFT com Ferias (Hoje >= DataInicio AND Hoje <= DataFim, Ativo = true)
        //
        // PRIORIZAÃ‡ÃƒO DE STATUS (lÃ³gica ternÃ¡ria aninhada):
        // FÃ©rias > FolgaRecesso.Tipo > EscalaDiaria.StatusMotorista > "Sem Escala"
        //
        // Usado em: Dashboards, telas de gestÃ£o, relatÃ³rios
        public async Task<List<ViewStatusMotoristas>> GetStatusMotoristasAsync()
        {
            var hoje = DateTime.Today;

            var query = from m in _db.Set<Motorista>()
                        join va in _db.Set<VAssociado>() on m.MotoristaId equals va.MotoristaId into vaLeft
                        from va in vaLeft.Where(x => x.Ativo).DefaultIfEmpty()
                        join v in _db.Set<ViewVeiculos>() on va.VeiculoId equals v.VeiculoId into vLeft
                        from v in vLeft.DefaultIfEmpty()
                        join ed in _db.Set<EscalaDiaria>() on va.AssociacaoId equals ed.AssociacaoId into edLeft
                        from ed in edLeft.Where(x => x.DataEscala == hoje && x.Ativo).DefaultIfEmpty()
                        join fr in _db.Set<FolgaRecesso>() on m.MotoristaId equals fr.MotoristaId into frLeft
                        from fr in frLeft.Where(x => hoje >= x.DataInicio && hoje <= x.DataFim && x.Ativo).DefaultIfEmpty()
                        join f in _db.Set<Ferias>() on m.MotoristaId equals f.MotoristaId into fLeft
                        from f in fLeft.Where(x => hoje >= x.DataInicio && hoje <= x.DataFim && x.Ativo).DefaultIfEmpty()
                        where m.Status == true
                        select new ViewStatusMotoristas
                        {
                            MotoristaId = m.MotoristaId,
                            Nome = m.Nome,
                            Ponto = m.Ponto,
                            StatusAtual = f != null ? "FÃ©rias" :
                                        fr != null ? fr.Tipo :
                                        ed != null ? ed.StatusMotorista :
                                        "Sem Escala",
                            DataEscala = ed.DataEscala,
                            NumeroSaidas = ed != null ? ed.NumeroSaidas : 0,
                            Placa = v.Placa,
                            Veiculo = v.Descricao
                        };

            return await query.ToListAsync();
        }

        // [ETAPA] Atualiza status de um motorista em sua escala do dia
        // Busca escala por MotoristaId (via Associacao) + Data + Ativo = true
        // Altera StatusMotorista (ex: "DisponÃ­vel" â†’ "Em ServiÃ§o" â†’ "Encerrado")
        // âš ï¸ USA .Update() E SaveChanges (EXCEÃ‡ÃƒO ao padrÃ£o Unit of Work)
        // Retorna: true se encontrou e atualizou, false se nÃ£o encontrou escala
        public async Task<bool> AtualizarStatusMotoristaAsync(Guid motoristaId, string novoStatus, DateTime? data = null)
        {
            var dataEscala = data ?? DateTime.Today;

            var escala = await _db.Set<EscalaDiaria>().AsTracking()
                .AsTracking().FirstOrDefaultAsync(ed =>
                    ed.Associacao.MotoristaId == motoristaId &&
                    ed.DataEscala == dataEscala &&
                    ed.Ativo);

            if (escala != null)
            {
                escala.StatusMotorista = novoStatus;
                escala.DataAlteracao = DateTime.Now;
                _db.Update(escala);
                return true;
            }

            return false;
        }

        // [ETAPA] âš ï¸ MÃ‰TODO DEPRECIADO - Incrementa contador de viagens
        // OBSERVAÃ‡ÃƒO NO CÃ“DIGO: "Este mÃ©todo nÃ£o Ã© mais necessÃ¡rio pois o contador agora vem da tabela Viagem"
        // Mantido por compatibilidade (retorna true sempre)
        // TODO: Remover mÃ©todo e atualizar chamadas no cÃ³digo
        public async Task<bool> IncrementarContadorViagemAsync(Guid motoristaId, DateTime data)
        {
            // Este mÃ©todo nÃ£o Ã© mais necessÃ¡rio pois o contador agora vem da tabela Viagem
            // Mantido por compatibilidade
            return await Task.FromResult(true);
        }

        // [ETAPA] â­ VALIDAÃ‡ÃƒO COMPLEXA: Verifica se motorista estÃ¡ disponÃ­vel para escala
        // TRÃŠS VERIFICAÃ‡Ã•ES:
        // 1. NÃ£o hÃ¡ conflito de horÃ¡rio com outras escalas do motorista (sobreposiÃ§Ã£o)
        // 2. Motorista nÃ£o estÃ¡ em Folga/Recesso no dia
        // 3. Motorista nÃ£o estÃ¡ em FÃ©rias no dia
        // Retorna: true se disponÃ­vel, false se indisponÃ­vel
        public async Task<bool> MotoristaDisponivelAsync(Guid motoristaId, DateTime data, TimeSpan horaInicio, TimeSpan horaFim)
        {
            // Verificar se nÃ£o hÃ¡ conflito com outras escalas
            var temConflito = await _db.Set<EscalaDiaria>()
                .AnyAsync(ed =>
                    ed.Associacao.MotoristaId == motoristaId &&
                    ed.DataEscala == data &&
                    ed.Ativo &&
                    ((horaInicio >= ed.HoraInicio && horaInicio < ed.HoraFim) ||
                     (horaFim > ed.HoraInicio && horaFim <= ed.HoraFim) ||
                     (horaInicio <= ed.HoraInicio && horaFim >= ed.HoraFim))
                );

            // Verificar se nÃ£o estÃ¡ em folga/fÃ©rias
            var estaEmFolga = await _db.Set<FolgaRecesso>()
                .AnyAsync(f => f.MotoristaId == motoristaId &&
                              f.DataInicio <= data &&
                              f.DataFim >= data &&
                              f.Ativo);

            var estaEmFerias = await _db.Set<Ferias>()
                .AnyAsync(f => f.MotoristaId == motoristaId &&
                               f.DataInicio <= data &&
                               f.DataFim >= data &&
                               f.Ativo);

            return !temConflito && !estaEmFolga && !estaEmFerias;
        }

        // [ETAPA] Verifica se VEÃCULO estÃ¡ disponÃ­vel no horÃ¡rio
        // LÃ³gica de sobreposiÃ§Ã£o: Mesma lÃ³gica de Turno
        // - horaInicio dentro do perÃ­odo existente
        // - horaFim dentro do perÃ­odo existente
        // - Novo perÃ­odo envolve completamente o existente
        // Retorna: true se disponÃ­vel, false se conflito
        public async Task<bool> VeiculoDisponivelAsync(Guid veiculoId, DateTime data, TimeSpan horaInicio, TimeSpan horaFim)
        {
            var temConflito = await _db.Set<EscalaDiaria>()
                .AnyAsync(ed =>
                    ed.Associacao.VeiculoId == veiculoId &&
                    ed.DataEscala == data &&
                    ed.Ativo &&
                    ((horaInicio >= ed.HoraInicio && horaInicio < ed.HoraFim) ||
                     (horaFim > ed.HoraInicio && horaFim <= ed.HoraFim) ||
                     (horaInicio <= ed.HoraInicio && horaFim >= ed.HoraFim))
                );

            return !temConflito;
        }

        // [ETAPA] Verifica se existe conflito de horÃ¡rio para um motorista em uma data
        // Similar a MotoristaDisponivelAsync, mas foca apenas em conflito de escalas (sem fÃ©rias/folgas)
        // ParÃ¢metro excludeId: Ignora a prÃ³pria escala (validaÃ§Ã£o em ediÃ§Ã£o)
        // Usado em: ValidaÃ§Ã£o antes de criar/editar escala
        public async Task<bool> ExisteEscalaConflitanteAsync(Guid motoristaId, DateTime data, TimeSpan horaInicio, TimeSpan horaFim, Guid? excludeId = null)
        {
            var query = _db.Set<EscalaDiaria>()
                .Where(ed =>
                    ed.Associacao.MotoristaId == motoristaId &&
                    ed.DataEscala == data &&
                    ed.Ativo);

            if (excludeId.HasValue)
            {
                query = query.Where(ed => ed.EscalaDiaId != excludeId.Value);
            }

            return await query.AnyAsync(ed =>
                (horaInicio >= ed.HoraInicio && horaInicio < ed.HoraFim) ||
                (horaFim > ed.HoraInicio && horaFim <= ed.HoraFim) ||
                (horaInicio <= ed.HoraInicio && horaFim >= ed.HoraFim)
            );
        }

        // [ETAPA] Busca escalas em um intervalo de datas
        // Include: Associacao â†’ Motorista + Veiculo, TipoServico, Turno, Requisitante
        // Filtros: DataEscala >= dataInicio AND DataEscala <= dataFim, Ativo = true
        // OrdenaÃ§Ã£o: DataEscala ASC, HoraInicio ASC
        // Usado em: RelatÃ³rios, exportaÃ§Ãµes, consultas de histÃ³rico
        public async Task<List<EscalaDiaria>> GetEscalasPorPeriodoAsync(DateTime dataInicio, DateTime dataFim)
        {
            return await _db.Set<EscalaDiaria>()
                .Include(x => x.Associacao)
                    .ThenInclude(a => a.Motorista)
                .Include(x => x.Associacao)
                    .ThenInclude(a => a.Veiculo)
                .Include(x => x.TipoServico)
                .Include(x => x.Turno)
                .Include(x => x.Requisitante)
                .Where(x => x.DataEscala >= dataInicio &&
                           x.DataEscala <= dataFim &&
                           x.Ativo)
                .OrderBy(x => x.DataEscala)
                .ThenBy(x => x.HoraInicio)
                .ToListAsync();
        }

        // [ETAPA] Busca escalas de um motorista especÃ­fico (todas ou de uma data)
        // Include: Associacao â†’ Motorista + Veiculo, TipoServico, Turno, Requisitante
        // Filtro: MotoristaId (via Associacao), Data (opcional), Ativo = true
        // OrdenaÃ§Ã£o: DataEscala ASC, HoraInicio ASC
        public async Task<List<EscalaDiaria>> GetEscalasMotoristaAsync(Guid motoristaId, DateTime? data = null)
        {
            var query = _db.Set<EscalaDiaria>()
                .Include(x => x.Associacao)
                    .ThenInclude(a => a.Motorista)
                .Include(x => x.Associacao)
                    .ThenInclude(a => a.Veiculo)
                .Include(x => x.TipoServico)
                .Include(x => x.Turno)
                .Include(x => x.Requisitante)
                .Where(x => x.Associacao.MotoristaId == motoristaId && x.Ativo);

            if (data.HasValue)
            {
                query = query.Where(x => x.DataEscala == data.Value);
            }

            return await query.OrderBy(x => x.DataEscala)
                             .ThenBy(x => x.HoraInicio)
                             .ToListAsync();
        }
    }

    public class FolgaRecessoRepository : Repository<FrotiX.Models.FolgaRecesso>, IFolgaRecessoRepository
    {
        private readonly FrotiXDbContext _db;
        public FolgaRecessoRepository(FrotiXDbContext db) : base(db) => _db = db;

        // [ETAPA] Atualiza folga/recesso existente
        // Campos: MotoristaId, Tipo, DataInicio, DataFim, Ativo, Observacoes
        // NÃƒO chama SaveChanges() (respeita Unit of Work)
        public void Update(FrotiX.Models.FolgaRecesso folgaRecesso)
        {
            var set = _db.Set<FrotiX.Models.FolgaRecesso>();
            var obj = set.AsTracking().FirstOrDefault(x => x.FolgaId == folgaRecesso.FolgaId);
            if (obj != null)
            {
                obj.MotoristaId = folgaRecesso.MotoristaId;
                obj.Tipo = folgaRecesso.Tipo;
                obj.DataInicio = folgaRecesso.DataInicio;
                obj.DataFim = folgaRecesso.DataFim;
                obj.Ativo = folgaRecesso.Ativo;
                obj.Observacoes = folgaRecesso.Observacoes;
                obj.DataAlteracao = DateTime.Now;
                obj.UsuarioIdAlteracao = folgaRecesso.UsuarioIdAlteracao;
            }
        }

        // [ETAPA] Busca HISTÃ“RICO de folgas/recessos de um motorista
        // OrdenaÃ§Ã£o: DataInicio DESC (mais recentes primeiro)
        public Task<List<FrotiX.Models.FolgaRecesso>> GetFolgasPorMotoristaAsync(Guid motoristaId)
            => _db.Set<FrotiX.Models.FolgaRecesso>()
                  .Where(x => x.MotoristaId == motoristaId)
                  .OrderByDescending(x => x.DataInicio)
                  .ToListAsync();

        // [ETAPA] Busca folgas/recessos ATIVOS em uma data especÃ­fica
        // Filtro: Ativo = true, DataInicio <= data <= DataFim
        public Task<List<FrotiX.Models.FolgaRecesso>> GetFolgasAtivasAsync(DateTime data)
            => _db.Set<FrotiX.Models.FolgaRecesso>()
                  .Where(x => x.Ativo && x.DataInicio <= data && x.DataFim >= data)
                  .ToListAsync();

        // [ETAPA] Verifica se motorista estÃ¡ em folga/recesso em uma data
        // ValidaÃ§Ã£o usada em: CriaÃ§Ã£o de escalas (motorista em folga nÃ£o pode ter escala)
        public Task<bool> MotoristaEstaEmFolgaAsync(Guid motoristaId, DateTime data)
            => _db.Set<FrotiX.Models.FolgaRecesso>()
                  .AnyAsync(x => x.MotoristaId == motoristaId && x.Ativo && x.DataInicio <= data && x.DataFim >= data);

        // [ETAPA] Busca a folga/recesso ATIVA de um motorista em uma data
        // Retorna: Objeto FolgaRecesso ou null
        public Task<FrotiX.Models.FolgaRecesso> GetFolgaAtivaMotoristaAsync(Guid motoristaId, DateTime data)
            => _db.Set<FrotiX.Models.FolgaRecesso>()
                  .FirstOrDefaultAsync(x => x.MotoristaId == motoristaId && x.Ativo && x.DataInicio <= data && x.DataFim >= data);
    }

    public class FeriasRepository : Repository<FrotiX.Models.Ferias>, IFeriasRepository
    {
        private readonly FrotiXDbContext _db;
        public FeriasRepository(FrotiXDbContext db) : base(db) => _db = db;

        // [ETAPA] Atualiza perÃ­odo de fÃ©rias existente
        // Campos: MotoristaId, DataInicio, DataFim, Ativo, Observacoes
        // NÃƒO chama SaveChanges() (respeita Unit of Work)
        public void Update(FrotiX.Models.Ferias ferias)
        {
            var set = _db.Set<FrotiX.Models.Ferias>();
            var obj = set.AsTracking().FirstOrDefault(x => x.FeriasId == ferias.FeriasId);
            if (obj != null)
            {
                obj.MotoristaId = ferias.MotoristaId;
                obj.DataInicio = ferias.DataInicio;
                obj.DataFim = ferias.DataFim;
                obj.Ativo = ferias.Ativo;
                obj.Observacoes = ferias.Observacoes;
                obj.DataAlteracao = DateTime.Now;
                obj.UsuarioIdAlteracao = ferias.UsuarioIdAlteracao;
            }
        }

        public Task<List<FrotiX.Models.Ferias>> GetFeriasPorMotoristaAsync(Guid motoristaId)
            => _db.Set<FrotiX.Models.Ferias>()
                  .Where(x => x.MotoristaId == motoristaId)
                  .OrderByDescending(x => x.DataInicio)
                  .ToListAsync();

        public Task<List<FrotiX.Models.Ferias>> GetFeriasAtivasAsync(DateTime data)
            => _db.Set<FrotiX.Models.Ferias>()
                  .Where(x => x.Ativo && x.DataInicio <= data && x.DataFim >= data)
                  .ToListAsync();

        public Task<bool> MotoristaEstaEmFeriasAsync(Guid motoristaId, DateTime data)
            => _db.Set<FrotiX.Models.Ferias>()
                  .AnyAsync(x => x.MotoristaId == motoristaId && x.Ativo && x.DataInicio <= data && x.DataFim >= data);

        public Task<FrotiX.Models.Ferias> GetFeriasAtivaMotoristaAsync(Guid motoristaId, DateTime data)
            => _db.Set<FrotiX.Models.Ferias>()
                  .FirstOrDefaultAsync(x => x.MotoristaId == motoristaId && x.Ativo && x.DataInicio <= data && x.DataFim >= data);

        // Sem a coluna de substituto no modelo, retornamos as fÃ©rias ativas na data.
        public Task<List<FrotiX.Models.Ferias>> GetFeriasSemSubstitutoAsync(DateTime data)
            => _db.Set<FrotiX.Models.Ferias>()
                  .Where(x => x.Ativo && x.DataInicio <= data && x.DataFim >= data)
                  .ToListAsync();
    }

    public class CoberturaFolgaRepository : Repository<FrotiX.Models.CoberturaFolga>, ICoberturaFolgaRepository
    {
        private readonly FrotiXDbContext _db;
        public CoberturaFolgaRepository(FrotiXDbContext db) : base(db) => _db = db;

        public void Update(FrotiX.Models.CoberturaFolga coberturaFolga)
        {
            var set = _db.Set<FrotiX.Models.CoberturaFolga>();
            var obj = set.AsTracking().FirstOrDefault(x => x.CoberturaId == coberturaFolga.CoberturaId);
            if (obj != null)
            {
                obj.MotoristaFolgaId = coberturaFolga.MotoristaFolgaId;
                obj.MotoristaCoberturaId = coberturaFolga.MotoristaCoberturaId;
                obj.DataInicio = coberturaFolga.DataInicio;
                obj.DataFim = coberturaFolga.DataFim;
                obj.Ativo = coberturaFolga.Ativo;
                obj.Observacoes = coberturaFolga.Observacoes;
                obj.DataAlteracao = DateTime.Now;
                obj.UsuarioIdAlteracao = coberturaFolga.UsuarioIdAlteracao;
            }
        }

        public Task<List<FrotiX.Models.CoberturaFolga>> GetCoberturasAtivasAsync(DateTime data)
            => _db.Set<FrotiX.Models.CoberturaFolga>()
                  .Where(x => x.Ativo && x.DataInicio <= data && x.DataFim >= data)
                  .ToListAsync();

        public Task<FrotiX.Models.CoberturaFolga> GetCoberturaPorMotoristaAsync(Guid motoristaCoberturaId, DateTime data)
            => _db.Set<FrotiX.Models.CoberturaFolga>()
                  .FirstOrDefaultAsync(x => x.MotoristaCoberturaId == motoristaCoberturaId && x.Ativo && x.DataInicio <= data && x.DataFim >= data);

        public Task<bool> MotoristaEstaCobridoAsync(Guid motoristaFolgaId, DateTime data)
            => _db.Set<FrotiX.Models.CoberturaFolga>()
                  .AnyAsync(x => x.MotoristaFolgaId == motoristaFolgaId && x.Ativo && x.DataInicio <= data && x.DataFim >= data);

        public Task<FrotiX.Models.CoberturaFolga> GetCoberturaMotoristaAsync(Guid motoristaFolgaId, DateTime data)
            => _db.Set<FrotiX.Models.CoberturaFolga>()
                  .FirstOrDefaultAsync(x => x.MotoristaFolgaId == motoristaFolgaId && x.Ativo && x.DataInicio <= data && x.DataFim >= data);

        public Task<List<FrotiX.Models.CoberturaFolga>> GetHistoricoCoberturas(Guid motoristaId)
            => _db.Set<FrotiX.Models.CoberturaFolga>()
                  .Where(x => x.MotoristaFolgaId == motoristaId || x.MotoristaCoberturaId == motoristaId)
                  .OrderByDescending(x => x.DataInicio)
                  .ToListAsync();
    }

    public class ObservacoesEscalaRepository : Repository<FrotiX.Models.ObservacoesEscala>, IObservacoesEscalaRepository
    {
        private readonly FrotiXDbContext _db;
        public ObservacoesEscalaRepository(FrotiXDbContext db) : base(db) => _db = db;

        public void Update(FrotiX.Models.ObservacoesEscala observacaoEscala)
        {
            var set = _db.Set<FrotiX.Models.ObservacoesEscala>();
            var obj = set.AsTracking().FirstOrDefault(x => x.ObservacaoId == observacaoEscala.ObservacaoId);
            if (obj != null)
            {
                obj.DataEscala = observacaoEscala.DataEscala;
                obj.Titulo = observacaoEscala.Titulo;
                obj.Descricao = observacaoEscala.Descricao;
                obj.Ativo = observacaoEscala.Ativo;
                obj.DataAlteracao = DateTime.Now;
                obj.UsuarioIdAlteracao = observacaoEscala.UsuarioIdAlteracao;
            }
        }

        public Task<List<FrotiX.Models.ObservacoesEscala>> GetObservacoesAtivasAsync(DateTime data)
            => _db.Set<FrotiX.Models.ObservacoesEscala>()
                  .Where(x => x.Ativo && x.DataEscala.Date == data.Date)
                  .OrderBy(x => x.DataEscala)
                  .ToListAsync();

        public Task<List<FrotiX.Models.ObservacoesEscala>> GetObservacoesPorPeriodoAsync(DateTime dataInicio, DateTime dataFim)
            => _db.Set<FrotiX.Models.ObservacoesEscala>()
                  .Where(x => x.DataEscala.Date >= dataInicio.Date && x.DataEscala.Date <= dataFim.Date)
                  .OrderBy(x => x.DataEscala)
                  .ToListAsync();

        public Task<bool> ExisteObservacaoAsync(DateTime data, string titulo)
            => _db.Set<FrotiX.Models.ObservacoesEscala>()
                  .AnyAsync(x => x.DataEscala.Date == data.Date && x.Titulo == titulo);
    }

    public class ViewEscalasCompletasRepository : Repository<FrotiX.Models.ViewEscalasCompletas>, IViewEscalasCompletasRepository
    {
        private readonly FrotiXDbContext _db;
        public ViewEscalasCompletasRepository(FrotiXDbContext db) : base(db) => _db = db;

        // [ETAPA] Busca TODAS as escalas completas (view materializada)
        // OrdenaÃ§Ã£o: DataEscala ASC, HoraInicio ASC
        public Task<List<FrotiX.Models.ViewEscalasCompletas>> GetAllAsync()
            => _db.Set<FrotiX.Models.ViewEscalasCompletas>()
                  .OrderBy(x => x.DataEscala)
                  .ThenBy(x => x.HoraInicio)
                  .ToListAsync();

        // [ETAPA] Busca escalas completas com PAGINAÃ‡ÃƒO e filtro genÃ©rico
        // Retorna: (Items, TotalCount) para construir paginaÃ§Ã£o no frontend
        public async Task<(List<FrotiX.Models.ViewEscalasCompletas> Items, int TotalCount)> GetPaginatedAsync(
            Expression<Func<FrotiX.Models.ViewEscalasCompletas, bool>> filter,
            int page,
            int pageSize)
        {
            var query = _db.Set<FrotiX.Models.ViewEscalasCompletas>().Where(filter);
            var total = await query.CountAsync();
            var items = await query
                .OrderBy(x => x.DataEscala)
                .ThenBy(x => x.HoraInicio)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();
            return (items, total);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // [REPOSITÃ“RIO 10/11] VIEW MOTORISTAS VEZ (Read-Only)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // View: Motoristas disponÃ­veis ordenados por menor nÃºmero de viagens (fila de atendimento)
    // MÃ©todo: GetTopMotoristasAsync (retorna TOP N)
    // OrdenaÃ§Ã£o: NumeroSaidas ASC, HoraInicio ASC
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public class ViewMotoristasVezRepository : Repository<FrotiX.Models.ViewMotoristasVez>, IViewMotoristasVezRepository
    {
        private readonly FrotiXDbContext _db;
        public ViewMotoristasVezRepository(FrotiXDbContext db) : base(db) => _db = db;

        // [ETAPA] Busca TOP N motoristas da vez (menor nÃºmero de viagens)
        // Usado em: Tela Despachante para distribuir viagens
        public Task<List<FrotiX.Models.ViewMotoristasVez>> GetTopMotoristasAsync(int quantidade = 5)
            => _db.Set<FrotiX.Models.ViewMotoristasVez>()
                  .OrderBy(x => x.NumeroSaidas)
                  .ThenBy(x => x.HoraInicio)
                  .Take(quantidade)
                  .ToListAsync();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // [REPOSITÃ“RIO 11/11] VIEW STATUS MOTORISTAS (Read-Only)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // View: Status consolidado de todos motoristas (FÃ©rias/Folga/Escala/Sem Escala)
    // MÃ©todos: GetStatusAtualizadoAsync, GetStatusMotoristaAsync (individual)
    // PriorizaÃ§Ã£o de status: FÃ©rias > Folga > Escala > "Sem Escala"
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public class ViewStatusMotoristasRepository : Repository<FrotiX.Models.ViewStatusMotoristas>, IViewStatusMotoristasRepository
    {
        private readonly FrotiXDbContext _db;
        public ViewStatusMotoristasRepository(FrotiXDbContext db) : base(db) => _db = db;

        // [ETAPA] Busca status atualizado de TODOS os motoristas
        // Usado em: Dashboards, telas de gestÃ£o
        // OrdenaÃ§Ã£o: Nome ASC
        public Task<List<FrotiX.Models.ViewStatusMotoristas>> GetStatusAtualizadoAsync()
            => _db.Set<FrotiX.Models.ViewStatusMotoristas>()
                  .OrderBy(x => x.Nome)
                  .ToListAsync();

        // [ETAPA] Busca status de UM motorista especÃ­fico
        // Retorna: ViewStatusMotoristas ou null
        public Task<FrotiX.Models.ViewStatusMotoristas> GetStatusMotoristaAsync(Guid motoristaId)
            => _db.Set<FrotiX.Models.ViewStatusMotoristas>()
                  .FirstOrDefaultAsync(x => x.MotoristaId == motoristaId);
    }
}
