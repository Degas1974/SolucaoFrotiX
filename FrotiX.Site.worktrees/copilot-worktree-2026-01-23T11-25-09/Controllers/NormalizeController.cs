using FrotiX.Services;
using FrotiX.TextNormalization;
using Microsoft.AspNetCore.Mvc;
using System;
using System.Threading.Tasks;

namespace FrotiX.Controllers
{
    /*
    *  #################################################################################################
    *  #                                                                                               #
    *  #   โโโโโโโโโโโโโโโ  โโโโโโโ โโโโโโโโโโโโโโโ  โโโ    โโโโโโโ  โโโโโโโ โโโโโโโ  โโโโโโโ          #
    *  #   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ          #
    *  #   โโโโโโ  โโโโโโโโโโโ   โโโ   โโโ   โโโ โโโโโโ      โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโ          #
    *  #   โโโโโโ  โโโโโโโโโโโ   โโโ   โโโ   โโโ โโโโโโ     โโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโ          #
    *  #   โโโ     โโโ  โโโโโโโโโโโโ   โโโ   โโโโโโโ โโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ          #
    *  #   โโโ     โโโ  โโโ โโโโโโโ    โโโ   โโโโโโ  โโโ    โโโโโโโโ โโโโโโโ โโโโโโโโ โโโโโโโ           #
    *  #                                                                                               #
    *  #   PROJETO: FROTIX - SOLUรรO INTEGRADA DE GESTรO DE FROTAS                                     #
    *  #   MODULO:  NORMALIZAรรO DE DADOS IA MOTOR (BERT/ONNX)                                         #
    *  #   DATA:    2026 (Modernizaรงรฃo FrotiX 2026)                                                   #
    *  #                                                                                               #
    *  #################################################################################################
    */

    /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    /// โ ๐ NOME: NormalizeController                                                โ
    /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
    /// โ ๐ DESCRIรรO:                                                                โ
    /// โ    API de IA local para normalizaรงรฃo de descriรงรตes tรฉcnicas.                 โ
    /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
    /// โ ๐ ESCOPO: API REST                                                          โ
    /// โ    โข Rota base: /api/Normalize                                              โ
    /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    [ApiController]
    [Route("api/[controller]")]
    public class NormalizeController : ControllerBase
    {
        private readonly NormalizationService _normalizer;
        private readonly ILogService _log;

        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        /// โ ๐ NOME: NormalizeController (Construtor)                                  โ
        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
        /// โ ๐ DESCRIรรO:                                                                โ
        /// โ    Inicializa o motor de normalizaรงรฃo semรขntica FrotiX.                      โ
        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
        /// โ ๐ฅ PARรMETROS:                                                               โ
        /// โ    โข normalizer (NormalizationService): Serviรงo de normalizaรงรฃo.            โ
        /// โ    โข log (ILogService): Serviรงo de log centralizado.                         โ
        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        public NormalizeController(NormalizationService normalizer, ILogService log)
        {
            try
            {
                _normalizer = normalizer;
                _log = log;
            }
            catch (Exception error)
            {
                Alerta.TratamentoErroComLinha("NormalizeController.cs", "NormalizeController", error);
            }
        }

        public record NormalizeRequest(string Text);

        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        /// โ ๐ NOME: Post (POST)                                                      โ
        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
        /// โ ๐ DESCRIรรO:                                                                โ
        /// โ    Recebe texto bruto e retorna versรฃo normalizada pela IA.                 โ
        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
        /// โ ๐ฅ PARรMETROS:                                                               โ
        /// โ    โข body (NormalizeRequest): Texto a normalizar.                            โ
        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
        /// โ ๐ค RETORNO:                                                                  โ
        /// โ    โข ActionResult<string>: Texto normalizado.                               โ
        /// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        [HttpPost]
        public async Task<ActionResult<string>> Post([FromBody] NormalizeRequest body)
        {
            try
            {
                // [VALIDACAO] Verifica payload e texto.
                if (body is null || string.IsNullOrWhiteSpace(body.Text))
                {
                    _log.Warning("NormalizeController.Post: Requisiรงรฃo sem texto.");
                    return BadRequest("Text is required.");
                }

                // [IA] Normaliza texto via serviรงo.
                var result = await _normalizer.NormalizeAsync(body.Text);
                
                // [LOG] Registro de sucesso.
                _log.Info($"NormalizeController.Post: Texto normalizado com sucesso. Entrada: {body.Text} | Saรญda: {result}");
                
                // [RETORNO] Texto normalizado.
                return Ok(result);
            }
            catch (Exception error)
            {
                _log.Error("NormalizeController.Post", error);
                Alerta.TratamentoErroComLinha("NormalizeController.cs" , "Post" , error);
                return StatusCode(500 , "Erro ao normalizar texto");
            }
        }
    }
}
