/* > ---------------------------------------------------------------------------------------
 > ğŸ“„ **CARD DE IDENTIDADE DO ARQUIVO**
 > ---------------------------------------------------------------------------------------
 > ğŸ†” **Nome:** ConfirmarSenha.cshtml.cs
 > ğŸ“ **Local:** Areas/Identity/Pages
 > â“ **Por que existo?** PÃ¡gina de confirmaÃ§Ã£o de senha para usuÃ¡rios nÃ£o autenticados.
 > ğŸ”— **RelevÃ¢ncia:** Alta
 > ---------------------------------------------------------------------------------------
 */

using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Logging;
using FrotiX.Models;
using FrotiX.Helpers;
using System;
using Microsoft.AspNetCore.Mvc.ModelBinding;

using FrotiX.Services;

namespace FrotiX.Areas.Identity.Pages
{
    [AllowAnonymous]
    public class ConfirmarSenha : PageModel
    {
        /*
        ### ğŸ“¡ SAÃDA (Quem este arquivo chama?)
        * **InjeÃ§Ã£o de DependÃªncia:** `_signInManager`, `_logger`, `_log`
        * **AutenticaÃ§Ã£o:** `HttpContext.SignOutAsync`
        * **Helper:** `Url.Content`

        ### ğŸ§² ENTRADA (Quem pode chamar este arquivo?)
        * **MÃ©todos PÃºblicos:** `OnGetAsync`, `OnPostAsync`
        */
        private readonly SignInManager<IdentityUser> _signInManager;
        private readonly ILogger<ConfirmarSenhaModel> _logger;
        private readonly ILogService _log;

        /// <summary>
        /// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        /// â•‘ ğŸ“Œ NOME: ConfirmarSenha                                                     â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“ DESCRIÃ‡ÃƒO:                                                                â•‘
        /// â•‘    Inicializa dependÃªncias da pÃ¡gina de confirmaÃ§Ã£o de senha.                â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ¯ IMPORTÃ‚NCIA PARA A SOLUÃ‡ÃƒO:                                              â•‘
        /// â•‘    Prepara o fluxo de validaÃ§Ã£o de senha para usuÃ¡rios nÃ£o autenticados.     â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“¥ PARÃ‚METROS:                                                               â•‘
        /// â•‘    â€¢ signInManager (SignInManager<IdentityUser>): gerenciador de login.      â•‘
        /// â•‘    â€¢ logger (ILogger<ConfirmarSenhaModel>): logger da pÃ¡gina.                â•‘
        /// â•‘    â€¢ log (ILogService): serviÃ§o de log FrotiX.                               â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ“¤ RETORNO:                                                                  â•‘
        /// â•‘    â€¢ void: constrÃ³i o PageModel.                                             â•‘
        /// â•‘    â€¢ Significado: prepara o fluxo de confirmaÃ§Ã£o.                            â•‘
        /// â•‘    â€¢ Consumidor: runtime do ASP.NET Core.                                    â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“ FUNÃ‡Ã•ES QUE CHAMA:                                                        â•‘
        /// â•‘    â€¢ Nenhuma (apenas inicializaÃ§Ã£o de dependÃªncias).                          â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ“² CHAMADA POR:                                                              â•‘
        /// â•‘    â€¢ DI container do ASP.NET Core.                                           â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ”— ESCOPO: INTERNA ao mÃ³dulo                                                 â•‘
        /// â•‘    â€¢ Arquivos relacionados: ConfirmarSenha.cshtml                            â•‘
        /// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        /// </summary>
        public ConfirmarSenha(SignInManager<IdentityUser> signInManager, ILogger<ConfirmarSenhaModel> logger, ILogService log)
        {
            _signInManager = signInManager;
            _logger = logger;
            _log = log;
        }

        [BindProperty]
        public ConfirmarSenhaModel Input { get; set; }

        public IList<AuthenticationScheme> ExternalLogins { get; set; }

        public string ReturnUrl { get; set; }

        [TempData]
        public string ErrorMessage { get; set; }

        public class ConfirmarSenhaModel
        {
            [Required(ErrorMessage = "A senha Ã© obrigatÃ³ria!")]
            [DataType(DataType.Password)]
            public string Password { get; set; }

            [Compare(nameof(Password), ErrorMessage = "A confirmaÃ§Ã£o da senha nÃ£o combina com a senha!")]
            [DataType(DataType.Password)]
            public string ConfirmacaoPassword { get; set; }
        }

        /// <summary>
        /// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        /// â•‘ ğŸ“Œ NOME: OnGetAsync                                                          â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“ DESCRIÃ‡ÃƒO:                                                                â•‘
        /// â•‘    Inicializa a pÃ¡gina de confirmaÃ§Ã£o, limpando logins externos.             â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ¯ IMPORTÃ‚NCIA PARA A SOLUÃ‡ÃƒO:                                              â•‘
        /// â•‘    Garante um estado limpo de autenticaÃ§Ã£o antes de confirmar a senha.       â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“¥ PARÃ‚METROS:                                                               â•‘
        /// â•‘    â€¢ returnUrl (string): URL de retorno apÃ³s a aÃ§Ã£o (opcional).              â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ“¤ RETORNO:                                                                  â•‘
        /// â•‘    â€¢ Task: operaÃ§Ã£o assÃ­ncrona sem retorno explÃ­cito.                        â•‘
        /// â•‘    â€¢ Significado: prepara o GET da pÃ¡gina.                                   â•‘
        /// â•‘    â€¢ Consumidor: pipeline Razor Pages.                                       â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“ FUNÃ‡Ã•ES QUE CHAMA:                                                        â•‘
        /// â•‘    â€¢ HttpContext.SignOutAsync() â†’ limpa cookies externos.                    â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ“² CHAMADA POR:                                                              â•‘
        /// â•‘    â€¢ Roteamento Razor Pages (GET /Identity/ConfirmarSenha).                  â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ”— ESCOPO: INTERNA ao mÃ³dulo                                                 â•‘
        /// â•‘    â€¢ Arquivos relacionados: ConfirmarSenha.cshtml                            â•‘
        /// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        /// </summary>
        public async Task OnGetAsync(string returnUrl = null)
        {
            try
            {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ”¹ BLOCO: InicializaÃ§Ã£o e Limpeza
                // Exibe mensagens de erro anteriores e limpa sessÃ£o externa
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    ModelState.AddModelError(string.Empty, ErrorMessage);
                }

                returnUrl = returnUrl ?? Url.Content("~/");

                // [REGRA] Limpar cookie externo para garantir login limpo
                await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);

                ReturnUrl = returnUrl;
            }
            catch (Exception error)
            {
                // ğŸ›¡ï¸ Blindagem Padronizada FrotiX
                _log.Error("Erro ao carregar tela de ConfirmarSenha", error);
                Alerta.TratamentoErroComLinha("ConfirmarSenha.cshtml.cs", "OnGetAsync", error);
            }
        }


        /// <summary>
        /// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        /// â•‘ ğŸ“Œ NOME: OnPostAsync                                                         â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“ DESCRIÃ‡ÃƒO:                                                                â•‘
        /// â•‘    Processa a confirmaÃ§Ã£o de senha submetida pelo formulÃ¡rio.                â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ¯ IMPORTÃ‚NCIA PARA A SOLUÃ‡ÃƒO:                                              â•‘
        /// â•‘    Centraliza a validaÃ§Ã£o e redirecionamento de confirmaÃ§Ã£o de senha.        â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“¥ PARÃ‚METROS:                                                               â•‘
        /// â•‘    â€¢ returnUrl (string): URL de retorno (opcional).                          â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ“¤ RETORNO:                                                                  â•‘
        /// â•‘    â€¢ IActionResult: redirecionamento para Login ou reexibiÃ§Ã£o com erro.      â•‘
        /// â•‘    â€¢ Significado: confirma a validaÃ§Ã£o e encerra o fluxo.                    â•‘
        /// â•‘    â€¢ Consumidor: fluxo de UI do Identity.                                    â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“ FUNÃ‡Ã•ES QUE CHAMA:                                                        â•‘
        /// â•‘    â€¢ RedirectToPage() â†’ redireciona usuÃ¡rio.                                 â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ“² CHAMADA POR:                                                              â•‘
        /// â•‘    â€¢ Submit do formulÃ¡rio na view ConfirmarSenha.cshtml.                     â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ”— ESCOPO: INTERNA ao mÃ³dulo                                                 â•‘
        /// â•‘    â€¢ Arquivos relacionados: ConfirmarSenha.cshtml                            â•‘
        /// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        /// </summary>
        public async Task<IActionResult> OnPostAsync(string returnUrl = null)
        {
            try
            {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ”¹ BLOCO: ValidaÃ§Ã£o
                // Verifica se o modelo recebido Ã© vÃ¡lido
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                // [REGRA] Validar estado do modelo
                if (ModelState.IsValid)
                {
                    _log.Info("Senha confirmada com sucesso.");
                }

                // Se chegou atÃ© aqui, redireciona para Login
                return RedirectToPage("Account/LoginFrotiX");
            }
            catch (Exception error)
            {
                // ğŸ›¡ï¸ Blindagem Padronizada FrotiX
                _log.Error("Erro ao processar confirmaÃ§Ã£o de senha", error);
                Alerta.TratamentoErroComLinha("ConfirmarSenha.cshtml.cs", "OnPostAsync", error);
                return Page();
            }
        }
    }
}


