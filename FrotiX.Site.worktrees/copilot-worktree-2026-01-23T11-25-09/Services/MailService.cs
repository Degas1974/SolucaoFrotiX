/*
*  #################################################################################################
*  #   PROJETO: FROTIX - SOLUÃ‡ÃƒO INTEGRADA DE GESTÃƒO DE FROTAS                                    #
*  #   MODULO:  SERVIÃ‡OS - ENVIO DE E-MAIL                                                         #
*  #   DATA:    2026 (ModernizaÃ§Ã£o FrotiX 2026)                                                   #
*  #################################################################################################
*/

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

using Microsoft.Extensions.Options;
using FrotiX.Models;
using FrotiX.Settings;
using MimeKit;
using MailKit.Net.Smtp;
using MailKit.Security;

namespace FrotiX.Services
{
    /// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    /// â•‘ ğŸ“Œ NOME: MailService                                                         â•‘
    /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    /// â•‘ ğŸ“ DESCRIÃ‡ÃƒO:                                                                â•‘
    /// â•‘    ServiÃ§o de envio de e-mails usando MailKit/MimeKit via SMTP.              â•‘
    /// â•‘    Utilizado para autenticaÃ§Ã£o 2FA, notificaÃ§Ãµes e alertas do sistema.       â•‘
    /// â•‘                                                                              â•‘
    /// â•‘ ğŸ¯ IMPORTÃ‚NCIA PARA A SOLUÃ‡ÃƒO:                                              â•‘
    /// â•‘    Sistema crÃ­tico de comunicaÃ§Ã£o. Envia cÃ³digos de autenticaÃ§Ã£o, alertas   â•‘
    /// â•‘    de vencimento de CNH, notificaÃ§Ãµes de manutenÃ§Ã£o e outros e-mails.        â•‘
    /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    /// â•‘ ğŸ“ FUNÃ‡Ã•ES PRINCIPAIS:                                                       â•‘
    /// â•‘    â€¢ SendEmailAsync() â†’ Envia e-mail via SMTP                                â•‘
    /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    /// â•‘ ğŸ”— ESCOPO: INTERNA - ServiÃ§o de infraestrutura                               â•‘
    /// â•‘    â€¢ Arquivos relacionados: appsettings.json (MailSettings), IMailService   â•‘
    /// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public class MailService : IMailService
    {
        public class EmailSettings
        {
            public string EmailId { get; set; }
            public string Name { get; set; }
            public string Password { get; set; }
            public string Host { get; set; }
            public int Port { get; set; }
            public bool UseSSL { get; set; }
        }

        private readonly MailSettings _settings;
        
        public MailService(IOptions<MailSettings> mailSettings)
        {
            _settings = mailSettings.Value;
        }

        /// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        /// â•‘ ğŸ“Œ NOME: SendEmailAsync                                                      â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“ DESCRIÃ‡ÃƒO:                                                                â•‘
        /// â•‘    Envia e-mail HTML via SMTP com autenticaÃ§Ã£o TLS.                          â•‘
        /// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        /// â•‘ ğŸ“¥ PARÃ‚METROS:                                                               â•‘
        /// â•‘    â€¢ mailRequest: Objeto com ToEmail, Subject, Body                          â•‘
        /// â•‘                                                                              â•‘
        /// â•‘ ğŸ“¤ RETORNO:                                                                  â•‘
        /// â•‘    â€¢ Task: Tarefa assÃ­ncrona de envio                                        â•‘
        /// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        public async Task SendEmailAsync(MailRequest mailRequest)
        {
            // [DADOS] CriaÃ§Ã£o da mensagem MIME
            var email = new MimeMessage();

            // [REGRA] ConfiguraÃ§Ã£o do remetente (FrotiX - AutenticaÃ§Ã£o)
            var nome = "FrotiX - AutenticaÃ§Ã£o";
            var fromemail = _settings.Mail;

            email.Sender = MailboxAddress.Parse(_settings.Mail);
            email.To.Add(MailboxAddress.Parse(mailRequest.ToEmail));
            email.Subject = mailRequest.Subject;

            MailboxAddress emailFrom = new MailboxAddress(nome, _settings.Mail);
            email.From.Add(emailFrom);

            // [DADOS] Corpo do e-mail em HTML
            email.Body = new TextPart("html") { Text = mailRequest.Body };

            // [AJAX] Envio via SMTP com TLS
            using var smtp = new SmtpClient();
            smtp.Connect(_settings.Host, _settings.Port, SecureSocketOptions.StartTlsWhenAvailable);
            smtp.Authenticate(_settings.Mail, _settings.Password);
            await smtp.SendAsync(email);
            smtp.Disconnect(true);
        }
    }
}


