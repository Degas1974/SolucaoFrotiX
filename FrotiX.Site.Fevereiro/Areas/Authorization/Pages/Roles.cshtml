@*****************************************************************************************
 * ‚ö° ARQUIVO: Roles.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : P√°gina de gerenciamento de perfis (Roles) do Identity com DataTable
 *                   edit√°vel, permitindo CRUD completo via AJAX.
 *
 * üì• ENTRADAS     : Intera√ß√µes do usu√°rio no grid (criar/editar/excluir),
 *                   filtros/ordena√ß√£o/pagina√ß√£o do DataTables.
 *
 * üì§ SA√çDAS       : HTML + JavaScript que renderiza tabela e consome a API /api/roles.
 *
 * üîó CHAMADA POR  : Rota Razor Pages /Authorization/Roles.
 *
 * üîÑ CHAMA        : /api/roles (GET/POST/PUT/DELETE), plugin DataTableEdit.
 *
 * üì¶ DEPEND√äNCIAS : DataTables, datatables.bundle.js, plugin DataTableEdit, alerta (JS).
 *
 * üìù OBSERVA√á√ïES  : Colunas Id e ConcurrencyStamp s√£o ocultas na grid.
 *****************************************************************************************@

@page
@model RoleModel
@{
    ViewData["Title"] = "Role";
    ViewData["PageName"] = "authorization_roles";
    ViewData["Heading"] = "<i class='fal fa-shield-alt'></i> Authorization: <span class='fw-300'>Roles</span>";
    ViewData["Category1"] = "Authorization";
    ViewData["PageIcon"] = "fa-shield-alt";
}

@section HeadBlock {
    <link rel="stylesheet" media="screen, print" href="~/css/datagrid/datatables/datatables.bundle.css">
    <link rel="stylesheet" media="screen, print" href="~/css/formplugins/select2/select2.bundle.css">
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <div class="panel-container show">
                <div class="panel-content">
                    <table id="dt-list" class="table table-bordered table-hover table-striped w-100"></table>
                </div>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script src="~/js/datagrid/datatables/datatables.bundle.js"></script>
    @* <script src="~/js/formplugins/select2/select2.bundle.js"></script> *@
    <script>
        /****************************************************************************************
         * ‚ö° FUN√á√ÉO: Inicializa√ß√£o DataTable de Roles (Perfis de Acesso)
         * --------------------------------------------------------------------------------------
         * üéØ OBJETIVO     : Gerenciar perfis de acesso (Roles) do sistema com CRUD completo
         *                   via DataTable edit√°vel (adicionar, editar, deletar roles).
         * üì• ENTRADAS     : Nenhuma (fun√ß√£o auto-execut√°vel no document.ready).
         * üì§ SA√çDAS       : DataTable renderizada na div #dt-list com opera√ß√µes CRUD.
         * üîó CHAMADA POR  : Evento de UI (document.ready do jQuery).
         * üîÑ CHAMA        : DataTableEdit() (plugin customizado), $.ajax() para API /api/roles.
         * üì¶ DEPEND√äNCIAS : jQuery, DataTables, datatables.bundle.js, plugin DataTableEdit.
         ****************************************************************************************/
        $(function () {
            try {
                const endpoint = "/api/roles";

                // [DOC] Inicializa DataTable com plugin customizado DataTableEdit para opera√ß√µes CRUD
                $('#dt-list').DataTableEdit({
                    ajax: endpoint,
                    columns: [
                        { title: "Id", data: "id", type: "readonly", visible: false, searchable: false },
                        { title: "ConcurrencyStamp", data: "concurrencyStamp", type: "readonly", visible: false, searchable: false },
                        { title: "Name", data: "name", type: "text" },
                        { title: "Normalized", data: "normalizedName", type: "readonly" }
                    ],

                    // [DOC] Callback para adicionar nova role via POST no endpoint
                    onAddRow: function (table, rowdata, success, error) {
                        try {
                            $.ajax({
                                url: endpoint,
                                type: 'POST',
                                data: rowdata,
                                success: success,
                                error: function(xhr, status, errorMsg) {
                                    alerta.erro('Erro ao adicionar role: ' + (xhr.responseJSON?.message || errorMsg));
                                    if (error) error(xhr, status, errorMsg);
                                }
                            });
                        } catch (ex) {
                            alerta.erro('Erro ao processar adi√ß√£o de role: ' + ex.message);
                            console.error('Erro onAddRow:', ex);
                        }
                    },

                    // [DOC] Callback para deletar role existente via DELETE no endpoint
                    onDeleteRow: function (table, rowdata, success, error) {
                        try {
                            $.ajax({
                                url: endpoint,
                                type: 'DELETE',
                                data: rowdata,
                                success: success,
                                error: function(xhr, status, errorMsg) {
                                    alerta.erro('Erro ao deletar role: ' + (xhr.responseJSON?.message || errorMsg));
                                    if (error) error(xhr, status, errorMsg);
                                }
                            });
                        } catch (ex) {
                            alerta.erro('Erro ao processar exclus√£o de role: ' + ex.message);
                            console.error('Erro onDeleteRow:', ex);
                        }
                    },

                    // [DOC] Callback para editar role existente via PUT no endpoint
                    onEditRow: function (table, rowdata, success, error) {
                        try {
                            $.ajax({
                                url: endpoint,
                                type: 'PUT',
                                data: rowdata,
                                success: success,
                                error: function(xhr, status, errorMsg) {
                                    alerta.erro('Erro ao editar role: ' + (xhr.responseJSON?.message || errorMsg));
                                    if (error) error(xhr, status, errorMsg);
                                }
                            });
                        } catch (ex) {
                            alerta.erro('Erro ao processar edi√ß√£o de role: ' + ex.message);
                            console.error('Erro onEditRow:', ex);
                        }
                    }
                });
            } catch (erro) {
                alerta.erro('Erro ao inicializar DataTable de Roles: ' + erro.message);
                console.error('Erro na inicializa√ß√£o:', erro);
            }
        });
    </script>
}
