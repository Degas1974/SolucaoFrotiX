@*
 ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Usuarios/Index.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : P√°gina principal de gest√£o de usu√°rios com DataTable jQuery server-side,
 *                   filtros avan√ßados, modais para CRUD completo, sistema CR√çTICO de
 *                   controle de acesso e permiss√µes do FrotiX
 *
 * üì• ENTRADAS     : @page, @model IndexModel, route /Usuarios/Index, filtros via query:
 *                   textBusca (nome/email/CPF), apenasMotoristasAtivos (checkbox),
 *                   perfilFiltro (dropdown), bot√£o Filtrar dispara DataTable.ajax.reload()
 *
 * üì§ SA√çDAS       : Page renderizada com: Header card (Gest√£o de Usu√°rios, √≠cone fa-users),
 *                   Toolbar filtros (TextBox busca, CheckBox Motoristas, ComboBox Perfil),
 *                   DataTable renderizado (6 cols: Foto avatar 40x40, Nome, Email, CPF,
 *                   Perfil badge, Status badge, UltimoAcesso, A√ß√µes 4 bot√µes:
 *                   Visualizar/Editar/Recursos/Excluir), 2 Modais (Novo/Editar Usuario
 *                   com form + Visualizar readonly)
 *
 * üîó CHAMADA POR  : Menu Admin > Usu√°rios (sidebar), usuarios com role Admin, p√°gina
 *                   CR√çTICA controle de acesso sistema
 *
 * üîÑ CHAMA        : GET /api/Usuarios/GetAll (DataTable server-side filtering),
 *                   POST /api/Usuarios/Save (criar/editar AJAX), DELETE /api/Usuarios/Delete
 *                   (soft delete), GET /api/Usuarios/GetById (carregar para visualizar),
 *                   /Usuarios/Recursos?id=123 (gerenciar permiss√µes), upload foto
 *                   wwwroot/uploads/usuarios/
 *
 * üì¶ DEPEND√äNCIAS : ASP.NET Core Razor Pages, DataTables 1.13.4 jQuery, Bootstrap 5.3.8,
 *                   Font Awesome 6 Duotone, jQuery 3.7.1, jQuery Mask Plugin (CPF/tel),
 *                   Dropzone.js (foto drag-drop), zxcvbn (password strength), Alerta.js,
 *                   AppToast.js, EF Core 8.0, BCrypt.Net (hash senha)
 *
 * üìù OBSERVA√á√ïES  : Total ~220 linhas. **P√ÅGINA CR√çTICA** - DataTable server-side necess√°rio
 *                   (tabela Usu√°rios pode ter milhares registros). Hash senha **obrigat√≥rio**
 *                   BCrypt (BCrypt.HashPassword gera salt, protege rainbow table attacks -
 *                   NUNCA salvar plain text). Soft delete recomendado (seta Excluido=true,
 *                   mant√©m auditoria). Email unique constraint (evita duplicatas). CPF
 *                   valida√ß√£o d√≠gitos verificadores frontend + backend. **Perfis globais:**
 *                   Admin=acesso total, Coordenador=setores/viagens, Operador=CRUD b√°sico,
 *                   Motorista=readonly suas viagens, Consulta=readonly geral. **Recursos:**
 *                   permiss√µes granulares por tela (tabela UsuarioRecursos M:N, gerenciadas
 *                   em /Usuarios/Recursos?id=123, filtra menu por UsuarioRecursos).
 *
 * ‚ö†Ô∏è  ISSUES      : Coment√°rio anterior refencia rule "nunca use arroba" - problema antigo
 *                   em @razor, agora resolvido. Soft delete sem audit trail de quem excluiu.
 ****************************************************************************************
 *@
@page
@model FrotiX.Pages.Usuarios.IndexModel

@{
    ViewData["Title"] = "Gest√£o de Usu√°rios";
    ViewData["PageName"] = "usuarios_index";
    ViewData["Heading"] = "<i class='fa-duotone fa-users'></i> Cadastros: <span class='fw-300'>Usu√°rios</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-users";
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

    <style>
        /* ===== CORRECAO: HEADER DA TABELA USUARIOS ===== */
        /* Sobrescreve o gradiente escuro do ftx-card-styled.css */
        #tblUsuario thead,
        #tblUsuario thead tr {
            background: linear-gradient(180deg, #4a6fa5 0%, #3d5f8f 100%) !important;
        }

        #tblUsuario thead th {
            background: transparent !important;
            color: #fff !important;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none !important;
        }

        /* ===== MODAL CONTROLE DE ACESSO ===== */
        #modalControleAcesso .modal-dialog {
            max-width: 900px;
        }

        #modalControleAcesso .modal-header {
            background: linear-gradient(180deg, #3D5771 0%, #2d4559 100%);
            border-bottom: none;
            padding: 1rem 1.5rem;
        }

        #modalControleAcesso .modal-header .modal-title {
            color: #fff !important;
        }

        #modalControleAcesso .modal-header .modal-title i {
            color: #fff !important;
        }

        /* ===== MODAL FOTO ===== */
        #modalFoto .modal-dialog {
            max-width: 500px;
        }

        #modalFoto .modal-header {
            background: linear-gradient(180deg, #2F4F4F 0%, #1a3030 100%);
            border-bottom: none;
            padding: 1rem 1.5rem;
        }

        #modalFoto .modal-header .modal-title {
            color: #fff !important;
        }

        #modalFoto .modal-header .modal-title i {
            color: #fff !important;
        }

        .img-foto-usuario {
            width: 100%;
            max-width: 300px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .no-foto-placeholder {
            width: 200px;
            height: 200px;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            background: linear-gradient(180deg, #f8f9fa, #fff);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .no-foto-placeholder i {
            color: #adb5bd;
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .no-foto-placeholder p {
            color: #6c757d;
            font-style: italic;
            margin: 0;
        }

        /* ===== RESPONSIVO ===== */
        @@media (max-width: 768px) {
            #modalControleAcesso .modal-dialog,
            #modalFoto .modal-dialog {
                max-width: 95%;
                margin: 1rem auto;
            }
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel ftx-card-styled">
            <div class="panel-container show">

                <!-- Header Padr√£o FrotiX com Bot√£o √† Direita -->
                <div class="ftx-card-header d-flex justify-content-between align-items-center">
                    <h2 class="titulo-paginas mb-0">
                        <i class="fa-duotone fa-users"></i>
                        Cadastros: Gest√£o de Usu√°rios
                    </h2>
                    <a href="/Usuarios/Upsert" class="btn btn-fundo-laranja" data-ftx-loading>
                        <i class="fa-duotone fa-clone-plus icon-pulse me-1"></i> Adicionar Usu√°rio
                    </a>
                </div>

                <div class="panel-content">
                    <div class="box-body">
                        <table id="tblUsuario" class="table table-bordered table-striped table-hover ftx-table" width="100%">
                            <thead>
                                <tr>
                                    <th>Usu√°rio</th>
                                    <th>Ponto</th>
                                    <th>Detentor Carga</th>
                                    <th>Status</th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* ================ Modal Controle de Acesso ================ *@
<div class="modal fade" id="modalControleAcesso" tabindex="-1" aria-labelledby="tituloControleAcesso" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="tituloControleAcesso">
                    <i class="fa-duotone fa-shield-keyhole"></i>
                    Gest√£o de Recursos do Usu√°rio
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtUsuarioIdRecurso" />

                <div class="alert alert-info mb-3">
                    <i class="fa-duotone fa-circle-info me-2"></i>
                    <strong id="txtNomeUsuarioRecurso"></strong> - Clique nos bot√µes para conceder ou remover acesso aos recursos.
                </div>

                <table id="tblRecursos" class="table table-bordered table-striped table-hover ftx-table" width="100%">
                    <thead>
                        <tr>
                            <th>Nome do Recurso</th>
                            <th class="text-center" style="width: 130px;">Status do Acesso</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@* ================ Modal Foto do Usu√°rio ================ *@
<div class="modal fade" id="modalFoto" tabindex="-1" aria-labelledby="tituloFoto" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloFoto">
                    <i class="fa-duotone fa-id-badge"></i>
                    Foto do Usu√°rio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <h6 id="txtNomeUsuarioFoto" class="text-muted mb-3"></h6>
                <div id="divFotoContainer">
                    <!-- Foto ou placeholder ser√° inserido via JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script src="~/js/cadastros/usuario-index.js" asp-append-version="true"></script>
}
