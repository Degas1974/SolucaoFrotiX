# Conversa: Toast Veículo Sem Abastecimento no Dashboard

> **Data/Hora Início**: 17/01/2026 - 15:30
> **Data/Hora Término**: 17/01/2026 - 16:15
> **Participantes**: Usuário + Claude (Opus 4.5)

---

## Resumo Executivo

Implementação de toast amarelo no Dashboard de Abastecimentos que é exibido quando o usuário muda o ano na aba "Consumo por Veículo" e o veículo selecionado não possui abastecimentos no novo período.

---

## Solicitação do Usuário

O usuário queria que aparecesse um toast amarelo na aba "Consumo por Veículo" quando:
1. Há um veículo selecionado na lista de Placas
2. O usuário muda o ano no filtro
3. O veículo selecionado não tem abastecimentos no novo ano

A mensagem deveria ser: "Nenhum Abastecimento no Período para o Veículo"

---

## Arquivos Criados/Modificados

### Modificados

1. **`wwwroot/js/dashboards/dashboard-abastecimento.js`**
   - Evento `filtroAnoVeiculo.change`: Agora guarda a placa selecionada (via Select2 API) antes de limpar e passa para `carregarDadosVeiculo()`
   - Evento `filtroMesVeiculo.change`: Também guarda a placa selecionada antes de limpar
   - Função `carregarDadosVeiculo()`: Recebe novos parâmetros `placaAnterior` e `textoPlacaAnterior`
   - Função `executarCarregamentoVeiculo()`: Recebe os mesmos parâmetros e verifica se a placa anterior está disponível na lista `data.placasDisponiveis`
   - Função `exibirToastAmareloAposLoading()`: Duração padrão alterada de 6000ms para 4000ms
   - Movida declaração de `mensagensToast` para fora do bloco `try` interno para estar acessível no `finally`

2. **`Documentacao/Pages/Abastecimento - DashboardAbastecimento.md`**
   - Adicionada entrada no log de modificações
   - Versão atualizada para 0.4

---

## Problemas Encontrados e Soluções

### Problema 1: Toast não aparecia ao mudar o mês
**Causa**: A placa estava sendo capturada via DOM nativo, mas o Select2 estava ativo e o valor não estava acessível dessa forma.
**Solução**: Usar a API do Select2 (`$selectPlaca.val()` e `$selectPlaca.select2('data')`) para capturar a placa selecionada.

### Problema 2: Erro "mensagensToast is not defined"
**Causa**: A variável `mensagensToast` estava declarada dentro do bloco `try`, mas era usada no `finally` que está fora do escopo.
**Solução**: Mover a declaração de `mensagensToast` para fora do bloco `try` interno, antes dele.

### Problema 3: Toast não aparecia ao mudar o ano
**Causa**: O evento de mudança de ano não estava carregando os dados quando um ano válido era selecionado - esperava o usuário selecionar um mês.
**Solução**: Alterar a lógica para sempre carregar os dados ao mudar o ano, passando a placa anterior para verificação.

### Problema 4: Duração do toast muito longa
**Solicitação**: Reduzir em 2 segundos.
**Solução**: Alterada duração padrão de 6000ms para 4000ms.

---

## Decisões Técnicas

1. **Não exibir toast no botão "Limpar Ano/Mês"**: O usuário especificou que o toast não deve aparecer ao limpar, pois a lista de placas será esvaziada intencionalmente.

2. **Toast apenas quando confirmado que não há abastecimentos**: O toast só aparece após a API retornar e confirmar que a placa anterior não está na lista `placasDisponiveis` do novo período.

3. **Uso da API Select2**: Como o campo de placa usa Select2, foi necessário usar sua API específica para capturar o valor e texto selecionados corretamente.

---

## Fluxo Implementado

```
1. Usuário seleciona um veículo na lista de Placas
2. Usuário muda o ano no filtro
3. Sistema guarda a placa selecionada (ID e texto) via Select2 API
4. Sistema limpa lista de placas e carrega dados do novo ano
5. API retorna novas placas disponíveis para o período
6. Se a placa anterior não estiver na nova lista:
   → Exibe toast amarelo: "Nenhum Abastecimento no Período para o Veículo [PLACA]"
7. Toast permanece visível por 4 segundos
```

---

## Código Principal Alterado

### Evento de mudança de ano (linhas 475-505)
```javascript
document.getElementById('filtroAnoVeiculo')?.addEventListener('change', function () {
    try {
        // Guardar placa selecionada antes de limpar
        const $selectPlaca = $('#filtroPlacaVeiculo');
        let placaSelecionadaAntes = '';
        let textoPlacaAntes = '';

        if ($selectPlaca.length && $selectPlaca.hasClass('select2-hidden-accessible')) {
            placaSelecionadaAntes = $selectPlaca.val() || '';
            const select2Data = $selectPlaca.select2('data');
            textoPlacaAntes = (select2Data && select2Data.length > 0) ? select2Data[0].text : '';
        }

        prepararAtualizacaoVeiculoSemPlaca();
        carregarDadosVeiculo(false, placaSelecionadaAntes, textoPlacaAntes);
    } catch (error) {
        Alerta.TratamentoErroComLinha("dashboard-abastecimento.js", "filtroAnoVeiculo.change", error);
    }
});
```

### Verificação na função executarCarregamentoVeiculo (linhas 1115-1125)
```javascript
if (placaAnterior && textoPlacaAnterior && textoPlacaAnterior !== 'Todas') {
    const placasDisponiveis = data?.placasDisponiveis || [];
    const placaAindaDisponivel = placasDisponiveis.some(p => p.veiculoId === placaAnterior);
    if (!placaAindaDisponivel) {
        const placaTexto = obterPlacaTextoCompleto(textoPlacaAnterior);
        mensagensToast.push('Nenhum Abastecimento no Período para o Veículo' + (placaTexto ? ' ' + placaTexto : ''));
    }
}
```

---

## Tarefas Pendentes

Nenhuma.

---

## Tags

`#dashboard` `#abastecimento` `#toast` `#filtros` `#select2` `#javascript`
