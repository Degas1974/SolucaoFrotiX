@*
 ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Usuarios/Upsert.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio de cria√ß√£o/edi√ß√£o de Usu√°rios com valida√ß√£o completa,
 *                   upload de foto, campos senha com strength meter, suporte role Motorista
 *                   com CNH/validadeCNH/categoria autom√°tico.
 *
 * üì• ENTRADAS     : @page, @model UpsertModel, route /Usuarios/Upsert?id=guid (opcional),
 *                   POST submission com UsuarioObj (AspNetUsers+props customizadas),
 *                   FormFile foto upload, passwords com valida√ß√£o server/client
 *
 * üì§ SA√çDAS       : Renderiza√ß√£o modal/page form com: Dropzone foto 40x40px avatar,
 *                   campos Nome/Email/CPF/Telefone (inputs masked), Senha/ConfirmaSenha
 *                   password strength meter zxcvbn, Perfil dropdown, checkbox Motorista
 *                   (toggle CNH/Categoria/ValidadeCNH), Status checkbox, POST form para
 *                   UpsertModel.OnPostSubmit, redirect ./Index ap√≥s sucesso
 *
 * üîó CHAMADA POR  : /Usuarios/Index (bot√£o + Novo Usuario, DataTable edit links),
 *                   UpsertModel.OnGet() (carrega usu√°rio para edi√ß√£o)
 *
 * üîÑ CHAMA        : UpsertModel.OnPostSubmit (code-behind save), ./Index (cancelamento),
 *                   wwwroot/uploads/usuarios/ (salva foto base64/bin√°ria), ASP.NET
 *                   validation system (asp-validation-summary, asp-validation-for)
 *
 * üì¶ DEPEND√äNCIAS : ASP.NET Core Razor Pages 8.0, Bootstrap 5 (form-control, modal,
 *                   checkbox, form-group), Font Awesome 6 Duotone (fa-floppy-disk,
 *                   fa-circle-xmark), jQuery 3.7.1, jQuery Mask Plugin (mascaras CPF),
 *                   Dropzone.js (upload foto drag-drop), zxcvbn library (password strength),
 *                   Tag Helpers (asp-for, asp-validation-*, asp-page-handler)
 *
 * üìù OBSERVA√á√ïES  : Total ~450 linhas. Formul√°rio cr√≠tico gest√£o usu√°rios. Foto salva como
 *                   base64 no banco (ou arquivo wwwroot). Password strength meter inline
 *                   (zxcvbn mostra for√ßa senha em tempo real). CNH/Validadade condicional
 *                   (vis√≠vel s√≥ se Motorista=checked). Todos campos obrigat√≥rios validados
 *                   server-side (Email unique, CPF v√°lido). Soft-switch estilo para checkbox
 *                   Status/Motorista/DetenorCargaPatrimonial (CSS ftx-switch). Header din√¢mico
 *                   (Criar vs Atualizar baseado em UsuarioObj.AspNetUsers.Id != null).
 *
 * ‚ö†Ô∏è  ISSUES      : Documenta√ß√£o referencia arquivo .md externo desatualizado (11/01/2026)
 ****************************************************************************************
 *@

@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Usuarios.UpsertModel

@{
    ViewData["Title"] = "Usu√°rios";
    ViewData["PageName"] = "Usuarios_upsert";
    ViewData["Heading"] = "<i class='fa-duotone fa-users'></i> Cadastros: <span class='fw-300'>Usu√°rios</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-users";

    var isEdicao = Model.UsuarioObj?.AspNetUsers?.Id != null;
    var statusChecked = isEdicao ? (Model.UsuarioObj?.AspNetUsers?.Status == true) : true; // Novo usu√°rio come√ßa Ativo
    var detentorChecked = Model.UsuarioObj?.AspNetUsers?.DetentorCargaPatrimonial == true;
    var fotoBase64 = Model.UsuarioObj?.AspNetUsers?.Foto != null
    ? Convert.ToBase64String(Model.UsuarioObj.AspNetUsers.Foto)
    : null;
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

    <style>
        .form-control-sm {
            height: calc(1.5em + .5rem + 2px);
            padding: .25rem .5rem;
            font-size: .875rem;
            line-height: 1.5;
            border-radius: .25rem;
        }

        .label-ftx {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        /* Checkbox Switch Estilizado */
        .ftx-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 0.75rem;
        }

        .ftx-switch input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ftx-switch-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background: linear-gradient(135deg, #94a3b8, #cbd5e1);
            border-radius: 26px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ftx-switch-slider::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .ftx-switch input:checked+.ftx-switch-slider {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .ftx-switch input:checked+.ftx-switch-slider::before {
            transform: translateX(24px);
        }

        .ftx-switch-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .ftx-switch:hover .ftx-switch-slider {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
        }

        /* ====== SE√á√ÉO DE FOTO - Dropzone Estilizado ====== */
        .ftx-foto-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .ftx-foto-container {
            position: relative !important;
            width: 180px;
            height: 180px;
            border-radius: 12px;
            overflow: visible !important;
            /* Permite o bot√£o sair da √°rea */
            border: 3px solid #3D5771;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #fff;
        }

        .ftx-foto-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 9px;
            /* Arredonda a imagem para n√£o vazar */
        }

        /* Bot√£o de Limpar Foto (lixeira) - 40% dentro, 60% fora */
        /* Por padr√£o, o bot√£o est√° COMPLETAMENTE OCULTO - m√∫ltiplas camadas de prote√ß√£o */
        .ftx-foto-container .ftx-foto-clear {
            position: absolute !important;
            bottom: -14px !important;
            /* 40% dentro = 14.4px */
            right: -22px !important;
            /* 60% fora = 21.6px */
            width: 36px !important;
            height: 36px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #722F37, #8B3A3A) !important;
            border: 3px solid #fff !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25) !important;
            display: none !important;
            /* OCULTO por padr√£o */
            visibility: hidden !important;
            /* Backup: oculta mesmo se display falhar */
            opacity: 0 !important;
            /* Backup: torna invis√≠vel */
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            z-index: 999 !important;
            margin: 0 !important;
            padding: 0 !important;
            top: auto !important;
            left: auto !important;
        }

        /* S√≥ mostra quando tiver a classe show - remove TODAS as prote√ß√µes */
        .ftx-foto-container .ftx-foto-clear.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .ftx-foto-clear:hover {
            background: linear-gradient(135deg, #8B3A3A, #A04040);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        }

        .ftx-foto-clear i {
            color: #fff;
            font-size: 0.9rem;
        }

        /* Dropzone Visual Elegante */
        .ftx-dropzone {
            position: relative;
            width: 100%;
            cursor: pointer;
        }

        /* Esconde completamente o input file nativo (incluindo texto "Nenhum arquivo escolhido") */
        .ftx-dropzone-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .ftx-dropzone-input::-webkit-file-upload-button {
            visibility: hidden;
        }

        .ftx-dropzone-input::file-selector-button {
            visibility: hidden;
        }

        .ftx-dropzone-area {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transition: all 0.3s ease;
        }

        .ftx-dropzone:hover .ftx-dropzone-area {
            border-color: #3D5771;
            background: linear-gradient(135deg, #e8f4fc 0%, #dbeafe 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(61, 87, 113, 0.15);
        }

        .ftx-dropzone-icon {
            font-size: 2rem;
            color: #3D5771;
            margin-bottom: 0.5rem;
            --fa-primary-color: #3D5771;
            --fa-secondary-color: #6b8ba3;
            --fa-secondary-opacity: 0.7;
        }

        .ftx-dropzone-text {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0;
            font-weight: 500;
        }

        .ftx-dropzone-hint {
            font-size: 0.75rem;
            color: #94a3b8;
            margin: 0.25rem 0 0 0;
        }

        /* Estado com arquivo selecionado */
        .ftx-dropzone.has-file .ftx-dropzone-area {
            border-color: #22c55e;
            border-style: solid;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .ftx-dropzone.has-file .ftx-dropzone-icon {
            color: #22c55e;
            --fa-primary-color: #22c55e;
            --fa-secondary-color: #86efac;
        }

        .ftx-dropzone.has-file .ftx-dropzone-text {
            color: #166534;
        }

        .foto-container {
            text-align: center;
            padding: 1.25rem;
            background: linear-gradient(180deg, #f8f9fa, #fff);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
    </style>
}

<form method="post" enctype="multipart/form-data">
    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel ftx-card-styled">
                <div class="panel-container show">

                    <!-- Header Padr√£o FrotiX -->
                    <div class="ftx-card-header d-flex justify-content-between align-items-center">
                        <h2 class="titulo-paginas mb-0">
                            <i class="fa-duotone fa-user-pen"></i>
                            @(isEdicao ? "Editar" : "Criar") Usu√°rio
                        </h2>
                        <a asp-page="./Index" class="btn btn-header-orange" data-ftx-loading>
                            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar √† Lista
                        </a>
                    </div>

                    <div class="panel-content">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        @if (isEdicao)
                        {
                            <input type="hidden" asp-for="UsuarioObj.AspNetUsers.Id" />
                        }

                        <div class="row">
                            <!-- Coluna dos Dados -->
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <!-- Ponto -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx label-required"
                                                asp-for="UsuarioObj.AspNetUsers.Ponto">Ponto</label>
                                            <span class="text-danger"
                                                asp-validation-for="UsuarioObj.AspNetUsers.Ponto"></span>
                                            <input id="txtPonto" class="form-control form-control-sm"
                                                asp-for="UsuarioObj.AspNetUsers.Ponto" placeholder="Ex: p_1234567890"
                                                maxlength="12" />
                                        </div>
                                    </div>

                                    <!-- Nome Completo -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="label-ftx label-required"
                                                asp-for="UsuarioObj.AspNetUsers.NomeCompleto">Nome Completo</label>
                                            <span class="text-danger"
                                                asp-validation-for="UsuarioObj.AspNetUsers.NomeCompleto"></span>
                                            <input id="txtNomeCompleto" class="form-control form-control-sm"
                                                asp-for="UsuarioObj.AspNetUsers.NomeCompleto"
                                                placeholder="Nome completo" maxlength="80" />
                                        </div>
                                    </div>

                                    <!-- Ramal -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx label-required"
                                                asp-for="UsuarioObj.AspNetUsers.Ramal">Ramal</label>
                                            <span class="text-danger"
                                                asp-validation-for="UsuarioObj.AspNetUsers.Ramal"></span>
                                            <input id="txtRamal" class="form-control form-control-sm"
                                                asp-for="UsuarioObj.AspNetUsers.Ramal" placeholder="12345678"
                                                type="text" maxlength="8" inputmode="numeric" pattern="[1-9][0-9]{7}" />
                                        </div>
                                    </div>

                                    <!-- Login (UserName) -->
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="label-ftx label-required"
                                                asp-for="UsuarioObj.AspNetUsers.UserName">Login</label>
                                            <span class="text-danger"
                                                asp-validation-for="UsuarioObj.AspNetUsers.UserName"></span>
                                            <input id="txtUserName" class="form-control form-control-sm"
                                                asp-for="UsuarioObj.AspNetUsers.UserName" disabled
                                                style="background-color: #e9ecef;" />
                                        </div>
                                    </div>

                                    <!-- Email -->
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <label class="label-ftx label-required"
                                                asp-for="UsuarioObj.AspNetUsers.Email">Email</label>
                                            <span class="text-danger"
                                                asp-validation-for="UsuarioObj.AspNetUsers.Email"></span>
                                            <input id="txtEmail" class="form-control form-control-sm"
                                                asp-for="UsuarioObj.AspNetUsers.Email"
                                                placeholder="usuario@camara.leg.br" maxlength="256" />
                                        </div>
                                    </div>

                                    <!-- Celular -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx"
                                                asp-for="UsuarioObj.AspNetUsers.PhoneNumber">Celular</label>
                                            <span class="text-danger"
                                                asp-validation-for="UsuarioObj.AspNetUsers.PhoneNumber"></span>
                                            <input id="txtCelular" class="form-control form-control-sm"
                                                asp-for="UsuarioObj.AspNetUsers.PhoneNumber"
                                                placeholder="(xx) xxxxx-xxxx" maxlength="15" />
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-3" />

                                <!-- Checkboxes com Switch Estilizado -->
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label class="ftx-switch">
                                            <input type="hidden" name="UsuarioObj.AspNetUsers.Status" value="false" />
                                            <input type="checkbox" id="chkStatus" name="UsuarioObj.AspNetUsers.Status"
                                                value="true" @(statusChecked ? "checked" : "") />
                                            <span class="ftx-switch-slider"></span>
                                            <span class="ftx-switch-label">Status (Ativo/Inativo)</span>
                                        </label>
                                    </div>

                                    <div class="col-md-7">
                                        <label class="ftx-switch">
                                            <input type="hidden" name="UsuarioObj.AspNetUsers.DetentorCargaPatrimonial"
                                                value="false" />
                                            <input type="checkbox" id="chkDetentorCarga"
                                                name="UsuarioObj.AspNetUsers.DetentorCargaPatrimonial" value="true"
                                                @(detentorChecked ? "checked" : "") />
                                            <span class="ftx-switch-slider"></span>
                                            <span class="ftx-switch-label">Detentor de Carga Patrimonial</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna da Foto (√† direita) -->
                            <div class="col-md-4">
                                <div class="foto-container">
                                    <h6 class="label-ftx mb-3">
                                        <i class="fa-duotone fa-camera me-1"></i> Foto do Usu√°rio
                                    </h6>
                                    <div class="ftx-foto-section">
                                        <!-- Preview da Foto com Bot√£o de Limpar -->
                                        <div class="ftx-foto-container">
                                            @if (fotoBase64 != null)
                                            {
                                                <img id="imgPreview" src="data:image/png;base64,@fotoBase64"
                                                    alt="Foto do Usu√°rio" />
                                            }
                                            else
                                            {
                                                <img id="imgPreview" src="/Images/sucesso_transparente.png"
                                                    alt="Foto do Usu√°rio" />
                                            }
                                            <!-- Bot√£o Limpar: SEMPRE oculto no HTML, JS controla visibilidade -->
                                            <button type="button" class="ftx-foto-clear" id="btnLimparFoto"
                                                style="display: none !important;">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </div>

                                        <!-- Dropzone Estilizado -->
                                        <div class="ftx-dropzone" id="dropzoneArea">
                                            <input type="file" class="ftx-dropzone-input" id="inputFoto"
                                                name="FotoUpload" accept="image/*" />
                                            <div class="ftx-dropzone-area">
                                                <i class="fa-duotone fa-cloud-arrow-up ftx-dropzone-icon"></i>
                                                <p class="ftx-dropzone-text">Clique ou arraste uma imagem</p>
                                                <p class="ftx-dropzone-hint">JPG, PNG ou GIF</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Bot√µes de A√ß√£o -->
                        <div class="d-flex gap-2">
                            @if (isEdicao)
                            {
                                <button type="submit" asp-page-handler="Edit"
                                    asp-route-id="@Model.UsuarioObj.AspNetUsers.Id" class="btn btn-azul btn-submit-spin">
                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Atualizar Usu√°rio
                                </button>
                            }
                            else
                            {
                                <button type="submit" asp-page-handler="Submit" class="btn btn-azul btn-submit-spin">
                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Criar Usu√°rio
                                </button>
                            }

                            <a asp-page="./Index" class="btn btn-ftx-fechar" data-ftx-loading>
                                <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar Opera√ß√£o
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section ScriptsBlock {
    <script>
        (function () {
            "use strict";

            try {
                // =====================================================
                // PREVIEW DA FOTO - Dropzone Estilizado
                // =====================================================
                const inputFoto = document.getElementById('inputFoto');
                const imgPreview = document.getElementById('imgPreview');
                const dropzoneArea = document.getElementById('dropzoneArea');
                const dropzoneText = dropzoneArea ? dropzoneArea.querySelector('.ftx-dropzone-text') : null;
                const dropzoneIcon = dropzoneArea ? dropzoneArea.querySelector('.ftx-dropzone-icon') : null;
                const btnLimparFoto = document.getElementById('btnLimparFoto');
                const fotoPadraoPath = '/Images/sucesso_transparente.png';
                const hasFotoInicial = @(fotoBase64 != null ? "true" : "false") === "true";

                // Ajusta estado inicial do bot√£o e dropzone
                // Bot√£o SEMPRE come√ßa oculto no HTML - JS decide se mostra
                if (hasFotoInicial && btnLimparFoto) {
                    // S√≥ mostra se h√° foto inicial (edi√ß√£o com foto)
                    btnLimparFoto.style.cssText = 'display: flex !important; position: absolute !important; bottom: -14px !important; right: -22px !important; z-index: 999 !important;';
                    btnLimparFoto.classList.add('show');
                    if (dropzoneArea) dropzoneArea.classList.add('has-file');
                } else {
                    // Sem foto - mant√©m oculto (j√° est√° oculto no HTML)
                    if (dropzoneArea) dropzoneArea.classList.remove('has-file');
                }

                // Preview da foto ao selecionar arquivo
                if (inputFoto) {
                    inputFoto.addEventListener('change', function (e) {
                        try {
                            const files = e.target.files;
                            if (files && files[0]) {
                                // Atualiza preview
                                imgPreview.src = window.URL.createObjectURL(files[0]);

                                // Mostra bot√£o de limpar - usa cssText para sobrescrever display:none
                                if (btnLimparFoto) {
                                    btnLimparFoto.style.cssText = 'display: flex !important; position: absolute !important; bottom: -14px !important; right: -22px !important; z-index: 999 !important;';
                                    btnLimparFoto.classList.add('show');
                                }

                                // Atualiza visual do dropzone
                                if (dropzoneArea) {
                                    dropzoneArea.classList.add('has-file');
                                }
                                if (dropzoneText) {
                                    dropzoneText.textContent = files[0].name;
                                }
                                if (dropzoneIcon) {
                                    dropzoneIcon.className = 'fa-duotone fa-circle-check ftx-dropzone-icon';
                                }
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "inputFoto.change", error);
                        }
                    });

                    // Drag and drop visual feedback
                    if (dropzoneArea) {
                        dropzoneArea.addEventListener('dragover', function (e) {
                            e.preventDefault();
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '#3D5771';
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
                        });

                        dropzoneArea.addEventListener('dragleave', function (e) {
                            e.preventDefault();
                            if (!dropzoneArea.classList.contains('has-file')) {
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '';
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.background = '';
                            }
                        });

                        dropzoneArea.addEventListener('drop', function (e) {
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '';
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.background = '';
                        });
                    }
                }

                // =====================================================
                // BOT√ÉO LIMPAR FOTO (Lixeira)
                // =====================================================
                if (btnLimparFoto) {
                    btnLimparFoto.addEventListener('click', function (e) {
                        try {
                            e.preventDefault();
                            e.stopPropagation();

                            // Limpa o input file
                            if (inputFoto) {
                                inputFoto.value = '';
                            }

                            // Volta para a foto padr√£o
                            if (imgPreview) {
                                imgPreview.src = fotoPadraoPath;
                            }

                            // Esconde o bot√£o de limpar
                            btnLimparFoto.classList.remove('show');
                            btnLimparFoto.style.cssText = 'display: none !important;';

                            // Reseta o visual do dropzone
                            if (dropzoneArea) {
                                dropzoneArea.classList.remove('has-file');
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '';
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.background = '';
                            }
                            if (dropzoneText) {
                                dropzoneText.textContent = 'Clique ou arraste uma imagem';
                            }
                            if (dropzoneIcon) {
                                dropzoneIcon.className = 'fa-duotone fa-cloud-arrow-up ftx-dropzone-icon';
                            }

                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnLimparFoto.click", error);
                        }
                    });
                }

                // =====================================================
                // FUN√á√ÉO: Converter para Camel Case (exceto conectores)
                // =====================================================
                function toCamelCase(str) {
                    // Lista de conectores que devem permanecer em min√∫sculo
                    const conectores = ['da', 'de', 'do', 'das', 'dos', 'e', 'ou', 'a', 'o', 'as', 'os', 'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com'];

                    return str
                        .toLowerCase()
                        .split(' ')
                        .map(function (palavra, index) {
                            if (!palavra) return '';
                            // Primeira palavra sempre em Camel Case, demais verificar se √© conector
                            if (index === 0 || !conectores.includes(palavra)) {
                                return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                            }
                            return palavra;
                        })
                        .join(' ');
                }

                // =====================================================
                // VALIDA√á√ÉO: Nome Completo em Camel Case
                // =====================================================
                function sanitizeNomeCompleto(valor) {
                    let limpo = valor.replace(/[^\p{L} ]+/gu, '');
                    if (limpo.length > 80) {
                        limpo = limpo.substring(0, 80);
                    }
                    return limpo;
                }

                const txtNomeCompleto = document.getElementById('txtNomeCompleto');
                if (txtNomeCompleto) {
                    txtNomeCompleto.addEventListener('input', function () {
                        try {
                            txtNomeCompleto.value = sanitizeNomeCompleto(txtNomeCompleto.value);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtNomeCompleto.input", error);
                        }
                    });

                    txtNomeCompleto.addEventListener('blur', function () {
                        try {
                            const valor = sanitizeNomeCompleto(txtNomeCompleto.value.trim());
                            if (valor) {
                                txtNomeCompleto.value = toCamelCase(valor);
                                txtNomeCompleto.classList.remove('is-invalid');
                            } else {
                                txtNomeCompleto.classList.add('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtNomeCompleto.blur", error);
                        }
                    });
                }

                // =====================================================
                // VALIDA√á√ÉO: Ponto com prefixo p_ (min√∫sculo) seguido de n√∫meros
                // =====================================================
                const txtPonto = document.getElementById('txtPonto');
                const txtUserName = document.getElementById('txtUserName');
                const maxPontoDigits = 10;

                function formatPonto(valor) {
                    let digits = valor.trim().toLowerCase();
                    digits = digits.replace(/^[pP]_/, '');
                    digits = digits.replace(/\D/g, '');

                    const overflow = digits.length > maxPontoDigits;
                    if (overflow) {
                        digits = digits.substring(0, maxPontoDigits);
                    }

                    return {
                        formatted: digits.length > 0 ? 'p_' + digits : '',
                        digitsLength: digits.length,
                        overflow: overflow
                    };
                }

                if (txtPonto && txtUserName) {
                    txtPonto.addEventListener('blur', function () {
                        try {
                            const info = formatPonto(txtPonto.value);

                            txtPonto.value = info.formatted;
                            txtUserName.value = info.formatted;

                            if (info.digitsLength === 0 || info.overflow) {
                                txtPonto.classList.add('is-invalid');
                            } else {
                                txtPonto.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtPonto.blur", error);
                        }
                    });

                    txtPonto.addEventListener('input', function () {
                        try {
                            const info = formatPonto(txtPonto.value);

                            txtPonto.value = info.formatted;
                            txtUserName.value = info.formatted;

                            if (info.digitsLength === 0 || info.overflow) {
                                txtPonto.classList.add('is-invalid');
                            } else {
                                txtPonto.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtPonto.input", error);
                        }
                    });
                }


                // =====================================================
                // VALIDA√á√ÉO: Ramal - apenas n√∫meros (m√°x 5 d√≠gitos)
                // =====================================================
                const txtRamal = document.getElementById('txtRamal');
                if (txtRamal) {
                    txtRamal.addEventListener('input', function () {
                        try {
                            let valor = txtRamal.value.replace(/\D/g, '');

                            valor = valor.substring(0, 8);

                            txtRamal.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtRamal.input", error);
                        }
                    });

                    txtRamal.addEventListener('blur', function () {
                        try {
                            const valor = txtRamal.value.trim();
                            const regex = /^[1-9]\d{7}$/;

                            if (valor && !regex.test(valor)) {
                                txtRamal.classList.add('is-invalid');
                            } else {
                                txtRamal.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtRamal.blur", error);
                        }
                    });
                }


                // =====================================================
                // VALIDA√á√ÉO: Email obrigatoriamente terminando em @@camara.leg.br
                // Caracteres v√°lidos antes do @@: letras, n√∫meros, ponto, h√≠fen, underscore
                // =====================================================
                const txtEmail = document.getElementById('txtEmail');
                if (txtEmail) {
                    txtEmail.addEventListener('blur', function () {
                        try {
                            let valor = txtEmail.value.trim().toLowerCase();

                            if (valor) {
                                // Remove @@camara.leg.br se j√° existir para evitar duplica√ß√£o
                                valor = valor.replace(/@@camara\.leg\.br$/i, '');
                                // Remove qualquer @@ que possa existir
                                valor = valor.replace(/@@/g, '');

                                // Remove caracteres inv√°lidos (permite apenas: letras, n√∫meros, ponto, h√≠fen, underscore)
                                valor = valor.replace(/[^a-z0-9._-]/g, '');

                                // Valida se tem conte√∫do antes do @@
                                if (valor.length > 0) {
                                    // Adiciona o dom√≠nio obrigat√≥rio
                                    valor = valor + '@@camara.leg.br';
                                } else {
                                    // Se n√£o tiver conte√∫do, limpa o campo
                                    valor = '';
                                }

                                txtEmail.value = valor;

                                // Valida formato final (apenas caracteres v√°lidos antes do @@)
                                const regex = /^[a-z0-9._-]+@@camara\.leg\.br$/;
                                if (valor && !regex.test(valor)) {
                                    txtEmail.classList.add('is-invalid');
                                } else {
                                    txtEmail.classList.remove('is-invalid');
                                }
                            } else {
                                txtEmail.classList.add('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtEmail.blur", error);
                        }
                    });

                    // For√ßa min√∫sculo e remove caracteres inv√°lidos enquanto digita
                    txtEmail.addEventListener('input', function () {
                        try {
                            // Converte para min√∫sculo
                            let valor = txtEmail.value.toLowerCase();

                            // Remove TUDO que n√£o √© letra, n√∫mero, ponto, h√≠fen, underscore ou @@
                            valor = valor.replace(/[^a-z0-9._@@-]/g, '');

                            // Conta quantos @@ existem
                            const numArrobas = (valor.match(/@@/g) || []).length;

                            // Se tem mais de 1 @@, remove os extras
                            if (numArrobas > 1) {
                                // Mant√©m apenas o primeiro @@
                                const partes = valor.split('@@');
                                valor = partes[0] + '@@' + partes.slice(1).join('');
                            }

                            txtEmail.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtEmail.input", error);
                        }
                    });
                }

                // =====================================================
                // VALIDA√á√ÉO: Celular com m√°scara (xx) xxxxx-xxxx (11 digitos)
                // =====================================================
                const txtCelular = document.getElementById('txtCelular');
                if (txtCelular) {
                    txtCelular.addEventListener('input', function (e) {
                        try {
                            // Remove tudo que n√£o √© n√∫mero
                            let valor = txtCelular.value.replace(/\D/g, '');

                            // Limita a 11 d√≠gitos (celular brasileiro)
                            valor = valor.substring(0, 11);

                            // Aplica a m√°scara (xx) xxxxx-xxxx para celular ou (xx) xxxx-xxxx para fixo
                            if (valor.length > 10) {
                                // Celular: (xx) xxxxx-xxxx
                                valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2, 7) + '-' + valor.substring(7);
                            } else if (valor.length > 6) {
                                // Fixo ou parcial: (xx) xxxx-xxxx
                                valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2, 6) + '-' + valor.substring(6);
                            } else if (valor.length > 2) {
                                valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2);
                            } else if (valor.length > 0) {
                                valor = '(' + valor;
                            }

                            txtCelular.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtCelular.input", error);
                        }
                    });

                    // Valida formato completo ao sair do campo
                    txtCelular.addEventListener('blur', function () {
                        try {
                            const valor = txtCelular.value;
                            // Aceita celular (xx) xxxxx-xxxx (11 digitos) ou fixo (xx) xxxx-xxxx (10 digitos)
                            const regex = /^\(\d{2}\) \d{4,5}-\d{4}$/;

                            if (valor && !regex.test(valor)) {
                                txtCelular.classList.add('is-invalid');
                            } else {
                                txtCelular.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtCelular.blur", error);
                        }
                    });
                }

                // =====================================================
                // VALIDA√á√ÉO: Impedir submit se houver campos inv√°lidos
                // =====================================================
                const formulario = document.querySelector('form');
                if (formulario) {
                    formulario.addEventListener('submit', function (e) {
                        try {
                            // For√ßa valida√ß√£o de todos os campos antes de submeter
                            if (txtPonto) {
                                txtPonto.dispatchEvent(new Event('blur'));
                            }
                            if (txtNomeCompleto) {
                                txtNomeCompleto.dispatchEvent(new Event('blur'));
                            }
                            if (txtEmail) {
                                txtEmail.dispatchEvent(new Event('blur'));
                            }
                            if (txtCelular) {
                                txtCelular.dispatchEvent(new Event('blur'));
                            }
                            if (txtRamal) {
                                txtRamal.dispatchEvent(new Event('blur'));
                            }

                            // Verifica se existe algum campo com is-invalid
                            const camposInvalidos = formulario.querySelectorAll('.is-invalid');

                            if (camposInvalidos.length > 0) {
                                e.preventDefault();
                                e.stopPropagation();

                                // Mostra alerta ao usu√°rio
                                Alerta.Warning(
                                    'Campos Inv√°lidos',
                                    'Por favor, corrija os campos destacados em vermelho antes de salvar.',
                                    'OK'
                                );

                                // Foca no primeiro campo inv√°lido
                                camposInvalidos[0].focus();
                                return false;
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "form.submit", error);
                        }
                    });
                }


            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "script.init", error);
            }
        })();
    </script>
}