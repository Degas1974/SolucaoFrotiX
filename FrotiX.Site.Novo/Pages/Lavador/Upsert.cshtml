@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Lavador/Upsert.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio de cria√ß√£o/edi√ß√£o de lavador com campos pessoais, profissionais, upload de foto com preview, checkbox Status, valida√ß√£o client-side
 * üì• ENTRADAS     : @page, @model UpsertModel, LavadorObj (Lavador entity + ContratoList dropdown + NomeUsuarioAlteracao), form inputs (Nome, CPF, DataNascimento, Celular01/02, Ponto, DataIngresso, ContratoId, Status, FotoUpload file), route parameter id (Guid) para edi√ß√£o
 * üì§ SA√çDAS       : HTML form com POST para asp-page-handler="Edit|Submit", valida√ß√µes ASP.NET Core, preview de foto via JavaScript, m√°scaras de CPF, AJAX GET /api/Lavador/PegaFoto pr√©-preenche foto em edi√ß√£o, redirect para /Lavador ap√≥s salvar
 * üîó CHAMADA POR  : /Lavador (bot√£o "Adicionar Lavador"), /Lavador DataTable (bot√£o "Editar")
 * üîÑ CHAMA        : asp-page-handler="Submit" (POST create), asp-page-handler="Edit" (POST update), /api/Lavador/PegaFoto (GET foto base64 em edi√ß√£o), /Lavador (link Voltar), JavaScript inline fun√ß√µes mascara() (CPF), txtFile.change (preview), document.ready AJAX foto, Alerta.TratamentoErroComLinha
 * üì¶ DEPEND√äNCIAS : Google Fonts Outfit (700/800/900), ASP.NET TagHelpers, Bootstrap 5, jQuery, ~/Images/barbudo.jpg (placeholder), Font Awesome Duotone, CSS inline extenso (~260 linhas), Alerta.TratamentoErroComLinha (global), data-ftx-loading
 * üìù OBSERVA√á√ïES  : Total: ~370 linhas. isEdicao detecta se √© Create/Update via LavadorId != Empty. CSS inline massivo com padr√£o FrotiX (header azul com shimmer, cards, badges, form controls altura 38px padronizada, responsividade). Foto preview funcional cliente-side (FileReader implied). AJAX carrega foto em edi√ß√£o. M√°scara CPF JavaScript inline funcional (regex). Checkbox Status marcado automaticamente em cria√ß√£o (linha 353). Valida√ß√£o client/server via asp-validation-for. Bot√µes Submit com spinner (classe btn-submit-spin - verificar se definida). Cards organizados em se√ß√µes (Dados Pessoais, Profissionais, Foto, Configura√ß√µes). InfoUsu√°rio exibido em edi√ß√£o. Form usa enctype multipart. CSS bem estruturado com vari√°veis locais e se√ß√µes. Poss√≠vel mover CSS para arquivo externo (~260 linhas). JavaScript inline m√≠nimo (~55 linhas). Tratamento de erro robusto. Responsivo com media queries.
 **************************************************************************************** *@
@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Lavador.UpsertModel

@{
    ViewData["Title"] = "Lavadores";
    ViewData["PageName"] = "lavador_upsert";
    ViewData["Heading"] = "<i class='fa-duotone fa-car-wash'></i> Cadastros: <span class='fw-300'>Lavadores</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-car-wash";

    var isEdicao = Model.LavadorObj.Lavador.LavadorId != Guid.Empty;
}

@section HeadBlock {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====== HEADER AZUL PADR√ÉO FROTIX ====== */
        .ftx-card-header {
            background-color: #3D5771;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @@keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .ftx-card-header .titulo-paginas {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        /* √çcone do header: cores definidas no frotix.css global */
        .ftx-card-header .titulo-paginas i.fa-duotone {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* ====== BOT√ÉO LARANJA COM BORDA BRANCA ====== */
        .ftx-card-header .btn-fundo-laranja {
            border: 2px solid rgba(255, 255, 255, 0.7) !important;
            outline: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 1;
            padding: 0.5rem 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .ftx-card-header .btn-fundo-laranja:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* ====== PANEL CONTENT ====== */
        .panel-content {
            padding: 1.25rem;
            background: #f8f9fa;
        }

        /* ====== CARD LEVE ====== */
        .ftx-card {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .ftx-card-title {
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ftx-card-title i {
            --fa-primary-color: #3D5771;
            --fa-secondary-color: #6b8ba3;
            --fa-secondary-opacity: 0.7;
            font-size: 0.95rem;
        }

        .ftx-card-title span {
            font-family: 'Outfit', sans-serif !important;
            font-weight: 600 !important;
            font-size: 0.85rem;
            color: #3D5771;
        }

        .ftx-card-body {
            padding: 1rem;
        }

        /* ====== CAMPOS DO FORMUL√ÅRIO ====== */
        .ftx-form-group {
            margin-bottom: 0.75rem;
        }

        .ftx-form-group label {
            font-weight: 600;
            font-size: 0.8rem;
            color: #495057;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .ftx-form-group label i {
            --fa-primary-color: #6c757d;
            --fa-secondary-color: #adb5bd;
            font-size: 0.85rem;
        }

        .ftx-form-group .form-control {
            min-height: 2.2rem;
            padding: 0.4rem 0.65rem;
            font-size: 0.875rem;
            border-radius: 4px;
            border: 1px solid #ced4da;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .ftx-form-group .form-control:focus {
            border-color: #3D5771;
            box-shadow: 0 0 0 3px rgba(61, 87, 113, 0.15);
        }

        .ftx-form-group .form-select {
            min-height: 2.2rem;
            padding: 0.4rem 0.65rem;
            font-size: 0.875rem;
        }

        .text-danger {
            font-size: 0.75rem;
        }

        /* ====== CHECKBOX ESTILIZADO ====== */
        .ftx-check-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .ftx-check-card:hover {
            border-color: #3D5771;
            background: #fff;
        }

        .ftx-check-card .form-check-input {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
            margin: 0;
        }

        .ftx-check-card .form-check-input:checked {
            background-color: #38A169;
            border-color: #38A169;
        }

        .ftx-check-card label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #495057;
            cursor: pointer;
            margin: 0;
        }

        /* ====== CONTAINER DE FOTO ====== */
        .ftx-foto-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .ftx-foto-container {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #3D5771;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            background: #f8f9fa;
        }

        .ftx-foto-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ftx-foto-upload {
            position: relative;
        }

        .ftx-foto-upload input[type="file"] {
            max-width: 250px;
        }

        /* ====== INFO DE ALTERA√á√ÉO ====== */
        .ftx-info-alteracao {
            background: linear-gradient(135deg, #e9ecef 0%, #f1f3f5 100%);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ftx-info-alteracao i {
            --fa-primary-color: #6c757d;
            --fa-secondary-color: #adb5bd;
        }

        /* ====== BOT√ïES DE A√á√ÉO ====== */
        .ftx-btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .ftx-btn-group .btn {
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 160px;
            justify-content: center;
        }

        /* ====== RESPONSIVO ====== */
        @@media (max-width: 768px) {
            .ftx-card-header {
                flex-direction: column;
                text-align: center;
            }

            .ftx-card-header .titulo-paginas {
                font-size: 1.2rem;
            }

            .ftx-btn-group {
                width: 100%;
            }

            .ftx-btn-group .btn {
                flex: 1;
            }
        }
    </style>
}

<form method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel">
                <div class="panel-container show">

                    <!-- HEADER AZUL PADR√ÉO FROTIX -->
                    <div class="ftx-card-header">
                        <h2 class="titulo-paginas">
                            <i class="fa-duotone fa-car-wash"></i>
                            @(isEdicao ? "Atualizar" : "Cadastrar") Lavador
                        </h2>
                        <a href="/Lavador" class="btn btn-fundo-laranja" data-ftx-loading>
                            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i>
                            Voltar √† Lista
                        </a>
                    </div>

                    <!-- CONTE√öDO -->
                    <div class="panel-content">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        @if (isEdicao)
                        {
                            <input type="hidden" asp-for="LavadorObj.Lavador.LavadorId" />
                        }
                        <input type="hidden" asp-for="LavadorObj.Lavador.UsuarioIdAlteracao" />

                        <div class="row">
                            <!-- COLUNA PRINCIPAL (DADOS) -->
                            <div class="col-lg-8">

                                <!-- CARD: DADOS PESSOAIS -->
                                <div class="ftx-card">
                                    <div class="ftx-card-title">
                                        <i class="fa-duotone fa-id-card"></i>
                                        <span>Dados Pessoais</span>
                                    </div>
                                    <div class="ftx-card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="ftx-form-group">
                                                    <label class="label-required">
                                                        <i class="fa-duotone fa-user"></i>
                                                        Nome Completo
                                                    </label>
                                                    <input class="form-control" asp-for="LavadorObj.Lavador.Nome"
                                                        placeholder="Nome do lavador" />
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.Nome"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="ftx-form-group">
                                                    <label class="label-required">
                                                        <i class="fa-duotone fa-id-badge"></i>
                                                        CPF
                                                    </label>
                                                    <input class="form-control" asp-for="LavadorObj.Lavador.CPF"
                                                        placeholder="000.000.000-00" inputmode="numeric"
                                                        oninput="mascara(this)" />
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.CPF"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="ftx-form-group">
                                                    <label class="label-required">
                                                        <i class="fa-duotone fa-cake-candles"></i>
                                                        Data de Nascimento
                                                    </label>
                                                    <input class="form-control"
                                                        asp-for="LavadorObj.Lavador.DataNascimento" type="date" />
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.DataNascimento"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="ftx-form-group">
                                                    <label class="label-required">
                                                        <i class="fa-duotone fa-mobile"></i>
                                                        Celular 1
                                                    </label>
                                                    <input class="form-control" asp-for="LavadorObj.Lavador.Celular01"
                                                        placeholder="(00) 00000-0000" />
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.Celular01"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="ftx-form-group">
                                                    <label>
                                                        <i class="fa-duotone fa-phone"></i>
                                                        Celular 2
                                                    </label>
                                                    <input class="form-control" asp-for="LavadorObj.Lavador.Celular02"
                                                        placeholder="(00) 00000-0000" />
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.Celular02"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- CARD: DADOS PROFISSIONAIS -->
                                <div class="ftx-card">
                                    <div class="ftx-card-title">
                                        <i class="fa-duotone fa-briefcase"></i>
                                        <span>Dados Profissionais</span>
                                    </div>
                                    <div class="ftx-card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="ftx-form-group">
                                                    <label class="label-required">
                                                        <i class="fa-duotone fa-hashtag"></i>
                                                        Ponto
                                                    </label>
                                                    <input class="form-control" asp-for="LavadorObj.Lavador.Ponto"
                                                        placeholder="p_0000" />
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.Ponto"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="ftx-form-group">
                                                    <label>
                                                        <i class="fa-duotone fa-calendar-check"></i>
                                                        Data de Ingresso
                                                    </label>
                                                    <input class="form-control"
                                                        asp-for="LavadorObj.Lavador.DataIngresso" type="date" />
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.DataIngresso"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="ftx-form-group">
                                                    <label class="label-required">
                                                        <i class="fa-duotone fa-file-contract"></i>
                                                        Contrato
                                                    </label>
                                                    @Html.DropDownListFor(
                                                    m => m.LavadorObj.Lavador.ContratoId,
                                                                                                        Model.LavadorObj.ContratoList,
                                                                                                        "-- Selecione um Contrato --",
                                                                                                        new { @class = "form-select" }
                                                                                                        )
                                                    <span class="text-danger"
                                                        asp-validation-for="LavadorObj.Lavador.ContratoId"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-2">
                                            <div class="col-md-4">
                                                <div class="ftx-check-card">
                                                    <input type="checkbox" class="form-check-input"
                                                        asp-for="LavadorObj.Lavador.Status" id="chkStatus" />
                                                    <label for="chkStatus">
                                                        Lavador Ativo
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- INFO DE ALTERA√á√ÉO -->
                                @if (isEdicao)
                                {
                                    <div class="ftx-info-alteracao mb-3">
                                        <i class="fa-duotone fa-clock-rotate-left"></i>
                                        Alterado por <strong>@Model.LavadorObj.NomeUsuarioAlteracao</strong>
                                        em @(Model.LavadorObj.Lavador.DataAlteracao?.ToString("dd/MM/yyyy") ?? "")
                                        √†s @(Model.LavadorObj.Lavador.DataAlteracao?.ToString("HH:mm") ?? "")
                                    </div>
                                }

                                <!-- BOT√ïES DE A√á√ÉO -->
                                <div class="ftx-btn-group">
                                    @if (isEdicao)
                                    {
                                        <button type="submit" asp-page-handler="Edit"
                                            asp-route-id="@Model.LavadorObj.Lavador.LavadorId"
                                            class="btn btn-azul btn-submit-spin">
                                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                            Atualizar Lavador
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="submit" asp-page-handler="Submit"
                                            class="btn btn-azul btn-submit-spin">
                                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                            Criar Lavador
                                        </button>
                                    }
                                    <a asp-page="./Index" class="btn btn-ftx-fechar" data-ftx-loading>
                                        <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i>
                                        Cancelar Opera√ß√£o
                                    </a>
                                </div>

                            </div>

                            <!-- COLUNA LATERAL (FOTO) -->
                            <div class="col-lg-4">
                                <div class="ftx-card">
                                    <div class="ftx-card-title">
                                        <i class="fa-duotone fa-camera"></i>
                                        <span>Foto do Lavador</span>
                                    </div>
                                    <div class="ftx-card-body">
                                        <div class="ftx-foto-section">
                                            <div class="ftx-foto-container">
                                                <img id="imgViewer" src="/Images/barbudo.jpg" alt="Foto do Lavador" />
                                            </div>
                                            <div class="ftx-foto-upload">
                                                <input class="form-control" id="txtFile" type="file" accept="image/*"
                                                    asp-for="FotoUpload" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</form>

@section ScriptsBlock {
    <script>
        // --------- M√°scara CPF ---------
        function mascara(i) {
            try {
                var v = i.value || "";
                v = v.replace(/\D/g, "");

                if (v.length > 11) v = v.substring(0, 11);

                if (v.length > 9) {
                    v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, "$1.$2.$3-$4");
                } else if (v.length > 6) {
                    v = v.replace(/(\d{3})(\d{3})(\d{0,3})/, "$1.$2.$3");
                } else if (v.length > 3) {
                    v = v.replace(/(\d{3})(\d{0,3})/, "$1.$2");
                }

                i.value = v;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "mascara", error);
            }
        }

        // --------- Preview da Foto ---------
        $("#txtFile").on("change", function (event) {
            try {
                var files = event.target.files;
                if (files && files[0]) {
                    $("#imgViewer").attr("src", window.URL.createObjectURL(files[0]));
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtFile.change", error);
            }
        });

        // --------- Inicializa√ß√£o ---------
        $(document).ready(function () {
            try {
                const lavadorId = '@Model.LavadorObj.Lavador.LavadorId';
                const idVazio = '00000000-0000-0000-0000-000000000000';

                if (lavadorId && lavadorId !== idVazio) {
                    // Edi√ß√£o: carrega foto do backend
                    $.ajax({
                        type: "GET",
                        url: "/api/Lavador/PegaFoto",
                        data: { id: lavadorId },
                        success: function (data) {
                            try {
                                if (data && data.foto) {
                                    $('#imgViewer').attr('src', "data:image/jpg;base64," + data.foto);
                                } else {
                                    $('#imgViewer').attr('src', "/Images/barbudo.jpg");
                                }
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("Upsert.cshtml", "PegaFoto.success", error);
                            }
                        },
                        error: function (xhr) {
                            try {
                                console.warn('Erro ao carregar foto:', xhr);
                                $('#imgViewer').attr('src', "/Images/barbudo.jpg");
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("Upsert.cshtml", "PegaFoto.error", error);
                            }
                        }
                    });
                } else {
                    // Inser√ß√£o: foto padr√£o + marca Status como ativo
                    $('#imgViewer').attr('src', "/Images/barbudo.jpg");
                    $('#chkStatus').prop('checked', true);
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "document.ready", error);
            }
        });
    </script>
}