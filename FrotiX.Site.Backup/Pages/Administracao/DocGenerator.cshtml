@page

@* ╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
   ║  ███████╗██████╗  ██████╗ ████████╗██╗██╗  ██╗    ███████╗██╗████████╗███████╗                        ║
   ║  ██╔════╝██╔══██╗██╔═══██╗╚══██╔══╝██║╚██╗██╔╝    ██╔════╝██║╚══██╔══╝██╔════╝                        ║
   ║  █████╗  ██████╔╝██║   ██║   ██║   ██║ ╚███╔╝     ███████╗██║   ██║   █████╗                          ║
   ║  ██╔══╝  ██╔══██╗██║   ██║   ██║   ██║ ██╔██╗     ╚════██║██║   ██║   ██╔══╝                          ║
   ║  ██║     ██║  ██║╚██████╔╝   ██║   ██║██╔╝ ██╗    ███████║██║   ██║   ███████╗                        ║
   ║  ╚═╝     ╚═╝  ╚═╝ ╚═════╝    ╚═╝   ╚═╝╚═╝  ╚═╝    ╚══════╝╚═╝   ╚═╝   ╚══════╝                        ║
   ╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
   ║ DocGenerator.cshtml                                                                                  ║
   ║ Gerador automático de documentação do sistema                                                        ║
   ╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
   ║ METADATA                                                                                             ║
   ║ @arquivo    DocGenerator.cshtml                                                                      ║
   ║ @local      Pages/Administracao/                                                                     ║
   ║ @versao     1.0.0                                                                                    ║
   ║ @data       23/01/2026                                                                               ║
   ║ @relevancia Ferramenta para gerar documentação técnica automatizada                                  ║
   ╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝ *@

@model FrotiX.Pages.Administracao.DocGeneratorModel
@{
    ViewData["Title"] = "Gerador de Documentação";
}

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap');

    /* Header Padrão */
    .dashboard-header {
        background: linear-gradient(135deg, #4a6075 0%, #3d5266 50%, #2f4050 100%);
        border-radius: 10px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(74, 96, 117, 0.25);
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.03) 50%, transparent 70%);
        animation: shimmer 3s infinite;
    }

    @@keyframes shimmer {
        0% {
            transform: translateX(-100%) rotate(45deg);
        }

        100% {
            transform: translateX(100%) rotate(45deg);
        }
    }

    .dashboard-header .header-icon {
        font-size: 2.8rem;
        color: #fff;
        margin-right: 1rem;
        --fa-primary-color: #fff;
        --fa-secondary-color: rgba(255, 255, 255, 0.7);
        align-self: center;
    }

    .dashboard-header h4 {
        font-family: 'Outfit', sans-serif !important;
        color: #fff !important;
        font-size: 1.5rem;
        font-weight: 900 !important;
        margin: 0;
    }

    .dashboard-header .subtitle {
        font-family: 'Outfit', sans-serif;
        color: rgba(255, 255, 255, 0.75);
        font-size: 0.85rem;
        margin-top: 0.15rem;
    }

    /* Tree View */
    .tree-container {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #fff;
    }

    .tree-node {
        padding: 0.5rem;
        cursor: pointer;
        user-select: none;
    }

    .tree-node:hover {
        background: rgba(74, 96, 117, 0.08);
    }

    .tree-folder {
        font-weight: 600;
        color: #3d5266;
    }

    .tree-file {
        color: #555;
    }

    .tree-toggle {
        width: 20px;
        display: inline-block;
        text-align: center;
    }

    .tree-checkbox {
        margin-right: 8px;
    }

    .tree-icon {
        margin-right: 6px;
        --fa-primary-color: #b66a3d;
        --fa-secondary-color: #6c757d;
    }

    .tree-children {
        margin-left: 20px;
    }

    .tree-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        margin-left: 8px;
        border-radius: 10px;
    }

    .badge-needs-update {
        background: #ffc107;
        color: #000;
    }

    .badge-up-to-date {
        background: #28a745;
        color: #fff;
    }

    .badge-new {
        background: #17a2b8;
        color: #fff;
    }

    /* Config Panel */
    .config-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .config-label {
        font-weight: 600;
        color: #3d5266;
        font-size: 0.85rem;
    }

    /* Progress Area */
    .progress-container {
        display: none;
        background: #fff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .progress-container.active {
        display: block;
    }

    /* Overlay de processamento */
    .processing-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .processing-overlay.active {
        display: flex;
    }

    .processing-box {
        background: linear-gradient(135deg, #2d3e50 0%, #1a252f 100%);
        border-radius: 16px;
        padding: 2rem 3rem;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-width: 600px;
        max-width: 800px;
    }

    .processing-log-container {
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-top: 1rem;
        text-align: left;
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 0.75rem;
    }

    .processing-log-entry {
        margin-bottom: 3px;
        padding: 2px 0;
    }

    .processing-log-time {
        color: #6a9955;
    }

    .processing-log-info {
        color: #9cdcfe;
    }

    .processing-log-success {
        color: #4ec9b0;
    }

    .processing-log-error {
        color: #f44747;
    }

    .processing-log-warning {
        color: #dcdcaa;
    }

    .processing-logo {
        width: 80px;
        height: auto;
        margin-bottom: 1.5rem;
        animation: pulse-logo 1.5s ease-in-out infinite;
    }

    @@keyframes pulse-logo {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }

    .processing-title {
        color: #fff;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .processing-subtitle {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
    }

    .processing-progress {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .processing-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #b66a3d 0%, #c67750 50%, #b66a3d 100%);
        background-size: 200% 100%;
        animation: progress-shimmer 2s linear infinite;
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    @@keyframes progress-shimmer {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    .processing-file {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.85rem;
        font-family: 'Fira Code', monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        word-break: break-all;
    }

    .processing-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1rem;
    }

    .processing-stat {
        text-align: center;
    }

    .processing-stat-number {
        color: #fff;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .processing-stat-label {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.7rem;
        text-transform: uppercase;
    }

    .processing-cancel-btn {
        margin-top: 1.5rem;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.8);
        padding: 0.5rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .processing-cancel-btn:hover {
        background: rgba(220, 53, 69, 0.8);
        border-color: #dc3545;
        color: #fff;
    }

    .progress-bar-custom {
        height: 24px;
        background: linear-gradient(90deg, #b66a3d 0%, #c67750 100%);
        border-radius: 12px;
        transition: width 0.3s ease;
    }

    /* Log Area */
    .log-container {
        max-height: 300px;
        overflow-y: auto;
        background: #1e1e1e;
        color: #d4d4d4;
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 0.8rem;
    }

    .log-entry {
        margin-bottom: 4px;
        padding: 2px 0;
    }

    .log-time {
        color: #6a9955;
    }

    .log-info {
        color: #569cd6;
    }

    .log-success {
        color: #4ec9b0;
    }

    .log-error {
        color: #f44747;
    }

    .log-warning {
        color: #dcdcaa;
    }

    /* Stats Cards */
    .stat-card {
        background: #fff;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #3d5266;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
    }

    /* Buttons */
    .btn-generate {
        background: linear-gradient(135deg, #b66a3d 0%, #c67750 100%);
        border: none;
        color: #fff;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(182, 106, 61, 0.3);
        transition: all 0.2s;
    }

    .btn-generate:hover {
        background: linear-gradient(135deg, #a55d35 0%, #b06640 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(182, 106, 61, 0.4);
        color: #fff;
    }

    .btn-generate:disabled {
        background: #ccc;
        box-shadow: none;
        transform: none;
        cursor: not-allowed;
    }

    .btn-cancel {
        background: #dc3545;
        border: none;
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 6px;
    }

    /* Category Icons */
    .category-controller {
        --fa-primary-color: #3498db;
    }

    .category-page {
        --fa-primary-color: #9b59b6;
    }

    .category-service {
        --fa-primary-color: #e67e22;
    }

    .category-repository {
        --fa-primary-color: #27ae60;
    }

    .category-helper {
        --fa-primary-color: #f39c12;
    }

    .category-js {
        --fa-primary-color: #f1c40f;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="ftx-card-header" style="border-radius: 10px; margin-bottom: 1.5rem;">
        <h2 class="titulo-paginas">
            <i class="fa-duotone fa-file-code"></i>
            Gerador de Documentação
        </h2>
    </div>

    <!-- Stats Row -->
    <div class="row mb-4" id="statsRow">
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-number" id="statTotal">-</div>
                <div class="stat-label">Total de Arquivos</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-number text-success" id="statWithDocs">-</div>
                <div class="stat-label">Com Documentação</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-number text-warning" id="statNeedUpdate">-</div>
                <div class="stat-label">Precisam Atualizar</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-number text-primary" id="statControllers">-</div>
                <div class="stat-label">Controllers</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-number text-info" id="statPages">-</div>
                <div class="stat-label">Razor Pages</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-number text-secondary" id="statOthers">-</div>
                <div class="stat-label">Outros</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Tree View -->
        <div class="col-lg-7">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fa-duotone fa-folder-tree me-2 text-primary"></i>
                        Estrutura do Projeto
                    </h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="selectAll()">
                            <i class="fa-duotone fa-check-double me-1"></i>Selecionar Tudo
                        </button>
                        <button class="btn btn-sm btn-vinho me-2" onclick="deselectAll()">
                            <i class="fa-duotone fa-xmark me-1"></i>Limpar
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="refreshTree()">
                            <i class="fa-duotone fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="tree-container" id="treeContainer">
                        <div class="p-4 text-center text-muted">
                            <i class="fa-duotone fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Carregando estrutura...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Configuration -->
        <div class="col-lg-5">
            <!-- Configuration -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white py-2">
                    <h6 class="mb-0">
                        <i class="fa-duotone fa-sliders me-2 text-info"></i>
                        Configurações
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="config-label">Provedor de IA</label>
                            <select class="form-select form-select-sm" id="aiProvider">
                                <option value="none">Sem IA (Heurísticas)</option>
                                <option value="openai">OpenAI (GPT-4o)</option>
                                <option value="claude">Anthropic Claude</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="config-label">Nível de Detalhe</label>
                            <select class="form-select form-select-sm" id="detailLevel">
                                <option value="minimal">Mínimo</option>
                                <option value="standard" selected>Padrão (500+ linhas)</option>
                                <option value="detailed">Detalhado (1000+ linhas)</option>
                                <option value="exhaustive">Exaustivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="onlyModified" checked>
                                <label class="form-check-label" for="onlyModified">
                                    Apenas arquivos modificados
                                </label>
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="forceRegenerate">
                                <label class="form-check-label" for="forceRegenerate">
                                    Forçar regeneração (ignorar cache)
                                </label>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generateMarkdown" checked>
                                <label class="form-check-label" for="generateMarkdown">
                                    Gerar Markdown (.md)
                                </label>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generateHtml" checked>
                                <label class="form-check-label" for="generateHtml">
                                    Gerar HTML A4
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card shadow-sm mb-3">
                <div class="card-body text-center">
                    <button class="btn btn-generate btn-lg" id="btnGenerate" onclick="startGeneration()">
                        <i class="fa-duotone fa-wand-magic-sparkles me-2"></i>
                        Gerar Documentação
                    </button>
                    <button class="btn btn-cancel ms-2 d-none" id="btnCancel" onclick="cancelGeneration()">
                        <i class="fa-duotone fa-stop me-1"></i>
                        Cancelar
                    </button>
                </div>
            </div>

            <!-- Progress -->
            <div class="progress-container" id="progressContainer">
                <div class="d-flex justify-content-between mb-2">
                    <span id="progressStatus">Processando...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress" style="height: 24px; background: #e9ecef; border-radius: 12px;">
                    <div class="progress-bar-custom" id="progressBar" style="width: 0%;"></div>
                </div>
                <div class="mt-2 text-muted small" id="progressDetails">
                    Arquivo: -
                </div>
            </div>

            <!-- Log -->
            <div class="card shadow-sm">
                <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fa-duotone fa-terminal me-2 text-dark"></i>
                        Log de Execução
                    </h6>
                    <button class="btn btn-sm btn-vinho" onclick="clearLog()">
                        <i class="fa-duotone fa-trash me-1"></i>Limpar
                    </button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-time">[Sistema]</span>
                        <span class="log-info">Aguardando comando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overlay de Processamento -->
<div class="processing-overlay" id="processingOverlay">
    <div class="processing-box">
        <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" class="processing-logo" />
        <div class="processing-title" id="overlayTitle">Gerando Documentação...</div>
        <div class="processing-subtitle" id="overlaySubtitle">Aguarde enquanto processamos seus arquivos</div>

        <div class="processing-progress">
            <div class="processing-progress-bar" id="overlayProgressBar" style="width: 0%;"></div>
        </div>

        <div class="processing-file" id="overlayCurrentFile">Preparando...</div>

        <div class="processing-stats">
            <div class="processing-stat">
                <div class="processing-stat-number" id="overlayProcessed">0</div>
                <div class="processing-stat-label">Processados</div>
            </div>
            <div class="processing-stat">
                <div class="processing-stat-number" id="overlayTotal">0</div>
                <div class="processing-stat-label">Total</div>
            </div>
            <div class="processing-stat">
                <div class="processing-stat-number text-success" id="overlaySuccess">0</div>
                <div class="processing-stat-label">Sucesso</div>
            </div>
            <div class="processing-stat">
                <div class="processing-stat-number text-danger" id="overlayFailed">0</div>
                <div class="processing-stat-label">Falha</div>
            </div>
        </div>

        <!-- Log dentro do overlay -->
        <div class="processing-log-container" id="overlayLogContainer">
            <div class="processing-log-entry">
                <span class="processing-log-time">[Sistema]</span>
                <span class="processing-log-info">Iniciando processamento...</span>
            </div>
        </div>

        <button class="processing-cancel-btn" onclick="cancelGeneration()">
            <i class="fa-duotone fa-stop me-2"></i>Cancelar
        </button>
    </div>
</div>

@section ScriptsBlock {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
            /**
             * ═══════════════════════════════════════════════════════════════════════════
             * DOC GENERATOR - GERADOR DE DOCUMENTAÇÃO AUTOMÁTICA
             * ═══════════════════════════════════════════════════════════════════════════
             * @@description Sistema de geração automática de documentação para arquivos C#
            * Utiliza SignalR para comunicação em tempo real com fallback para polling
                * Integração com IA(OpenAI / Google Gemini) para análise e documentação
                    */

            /**
             * ═══════════════════════════════════════════════════════════════════════════
             * ESTADO GLOBAL DA APLICAÇÃO
             * ═══════════════════════════════════════════════════════════════════════════
             */

            /** @@type { string[] } Lista de caminhos de arquivos selecionados para documentação */
        let selectedPaths = [];
            /** @@type { string | null } ID do job de geração em andamento */
        let currentJobId = null;
            /** @@type { signalR.HubConnection | null } Conexão SignalR ativa */
        let connection = null;
            /** @@type { number | null } Intervalo de polling(fallback quando SignalR falha) */
        let pollingInterval = null;
            /** @@type { boolean } Flag para usar polling em vez de SignalR */
        let usePollingFallback = false;

        /**
         * ═══════════════════════════════════════════════════════════════════════════
         * INICIALIZAÇÃO DA PÁGINA
         * ═══════════════════════════════════════════════════════════════════════════
         */
        document.addEventListener('DOMContentLoaded', function () {
            try {
                initSignalR();  // Configura conexão em tempo real
                refreshTree();  // Carrega árvore de arquivos
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "DOMContentLoaded", erro);
            }
        });

            /**
             * ═══════════════════════════════════════════════════════════════════════════
             * SIGNALR - COMUNICAÇÃO EM TEMPO REAL
             * ═══════════════════════════════════════════════════════════════════════════
             */

            /**
             * Inicializa conexão SignalR com fallback automático
             * @@description Configura conexão com fallback: WebSockets → SSE → LongPolling
            * @@returns { void}
            */
        function initSignalR() {
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/hubs/docgeneration", {
                        // Permitir fallback automático entre transportes
                        transport: signalR.HttpTransportType.WebSockets |
                            signalR.HttpTransportType.ServerSentEvents |
                            signalR.HttpTransportType.LongPolling,
                        withCredentials: true
                    })
                    .withAutomaticReconnect([0, 2000, 5000, 10000, 30000])
                    .configureLogging(signalR.LogLevel.Warning)
                    .build();

                // Handler para progresso de geração (recebido do Hub)
                connection.on("DocGenerationProgress", function (progress) {
                    updateProgress(progress);
                });

                // Handler para confirmação de conexão
                connection.on("Connected", function (connectionId) {
                    addLog("Conectado ao servidor (ID: " + connectionId.substring(0, 8) + "...)", "info");
                });

                // Handlers de estado da conexão
                connection.onreconnecting(function (error) {
                    addLog("Reconectando ao servidor...", "warning");
                });

                connection.onreconnected(function (connectionId) {
                    addLog("Reconectado ao servidor", "success");
                });

                connection.onclose(function (error) {
                    if (error) {
                        addLog("Conexão SignalR fechada: " + (error.message || error.toString()), "warning");
                    }
                });

                // Iniciar conexão
                connection.start()
                    .then(function () {
                        addLog("SignalR conectado", "success");
                    })
                    .catch(function (err) {
                        var errorMsg = err && err.message ? err.message : (err ? err.toString() : 'Erro desconhecido');
                        addLog("Erro SignalR: " + errorMsg + " (usando polling)", "warning");
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "initSignalR", erro);
            }
        }

            /**
             * ═══════════════════════════════════════════════════════════════════════════
             * ÁRVORE DE ARQUIVOS - CARREGAMENTO E RENDERIZAÇÃO
             * ═══════════════════════════════════════════════════════════════════════════
             */

            /**
             * Carrega a árvore de arquivos do servidor
             * @@description Faz requisição GET à API e renderiza estrutura de diretórios
            * @@returns { void}
            */
        function refreshTree() {
            try {
                // Exibe loading enquanto carrega
                document.getElementById('treeContainer').innerHTML = `
                            <div class="p-4 text-center text-muted">
                                <i class="fa-duotone fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Carregando estrutura...</p>
                            </div>
                        `;

                fetch('/api/docgenerator/discover')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            renderStats(result.data);
                            renderTree(result.data.tree);
                            addLog("Estrutura carregada: " + result.data.totalFiles + " arquivos", "success");
                        } else {
                            addLog("Erro ao carregar: " + result.message, "error");
                        }
                    })
                    .catch(err => {
                        addLog("Erro: " + err.message, "error");
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "refreshTree", erro);
            }
        }

            /**
             * Renderiza estatísticas de arquivos
             * @@description Atualiza contadores na interface(total, com docs, precisam atualizar)
            * @@param { Object } data - Dados de estatísticas do servidor
                * @@returns { void}
                */
            function renderStats(data) {
                try {
                    document.getElementById('statTotal').textContent = data.totalFiles || 0;
                    document.getElementById('statWithDocs').textContent = data.filesWithDocs || 0;
                    document.getElementById('statNeedUpdate').textContent = data.filesNeedingUpdate || 0;

                    // Estatísticas por categoria
                    const byCategory = data.filesByCategory || {};
                    document.getElementById('statControllers').textContent = byCategory['Controller'] || 0;
                    document.getElementById('statPages').textContent =
                        (byCategory['RazorPage'] || 0) + (byCategory['RazorPageModel'] || 0);
                    document.getElementById('statOthers').textContent =
                        (byCategory['Service'] || 0) + (byCategory['Repository'] || 0) +
                        (byCategory['JavaScript'] || 0) + (byCategory['Helper'] || 0);
                } catch (erro) {
                    Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "renderStats", erro);
                }
            }

            /**
             * Renderiza a árvore de arquivos recursivamente
             * @@description Cria HTML da estrutura de diretórios e arquivos com checkboxes
            * @@param { Object } node - Nó da árvore(pasta ou arquivo)
                * @@param { number } level - Nível de profundidade(para indentação)
                    * @@returns { string } HTML da árvore
                        */
        function renderTree(node, level = 0) {
            try {
                if (!node) return '';

                let html = '';

                if (level === 0) {
                    html += '<div class="tree-root p-2">';
                }

                // Pastas - renderiza recursivamente
                if (node.children && node.children.length > 0) {
                    html += `<div class="tree-node tree-folder" style="padding-left: ${level * 16}px;">
                                <span class="tree-toggle" onclick="toggleFolder(this)">
                                    <i class="fa-duotone fa-caret-down"></i>
                                </span>
                                <input type="checkbox" class="tree-checkbox" data-path="${node.path}" onchange="toggleSelection(this)">
                                <i class="fa-duotone fa-folder tree-icon"></i>
                                <span>${node.name}</span>
                                <span class="badge bg-secondary tree-badge">${node.totalFiles}</span>
                            </div>
                            <div class="tree-children">`;

                    for (const child of node.children) {
                        html += renderTree(child, level + 1);
                    }

                    // Arquivos dentro da pasta
                    if (node.files && node.files.length > 0) {
                        for (const file of node.files) {
                            const icon = getCategoryIcon(file.category);
                            // Badge de status: Atualizar (precisa regen) / OK (tem doc) / Novo (sem doc)
                            const badge = file.needsRegeneration
                                ? '<span class="badge badge-needs-update tree-badge">Atualizar</span>'
                                : (file.hasExistingDoc
                                    ? '<span class="badge badge-up-to-date tree-badge">OK</span>'
                                    : '<span class="badge badge-new tree-badge">Novo</span>');

                            html += `<div class="tree-node tree-file" style="padding-left: ${(level + 1) * 16}px;">
                                        <span class="tree-toggle"></span>
                                        <input type="checkbox" class="tree-checkbox" data-path="${file.relativePath}" onchange="toggleSelection(this)">
                                        <i class="${icon} tree-icon"></i>
                                        <span>${file.fileName}</span>
                                        ${badge}
                                    </div>`;
                        }
                    }

                    html += '</div>';
                } else if (node.files && node.files.length > 0) {
                    for (const file of node.files) {
                        const icon = getCategoryIcon(file.category);
                        const badge = file.needsRegeneration
                            ? '<span class="badge badge-needs-update tree-badge">Atualizar</span>'
                            : (file.hasExistingDoc
                                ? '<span class="badge badge-up-to-date tree-badge">OK</span>'
                                : '<span class="badge badge-new tree-badge">Novo</span>');

                        html += `<div class="tree-node tree-file" style="padding-left: ${level * 16}px;">
                                    <span class="tree-toggle"></span>
                                    <input type="checkbox" class="tree-checkbox" data-path="${file.relativePath}" onchange="toggleSelection(this)">
                                    <i class="${icon} tree-icon"></i>
                                    <span>${file.fileName}</span>
                                    ${badge}
                                </div>`;
                    }
                }

                if (level === 0) {
                    html += '</div>';
                    document.getElementById('treeContainer').innerHTML = html;
                    return;
                }

                return html;
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "renderTree", erro);
                return '';
            }
        }

        // Obter ícone por categoria
        function getCategoryIcon(category) {
            const icons = {
                'Controller': 'fa-duotone fa-gears category-controller',
                'RazorPage': 'fa-duotone fa-file-code category-page',
                'RazorPageModel': 'fa-duotone fa-file-lines category-page',
                'Service': 'fa-duotone fa-cog category-service',
                'Repository': 'fa-duotone fa-database category-repository',
                'Helper': 'fa-duotone fa-toolbox category-helper',
                'JavaScript': 'fa-duotone fa-js category-js',
                'Css': 'fa-duotone fa-css3',
                'Model': 'fa-duotone fa-cube',
                'Hub': 'fa-duotone fa-broadcast-tower'
            };
            return icons[category] || 'fa-duotone fa-file';
        }

        // Toggle pasta
        function toggleFolder(element) {
            try {
                const children = element.closest('.tree-node').nextElementSibling;
                const icon = element.querySelector('i');

                if (children && children.classList.contains('tree-children')) {
                    children.style.display = children.style.display === 'none' ? 'block' : 'none';
                    icon.classList.toggle('fa-caret-down');
                    icon.classList.toggle('fa-caret-right');
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "toggleFolder", erro);
            }
        }

        // Toggle seleção
        function toggleSelection(checkbox, propagateToChildren = true) {
            try {
                const path = checkbox.dataset.path;
                const node = checkbox.closest('.tree-node');
                const isFolder = node.classList.contains('tree-folder');
                const isFile = node.classList.contains('tree-file');

                // DEBUG: Log para verificar seleção
                console.log(`[toggleSelection] path="${path}", isFolder=${isFolder}, isFile=${isFile}, checked=${checkbox.checked}`);

                // Apenas adicionar paths de ARQUIVOS ao selectedPaths (não pastas)
                if (isFile && path) {
                    if (checkbox.checked) {
                        if (!selectedPaths.includes(path)) {
                            selectedPaths.push(path);
                            console.log(`[toggleSelection] Adicionado: ${path}`);
                        }
                    } else {
                        selectedPaths = selectedPaths.filter(p => p !== path);
                        console.log(`[toggleSelection] Removido: ${path}`);
                    }
                }

                // Log estado atual
                console.log(`[toggleSelection] selectedPaths atual (${selectedPaths.length}):`, selectedPaths);

                // Selecionar filhos se for pasta (propagar apenas se solicitado)
                if (propagateToChildren) {
                    const children = node.nextElementSibling;

                    if (children && children.classList.contains('tree-children')) {
                        const childCheckboxes = children.querySelectorAll('.tree-checkbox');
                        childCheckboxes.forEach(cb => {
                            cb.checked = checkbox.checked;
                            // Chamar recursivamente mas sem propagar novamente para evitar loops
                            toggleSelection(cb, true);
                        });
                    }
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "toggleSelection", erro);
            }
        }

        // Selecionar todos
        function selectAll() {
            try {
                selectedPaths = []; // Limpar primeiro para evitar duplicatas
                document.querySelectorAll('.tree-checkbox').forEach(cb => {
                    cb.checked = true;
                    const node = cb.closest('.tree-node');
                    const isFile = node.classList.contains('tree-file');
                    const path = cb.dataset.path;

                    // Apenas adicionar paths de ARQUIVOS
                    if (isFile && path && !selectedPaths.includes(path)) {
                        selectedPaths.push(path);
                    }
                });
                console.log(`[selectAll] Total de arquivos selecionados: ${selectedPaths.length}`, selectedPaths);
                addLog(`Todos os arquivos selecionados (${selectedPaths.length})`, "info");
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "selectAll", erro);
            }
        }

        // Desmarcar todos
        function deselectAll() {
            try {
                document.querySelectorAll('.tree-checkbox').forEach(cb => cb.checked = false);
                selectedPaths = [];
                addLog("Seleção limpa", "info");
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "deselectAll", erro);
            }
        }

        // Iniciar geração
        function startGeneration() {
            try {
                const request = {
                    onlyModified: document.getElementById('onlyModified').checked,
                    forceRegenerate: document.getElementById('forceRegenerate').checked,
                    useAi: document.getElementById('aiProvider').value !== 'none',
                    aiProvider: document.getElementById('aiProvider').value,
                    detailLevel: document.getElementById('detailLevel').value,
                    selectedPaths: selectedPaths.length > 0 ? selectedPaths : [],
                    generateMarkdown: document.getElementById('generateMarkdown').checked,
                    generateHtml: document.getElementById('generateHtml').checked
                };

                document.getElementById('btnGenerate').disabled = true;
                document.getElementById('btnCancel').classList.remove('d-none');
                document.getElementById('progressContainer').classList.add('active');

                addLog("Iniciando geração de documentação...", "info");
                addLog(`Arquivos selecionados: ${selectedPaths.length}`, "info");

                // Mostrar overlay de processamento
                showProcessingOverlay();

                fetch('/api/docgenerator/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            currentJobId = result.data.jobId;
                            addLog("Job iniciado: " + currentJobId, "success");
                            addLog("Total de arquivos: " + result.data.totalFiles, "info");

                            // Tentar inscrever no SignalR
                            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                                connection.invoke("SubscribeToJob", currentJobId)
                                    .then(function () {
                                        addLog("Inscrito no SignalR para receber atualizações", "info");
                                    })
                                    .catch(function (err) {
                                        // Iniciar polling como fallback apenas se SignalR falhar
                                        addLog("SignalR indisponível, usando polling...", "warning");
                                        startPolling(currentJobId);
                                    });
                            } else {
                                // SignalR não está conectado, usar polling
                                startPolling(currentJobId);
                            }
                        } else {
                            addLog("Erro: " + result.message, "error");
                            hideProcessingOverlay();
                            resetUI();
                        }
                    })
                    .catch(err => {
                        addLog("Erro: " + err.message, "error");
                        hideProcessingOverlay();
                        resetUI();
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "startGeneration", erro);
            }
        }

        // Cancelar geração
        function cancelGeneration() {
            try {
                if (currentJobId) {
                    // Atualizar overlay para mostrar que está cancelando
                    document.getElementById('overlayTitle').textContent = 'Cancelando...';
                    document.getElementById('overlaySubtitle').textContent = 'Aguarde enquanto cancelamos o processamento';

                    fetch('/api/docgenerator/job/' + currentJobId + '/cancel', { method: 'POST' })
                        .then(response => response.json())
                        .then(result => {
                            addLog("Cancelamento solicitado", "warning");

                            if (result.success) {
                                // Aguardar um pouco e esconder overlay caso SignalR não responda
                                setTimeout(function () {
                                    if (document.getElementById('processingOverlay').classList.contains('active')) {
                                        addLog("Job cancelado com sucesso", "success");
                                        hideProcessingOverlay();
                                        resetUI();
                                    }
                                }, 2000);
                            }
                        })
                        .catch(err => {
                            addLog("Erro ao cancelar: " + err.message, "error");
                            // Mesmo com erro, fechar overlay após delay
                            setTimeout(function () {
                                hideProcessingOverlay();
                                resetUI();
                            }, 1500);
                        });
                } else {
                    // Se não há job, apenas esconder o overlay
                    hideProcessingOverlay();
                    resetUI();
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "cancelGeneration", erro);
            }
        }

        // Polling de status do job como fallback quando SignalR não funciona
        function startPolling(jobId) {
            try {
                console.log('[DocGenerator] Iniciando polling para job:', jobId);
                addLog("Usando polling para acompanhar progresso...", "info");

                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }

                pollingInterval = setInterval(function () {
                    if (!currentJobId) {
                        stopPolling();
                        return;
                    }

                    fetch('/api/docgenerator/job/' + currentJobId)
                        .then(response => response.json())
                        .then(result => {
                            if (result.success && result.data) {
                                var job = result.data;

                                // Criar objeto de progresso compatível com updateProgress
                                var progress = {
                                    jobId: job.jobId,
                                    totalFiles: job.totalFiles,
                                    processedFiles: job.processedFiles,
                                    currentFile: job.currentFile,
                                    currentStatus: job.currentStatus,
                                    message: job.currentFile ? ('Processando: ' + job.currentFile) : 'Em execução...',
                                    isComplete: !job.isRunning,
                                    hasError: job.failedCount > 0 && job.successCount === 0,
                                    errorMessage: ''
                                };

                                // Se terminou, atualizar mensagem
                                if (!job.isRunning) {
                                    if (job.isCancelled) {
                                        progress.message = 'Job cancelado';
                                    } else {
                                        progress.message = 'Concluído! Sucesso: ' + job.successCount + ', Falha: ' + job.failedCount + ', Ignorados: ' + job.skippedCount;
                                    }
                                }

                                updateProgress(progress);

                                // Parar polling se job terminou
                                if (!job.isRunning) {
                                    stopPolling();
                                }
                            }
                        })
                        .catch(err => {
                            // Silencioso - não logar erros de polling
                        });
                }, 2000); // Polling a cada 2 segundos
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "startPolling", erro);
            }
        }

        // Parar polling
        function stopPolling() {
            try {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "stopPolling", erro);
            }
        }

        // Atualizar progresso
        function updateProgress(progress) {
            try {

                // Calcular porcentagem (o servidor envia totalFiles e processedFiles)
                var percent = 0;
                if (progress.totalFiles > 0) {
                    percent = Math.round((progress.processedFiles * 100) / progress.totalFiles);
                }

                // Atualizar painel de progresso na página
                document.getElementById('progressPercent').textContent = percent + '%';
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressDetails').textContent = 'Arquivo: ' + (progress.currentFile || '-');
                document.getElementById('progressStatus').textContent = progress.message || 'Processando...';

                // Atualizar overlay de processamento
                updateProcessingOverlay(progress);

                if (progress.message) {
                    const type = progress.hasError ? 'error' : (progress.isComplete ? 'success' : 'info');
                    addLog(progress.message, type);
                }

                if (progress.isComplete) {
                    hideProcessingOverlay();
                    resetUI();
                    refreshTree();

                    // Mostrar alerta de conclusão
                    if (progress.hasError) {
                        Alerta.Erro("Erro na Geração", progress.errorMessage || "Ocorreu um erro durante a geração.", "OK");
                    } else {
                        Alerta.Sucesso("Documentação Gerada", "A documentação foi gerada com sucesso!", "OK");
                    }
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "updateProgress", erro);
            }
        }

        // Mostrar overlay de processamento
        function showProcessingOverlay() {
            try {
                document.getElementById('processingOverlay').classList.add('active');
                document.getElementById('overlayCurrentFile').textContent = 'Preparando...';
                document.getElementById('overlayProgressBar').style.width = '0%';
                document.getElementById('overlayProcessed').textContent = '0';
                document.getElementById('overlayTotal').textContent = '0';
                document.getElementById('overlaySuccess').textContent = '0';
                document.getElementById('overlayFailed').textContent = '0';
                document.getElementById('overlayTitle').textContent = 'Gerando Documentação...';
                document.getElementById('overlaySubtitle').textContent = 'Aguarde enquanto processamos seus arquivos';

                // Limpar log do overlay
                document.getElementById('overlayLogContainer').innerHTML = `
                            <div class="processing-log-entry">
                                <span class="processing-log-time">[Sistema]</span>
                                <span class="processing-log-info">Iniciando processamento...</span>
                            </div>
                        `;
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "showProcessingOverlay", erro);
            }
        }

        // Esconder overlay de processamento
        function hideProcessingOverlay() {
            try {
                document.getElementById('processingOverlay').classList.remove('active');
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "hideProcessingOverlay", erro);
            }
        }

        // Atualizar overlay de processamento
        function updateProcessingOverlay(progress) {
            try {
                // Calcular porcentagem
                var percent = 0;
                if (progress.totalFiles > 0) {
                    percent = Math.round((progress.processedFiles * 100) / progress.totalFiles);
                }

                document.getElementById('overlayProgressBar').style.width = percent + '%';
                document.getElementById('overlayCurrentFile').textContent = progress.currentFile || 'Processando...';
                document.getElementById('overlayProcessed').textContent = progress.processedFiles || '0';
                document.getElementById('overlayTotal').textContent = progress.totalFiles || '0';

                // Calcular sucesso e falha a partir da mensagem (ou usar valores diretos se disponíveis)
                if (progress.isComplete) {
                    document.getElementById('overlayTitle').textContent = progress.hasError ? 'Erro!' : 'Concluído!';
                    document.getElementById('overlaySubtitle').textContent = progress.message || 'Processamento finalizado';
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "updateProcessingOverlay", erro);
            }
        }

        // Reset UI
        function resetUI() {
            try {
                document.getElementById('btnGenerate').disabled = false;
                document.getElementById('btnCancel').classList.add('d-none');
                currentJobId = null;
                stopPolling(); // Parar polling quando resetar UI
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "resetUI", erro);
            }
        }

        // Adicionar log (tanto no painel quanto no overlay)
        function addLog(message, type = 'info') {
            try {
                const container = document.getElementById('logContainer');
                const overlayContainer = document.getElementById('overlayLogContainer');
                const time = new Date().toLocaleTimeString('pt-BR');

                // Adicionar ao log principal (painel)
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;

                // Adicionar ao log do overlay (se estiver visível)
                if (overlayContainer && document.getElementById('processingOverlay').classList.contains('active')) {
                    const overlayEntry = document.createElement('div');
                    overlayEntry.className = 'processing-log-entry';
                    overlayEntry.innerHTML = `<span class="processing-log-time">[${time}]</span> <span class="processing-log-${type}">${message}</span>`;
                    overlayContainer.appendChild(overlayEntry);
                    overlayContainer.scrollTop = overlayContainer.scrollHeight;
                }
            } catch (erro) {
                console.error("Erro ao adicionar log:", erro);
            }
        }

        // Limpar log
        function clearLog() {
            try {
                document.getElementById('logContainer').innerHTML = `
                            <div class="log-entry">
                                <span class="log-time">[Sistema]</span>
                                <span class="log-info">Log limpo</span>
                            </div>
                        `;
            } catch (erro) {
                Alerta.TratamentoErroComLinha("DocGenerator.cshtml", "clearLog", erro);
            }
        }
    </script>
}