@* ****************************************************************************************
 * âš¡ ARQUIVO: Pages/Multa/ListaTiposMulta.cshtml
 * --------------------------------------------------------------------------------------
 * ğŸ¯ OBJETIVO     : Listagem de infraÃ§Ãµes/tipos de multa (CÃ³digo de TrÃ¢nsito Brasileiro) com editar/excluir
 * ğŸ“¥ ENTRADAS     : @page, @model ListaTiposMultaModel, cliques: btn-delete (delegado)
 * ğŸ“¤ SAÃDAS       : DataTable #tblTipoMulta (JSON /api/Multa/PegaTipoMulta), POST /api/Multa/DeleteTipoMulta, AppToast feedback
 * ğŸ”— CHAMADA POR  : Menu Multas/Cadastros, botÃ£o "Nova InfraÃ§Ã£o", navegaÃ§Ã£o
 * ğŸ”„ CHAMA        : /api/Multa/PegaTipoMulta, /api/Multa/DeleteTipoMulta, ./UpsertTipoMulta
 * ğŸ“¦ DEPENDÃŠNCIAS : DataTables (Buttons: pageLength, excel, pdfHtml5), Font Awesome Duotone, Bootstrap (implÃ­cito), Alerta.* (custom), AppToast
 * ğŸ“ OBSERVAÃ‡Ã•ES  : Total: 192 linhas. CSS inline pequeno (70 linhas) - pode extrair mas nÃ£o crÃ­tico, JavaScript inline moderado (122 linhas) - mover para JS externo (bom candidato), PADRÃƒO CORRETO: Usa try-catch com Alerta.TratamentoErroComLinha em todos os handlers - excelente, DataTable: 5 colunas (Artigo, Denatran, DescriÃ§Ã£o, InfraÃ§Ã£o, AÃ§Ã£o) - correto, BotÃµes DataTables: excel e PDF landscape - Ãºtil para relatÃ³rios, Token antiforgery via __RequestVerificationToken - seguranÃ§a OK, loadList() destroi e recria DataTable - correto para evitar duplicaÃ§Ã£o
 **************************************************************************************** *@
@page
@model FrotiX.Pages.Multa.ListaTiposMultaModel

@{
    ViewData["Title"] = "InfraÃ§Ãµes";
    ViewData["PageName"] = "multa_tiposmulta";
    ViewData["Heading"] = "<i class='fa-duotone fa-ballot-check'></i> Cadastros: <span class='fw-300'>CÃ³digo de TrÃ¢nsito - InfraÃ§Ãµes</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-ballot-check";
}

@section HeadBlock {
    <style>
        /* ======== OUTLINE BRANCO NO BOTÃƒO DO HEADER (PadrÃ£o FrotiX) ======== */
        .ftx-card-header .btn-fundo-laranja {
            outline: 2px solid rgba(255, 255, 255, 0.5) !important;
            outline-offset: 1px;
            transition: all 0.2s ease;
        }

        .ftx-card-header .btn-fundo-laranja:hover {
            outline: 2px solid rgba(255, 255, 255, 0.8) !important;
            outline-offset: 2px;
        }
    </style>
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <div class="panel-container show">

                <!-- HEADER PADRÃƒO FROTIX -->
                <div class="ftx-card-header">
                    <h2 class="titulo-paginas">
                        <i class="fa-duotone fa-list-check"></i>
                        InfraÃ§Ãµes de TrÃ¢nsito
                    </h2>
                    <div class="ftx-card-actions">
                        <a href="/Multa/UpsertTipoMulta" class="btn btn-fundo-laranja" data-ftx-loading>
                            <i class="fa-duotone fa-clone-plus icon-pulse me-1"></i>
                            Nova InfraÃ§Ã£o
                        </a>
                    </div>
                </div>

                <!-- CONTEÃšDO -->
                <div class="panel-content">
                    <div class="box-body">
                        <table id="tblTipoMulta" class="table table-bordered table-striped nowrap" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Artigo/ParÃ¡grafo/Ãndice</th>
                                    <th>CÃ³digo Denatran</th>
                                    <th>DescriÃ§Ã£o</th>
                                    <th>InfraÃ§Ã£o</th>
                                    <th style="min-width:100px">AÃ§Ã£o</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script asp-append-version="true">
            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * LISTA TIPOS DE MULTA - GERENCIAMENTO DE INFRAÃ‡Ã•ES
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * @@description Listagem de tipos de multa / infraÃ§Ã£o com DataTable.
             * Permite visualizar, editar e excluir registros.
             * @@requires jQuery DataTables, Bootstrap, Alerta
            * @@file Multa / ListaTiposMulta.cshtml
            */

        let dataTable;

        $(document).ready(function () {
            try {
                loadList();

                $(document).on('click', '.btn-delete', function () {
                    try {
                        const id = $(this).data('id');

                        Alerta.Confirmar(
                            "Confirmar ExclusÃ£o",
                            "VocÃª tem certeza que deseja apagar esta infraÃ§Ã£o? NÃ£o serÃ¡ possÃ­vel recuperar os dados eliminados!",
                            "Excluir",
                            "Cancelar"
                        ).then(function (confirmed) {
                            try {
                                if (!confirmed) return;

                                const token = document.getElementsByName('__RequestVerificationToken')[0]?.value || '';

                                $.ajax({
                                    url: '/api/Multa/DeleteTipoMulta',
                                    type: "POST",
                                    data: JSON.stringify({ TipoMultaId: id }),
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    beforeSend: function (xhr) {
                                        try {
                                            if (token) xhr.setRequestHeader('RequestVerificationToken', token);
                                        } catch (error) {
                                            Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "btn-delete.ajax.beforeSend", error);
                                        }
                                    },
                                    success: function (data) {
                                        try {
                                            if (data?.success) {
                                                AppToast.show('Verde', data.message || "ExcluÃ­do com sucesso.", 2000);
                                                dataTable.ajax.reload(null, false);
                                            } else {
                                                AppToast.show('Vermelho', data?.message || "Falha ao excluir.", 2000);
                                            }
                                        } catch (error) {
                                            Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "btn-delete.ajax.success", error);
                                        }
                                    },
                                    error: function (err) {
                                        try {
                                            Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "btn-delete.ajax.error", err);
                                            AppToast.show('Vermelho', "Erro inesperado ao excluir.", 2000);
                                        } catch (error) {
                                            Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "btn-delete.ajax.error.catch", error);
                                        }
                                    }
                                });
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "btn-delete.confirmar.then", error);
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "btn-delete.click", error);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "document.ready", error);
            }
        });

            /**
             * Carrega/recarrega DataTable de tipos de multa
             * @@description Inicializa tabela com AJAX para / api / Multa / PegaTipoMulta
            * Suporta exportaÃ§Ã£o Excel / PDF, paginaÃ§Ã£o e ordenaÃ§Ã£o
                */
        function loadList() {
            try {
                if ($.fn.DataTable.isDataTable('#tblTipoMulta')) {
                    dataTable.destroy();
                    $('#tblTipoMulta tbody').empty();
                }

                dataTable = $('#tblTipoMulta').DataTable({
                    responsive: true,
                    autoWidth: false,
                    dom: 'Bfrtip',
                    lengthMenu: [[10, 25, 50, -1], ['10 linhas', '25 linhas', '50 linhas', 'Todas as Linhas']],
                    buttons: [
                        'pageLength',
                        'excel',
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            pageSize: 'LEGAL',
                            text: 'PDF'
                        }
                    ],
                    order: [[0, 'asc']],
                    columnDefs: [
                        { targets: 0, className: "text-left", width: "18%" },
                        { targets: 1, className: "text-left", width: "12%" },
                        { targets: 2, className: "text-left", width: "48%" },
                        { targets: 3, className: "text-center", width: "10%" },
                        { targets: 4, className: "text-center", width: "12%" }
                    ],
                    ajax: {
                        url: "/api/Multa/PegaTipoMulta",
                        type: "GET",
                        dataType: "json"
                    },
                    columns: [
                        { "data": "artigo" },
                        { "data": "denatran" },
                        { "data": "descricao" },
                        { "data": "infracao" },
                        {
                            "data": "tipoMultaId",
                            "render": function (data) {
                                try {
                                    const edit = `<a href="/Multa/UpsertTipoMulta?id=${data}" 
                                                         class="btn btn-sm btn-azul text-white btn-icon-28" 
                                                         data-ejtip="Editar InfraÃ§Ã£o">
                                                         <i class="fa-duotone fa-edit"></i>
                                                      </a>`;
                                    const del = `<button type="button" 
                                                             class="btn btn-sm btn-vinho text-white btn-icon-28 btn-delete" 
                                                             data-id="${data}" 
                                                             data-ejtip="Excluir InfraÃ§Ã£o">
                                                             <i class="fa-duotone fa-trash-alt"></i>
                                                     </button>`;
                                    return `<div class="d-flex justify-content-center gap-1">${edit}${del}</div>`;
                                } catch (error) {
                                    Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "columns.render", error);
                                    return '';
                                }
                            }
                        }
                    ],
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                        emptyTable: "Sem Dados para ExibiÃ§Ã£o"
                    },
                    width: "100%"
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaTiposMulta.cshtml", "loadList", error);
            }
        }
    </script>
}