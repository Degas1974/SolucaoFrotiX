@page
@* ╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
   ║  ███████╗██████╗  ██████╗ ████████╗██╗██╗  ██╗    ███████╗██╗████████╗███████╗                        ║
   ║  ██╔════╝██╔══██╗██╔═══██╗╚══██╔══╝██║╚██╗██╔╝    ██╔════╝██║╚══██╔══╝██╔════╝                        ║
   ║  █████╗  ██████╔╝██║   ██║   ██║   ██║ ╚███╔╝     ███████╗██║   ██║   █████╗                          ║
   ║  ██╔══╝  ██╔══██╗██║   ██║   ██║   ██║ ██╔██╗     ╚════██║██║   ██║   ██╔══╝                          ║
   ║  ██║     ██║  ██║╚██████╔╝   ██║   ██║██╔╝ ██╗    ███████║██║   ██║   ███████╗                        ║
   ║  ╚═╝     ╚═╝  ╚═╝ ╚═════╝    ╚═╝   ╚═╝╚═╝  ╚═╝    ╚══════╝╚═╝   ╚═╝   ╚══════╝                        ║
   ╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
   ║ UpsertEEscala.cshtml                                                                                 ║
   ║ Formulário de Edição de Escalas - Alteração de turnos e motoristas                                   ║
   ╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
   ║ METADATA                                                                                             ║
   ║ @arquivo    UpsertEEscala.cshtml                                                                     ║
   ║ @local      Pages/Escalas/                                                                           ║
   ║ @versao     1.0.0                                                                                    ║
   ║ @data       23/01/2026                                                                               ║
   ║ @relevancia Formulário para edição de escalas de trabalho existentes                                 ║
   ╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝ *@
@model FrotiX.Pages.Escalas.UpsertEEscalaModel
@{
    ViewData["Title"] = "Editar Escala";
    ViewData["PageName"] = "editar_escala";
}

<style>
    .status-checkbox {
        margin: 10px;
        padding: 15px;
        border-radius: 5px;
        transition: all 0.3s;
    }

    .status-checkbox.active-disponivel {
        background-color: #d4edda;
        border: 2px solid #28a745;
    }

    .status-checkbox.active-indisponivel {
        background-color: #f8d7da;
        border: 2px solid #dc3545;
    }

    .status-checkbox.active-economildo {
        background-color: #d1ecf1;
        border: 2px solid #17a2b8;
    }

    .status-checkbox.active-servico {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
    }

    .status-checkbox.active-reservado {
        background-color: #e2e3e5;
        border: 2px solid #6c757d;
    }

    .status-checkbox.active-viagem {
        background-color: #cfe2ff;
        border: 2px solid #0d6efd;
    }

    .indisponibilidade-section,
    .servico-section,
    .economildo-section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .contador-viagens {
        font-size: 3rem;
        font-weight: bold;
        color: #007bff;
    }
</style>

<div class="row mb-3">
    <div class="col-md-9">
        <h2><i class="fas fa-edit"></i> @ViewData["Title"]</h2>
    </div>
    <div class="col-md-3 text-end">
        <a asp-page="./ListaEscala" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<!-- Card de Status Atual -->
<div class="card mb-3 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Status Atual da Escala</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 text-center">
                <h6>Motorista</h6>
                <h4>@Model.NomeMotorista</h4>
                <span class="badge bg-@(Model.StatusMotorista == "Disponível" ? "success" :
                                                                               Model.StatusMotorista == "Em Viagem" ? "primary" :
                                                                               Model.StatusMotorista == "Indisponível" ? "danger" :
                                                                               Model.StatusMotorista == "Em Serviço" ? "warning" : "info")">
                    @Model.StatusMotorista
                </span>
            </div>
            <div class="col-md-4 text-center">
                <h6>Veículo</h6>
                <h4>@Model.DescricaoVeiculo</h4>
            </div>
            <div class="col-md-4 text-center">
                <h6>Número de Saídas Hoje</h6>
                <div class="contador-viagens">@Model.NumeroSaidas</div>
            </div>
        </div>
    </div>
</div>

<!-- POST via AJAX em EditarEscala.js -->
<form id="formEditarEscala" method="post">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <input type="hidden" id="hiddenEscalaDiaId" name="EscalaDiaId" value="@Model.EscalaDiaId" />
    <input type="hidden" id="hiddenMotoristaId" name="MotoristaId" value="@Model.MotoristaId" />
    <input type="hidden" id="hiddenNumeroSaidas" name="NumeroSaidas" value="@Model.NumeroSaidas" />

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Dados da Escala</h5>
        </div>
        <div class="card-body">
            <!-- Linha 1: Motorista e Veículo -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="MotoristaId" class="control-label required">
                            <i class="fas fa-user"></i> Motorista
                        </label>
                        <ejs-dropdownlist id="motoristaId" name="MotoristaId" dataSource="@Model.MotoristaList"
                            value="@Model.MotoristaId" placeholder="Selecione o motorista" allowFiltering="true"
                            floatLabelType="Auto" enabled="false">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <small class="text-muted">O motorista não pode ser alterado após a criação da escala</small>
                        <span asp-validation-for="MotoristaId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="VeiculoId" class="control-label">
                            <i class="fas fa-car"></i> Veículo
                        </label>
                        <ejs-dropdownlist id="veiculoId" name="VeiculoId" dataSource="@Model.VeiculoList"
                            value="@Model.VeiculoId" placeholder="Selecione o veículo" allowFiltering="true"
                            floatLabelType="Auto">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="veiculoNaoDefinido"
                                name="VeiculoNaoDefinido" @(Model.VeiculoId == null || Model.VeiculoId == Guid.Empty ?
                                                                                          "checked" : "") />
                            <label class="form-check-label" for="veiculoNaoDefinido">
                                <i class="fas fa-ban text-muted"></i> Veículo não definido
                            </label>
                        </div>
                        <span asp-validation-for="VeiculoId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Linha 2: Data e Turno -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="DataEscala" class="control-label required">
                            <i class="fas fa-calendar-day"></i> Data
                        </label>
                        <ejs-datepicker id="dataEscala" name="DataEscala" value="@Model.DataEscala" format="dd/MM/yyyy"
                            placeholder="Selecione a data" floatLabelType="Auto"></ejs-datepicker>
                        <span asp-validation-for="DataEscala" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="TurnoId" class="control-label required">
                            <i class="fas fa-clock"></i> Turno
                        </label>
                        <ejs-dropdownlist id="turnoId" name="TurnoId" dataSource="@Model.TurnoList"
                            value="@Model.TurnoId" placeholder="Selecione o turno" floatLabelType="Auto">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <span asp-validation-for="TurnoId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Linha 3: Horários -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="HoraInicio" class="control-label required">
                            <i class="fas fa-hourglass-start"></i> Hora Início
                        </label>
                        <ejs-timepicker id="horaInicio" name="HoraInicio" value="@Model.HoraInicio"
                            placeholder="Hora início" format="HH:mm" step="30" floatLabelType="Auto"></ejs-timepicker>
                        <span asp-validation-for="HoraInicio" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="HoraFim" class="control-label required">
                            <i class="fas fa-hourglass-end"></i> Hora Fim
                        </label>
                        <ejs-timepicker id="horaFim" name="HoraFim" value="@Model.HoraFim" placeholder="Hora fim"
                            format="HH:mm" step="30" floatLabelType="Auto"></ejs-timepicker>
                        <span asp-validation-for="HoraFim" class="text-danger"></span>
                    </div>
                </div>

            </div>

            <!-- Dias da Semana -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="control-label">
                        <i class="fas fa-calendar-week"></i> Dias da Semana (escalas futuras)
                    </label>
                    <div class="dias-semana-container">
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Segunda" id="segunda" />
                            <label for="segunda">Segunda-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Terca" id="terca" />
                            <label for="terca">Terça-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Quarta" id="quarta" />
                            <label for="quarta">Quarta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Quinta" id="quinta" />
                            <label for="quinta">Quinta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Sexta" id="sexta" />
                            <label for="sexta">Sexta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Sabado" id="sabado" />
                            <label for="sabado">Sábado</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Domingo" id="domingo" />
                            <label for="domingo">Domingo</label>
                        </div>
                    </div>
                    <small class="form-text text-muted">
                        Alterações nos dias da semana afetam escalas futuras (a partir de hoje)
                    </small>
                </div>
            </div>

            <!-- Linha 4: Tipo Serviço e Lotação -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="TipoServicoId" class="control-label required">
                            <i class="fas fa-briefcase"></i> Tipo de Serviço
                        </label>
                        <ejs-dropdownlist id="tipoServicoId" name="TipoServicoId" dataSource="@Model.TipoServicoList"
                            value="@Model.TipoServicoId" placeholder="Selecione o tipo de serviço"
                            floatLabelType="Auto">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <span asp-validation-for="TipoServicoId" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Motorista -->
    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-toggle-on"></i> Status do Motorista</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.StatusMotorista == "Em Viagem" ? "active-viagem" : "")"
                        id="statusViagem">
                        <div class="form-check">
                            <input type="radio" name="StatusMotorista" value="Em Viagem" @(Model.StatusMotorista == "Em Viagem" ? "checked" : "") class="form-check-input" disabled />
                            <label class="form-check-label">
                                <i class="fas fa-car text-primary"></i> Em Viagem
                            </label>
                        </div>
                        <small class="text-muted">Automático</small>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaIndisponivel ? "active-indisponivel" : "")"
                        id="statusIndisponivel">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaIndisponivel" class="form-check-input" />
                            <label asp-for="MotoristaIndisponivel" class="form-check-label">
                                <i class="fas fa-times-circle text-danger"></i> Indisponível
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaEconomildo ? "active-economildo" : "")"
                        id="statusEconomildo">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaEconomildo" class="form-check-input" />
                            <label asp-for="MotoristaEconomildo" class="form-check-label">
                                <i class="fas fa-dollar-sign text-info"></i> Economildo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaEmServico ? "active-servico" : "")" id="statusServico">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaEmServico" class="form-check-input" />
                            <label asp-for="MotoristaEmServico" class="form-check-label">
                                <i class="fas fa-briefcase text-warning"></i> Em Serviço
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaReservado ? "active-reservado" : "")"
                        id="statusReservado">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaReservado" class="form-check-input" />
                            <label asp-for="MotoristaReservado" class="form-check-label">
                                <i class="fas fa-lock text-secondary"></i> Reservado
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.StatusMotorista == "Em Viagem")
            {
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> O status "Em Viagem" é atualizado automaticamente quando o motorista
                    inicia ou finaliza uma viagem.
                </div>
            }

            <!-- Seção de Indisponibilidade -->
            <div class="indisponibilidade-section" id="indisponibilidadeSection"
                style="@(Model.MotoristaIndisponivel ? "display: block;" : "")">
                <h6><i class="fas fa-calendar-times"></i> Configurar Indisponibilidade</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="CategoriaIndisponibilidade">
                                <i class="fas fa-tag"></i> Motivo
                            </label>
                            <ejs-dropdownlist id="categoriaIndisponibilidade" name="CategoriaIndisponibilidade"
                                value="@Model.CategoriaIndisponibilidade" dataSource='@(new List<object> {
                                                                                                                                                                     new { text = "Folga", value = "Folga" },
                                                                                                                                                                     new { text = "Férias", value = "Férias" },
                                                                                                                                                                     new { text = "Recesso", value = "Recesso" },
                                                                                                                                                                     new { text = "Falta", value = "Falta"},
                                                                                                                                                                     new { text = "Atestado", value = "Atestado"}
                                                                                                                                                                 })'
                                placeholder="Selecione a categoria">
                                <e-dropdownlist-fields text="text" value="value"></e-dropdownlist-fields>
                            </ejs-dropdownlist>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DataInicioIndisponibilidade">
                                <i class="fas fa-calendar-day"></i> Data Inicial
                            </label>
                            <ejs-datepicker id="dataInicioIndisponibilidade" name="DataInicioIndisponibilidade"
                                value="@Model.DataInicioIndisponibilidade" format="dd/MM/yyyy"
                                placeholder="Data início"></ejs-datepicker>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DataFimIndisponibilidade">
                                <i class="fas fa-calendar-day"></i> Data Final
                            </label>
                            <ejs-datepicker id="dataFimIndisponibilidade" name="DataFimIndisponibilidade"
                                value="@Model.DataFimIndisponibilidade" format="dd/MM/yyyy"
                                placeholder="Data fim"></ejs-datepicker>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="MotoristaCobertorId">
                                <i class="fas fa-user-shield"></i> Motorista Cobertor
                            </label>
                            <ejs-dropdownlist id="motoristaCobertorId" name="MotoristaCobertorId"
                                dataSource="@Model.MotoristaList" value="@Model.MotoristaCobertorId"
                                placeholder="Selecione o cobertor" allowFiltering="true">
                                <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                            </ejs-dropdownlist>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Economildo -->

            <div class="economildo-section" id="economildoSection"
                style="@(Model.MotoristaEconomildo ? "display: block;" : "")">
                <h6><i class="fas fa-user-tie"></i> Configurar Economildo</h6>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label asp-for="Lotacao" class="control-label">
                                <i class="fas fa-map-marker-alt"></i> Lotação
                            </label>
                            <ejs-dropdownlist id="lotacao" name="Lotacao" dataSource="@Model.LotacaoList"
                                value="@Model.Lotacao" placeholder="Selecione a lotação" floatLabelType="Auto">
                                <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                            </ejs-dropdownlist>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Seção de Em Serviço -->
            <div class="servico-section" id="servicoSection"
                style="@(Model.MotoristaEmServico ? "display: block;" : "")">
                <h6><i class="fas fa-user-tie"></i> Configurar Serviço Fixo</h6>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label asp-for="RequisitanteId">
                                <i class="fas fa-user-tie"></i> Requisitante
                            </label>
                            <ejs-dropdownlist id="requisitanteId" name="RequisitanteId"
                                dataSource="@Model.RequisitanteList" value="@Model.RequisitanteId"
                                placeholder="Selecione o requisitante" allowFiltering="true">
                                <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                            </ejs-dropdownlist>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Observações -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Observações</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label asp-for="Observacoes" class="control-label">
                    <i class="fas fa-comment"></i> Observações
                </label>
                <ejs-textbox id="observacoes" name="Observacoes" value="@Model.Observacoes" multiline="true"
                    placeholder="Digite as observações..." floatLabelType="Auto"></ejs-textbox>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="row mt-3">
        <div class="col-12">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Salvar Alterações
            </button>
            <!-- ✅ CORRIGIDO: asp-action → asp-page -->
            <a asp-page="./ListaEscala" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="button" class="btn btn-danger float-end" onclick="excluirEscala('@Model.EscalaDiaId')">
                <i class="fas fa-trash"></i> Excluir Escala
            </button>
        </div>
    </div>
</form>

@section ScriptsBlock {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="~/js/cadastros/EditarEscala.js" asp-append-version="true"></script>
}