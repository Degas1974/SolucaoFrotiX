@page
@* ╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
   ║  ███████╗██████╗  ██████╗ ████████╗██╗██╗  ██╗    ███████╗██╗████████╗███████╗                        ║
   ║  ██╔════╝██╔══██╗██╔═══██╗╚══██╔══╝██║╚██╗██╔╝    ██╔════╝██║╚══██╔══╝██╔════╝                        ║
   ║  █████╗  ██████╔╝██║   ██║   ██║   ██║ ╚███╔╝     ███████╗██║   ██║   █████╗                          ║
   ║  ██╔══╝  ██╔══██╗██║   ██║   ██║   ██║ ██╔██╗     ╚════██║██║   ██║   ██╔══╝                          ║
   ║  ██║     ██║  ██║╚██████╔╝   ██║   ██║██╔╝ ██╗    ███████║██║   ██║   ███████╗                        ║
   ║  ╚═╝     ╚═╝  ╚═╝ ╚═════╝    ╚═╝   ╚═╝╚═╝  ╚═╝    ╚══════╝╚═╝   ╚═╝   ╚══════╝                        ║
   ╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
   ║ FichaEscalas.cshtml                                                                                  ║
   ║ Ficha detalhada de escalas - Visualização por turno e tipo de serviço                                ║
   ╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
   ║ METADATA                                                                                             ║
   ║ @arquivo    FichaEscalas.cshtml                                                                      ║
   ║ @local      Pages/Escalas/                                                                           ║
   ║ @versao     1.0.0                                                                                    ║
   ║ @data       23/01/2026                                                                               ║
   ║ @relevancia Exibição consolidada de escalas de motoristas por dia                                    ║
   ╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝ *@
@model FrotiX.Pages.Escalas.FichaEscalasModel
@{
    ViewData["Title"] = "Ficha de Escala";
    ViewData["PageName"] = "ficha_escala";
    Layout = "_Layout";
    var dataEscala = Model.DataEscala ?? DateTime.Today;
    var diaSemana = dataEscala.ToString("dddd", new System.Globalization.CultureInfo("pt-BR"));
    diaSemana = char.ToUpper(diaSemana[0]) + diaSemana.Substring(1);

    // Agrupar escalas por turno e tipo de serviço (excluindo indisponíveis)
    var servicosGeraisMatutino = Model.Escalas
    .Where(e => e.NomeTurno == "Matutino" && e.NomeServico == "Serviços Gerais" && e.StatusMotorista != "Indisponível")
    .OrderBy(e => e.HoraInicio).ToList();

    var economildoMatutino = Model.Escalas
    .Where(e => e.NomeTurno == "Matutino" && e.NomeServico == "Economildo" && e.StatusMotorista != "Indisponível")
    .OrderBy(e => e.HoraInicio).ToList();

    var servicosGeraisVespertino = Model.Escalas
    .Where(e => e.NomeTurno == "Vespertino" && e.NomeServico == "Serviços Gerais" && e.StatusMotorista != "Indisponível")
    .OrderBy(e => e.HoraInicio).ToList();

    var economildoVespertino = Model.Escalas
    .Where(e => e.NomeTurno == "Vespertino" && e.NomeServico == "Economildo" && e.StatusMotorista != "Indisponível")
    .OrderBy(e => e.HoraInicio).ToList();

    var servicosGeraisNoturno = Model.Escalas
    .Where(e => e.NomeTurno == "Noturno" && e.NomeServico == "Serviços Gerais" && e.StatusMotorista != "Indisponível")
    .OrderBy(e => e.HoraInicio).ToList();

    // Indisponíveis separados por motivo
    var ferias = Model.Escalas.Where(e => e.MotivoCobertura == "Férias" && e.StatusMotorista == "Indisponível").ToList();
    var folgas = Model.Escalas.Where(e => e.MotivoCobertura == "Folga" && e.StatusMotorista == "Indisponível").ToList();
    var faltas = Model.Escalas.Where(e => e.MotivoCobertura == "Falta" && e.StatusMotorista == "Indisponível").ToList();
    var recessos = Model.Escalas.Where(e => e.MotivoCobertura == "Recesso" && e.StatusMotorista == "Indisponível").ToList();
    var atestados = Model.Escalas.Where(e => e.MotivoCobertura == "Atestado" && e.StatusMotorista ==
    "Indisponível").ToList();

    // Combinar folgas, faltas, recessos e atestados
    var afastamentos = folgas.Concat(faltas).Concat(recessos).Concat(atestados).ToList();
}

<style>
    /* ============================================= */
    /* ESTILOS DE IMPRESSÃO / EXPORTAÇÃO PDF        */
    /* ============================================= */
    @@media print {

        /* Configuração da página com margens */
        @@page {
            margin: 10mm;
            size: A4 portrait;
        }

        /* Configurações gerais */
        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
            font-size: 9pt;
            background: #fff !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        /* ESCONDE ELEMENTOS NO-PRINT - MUITO ESPECÍFICO */
        .no-print,
        .no-print *,
        div.no-print,
        div.no-print *,
        .no-print label,
        .no-print input,
        .no-print button,
        .no-print a,
        [class*="no-print"],
        [class*="no-print"] * {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        /* ESCONDE ELEMENTOS DO LAYOUT */
        header,
        footer,
        nav,
        aside,
        .sidebar,
        .navbar,
        .nav,
        .menu,
        .breadcrumb,
        #sidebar,
        .sidebar-wrapper,
        .main-header,
        .main-footer,
        .content-header {
            display: none !important;
        }

        /* Container principal */
        .container-fluid,
        .container,
        main,
        .content,
        .content-wrapper {
            padding: 0 !important;
            margin: 0 !important;
            background: #fff !important;
            width: 100% !important;
            max-width: none !important;
        }

        /* Ficha container */
        .ficha-container {
            padding: 3mm !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: none !important;
            background: #fff !important;
        }

        /* Tabelas - fundo branco nas células (EXCETO cabeçalhos) */
        .ficha-table tbody,
        .ficha-table tbody td,
        .afastamento-table tbody,
        .afastamento-table tbody td,
        .afastamento-box,
        .afastamentos-container,
        .observacoes-box {
            background: #fff !important;
            background-color: #fff !important;
        }

        /* ========================================= */
        /* ELEMENTOS QUE DEVEM MANTER COR           */
        /* ========================================= */
        .section-header,
        td.section-header,
        .ficha-table .section-header,
        .ficha-table td.section-header {
            background-color: #2c3e50 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .ficha-table thead tr:last-child th {
            background-color: #4a6278 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .afastamento-header {
            background-color: #2c3e50 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .afastamento-table th {
            background-color: #4a6278 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Quadradinhos de saídas */
        .saida-box {
            border: 1px solid #000 !important;
            background-color: #fff !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .saida-box.preenchido {
            background-color: #000 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .saida-box.hachurado {
            background: repeating-linear-gradient(45deg,
                    #666,
                    #666 2px,
                    #fff 2px,
                    #fff 4px) !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Selo de cobertura */
        .selo-cobertura {
            background: linear-gradient(145deg, #5dade2, #2980b9) !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Evita quebra de página no meio das tabelas */
        table {
            page-break-inside: avoid;
        }

        .afastamentos-container {
            page-break-inside: avoid;
        }

        .observacoes-box {
            page-break-inside: avoid;
        }
    }

    /* ============================================= */
    /* ESTILOS NORMAIS DA PÁGINA                    */
    /* ============================================= */
    .ficha-container {
        font-family: Arial, sans-serif;
        background: white;
        max-width: 1200px;
        margin: 0 auto;
    }

    .ficha-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 10pt;
    }

    .ficha-table th,
    .ficha-table td {
        border: 1px solid #000;
        padding: 4px 6px;
        text-align: left;
    }

    /* Cabeçalho principal - Azul Petróleo */
    .section-header {
        background-color: #2c3e50;
        color: white;
        font-weight: bold;
        text-align: center;
        font-size: 11pt;
    }

    /* Sub-cabeçalho - 30% mais claro */
    .ficha-table thead tr:last-child th {
        background-color: #4a6278;
        color: white;
    }

    .col-horario {
        width: 60px;
        text-align: center;
    }

    .col-qtd {
        width: 40px;
        text-align: center;
    }

    .col-motorista {
        width: 180px;
    }

    .col-saidas {
        width: 100px;
    }

    .col-veiculo {
        width: 80px;
        text-align: center;
    }

    .col-lotacao {
        width: 120px;
    }

    .col-fim {
        width: 60px;
        text-align: center;
    }

    /* Quadradinhos de saídas */
    .saidas-container {
        display: flex;
        gap: 2px;
    }

    .saida-box {
        width: 14px;
        height: 14px;
        border: 1px solid #000;
        display: inline-block;
    }

    .saida-box.preenchido {
        background-color: #000;
    }

    .saida-box.hachurado {
        background: repeating-linear-gradient(45deg,
                #666,
                #666 2px,
                #fff 2px,
                #fff 4px);
    }

    /* Selo de Cobertura */
    .selo-cobertura {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(145deg, #5dade2, #2980b9);
        color: white;
        font-size: 10px;
        font-weight: bold;
        margin-left: 5px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Seções de férias/afastamentos */
    .afastamentos-container {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }

    .afastamento-box {
        flex: 1;
        border: 1px solid #000;
    }

    .afastamento-header {
        background-color: #2c3e50;
        color: white;
        font-weight: bold;
        padding: 5px;
        text-align: center;
        border-bottom: 1px solid #000;
        font-size: 10pt;
    }

    .afastamento-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
    }

    .afastamento-table th {
        background-color: #4a6278;
        color: white;
    }

    .afastamento-table th,
    .afastamento-table td {
        border: 1px solid #000;
        padding: 3px 5px;
    }

    /* Observações */
    .observacoes-box {
        border: 1px solid #000;
        padding: 8px;
        margin-top: 15px;
        min-height: 80px;
    }

    .observacoes-header {
        font-weight: bold;
        margin-bottom: 5px;
    }
</style>

<div class="container-fluid">
    <!-- Botões de controle - TUDO no-print -->
    <div class="no-print mb-3 d-flex gap-2">
        <a href="/Escalas/ListaEscala" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Imprimir
        </button>
        <button class="btn btn-danger" id="btnExportarPDF">
            <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
        <label for="dataFiltro" class="mb-0 ms-auto">Data:</label>
        <input type="date" id="dataFiltro" class="form-control" style="width: 160px;"
            value="@dataEscala.ToString("yyyy-MM-dd")" onchange="filtrarPorData()" />
    </div>

    <div class="ficha-container" id="fichaConteudo">

        <!-- SERVIÇOS GERAIS - MATUTINO -->
        @if (servicosGeraisMatutino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">
                            SERVIÇOS GERAIS - MATUTINO - @dataEscala.ToString("dd/MM/yyyy") - @diaSemana
                        </td>
                    </tr>
                    <tr>
                        <th class="col-horario">HORÁRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SAÍDAS</th>
                        <th class="col-veiculo">VEÍCULO</th>
                        <th class="col-lotacao">LOTAÇÃO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int qtdSGM = 0;
                    }
                    @foreach (var escala in servicosGeraisMatutino)
                    {
                        qtdSGM++;
                        var ehCobertor = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitular = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdSGM</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertor)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitular">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box @(i < escala.NumeroSaidas ? "preenchido" : "")"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- ECONOMILDO MATUTINO -->
        @if (economildoMatutino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">ECONOMILDO MATUTINO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HORÁRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SAÍDAS</th>
                        <th class="col-veiculo">VEÍCULO</th>
                        <th class="col-lotacao">LOTAÇÃO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int qtdEM = 0;
                    }
                    @foreach (var escala in economildoMatutino)
                    {
                        qtdEM++;
                        var ehCobertorEM = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularEM = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdEM</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorEM)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularEM">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @* Economildo sempre tem todos os quadradinhos hachurados *@
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box hachurado"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- SERVIÇOS GERAIS - VESPERTINO -->
        @if (servicosGeraisVespertino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">SERVIÇOS GERAIS - VESPERTINO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HORÁRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SAÍDAS</th>
                        <th class="col-veiculo">VEÍCULO</th>
                        <th class="col-lotacao">LOTAÇÃO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int qtdSGV = 0;
                    }
                    @foreach (var escala in servicosGeraisVespertino)
                    {
                        qtdSGV++;
                        var ehCobertorSGV = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularSGV = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdSGV</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorSGV)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularSGV">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box @(i < escala.NumeroSaidas ? "preenchido" : "")"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- ECONOMILDO VESPERTINO -->
        @if (economildoVespertino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">ECONOMILDO VESPERTINO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HORÁRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SAÍDAS</th>
                        <th class="col-veiculo">VEÍCULO</th>
                        <th class="col-lotacao">LOTAÇÃO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int qtdEV = 0;
                    }
                    @foreach (var escala in economildoVespertino)
                    {
                        qtdEV++;
                        var ehCobertorEV = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularEV = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdEV</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorEV)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularEV">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box hachurado"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- SERVIÇOS GERAIS - NOTURNO -->
        @if (servicosGeraisNoturno.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">SERVIÇOS GERAIS - NOTURNO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HORÁRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SAÍDAS</th>
                        <th class="col-veiculo">VEÍCULO</th>
                        <th class="col-lotacao">LOTAÇÃO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int qtdSGN = 0;
                    }
                    @foreach (var escala in servicosGeraisNoturno)
                    {
                        qtdSGN++;
                        var ehCobertorSGN = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularSGN = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdSGN</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorSGN)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularSGN">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box @(i < escala.NumeroSaidas ? "preenchido" : "")"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- SEÇÕES DE FÉRIAS E AFASTAMENTOS -->
        <div class="afastamentos-container">
            <!-- FÉRIAS -->
            <div class="afastamento-box">
                <div class="afastamento-header">
                    FÉRIAS - @DateTime.Now.ToString("MMMM yyyy", new
                                        System.Globalization.CultureInfo("pt-BR")).ToUpper()
                </div>
                <table class="afastamento-table">
                    <thead>
                        <tr>
                            <th style="width: 60%;">FÉRIAS / POSTO</th>
                            <th style="width: 40%;">COBERTURA</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (ferias.Any())
                        {
                            @foreach (var item in ferias)
                            {
                                <tr>
                                    <td>@item.NomeMotoristaTitular</td>
                                    <td>@(item.NomeMotoristaCobertor ?? "Não definido")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2" class="text-center text-muted">Nenhum motorista de férias</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- FOLGAS, FALTAS, RECESSOS E ATESTADOS -->
            <div class="afastamento-box">
                <div class="afastamento-header">
                    FOLGAS / FALTAS / RECESSOS / ATESTADOS
                </div>
                <table class="afastamento-table">
                    <thead>
                        <tr>
                            <th style="width: 35%;">MOTORISTA</th>
                            <th style="width: 35%;">MOTIVO / PERÍODO</th>
                            <th style="width: 30%;">COBERTURA</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (afastamentos.Any())
                        {
                            @foreach (var item in afastamentos)
                            {
                                var periodoStr = "";
                                if (item.DataInicio.HasValue && item.DataFim.HasValue)
                                {
                                    periodoStr = $" ({item.DataInicio.Value:dd/MM} até {item.DataFim.Value:dd/MM})";
                                }
                                <tr>
                                    <td>@item.NomeMotoristaTitular</td>
                                    <td>@item.MotivoCobertura@periodoStr</td>
                                    <td>@(item.NomeMotoristaCobertor ?? "Não definido")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center text-muted">Nenhum afastamento registrado</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- OBSERVAÇÕES DO DIA -->
        <div class="observacoes-box">
            <div class="observacoes-header">OBSERVAÇÕES:</div>
            <div id="observacoesConteudo">
                <!-- Carregado via JS -->
            </div>
        </div>

    </div>
</div>

@section ScriptsBlock {
    <script>
        /**
         * ═══════════════════════════════════════════════════════════════════════════
         * FICHA DE ESCALAS - SCRIPTS DE CONTROLE
         * ═══════════════════════════════════════════════════════════════════════════
         * @@description Funções para filtro por data, exportação PDF e carregamento
         *              de observações do dia via AJAX
         */

        /**
         * ═══════════════════════════════════════════════════════════════════════════
         * FILTRO POR DATA
         * ═══════════════════════════════════════════════════════════════════════════
         */

        /**
         * Aplica filtro por data redirecionando a página
         * @@description Redireciona para a mesma página com parâmetro DataEscala
         * @@global
         */
        function filtrarPorData() {
            try {
                var dataInput = document.getElementById('dataFiltro');
                if (dataInput && dataInput.value) {
                    window.location.href = '/Escalas/FichaEscalas?DataEscala=' + dataInput.value;
                }
            } catch (error) {
                console.error('Erro em filtrarPorData:', error);
                if (typeof Alerta !== 'undefined') {
                    Alerta.TratamentoErroComLinha("FichaEscalas", "filtrarPorData", error);
                }
            }
        }

        /**
         * ═══════════════════════════════════════════════════════════════════════════
         * EXPORTAÇÃO PDF
         * ═══════════════════════════════════════════════════════════════════════════
         */

        /**
         * Exporta a ficha para PDF via impressão do navegador
         * @@description Abre diálogo de impressão nativo do navegador
         * @@global
         */
        function exportarPDF() {
            try {
                console.log('Exportando PDF...');
                window.print();
            } catch (error) {
                console.error('Erro em exportarPDF:', error);
                if (typeof Alerta !== 'undefined') {
                    Alerta.TratamentoErroComLinha("FichaEscalas", "exportarPDF", error);
                }
            }
        }

        /**
         * ═══════════════════════════════════════════════════════════════════════════
         * CARREGAMENTO DE OBSERVAÇÕES DO DIA
         * ═══════════════════════════════════════════════════════════════════════════
         */

        /**
         * Carrega observações da escala para a data selecionada
         * @@description Faz requisição AJAX para /api/Escala/GetObservacoesDia
         *              e popula o container #observacoesConteudo com os resultados
         */
        function carregarObservacoesFicha() {
            try {
                var dataInput = document.getElementById('dataFiltro');
                if (!dataInput || !dataInput.value) {
                    console.warn('Campo dataFiltro não encontrado ou vazio');
                    return;
                }

                var dataParam = dataInput.value;
                console.log('Buscando observações para:', dataParam);

                $.ajax({
                    url: '/api/Escala/GetObservacoesDia',
                    type: 'GET',
                    data: { data: dataParam },
                    success: function (response) {
                        try {
                            console.log('Resposta observações:', response);
                            var container = document.getElementById('observacoesConteudo');
                            if (!container) {
                                console.warn('Container observacoesConteudo não encontrado');
                                return;
                            }

                            if (response.success && response.data && response.data.length > 0) {
                                var html = '';
                                response.data.forEach(function (obs) {
                                    html += '<div style="margin-bottom: 5px;">';
                                    if (obs.titulo) {
                                        html += '<strong>' + obs.titulo + ':</strong> ';
                                    }
                                    html += (obs.descricao || '');
                                    html += '</div>';
                                });
                                container.innerHTML = html;
                                console.log('Observações carregadas:', response.data.length);
                            } else {
                                container.innerHTML = '<span class="text-muted">Nenhuma observação para este dia</span>';
                                console.log('Nenhuma observação encontrada');
                            }
                        } catch (error) {
                            console.error('Erro ao processar observações:', error);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Erro ao carregar observações:', error);
                        console.error('Status:', xhr.status);
                        var container = document.getElementById('observacoesConteudo');
                        if (container) {
                            container.innerHTML = '<span class="text-muted">Erro ao carregar observações</span>';
                        }
                    }
                });
            } catch (error) {
                console.error('Erro em carregarObservacoesFicha:', error);
            }
        }

        /**
         * ═══════════════════════════════════════════════════════════════════════════
         * INICIALIZAÇÃO DO DOCUMENTO
         * ═══════════════════════════════════════════════════════════════════════════
         * @@description Carrega observações do dia e configura handler do botão PDF
         */
        $(document).ready(function () {
            try {
                console.log('FichaEscalas inicializando...');

                // Carregar observações do dia
                carregarObservacoesFicha();

                // Configurar botão de exportar PDF
                $('#btnExportarPDF').off('click').on('click', function (e) {
                    e.preventDefault();
                    exportarPDF();
                });

                console.log('FichaEscalas inicializado com sucesso');

            } catch (error) {
                console.error('Erro na inicialização:', error);
            }
        });

        console.log('FichaEscalas scripts carregados');
    </script>
}