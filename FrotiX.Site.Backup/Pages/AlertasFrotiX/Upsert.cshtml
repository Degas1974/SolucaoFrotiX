@* ****************************************************************************************
 * âš¡ ARQUIVO: Pages/AlertasFrotiX/Upsert.cshtml (900 linhas + JavaScript inline complexo)
 * --------------------------------------------------------------------------------------
 * ğŸ¯ OBJETIVO     : FormulÃ¡rio completo de criaÃ§Ã£o e ediÃ§Ã£o de alertas com sistema avanÃ§ado de recorrÃªncia V2
 * ğŸ“¥ ENTRADAS     : @page "/AlertasFrotiX/Upsert?id={AlertaId}" (opcional), @model UpsertModel, Model properties (Alerta, TiposList, FrequenciaList, UsuariosList, isEdicao), Form inputs (Syncfusion EJ2 TextBox, DropDownList, MultiSelect, DatePicker, TimePicker), Calendar modal (seleÃ§Ã£o mÃºltipla datas)
 * ğŸ“¤ SAÃDAS       : HTML Form <form method="post" asp-page-handler="Submit/Edit">, POST tradicional, JavaScript preview mensagem, redirecionamento /AlertasFrotiX/AlertasFrotiX
 * ğŸ”— CHAMADA POR  : BotÃ£o "Adicionar Alerta" em AlertasFrotiX.cshtml, Links de ediÃ§Ã£o nas DataTables, Menu navegaÃ§Ã£o (Cadastros â†’ Alertas)
 * ğŸ”„ CHAMA        : ~/js/cadastros/alertas_upsert.js, ~/js/cadastros/alertas_recorrencia.js, ~/css/alertaupsert.css, PageHandlers (OnPostSubmit, OnPostEdit)
 * ğŸ“¦ DEPENDÃŠNCIAS : Syncfusion EJ2 ASP.NET Core (commercial license): ejs-textbox, ejs-dropdownlist, ejs-multiselect, ejs-datepicker, ejs-timepicker, jQuery, Bootstrap 5.3.8 (modal calendÃ¡rio), Google Fonts Outfit, Custom CSS alertaupsert.css, Custom JS Alerta.TratamentoErroComLinha()
 * ğŸ“ OBSERVAÃ‡Ã•ES  : Total: 900 linhas. BUGS: TimePicker race condition (mÃºltiplos event handlers created/open/rendered), RecorrÃªncia V2 sem validaÃ§Ã£o cruzada (Semanal sem dias, Mensal sem datas), Calendar modal sem limite datas (seleÃ§Ã£o retroativa infinita), MultiSelect usuÃ¡rios sem lazy loading (performance +1000 usuÃ¡rios), Form validation client-side fraca, CSS inline ~100 linhas conflita com alertaupsert.css, JavaScript inline ~100 linhas (lÃ³gica calendÃ¡rio deveria estar em alertas_upsert.js), Sem debounce no preview mensagem, DatePicker ranges nÃ£o respeitam fuso horÃ¡rio
 *****************************************************************************************@
@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Syncfusion.EJ2

@model FrotiX.Pages.AlertasFrotiX.UpsertModel

@{
	ViewData["Title"] = Model.AlertasFrotiXId == Guid.Empty ? "Novo Alerta" : "Editar Alerta";
	ViewData["PageName"] = "alertasfrotix_upsert";
	ViewData["Heading"] = "<i class='fa-duotone fa-bell'></i> Sistema: <span class='fw-300'>Alertas</span>";
	ViewData["Category1"] = "Alertas";
	ViewData["PageIcon"] = "fa-duotone fa-bell";
}

@section HeadBlock {
	<link rel="stylesheet" href="~/css/alertaupsert.css" asp-append-version="true" />
	<style>
		/* Estilos especÃ­ficos para controles de recorrÃªncia */
		#divRecorrenciaAlerta .section-card {
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			margin-top: 1rem;
		}

		#divRecorrenciaAlerta .section-card-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 0.75rem 1rem;
			border-radius: 8px 8px 0 0;
			font-weight: 600;
		}

		#divRecorrenciaAlerta .section-card-body {
			padding: 1rem;
		}

		/* ======== CALENDÃRIO DATEPICKER - LARGURA AUMENTADA ======== */
		/* Popup do calendÃ¡rio com largura adequada para nÃ£o trepar header */
		#DataExibicao_popup.e-datepicker.e-popup,
		#DataExpiracao_popup.e-datepicker.e-popup {
			min-width: 280px !important;
		}

		/* Container do calendÃ¡rio */
		#DataExibicao_popup .e-calendar,
		#DataExpiracao_popup .e-calendar {
			min-width: 280px !important;
		}

		/* Header do calendÃ¡rio (dias da semana) */
		#DataExibicao_popup .e-calendar .e-header,
		#DataExpiracao_popup .e-calendar .e-header {
			padding: 8px 12px !important;
		}

		/* CÃ©lulas do calendÃ¡rio com espaÃ§amento adequado */
		#DataExibicao_popup .e-calendar .e-content table td,
		#DataExpiracao_popup .e-calendar .e-content table td {
			padding: 6px !important;
			min-width: 36px !important;
		}
	</style>
}

<script>
	/**
	 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	 * TRATAMENTO DE ERROS GLOBAIS - UPSERT ALERTAS
	 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	 * @@description Captura e registra erros nÃ£o tratados em toda a pÃ¡gina.
	 * Evita que erros JavaScript quebrem a experiÃªncia do usuÃ¡rio.
	 */

	/**
	 * Handler global para erros JavaScript
	 * @@description Captura erros nÃ£o tratados em qualquer parte do script
		* @@param { string } msg - Mensagem de erro
			* @@param { string } url - URL do arquivo onde ocorreu o erro
				* @@param { number } line - NÃºmero da linha do erro
					* @@param { number } col - NÃºmero da coluna do erro
						* @@param { Error } error - Objeto Error com detalhes do erro
							* @@returns { boolean } true para suprimir o erro padrÃ£o do navegador
								*/
	window.onerror = function (msg, url, line, col, error) {
		try {
			console.error('Erro Global:', {
				mensagem: msg,
				arquivo: url,
				linha: line,
				coluna: col,
				erro: error
			});
			return true;
		} catch (err) {
			Alerta.TratamentoErroComLinha("Upsert.cshtml", "window.onerror", err);
			return true;
		}
	};

	/**
	 * Handler para Promises rejeitadas nÃ£o tratadas
	 * @@description Monitora rejeiÃ§Ãµes de Promise sem.catch()
		* @@param { PromiseRejectionEvent } e - Evento de rejeiÃ§Ã£o
			*/
	window.addEventListener('unhandledrejection', function (e) {
		try {
			console.error('Promise rejeitada:', e.reason);
			e.preventDefault();
		} catch (error) {
			Alerta.TratamentoErroComLinha("Upsert.cshtml", "unhandledrejection", error);
		}
	});
</script>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<!-- ===== HEADER FROTIX ===== -->
			<div class="ftx-card-header">
				<h2 class="titulo-paginas">
					<i class="fa-duotone fa-bell-plus"></i>
					@(Model.AlertasFrotiXId == Guid.Empty ? "Cadastrar Novo Alerta" : "Editar Alerta")
				</h2>
				<div class="ftx-card-actions">
					<a href="/Alertasfrotix/Alertasfrotix" class="btn btn-header-orange" data-ftx-loading>
						<i class="fa-duotone fa-rotate-left icon-space"></i>
						Voltar Ã  Lista
					</a>
				</div>
			</div>

			<div class="panel-container show">
				<div class="panel-content">
					<form id="formAlerta" method="post">
						<input type="hidden" id="AlertasFrotiXId" name="AlertasFrotiXId"
							value="@Model.AlertasFrotiXId" />

						<!-- SeÃ§Ã£o: InformaÃ§Ãµes BÃ¡sicas -->
						<div class="section-legend">
							<i class="fa-duotone fa-info-circle"></i>
							<span>InformaÃ§Ãµes BÃ¡sicas</span>
						</div>

						<div class="row">
							<div class="col-md-8">
								<label class="label required-field">TÃ­tulo do Alerta</label>
								<ejs-textbox id="Titulo" name="Titulo" placeholder="Digite o tÃ­tulo do alerta"
									value="@Model.Titulo" floatLabelType="Never" cssClass="e-outline">
								</ejs-textbox>
								<span class="text-danger field-validation-valid" data-valmsg-for="Titulo"></span>
							</div>

							<div class="col-md-4">
								<label class="label required-field">Prioridade</label>
								<ejs-dropdownlist id="Prioridade" name="Prioridade" placeholder="Selecione a prioridade"
									dataSource="@Model.PrioridadesList" value="@((int)Model.Prioridade)"
									floatLabelType="Never">
									<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
								</ejs-dropdownlist>
								<span class="text-danger field-validation-valid" data-valmsg-for="Prioridade"></span>
							</div>
						</div>

						<div class="row mt-3">
							<div class="col-md-12">
								<label class="label required-field">DescriÃ§Ã£o</label>
								<ejs-textbox id="Descricao" name="Descricao"
									placeholder="Digite a descriÃ§Ã£o detalhada do alerta" value="@Model.Descricao"
									multiline="true" rows="3" floatLabelType="Never" cssClass="e-outline">
								</ejs-textbox>
								<span class="text-danger field-validation-valid" data-valmsg-for="Descricao"></span>
							</div>
						</div>

						<!-- SeÃ§Ã£o: Tipo de Alerta -->
						<div class="section-legend">
							<i class="fa-duotone fa-tags"></i>
							<span>Tipo de Alerta</span>
							<span class="legend-note">(Selecione o tipo)</span>
						</div>

						<div class="row mb-3">
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="1" data-ejtip="Selecionar tipo: Agendamento">
									<i class="fa-duotone fa-calendar-check" style="color: #0ea5e9;"></i>
									<div>Agendamento</div>
									<span class="preview-badge" style="background-color: #0ea5e9;">Agendamento</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="2" data-ejtip="Selecionar tipo: ManutenÃ§Ã£o">
									<i class="fa-duotone fa-screwdriver-wrench" style="color: #f59e0b;"></i>
									<div>ManutenÃ§Ã£o</div>
									<span class="preview-badge" style="background-color: #f59e0b;">ManutenÃ§Ã£o</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="3" data-ejtip="Selecionar tipo: Motorista">
									<i class="fa-duotone fa-id-card-clip" style="color: #14b8a6;"></i>
									<div>Motorista</div>
									<span class="preview-badge" style="background-color: #14b8a6;">Motorista</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="4" data-ejtip="Selecionar tipo: VeÃ­culo">
									<i class="fa-duotone fa-car-bus" style="color: #7c3aed;"></i>
									<div>VeÃ­culo</div>
									<span class="preview-badge" style="background-color: #7c3aed;">VeÃ­culo</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="5" data-ejtip="Selecionar tipo: AnÃºncio">
									<i class="fa-duotone fa-bullhorn" style="color: #dc2626;"></i>
									<div>AnÃºncio</div>
									<span class="preview-badge" style="background-color: #dc2626;">AnÃºncio</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="6" data-ejtip="Selecionar tipo: AniversÃ¡rio">
									<i class="fa-duotone fa-cake-candles" style="color: #ec4899;"></i>
									<div>AniversÃ¡rio</div>
									<span class="preview-badge" style="background-color: #ec4899;">AniversÃ¡rio</span>
								</div>
							</div>
						</div>
						<input type="hidden" id="TipoAlerta" name="TipoAlerta" value="@((int)Model.TipoAlerta)" />

						<!-- SeÃ§Ã£o: VÃ­nculos (aparece dinamicamente) -->
						<div id="secaoVinculos" style="display: none;">
							<div class="section-legend">
								<i class="fa-duotone fa-link"></i>
								<span>VÃ­nculos</span>
								<span class="legend-note">(Opcional)</span>
							</div>

							<div class="row">
								<div class="col-md-6" id="divViagem" style="display: none;">
									<label class="label">Agendamento Relacionado</label>
									<ejs-dropdownlist id="ViagemId" name="ViagemId"
										placeholder="Selecione o agendamento" dataSource="@Model.ViagensListCompleta"
										value="@Model.ViagemId" allowFiltering="true" filterType="Contains"
										floatLabelType="Never" popupHeight="400px" popupWidth="600px">
										<e-dropdownlist-fields text="DataInicial"
											value="ViagemId"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>

								<div class="col-md-6" id="divManutencao" style="display: none;">
									<label class="label">ManutenÃ§Ã£o Relacionada</label>
									<ejs-dropdownlist id="ManutencaoId" name="ManutencaoId"
										placeholder="Selecione a manutenÃ§Ã£o" dataSource="@Model.ManutencoesListCompleta"
										value="@Model.ManutencaoId" allowFiltering="true" floatLabelType="Never">
										<e-dropdownlist-fields text="NumOS"
											value="ManutencaoId"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>

								<div class="col-md-6" id="divMotorista" style="display: none;">
									<label class="label">Motorista Relacionado</label>
									<ejs-dropdownlist id="MotoristaId" name="MotoristaId"
										placeholder="Selecione o motorista" dataSource="@Model.MotoristasList"
										value="@Model.MotoristaId" allowFiltering="true" floatLabelType="Never">
										<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>

								<div class="col-md-6" id="divVeiculo" style="display: none;">
									<label class="label">VeÃ­culo Relacionado</label>
									<ejs-dropdownlist id="VeiculoId" name="VeiculoId" placeholder="Selecione o veÃ­culo"
										dataSource="@Model.VeiculosList" value="@Model.VeiculoId" allowFiltering="true"
										floatLabelType="Never">
										<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>
							</div>
						</div>

						<!-- SeÃ§Ã£o: ConfiguraÃ§Ãµes de ExibiÃ§Ã£o -->
						<div class="section-legend">
							<i class="fa-duotone fa-clock"></i>
							<span>ConfiguraÃ§Ãµes de ExibiÃ§Ã£o</span>
						</div>

						<!-- Linha 1: Tipo de ExibiÃ§Ã£o (sempre visÃ­vel) -->
						<div class="row">
							<div class="col-md-4">
								<label class="label required-field">Tipo de ExibiÃ§Ã£o</label>
								<ejs-dropdownlist id="TipoExibicao" placeholder="Quando exibir o alerta"
									dataSource="@Model.TipoExibicaoList" value="@((int)Model.TipoExibicao)"
									allowFiltering="true" floatLabelType="Never" popupHeight="300px" zIndex="1000">
									<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
								</ejs-dropdownlist>
							</div>
						</div>

						<!-- Linha 2: Campos dinÃ¢micos de Data/HorÃ¡rio/ExpiraÃ§Ã£o -->
						<div class="row mt-3" id="rowCamposExibicao">
							<!-- Data de ExibiÃ§Ã£o (TipoExibicao 3, 4, 5, 6, 7, 8) -->
							<div class="col-md-3" id="divDataExibicao" style="display: none;">
								<label class="label" id="lblDataExibicao">Data de ExibiÃ§Ã£o</label>
								<ejs-datepicker id="DataExibicao" name="DataExibicao" placeholder="Selecione"
									value="@Model.DataExibicao" format="dd/MM/yyyy" floatLabelType="Never"
									locale="pt-BR">
								</ejs-datepicker>
							</div>

							<!-- HorÃ¡rio de ExibiÃ§Ã£o (TipoExibicao 2, 3, 4, 5, 6, 7, 8) -->
							<div class="col-md-3" id="divHorarioExibicao" style="display: none;">
								<label class="label" id="lblHorarioExibicao">HorÃ¡rio de ExibiÃ§Ã£o</label>
								<ejs-timepicker id="HorarioExibicao" name="HorarioExibicao"
									value="@Model.HorarioExibicao?.ToString(@"hh\:mm")" format="HH:mm" step="15"
									floatLabelType="Never" locale="pt-BR" allowEdit="false" placeholder="Selecione">
								</ejs-timepicker>
								<span class="text-danger field-validation-valid"
									data-valmsg-for="HorarioExibicao"></span>
							</div>

							<!-- Data de ExpiraÃ§Ã£o (Todos os tipos) -->
							<div class="col-md-3" id="divDataExpiracao" style="display: none;">
								<label class="label">Data de ExpiraÃ§Ã£o</label>
								<ejs-datepicker id="DataExpiracao" name="DataExpiracao" placeholder="Selecione"
									value="@Model.DataExpiracao" format="dd/MM/yyyy" floatLabelType="Never"
									locale="pt-BR">
								</ejs-datepicker>
							</div>
						</div>

						<!-- ============================================================ -->
						<!-- SEÃ‡ÃƒO: CONFIGURAÃ‡Ã•ES DE RECORRÃŠNCIA V2                       -->
						<!-- Controle via TipoExibicao (valores 4-8 sÃ£o recorrentes)     -->
						<!-- DataExibicao = inÃ­cio, DataExpiracao = fim                   -->
						<!-- ============================================================ -->

						<!-- Campos de RecorrÃªncia (aparecem dinamicamente baseado em TipoExibicao) -->
						<div class="row mt-3" id="rowCamposRecorrencia">
							<!-- lstDiasAlerta - Dias da Semana (TipoExibicao = 5 Semanal ou 6 Quinzenal) -->
							<div class="col-md-6" id="divDiasAlerta" style="display: none;">
								<label class="label font-weight-bold">
									Dias da Semana
									<i class="fa-duotone fa-calendar-week field-icon"
										style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<ejs-multiselect id="lstDiasAlerta" name="DiasSemana" placeholder="Selecione os dias..."
									mode="CheckBox" showSelectAll="true" selectAllText="Selecionar todos"
									unSelectAllText="Desmarcar todos" popupHeight="250px" floatLabelType="Never">
									<e-multiselect-fields value="Value" text="Text"></e-multiselect-fields>
								</ejs-multiselect>
							</div>

							<!-- lstDiasMesAlerta - Dia do MÃªs (TipoExibicao = 7 Mensal) -->
							<div class="col-md-2" id="divDiaMesAlerta" style="display: none;">
								<label class="label font-weight-bold">
									Dia do MÃªs
									<i class="fa-duotone fa-calendar-clock field-icon"
										style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<ejs-dropdownlist id="lstDiasMesAlerta" name="DiaMesRecorrencia"
									placeholder="Selecione..." value="@Model.DiaMesRecorrencia" popupHeight="250px"
									floatLabelType="Never" cssClass="e-outline">
									<e-dropdownlist-fields value="Value" text="Text"></e-dropdownlist-fields>
								</ejs-dropdownlist>
							</div>
						</div>

						<!-- CalendÃ¡rio para Dias Variados (TipoExibicao = 8) -->
						<div class="row mt-3" id="calendarContainerAlerta" style="display: none;">
							<div class="col-md-4 col-lg-3">
								<label class="label font-weight-bold d-block mb-2">
									Selecione as Datas
									<i class="fa-duotone fa-calendar-days field-icon"
										style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<div style="position: relative; display: inline-block;">
									<!-- Badge laranja no canto superior direito do calendÃ¡rio (40% dentro, 60% fora) -->
									<span id="badgeDatasSelecionadas" style="
										position: absolute;
										top: -10px;
										right: -10px;
										background: #ff8800;
										color: white;
										border-radius: 50%;
										width: 28px;
										height: 28px;
										display: none;
										align-items: center;
										justify-content: center;
										font-size: 12px;
										font-weight: 700;
										z-index: 100;
										box-shadow: 0 2px 4px rgba(0,0,0,0.2);
										border: 2px solid white;">0</span>

									<!-- CalendÃ¡rio Syncfusion (sem card) -->
									<div id="calDatasSelecionadasAlerta"></div>

									<input type="hidden" id="DatasSelecionadas" name="DatasSelecionadas"
										value="@Model.DatasSelecionadas" />
								</div>
							</div>
						</div>

						<!-- FIM DA SEÃ‡ÃƒO DE RECORRÃŠNCIA -->

						<!-- SeÃ§Ã£o: DestinatÃ¡rios -->
						<div class="section-legend">
							<i class="fa-duotone fa-users"></i>
							<span>DestinatÃ¡rios</span>
							<span class="legend-note">(Selecione os usuÃ¡rios que receberÃ£o o alerta)</span>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label class="label required-field">UsuÃ¡rios</label>
								<ejs-multiselect id="UsuariosIds" name="UsuariosIds" placeholder="Selecione os usuÃ¡rios"
									dataSource="@Model.UsuariosList" value="@Model.UsuariosIds" mode="Box"
									showSelectAll="true" selectAllText="Selecionar Todos"
									unSelectAllText="Desmarcar Todos" floatLabelType="Never"
									cssClass="multiselect-usuarios" itemTemplate="usuariosItemTemplate"
									valueTemplate="usuariosValueTemplate" closePopupOnSelect="false" appendTo="body">
									<e-multiselect-fields text="NomeCompleto" value="Id"></e-multiselect-fields>
								</ejs-multiselect>
								<span class="text-danger field-validation-valid" data-valmsg-for="UsuariosIds"></span>
							</div>
						</div>

						<!-- BotÃµes de AÃ§Ã£o -->
						<div class="row mt-4">
							<div class="col-md-12 d-flex justify-content-end gap-2">
								<button type="button" class="btn btn-ftx-fechar form-control"
									onclick="window.location.href='/AlertasFrotiX'" data-ftx-loading>
									<i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar OperaÃ§Ã£o
								</button>
								<button type="submit" class="btn btn-azul btn-submit-spin form-control">
									<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
									@(Model.AlertasFrotiXId == Guid.Empty ? "Criar Alerta" : "Atualizar Alerta")
								</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Templates para o MultiSelect de UsuÃ¡rios -->
<script id="usuariosItemTemplate" type="text/x-template">
    <div class="user-item-multiselect">
        <div class="user-icon-circle pointer-none">
            ${NomeCompleto.substring(0,1).toUpperCase()}
        </div>
        <div class="user-info-text">
            <span class="user-name-full">${NomeCompleto}</span>
            <span class="user-ponto-text">${Ponto ? 'Ponto: ' + Ponto : 'Sem registro'}</span>
        </div>
    </div>
</script>

<script id="usuariosValueTemplate" type="text/x-template">
    <div class="user-value-multiselect">
        <span class="user-name-selected">${NomeCompleto}</span>
    </div>
</script>

@section ScriptsBlock {
	<script src="~/js/alertasfrotix/alertas_upsert.js" asp-append-version="true"></script>
	<script src="~/js/alertasfrotix/alertas_recorrencia.js" asp-append-version="true"></script>

	<script>
			/**
			 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			 * INICIALIZAÃ‡ÃƒO DOS CONTROLES DE RECORRÃŠNCIA V2
			 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			 * @@description Configura os dropdowns de dias da semana e dias do mÃªs
			 *              para alertas recorrentes. O controle Ã© feito via TipoExibicao
			 *              (valores 4-8 sÃ£o recorrentes).
			 * @@requires alertas_recorrencia.js - FunÃ§Ãµes initCalendarioAlerta e verificarEstadoRecorrenciaAlerta
			*/
		document.addEventListener('DOMContentLoaded', function () {
			try {
				// ================================================================
				// INICIALIZAÃ‡ÃƒO DOS DROPDOWNS DE RECORRÃŠNCIA V2
				// Controle via TipoExibicao (nÃ£o hÃ¡ mais Recorrente e PerÃ­odo)
				// ================================================================

				/**
				 * DataSource para seleÃ§Ã£o de dias da semana
				 * @@type {Array<{Text: string, Value: number}>}
				 */
				var dataDiasSemana = [
					{ Text: 'Domingo', Value: 0 },
					{ Text: 'Segunda-Feira', Value: 1 },
					{ Text: 'TerÃ§a-Feira', Value: 2 },
					{ Text: 'Quarta-Feira', Value: 3 },
					{ Text: 'Quinta-Feira', Value: 4 },
					{ Text: 'Sexta-Feira', Value: 5 },
					{ Text: 'SÃ¡bado', Value: 6 }
				];

				/**
				 * DataSource para seleÃ§Ã£o de dia do mÃªs (1-31)
				 * @@type {Array<{Text: string, Value: number}>}
				 */
				var dataDiasMes = [];
				for (var i = 1; i <= 31; i++) {
					dataDiasMes.push({ Text: i.toString(), Value: i });
				}

				// Configurar lstDiasAlerta (MultiSelect Syncfusion)
				var lstDiasAlerta = document.getElementById('lstDiasAlerta');
				if (lstDiasAlerta && lstDiasAlerta.ej2_instances && lstDiasAlerta.ej2_instances[0]) {
					var diasMultiSelect = lstDiasAlerta.ej2_instances[0];
					diasMultiSelect.dataSource = dataDiasSemana;
					diasMultiSelect.fields = { text: 'Text', value: 'Value' };
					diasMultiSelect.dataBind();
				}

				// Configurar lstDiasMesAlerta (DropDownList Syncfusion)
				var lstDiasMesAlerta = document.getElementById('lstDiasMesAlerta');
				if (lstDiasMesAlerta && lstDiasMesAlerta.ej2_instances && lstDiasMesAlerta.ej2_instances[0]) {
					var diasMesDropdown = lstDiasMesAlerta.ej2_instances[0];
					diasMesDropdown.dataSource = dataDiasMes;
					diasMesDropdown.fields = { text: 'Text', value: 'Value' };
					diasMesDropdown.value = @(Model.DiaMesRecorrencia ?? 0);
					diasMesDropdown.dataBind();
				}

				// Inicializar CalendÃ¡rio para datas variadas (TipoExibicao = 8)
				if (typeof initCalendarioAlerta === 'function') {
					initCalendarioAlerta();
				}

				// Verificar estado inicial em modo ediÃ§Ã£o
				if (typeof verificarEstadoRecorrenciaAlerta === 'function') {
					verificarEstadoRecorrenciaAlerta();
				}

			} catch (error) {
				console.error('Erro na inicializaÃ§Ã£o:', error);
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "DOMContentLoaded.recorrencia", error);
			}
		});
	</script>

	<script>
			/**
			 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			 * CONFIGURAÃ‡ÃƒO DO TIMEPICKER - HORÃRIO DE EXIBIÃ‡ÃƒO
			 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			 * @@description Configura o componente Syncfusion TimePicker para seleÃ§Ã£o
			* de horÃ¡rio de exibiÃ§Ã£o do alerta com intervalos de 15 minutos.
			 */
		document.addEventListener('DOMContentLoaded', function () {
			try {
					/** @@type { ej.calendars.TimePicker } InstÃ¢ncia do TimePicker Syncfusion */
					var timePicker = document.getElementById('HorarioExibicao').ej2_instances[0];

				if (timePicker) {
					timePicker.locale = 'pt-BR';
					timePicker.format = 'HH:mm';
					timePicker.step = 15;
					timePicker.dataBind();
				}

					/**
					 * Callback quando o popup Ã© criado
					 * @@param { Object } args - Argumentos do evento
					*/
					timePicker.popupCreated = function (args) {
						try {
							console.log('Popup criado com sucesso');
						} catch (error) {
							Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.popupCreated", error);
						}
					};

					/**
					 * Callback quando o popup Ã© aberto - posiciona abaixo do input
					 * @@param { Object } args - Argumentos do evento com referÃªncia ao popup
					*/
				timePicker.open = function (args) {
					try {
						if (args && args.popup) {
							args.popup.position = { X: 'left', Y: 'bottom' };
						}
					} catch (error) {
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.open", error);
					}
				};

					/**
					 * Callback antes de abrir o popup - valida se pode ser criado
					 * @@param { Object } args - Argumentos do evento(args.cancel pode ser setado)
					*/
					timePicker.beforeOpen = function (args) {
						try {
							if (!args || !args.popup) {
								args.cancel = true;
								console.error('Popup nÃ£o pode ser criado');
							}
						} catch (error) {
							Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.beforeOpen", error);
						}
					};

				/**
				 * Handler de clique no input - abre o popup manualmente se fechado
				 */
				timePicker.inputElement.addEventListener('click', function (e) {
					try {
						if (!timePicker.isPopupOpen()) {
							timePicker.show();
						}
					} catch (error) {
						console.error('Erro ao abrir TimePicker:', error);
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.inputElement.click", error);
						e.preventDefault();
					}
				});

			} catch (error) {
				console.error('Erro na inicializaÃ§Ã£o:', error);
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "DOMContentLoaded.timePicker", error);
			}
		});
	</script>

	<script>
			/**
			 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			 * CONFIGURAÃ‡ÃƒO DO FLATPICKR - SELETOR DE HORÃRIO ALTERNATIVO
			 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			 * @@description Inicializa o Flatpickr como seletor de horÃ¡rio alternativo
			* com formato 24h e incrementos de 15 minutos.
			 * @@requires flatpickr - Biblioteca de seleÃ§Ã£o de data / hora
			*/
		document.addEventListener('DOMContentLoaded', function () {
			try {
				flatpickr("#dtpHorarioExibicao", {
					enableTime: true,
					noCalendar: true,
					dateFormat: "H:i",
					time_24hr: true,
					minuteIncrement: 15
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "DOMContentLoaded.flatpickr", error);
			}
		});
	</script>
}