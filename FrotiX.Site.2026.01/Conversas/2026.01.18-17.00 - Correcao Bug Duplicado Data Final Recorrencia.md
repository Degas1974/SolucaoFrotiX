# Conversa: Correção Bug Duplicado Data Final Recorrência

> **Data/Hora Início**: 18/01/2026 17:00
> **Data/Hora Término**: 18/01/2026 17:35
> **Tipo**: Correção de Bug Visual
> **Status**: ✅ Concluído

---

## Resumo Executivo

Corrigido bug visual no modal de agendamento onde o campo "Data Final Recorrência" aparecia duplicado (texto readonly + DatePicker) ao alternar de modo edição para modo novo.

---

## Problema Reportado

Ao seguir o fluxo:
1. Abrir viagem existente (modo edição) com recorrência
2. Fechar modal
3. Abrir nova viagem (modo novo)

O campo "Data Final Recorrência" aparecia com **ambos os elementos visíveis**:
- O texto readonly (`txtFinalRecorrenciaTexto`)
- O DatePicker Syncfusion (`txtFinalRecorrencia`)

### Comportamento Esperado
- **Modo edição**: Apenas texto readonly visível
- **Modo novo**: Apenas DatePicker visível

---

## Análise da Causa Raiz

O problema foi identificado na função `limparCamposModalViagens()` em `modal-viagem-novo.js`:

```javascript
// CÓDIGO PROBLEMÁTICO (linha 2456):
txtFinalRecorrenciaTexto.style.display = "none";
```

O Syncfusion EJ2 pode reaplicar estilos inline durante re-renderizações, sobrescrevendo o `style.display = "none"` simples.

A solução anterior usava a classe CSS `.ftx-ocultar-recorrencia-texto` com `display: none !important`, mas o código JavaScript não estava usando `!important` nos estilos inline.

---

## Solução Implementada

### 1. Correção no `modal-viagem-novo.js`

Substituído `style.display = "none"` por `style.setProperty('display', 'none', 'important')` em dois locais:

**Função `limparCamposModalViagens()` (linhas 2454-2498)**:
```javascript
// CORRIGIDO:
txtFinalRecorrenciaTexto.style.setProperty('display', 'none', 'important');
wrapper.style.setProperty('display', 'inline-flex', 'important');
controlWrapper.style.setProperty('display', 'block', 'important');
```

**Função `aoAbrirModalViagem()` (linhas 1842-1880)**:
- Adicionado comentário explicativo sobre a correção
- Garantido que `controlWrapper` também recebe estilo forçado

### 2. Criação de Funções Utilitárias Globais em `exibe-viagem.js`

Criadas duas funções centralizadas para controle de visibilidade (linhas 38-136):

```javascript
/**
 * Garante que APENAS o DatePicker seja visível (modo novo)
 */
window.ftxMostrarDatePickerFinalRecorrencia = function() {
    // Oculta texto readonly com !important
    // Mostra DatePicker com !important
};

/**
 * Garante que APENAS o texto readonly seja visível (modo edição)
 * @param {string} dataFormatada - Data no formato dd/MM/yyyy
 */
window.ftxMostrarTextoFinalRecorrencia = function(dataFormatada) {
    // Oculta DatePicker com !important
    // Mostra texto readonly com !important
};
```

### 3. Atualização da função `exibirNovaViagem()`

A função agora chama a função utilitária centralizada:

```javascript
if (typeof window.ftxMostrarDatePickerFinalRecorrencia === 'function') {
    window.ftxMostrarDatePickerFinalRecorrencia();
} else {
    // Fallback com código inline
}
```

---

## Arquivos Modificados

| Arquivo | Alteração |
|---------|-----------|
| `wwwroot/js/agendamento/components/modal-viagem-novo.js` | Correção `setProperty` com `!important` |
| `wwwroot/js/agendamento/components/exibe-viagem.js` | Funções utilitárias globais + uso na `exibirNovaViagem()` |
| `Documentacao/JavaScript/exibe-viagem.md` | Log de modificação adicionado |
| `Documentacao/JavaScript/modal-viagem-novo.md` | Log de modificação adicionado |

---

## Testes Realizados

- ✅ `dotnet build` - Compilação com êxito (0 erros, 0 avisos)

### Testes Manuais Recomendados

1. Abrir viagem existente com recorrência → Verificar que apenas texto readonly aparece
2. Fechar e abrir nova viagem → Verificar que apenas DatePicker aparece
3. Alternar múltiplas vezes entre edição e novo → Verificar consistência

---

## Decisões Técnicas

1. **Uso de `setProperty` com `!important`**: Necessário para resistir a re-renderizações do Syncfusion que sobrescrevem estilos inline
2. **Funções utilitárias globais**: Centraliza a lógica de visibilidade para facilitar manutenção futura
3. **Fallback no código**: Mantido código inline como fallback caso a função ainda não esteja carregada

---

## Referências

- Classe CSS: `.ftx-ocultar-recorrencia-texto` em `Pages/Agenda/Index.cshtml` (linha 1488)
- Classe CSS: `.ftx-ocultar-recorrencia-date` em `Pages/Agenda/Index.cshtml` (linha 1484)

---

## Versionamento

| Arquivo | Versão Anterior | Nova Versão |
|---------|-----------------|-------------|
| `exibe-viagem.js` | 2.3 | 2.4 |
| `modal-viagem-novo.js` | 1.10 | 1.11 |

---

**Responsável**: Claude Opus
**Build**: ✅ Sucesso
