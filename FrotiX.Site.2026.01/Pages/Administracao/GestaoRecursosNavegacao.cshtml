@page

@* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                        â•‘
   â•‘  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•                        â•‘
   â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                          â•‘
   â•‘  â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—     â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•                          â•‘
   â•‘  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                        â•‘
   â•‘  â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•    â•šâ•â•   â•šâ•â•â•šâ•â•  â•šâ•â•    â•šâ•â•â•â•â•â•â•â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•                        â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ GestaoRecursosNavegacao.cshtml                                                                       â•‘
   â•‘ PÃ¡gina de gestÃ£o de recursos e itens de navegaÃ§Ã£o do sistema                                         â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ METADATA                                                                                             â•‘
   â•‘ @arquivo    GestaoRecursosNavegacao.cshtml                                                           â•‘
   â•‘ @local      Pages/Administracao/                                                                     â•‘
   â•‘ @versao     1.0.0                                                                                    â•‘
   â•‘ @data       23/01/2026                                                                               â•‘
   â•‘ @relevancia ConfiguraÃ§Ã£o de menus, permissÃµes e recursos de navegaÃ§Ã£o                                â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@

@model FrotiX.Pages.Administracao.GestaoRecursosNavegacaoModel

@{
    ViewData["Title"] = "GestÃ£o de Recursos e NavegaÃ§Ã£o";
    ViewData["PageName"] = "administracao_gestaorecursosnavegacao";
    ViewData["Heading"] = "<i class='fa-duotone fa-sitemap'></i> AdministraÃ§Ã£o: <span class='fw-300'>GestÃ£o de Recursos e NavegaÃ§Ã£o</span>";
    ViewData["Category1"] = "AdministraÃ§Ã£o";
    ViewData["PageIcon"] = "fa-duotone fa-sitemap";
}

@section HeadBlock {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====== HEADER AZUL PADRAO FROTIX ====== */
        .ftx-card-header {
            background-color: #3D5771;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @@keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .ftx-card-header .titulo-paginas {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .ftx-card-header .titulo-paginas i.fa-duotone {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .ftx-card-header .header-actions {
            display: flex;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* ====== LAYOUT PRINCIPAL ====== */
        .gestao-container {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            min-height: calc(100vh - 200px);
        }

        /* ====== COLUNA ESQUERDA - TREEVIEW ====== */
        .tree-panel {
            flex: 0 0 400px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }

        .tree-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .tree-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: calc(100vh - 350px);
        }

        .tree-actions {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.5rem;
        }

        /* ====== COLUNA DIREITA - PROPRIEDADES ====== */
        .props-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Card de propriedades */
        .props-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .props-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .props-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .props-body {
            padding: 1.5rem;
        }

        /* ====== FORMULARIO DE PROPRIEDADES ====== */
        .form-group {
            margin-bottom: 2rem;
            /* EspaÃ§amento vertical aumentado significativamente */
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.375rem;
            /* MantÃ©m label prÃ³xima ao controle */
            font-size: 0.875rem;
        }

        /* Asteriscos obrigatÃ³rios nas labels */
        .form-group label .required-asterisk {
            font-size: calc(0.875rem - 2px);
            color: #dc3545;
            font-style: italic;
            margin-left: 0.25rem;
        }

        /* BotÃµes de ordenaÃ§Ã£o */
        .order-controls {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .btn-order {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            background: #fff;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 24px;
        }

        .btn-order:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #3D5771;
            color: #3D5771;
        }

        .btn-order:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-order i {
            font-size: 0.875rem;
        }

        .order-input-group {
            display: flex;
            align-items: center;
        }

        .form-group .form-control {
            border-radius: 6px;
            border: 1px solid #ced4da;
            padding: 0.5rem 0.75rem;
        }

        .form-group .form-control:focus {
            border-color: #3D5771;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15);
        }

        /* ====== CARD DE CONTROLE DE ACESSO ====== */
        .acesso-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .acesso-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .acesso-item:last-child {
            border-bottom: none;
        }

        .acesso-item label {
            flex: 1;
            margin: 0;
            cursor: pointer;
        }

        /* ====== TREEVIEW CUSTOMIZADO ====== */
        #gestaoTreeView .e-treeview {
            background: transparent;
        }

        /* âœ… LINHAS VISUAIS CONECTANDO NÃ“S (Grupos e PÃ¡ginas) */
        #gestaoTreeView .e-treeview .e-list-item {
            position: relative;
        }

        /* Container de filhos - adiciona padding para espaÃ§o das linhas */
        #gestaoTreeView .e-treeview .e-list-children {
            position: relative;
            margin-left: 1.25rem;
            padding-left: 0.5rem;
            border-left: 1px solid #d0d0d0;
            opacity: 0.6;
        }

        /* Linha horizontal conectando ao nÃ³ pai */
        #gestaoTreeView .e-treeview .e-list-item:not(:first-child)::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 50%;
            width: 1.25rem;
            height: 1px;
            background-color: #d0d0d0;
            opacity: 0.6;
        }

        /* REMOVE o Ã­cone padrÃ£o do Syncfusion (evita duplicaÃ§Ã£o) */
        #gestaoTreeView .e-treeview .e-list-icon {
            display: none !important;
        }

        /* REMOVE o fundo azul de seleÃ§Ã£o padrÃ£o do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-item.e-active,
        #gestaoTreeView .e-treeview .e-list-item.e-node-focus,
        #gestaoTreeView .e-treeview .e-list-item:focus,
        #gestaoTreeView .e-treeview .e-fullrow.e-active,
        #gestaoTreeView .e-treeview .e-text-content.e-active {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Remove fullrow highlight */
        #gestaoTreeView .e-treeview .e-fullrow {
            display: none !important;
        }

        #gestaoTreeView .e-list-item {
            padding: 2px 0;
            background: transparent !important;
        }

        #gestaoTreeView .e-text-content {
            background: transparent !important;
            border: none !important;
        }

        #gestaoTreeView .tree-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #gestaoTreeView .tree-node:hover {
            background: #f1f3f5;
        }

        #gestaoTreeView .tree-node.selected {
            background: rgba(61, 87, 113, 0.15) !important;
            border-left: 3px solid #3D5771;
        }

        /* Garante que o texto NÃƒO desaparece ao selecionar */
        #gestaoTreeView .tree-node .node-text,
        #gestaoTreeView .e-list-item .tree-node .node-text,
        /* Texto padrÃ£o quando item NÃƒO estÃ¡ selecionado */
        #gestaoTreeView .e-list-item .tree-node:not(.selected) .node-text {
            color: #333 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Texto em NEGRITO LARANJA ESCURO quando item estÃ¡ selecionado */
        #gestaoTreeView .tree-node.selected .node-text,
        #gestaoTreeView .e-list-item.e-active .tree-node.selected .node-text,
        #gestaoTreeView .e-list-item.e-node-focus .tree-node.selected .node-text {
            color: #cc5500 !important;
            /* Laranja bem escuro */
            font-weight: 700 !important;
            /* Negrito */
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Texto em NEGRITO para grupos (nÃ³s com filhos ou href vazio) */
        #gestaoTreeView .tree-node .node-text.node-group {
            font-weight: 700;
        }

        /* FORÃ‡A texto visÃ­vel em TODOS os estados do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-text,
        #gestaoTreeView .e-treeview .e-text-content,
        #gestaoTreeView .e-treeview .e-list-item span,
        #gestaoTreeView .e-treeview .e-active .e-list-text,
        #gestaoTreeView .e-treeview .e-node-focus .e-list-text {
            color: #333 !important;
        }

        /* Classe para Ã­cones duotone padrÃ£o FrotiX (reutilizÃ¡vel) */
        .icon-duotone-ftx {
            --fa-primary-color: #ff6b35;
            /* Laranja forte */
            --fa-secondary-color: #6c757d;
            /* Cinza mÃ©dio */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 1;
            margin-right: 0.5rem;
            /* EspaÃ§amento de 2 caracteres */
        }

        /* Ãcones duotone com cores FrotiX padrÃ£o */
        #gestaoTreeView .tree-node i,
        #gestaoTreeView .tree-node i.fa-duotone {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        /* Ãcone do item selecionado mantÃ©m cores padrÃ£o */
        #gestaoTreeView .tree-node.selected i,
        #gestaoTreeView .tree-node.selected i.fa-duotone {
            --fa-primary-color: #ff6b35;
            --fa-secondary-color: #6c757d;
        }

        /* Drop como filho - destaca item inteiro */
        #gestaoTreeView .e-drop-target-child {
            background-color: rgba(0, 123, 255, 0.2) !important;
            border: 2px dashed #007bff !important;
            border-radius: 6px;
        }

        /* Drop como irmÃ£o - linha indicadora */
        #gestaoTreeView .e-drop-target-sibling {
            position: relative;
        }

        #gestaoTreeView .e-drop-target-sibling::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: -2px;
            height: 3px;
            background-color: #007bff;
            border-radius: 2px;
            z-index: 10;
        }

        #gestaoTreeView .tree-node .node-text {
            flex: 1;
            font-size: 0.9rem;
            color: #333;
        }

        /* SweetAlert mais largo para dropdown de pÃ¡ginas */
        .swal-wide {
            width: 550px !important;
            max-width: 90vw !important;
        }

        .swal-wide .swal2-html-container {
            text-align: center;
            padding: 1rem 1.5rem !important;
        }

        .swal-wide select {
            margin-top: 8px;
            border: 2px solid #3D5771;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .swal-wide select:focus {
            border-color: #ff6b35;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        /* Badge clicÃ¡vel (transforma Grupo â†” PÃ¡gina) */
        #gestaoTreeView .tree-node .node-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #gestaoTreeView .tree-node .node-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* Badge PÃ¡gina - Azul */
        #gestaoTreeView .tree-node .node-badge.badge-pagina {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: #fff;
        }

        #gestaoTreeView .tree-node .node-badge.badge-pagina:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
        }

        /* Badge Grupo - Laranja */
        #gestaoTreeView .tree-node .node-badge.badge-grupo {
            background: linear-gradient(135deg, #fd7e14 0%, #e96b02 100%);
            color: #fff;
        }

        #gestaoTreeView .tree-node .node-badge.badge-grupo:hover {
            background: linear-gradient(135deg, #e96b02 0%, #d35400 100%);
        }

        /* Drag and drop */
        #gestaoTreeView .e-drag-item {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
        }

        /* âœ… Destaca item quando pode soltar sobre ele (como filho) */
        #gestaoTreeView .e-treeview .e-list-item.e-drop-target {
            background-color: rgba(198, 119, 80, 0.1) !important;
            border: 2px dashed #c67750 !important;
            border-radius: 6px;
        }

        /* âœ… Remove a seta azul padrÃ£o (drop indicator) entre itens quando queremos drop sobre item */
        #gestaoTreeView .e-treeview .e-drop-indicator {
            display: none !important;
        }

        /* âœ… Mostra indicador visual quando pode soltar sobre item */
        #gestaoTreeView .e-treeview .e-list-item.e-drop-target::before {
            content: "ğŸ“ Soltar aqui para criar grupo";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: #c67750;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
            pointer-events: none;
        }

        /* ====== BOTÃ•ES DE NAVEGAÃ‡ÃƒO DA ÃRVORE ====== */

        /* Container dos botÃµes de cada item */
        .tree-nav-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        /* Mostra botÃµes ao passar mouse no item */
        #gestaoTreeView .tree-node:hover .tree-nav-buttons {
            opacity: 1;
        }

        /* Mostra botÃµes quando item estÃ¡ selecionado */
        #gestaoTreeView .tree-node.selected .tree-nav-buttons {
            opacity: 1;
        }

        /* BotÃ£o base de navegaÃ§Ã£o */
        .tree-nav-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
            padding: 0;
        }

        .tree-nav-btn:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .tree-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .tree-nav-btn:disabled:hover {
            background: transparent;
        }

        /* Ãcones das setas */
        .tree-nav-btn i {
            font-size: 0.85rem;
        }

        /* Setas de OrdenaÃ§Ã£o (Esquerda) - Vinho/Vermelho claro */
        .tree-nav-btn.btn-order i {
            --fa-primary-color: #722F37;
            /* Vinho */
            --fa-secondary-color: #FFCCCB;
            /* Vermelho claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.7;
        }

        .tree-nav-btn.btn-order:hover i {
            --fa-primary-color: #5a252c;
            /* Vinho mais escuro */
            --fa-secondary-color: #ff9999;
            /* Vermelho mais visÃ­vel */
        }

        /* Setas de Hierarquia (Direita) - Roxo/Azul claro */
        .tree-nav-btn.btn-level i {
            --fa-primary-color: #6B3FA0;
            /* Roxo */
            --fa-secondary-color: #ADD8E6;
            /* Azul claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.7;
        }

        .tree-nav-btn.btn-level:hover i {
            --fa-primary-color: #522f7a;
            /* Roxo mais escuro */
            --fa-secondary-color: #87CEEB;
            /* Azul mais visÃ­vel */
        }

        /* Separador entre botÃµes esquerda/direita e o conteÃºdo */
        .tree-nav-separator {
            width: 1px;
            height: 20px;
            background: #dee2e6;
            margin: 0 4px;
        }

        /* ====== CARD DE CONFIRMAÃ‡ÃƒO DE ALTERAÃ‡Ã•ES ====== */
        .tree-changes-card {
            display: none !important;
            /* Oculto por padrÃ£o */
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            margin: 0 1.5rem 1rem 1.5rem;
            /* Margem para alinhar com o container */
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        .tree-changes-card.show {
            display: flex !important;
            animation: slideIn 0.3s ease;
        }

        @@keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tree-changes-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #495057;
            font-size: 0.9rem;
        }

        .tree-changes-info i {
            color: #ffc107;
        }

        .tree-changes-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* BotÃ£o Confirmar (Check-mark) - Azul PetrÃ³leo padrÃ£o FrotiX */
        .btn-confirmar-alteracoes {
            width: 28px;
            height: 28px;
            border: none;
            background: #3D5771;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-confirmar-alteracoes:hover {
            background: #2d4154;
            transform: scale(1.08);
        }

        .btn-confirmar-alteracoes i {
            font-size: 0.95rem;
            --fa-primary-color: #fff;
            /* Branco */
            --fa-secondary-color: #a0c4e8;
            /* Azul claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.8;
        }

        /* BotÃ£o Cancelar (X no cÃ­rculo) - Vinho padrÃ£o FrotiX */
        .btn-cancelar-alteracoes {
            width: 28px;
            height: 28px;
            border: none;
            background: #722F37;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-cancelar-alteracoes:hover {
            background: #5a252b;
            transform: scale(1.08);
        }

        .btn-cancelar-alteracoes i {
            font-size: 0.95rem;
            --fa-primary-color: #fff;
            /* Branco */
            --fa-secondary-color: #FFCCCB;
            /* Vermelho claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.8;
        }

        /* ====== TOGGLE TIPO DE ITEM (PÃGINA/GRUPO) ====== */
        .tipo-item-toggle {
            display: flex;
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #3D5771;
        }

        .tipo-item-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
        }

        .tipo-item-btn:first-child {
            border-right: 1px solid #dee2e6;
        }

        .tipo-item-btn:hover:not(.active) {
            background: #e9ecef;
        }

        .tipo-item-btn.active {
            background: #3D5771;
            color: #fff;
        }

        .tipo-item-btn i {
            font-size: 1.1rem;
        }

        .tipo-item-btn.active i {
            --fa-primary-color: #fff;
            --fa-secondary-color: #a0c4e8;
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.8;
        }

        .tipo-item-btn:not(.active) i {
            --fa-primary-color: #6c757d;
            --fa-secondary-color: #adb5bd;
        }

        /* ====== BOTOES ====== */
        /* Os botÃµes usam classes globais do FrotiX: btn-azul, btn-ftx-fechar, btn-voltar */

        /* Estado vazio */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* ====== MENSAGENS ====== */
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @@keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ====== DROPDOWNTREE DE ÃCONES - BORDAS SEMPRE VISÃVEIS ====== */
        .ddl-icone-border .e-ddt-wrapper,
        .ddl-icone-border .e-input-group,
        .ddl-icone-border.e-dropdowntree .e-input-group,
        .ddl-icone-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-icone-border .e-input-group.e-input-focus,
        .ddl-icone-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* ForÃ§a bordas mesmo quando vazio */
        #ddlIcone.e-dropdowntree,
        #ddlIcone .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }

        /* ====== DROPDOWNTREE DE PÃGINAS - BORDAS SEMPRE VISÃVEIS ====== */
        .ddl-pagina-border .e-ddt-wrapper,
        .ddl-pagina-border .e-input-group,
        .ddl-pagina-border.e-dropdowntree .e-input-group,
        .ddl-pagina-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-pagina-border .e-input-group.e-input-focus,
        .ddl-pagina-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* ForÃ§a bordas mesmo quando vazio */
        #ddlPagina.e-dropdowntree,
        #ddlPagina .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }
    </style>
}

<div class="ftx-card-header">
    <h2 class="titulo-paginas mb-0">
        <i class="fa-duotone fa-sitemap"></i>
        GestÃ£o de Recursos e NavegaÃ§Ã£o
    </h2>
    <div class="header-actions">
        <button type="button" class="btn btn-header-orange" onclick="migrarDadosJson()">
            <i class="fa-duotone fa-database icon-space"></i> Migrar do JSON
        </button>
        <a asp-page="/Index" class="btn btn-header-orange">
            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar
        </a>
    </div>
</div>

<div class="gestao-container">
    <!-- Coluna Esquerda: TreeView -->
    <div class="tree-panel">
        <div class="tree-header">
            <h5><i class="fa-duotone fa-folder-tree"></i> Estrutura do Menu</h5>
            <span id="itemCount" class="badge bg-secondary">0 itens</span>
        </div>

        <!-- âœ… Card de ConfirmaÃ§Ã£o de AlteraÃ§Ãµes (dentro do tree-panel) -->
        <div class="tree-changes-card" id="treeChangesCard">
            <div class="tree-changes-info">
                <i class="fa-duotone fa-triangle-exclamation"></i>
                <span id="changesMessage">AlteraÃ§Ãµes pendentes</span>
            </div>
            <div class="tree-changes-actions">
                <button type="button" class="btn-confirmar-alteracoes" id="btnConfirmarAlteracoes"
                    title="Confirmar e salvar">
                    <i class="fa-duotone fa-circle-check"></i>
                </button>
                <button type="button" class="btn-cancelar-alteracoes" id="btnCancelarAlteracoes"
                    title="Cancelar alteraÃ§Ãµes">
                    <i class="fa-duotone fa-circle-xmark"></i>
                </button>
            </div>
        </div>
        <div class="tree-content" id="gestaoTreeView">
            <div class="empty-state" id="emptyTreeState">
                <i class="fa-duotone fa-folder-open"></i>
                <p>Nenhum recurso encontrado.<br>Clique em "Migrar do JSON" para importar ou adicione novos itens.</p>
            </div>
        </div>

        <div class="tree-actions">
            <button type="button" class="btn btn-header-orange btn-submit-spin" onclick="adicionarNovoItem()">
                <i class="fa-duotone fa-plus icon-space icon-pulse"></i> Novo Item
            </button>
            <!-- âœ… REMOVIDO: Salvamento agora Ã© automÃ¡tico apÃ³s drag-drop -->
        </div>
    </div>

    <!-- Coluna Direita: Propriedades -->
    <div class="props-panel">
        <!-- Card: Propriedades do Item -->
        <div class="props-card" id="propsCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-sliders"></i> Propriedades do Item <span id="modoEdicao"
                        class="badge bg-secondary ms-2">Selecione</span></h5>
                <span id="selectedItemName" class="text-muted">Nenhum item selecionado</span>
            </div>
            <div class="props-body">
                <form id="formPropriedades">
                    <input type="hidden" id="recursoId" />
                    <input type="hidden" id="parentId" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNome">Nome (exibido no menu)<span
                                        class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="txtNome" placeholder="Ex: Veiculos" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNomeMenu">NomeMenu (identificador Ãºnico)<span
                                        class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="txtNomeMenu" placeholder="Ex: veiculo" />
                            </div>
                        </div>
                    </div>

                    <!-- DropDownTree de PÃ¡ginas - DEVE FICAR ANTES DO CAMPO URL -->
                    <!-- âœ… POSICIONAR ABAIXO DE... -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlPosicao">Posicionar abaixo de...</label>
                                <ejs-dropdowntree id="ddlPosicao" placeholder="Selecione a posiÃ§Ã£o na estrutura..."
                                    popupHeight="350px" showCheckBox="false" showClearButton="true"
                                    allowFiltering="true" filterType="Contains" ignoreCase="true" cssClass="e-outline"
                                    change="onPosicaoChange">
                                </ejs-dropdowntree>
                                <small class="form-text text-muted mt-1">
                                    O item serÃ¡ posicionado logo apÃ³s o item selecionado
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- âœ… TIPO DE ITEM: PÃGINA OU GRUPO -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label>Tipo de Item</label>
                                <div class="tipo-item-toggle" id="tipoItemToggle">
                                    <button type="button" class="tipo-item-btn active" id="btnTipoPagina"
                                        onclick="selecionarTipoItem('pagina')">
                                        <i class="fa-duotone fa-file-lines"></i>
                                        <span>PÃ¡gina</span>
                                    </button>
                                    <button type="button" class="tipo-item-btn" id="btnTipoGrupo"
                                        onclick="selecionarTipoItem('grupo')">
                                        <i class="fa-duotone fa-folder-tree"></i>
                                        <span>Grupo</span>
                                    </button>
                                </div>
                                <input type="hidden" id="tipoItem" value="pagina" />
                            </div>
                        </div>
                    </div>

                    <!-- âœ… SELECIONE A PÃGINA (sÃ³ aparece se for PÃ¡gina) -->
                    <div class="row" id="rowPaginaSistema">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlPagina">Selecione a PÃ¡gina do Sistema<span
                                        class="required-asterisk">*</span></label>

                                <ejs-dropdowntree id="ddlPagina" placeholder="Busque ou selecione uma pÃ¡gina..."
                                    popupHeight="400px" showCheckBox="false" showClearButton="true"
                                    allowFiltering="true" filterType="Contains" ignoreCase="true"
                                    cssClass="e-outline ddl-pagina-border" created="onPaginaDropdownCreated">
                                </ejs-dropdowntree>

                                <small class="form-text text-muted mt-1">
                                    Ao selecionar uma pÃ¡gina, a URL serÃ¡ preenchida automaticamente
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Campos ocultos para compatibilidade -->
                    <input type="hidden" id="ddlItemPai" />
                    <input type="hidden" id="txtOrdem" value="0" />
                    <input type="hidden" id="txtHref" />

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="ddlIcone">Selecione o Ãcone (FontAwesome 7 Pro)<span
                                        class="required-asterisk">*</span></label>

                                <!-- DropDownTree para seleÃ§Ã£o hierÃ¡rquica -->
                                <ejs-dropdowntree id="ddlIcone" placeholder="Busque ou selecione um Ã­cone..."
                                    popupHeight="400px" showCheckBox="false" showClearButton="true"
                                    allowFiltering="true" filterType="Contains" ignoreCase="true"
                                    cssClass="e-outline ddl-icone-border" created="onIconeDropdownCreated"
                                    change="onIconeChange">
                                </ejs-dropdowntree>

                                <!-- Campo bloqueado exibindo a classe CSS completa do Ã­cone selecionado -->
                                <small class="form-text text-muted mt-1">Classe CSS:</small>
                                <input type="text" class="form-control form-control-sm mt-1" id="txtIconClass" readonly
                                    placeholder="A classe do Ã­cone aparecerÃ¡ aqui..."
                                    style="background-color: #f8f9fa; font-family: monospace; font-size: 0.85rem;" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="chkAtivo">Status</label>
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" id="chkAtivo" checked />
                                    <label class="form-check-label" for="chkAtivo">Ativo no menu</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="txtDescricao">DescriÃ§Ã£o</label>
                        <textarea class="form-control" id="txtDescricao" rows="2"
                            placeholder="DescriÃ§Ã£o do recurso..."></textarea>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-azul btn-submit-spin" onclick="salvarPropriedades()">
                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Salvar Propriedades
                        </button>
                        <button type="button" class="btn btn-ftx-fechar" onclick="excluirItem()">
                            <i class="fa-duotone fa-trash icon-space icon-pulse"></i> Excluir
                        </button>
                        <button type="button" class="btn btn-voltar" onclick="limparFormulario()">
                            <i class="fa-duotone fa-eraser icon-space icon-pulse"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card: Controle de Acesso -->
        <div class="props-card" id="acessoCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-users"></i> Controle de Acesso</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosAcessos()">
                    Marcar Todos
                </button>
            </div>
            <div class="props-body">
                <div class="acesso-list" id="listaAcessos">
                    <div class="empty-state">
                        <p class="text-muted mb-0">Selecione um item para gerenciar acessos</p>
                    </div>
                </div>
            </div>
            <div class="props-footer" style="padding: 15px; border-top: 1px solid #dee2e6; text-align: center;">
                <button type="button" class="btn btn-ftx-fechar" onclick="fecharCards()">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar Item
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script>
            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * GESTÃƒO DE RECURSOS DE NAVEGAÃ‡ÃƒO - EDITOR DO MENU LATERAL
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * @@description Sistema completo de gerenciamento do menu de navegaÃ§Ã£o FrotiX
            * Permite criar, editar, reorganizar e excluir itens do menu lateral
                * Utiliza TreeView do Syncfusion com suporte a drag - and - drop
                    */

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * VARIÃVEIS GLOBAIS
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /** @@type { Array } Dados da Ã¡rvore de navegaÃ§Ã£o */
        var treeData = [];
            /** @@type { Object | null } InstÃ¢ncia do TreeView Syncfusion */
            var treeObj = null;
            /** @@type { Object | null } Item atualmente selecionado na Ã¡rvore */
        var selectedItem = null;
            /** @@type { Object | null } InformaÃ§Ãµes do Ãºltimo drag - and - drop para toast */
        var lastDragInfo = null;

            /**
             * Controle de alteraÃ§Ãµes pendentes na estrutura
             * @@description Rastreia se hÃ¡ mudanÃ§as nÃ£o salvas no JSON de navegaÃ§Ã£o
            */
            /** @@type { Object | null } Estado original antes das alteraÃ§Ãµes */
        var treeDataOriginal = null;
            /** @@type { boolean } Flag para indicar se hÃ¡ alteraÃ§Ãµes nÃ£o salvas */
        var alteracoesPendentes = false;

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * FUNÃ‡Ã•ES AUXILIARES - BUSCA DE ÃCONES
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Busca Ã­cone pelo ID no dataSource do DropDownTree
             * @@param { string } iconId - ID do Ã­cone(classe FontAwesome)
            * @@returns { Object| null} Objeto do Ã­cone ou null se nÃ£o encontrado
                */
        function findIconById(iconId) {
            try {
                var ddlIconeObj = document.getElementById('ddlIcone')?.ej2_instances?.[0];
                if (!ddlIconeObj || !ddlIconeObj.fields || !ddlIconeObj.fields.dataSource) return null;
                var ds = ddlIconeObj.fields.dataSource;
                // Busca em categorias e subcategorias
                for (var i = 0; i < ds.length; i++) {
                    var cat = ds[i];
                    if (cat.child && cat.child.length > 0) {
                        for (var j = 0; j < cat.child.length; j++) {
                            if (cat.child[j].id === iconId) return cat.child[j];
                        }
                    }
                }
                return null;
            } catch (e) {
                console.warn('[findIconById] Erro:', e);
                return null;
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * VARIÃVEIS DE RASTREAMENTO DE SELEÃ‡ÃƒO
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /** @@type { string | null } Ãšltimo Ã­cone selecionado no DropDownTree */
        var ultimoIconeSelecionado = null;
            /** @@type { string | null } Ãšltima pÃ¡gina selecionada no DropDownTree */
        var ultimaPaginaSelecionada = null;

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CONFIGURAÃ‡ÃƒO DO DROPDOWN DE ÃCONES
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Callback executado apÃ³s criaÃ§Ã£o do DropDownTree de Ã­cones
             * @@description Configura templates de item / valor e eventos de seleÃ§Ã£o
            * Aplica padrÃ£o FrotiX(Duotone com cores laranja / cinza)
                * @@returns { void}
                */
        function onIconeDropdownCreated() {
            try {
                var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                if (ddlIconeObj) {
                    // Template de item (lista de opÃ§Ãµes)
                    ddlIconeObj.itemTemplate = function (data) {
                        if (data.isCategory) {
                            return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                        }
                        // Garante que seja duotone e aplica cores padrÃ£o FrotiX
                        var iconClass = data.id || '';
                        if (iconClass && !iconClass.includes('fa-duotone')) {
                            iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                        }
                        return '<div style="display: flex; align-items: center; gap: 8px;">' +
                            '<i class="' + iconClass + '" style="font-size: 16px; width: 20px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                            '<span style="color: #5f6b7a;">' + data.text + '</span>' +
                            '</div>';
                    };

                    // Template de valor selecionado
                    ddlIconeObj.valueTemplate = function (data) {
                        if (!data || data.isCategory) return '';
                        // Garante que seja duotone e aplica cores padrÃ£o FrotiX
                        var iconClass = data.id || '';
                        if (iconClass && !iconClass.includes('fa-duotone')) {
                            iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                        }
                        return '<div style="display: flex; align-items: center; gap: 8px;">' +
                            '<i class="' + iconClass + '" style="font-size: 14px; width: 18px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                            '<span style="color: #5f6b7a;">' + data.text + '</span>' +
                            '</div>';
                    };

                    // Evento selecting - aplica no primeiro clique
                    ddlIconeObj.selecting = function (args) {
                        if (args.nodeData && !args.nodeData.isCategory) {
                            ultimoIconeSelecionado = args.nodeData.id;
                            var txtIconClass = document.getElementById('txtIconClass');
                            if (txtIconClass) {
                                txtIconClass.value = args.nodeData.id;
                            }
                        }
                    };

                    // Evento select - confirma seleÃ§Ã£o e fecha popup
                    ddlIconeObj.select = function (args) {
                        console.log('=== SELECT Ã­cone ===', args);
                        if (args.nodeData && !args.nodeData.isCategory) {
                            ultimoIconeSelecionado = args.nodeData.id;
                            var txtIconClass = document.getElementById('txtIconClass');
                            if (txtIconClass) {
                                txtIconClass.value = args.nodeData.id;
                            }
                            // Define o valor e fecha o popup IMEDIATAMENTE
                            ddlIconeObj.value = [args.nodeData.id];
                            ddlIconeObj.dataBind();
                            setTimeout(function () {
                                ddlIconeObj.hidePopup();
                                // Dispara change manualmente apÃ³s fechar
                                onIconeChange({ itemData: args.nodeData, value: [args.nodeData.id] });
                                // Atualiza estado dos botÃµes de ordenaÃ§Ã£o
                                atualizarEstadoBotoesOrdenacao();
                            }, 50);
                        }
                    };

                    ddlIconeObj.change = function (args) {
                        onIconeChange(args);
                    };

                    ddlIconeObj.changeOnBlur = false;

                    console.log('Templates e eventos de Ã­cone configurados');
                }
            } catch (error) {
                console.error('Erro ao configurar template do DropDownTree:', error);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * FUNÃ‡Ã•ES DE CODIFICAÃ‡ÃƒO/DECODIFICAÃ‡ÃƒO HTML
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * @@description FunÃ§Ãµes para tratar caracteres especiais e acentos
            * NecessÃ¡rio para gravaÃ§Ã£o correta no arquivo JSON de navegaÃ§Ã£o
                */

            /**
             * Decodifica entidades HTML para caracteres normais
             * @@description Usado para exibiÃ§Ã£o na interface
            * @@param { string } html - Texto com entidades HTML
                * @@returns { string } Texto decodificado
                    */
        function decodeHtml(html) {
            try {
                if (!html) return html;
                var txt = document.createElement("textarea");
                txt.innerHTML = html;
                return txt.value;
            } catch (erro) {
                console.error('[decodeHtml] Erro:', erro);
                return html; // Retorna valor original em caso de erro
            }
        }

            /**
             * Codifica TODOS caracteres especiais e acentuados para entidades HTML
             * @@description Usado para gravaÃ§Ã£o no arquivo JSON
            * @@param { string } text - Texto a ser codificado
                * @@returns { string } Texto com entidades HTML
                    */
        function encodeHtml(text) {
            try {
                if (!text) return text;

                var result = '';
                for (var i = 0; i < text.length; i++) {
                    var char = text[i];
                    var code = char.charCodeAt(0);

                    // Se for caractere ASCII bÃ¡sico (32-126) exceto < > & " '
                    if (code >= 32 && code <= 126 && char !== '<' && char !== '>' && char !== '&' && char !== '"' && char !== "'") {
                        result += char;
                    } else {
                        // Converte para entidade HTML numÃ©rica
                        result += '&#' + code + ';';
                    }
                }
                return result;
            } catch (erro) {
                console.error('[encodeHtml] Erro:', erro);
                return text; // Retorna valor original em caso de erro
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * INICIALIZAÃ‡ÃƒO DA PÃGINA
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * @@description Carrega todos os dados necessÃ¡rios ao iniciar a pÃ¡gina
            * - Ãrvore de navegaÃ§Ã£o(do banco de dados)
             * - Ãcones FontAwesome disponÃ­veis
            * - PÃ¡ginas do sistema para mapeamento
                */
        document.addEventListener('DOMContentLoaded', function () {
            carregarArvore();
            carregarIconesFontAwesome();
            carregarPaginasSistema();

            // Configura botÃµes de confirmaÃ§Ã£o/cancelamento de alteraÃ§Ãµes
            configurarBotoesAlteracoes();
        });

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * DROPDOWN DE ITEM PAI - HIERARQUIA DO MENU
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Popula dropdown com todos os grupos disponÃ­veis
             * @@description Extrai grupos do treeData recursivamente e formata
            * para exibiÃ§Ã£o hierÃ¡rquica com indentaÃ§Ã£o visual
                * @@returns { void}
                */
        function popularDropdownItemPai() {
            try {
                var grupos = [];

                // Adiciona opÃ§Ã£o "<sem grupo>" no inÃ­cio
                // Usa valor especial '_SEM_GRUPO_' ao invÃ©s de null
                grupos.push({
                    id: '_SEM_GRUPO_',
                    text: '<sem grupo>',
                    textFormatado: '<sem grupo>',
                    textoSemIndentacao: '<sem grupo>',
                    nivel: -1
                });

                    /**
                     * FunÃ§Ã£o recursiva para extrair grupos
                     * @@param { Array } items - Lista de itens a processar
                    */
                function extrairGrupos(items) {
                    if (!items) return;

                    items.forEach(function (item) {
                        // Grupo = href vazio ou 'javascript:void(0);'
                        var isGrupo = !item.href || item.href === 'javascript:void(0);';

                        if (isGrupo) {
                            grupos.push({
                                id: item.id,
                                text: item.text,
                                nivel: calcularNivel(item.id)
                            });
                        }

                        // RecursÃ£o nos filhos
                        if (item.items && item.items.length > 0) {
                            extrairGrupos(item.items);
                        }
                    });
                }

                    /**
                     * Calcula nÃ­vel hierÃ¡rquico do item
                     * @@param { string } itemId - ID do item
                    * @@returns { number } NÃ­vel de profundidade(0 = raiz)
                        */
                function calcularNivel(itemId) {
                    var nivel = 0;
                    var item = buscarItemPorId(treeData, itemId);

                    while (item && item.parentId) {
                        nivel++;
                        item = buscarItemPorId(treeData, item.parentId);
                    }

                    return nivel;
                }

                // Extrai todos os grupos da Ã¡rvore
                extrairGrupos(treeData);

                // Formata texto com indentaÃ§Ã£o baseada no nÃ­vel E decodifica HTML
                grupos.forEach(function (grupo) {
                    if (grupo.id === '_SEM_GRUPO_') {
                        // "<sem grupo>" nÃ£o precisa indentaÃ§Ã£o (jÃ¡ definido acima)
                        return;
                    } else {
                        var textoDecodificado = decodeHtml(grupo.text);
                        var indentacao = '  '.repeat(grupo.nivel);
                        grupo.textFormatado = indentacao + textoDecodificado;  // Com indentaÃ§Ã£o para exibiÃ§Ã£o
                        grupo.textoSemIndentacao = textoDecodificado;  // Sem indentaÃ§Ã£o para ordenaÃ§Ã£o
                    }
                });

                // Ordena alfabeticamente pelo texto SEM indentaÃ§Ã£o (exceto "<sem grupo>" que fica primeiro)
                grupos.sort(function (a, b) {
                    if (a.id === '_SEM_GRUPO_') return -1; // "<sem grupo>" sempre primeiro
                    if (b.id === '_SEM_GRUPO_') return 1;
                    // Ordena pelo texto sem indentaÃ§Ã£o para ordenaÃ§Ã£o correta
                    return a.textoSemIndentacao.localeCompare(b.textoSemIndentacao, 'pt-BR', { sensitivity: 'base' });
                });

                console.log('Grupos encontrados:', grupos.length - 1, '+ <sem grupo>');
                // Dropdown removido - hierarquia agora Ã© gerenciada pelos botÃµes de seta
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "popularDropdownItemPai", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CONTROLES DE POSIÃ‡ÃƒO E TIPO DE ITEM
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Popula dropdown "Posicionar abaixo de..."
             * @@description Exibe lista hierÃ¡rquica de todos os itens do menu
            * para definir a posiÃ§Ã£o de novos itens
                * @@returns { void}
                */
        function popularDropdownPosicao() {
            try {
                var itens = [];

                // Adiciona opÃ§Ã£o "No inÃ­cio (raiz)"
                itens.push({
                    id: '_INICIO_',
                    text: 'ğŸ“ No inÃ­cio (primeiro item)',
                    hasChildren: false
                });

                    /**
                     * FunÃ§Ã£o recursiva para extrair itens com hierarquia visual
                     * @@param { Array } lista - Lista de itens
                    * @@param { number } nivel - NÃ­vel de indentaÃ§Ã£o atual
                        */
                function extrairItensHierarquicos(lista, nivel) {
                    lista.forEach(function (item) {
                        var indentacao = '  '.repeat(nivel);
                        var icone = (item.items && item.items.length > 0) ? 'ğŸ“' : 'ğŸ“„';

                        itens.push({
                            id: item.id,
                            text: indentacao + icone + ' ' + decodeHtml(item.text),
                            hasChildren: false
                        });

                        if (item.items && item.items.length > 0) {
                            extrairItensHierarquicos(item.items, nivel + 1);
                        }
                    });
                }

                extrairItensHierarquicos(treeData, 0);

                // Popula o DropDownTree
                var ddlPosicao = document.getElementById('ddlPosicao');
                if (ddlPosicao && ddlPosicao.ej2_instances && ddlPosicao.ej2_instances[0]) {
                    var ddl = ddlPosicao.ej2_instances[0];
                    ddl.fields = {
                        dataSource: itens,
                        value: 'id',
                        text: 'text',
                        hasChildren: 'hasChildren'
                    };
                    ddl.dataBind();
                    console.log('Dropdown de posiÃ§Ã£o populado com', itens.length, 'itens');
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "popularDropdownPosicao", erro);
            }
        }

            /**
             * Alterna tipo do item entre PÃ¡gina e Grupo
             * @@description Atualiza UI de toggle de tipo e campos relacionados
            * @@param { string } tipo - 'pagina' ou 'grupo'
                * @@returns { void}
                */
        function selecionarTipoItem(tipo) {
            try {
                var btnPagina = document.getElementById('btnTipoPagina');
                var btnGrupo = document.getElementById('btnTipoGrupo');
                var tipoItemInput = document.getElementById('tipoItem');
                var rowPagina = document.getElementById('rowPaginaSistema');

                if (tipo === 'pagina') {
                    btnPagina.classList.add('active');
                    btnGrupo.classList.remove('active');
                    tipoItemInput.value = 'pagina';

                    // Mostra seleÃ§Ã£o de pÃ¡gina
                    if (rowPagina) rowPagina.style.display = 'block';

                } else {
                    btnPagina.classList.remove('active');
                    btnGrupo.classList.add('active');
                    tipoItemInput.value = 'grupo';

                    // Esconde seleÃ§Ã£o de pÃ¡gina
                    if (rowPagina) rowPagina.style.display = 'none';

                    // Limpa URL quando vira grupo
                    document.getElementById('txtHref').value = '';
                }

                console.log('[TIPO] Tipo de item alterado para:', tipo);

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "selecionarTipoItem", erro);
            }
        }

            /**
             * Evento de mudanÃ§a de posiÃ§Ã£o no dropdown
             * @@param { Object } args - Argumentos do evento Syncfusion
            * @@returns { void}
            */
            function onPosicaoChange(args) {
            try {
                console.log('[POSIÃ‡ÃƒO] Nova posiÃ§Ã£o selecionada:', args.value);
                // A posiÃ§Ã£o serÃ¡ aplicada ao salvar
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPosicaoChange", erro);
            }
        }

            /**
             * Atualiza toggle de tipo baseado no item selecionado
             * @@param { Object } item - Item da Ã¡rvore selecionado
            * @@returns { void}
            */
        function atualizarToggleTipo(item) {
            if (!item) return;

            var ehGrupo = !item.href || item.href === 'javascript:void(0);' || (item.items && item.items.length > 0);

            if (ehGrupo) {
                selecionarTipoItem('grupo');
            } else {
                selecionarTipoItem('pagina');
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * TRANSFORMAÃ‡ÃƒO DE TIPO (GRUPO â†” PÃGINA)
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Alterna tipo do item entre Grupo e PÃ¡gina
             * @@description Abre modal apropriado para confirmar transformaÃ§Ã£o
            * Se Grupoâ†’PÃ¡gina: pede para selecionar URL
                * Se PÃ¡ginaâ†’Grupo: pergunta o que fazer com itens abaixo
                    * @@param { string } itemId - ID do item a transformar
                        * @@param { Event } event - Evento de clique
                            * @@returns { void}
                            */
        function alternarTipoItem(itemId, event) {
            try {
                console.log('[TOGGLE-TIPO] Alternando tipo do item:', itemId);

                var item = buscarItemPorId(treeData, itemId);
                if (!item) {
                    console.error('[TOGGLE-TIPO] Item nÃ£o encontrado:', itemId);
                    return;
                }

                var nomeItem = decodeHtml(item.text);
                var ehGrupoAtual = !item.href || item.href === 'javascript:void(0);';

                if (ehGrupoAtual) {
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // GRUPO â†’ PÃGINA
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                    // Monta HTML com dropdown de pÃ¡ginas dentro do SweetAlert
                    var htmlPaginas = montarSelectPaginasParaSwal(itemId);

                    var mensagemBase = 'O Grupo <strong>"' + nomeItem + '"</strong> serÃ¡ transformado em uma <strong>PÃ¡gina</strong>.<br><br>';

                    if (item.items && item.items.length > 0) {
                        mensagemBase += '<div class="alert alert-warning" style="text-align:left; font-size:0.9rem; margin-bottom:15px;">' +
                            '<i class="fa-duotone fa-triangle-exclamation"></i> ' +
                            'Este grupo possui <strong>' + item.items.length + '</strong> filho(s).<br>' +
                            'Eles serÃ£o movidos para o nÃ­vel acima.' +
                            '</div>';
                    }

                    // NÃ£o inclui o select na mensagemBase - serÃ¡ inserido pela funÃ§Ã£o do modal

                    mostrarModalTransformacaoGrupoEmPagina('Transformar Grupo em PÃ¡gina', mensagemBase, htmlPaginas)
                        .then(function (result) {
                            if (result.confirmado && result.paginaUrl) {
                                executarTransformacaoGrupoEmPagina(item, result.paginaUrl);
                            }
                        });

                } else {
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // PÃGINA â†’ GRUPO
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                    // Encontra itens irmÃ£os ABAIXO deste item
                    var irmaosAbaixo = encontrarIrmaosAbaixo(item);

                    var mensagem = 'A PÃ¡gina <strong>"' + nomeItem + '"</strong> serÃ¡ transformada em <strong>Grupo</strong>.<br><br>' +
                        '<div class="alert alert-info" style="text-align:left; font-size:0.9rem;">' +
                        '<i class="fa-duotone fa-info-circle"></i> A URL da pÃ¡gina serÃ¡ removida.' +
                        '</div>';

                    if (irmaosAbaixo.length > 0) {
                        // Tem itens abaixo - mostra modal customizado com 4 opÃ§Ãµes
                        mostrarModalTransformacaoPaginaEmGrupo(item, nomeItem, irmaosAbaixo);

                    } else {
                        // NÃ£o tem itens abaixo - confirmaÃ§Ã£o simples
                        Alerta.Confirmar(
                            'Transformar PÃ¡gina em Grupo',
                            mensagem,
                            'Sim, Transformar',
                            'Cancelar'
                        ).then(function (confirmado) {
                            if (confirmado) {
                                executarTransformacaoPaginaEmGrupo(item, false, [], null);
                            }
                        });
                    }
                }

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "alternarTipoItem", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * BUSCA DE ÃCONES POR URL/TEXTO
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Busca Ã­cone personalizado na treeData por URL/href
             * @@description Procura item que corresponda Ã  URL e retorna seu Ã­cone
            * Usa mÃºltiplas estratÃ©gias de comparaÃ§Ã£o para maior flexibilidade
                * @@param { Array } items - Lista de itens para buscar
                    * @@param { string } url - URL a ser buscada
                        * @@returns { string| null} Classe do Ã­cone ou null
                            */
        function buscarIconePorUrl(items, url) {
            try {
                if (!items || !url) return null;

                // Normaliza URL para comparaÃ§Ã£o (mÃºltiplos formatos)
                var normalizarUrl = function (u) {
                    if (!u) return '';
                    u = u.toLowerCase().trim();
                    u = u.replace(/^\//, ''); // Remove barra inicial
                    u = u.replace(/\.html$/, ''); // Remove .html se existir
                    u = u.replace(/\.cshtml$/, ''); // Remove .cshtml se existir
                    u = u.replace(/_/g, ''); // Remove underscores para comparaÃ§Ã£o flexÃ­vel
                    u = u.replace(/\//g, ''); // Remove barras
                    return u;
                };

                // Extrai partes da URL (mÃ³dulo e pÃ¡gina) para correspondÃªncia mais precisa
                var extrairPartesUrl = function (u) {
                    if (!u) return { modulo: '', pagina: '', completa: '' };
                    u = u.toLowerCase().trim();
                    var partes = u.replace(/\.(html|cshtml)$/, '').split(/[\/_]/);
                    return {
                        modulo: partes[0] || '',
                        pagina: partes[1] || partes[0] || '',
                        completa: u.replace(/\.(html|cshtml)$/, '').replace(/[\/_]/g, '')
                    };
                };

                var urlNormalizada = normalizarUrl(url);
                var partesUrl = extrairPartesUrl(url);

                for (var i = 0; i < items.length; i++) {
                    var item = items[i];

                    // Compara href do item com a URL normalizada (mÃºltiplas estratÃ©gias)
                    if (item.href) {
                        var hrefNormalizado = normalizarUrl(item.href);
                        var partesHref = extrairPartesUrl(item.href);

                        // EstratÃ©gia 1: ComparaÃ§Ã£o exata normalizada
                        var matchExato = hrefNormalizado === urlNormalizada;

                        // EstratÃ©gia 2: ComparaÃ§Ã£o por partes (mÃ³dulo + pÃ¡gina)
                        var matchPartes = partesHref.completa === partesUrl.completa ||
                            (partesHref.modulo === partesUrl.modulo && partesHref.pagina === partesUrl.pagina);

                        // EstratÃ©gia 3: ComparaÃ§Ã£o flexÃ­vel (contÃ©m)
                        var matchFlexivel = hrefNormalizado.includes(urlNormalizada) || urlNormalizada.includes(hrefNormalizado);

                        if ((matchExato || matchPartes || matchFlexivel) && item.icon) {
                            // Normaliza Ã­cone para duotone se necessÃ¡rio
                            var iconClass = item.icon || '';
                            if (iconClass && !iconClass.includes('fa-duotone')) {
                                iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                            }
                            return iconClass || null;
                        }
                    }

                    // Busca recursivamente nos filhos
                    if (item.items && item.items.length > 0) {
                        var found = buscarIconePorUrl(item.items, url);
                        if (found) return found;
                    }
                }

                return null;
            } catch (erro) {
                console.error('[buscarIconePorUrl]', erro);
                return null;
            }
        }

            /**
             * Busca item na treeData por texto/nome
             * @@description Usado para encontrar grupos / categorias pelo nome
            * @@param { Array } items - Lista de itens para buscar
                * @@param { string } texto - Texto a ser buscado
                    * @@returns { Object| null} Item encontrado ou null
                        */
        function buscarItemPorTexto(items, texto) {
            try {
                if (!items || !texto) return null;

                var textoBusca = (texto || '').toLowerCase().trim();

                for (var i = 0; i < items.length; i++) {
                    var item = items[i];
                    var textoItem = (item.text || '').toLowerCase().trim();

                    // Compara texto normalizado
                    if (textoItem === textoBusca) {
                        return item;
                    }

                    // Busca recursivamente nos filhos
                    if (item.items && item.items.length > 0) {
                        var found = buscarItemPorTexto(item.items, texto);
                        if (found) return found;
                    }
                }

                return null;
            } catch (erro) {
                console.error('[buscarItemPorTexto]', erro);
                return null;
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * MODAL PARA SELEÃ‡ÃƒO DE PÃGINAS DO SISTEMA
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Monta HTML do select de pÃ¡ginas com Ã­cones
             * @@description Usado no modal de transformaÃ§Ã£o Grupoâ†’PÃ¡gina
            * @@param { string } itemIdExcluir - ID do item a excluir da lista
                * @@returns { string } HTML do select ou mensagem de erro
                    */
        function montarSelectPaginasParaSwal(itemIdExcluir) {
            try {
                var ddlPaginaObj = document.getElementById('ddlPagina');
                if (!ddlPaginaObj || !ddlPaginaObj.ej2_instances || !ddlPaginaObj.ej2_instances[0]) {
                    return '<p style="color:#ff6b35;">Erro ao carregar pÃ¡ginas</p>';
                }

                var ddl = ddlPaginaObj.ej2_instances[0];
                var dataSource = ddl.fields && ddl.fields.dataSource ? ddl.fields.dataSource : [];

                if (!dataSource || dataSource.length === 0) {
                    return '<p style="color:#ff6b35; padding:20px; text-align:center;">âš ï¸ Nenhuma pÃ¡gina disponÃ­vel. Aguarde o carregamento das pÃ¡ginas do sistema.</p>';
                }

                // Lista customizada com divs clicÃ¡veis (permite HTML e Ã­cones FontAwesome)
                var html = '<div id="swalListaPaginas" style="max-height:300px; overflow-y:auto; border:2px solid #3D5771; border-radius:6px; background:#1e1e2f;">';

                var totalOpcoes = 0;

                // FunÃ§Ã£o recursiva para montar lista hierÃ¡rquica com Ã­cones FontAwesome oficiais
                function adicionarOpcoes(items, nivel) {
                    items.forEach(function (item) {
                        var indentPx = nivel * 20;
                        var temFilhos = item.child && item.child.length > 0;
                        // Categoria Ã© identificada por: isCategory=true OU (tem filhos E nÃ£o tem paginaRef)
                        var isCategory = item.isCategory || (temFilhos && !item.paginaRef);

                        // URL vem do campo paginaRef (igual ao DropDownTree)
                        var paginaUrl = item.paginaRef || item.url || '';

                        // âœ… Busca Ã­cone personalizado na treeData (igual Ã  Estrutura do Menu)
                        var iconClass = '';
                        if (isCategory) {
                            // Para categorias/grupos, busca na treeData por texto/nome
                            var grupoEncontrado = buscarItemPorTexto(treeData || [], item.text);
                            if (grupoEncontrado && grupoEncontrado.icon) {
                                iconClass = grupoEncontrado.icon;
                                // Normaliza Ã­cone para duotone se necessÃ¡rio
                                if (!iconClass.includes('fa-duotone')) {
                                    iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                                }
                            } else {
                                // Fallback: usa folder-tree se nÃ£o encontrar Ã­cone personalizado
                                iconClass = 'fa-duotone fa-folder-tree';
                            }
                        } else {
                            // Para pÃ¡ginas, busca Ã­cone personalizado pela URL
                            var iconPersonalizado = buscarIconePorUrl(treeData || [], paginaUrl);
                            if (iconPersonalizado) {
                                iconClass = iconPersonalizado;
                            } else {
                                // Fallback: usa file-lines se nÃ£o encontrar Ã­cone personalizado
                                iconClass = 'fa-duotone fa-file-lines';
                            }
                        }

                        // SÃ³ permite selecionar pÃ¡ginas (nÃ£o categorias)
                        var podeSelecionar = !isCategory && paginaUrl;

                        html += '<div class="swal-item-pagina' + (isCategory ? ' swal-item-categoria' : ' swal-item-pagina-sel') + '" ' +
                            'data-itemid="' + item.id + '" ' +
                            'data-url="' + paginaUrl + '" ' +
                            'data-iscategory="' + (isCategory ? 'true' : 'false') + '" ' +
                            'data-podeselecionar="' + (podeSelecionar ? 'true' : 'false') + '" ' +
                            'style="padding:10px 15px; padding-left:' + (15 + indentPx) + 'px; border-bottom:1px solid #2d2d4d; ' +
                            'display:flex; align-items:center; gap:8px; transition:all 0.2s; ' +
                            (isCategory ? 'font-weight:700; color:#6c757d; cursor:not-allowed; opacity:0.7;' : 'font-weight:400; color:#e0e0e0; cursor:pointer;') + '">' +
                            '<i class="' + iconClass + '" style="font-size:16px; width:20px; flex-shrink:0; --fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d;"></i>' +
                            '<span style="flex:1;">' + decodeHtml(item.text) + '</span>' +
                            (podeSelecionar ? '' : '<i class="fa-duotone fa-ban" style="font-size:14px; flex-shrink:0; --fa-primary-color:#ff4444; --fa-secondary-color:#ff8888;"></i>') +
                            '</div>';
                        totalOpcoes++;

                        if (temFilhos) {
                            adicionarOpcoes(item.child, nivel + 1);
                        }
                    });
                }

                adicionarOpcoes(dataSource, 0);
                html += '</div>';
                // Campos hidden para armazenar seleÃ§Ã£o
                html += '<input type="hidden" id="swalPaginaSelecionada" value="" />';
                html += '<input type="hidden" id="swalUrlSelecionada" value="" />';

                return html;

            } catch (erro) {
                console.error('[SWAL-SELECT]', erro);
                return '<p style="color:#ff6b35;">Erro ao carregar pÃ¡ginas</p>';
            }
        }

        // Modal customizado padrÃ£o FrotiX para transformaÃ§Ã£o Grupoâ†’PÃ¡gina
        function mostrarModalTransformacaoGrupoEmPagina(titulo, mensagem, htmlSelect) {
            return new Promise(function (resolve) {
                var iconHtml = '<img src="/images/confirmar_transparente.png" style="max-width: 150px; width: 100%; height: auto; margin-bottom: 10px;">';

                var msg = `
                    <div style="background:#1e1e2f; border-radius: 8px; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #e0e0e0;">
                      <div style="background:#2d2d4d; padding: 20px; text-align: center;">
                        <div style="margin-bottom: 10px;">
                          <div style="display: inline-block; max-width: 200px; width: 100%;">
                            ${iconHtml}
                          </div>
                        </div>
                        <div style="font-size: 20px; color: #c9a8ff; font-weight: bold;">${titulo}</div>
                      </div>

                      <div style="padding: 20px; font-size: 15px; line-height: 1.6; text-align: center; background:#1e1e2f">
                        <div style="margin-bottom: 20px;">${mensagem}</div>
                        <div style="margin-top: 15px; text-align: left;">
                          <label style="font-weight:600; margin-bottom:8px; display:block; color:#e0e0e0;">Selecione a PÃ¡gina do Sistema:</label>
                          ${htmlSelect}
                        </div>
                        <div id="swalMensagemErro" style="display:none; margin-top:15px; background:linear-gradient(135deg, #ff6b35, #e55a2b); color:white; padding:10px 15px; border-radius:8px; border:2px solid rgba(255,255,255,0.5); text-align:center;">
                          <i class="fa-duotone fa-triangle-exclamation" style="--fa-primary-color:#ffffff; --fa-secondary-color:#ffcc00; margin-right:8px;"></i>
                          <strong>Selecione uma pÃ¡gina</strong> clicando em um item da lista acima!
                        </div>
                      </div>

                      <div style="background:#3b3b5c; padding: 15px; text-align: center;">
                        <button id="btnCancelTransform" style="
                          background: #722F37;
                          border: none;
                          color: #fff;
                          padding: 10px 20px;
                          margin-right: 10px;
                          font-size: 14px;
                          border-radius: 5px;
                          cursor: pointer;
                          transition: background 0.3s;
                        " onmouseover="this.style.background='#5a252b'" onmouseout="this.style.background='#722F37'">
                          <i class="fa-duotone fa-circle-xmark" style="--fa-primary-color:#fff; --fa-secondary-color:#FFCCCB; margin-right: 5px;"></i>Cancelar
                        </button>

                        <button id="btnConfirmTransform" style="
                          background: #3D5771;
                          border: none;
                          color: #fff;
                          padding: 10px 20px;
                          font-size: 14px;
                          border-radius: 5px;
                          cursor: pointer;
                          transition: background 0.3s;
                        " onmouseover="this.style.background='#2d4154'" onmouseout="this.style.background='#3D5771'">
                          <i class="fa-duotone fa-arrow-right-arrow-left" style="--fa-primary-color:#fff; --fa-secondary-color:#a0c4e8; margin-right: 5px;"></i>Transformar
                        </button>
                      </div>
                    </div>`;

                Swal.fire({
                    showConfirmButton: false,
                    html: msg,
                    backdrop: true,
                    heightAuto: false,
                    allowOutsideClick: false,
                    allowEscapeKey: true,
                    focusConfirm: false,
                    customClass: {
                        popup: 'swal2-popup swal2-no-border swal2-no-shadow'
                    },
                    didOpen: function () {
                        var popup = document.querySelector('.swal2-popup');
                        if (popup) {
                            popup.style.border = 'none';
                            popup.style.boxShadow = 'none';
                            popup.style.background = 'transparent';
                        }

                        // âœ… Event delegation para cliques nos itens da lista
                        // Usa setTimeout para garantir que o DOM foi completamente renderizado
                        setTimeout(function () {
                            var listaPaginas = document.getElementById('swalListaPaginas');
                            if (listaPaginas) {
                                listaPaginas.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    // Busca o item pai mais prÃ³ximo que tenha a classe swal-item-pagina
                                    var target = e.target;
                                    var item = null;

                                    // Tenta encontrar o item pai
                                    while (target && target !== listaPaginas) {
                                        if (target.classList && target.classList.contains('swal-item-pagina')) {
                                            item = target;
                                            break;
                                        }
                                        target = target.parentElement;
                                    }

                                    if (!item) {
                                        return;
                                    }

                                    var podeSelecionar = item.dataset.podeselecionar === 'true';
                                    var isCategory = item.dataset.iscategory === 'true';

                                    if (!podeSelecionar || isCategory || !item.dataset.itemid) {
                                        return; // NÃ£o permite selecionar categorias ou placeholder
                                    }

                                    // Remove seleÃ§Ã£o anterior
                                    document.querySelectorAll('.swal-item-pagina').forEach(function (el) {
                                        el.style.background = 'transparent';
                                        el.style.borderLeft = 'none';
                                        el.classList.remove('swal-item-selected');
                                        delete el.dataset.selected;
                                    });

                                    // Seleciona item atual
                                    item.style.background = '#3D5771';
                                    item.style.borderLeft = '3px solid #ff6b35';
                                    item.classList.add('swal-item-selected');
                                    item.dataset.selected = 'true';

                                    // Esconde mensagem de erro quando usuÃ¡rio seleciona uma pÃ¡gina
                                    var mensagemErro = document.getElementById('swalMensagemErro');
                                    if (mensagemErro) {
                                        mensagemErro.style.display = 'none';
                                    }

                                    // Atualiza campos hidden
                                    var paginaIdInput = document.getElementById('swalPaginaSelecionada');
                                    var urlInput = document.getElementById('swalUrlSelecionada');

                                    if (!paginaIdInput || !urlInput) {
                                        return;
                                    }

                                    paginaIdInput.value = item.dataset.itemid;
                                    urlInput.value = item.dataset.url || '';
                                }, true); // useCapture = true para garantir captura

                                // Hover effect para pÃ¡ginas selecionÃ¡veis
                                listaPaginas.addEventListener('mouseover', function (e) {
                                    var target = e.target;
                                    var item = null;
                                    while (target && target !== listaPaginas) {
                                        if (target.classList && target.classList.contains('swal-item-pagina')) {
                                            item = target;
                                            break;
                                        }
                                        target = target.parentElement;
                                    }
                                    if (item && item.dataset.podeselecionar === 'true' && item.dataset.selected !== 'true') {
                                        item.style.background = '#2d2d4d';
                                    }
                                }, true);

                                listaPaginas.addEventListener('mouseout', function (e) {
                                    var target = e.target;
                                    var item = null;
                                    while (target && target !== listaPaginas) {
                                        if (target.classList && target.classList.contains('swal-item-pagina')) {
                                            item = target;
                                            break;
                                        }
                                        target = target.parentElement;
                                    }
                                    if (item && item.dataset.selected !== 'true') {
                                        item.style.background = 'transparent';
                                    }
                                }, true);
                            }
                        }, 100);

                        var confirmBtn = document.getElementById('btnConfirmTransform');
                        if (confirmBtn) {
                            confirmBtn.onclick = function () {
                                var paginaIdInput = document.getElementById('swalPaginaSelecionada');
                                var urlInput = document.getElementById('swalUrlSelecionada');
                                var mensagemErro = document.getElementById('swalMensagemErro');

                                if (!paginaIdInput || !paginaIdInput.value || !urlInput || !urlInput.value) {
                                    // Mostra mensagem de erro inline no modal (nÃ£o abre outro SweetAlert)
                                    if (mensagemErro) {
                                        mensagemErro.style.display = 'block';
                                        // Scroll para a mensagem de erro
                                        mensagemErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }
                                    return;
                                }

                                var paginaId = paginaIdInput.value;
                                var paginaUrl = urlInput.value;

                                Swal.close();
                                resolve({ confirmado: true, paginaId: paginaId, paginaUrl: paginaUrl });
                            };
                        }

                        var cancelBtn = document.getElementById('btnCancelTransform');
                        if (cancelBtn) {
                            cancelBtn.onclick = function () {
                                Swal.close();
                                resolve({ confirmado: false });
                            };
                        }
                    }
                });
            });
        }

        // Encontra itens irmÃ£os que estÃ£o ABAIXO do item atual
        function encontrarIrmaosAbaixo(item) {
            try {
                var lista = item.parentId ? null : treeData;

                if (item.parentId) {
                    var pai = buscarItemPorId(treeData, item.parentId);
                    lista = pai ? pai.items : null;
                }

                if (!lista) return [];

                var indexAtual = lista.findIndex(function (i) { return i.id === item.id; });
                if (indexAtual === -1 || indexAtual >= lista.length - 1) return [];

                // Retorna todos os itens apÃ³s o atual
                return lista.slice(indexAtual + 1);

            } catch (erro) {
                console.error('[IRMAOS-ABAIXO]', erro);
                return [];
            }
        }

        // Executa transformaÃ§Ã£o GRUPO â†’ PÃGINA (salva imediatamente)
        function executarTransformacaoGrupoEmPagina(item, novaUrl) {
            try {
                // Guarda o ID do item
                var itemId = item.id;

                // Se tem filhos, move para o nÃ­vel do pai
                if (item.items && item.items.length > 0) {
                    var paiId = item.parentId;
                    var listaDestino = paiId ? null : treeData;

                    if (paiId) {
                        var pai = buscarItemPorId(treeData, paiId);
                        listaDestino = pai ? pai.items : null;
                    }

                    if (listaDestino) {
                        var indexItem = listaDestino.findIndex(function (i) { return i.id === item.id; });

                        // Insere filhos apÃ³s o item
                        item.items.forEach(function (filho, idx) {
                            filho.parentId = paiId || null;
                            listaDestino.splice(indexItem + 1 + idx, 0, filho);
                        });
                    }

                    item.items = [];
                }

                // Define a nova URL
                item.href = novaUrl;

                // ForÃ§a reconstruÃ§Ã£o da Ã¡rvore
                treeData = JSON.parse(JSON.stringify(treeData));

                // âœ… Atualiza TreeView SEM marcar alteraÃ§Ãµes pendentes (salva direto no banco)
                // Passa null para limpar seleÃ§Ã£o, false para nÃ£o marcar pendentes
                atualizarTreeViewAposMovimento(null, false);

                // âœ… Salva a estrutura completa diretamente (jÃ¡ salva href/icon)
                // NÃ£o usa salvarPropriedades() pois ela faz reload da pÃ¡gina antes de terminar
                salvarOrdenacaoAutomaticaSemReload().then(function () {
                    // âœ… Limpa seleÃ§Ã£o apÃ³s salvar com sucesso
                    selectedItem = null;
                    if (treeObj) {
                        treeObj.selectedNodes = [];
                    }
                    limparFormulario();

                    Alerta.Sucesso('TransformaÃ§Ã£o Realizada', 'O grupo foi transformado em pÃ¡gina e salvo com sucesso!');

                    // âœ… Agora sim, recarrega a pÃ¡gina para atualizar menu lateral
                    setTimeout(function () {
                        window.location.reload();
                    }, 1500);
                }).catch(function (erro) {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoGrupoEmPagina", erro);
                });

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoGrupoEmPagina", erro);
            }
        }

        // âœ… Modal customizado FrotiX para transformaÃ§Ã£o PÃ¡ginaâ†’Grupo com 4 opÃ§Ãµes
        function mostrarModalTransformacaoPaginaEmGrupo(item, nomeItem, irmaosAbaixo) {
            try {
                // Monta lista de itens (mÃ¡ximo 5 + contador)
                var listaItensHtml = irmaosAbaixo.slice(0, 5).map(function (irmao) {
                    return '<div style="padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.1);">â€¢ ' + decodeHtml(irmao.text) + '</div>';
                }).join('');

                if (irmaosAbaixo.length > 5) {
                    listaItensHtml += '<div style="padding:4px 0; font-style:italic; color:#aaa;">... e mais ' + (irmaosAbaixo.length - 5) + ' item(ns)</div>';
                }

                var htmlModal = `
                    <div id="modalTransformPaginaGrupo" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 99999;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #1e1e2f 0%, #2d2d4d 100%);
                            border-radius: 12px;
                            max-width: 500px;
                            width: 90%;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                            overflow: hidden;
                            font-family: 'Segoe UI', sans-serif;
                        ">
                            <!-- Header com emoji -->
                            <div style="background:#2d2d4d; padding:25px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1);">
                                <div style="font-size:50px; margin-bottom:10px;">ğŸ¤”</div>
                                <div style="font-size:22px; color:#c9a8ff; font-weight:bold;">Transformar PÃ¡gina em Grupo</div>
                            </div>

                            <!-- ConteÃºdo -->
                            <div style="padding:20px; color:#e0e0e0;">
                                <p style="text-align:center; margin-bottom:15px;">
                                    A PÃ¡gina <strong style="color:#ff6b35;">"${decodeHtml(nomeItem)}"</strong> serÃ¡ transformada em <strong>Grupo</strong>.
                                </p>

                                <!-- Card de aviso laranja -->
                                <div style="
                                    background: rgba(255,107,53,0.2);
                                    border: 1px solid rgba(255,255,255,0.3);
                                    border-radius: 8px;
                                    padding: 12px 15px;
                                    margin-bottom: 20px;
                                    color: #fff;
                                    font-size: 0.9rem;
                                ">
                                    <i class="fa-duotone fa-info-circle" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#fff; margin-right:8px;"></i>
                                    A URL da pÃ¡gina serÃ¡ removida.
                                </div>

                                <!-- Lista de itens abaixo -->
                                <div style="text-align:left;">
                                    <strong style="color:#c9a8ff;">Existem ${irmaosAbaixo.length} item(ns) abaixo desta pÃ¡gina:</strong>
                                    <div style="
                                        margin-top:10px;
                                        max-height:150px;
                                        overflow-y:auto;
                                        background:rgba(0,0,0,0.2);
                                        border-radius:6px;
                                        padding:10px;
                                    ">
                                        ${listaItensHtml}
                                    </div>
                                </div>

                                <p style="text-align:center; margin-top:20px; font-weight:600; color:#c9a8ff;">
                                    O que deseja fazer com estes itens?
                                </p>
                            </div>

                            <!-- BotÃµes - 4 opÃ§Ãµes -->
                            <div style="background:#3b3b5c; padding:20px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
                                <!-- Subordinar ao Novo Grupo (Verde Militar FrotiX) -->
                                <button id="btnSubordinarNovoGrupo" style="
                                    background: #4a5d23;
                                    border: none;
                                    color: #fff;
                                    padding: 12px 16px;
                                    font-size: 13px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    flex: 1 1 45%;
                                    min-width: 180px;
                                " onmouseover="this.style.background='#3d4d1c'" onmouseout="this.style.background='#4a5d23'">
                                    <i class="fa-duotone fa-folder-tree" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                                    Subordinar ao Novo Grupo
                                </button>

                                <!-- Subordinar a Outro Grupo (Marrom FrotiX) -->
                                <button id="btnSubordinarOutroGrupo" style="
                                    background: #68432C;
                                    border: none;
                                    color: #fff;
                                    padding: 12px 16px;
                                    font-size: 13px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    flex: 1 1 45%;
                                    min-width: 180px;
                                " onmouseover="this.style.background='#523522'" onmouseout="this.style.background='#68432C'">
                                    <i class="fa-duotone fa-folder-open" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                                    Subordinar a Outro Grupo
                                </button>

                                <!-- Manter Onde EstÃ£o (Azul PetrÃ³leo FrotiX) -->
                                <button id="btnManterOndeEstao" style="
                                    background: #154c62;
                                    border: none;
                                    color: #fff;
                                    padding: 12px 16px;
                                    font-size: 13px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    flex: 1 1 45%;
                                    min-width: 180px;
                                " onmouseover="this.style.background='#0f3a4a'" onmouseout="this.style.background='#154c62'">
                                    <i class="fa-duotone fa-location-dot" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                                    Manter Onde EstÃ£o
                                </button>

                                <!-- Cancelar OperaÃ§Ã£o (Vinho FrotiX) -->
                                <button id="btnCancelarTransformacao" style="
                                    background: #722F37;
                                    border: none;
                                    color: #fff;
                                    padding: 12px 16px;
                                    font-size: 13px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    flex: 1 1 45%;
                                    min-width: 180px;
                                " onmouseover="this.style.background='#5a252b'" onmouseout="this.style.background='#722F37'">
                                    <i class="fa-duotone fa-circle-xmark" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                                    Cancelar OperaÃ§Ã£o
                                </button>
                            </div>
                        </div>
                    </div>`;

                // Adiciona ao DOM
                document.body.insertAdjacentHTML('beforeend', htmlModal);

                var modal = document.getElementById('modalTransformPaginaGrupo');

                // Event listeners para os botÃµes
                document.getElementById('btnSubordinarNovoGrupo').onclick = function () {
                    modal.remove();
                    executarTransformacaoPaginaEmGrupo(item, true, irmaosAbaixo, null);
                };

                document.getElementById('btnSubordinarOutroGrupo').onclick = function () {
                    // Abre modal de seleÃ§Ã£o de grupo (por cima deste)
                    mostrarModalSelecionarGrupoDestino(item, irmaosAbaixo, modal);
                };

                document.getElementById('btnManterOndeEstao').onclick = function () {
                    modal.remove();
                    // Transforma em grupo mas NÃƒO move os itens (ficam onde estÃ£o)
                    executarTransformacaoPaginaEmGrupo(item, false, [], null);
                };

                document.getElementById('btnCancelarTransformacao').onclick = function () {
                    modal.remove();
                };

                // Fecha com ESC
                var escHandler = function (e) {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "mostrarModalTransformacaoPaginaEmGrupo", erro);
            }
        }

        // âœ… Modal secundÃ¡rio para selecionar grupo destino (aparece por cima do modal principal)
        function mostrarModalSelecionarGrupoDestino(itemOrigem, itensParaMover, modalPrincipal) {
            try {
                var htmlGrupos = montarSelectGruposParaSwal(itemOrigem.id);

                var htmlModal = `
                    <div id="modalSelecionarGrupo" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 100000;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #1e1e2f 0%, #2d2d4d 100%);
                            border-radius: 12px;
                            max-width: 450px;
                            width: 90%;
                            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                            overflow: hidden;
                            font-family: 'Segoe UI', sans-serif;
                        ">
                            <!-- Header -->
                            <div style="background:#2d2d4d; padding:20px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1);">
                                <div style="font-size:40px; margin-bottom:8px;">ğŸ“</div>
                                <div style="font-size:18px; color:#c9a8ff; font-weight:bold;">Selecionar Grupo Destino</div>
                            </div>

                            <!-- ConteÃºdo -->
                            <div style="padding:20px; color:#e0e0e0;">
                                <p style="margin-bottom:15px;">
                                    Os <strong style="color:#ff6b35;">${itensParaMover.length}</strong> item(ns) serÃ£o movidos para o grupo selecionado:
                                </p>

                                <div style="text-align:left;">
                                    <label style="font-weight:600; margin-bottom:8px; display:block; color:#c9a8ff;">
                                        Selecione o Grupo:
                                    </label>
                                    ${htmlGrupos}
                                </div>
                            </div>

                            <!-- BotÃµes -->
                            <div style="background:#3b3b5c; padding:15px; display:flex; gap:10px; justify-content:center;">
                                <!-- Confirmar (Verde Militar) -->
                                <button id="btnConfirmarGrupo" style="
                                    background: #4a5d23;
                                    border: none;
                                    color: #fff;
                                    padding: 12px 25px;
                                    font-size: 14px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#3d4d1c'" onmouseout="this.style.background='#4a5d23'">
                                    <i class="fa-duotone fa-check" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                                    Confirmar
                                </button>

                                <!-- Voltar (Azul PetrÃ³leo) -->
                                <button id="btnVoltarSelecao" style="
                                    background: #154c62;
                                    border: none;
                                    color: #fff;
                                    padding: 12px 25px;
                                    font-size: 14px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                " onmouseover="this.style.background='#0f3a4a'" onmouseout="this.style.background='#154c62'">
                                    <i class="fa-duotone fa-arrow-left" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                                    Voltar
                                </button>
                            </div>
                        </div>
                    </div>`;

                // Adiciona ao DOM
                document.body.insertAdjacentHTML('beforeend', htmlModal);

                var modalSelecao = document.getElementById('modalSelecionarGrupo');

                // Event listeners
                document.getElementById('btnConfirmarGrupo').onclick = function () {
                    var selectGrupo = document.getElementById('swalSelectGrupo');
                    if (!selectGrupo || !selectGrupo.value) {
                        Alerta.Warning('AtenÃ§Ã£o', 'Selecione um grupo destino!');
                        return;
                    }

                    var grupoDestinoId = selectGrupo.value;

                    // Fecha ambos os modais
                    modalSelecao.remove();
                    modalPrincipal.remove();

                    // Executa a transformaÃ§Ã£o
                    executarTransformacaoPaginaEmGrupo(itemOrigem, false, itensParaMover, grupoDestinoId);
                };

                document.getElementById('btnVoltarSelecao').onclick = function () {
                    // Apenas fecha este modal, volta pro anterior
                    modalSelecao.remove();
                };

                // Fecha com ESC (volta pro modal anterior)
                var escHandler = function (e) {
                    if (e.key === 'Escape') {
                        modalSelecao.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "mostrarModalSelecionarGrupoDestino", erro);
            }
        }

        // Monta HTML do <select> de grupos para usar no SweetAlert
        function montarSelectGruposParaSwal(itemIdExcluir) {
            try {
                var grupos = [];

                // Adiciona opÃ§Ã£o "Raiz (sem grupo pai)"
                grupos.push({
                    id: '_RAIZ_',
                    text: 'ğŸ“ Raiz (nÃ­vel principal)',
                    nivel: 0
                });

                // FunÃ§Ã£o recursiva para encontrar grupos
                function coletarGrupos(items, nivel) {
                    items.forEach(function (item) {
                        // Ã‰ grupo se nÃ£o tem href ou tem filhos
                        var ehGrupo = !item.href || item.href === 'javascript:void(0);' || (item.items && item.items.length > 0);

                        // NÃ£o inclui o item que estÃ¡ sendo transformado
                        if (ehGrupo && item.id !== itemIdExcluir) {
                            grupos.push({
                                id: item.id,
                                text: decodeHtml(item.text),
                                nivel: nivel
                            });
                        }

                        if (item.items && item.items.length > 0) {
                            coletarGrupos(item.items, nivel + 1);
                        }
                    });
                }

                coletarGrupos(treeData, 1);

                var html = '<select id="swalSelectGrupo" class="form-control" style="width:100%; padding:10px; font-size:1rem; margin-top:8px;">';
                html += '<option value="">-- Selecione um grupo --</option>';

                grupos.forEach(function (grupo) {
                    var indent = '&nbsp;&nbsp;'.repeat(grupo.nivel * 2);
                    var icone = grupo.id === '_RAIZ_' ? 'ğŸ“' : 'ğŸ“';
                    html += '<option value="' + grupo.id + '">' + indent + icone + ' ' + grupo.text + '</option>';
                });

                html += '</select>';

                return html;

            } catch (erro) {
                console.error('[SWAL-SELECT-GRUPOS]', erro);
                return '<p class="text-danger">Erro ao carregar grupos</p>';
            }
        }

        // Executa transformaÃ§Ã£o PÃGINA â†’ GRUPO
        function executarTransformacaoPaginaEmGrupo(item, subordinarAoNovoGrupo, itensParaMover, grupoDestinoId) {
            try {
                // Transforma em grupo
                item.href = 'javascript:void(0);';
                item.items = item.items || [];

                // ObtÃ©m lista onde o item estÃ¡ atualmente
                var listaOrigem = item.parentId ? null : treeData;
                if (item.parentId) {
                    var paiOrigem = buscarItemPorId(treeData, item.parentId);
                    listaOrigem = paiOrigem ? paiOrigem.items : null;
                }

                if (itensParaMover && itensParaMover.length > 0 && listaOrigem) {
                    if (subordinarAoNovoGrupo) {
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // OPÃ‡ÃƒO 1: Subordinar ao novo grupo (viram filhos)
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        itensParaMover.forEach(function (irmao) {
                            var idx = listaOrigem.findIndex(function (i) { return i.id === irmao.id; });
                            if (idx !== -1) {
                                listaOrigem.splice(idx, 1);
                                irmao.parentId = item.id;
                                item.items.push(irmao);
                            }
                        });
                    } else if (grupoDestinoId) {
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // OPÃ‡ÃƒO 2: Mover para outro grupo
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        var listaDestino;
                        var novoParentId;

                        if (grupoDestinoId === '_RAIZ_') {
                            listaDestino = treeData;
                            novoParentId = null;
                        } else {
                            var grupoDestino = buscarItemPorId(treeData, grupoDestinoId);
                            if (grupoDestino) {
                                grupoDestino.items = grupoDestino.items || [];
                                listaDestino = grupoDestino.items;
                                novoParentId = grupoDestinoId;
                            }
                        }

                        if (listaDestino) {
                            itensParaMover.forEach(function (irmao) {
                                var idx = listaOrigem.findIndex(function (i) { return i.id === irmao.id; });
                                if (idx !== -1) {
                                    listaOrigem.splice(idx, 1);
                                    irmao.parentId = novoParentId;
                                    listaDestino.push(irmao);
                                }
                            });
                        }
                    }
                }

                // ForÃ§a reconstruÃ§Ã£o da Ã¡rvore
                treeData = JSON.parse(JSON.stringify(treeData));

                // âœ… Atualiza TreeView SEM marcar alteraÃ§Ãµes pendentes (salva direto no banco)
                // Passa null para limpar seleÃ§Ã£o, false para nÃ£o marcar pendentes
                atualizarTreeViewAposMovimento(null, false);

                // âœ… Salva a estrutura completa diretamente (jÃ¡ salva href/icon)
                // NÃ£o usa salvarPropriedades() pois ela faz reload da pÃ¡gina antes de terminar
                salvarOrdenacaoAutomaticaSemReload().then(function () {
                    // âœ… Limpa seleÃ§Ã£o apÃ³s salvar com sucesso
                    selectedItem = null;
                    if (treeObj) {
                        treeObj.selectedNodes = [];
                    }
                    limparFormulario();

                    // Mensagem de sucesso
                    var msg = 'PÃ¡gina transformada em Grupo e salva com sucesso!';
                    if (itensParaMover && itensParaMover.length > 0) {
                        if (subordinarAoNovoGrupo) {
                            msg = 'Grupo criado com ' + itensParaMover.length + ' filho(s) e salvo com sucesso!';
                        } else if (grupoDestinoId) {
                            msg = 'Grupo criado! ' + itensParaMover.length + ' item(ns) movido(s) para outro grupo. AlteraÃ§Ãµes salvas.';
                        }
                    }

                    Alerta.Sucesso('TransformaÃ§Ã£o Realizada', msg);

                    // âœ… Agora sim, recarrega a pÃ¡gina para atualizar menu lateral
                    setTimeout(function () {
                        window.location.reload();
                    }, 1500);
                }).catch(function (erro) {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoPaginaEmGrupo", erro);
                });

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoPaginaEmGrupo", erro);
            }
        }

            // âœ… REMOVIDO: FunÃ§Ã£o transformarGrupoEmPaginaComFilhos substituÃ­da por executarTransformacaoGrupoEmPagina
            // âœ… REMOVIDO: Evento onItemPaiChange - hierarquia agora Ã© gerenciada pelos botÃµes de seta na TreeView

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CONTROLE DE ALTERAÃ‡Ã•ES PENDENTES
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * @@description Sistema para rastrear mudanÃ§as nÃ£o salvas na estrutura
            * Mostra card de confirmaÃ§Ã£o quando hÃ¡ alteraÃ§Ãµes pendentes
                */

            /**
             * Guarda estado original do treeData
             * @@description Permite cancelar alteraÃ§Ãµes voltando ao estado original
            * @@returns { void}
            */
        function guardarEstadoOriginal() {
            treeDataOriginal = JSON.parse(JSON.stringify(treeData));
            alteracoesPendentes = false;
            esconderCardAlteracoes();
            console.log('[ALTERAÃ‡Ã•ES] Estado original guardado');
        }

            /**
             * Marca que hÃ¡ alteraÃ§Ãµes pendentes
             * @@description Exibe o card de confirmaÃ§Ã£o ao usuÃ¡rio
            * @@returns { void}
            */
        function marcarAlteracoesPendentes() {
            alteracoesPendentes = true;
            mostrarCardAlteracoes();
            console.log('[ALTERAÃ‡Ã•ES] âš ï¸ AlteraÃ§Ãµes pendentes marcadas');
        }

            /**
             * Mostra o card flutuante de confirmaÃ§Ã£o de alteraÃ§Ãµes
             * @@returns { void}
             */
        function mostrarCardAlteracoes() {
            var card = document.getElementById('treeChangesCard');
            console.log('[ALTERAÃ‡Ã•ES] Tentando mostrar card:', card);
            if (card) {
                card.classList.add('show');
                console.log('[ALTERAÃ‡Ã•ES] Card show adicionado. Classes:', card.className);
            } else {
                console.error('[ALTERAÃ‡Ã•ES] Card treeChangesCard nÃ£o encontrado!');
            }
        }

            /**
             * Esconde o card de confirmaÃ§Ã£o de alteraÃ§Ãµes
             * @@returns { void}
             */
        function esconderCardAlteracoes() {
            var card = document.getElementById('treeChangesCard');
            if (card) {
                card.classList.remove('show');
            }
        }

            /**
             * Confirma as alteraÃ§Ãµes e salva no banco
             * @@description Trata casos especiais como transformaÃ§Ã£o de tipo
            * @@returns { void}
            */
        function confirmarAlteracoes() {
            try {
                console.log('[ALTERAÃ‡Ã•ES] âœ… Confirmando alteraÃ§Ãµes...');

                // Se hÃ¡ item selecionado com alteraÃ§Ãµes (ex: transformaÃ§Ã£o de tipo), salva primeiro
                if (selectedItem && selectedItem._transformado) {
                    console.log('[ALTERAÃ‡Ã•ES] Item foi transformado, salvando primeiro...');

                    // Garante que os campos do formulÃ¡rio estÃ£o corretos
                    var tipoItem = document.getElementById('tipoItem');
                    var txtHref = document.getElementById('txtHref');

                    if (tipoItem) tipoItem.value = 'pagina';
                    if (txtHref && selectedItem._novaUrl) txtHref.value = selectedItem._novaUrl;

                    // Salva o item transformado primeiro
                    salvarPropriedades().then(function () {
                        // Remove a flag de transformaÃ§Ã£o
                        delete selectedItem._transformado;
                        delete selectedItem._novaUrl;

                        // Depois salva a Ã¡rvore
                        salvarArvoreCompleta();
                    }).catch(function (erro) {
                        console.error('[ALTERAÃ‡Ã•ES] Erro ao salvar item transformado:', erro);
                        Alerta.Erro('Erro ao Salvar', 'NÃ£o foi possÃ­vel salvar a transformaÃ§Ã£o do item.');
                    });
                    return;
                }

                // Salva apenas a Ã¡rvore (reordenaÃ§Ã£o)
                salvarArvoreCompleta();

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "confirmarAlteracoes", erro);
            }
        }

            /**
             * Salva a Ã¡rvore completa apÃ³s confirmaÃ§Ã£o
             * @@description Chama API e atualiza TreeView
            * @@returns { void}
            */
        function salvarArvoreCompleta() {
            try {
                // Salva no banco
                salvarOrdenacaoAutomatica();

                // Atualiza TreeView
                treeObj.fields.dataSource = treeData;
                treeObj.dataBind();
                treeObj.refresh();
                treeObj.expandAll();
                configurarBotoesNavegacao();

                // Atualiza o estado original para o novo estado
                guardarEstadoOriginal();

                // Esconde o card de alteraÃ§Ãµes
                alteracoesPendentes = false;
                esconderCardAlteracoes();

                // Mostra mensagem de sucesso
                Alerta.Sucesso('AlteraÃ§Ãµes Salvas', 'As alteraÃ§Ãµes na estrutura do menu foram salvas com sucesso!');

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarArvoreCompleta", erro);
            }
        }

            /**
             * Cancela alteraÃ§Ãµes e restaura estado original
             * @@description Desfaz todas as mudanÃ§as nÃ£o salvas
            * @@returns { void}
            */
        function cancelarAlteracoes() {
            try {
                console.log('[ALTERAÃ‡Ã•ES] âŒ Cancelando alteraÃ§Ãµes...');

                if (!treeDataOriginal) {
                    console.warn('[ALTERAÃ‡Ã•ES] NÃ£o hÃ¡ estado original para restaurar');
                    return;
                }

                // Restaura o estado original
                treeData = JSON.parse(JSON.stringify(treeDataOriginal));

                // Atualiza TreeView
                treeObj.fields.dataSource = treeData;
                treeObj.dataBind();
                treeObj.refresh();
                treeObj.expandAll();

                // Reconfigura event listeners
                configurarBotoesNavegacao();

                // Limpa seleÃ§Ã£o
                selectedItem = null;
                limparFormulario(false);

                // Marca como sem alteraÃ§Ãµes pendentes
                alteracoesPendentes = false;
                esconderCardAlteracoes();

                // Mostra mensagem
                mostrarAlerta('AlteraÃ§Ãµes canceladas. Estrutura restaurada.', 'info');

                console.log('[ALTERAÃ‡Ã•ES] âœ… Estado original restaurado');

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "cancelarAlteracoes", erro);
            }
        }

            /**
             * Configura event listeners dos botÃµes de alteraÃ§Ãµes
             * @@description Atribui confirmarAlteracoes e cancelarAlteracoes aos botÃµes
            * @@returns { void}
            */
        function configurarBotoesAlteracoes() {
            var btnConfirmar = document.getElementById('btnConfirmarAlteracoes');
            var btnCancelar = document.getElementById('btnCancelarAlteracoes');

            if (btnConfirmar) {
                btnConfirmar.onclick = confirmarAlteracoes;
            }
            if (btnCancelar) {
                btnCancelar.onclick = cancelarAlteracoes;
            }

            console.log('BotÃµes de confirmaÃ§Ã£o/cancelamento configurados');
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CÃLCULO DE ORDEM AUTOMÃTICA
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Calcula ordem automaticamente baseada nos filhos do pai
             * @@description Define campo txtOrdem com prÃ³ximo valor disponÃ­vel
            * @@param { string } paiId - ID do item pai
                * @@returns { void}
                */
            function calcularOrdemAutomatica(paiId) {
            try {
                console.log('Calculando ordem para pai:', paiId);

                // Busca o item pai no treeData
                var pai = buscarItemPorId(treeData, paiId);

                if (!pai) {
                    console.warn('Pai nÃ£o encontrado no treeData');
                    document.getElementById('txtOrdem').value = 0;
                    return;
                }

                // Busca todos os filhos do pai
                var filhos = pai.items || [];
                console.log('Filhos encontrados:', filhos.length);

                if (filhos.length === 0) {
                    // Primeiro filho
                    document.getElementById('txtOrdem').value = 0;
                    console.log('Ordem definida: 0 (primeiro filho)');
                    return;
                }

                // Encontra a maior ordem entre os filhos
                var maiorOrdem = -1;
                filhos.forEach(function (filho) {
                    var ordem = parseFloat(filho.ordem) || 0;
                    if (ordem > maiorOrdem) {
                        maiorOrdem = ordem;
                    }
                });

                // Nova ordem = maior + 1
                var novaOrdem = maiorOrdem + 1;
                document.getElementById('txtOrdem').value = novaOrdem;
                console.log('Ordem calculada:', novaOrdem, '(maior atual:', maiorOrdem, ')');
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "calcularOrdemAutomatica", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CARREGAMENTO E RENDERIZAÃ‡ÃƒO DA ÃRVORE
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Carrega Ã¡rvore de navegaÃ§Ã£o do banco de dados
             * @@description Chama API GetTreeAdmin e renderiza o TreeView
            * @@returns { void}
            */
        function carregarArvore() {
            try {
                console.log('[DEBUG] Iniciando carregamento da Ã¡rvore...');
                fetch('/api/Navigation/GetTreeAdmin')
                    .then(r => {
                        console.log('[DEBUG] Response recebido:', r.status, r.statusText);
                        return r.json();
                    })
                    .then(result => {
                        console.log('[DEBUG] Dados recebidos da API:', result);
                        console.log('[DEBUG] result.success:', result.success);
                        console.log('[DEBUG] result.data:', result.data);
                        console.log('[DEBUG] result.data.length:', result.data ? result.data.length : 'undefined');

                        if (result.success && result.data && result.data.length > 0) {
                            console.log('[DEBUG] âœ… CondiÃ§Ã£o OK - Renderizando Ã¡rvore com', result.data.length, 'itens');
                            treeData = result.data;

                            // Esconde estado vazio (com verificaÃ§Ã£o de existÃªncia)
                            var emptyState = document.getElementById('emptyTreeState');
                            if (emptyState) {
                                emptyState.style.display = 'none';
                            }

                            console.log('[DEBUG] Chamando renderizarTreeView()...');
                            renderizarTreeView();
                            console.log('[DEBUG] Chamando atualizarContagem()...');
                            atualizarContagem();
                            console.log('[DEBUG] Chamando popularDropdownItemPai()...');
                            // âœ… Popula dropdown de Item Pai apÃ³s carregar Ã¡rvore
                            popularDropdownItemPai();

                            // âœ… Popula dropdown de posiÃ§Ã£o
                            popularDropdownPosicao();

                            // âœ… Guarda o estado original para poder cancelar alteraÃ§Ãµes
                            guardarEstadoOriginal();

                            console.log('[DEBUG] âœ… Ãrvore carregada com sucesso!');
                        } else {
                            console.log('[DEBUG] âŒ CondiÃ§Ã£o falhou - Mostrando estado vazio');
                            console.log('[DEBUG] Motivo: success=' + result.success + ', data=' + (result.data ? 'existe' : 'null/undefined') + ', length=' + (result.data ? result.data.length : 'N/A'));

                            // Mostra estado vazio (com verificaÃ§Ã£o de existÃªncia)
                            var emptyState = document.getElementById('emptyTreeState');
                            if (emptyState) {
                                emptyState.style.display = 'block';
                            }

                            var itemCount = document.getElementById('itemCount');
                            if (itemCount) {
                                itemCount.textContent = '0 itens';
                            }
                        }
                    })
                    .catch(erro => {
                        console.error('[DEBUG] âŒ ERRO no fetch:', erro);
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarArvore", erro);
                    });
            } catch (erro) {
                console.error('[DEBUG] âŒ ERRO no try-catch:', erro);
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarArvore", erro);
            }
        }

            /**
             * Renderiza o TreeView usando Syncfusion EJ2
             * @@description Cria instÃ¢ncia do TreeView com templates customizados
            * Configura nodeTemplate, drag - and - drop e eventos de clique
                * @@returns { void}
                */
        function renderizarTreeView() {
            try {
                console.log('[DEBUG renderizarTreeView] Iniciando renderizaÃ§Ã£o...');
                console.log('[DEBUG renderizarTreeView] treeData:', treeData);
                console.log('[DEBUG renderizarTreeView] treeData.length:', treeData ? treeData.length : 'undefined');

                // âœ… DestrÃ³i instÃ¢ncia anterior do TreeView se existir
                if (treeObj) {
                    console.log('[DEBUG renderizarTreeView] Destruindo instÃ¢ncia anterior do TreeView...');
                    try {
                        treeObj.destroy();
                        treeObj = null;
                    } catch (error) {
                        console.warn('[DEBUG renderizarTreeView] Erro ao destruir TreeView anterior:', error);
                    }
                }

                var container = document.getElementById('gestaoTreeView');
                console.log('[DEBUG renderizarTreeView] Container encontrado:', container);
                container.innerHTML = '<div id="treeViewControl"></div>';

                console.log('[DEBUG renderizarTreeView] Criando nova instÃ¢ncia do TreeView com', treeData.length, 'itens');

                treeObj = new ej.navigations.TreeView({
                    fields: {
                        dataSource: treeData,
                        id: 'id',
                        text: 'text',
                        child: 'items'
                    },
                    nodeTemplate: function (data) {
                        // âœ… REGRA: Grupo nunca tem href, apenas PÃ¡ginas tÃªm href
                        // Grupo = tem filhos OU href vazio/null/javascript:void(0)
                        var isGroup = (data.items && data.items.length > 0) || !data.href || data.href === 'javascript:void(0);' || data.href === '';
                        // Se tem href vÃ¡lido (nÃ£o vazio, nÃ£o void), Ã© PÃ¡gina
                        if (data.href && data.href !== 'javascript:void(0);' && data.href !== '') {
                            isGroup = false;
                        }

                        var badge = isGroup ? 'Grupo' : 'PÃ¡gina';
                        var badgeClass = isGroup ? 'badge-grupo' : 'badge-pagina';
                        var badgeTitle = isGroup ? 'Clique para transformar em PÃ¡gina' : 'Clique para transformar em Grupo';
                        var displayText = decodeHtml(data.text);  // âœ… DECODIFICA para exibiÃ§Ã£o

                        // âœ… Normaliza Ã­cone para DUOTONE
                        var iconClass = data.icon || 'fa-duotone fa-folder';
                        if (iconClass && !iconClass.includes('fa-duotone')) {
                            iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                        }

                        // âœ… BotÃµes de navegaÃ§Ã£o da Ã¡rvore
                        // Usa data-itemid para evitar problemas com escape de aspas em GUIDs
                        var btnsEsquerda =
                            '<div class="tree-nav-buttons tree-nav-left">' +
                            '<button type="button" class="tree-nav-btn btn-order btn-mover-cima" data-itemid="' + data.id + '" title="Mover para cima">' +
                            '<i class="fa-duotone fa-arrow-up-from-bracket"></i>' +
                            '</button>' +
                            '<button type="button" class="tree-nav-btn btn-order btn-mover-baixo" data-itemid="' + data.id + '" title="Mover para baixo">' +
                            '<i class="fa-duotone fa-arrow-down-from-bracket"></i>' +
                            '</button>' +
                            '</div>';

                        var btnsDireita =
                            '<div class="tree-nav-buttons tree-nav-right">' +
                            '<button type="button" class="tree-nav-btn btn-level btn-mover-esq" data-itemid="' + data.id + '" title="Subir nÃ­vel (vira irmÃ£o do pai)">' +
                            '<i class="fa-duotone fa-arrow-left-from-bracket"></i>' +
                            '</button>' +
                            '<button type="button" class="tree-nav-btn btn-level btn-mover-dir" data-itemid="' + data.id + '" title="Descer nÃ­vel (vira filho do item acima)">' +
                            '<i class="fa-duotone fa-arrow-right-from-bracket"></i>' +
                            '</button>' +
                            '</div>';

                        // âœ… Badge clicÃ¡vel para alternar tipo
                        var badgeBtn = '<button type="button" class="node-badge ' + badgeClass + ' btn-toggle-tipo" ' +
                            'data-itemid="' + data.id + '" title="' + badgeTitle + '">' + badge + '</button>';

                        return '<div class="tree-node" data-id="' + data.id + '">' +
                            btnsEsquerda +
                            '<div class="tree-nav-separator"></div>' +
                            '<i class="' + iconClass + ' icon-duotone-ftx"></i>' +
                            '<span class="node-text ' + (isGroup ? 'node-group' : '') + '">' + displayText + '</span>' +
                            badgeBtn +
                            '<div class="tree-nav-separator"></div>' +
                            btnsDireita +
                            '</div>';
                    },
                    allowDragAndDrop: false,  // âœ… DESABILITADO - usar apenas Propriedades
                    allowDropSibling: false,
                    allowDropChild: false,
                    allowMultiSelection: false,
                    nodeClicked: function (args) {
                        try {
                            console.log('=== nodeClicked event ===', args);

                            // Verifica se hÃ¡ elemento node
                            if (!args || !args.node) {
                                console.warn('Node clicado sem elemento vÃ¡lido:', args);
                                return;
                            }

                            // ObtÃ©m o ID do data-id do elemento DOM
                            var nodeElement = args.node;
                            var treeNodeDiv = nodeElement.querySelector('.tree-node');

                            if (!treeNodeDiv) {
                                console.error('Elemento .tree-node nÃ£o encontrado dentro do node');
                                return;
                            }

                            var nodeId = treeNodeDiv.getAttribute('data-id');
                            console.log('Node clicado - ID extraÃ­do do DOM:', nodeId);

                            if (!nodeId) {
                                console.error('data-id nÃ£o encontrado no elemento');
                                return;
                            }

                            // Busca dados completos no treeData
                            var itemCompleto = buscarItemPorId(treeData, nodeId);
                            console.log('Item encontrado no treeData:', itemCompleto);

                            if (itemCompleto) {
                                selecionarItem(itemCompleto);
                            } else {
                                console.error('Item nÃ£o encontrado no treeData para ID:', nodeId);
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "renderizarTreeView.nodeClicked", error);
                        }
                    },
                    expandOn: 'Click'
                });

                treeObj.appendTo('#treeViewControl');
                console.log('âœ… TreeView renderizado com sucesso! Total de itens:', treeData.length);

                // âœ… Adiciona event listeners com delegaÃ§Ã£o para os botÃµes de navegaÃ§Ã£o
                configurarBotoesNavegacao();

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "renderizarTreeView", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * BOTÃ•ES DE NAVEGAÃ‡ÃƒO DA ÃRVORE
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Configura event listeners para botÃµes de navegaÃ§Ã£o
             * @@description Usa delegaÃ§Ã£o de eventos para botÃµes no TreeView
            * @@returns { void}
            */
        function configurarBotoesNavegacao() {
            var treeContainer = document.getElementById('gestaoTreeView');
            if (!treeContainer) {
                console.error('[NAV-BTNS] Container da Ã¡rvore nÃ£o encontrado');
                return;
            }

            // Remove listeners anteriores (se houver)
            treeContainer.removeEventListener('click', handleNavButtonClick);

            // Adiciona listener com delegaÃ§Ã£o (useCapture = true)
            treeContainer.addEventListener('click', handleNavButtonClick, true);

            console.log('Event listeners de navegaÃ§Ã£o configurados');
        }

            /**
             * Handler para cliques nos botÃµes de navegaÃ§Ã£o
             * @@description Identifica qual botÃ£o foi clicado e executa aÃ§Ã£o correspondente
            * @@param { Event } event - Evento de clique
                * @@returns { void}
                */
        function handleNavButtonClick(event) {
            var target = event.target;

            // Se clicou no Ã­cone, pega o botÃ£o pai
            if (target.tagName === 'I') {
                target = target.parentElement;
            }

            // Verifica se Ã© um botÃ£o de navegaÃ§Ã£o OU badge de tipo
            var isNavBtn = target.classList.contains('tree-nav-btn');
            var isToggleTipo = target.classList.contains('btn-toggle-tipo');

            if (!isNavBtn && !isToggleTipo) {
                return; // NÃ£o Ã© um botÃ£o, deixa propagar
            }

            // Para a propagaÃ§Ã£o para evitar que o nodeClicked seja chamado
            event.stopPropagation();
            event.preventDefault();

            var itemId = target.getAttribute('data-itemid');
            console.log('[NAV-BTN] BotÃ£o clicado, itemId:', itemId);

            if (!itemId) {
                console.error('[NAV-BTN] data-itemid nÃ£o encontrado no botÃ£o');
                return;
            }

            // Clique no badge de tipo (Grupo â†” PÃ¡gina)
            if (isToggleTipo) {
                alternarTipoItem(itemId, event);
                return;
            }

            // Identifica qual botÃ£o foi clicado e executa aÃ§Ã£o
            if (target.classList.contains('btn-mover-cima')) {
                moverItemCima(itemId, event);
            } else if (target.classList.contains('btn-mover-baixo')) {
                moverItemBaixo(itemId, event);
            } else if (target.classList.contains('btn-mover-esq')) {
                moverItemEsquerda(itemId, event);
            } else if (target.classList.contains('btn-mover-dir')) {
                moverItemDireita(itemId, event);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * SELEÃ‡ÃƒO E EDIÃ‡ÃƒO DE ITENS
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Seleciona item e carrega suas propriedades no formulÃ¡rio
             * @@description Preenche todos os campos de ediÃ§Ã£o com dados do item
            * @@param { Object } itemData - Dados do item selecionado
                * @@returns { void}
                */
            function selecionarItem(itemData) {
            try {
                console.log('=== INICIO selecionarItem ===');
                console.log('itemData recebido:', itemData);

                if (!itemData) {
                    console.error('itemData Ã© null ou undefined');
                    return;
                }

                selectedItem = itemData;

                // Mostra card de propriedades
                var propsCard = document.getElementById('propsCard');
                if (!propsCard) {
                    console.error('Elemento propsCard nÃ£o encontrado!');
                    return;
                }
                propsCard.style.display = 'block';
                console.log('Card de propriedades mostrado');

                // Marca visualmente
                document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
                var node = document.querySelector('.tree-node[data-id="' + selectedItem.id + '"]');
                if (node) {
                    node.classList.add('selected');
                    console.log('Node marcado visualmente');
                }

                // Preenche formulario - usa os nomes corretos das propriedades (camelCase do JSON)
                var recursoId = document.getElementById('recursoId');
                var parentId = document.getElementById('parentId');
                var txtNome = document.getElementById('txtNome');
                var txtNomeMenu = document.getElementById('txtNomeMenu');
                var txtHref = document.getElementById('txtHref');
                var txtIconClass = document.getElementById('txtIconClass');
                var txtOrdem = document.getElementById('txtOrdem');
                var txtDescricao = document.getElementById('txtDescricao');
                var chkAtivo = document.getElementById('chkAtivo');
                var selectedItemName = document.getElementById('selectedItemName');
                var modoEdicao = document.getElementById('modoEdicao');

                // âœ… Preenche campos com valores DECODIFICADOS
                if (recursoId) recursoId.value = selectedItem.id || '';
                if (parentId) parentId.value = selectedItem.parentId || '';
                if (txtNome) txtNome.value = decodeHtml(selectedItem.text) || '';
                if (txtNomeMenu) txtNomeMenu.value = decodeHtml(selectedItem.nomeMenu) || '';
                if (txtHref) txtHref.value = selectedItem.href || '';
                if (txtOrdem) txtOrdem.value = selectedItem.ordem || 0;
                if (txtDescricao) txtDescricao.value = decodeHtml(selectedItem.descricao) || '';
                if (chkAtivo) chkAtivo.checked = selectedItem.ativo !== false;
                if (selectedItemName) selectedItemName.textContent = decodeHtml(selectedItem.text);

                console.log('Campos bÃ¡sicos preenchidos (decodificados)');

                // âœ… Atualiza estado dos botÃµes de ordenaÃ§Ã£o
                atualizarEstadoBotoesOrdenacao();

                // ========== ATUALIZA DROPDOWNTREE DE ÃCONE ==========
                var iconClass = selectedItem.icon || 'fa-duotone fa-file';
                if (txtIconClass) txtIconClass.value = iconClass;

                var ddlIconeObj = document.getElementById('ddlIcone');
                if (ddlIconeObj && ddlIconeObj.ej2_instances && ddlIconeObj.ej2_instances[0]) {
                    var ddlIcone = ddlIconeObj.ej2_instances[0];

                    // âœ… Converte fa-regular/fa-solid/fa-light para fa-duotone se necessÃ¡rio
                    var iconClassNormalizado = iconClass;
                    if (iconClass) {
                        // Remove qualquer prefixo e adiciona fa-duotone
                        iconClassNormalizado = iconClass.replace(/^fa-(regular|solid|light|duotone)\s+/, 'fa-duotone ');
                        // Se nÃ£o tinha prefixo, adiciona fa-duotone
                        if (!iconClassNormalizado.startsWith('fa-')) {
                            iconClassNormalizado = 'fa-duotone ' + iconClassNormalizado;
                        }
                    }

                    // Limpa seleÃ§Ã£o anterior
                    ddlIcone.value = null;
                    ddlIcone.dataBind();

                    // Define novo valor apÃ³s um pequeno delay para garantir que o componente estÃ¡ pronto
                    setTimeout(function () {
                        if (ddlIcone.fields && ddlIcone.fields.dataSource) {
                            var dataSource = ddlIcone.fields.dataSource;
                            var iconEncontrado = null;

                            // Busca em todas as categorias
                            for (var i = 0; i < dataSource.length; i++) {
                                var cat = dataSource[i];
                                if (cat.child && cat.child.length > 0) {
                                    for (var j = 0; j < cat.child.length; j++) {
                                        var icon = cat.child[j];
                                        // Compara com ID normalizado, original, ou apenas o nome do Ã­cone
                                        var iconIdStr = String(icon.id || '');
                                        var iconClassStr = String(iconClassNormalizado || '');
                                        var iconClassOriginalStr = String(iconClass || '');

                                        // Extrai apenas o nome do Ã­cone (ex: "fa-file" de "fa-duotone fa-file")
                                        var iconNameNormalizado = iconClassNormalizado.replace(/^fa-duotone\s+/, '');
                                        var iconNameOriginal = iconClassOriginalStr.replace(/^fa-(regular|solid|light|duotone)\s+/, '');

                                        if (iconIdStr === iconClassNormalizado ||
                                            iconIdStr === iconClassOriginalStr ||
                                            iconIdStr.endsWith(' ' + iconNameNormalizado) ||
                                            iconIdStr.endsWith(' ' + iconNameOriginal)) {
                                            iconEncontrado = icon;
                                            break;
                                        }
                                    }
                                }
                                if (iconEncontrado) break;
                            }

                            if (iconEncontrado) {
                                ddlIcone.value = [iconEncontrado.id];
                                ddlIcone.dataBind();
                                console.log('âœ… DropDownTree de Ã­cone atualizado para:', iconEncontrado.id);
                            } else {
                                console.warn('Ãcone nÃ£o encontrado no dataSource. Tentando:', iconClassNormalizado, 'ou', iconClass);
                            }
                        }
                    }, 500);
                }

                // ========== ATUALIZA DROPDOWNTREE DE PÃGINA ==========
                // Busca pela paginaRef (URL) ao invÃ©s de tentar reconstruir o ID
                var href = selectedItem.href || '';
                console.log('URL do item (href):', href);

                if (href && href.endsWith('.html')) {
                    var ddlPaginaObj = document.getElementById('ddlPagina');
                    if (ddlPaginaObj && ddlPaginaObj.ej2_instances && ddlPaginaObj.ej2_instances[0]) {
                        var ddlPagina = ddlPaginaObj.ej2_instances[0];

                        // Busca o item pela paginaRef no dataSource
                        var pageId = null;
                        if (ddlPagina.fields && ddlPagina.fields.dataSource) {
                            var dataSource = ddlPagina.fields.dataSource;
                            console.log('Buscando pÃ¡gina com paginaRef:', href);

                            // Itera todas as categorias (mÃ³dulos)
                            for (var i = 0; i < dataSource.length; i++) {
                                var category = dataSource[i];
                                if (category.child && category.child.length > 0) {
                                    // Busca nos filhos (pÃ¡ginas)
                                    for (var j = 0; j < category.child.length; j++) {
                                        var page = category.child[j];
                                        if (page.paginaRef === href) {
                                            pageId = page.id;
                                            console.log('âœ… PÃ¡gina encontrada! ID:', pageId, '| MÃ³dulo:', category.text, '| PÃ¡gina:', page.text);
                                            break;
                                        }
                                    }
                                }
                                if (pageId) break;
                            }
                        }

                        if (pageId) {
                            // Limpa seleÃ§Ã£o anterior
                            ddlPagina.value = null;
                            // Define novo valor
                            setTimeout(function () {
                                ddlPagina.value = [pageId];
                                console.log('âœ… DropDownTree de pÃ¡gina atualizado para:', pageId);
                            }, 100);
                        } else {
                            console.warn('âš ï¸ PÃ¡gina nÃ£o encontrada no DropDownTree para href:', href);
                        }
                    }
                } else {
                    console.log('URL nÃ£o estÃ¡ no formato esperado ou estÃ¡ vazia');
                }

                // ========== ATUALIZA PARENT ID (campo oculto) ==========
                var parentId = selectedItem.parentId;
                console.log('Parent ID do item:', parentId);
                document.getElementById('parentId').value = parentId || '';

                // Atualiza indicador de modo
                if (modoEdicao) {
                    modoEdicao.textContent = 'Editar';
                    modoEdicao.className = 'badge bg-warning text-dark ms-2';
                }

                // âœ… Habilita Card de Propriedades (caso esteja desabilitado)
                habilitarCardPropriedades(true);

                // âœ… Carrega e mostra controle de acesso
                carregarControleAcesso(selectedItem.id);
                document.getElementById('acessoCard').style.display = 'block';

                // âœ… Atualiza toggle de tipo (PÃ¡gina/Grupo)
                atualizarToggleTipo(selectedItem);

                console.log('=== FIM selecionarItem (sucesso) ===');
            } catch (error) {
                console.error('ERRO em selecionarItem:', error);
                console.error('Stack:', error.stack);
                mostrarAlerta('Erro ao selecionar item: ' + error.message, 'danger');
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * BUSCA RECURSIVA NA ÃRVORE
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Busca item por ID recursivamente no treeData
             * @@param { Array } items - Lista de itens para buscar
            * @@param { string } id - ID do item a buscar
                * @@returns { Object| null} Item encontrado ou null
                    */
        function buscarItemPorId(items, id) {
            try {
                if (!items || !id) return null;

                for (var i = 0; i < items.length; i++) {
                    // Compara como string para garantir
                    if (String(items[i].id) === String(id)) {
                        return items[i];
                    }
                    if (items[i].items && items[i].items.length > 0) {
                        var found = buscarItemPorId(items[i].items, id);
                        if (found) return found;
                    }
                }
                return null;
            } catch (erro) {
                console.error('[buscarItemPorId] Erro:', erro);
                return null;
            }
        }

            /**
             * Remove um item da Ã¡rvore recursivamente
             * @@param { Array } items - Lista de itens
            * @@param { string } id - ID do item a remover
                * @@returns { boolean } true se removeu, false se nÃ£o encontrou
                    */
        function removerItemDaArvore(items, id) {
            try {
                if (!items || !id) return false;

                for (var i = 0; i < items.length; i++) {
                    if (String(items[i].id) === String(id)) {
                        // Remove o item encontrado
                        items.splice(i, 1);
                        return true;
                    }
                    // Busca recursivamente nos filhos
                    if (items[i].items && items[i].items.length > 0) {
                        if (removerItemDaArvore(items[i].items, id)) {
                            return true;
                        }
                    }
                }
                return false;
            } catch (erro) {
                console.error('[removerItemDaArvore] Erro:', erro);
                return false;
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CARREGAMENTO DE ÃCONES E PÃGINAS
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Carrega Ã­cones FontAwesome do endpoint da API
             * @@description Popula o DropDownTree com Ã­cones hierÃ¡rquicos
            * @@returns { void}
            */
        function carregarIconesFontAwesome() {
            try {
                fetch('/api/Navigation/GetIconesFontAwesomeHierarquico')
                    .then(r => r.json())
                    .then(result => {
                        console.log('Ãcones FontAwesome carregados:', result);
                        if (result.success && result.data) {
                            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                            if (ddlIconeObj) {
                                // Configura os fields do DropDownTree
                                ddlIconeObj.fields = {
                                    dataSource: result.data,
                                    value: 'id',
                                    text: 'text',
                                    parentValue: 'parentId',
                                    hasChildren: 'hasChild',
                                    child: 'child'
                                };
                                ddlIconeObj.dataBind();
                                console.log('DropDownTree de Ã­cones populado com', result.data.length, 'categorias');
                            }
                        }
                    })
                    .catch(erro => {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarIconesFontAwesome", erro);
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarIconesFontAwesome", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * EVENTOS DE SELEÃ‡ÃƒO DE ÃCONE
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Evento SELECT: Dispara ao clicar no Ã­cone (nÃ£o precisa clicar fora)
             * @@param { Object } args - Argumentos do evento Syncfusion
            * @@returns { void}
            */
            function onIconeSelect(args) {
            try {
                console.log('=== onIconeSelect disparado (AO CLICAR) ===');
                console.log('args.nodeData:', args.nodeData);

                if (!args.nodeData || args.nodeData.isCategory) {
                    console.log('Categoria clicada - nÃ£o atualiza campo');
                    return;
                }

                // No evento SELECT, os dados vÃªm em args.nodeData
                var iconClass = args.nodeData.id;      // "fa-duotone fa-bat"
                var iconLabel = args.nodeData.text;    // "BastÃ£o"

                var txtIconClass = document.getElementById('txtIconClass');
                if (txtIconClass) {
                    txtIconClass.value = iconClass;
                    console.log('Classe CSS atualizada IMEDIATAMENTE:', iconClass, '| Label:', iconLabel);
                } else {
                    console.error('Elemento txtIconClass nÃ£o encontrado!');
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onIconeSelect", erro);
            }
        }

            /**
             * Evento CHANGE: Backup para quando valor Ã© setado programaticamente
             * @@param { Object } args - Argumentos do evento Syncfusion
            * @@returns { void}
            */
            function onIconeChange(args) {
            try {
                console.log('=== onIconeChange disparado ===');
                console.log('args completo:', args);
                console.log('args.itemData:', args.itemData);
                console.log('args.value:', args.value);

                // Quando setado programaticamente, itemData vem undefined
                // Preciso buscar o item no dataSource
                var itemData = args.itemData;

                if (!itemData && args.value && args.value.length > 0) {
                    console.log('itemData undefined - buscando no dataSource...');
                    var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                    if (ddlIconeObj && ddlIconeObj.fields && ddlIconeObj.fields.dataSource) {
                        var iconId = args.value[0];
                        console.log('Buscando iconId:', iconId);

                        itemData = findIconById(iconId);
                        if (itemData) {
                            console.log('Ãcone encontrado no dataSource:', itemData);
                        }

                        // Se nÃ£o encontrou, pode ser que seja a prÃ³pria classe
                        if (!itemData) {
                            console.log('Ãcone nÃ£o encontrado no dataSource - usando iconId diretamente');
                            itemData = { id: iconId, text: iconId, isCategory: false };
                        }
                    }
                }

                // Se nÃ£o hÃ¡ dados ou Ã© uma categoria, limpa o campo
                if (!itemData || itemData.isCategory) {
                    document.getElementById('txtIconClass').value = '';
                    console.log('Categoria selecionada ou campo limpo');
                    return;
                }

                // Apenas Ã­cones vÃ¡lidos (nÃ£o categorias)
                var iconClass = itemData.id;      // "fa-duotone fa-bat"
                var iconLabel = itemData.text;    // "BastÃ£o"

                // Atualiza campo de texto bloqueado com a classe CSS
                var txtIconClass = document.getElementById('txtIconClass');
                if (txtIconClass) {
                    txtIconClass.value = iconClass;
                    console.log('Classe CSS atualizada:', iconClass, '| Label:', iconLabel);
                } else {
                    console.error('Elemento txtIconClass nÃ£o encontrado!');
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onIconeChange", erro);
            }
        }

            /**
             * Carrega pÃ¡ginas do sistema da API
             * @@description Popula o DropDownTree de pÃ¡ginas
            * @@returns { void}
            */
        function carregarPaginasSistema() {
            try {
                fetch('/api/Navigation/GetPaginasHierarquico')
                    .then(r => r.json())
                    .then(result => {
                        console.log('PÃ¡ginas carregadas:', result);
                        if (result.success && result.data) {
                            var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                            if (ddlPaginaObj) {
                                ddlPaginaObj.fields = {
                                    dataSource: result.data,
                                    value: 'id',
                                    text: 'text',
                                    parentValue: 'parentId',
                                    hasChildren: 'hasChild',
                                    child: 'child'
                                };
                                ddlPaginaObj.dataBind();
                                console.log('DropDownTree de pÃ¡ginas populado com', result.data.length, 'mÃ³dulos');
                            }
                        }
                    })
                    .catch(erro => {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarPaginasSistema", erro);
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarPaginasSistema", erro);
            }
        }

            /**
             * Callback apÃ³s criaÃ§Ã£o do DropDownTree de pÃ¡ginas
             * @@description Configura templates de item e valor para exibiÃ§Ã£o
            * @@returns { void}
            */
        function onPaginaDropdownCreated() {
            try {
                var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                if (ddlPaginaObj) {
                    ddlPaginaObj.itemTemplate = function (data) {
                        if (data.isCategory) {
                            return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                        }
                        return '<div style="display: flex; align-items: center; gap: 8px;">' +
                            '<i class="fa-duotone fa-file-lines" style="font-size: 16px; width: 20px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                            '<span>' + data.text + '</span>' +
                            '</div>';
                    };

                    ddlPaginaObj.valueTemplate = function (data) {
                        if (!data || data.isCategory) return '';
                        var displayText = data.displayText || data.text;
                        return '<div style="display: flex; align-items: center; gap: 8px;">' +
                            '<i class="fa-duotone fa-file-lines" style="font-size: 14px; width: 18px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                            '<span>' + displayText + '</span>' +
                            '</div>';
                    };

                    // âœ… Evento SELECTING: dispara ANTES de confirmar seleÃ§Ã£o (mais confiÃ¡vel)
                    ddlPaginaObj.selecting = function (args) {
                        console.log('=== SELECTING pÃ¡gina (ANTES) ===', args);
                        if (args.nodeData && !args.nodeData.isCategory) {
                            // Armazena a seleÃ§Ã£o na variÃ¡vel global IMEDIATAMENTE
                            ultimaPaginaSelecionada = {
                                id: args.nodeData.id,
                                paginaRef: args.nodeData.paginaRef
                            };

                            var txtHref = document.getElementById('txtHref');
                            if (txtHref && args.nodeData.paginaRef) {
                                txtHref.value = args.nodeData.paginaRef;
                                console.log('âœ… URL atualizada via SELECTING:', args.nodeData.paginaRef);
                            }
                        }
                    };

                    // âœ… Evento SELECT: dispara ao selecionar item
                    ddlPaginaObj.select = function (args) {
                        console.log('=== SELECT pÃ¡gina ===', args);
                        if (args.nodeData && !args.nodeData.isCategory) {
                            // Armazena a seleÃ§Ã£o na variÃ¡vel global
                            ultimaPaginaSelecionada = {
                                id: args.nodeData.id,
                                paginaRef: args.nodeData.paginaRef
                            };

                            var txtHref = document.getElementById('txtHref');
                            if (txtHref && args.nodeData.paginaRef) {
                                txtHref.value = args.nodeData.paginaRef;
                                console.log('âœ… URL atualizada via SELECT:', args.nodeData.paginaRef);
                            }

                            // forÃ§a valor e dispara change manual para refletir na primeira escolha
                            ddlPaginaObj.value = [args.nodeData.id];
                            onPaginaChange({ itemData: args.nodeData, value: [args.nodeData.id] });
                            ddlPaginaObj.hidePopup();
                        }
                    };

                    // âœ… Evento CHANGE: backup
                    ddlPaginaObj.change = function (args) {
                        onPaginaChange(args);
                    };

                    // NÃ£o depende de blur para aplicar mudanÃ§a
                    ddlPaginaObj.changeOnBlur = false;

                    // âœ… Evento CLOSE do popup: garante atualizaÃ§Ã£o ao fechar
                    ddlPaginaObj.close = function (args) {
                        console.log('=== CLOSE pÃ¡gina ===');

                        var paginaRef = null;
                        var pageId = null;

                        // Tenta pegar o valor atual do componente
                        var valor = ddlPaginaObj.value;
                        if (valor && valor.length > 0) {
                            pageId = valor[0];
                            console.log('Valor do componente:', pageId);

                            // Busca a paginaRef no dataSource
                            if (ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                                var dataSource = ddlPaginaObj.fields.dataSource;
                                for (var i = 0; i < dataSource.length; i++) {
                                    var modulo = dataSource[i];
                                    if (modulo.child && modulo.child.length > 0) {
                                        for (var j = 0; j < modulo.child.length; j++) {
                                            var page = modulo.child[j];
                                            if (page.id === pageId && page.paginaRef) {
                                                paginaRef = page.paginaRef;
                                                break;
                                            }
                                        }
                                    }
                                    if (paginaRef) break;
                                }
                            }
                        }

                        // Se nÃ£o encontrou, usa a Ãºltima seleÃ§Ã£o armazenada
                        if (!paginaRef && ultimaPaginaSelecionada) {
                            paginaRef = ultimaPaginaSelecionada.paginaRef;
                            console.log('Usando Ãºltima pÃ¡gina selecionada:', paginaRef);
                        }

                        // Atualiza o campo se tiver uma URL vÃ¡lida
                        if (paginaRef) {
                            var txtHref = document.getElementById('txtHref');
                            if (txtHref) {
                                txtHref.value = paginaRef;
                                console.log('âœ… URL atualizada via CLOSE:', paginaRef);
                            }
                        }
                    };

                    console.log('DropDownTree de pÃ¡ginas configurado');
                }
            } catch (error) {
                console.error('Erro ao configurar DropDownTree de pÃ¡ginas:', error);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * EVENTOS DE SELEÃ‡ÃƒO DE PÃGINA
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Evento SELECT: Dispara ao clicar na pÃ¡gina (nÃ£o precisa clicar fora)
             * @@param { Object } args - Argumentos do evento Syncfusion
            * @@returns { void}
            */
            function onPaginaSelect(args) {
            try {
                console.log('=== onPaginaSelect disparado (AO CLICAR) ===');
                console.log('args.nodeData:', args.nodeData);

                if (!args.nodeData || args.nodeData.isCategory) {
                    console.log('Categoria clicada - nÃ£o gera URL');
                    return;
                }

                // No evento SELECT, os dados vÃªm em args.nodeData
                var paginaRef = args.nodeData.paginaRef;
                console.log('paginaRef extraÃ­da:', paginaRef);

                var txtHref = document.getElementById('txtHref');
                if (txtHref) {
                    txtHref.value = paginaRef;
                    console.log('URL atualizada IMEDIATAMENTE:', paginaRef);
                } else {
                    console.error('Elemento txtHref nÃ£o encontrado!');
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPaginaSelect", erro);
            }
        }

            /**
             * Evento CHANGE: Backup para quando valor Ã© setado programaticamente
             * @@param { Object } args - Argumentos do evento Syncfusion
            * @@returns { void}
            */
            function onPaginaChange(args) {
            try {
                console.log('=== onPaginaChange disparado ===');
                console.log('args completo:', args);
                console.log('args.itemData:', args.itemData);
                console.log('args.value:', args.value);

                // Quando setado programaticamente, itemData vem undefined
                // Preciso buscar o item no dataSource
                var itemData = args.itemData;

                if (!itemData && args.value && args.value.length > 0) {
                    console.log('itemData undefined - buscando no dataSource...');
                    var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                    if (ddlPaginaObj && ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                        var pageId = args.value[0];
                        console.log('Buscando pageId:', pageId);

                        // Busca em todas as categorias
                        var dataSource = ddlPaginaObj.fields.dataSource;
                        for (var i = 0; i < dataSource.length; i++) {
                            var category = dataSource[i];
                            if (category.child && category.child.length > 0) {
                                for (var j = 0; j < category.child.length; j++) {
                                    if (category.child[j].id === pageId) {
                                        itemData = category.child[j];
                                        console.log('Item encontrado no dataSource:', itemData);
                                        break;
                                    }
                                }
                            }
                            if (itemData) break;
                        }
                    }
                }

                // Se nÃ£o hÃ¡ dados ou Ã© uma categoria, nÃ£o faz nada
                if (!itemData || itemData.isCategory) {
                    console.log('Categoria selecionada ou campo limpo - nÃ£o gera URL');
                    return;
                }

                // ObtÃ©m a URL gerada (formato: modulo_pagina.html)
                var paginaRef = itemData.paginaRef;
                console.log('paginaRef extraÃ­da:', paginaRef);

                var txtHref = document.getElementById('txtHref');
                if (txtHref) {
                    txtHref.value = paginaRef;
                    console.log('URL atualizada no campo txtHref:', paginaRef);
                } else {
                    console.error('Elemento txtHref nÃ£o encontrado!');
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPaginaChange", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CONTROLE DE ACESSO (PERMISSÃ•ES DE USUÃRIO)
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Carrega lista de usuÃ¡rios com acesso ao recurso
             * @@param { string } recursoId - ID do recurso de navegaÃ§Ã£o
            * @@returns { void}
            */
        function carregarControleAcesso(recursoId) {
            try {
                if (!recursoId) {
                    document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
                    return;
                }

                fetch('/api/Navigation/GetUsuariosAcesso?recursoId=' + recursoId)
                    .then(r => r.json())
                    .then(result => {
                        console.log('Acessos carregados:', result);
                        var container = document.getElementById('listaAcessos');
                        if (result.success && result.data && result.data.length > 0) {
                            container.innerHTML = result.data.map(u =>
                                '<div class="acesso-item">' +
                                '<input type="checkbox" class="form-check-input me-2" ' +
                                'id="acesso_' + u.usuarioId + '" ' +
                                (u.acesso ? 'checked' : '') +
                                ' onchange="atualizarAcesso(\'' + u.usuarioId + '\', this.checked)" />' +
                                '<label for="acesso_' + u.usuarioId + '">' + u.nome + '</label>' +
                                '</div>'
                            ).join('');
                        } else {
                            container.innerHTML = '<p class="text-muted text-center">Nenhum usuÃ¡rio encontrado</p>';
                        }
                    })
                    .catch(erro => {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarControleAcesso", erro);
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarControleAcesso", erro);
            }
        }

            /**
             * Atualiza acesso de usuÃ¡rio ao recurso
             * @@param { string } usuarioId - ID do usuÃ¡rio
            * @@param { boolean } acesso - true para habilitar, false para remover
                * @@returns { void}
                */
        function atualizarAcesso(usuarioId, acesso) {
            try {
                if (!selectedItem) return;

                fetch('/api/Navigation/UpdateAcesso', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        usuarioId: usuarioId,
                        recursoId: selectedItem.id,
                        acesso: acesso
                    })
                })
                    .then(r => r.json())
                    .then(result => {
                        if (result.success) {
                            mostrarAlerta('Acesso atualizado!', 'success');
                        } else {
                            mostrarAlerta('Erro ao atualizar acesso: ' + result.message, 'danger');
                        }
                    })
                    .catch(erro => {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarAcesso", erro);
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarAcesso", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * SALVAMENTO DE PROPRIEDADES DO ITEM
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Salva propriedades do item no banco de dados
             * @@description Valida campos, codifica HTML e envia para API
            * @@returns { Promise } Promise que resolve com sucesso ou rejeita com erro
                */
        function salvarPropriedades() {
            return new Promise(function (resolve, reject) {
                try {
                    // âœ… ObtÃ©m o tipo de item do toggle
                    var tipoItem = document.getElementById('tipoItem').value;
                    var ehGrupo = (tipoItem === 'grupo');

                    // âœ… CODIFICA valores antes de enviar ao backend
                    var txtHref = document.getElementById('txtHref').value;
                    var parentIdValue = document.getElementById('parentId').value;

                    // âœ… Define href baseado no tipo
                    var hrefFinal;
                    if (ehGrupo) {
                        // Grupo nÃ£o tem URL de pÃ¡gina
                        hrefFinal = 'javascript:void(0);';
                    } else {
                        // PÃ¡gina deve ter URL
                        hrefFinal = txtHref || null;

                        if (!hrefFinal) {
                            Alerta.Warning('AtenÃ§Ã£o', 'Para itens do tipo PÃ¡gina, selecione uma pÃ¡gina do sistema!');
                            reject(new Error('URL nÃ£o informada'));
                            return;
                        }
                    }

                    // âœ… ObtÃ©m posiÃ§Ã£o selecionada no dropdown
                    var posicaoSelecionada = null;
                    var ddlPosicaoObj = document.getElementById('ddlPosicao');
                    if (ddlPosicaoObj && ddlPosicaoObj.ej2_instances && ddlPosicaoObj.ej2_instances[0]) {
                        var ddlPosicao = ddlPosicaoObj.ej2_instances[0];
                        posicaoSelecionada = ddlPosicao.value && ddlPosicao.value.length > 0 ? ddlPosicao.value[0] : null;
                    }
                    console.log('[SALVAR] PosiÃ§Ã£o selecionada:', posicaoSelecionada);

                    // âœ… Calcula parentId baseado na posiÃ§Ã£o (para novos itens ou quando alterado)
                    var parentIdFinal = parentIdValue || null;
                    var ehNovoItem = !document.getElementById('recursoId').value;

                    if (ehNovoItem && posicaoSelecionada && posicaoSelecionada !== '_INICIO_') {
                        // Se posicionou abaixo de um item, herda o parentId desse item
                        var itemReferencia = buscarItemPorId(treeData, posicaoSelecionada);
                        if (itemReferencia) {
                            parentIdFinal = itemReferencia.parentId || null;
                        }
                    }

                    var dto = {
                        id: document.getElementById('recursoId').value,
                        text: encodeHtml(document.getElementById('txtNome').value),
                        nomeMenu: encodeHtml(document.getElementById('txtNomeMenu').value),
                        href: hrefFinal,
                        icon: document.getElementById('txtIconClass').value,
                        ordem: 0,  // âœ… Backend calcula automaticamente
                        descricao: encodeHtml(document.getElementById('txtDescricao').value),
                        ativo: document.getElementById('chkAtivo').checked,
                        parentId: parentIdFinal,
                        posicaoAbaixoDe: posicaoSelecionada  // âœ… Envia para backend posicionar corretamente
                    };

                    console.log('DTO codificado para envio:', dto);

                    if (!dto.text || !dto.nomeMenu) {
                        Alerta.Warning('AtenÃ§Ã£o', 'Preencha Nome e NomeMenu!');
                        reject(new Error('Campos obrigatÃ³rios nÃ£o preenchidos'));
                        return;
                    }

                    var ehNovoItem = !dto.id;  // Se nÃ£o tem ID, Ã© novo item

                    fetch('/api/Navigation/SaveRecurso', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dto)
                    })
                        .then(r => r.json())
                        .then(result => {
                            if (result.success) {
                                mostrarAlerta(result.message, 'success');

                                // âœ… Atualiza Ã¡rvore apÃ³s pequeno delay para garantir que backend processou
                                setTimeout(function () {
                                    carregarArvore();
                                }, 300);

                                // âœ… Atualiza navegaÃ§Ã£o lateral apÃ³s salvar
                                atualizarNavegacaoLateral();

                                var recursoId = result.id || dto.id;

                                // âœ… APENAS para NOVO ITEM: habilita acesso e pergunta sobre gerenciamento
                                if (ehNovoItem && recursoId) {
                                    // Habilita acesso para todos usuÃ¡rios automaticamente
                                    habilitarAcessoTodosUsuarios(recursoId);

                                    // Pergunta se deseja fazer controle de acesso
                                    Alerta.Confirmar(
                                        'Gerenciar Controle de Acesso',
                                        'Deseja gerenciar o controle de acesso deste item agora?',
                                        'Sim',
                                        'NÃ£o'
                                    ).then(function (result) {
                                        if (result) {
                                            // Atualiza selectedItem com o ID retornado
                                            selectedItem = {
                                                id: recursoId,
                                                text: dto.text,
                                                nomeMenu: dto.nomeMenu,
                                                href: dto.href,
                                                icon: dto.icon,
                                                ordem: dto.ordem,
                                                descricao: dto.descricao,
                                                ativo: dto.ativo,
                                                parentId: dto.parentId
                                            };
                                            document.getElementById('recursoId').value = recursoId;

                                            // Desabilita Card de Propriedades
                                            habilitarCardPropriedades(false);

                                            // Carrega controle de acesso
                                            carregarControleAcesso(recursoId);

                                            // Mostra Card de Controle de Acesso
                                            document.getElementById('acessoCard').style.display = 'block';
                                        } else {
                                            // NÃ£o quer gerenciar acesso, fecha os cards
                                            document.getElementById('propsCard').style.display = 'none';
                                            document.getElementById('acessoCard').style.display = 'none';
                                            habilitarCardPropriedades(true);
                                        }
                                    });
                                } else {
                                    // âœ… EDIÃ‡ÃƒO de item existente: apenas fecha card de propriedades
                                    document.getElementById('propsCard').style.display = 'none';
                                    habilitarCardPropriedades(true);
                                }

                                // Resolve a Promise apÃ³s sucesso
                                resolve(result);
                            } else {
                                mostrarAlerta('Erro: ' + result.message, 'danger');
                                reject(new Error(result.message));
                            }
                        })
                        .catch(erro => {
                            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarPropriedades", erro);
                            reject(erro);
                        });
                } catch (erro) {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarPropriedades", erro);
                    reject(erro);
                }
            });
        }

        // Adiciona novo item
        function adicionarNovoItem() {
            try {
                // Limpa formulario mas mantÃ©m card visÃ­vel
                limparFormulario(false);  // false = NÃƒO esconde o card

                // âœ… Habilita Card de Propriedades
                habilitarCardPropriedades(true);

                // Mostra card de propriedades
                document.getElementById('propsCard').style.display = 'block';

                // âœ… Garante que Card de Controle de Acesso estÃ¡ escondido ao criar novo item
                document.getElementById('acessoCard').style.display = 'none';

                document.getElementById('txtNome').focus();
                document.getElementById('selectedItemName').textContent = 'Novo Item';

                // Atualiza indicador de modo para "Criar"
                document.getElementById('modoEdicao').textContent = 'Criar';
                document.getElementById('modoEdicao').className = 'badge bg-success ms-2';
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "adicionarNovoItem", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CRUD DE ITENS DA ÃRVORE
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Exclui item selecionado da Ã¡rvore
             * @@description Pede confirmaÃ§Ã£o e chama API de exclusÃ£o
            * @@returns { void}
            */
        function excluirItem() {
            try {
                if (!selectedItem || !selectedItem.id) {
                    mostrarAlerta('Selecione um item para excluir!', 'warning');
                    return;
                }

                Alerta.Confirmar(
                    'Confirmar ExclusÃ£o',
                    'Tem certeza que deseja excluir "' + decodeHtml(selectedItem.text) + '"?',
                    'Excluir',
                    'Cancelar'
                ).then(function (result) {
                    if (!result) return;

                    fetch('/api/Navigation/DeleteRecurso', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recursoId: selectedItem.id })
                    })
                        .then(r => r.json())
                        .then(result => {
                            if (result.success) {
                                mostrarAlerta(result.message, 'success');
                                limparFormulario();
                                carregarArvore();
                            } else {
                                mostrarAlerta('Erro: ' + result.message, 'danger');
                            }
                        })
                        .catch(erro => {
                            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "excluirItem", erro);
                        });
                });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "excluirItem", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * VALIDAÃ‡ÃƒO DE FORMULÃRIO
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Valida se campos obrigatÃ³rios estÃ£o preenchidos
             * @@returns { boolean } true se todos os campos obrigatÃ³rios estÃ£o preenchidos
            */
        function validarCamposObrigatorios() {
            var nome = document.getElementById('txtNome').value.trim();
            var nomeMenu = document.getElementById('txtNomeMenu').value.trim();
            var pagina = document.getElementById('ddlPagina')?.ej2_instances?.[0]?.value;
            var icone = document.getElementById('ddlIcone')?.ej2_instances?.[0]?.value;

            return nome && nomeMenu && pagina && pagina.length > 0 && icone && icone.length > 0;
        }

            /**
             * Atualiza estado dos botÃµes de ordenaÃ§Ã£o
             * @@description Mantida para compatibilidade - botÃµes agora estÃ£o inline
            * @@returns { void}
            */
        function atualizarEstadoBotoesOrdenacao() {
            // BotÃµes de navegaÃ§Ã£o agora estÃ£o inline na TreeView
            // NÃ£o hÃ¡ mais botÃµes externos para atualizar
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * VERIFICAÃ‡Ã•ES DE MOVIMENTAÃ‡ÃƒO
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Verifica se item selecionado pode mover para cima
             * @@returns { boolean } true se pode mover
            */
        function podeMoverParaCima() {
            if (!selectedItem || !selectedItem.id || !treeData) return false;

            var item = buscarItemPorId(treeData, selectedItem.id);
            if (!item) return false;

            // Encontra a lista que contÃ©m o item e seu Ã­ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado) return false;

            return resultado.indice > 0; // Pode mover se nÃ£o Ã© o primeiro
        }

            /**
             * Verifica se item selecionado pode mover para baixo
             * @@returns { boolean } true se pode mover
            */
        function podeMoverParaBaixo() {
            if (!selectedItem || !selectedItem.id || !treeData) return false;

            var item = buscarItemPorId(treeData, selectedItem.id);
            if (!item) return false;

            // Encontra a lista que contÃ©m o item e seu Ã­ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado) return false;

            return resultado.indice < resultado.lista.length - 1; // Pode mover se nÃ£o Ã© o Ãºltimo
        }

            /**
             * Busca a lista pai que contÃ©m um item
             * @@param { Array } lista - Lista para buscar
            * @@param { string } targetId - ID do item alvo
                * @@param { string } targetParentId - ID do pai do item alvo
                    * @@returns { Object| null} Objeto com lista e Ã­ndice, ou null
                        */
        function encontrarListaPaiEIndice(lista, targetId, targetParentId) {
            for (var i = 0; i < lista.length; i++) {
                var currentItem = lista[i];
                var currentParentId = currentItem.parentId || null;

                // Verifica se este item Ã© o alvo
                if (String(currentItem.id) === String(targetId)) {
                    return { lista: lista, indice: i };
                }

                // Busca recursivamente nos filhos
                if (currentItem.items && currentItem.items.length > 0) {
                    var resultado = encontrarListaPaiEIndice(currentItem.items, targetId, targetParentId);
                    if (resultado) return resultado;
                }
            }
            return null;
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * FUNÃ‡Ã•ES DE MOVIMENTAÃ‡ÃƒO NA ÃRVORE
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * @@description FunÃ§Ãµes chamadas pelos botÃµes inline no TreeView
            * Permitem reordenar itens e mudar hierarquia sem drag - and - drop
                */

            /**
             * Move item para CIMA (ordenaÃ§Ã£o vertical)
             * @@param { string } itemId - ID do item a mover
            * @@param { Event } event - Evento de clique
                * @@returns { void}
                */
        function moverItemCima(itemId, event) {
            console.log('[MOVER-CIMA] === FUNÃ‡ÃƒO CHAMADA ===');
            console.log('[MOVER-CIMA] itemId recebido:', itemId, 'tipo:', typeof itemId);

            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            try {
                console.log('[MOVER-CIMA] treeData:', treeData);
                var item = buscarItemPorId(treeData, itemId);
                console.log('[MOVER-CIMA] Item encontrado:', item);
                if (!item) {
                    console.error('[MOVER-CIMA] Item nÃ£o encontrado:', itemId);
                    return;
                }

                // Encontra a lista que contÃ©m o item e seu Ã­ndice
                var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
                if (!resultado || resultado.indice <= 0) {
                    console.log('[MOVER-CIMA] Item jÃ¡ estÃ¡ na primeira posiÃ§Ã£o');
                    return;
                }

                var listaIrmaos = resultado.lista;
                var indexAtual = resultado.indice;

                // Troca posiÃ§Ã£o com o item anterior
                var temp = listaIrmaos[indexAtual];
                listaIrmaos[indexAtual] = listaIrmaos[indexAtual - 1];
                listaIrmaos[indexAtual - 1] = temp;

                console.log('[MOVER-CIMA] Item movido para cima:', item.text);

                // ForÃ§a reconstruÃ§Ã£o e atualiza TreeView
                atualizarTreeViewAposMovimento(itemId);

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemCima", erro);
            }
        }

            /**
             * Move item para BAIXO (ordenaÃ§Ã£o vertical)
             * @@param { string } itemId - ID do item a mover
            * @@param { Event } event - Evento de clique
                * @@returns { void}
                */
        function moverItemBaixo(itemId, event) {
            console.log('[MOVER-BAIXO] === FUNÃ‡ÃƒO CHAMADA ===');
            console.log('[MOVER-BAIXO] itemId recebido:', itemId, 'tipo:', typeof itemId);

            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            try {
                var item = buscarItemPorId(treeData, itemId);
                console.log('[MOVER-BAIXO] Item encontrado:', item);
                if (!item) {
                    console.error('[MOVER-BAIXO] Item nÃ£o encontrado:', itemId);
                    return;
                }

                // Encontra a lista que contÃ©m o item e seu Ã­ndice
                var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
                if (!resultado || resultado.indice >= resultado.lista.length - 1) {
                    console.log('[MOVER-BAIXO] Item jÃ¡ estÃ¡ na Ãºltima posiÃ§Ã£o');
                    return;
                }

                var listaIrmaos = resultado.lista;
                var indexAtual = resultado.indice;

                // Troca posiÃ§Ã£o com o item seguinte
                var temp = listaIrmaos[indexAtual];
                listaIrmaos[indexAtual] = listaIrmaos[indexAtual + 1];
                listaIrmaos[indexAtual + 1] = temp;

                console.log('[MOVER-BAIXO] Item movido para baixo:', item.text);

                // ForÃ§a reconstruÃ§Ã£o e atualiza TreeView
                atualizarTreeViewAposMovimento(itemId);

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemBaixo", erro);
            }
        }

            /**
             * Move item para ESQUERDA (sobe nÃ­vel - vira irmÃ£o do pai)
             * @@param { string } itemId - ID do item a mover
            * @@param { Event } event - Evento de clique
                * @@returns { void}
                */
        function moverItemEsquerda(itemId, event) {
            console.log('[MOVER-ESQ] === FUNÃ‡ÃƒO CHAMADA ===');
            console.log('[MOVER-ESQ] itemId recebido:', itemId, 'tipo:', typeof itemId);

            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            try {
                var item = buscarItemPorId(treeData, itemId);
                console.log('[MOVER-ESQ] Item encontrado:', item);
                if (!item) {
                    console.error('[MOVER-ESQ] Item nÃ£o encontrado:', itemId);
                    return;
                }

                // Se jÃ¡ estÃ¡ na raiz, nÃ£o pode subir mais
                if (!item.parentId) {
                    console.log('[MOVER-ESQ] Item jÃ¡ estÃ¡ na raiz');
                    return;
                }

                // Encontra o pai atual
                var paiAtual = buscarItemPorId(treeData, item.parentId);
                if (!paiAtual) {
                    console.error('[MOVER-ESQ] Pai nÃ£o encontrado:', item.parentId);
                    return;
                }

                console.log('[MOVER-ESQ] Movendo item para nÃ­vel do pai:', paiAtual.text);

                // Remove item da lista de filhos do pai atual
                if (paiAtual.items) {
                    var indexNoFilho = paiAtual.items.findIndex(function (i) { return i.id === item.id; });
                    if (indexNoFilho !== -1) {
                        paiAtual.items.splice(indexNoFilho, 1);
                    }
                }

                // Item agora tem o parentId do avÃ´ (ou null se pai era raiz)
                var novoParentId = paiAtual.parentId || null;
                item.parentId = novoParentId;

                // Se novo pai Ã© null (raiz), adiciona ao treeData
                if (!novoParentId) {
                    // Encontra posiÃ§Ã£o do pai antigo e insere depois dele
                    var indexPai = treeData.findIndex(function (i) { return i.id === paiAtual.id; });
                    if (indexPai !== -1) {
                        treeData.splice(indexPai + 1, 0, item);
                    } else {
                        treeData.push(item);
                    }
                } else {
                    // Adiciona na lista de filhos do avÃ´
                    var avo = buscarItemPorId(treeData, novoParentId);
                    if (avo) {
                        if (!avo.items) avo.items = [];
                        // Insere depois do pai antigo
                        var indexPaiNoAvo = avo.items.findIndex(function (i) { return i.id === paiAtual.id; });
                        if (indexPaiNoAvo !== -1) {
                            avo.items.splice(indexPaiNoAvo + 1, 0, item);
                        } else {
                            avo.items.push(item);
                        }
                    }
                }

                // Se pai ficou sem filhos, transforma em pÃ¡gina
                if (paiAtual.items && paiAtual.items.length === 0) {
                    console.log('[MOVER-ESQ] Pai ficou sem filhos, transformando em pÃ¡gina');
                    paiAtual.items = [];
                    // Marca para usuÃ¡rio escolher href depois
                }

                console.log('[MOVER-ESQ] Item movido para esquerda (subiu nÃ­vel)');

                // ForÃ§a reconstruÃ§Ã£o e atualiza TreeView
                atualizarTreeViewAposMovimento(itemId);

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemEsquerda", erro);
            }
        }

            /**
             * Move item para DIREITA (desce nÃ­vel - vira filho do item acima)
             * @@description Se o item acima for PÃ¡gina, avisa que serÃ¡ transformado em Grupo
            * @@param { string } itemId - ID do item a mover
                * @@param { Event } event - Evento de clique
                    * @@returns { void}
                    */
        function moverItemDireita(itemId, event) {
            console.log('[MOVER-DIR] === FUNÃ‡ÃƒO CHAMADA ===');
            console.log('[MOVER-DIR] itemId recebido:', itemId, 'tipo:', typeof itemId);

            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            try {
                var item = buscarItemPorId(treeData, itemId);
                console.log('[MOVER-DIR] Item encontrado:', item);
                if (!item) {
                    console.error('[MOVER-DIR] Item nÃ£o encontrado:', itemId);
                    return;
                }

                // Encontra a lista que contÃ©m o item
                var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
                if (!resultado || resultado.indice <= 0) {
                    console.log('[MOVER-DIR] NÃ£o hÃ¡ item acima para virar pai');
                    return;
                }

                var listaIrmaos = resultado.lista;
                var indexAtual = resultado.indice;
                var itemAcima = listaIrmaos[indexAtual - 1];

                console.log('[MOVER-DIR] Item acima que virarÃ¡ pai:', itemAcima.text);

                // âœ… VERIFICAÃ‡ÃƒO: Se o item acima Ã© uma PÃ¡gina (tem href vÃ¡lido), avisar que serÃ¡ transformado em Grupo
                var itemAcimaEhPagina = itemAcima.href && itemAcima.href !== 'javascript:void(0);' && itemAcima.href.trim() !== '';

                if (itemAcimaEhPagina) {
                    // Exibir aviso de que a pÃ¡gina acima serÃ¡ transformada em Grupo
                    console.log('[MOVER-DIR] Item acima Ã© uma PÃ¡gina - exibindo aviso de transformaÃ§Ã£o');

                    Alerta.Confirmar(
                        'TransformaÃ§Ã£o em Grupo',
                        '<div style="text-align: left; padding: 10px;">' +
                        '<p style="margin-bottom: 15px;">Ao subordinar <strong>"' + item.text + '"</strong> como filho de <strong>"' + itemAcima.text + '"</strong>, ' +
                        'a pÃ¡gina <strong>"' + itemAcima.text + '"</strong> serÃ¡ <span style="color: #d9534f; font-weight: bold;">transformada em GRUPO</span>.</p>' +
                        '<div style="background: linear-gradient(135deg, #ff6b35, #e55a2b); color: white; padding: 12px 15px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.5); margin: 10px 0;">' +
                        '<i class="fa-duotone fa-triangle-exclamation" style="--fa-primary-color:#ffffff; --fa-secondary-color:#ffcc00; margin-right: 8px;"></i>' +
                        '<strong>ATENÃ‡ÃƒO:</strong> O link HTML da pÃ¡gina serÃ¡ removido permanentemente e ela nÃ£o acessarÃ¡ mais nenhuma funcionalidade diretamente!' +
                        '</div>' +
                        '<p style="margin-top: 15px;">Deseja prosseguir com esta operaÃ§Ã£o?</p>' +
                        '</div>',
                        '<i class="fa-duotone fa-check" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right: 6px;"></i>Sim, Transformar em Grupo',
                        '<i class="fa-duotone fa-xmark" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right: 6px;"></i>Cancelar'
                    ).then(function (confirmado) {
                        if (confirmado) {
                            console.log('[MOVER-DIR] UsuÃ¡rio confirmou transformaÃ§Ã£o - executando movimentaÃ§Ã£o');
                            executarMovimentacaoDireita(item, listaIrmaos, indexAtual, itemAcima, itemId);
                        } else {
                            console.log('[MOVER-DIR] UsuÃ¡rio cancelou - operaÃ§Ã£o revertida');
                            Alerta.Info('OperaÃ§Ã£o Cancelada', 'A movimentaÃ§Ã£o foi cancelada. Nenhuma alteraÃ§Ã£o foi feita.', 'OK');
                        }
                    });
                } else {
                    // Item acima jÃ¡ Ã© grupo, executa diretamente sem aviso
                    console.log('[MOVER-DIR] Item acima jÃ¡ Ã© Grupo - executando movimentaÃ§Ã£o direta');
                    executarMovimentacaoDireita(item, listaIrmaos, indexAtual, itemAcima, itemId);
                }

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemDireita", erro);
            }
        }

            /**
             * Executa movimentaÃ§Ã£o para direita apÃ³s confirmaÃ§Ã£o
             * @@description FunÃ§Ã£o auxiliar para moverItemDireita
            * @@param { Object } item - O item sendo movido
                * @@param { Array } listaIrmaos - Lista de irmÃ£os onde o item estÃ¡
                    * @@param { number } indexAtual - Ãndice atual do item na lista
                        * @@param { Object } itemAcima - O item que serÃ¡ o novo pai
                            * @@param { string } itemId - ID do item para manter selecionado
                                * @@returns { void}
                                */
        function executarMovimentacaoDireita(item, listaIrmaos, indexAtual, itemAcima, itemId) {
            try {
                // Remove item da lista atual
                listaIrmaos.splice(indexAtual, 1);

                // Define novo parentId
                item.parentId = itemAcima.id;

                // Adiciona item como filho do item acima
                if (!itemAcima.items) {
                    itemAcima.items = [];
                }
                itemAcima.items.push(item);

                // Item acima agora Ã© grupo (se nÃ£o tinha href, continua sem)
                if (!itemAcima.href || itemAcima.href === 'javascript:void(0);') {
                    // JÃ¡ era grupo, mantÃ©m
                } else {
                    // Era pÃ¡gina, vira grupo - limpa href
                    console.log('[MOVER-DIR] Item acima transformado em grupo');
                    itemAcima.href = 'javascript:void(0);';
                }

                console.log('[MOVER-DIR] Item movido para direita (desceu nÃ­vel, virou filho de ' + itemAcima.text + ')');

                // ForÃ§a reconstruÃ§Ã£o e atualiza TreeView
                atualizarTreeViewAposMovimento(itemId);

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarMovimentacaoDireita", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * ATUALIZAÃ‡ÃƒO DO TREEVIEW
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Atualiza TreeView apÃ³s movimentos de itens
             * @@description ReconstrÃ³i a Ã¡rvore e reconfigura event listeners
            * @@param { string| null} itemIdParaManter - ID do item a manter selecionado
                * @@param { boolean }[marcarPendentes = true] - Se deve marcar alteraÃ§Ãµes pendentes
                    * @@returns { void}
                    */
        function atualizarTreeViewAposMovimento(itemIdParaManter, marcarPendentes) {
            try {
                // Se marcarPendentes nÃ£o for informado, assume true (comportamento padrÃ£o)
                if (marcarPendentes === undefined) marcarPendentes = true;

                console.log('[ATUALIZAR] Atualizando TreeView apÃ³s movimento... marcarPendentes=' + marcarPendentes);

                // ForÃ§a reconstruÃ§Ã£o completa
                treeData = JSON.parse(JSON.stringify(treeData));

                // Atualiza TreeView
                if (treeObj) {
                    treeObj.fields.dataSource = treeData;
                    treeObj.dataBind();
                    treeObj.refresh();
                    treeObj.expandAll();
                }

                // Reconfigura event listeners (necessÃ¡rio apÃ³s refresh)
                configurarBotoesNavegacao();

                // Repopula dropdowns
                popularDropdownItemPai();
                popularDropdownPosicao();

                // MantÃ©m seleÃ§Ã£o no item movido (se itemIdParaManter for informado)
                if (itemIdParaManter) {
                    var itemAtualizado = buscarItemPorId(treeData, itemIdParaManter);
                    if (itemAtualizado) {
                        selectedItem = itemAtualizado;
                        // NÃƒO chama selecionarItem aqui para evitar recarregar dados antigos
                    }
                } else {
                    // Se itemIdParaManter for null/undefined/false, limpa a seleÃ§Ã£o
                    selectedItem = null;
                    if (treeObj) {
                        treeObj.selectedNodes = [];
                    }
                }

                // Marca alteraÃ§Ãµes pendentes apenas se solicitado
                if (marcarPendentes) {
                    marcarAlteracoesPendentes();
                    console.log('[ATUALIZAR] TreeView atualizado (alteraÃ§Ãµes pendentes)');
                } else {
                    console.log('[ATUALIZAR] TreeView atualizado (sem marcar pendentes - jÃ¡ salvo no banco)');
                }

            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarTreeViewAposMovimento", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * FUNÃ‡Ã•ES DE COMPATIBILIDADE (deprecated)
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * @@description FunÃ§Ãµes antigas mantidas para compatibilidade
            * Prefira usar as funÃ§Ãµes inline: moverItemCima, moverItemBaixo, etc.
             */

            /**
             * Move item selecionado para cima (deprecated - use moverItemCima)
             * @@returns { void}
             */
        function moverItemParaCima() {
            try {
                if (!selectedItem || !selectedItem.id) {
                    mostrarAlerta('Selecione um item primeiro', 'warning');
                    return;
                }

                var item = buscarItemPorId(treeData, selectedItem.id);
                if (!item) {
                    mostrarAlerta('Item nÃ£o encontrado na Ã¡rvore', 'danger');
                    return;
                }

                // Encontra a lista que contÃ©m o item e seu Ã­ndice
                var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
                if (!resultado || resultado.indice <= 0) {
                    mostrarAlerta('Item jÃ¡ estÃ¡ na primeira posiÃ§Ã£o', 'info');
                    return;
                }

                var listaIrmaos = resultado.lista;
                var indexAtual = resultado.indice;

                // âœ… Troca posiÃ§Ã£o com o item anterior (modifica referÃªncia original)
                var temp = listaIrmaos[indexAtual];
                listaIrmaos[indexAtual] = listaIrmaos[indexAtual - 1];
                listaIrmaos[indexAtual - 1] = temp;

                console.log('[MOVER-CIMA] âœ… PosiÃ§Ãµes trocadas na lista original');
                console.log('[MOVER-CIMA] Lista apÃ³s troca:', listaIrmaos.map(function (i) { return i.text; }));

                // âœ… Recria treeData para forÃ§ar atualizaÃ§Ã£o do TreeView
                var treeDataNovo = JSON.parse(JSON.stringify(treeData));
                treeData = treeDataNovo;

                // âœ… Atualiza TreeView com nova estrutura
                treeObj.fields.dataSource = treeData;
                treeObj.dataBind();

                console.log('[MOVER-CIMA] âœ… TreeView atualizado');

                // Seleciona o item novamente apÃ³s mover
                setTimeout(function () {
                    var itemAtualizado = buscarItemPorId(treeData, item.id);
                    if (itemAtualizado) {
                        selecionarItem(itemAtualizado);
                    }
                    salvarOrdenacaoAutomatica();
                }, 300);

            } catch (erro) {
                console.error('[moverItemParaCima] Erro:', erro);
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemParaCima", erro);
            }
        }

            /**
             * Move item selecionado para baixo (deprecated - use moverItemBaixo)
             * @@returns { void}
             */
        function moverItemParaBaixo() {
            try {
                if (!selectedItem || !selectedItem.id) {
                    mostrarAlerta('Selecione um item primeiro', 'warning');
                    return;
                }

                var item = buscarItemPorId(treeData, selectedItem.id);
                if (!item) {
                    mostrarAlerta('Item nÃ£o encontrado na Ã¡rvore', 'danger');
                    return;
                }

                // Encontra a lista que contÃ©m o item e seu Ã­ndice
                var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
                if (!resultado || resultado.indice >= resultado.lista.length - 1) {
                    mostrarAlerta('Item jÃ¡ estÃ¡ na Ãºltima posiÃ§Ã£o', 'info');
                    return;
                }

                var listaIrmaos = resultado.lista;
                var indexAtual = resultado.indice;

                console.log('[MOVER-BAIXO] Lista encontrada:', listaIrmaos.length, 'itens');
                console.log('[MOVER-BAIXO] Ãndice atual:', indexAtual);
                console.log('[MOVER-BAIXO] Item atual:', item.text);
                console.log('[MOVER-BAIXO] Item seguinte:', listaIrmaos[indexAtual + 1].text);

                // Troca posiÃ§Ã£o com o item seguinte (move grupo inteiro se for grupo)
                var temp = listaIrmaos[indexAtual];
                listaIrmaos[indexAtual] = listaIrmaos[indexAtual + 1];
                listaIrmaos[indexAtual + 1] = temp;

                console.log('[MOVER-BAIXO] âœ… PosiÃ§Ãµes trocadas na lista');

                // âœ… Recria treeData completamente para forÃ§ar atualizaÃ§Ã£o do TreeView
                var treeDataNovo = JSON.parse(JSON.stringify(treeData));
                treeData = treeDataNovo;

                // Atualiza TreeView com nova estrutura
                treeObj.fields.dataSource = treeData;
                treeObj.dataBind();

                console.log('[MOVER-BAIXO] âœ… TreeView atualizado');

                // Seleciona o item novamente apÃ³s mover
                setTimeout(function () {
                    var itemAtualizado = buscarItemPorId(treeData, item.id);
                    if (itemAtualizado) {
                        selecionarItem(itemAtualizado);
                    }
                    salvarOrdenacaoAutomatica();
                }, 300);

            } catch (erro) {
                console.error('[moverItemParaBaixo] Erro:', erro);
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemParaBaixo", erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * LIMPEZA DE FORMULÃRIO
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Limpa todos os campos do formulÃ¡rio de propriedades
             * @@param { boolean } [esconderCard = true] - Se deve esconder o card de propriedades
            * @@returns { void}
            */
        function limparFormulario(esconderCard = true) {
            try {
                selectedItem = null;

                // âœ… Reseta variÃ¡veis de rastreamento
                ultimoIconeSelecionado = null;
                ultimaPaginaSelecionada = null;

                document.getElementById('formPropriedades').reset();
                document.getElementById('recursoId').value = '';
                document.getElementById('parentId').value = '';
                document.getElementById('txtIconClass').value = '';
                document.getElementById('selectedItemName').textContent = 'Nenhum item selecionado';

                // Limpa DropDownTree de Ã­cones
                var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                if (ddlIconeObj) {
                    ddlIconeObj.value = [];
                    ddlIconeObj.text = '';
                    ddlIconeObj.refresh();
                }

                // Limpa DropDownTree de pÃ¡ginas
                var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                if (ddlPaginaObj) {
                    ddlPaginaObj.value = null;
                }

                // âœ… Limpa campo oculto parentId (dropdown foi removido)
                document.getElementById('parentId').value = '';

                document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
                document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));

                // Reseta indicador de modo
                document.getElementById('modoEdicao').textContent = 'Selecione';
                document.getElementById('modoEdicao').className = 'badge bg-secondary ms-2';

                // âœ… Atualiza estado dos botÃµes de ordenaÃ§Ã£o
                atualizarEstadoBotoesOrdenacao();

                // Esconde card apenas se solicitado
                if (esconderCard) {
                    document.getElementById('propsCard').style.display = 'none';
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "limparFormulario", erro);
            }
        }

            /*
            // âŒ DEPRECATED: Salvamento agora Ã© automÃ¡tico - funÃ§Ã£o mantida apenas como backup
            function salvarOrdenacao() {
                try {
                    if (!treeObj) return;
                    var dataSource = treeObj.getTreeData();
                    var items = extrairItensDoTreeView(dataSource, null, 0);
                    fetch('/api/Navigation/SaveTreeToDb', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(items)
                    })
                    .then(r => r.json())
                    .then(result => {
                        if (result.success) {
                            mostrarAlerta('OrdenaÃ§Ã£o salva com sucesso!', 'success');
                            carregarArvore();
                            atualizarNavegacaoLateral();
                        } else {
                            mostrarAlerta('Erro: ' + result.message, 'danger');
                        }
                    })
                    .catch(erro => {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacao", erro);
                    });
                } catch (erro) {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacao", erro);
                }
            }
            */

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * SALVAMENTO AUTOMÃTICO (AUTO-SAVE)
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Salva ordenaÃ§Ã£o automaticamente apÃ³s drag-drop ou transformaÃ§Ã£o
             * @@description Envia estrutura completa para API e atualiza navegaÃ§Ã£o
            * @@returns { void}
            */
        function salvarOrdenacaoAutomatica() {
            try {
                if (!treeObj && !treeData) {
                    console.error('[AUTO-SAVE] Nem treeObj nem treeData existem!');
                    return;
                }

                // Usa treeData diretamente (mais confiÃ¡vel apÃ³s modificaÃ§Ãµes manuais)
                var dataSource = treeData || treeObj.getTreeData();
                console.log('[AUTO-SAVE] DataSource obtido (treeData):', dataSource);

                var items = extrairItensDoTreeView(dataSource, null, 0);
                console.log('[AUTO-SAVE] Items extraÃ­dos para salvar:', items);
                console.log('[AUTO-SAVE] Total de items:', items.length);

                if (items.length === 0) {
                    console.warn('[AUTO-SAVE] Nenhum item para salvar!');
                    return;
                }

                console.log('[AUTO-SAVE] Enviando para backend...');

                var jsonPayload = JSON.stringify(items);
                console.log('[AUTO-SAVE] JSON Payload (primeiros 500 chars):', jsonPayload.substring(0, 500));

                fetch('/api/Navigation/SaveTreeToDb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: jsonPayload
                })
                    .then(r => {
                        console.log('[AUTO-SAVE] Response status:', r.status);
                        return r.json().then(data => ({ ok: r.ok, status: r.status, data: data }));
                    })
                    .then(response => {
                        console.log('[AUTO-SAVE] Response do backend:', response.data);

                        if (!response.ok) {
                            console.error('[AUTO-SAVE] HTTP Error:', response.status);

                            if (response.data.errors) {
                                console.error('[AUTO-SAVE] Erros de ValidaÃ§Ã£o:', JSON.stringify(response.data.errors, null, 2));
                                var erroMsg = 'Erro de validaÃ§Ã£o: ';
                                for (var campo in response.data.errors) {
                                    erroMsg += campo + ': ' + response.data.errors[campo].join(', ') + '; ';
                                }
                                mostrarAlerta(erroMsg, 'danger');
                            } else {
                                mostrarAlerta('Erro HTTP ' + response.status + ': ' + (response.data.message || response.data.title || 'Erro desconhecido'), 'danger');
                            }
                            return;
                        }

                        if (response.data.success) {
                            console.log('[AUTO-SAVE] OrdenaÃ§Ã£o salva automaticamente!');
                            // Toast discreto ao invÃ©s de alerta grande
                            var msg = 'OrdenaÃ§Ã£o salva automaticamente';
                            if (lastDragInfo && lastDragInfo.itemName) {
                                msg = "Item '" + lastDragInfo.itemName + "' movido de '" +
                                    (lastDragInfo.fromParentName || 'Sem grupo') + "' para '" +
                                    (lastDragInfo.toParentName || 'Sem grupo') + "'";
                            }
                            mostrarToastSucesso(msg);

                            // Recarrega Ã¡rvore com dados atualizados do banco
                            carregarArvore();

                            // Atualiza menu lateral
                            atualizarNavegacaoLateral();
                        } else {
                            console.error('[AUTO-SAVE] Erro no backend:', response.data.message);
                            mostrarAlerta('Erro ao salvar ordenaÃ§Ã£o: ' + response.data.message, 'danger');
                        }
                    })
                    .catch(erro => {
                        console.error('[AUTO-SAVE] Erro no fetch:', erro);
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacaoAutomatica", erro);
                    });
            } catch (erro) {
                console.error('[AUTO-SAVE] Erro no try-catch:', erro);
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacaoAutomatica", erro);
            }
        }

            /**
             * VersÃ£o do auto-save que retorna Promise e nÃ£o faz reload
             * @@description Usada para transformaÃ§Ãµes onde reload Ã© controlado externamente
            * @@returns { Promise } Promise que resolve com dados do backend
                */
            function salvarOrdenacaoAutomaticaSemReload() {
                return new Promise(function (resolve, reject) {
                    try {
                        if (!treeObj && !treeData) {
                            console.error('[AUTO-SAVE-SR] Nem treeObj nem treeData existem!');
                            reject(new Error('Dados da Ã¡rvore nÃ£o disponÃ­veis'));
                            return;
                        }

                        // Usa treeData diretamente (mais confiÃ¡vel apÃ³s modificaÃ§Ãµes manuais)
                        var dataSource = treeData || treeObj.getTreeData();
                        console.log('[AUTO-SAVE-SR] DataSource obtido (treeData):', dataSource);

                        var items = extrairItensDoTreeView(dataSource, null, 0);
                        console.log('[AUTO-SAVE-SR] Items extraÃ­dos para salvar:', items.length);

                        if (items.length === 0) {
                            console.warn('[AUTO-SAVE-SR] Nenhum item para salvar!');
                            reject(new Error('Nenhum item para salvar'));
                            return;
                        }

                        console.log('[AUTO-SAVE-SR] Enviando para backend...');

                        fetch('/api/Navigation/SaveTreeToDb', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(items)
                        })
                            .then(function (r) {
                                console.log('[AUTO-SAVE-SR] Response status:', r.status);
                                return r.json().then(function (data) {
                                    return { ok: r.ok, status: r.status, data: data };
                                });
                            })
                            .then(function (response) {
                                console.log('[AUTO-SAVE-SR] Response do backend:', response.data);

                                if (!response.ok) {
                                    console.error('[AUTO-SAVE-SR] HTTP Error:', response.status);
                                    reject(new Error(response.data.message || 'Erro HTTP ' + response.status));
                                    return;
                                }

                                if (response.data.success) {
                                    console.log('[AUTO-SAVE-SR] OrdenaÃ§Ã£o salva com sucesso (sem reload)!');
                                    resolve(response.data);
                                } else {
                                    console.error('[AUTO-SAVE-SR] Erro no backend:', response.data.message);
                                    reject(new Error(response.data.message));
                                }
                            })
                            .catch(function (erro) {
                                console.error('[AUTO-SAVE-SR] Erro no fetch:', erro);
                                reject(erro);
                            });
                    } catch (erro) {
                        console.error('[AUTO-SAVE-SR] Erro no try-catch:', erro);
                        reject(erro);
                    }
                });
            }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * ATUALIZAÃ‡ÃƒO DA NAVEGAÃ‡ÃƒO
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Atualiza a navegaÃ§Ã£o lateral (menu do sistema)
             * @@description Recarrega a pÃ¡gina para refletir mudanÃ§as no menu
            * @@returns { void}
            */
        function atualizarNavegacaoLateral() {
            try {
                console.log('[NAV-UPDATE] Atualizando navegaÃ§Ã£o lateral...');

                // Recarrega a pÃ¡gina inteira apÃ³s 1 segundo
                // Garante que o menu lateral seja atualizado com dados do banco
                setTimeout(function () {
                    console.log('[NAV-UPDATE] Recarregando pÃ¡gina para atualizar navegaÃ§Ã£o...');
                    window.location.reload();
                }, 1000);
            } catch (erro) {
                console.error('[NAV-UPDATE] Erro:', erro);
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * FUNÃ‡Ã•ES AUXILIARES
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Mostra toast discreto de sucesso para auto-save
             * @@param { string } mensagem - Mensagem a exibir
            * @@returns { void}
            */
        function mostrarToastSucesso(mensagem) {
            try {
                if (window.AppToast && typeof window.AppToast.show === 'function') {
                    // Converte entidades HTML para texto visÃ­vel no toast
                    var msgDecodificada = decodeHtml(mensagem);
                    window.AppToast.show('Verde', msgDecodificada, 4000);
                } else if (typeof showSyncfusionToast === 'function') {
                    showSyncfusionToast(decodeHtml(mensagem), 'success', 'âœ…');
                } else if (typeof Alerta !== 'undefined' && Alerta.Toast) {
                    Alerta.Toast('success', decodeHtml(mensagem));
                } else {
                    console.log('[TOAST]', mensagem);
                }
            } catch (erro) {
                console.log('[TOAST]', mensagem);
            }
        }

            /**
             * Extrai itens do TreeView para formato de salvamento
             * @@param { Array } items - Lista de itens da Ã¡rvore
            * @@param { string| null} parentId - ID do pai(null para raiz)
                * @@param { number } nivel - NÃ­vel hierÃ¡rquico atual
                    * @@returns { Array } Lista de itens formatados para API
                        */
        function extrairItensDoTreeView(items, parentId, nivel) {
            try {
                if (!items) return [];

                var result = [];

                items.forEach(function (item, index) {
                    var newItem = {
                        id: item.id,
                        text: item.text,
                        nomeMenu: item.nomeMenu,
                        icon: item.icon,
                        href: item.href,
                        parentId: parentId,
                        ordem: (nivel * 100) + index + 1,
                        nivel: nivel,
                        ativo: item.ativo !== false,
                        descricao: item.descricao,
                        items: []
                    };

                    if (item.items && item.items.length > 0) {
                        newItem.items = extrairItensDoTreeView(item.items, item.id, nivel + 1);
                    }

                    result.push(newItem);
                });

                return result;
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "extrairItensDoTreeView", erro);
                return [];
            }
        }

            /**
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             * CONTAGEM DE ITENS
             * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */

            /**
             * Atualiza contador de itens na interface
             * @@returns { void}
             */
        function atualizarContagem() {
            try {
                var total = contarItens(treeData);
                document.getElementById('itemCount').textContent = total + ' itens';
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarContagem", erro);
            }
        }

            /**
             * Conta itens recursivamente na Ã¡rvore
             * @@param { Array } items - Lista de itens
            * @@returns { number } Total de itens
                */
        function contarItens(items) {
            try {
                if (!items) return 0;
                var count = items.length;
                items.forEach(function (item) {
                    if (item.items && item.items.length > 0) {
                        count += contarItens(item.items);
                    }
                });
                return count;
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "contarItens", erro);
                return 0;
            }
        }

        // Migra dados do JSON
        function migrarDadosJson() {
            try {
                Alerta.Confirmar(
                    'Confirmar MigraÃ§Ã£o',
                    'Isso irÃ¡ migrar os dados do nav.json para o banco de dados. Continuar?',
                    'Migrar',
                    'Cancelar'
                ).then(function (result) {
                    if (!result) return;

                    mostrarAlerta('Migrando dados...', 'info');

                    fetch('/api/Navigation/MigrateFromJson', {
                        method: 'POST'
                    })
                        .then(r => r.json())
                        .then(result => {
                            if (result.success) {
                                mostrarAlerta(result.message, 'success');
                                carregarArvore();
                            } else {
                                mostrarAlerta('Erro: ' + result.message, 'danger');
                            }
                        })
                        .catch(erro => {
                            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "migrarDadosJson", erro);
                        });
                });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "migrarDadosJson", erro);
            }
        }

        // Seleciona todos os acessos
        function selecionarTodosAcessos() {
            try {
                document.querySelectorAll('#listaAcessos input[type="checkbox"]').forEach(function (cb) {
                    if (!cb.checked) {
                        cb.checked = true;
                        cb.dispatchEvent(new Event('change'));
                    }
                });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "selecionarTodosAcessos", erro);
            }
        }

        // Verifica se hÃ¡ mudanÃ§as nÃ£o salvas no formulÃ¡rio
        function verificarMudancasNaoSalvas() {
            try {
                if (!selectedItem) return false;

                // Pega valores atuais do formulÃ¡rio
                var txtNome = document.getElementById('txtNome').value;
                var txtNomeMenu = document.getElementById('txtNomeMenu').value;
                var txtHref = document.getElementById('txtHref').value;
                var txtIconClass = document.getElementById('txtIconClass').value;
                var txtOrdem = parseFloat(document.getElementById('txtOrdem').value) || 0;
                var txtDescricao = document.getElementById('txtDescricao').value;
                var chkAtivo = document.getElementById('chkAtivo').checked;
                var parentId = document.getElementById('parentId').value;

                // Compara com valores originais do selectedItem (decodificados)
                var nomeOriginal = decodeHtml(selectedItem.text) || '';
                var nomeMenuOriginal = decodeHtml(selectedItem.nomeMenu) || '';
                var hrefOriginal = selectedItem.href || '';
                var iconOriginal = selectedItem.icon || '';
                var ordemOriginal = selectedItem.ordem || 0;
                var descricaoOriginal = decodeHtml(selectedItem.descricao) || '';
                var ativoOriginal = selectedItem.ativo !== false;
                var parentIdOriginal = selectedItem.parentId || '';

                // Retorna true se houver alguma diferenÃ§a
                return txtNome !== nomeOriginal ||
                    txtNomeMenu !== nomeMenuOriginal ||
                    txtHref !== hrefOriginal ||
                    txtIconClass !== iconOriginal ||
                    txtOrdem !== ordemOriginal ||
                    txtDescricao !== descricaoOriginal ||
                    chkAtivo !== ativoOriginal ||
                    parentId !== parentIdOriginal;
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "verificarMudancasNaoSalvas", erro);
                return false;
            }
        }

        // Fecha ambos os cards (Propriedades e Controle de Acesso)
        function fecharCards() {
            try {
                // Verifica se estÃ¡ em modo ediÃ§Ã£o (tem selectedItem com ID)
                var emModoEdicao = selectedItem && selectedItem.id;

                // Se estiver em modo ediÃ§Ã£o e houver mudanÃ§as nÃ£o salvas
                if (emModoEdicao && verificarMudancasNaoSalvas()) {
                    Alerta.Confirmar(
                        'MudanÃ§as NÃ£o Salvas',
                        'VocÃª tem mudanÃ§as nÃ£o salvas. Deseja salvar antes de fechar?',
                        'Salvar',
                        'Descartar'
                    ).then(function (result) {
                        if (result) {
                            // UsuÃ¡rio escolheu SALVAR
                            salvarPropriedades();
                            // NÃ£o fecha os cards aqui, salvarPropriedades jÃ¡ gerencia isso
                        } else {
                            // UsuÃ¡rio escolheu DESCARTAR - fecha os cards
                            document.getElementById('propsCard').style.display = 'none';
                            document.getElementById('acessoCard').style.display = 'none';
                            habilitarCardPropriedades(true);
                            limparFormulario(true);
                        }
                    });
                    return;
                }

                // Fecha os cards normalmente
                document.getElementById('propsCard').style.display = 'none';
                document.getElementById('acessoCard').style.display = 'none';
                habilitarCardPropriedades(true);
                limparFormulario(true);
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "fecharCards", erro);
            }
        }

        // Habilita ou desabilita todos os campos do Card de Propriedades
        function habilitarCardPropriedades(habilitar) {
            try {
                var campos = document.querySelectorAll('#formPropriedades input, #formPropriedades textarea, #formPropriedades select, #formPropriedades button');
                campos.forEach(function (campo) {
                    if (habilitar) {
                        campo.removeAttribute('disabled');
                        campo.style.opacity = '1';
                        campo.style.cursor = 'auto';
                    } else {
                        campo.setAttribute('disabled', 'disabled');
                        campo.style.opacity = '0.6';
                        campo.style.cursor = 'not-allowed';
                    }
                });

                // MantÃ©m o botÃ£o Salvar Propriedades desabilitado quando estÃ¡ no modo de controle de acesso
                var btnSalvar = document.querySelector('#formPropriedades button[onclick*="salvarPropriedades"]');
                if (btnSalvar && !habilitar) {
                    btnSalvar.setAttribute('disabled', 'disabled');
                }
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarCardPropriedades", erro);
            }
        }

        // Habilita acesso para todos os usuÃ¡rios (chamado ao criar novo item)
        function habilitarAcessoTodosUsuarios(recursoId) {
            try {
                fetch('/api/Navigation/HabilitarAcessoTodosUsuarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recursoId: recursoId })
                })
                    .then(r => r.json())
                    .then(result => {
                        if (result.success) {
                            console.log('Acessos habilitados para todos os usuÃ¡rios');
                            carregarControleAcesso(recursoId);
                        } else {
                            console.error('Erro ao habilitar acessos:', result.message);
                        }
                    })
                    .catch(erro => {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarAcessoTodosUsuarios", erro);
                    });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarAcessoTodosUsuarios", erro);
            }
        }

        // Mostra alerta toast
        // FunÃ§Ã£o wrapper para mostrar alertas usando SweetAlert
        function mostrarAlerta(mensagem, tipo) {
            try {
                // Mapeia tipos Bootstrap para funÃ§Ãµes SweetAlert
                switch (tipo) {
                    case 'success':
                        return Alerta.Sucesso('Sucesso', mensagem);
                    case 'danger':
                    case 'error':
                        return Alerta.Erro('Erro', mensagem);
                    case 'warning':
                        return Alerta.Warning('AtenÃ§Ã£o', mensagem);
                    case 'info':
                        return Alerta.Info('InformaÃ§Ã£o', mensagem);
                    default:
                        return Alerta.Info('Aviso', mensagem);
                }
            } catch (erro) {
                // Fallback para console se SweetAlert falhar
                console.error('[mostrarAlerta] Erro ao exibir alerta:', erro);
                console.log(`[${tipo}] ${mensagem}`);
            }
        }
    </script>
}