<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Stored Procedures | FrotiX</title>
  <style>
    :root {
      --vinho: #722F37; --vinho-light: #8B3A44;
      --azul: #325d88; --azul-light: #3d6f9e;
      --terracota: #A97B6E; --terracota-light: #C08B7E;
      --verde: #557570; --verde-light: #6A8A85;
      --cinza: #f5f7fb; --card: #ffffff; --texto: #1f1f1f;
      --shadow: 0 20px 45px -18px rgba(0,0,0,.35);
      --radius: 14px; --header-bg: #b66a3d; --code-bg: #33465c;
    }
    @page { size: A4; margin: 16mm; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: "Segoe UI","Inter",system-ui,-apple-system,sans-serif;
      background: radial-gradient(circle at 12% 20%, rgba(50,93,136,.08), transparent 26%), radial-gradient(circle at 90% 10%, rgba(114,47,55,.10), transparent 30%), var(--cinza);
      color: var(--texto); padding: 22px; display: flex; justify-content: center;
    }
    .page { width: 210mm; max-width: 100%; }
    .hero {
      background: var(--header-bg); color: #fff; padding: 22px 24px;
      border-radius: var(--radius); box-shadow: 0 0 0 1px #000, 0 0 0 4px #fff, var(--shadow);
      display: flex; align-items: center; gap: 16px;
    }
     .hero .icon { width: 50px; height: 50px; filter: drop-shadow(0 6px 8px rgba(0,0,0,.25)); }
    h1 { margin: 0; font-size: 26px; letter-spacing: 0.2px; }
    .subtitle { margin: 6px 0 0; font-size: 13px; opacity: 0.92; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-top: 18px; }
    .card {
      background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 16px 18px; border: 1px solid rgba(0,0,0,0.05);
    }
    .section-title { display: flex; align-items: center; gap: 10px; margin: 0 0 10px; font-size: 15px; font-weight: 800; color: var(--vinho); }
    .icon { width: 18px; height: 18px; vertical-align: middle; filter: drop-shadow(0 2px 4px rgba(0,0,0,.15)); }
    .table-like { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table-like th, .table-like td { text-align: left; padding: 6px 8px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; font-weight: 600; background: rgba(169,123,110,.12); color: var(--terracota); margin-right: 8px; font-size: 12px; }
    code {
      background: var(--code-bg); color: #e9edf5; padding: 10px 12px;
      border-radius: 10px; display: block; white-space: pre-wrap; font-size: 12px; line-height: 1.45;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }
  </style>
</head>

  
  <body>
  <svg style="display:none" aria-hidden="true" focusable="false">
  
</svg>
  <div class="page">
    <header class="hero">
      <svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-database"></use></svg>
      <div>
        <h1>Stored Procedures - Öndice</h1>
        <p class="subtitle">VisÆo geral das SPs do FrotiX ú éltima atualiza‡Æo: 08/01/2026 ú VersÆo 1.0</p>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="section-title">
          <svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-info"></use></svg>
          VisÆo geral
        </div>
        <p>As SPs estÆo organizadas por funcionalidade e detalhadas em arquivos individuais em <code>Documentacao/Banco de Dados/Stored Procedures/</code>. Este ¡ndice traz um quadro-resumo de execu‡Æo e dependˆncias.</p>
        <div class="pill"><svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-folder-tree"></use></svg>Arquivos dedicados por SP</div>
        <div class="pill"><svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-arrows-rotate"></use></svg>Usar jobs/execu‡äes on-demand</div>
      </section>

      <section class="card">
        <div class="section-title">
          <svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-link"></use></svg>
          Quem usa e para qu
        </div>
        <ul>
          <li><strong>Controllers</strong>: dashboards/custos (<code>DashboardViagensController</code>, <code>DashboardVeiculosController</code>, <code>DashboardMotoristasController</code>, <code>CustosViagemController</code>, <code>AbastecimentoController</code>) consomem estat¡sticas e custos calculados por estas SPs.</li>
          <li><strong>Razor Pages</strong>: p ginas <code>Pages/Viagens/Dashboard*.cshtml</code>, <code>Pages/Veiculo/Dashboard*.cshtml</code>, <code>Pages/Administracao/*.cshtml</code> exibem dados alimentados pelos resultados dessas procedures.</li>
          <li><strong>JavaScript</strong>: scripts de gr ficos/heatmaps (Economildo, rankings de viagens/abastecimento) chamam endpoints que dependem das execu‡äes destas SPs.</li>
          <li><strong>Jobs SQL Agent</strong>: <code>JobAtualizacaoViagens</code> e jobs de estat¡stica di rios/mensais executam-nas em sequˆncia para manter snapshots e rankings atualizados.</li>
        </ul>
      </section>

      <section class="card">
        <div class="section-title">
          <svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-table"></use></svg>
          Quadro-resumo (execu‡Æo e dependˆncias)
        </div>
        <table class="table-like">
          <thead><tr><th>SP</th><th>Acionamento</th><th>Gera/Alimenta</th></tr></thead>
          <tbody>
            <tr><td>sp_JobAtualizacaoViagens</td><td>Job orquestrador di rio</td><td>Consumo, custos, estat¡sticas de viagem</td></tr>
            <tr><td>sp_NormalizarAbastecimentos</td><td>Job (pipeline de viagens)</td><td>Abastecimento normalizado</td></tr>
            <tr><td>sp_CalcularConsumoVeiculos</td><td>Job (pipeline de viagens)</td><td>Veiculo.Consumo (desabilita/reabilita triggers)</td></tr>
            <tr><td>sp_AtualizarPadroesVeiculos</td><td>Job (pipeline de viagens)</td><td>VeiculoPadraoViagem (base p/ corre‡Æo de km)</td></tr>
            <tr><td>sp_NormalizarViagens</td><td>Job (pipeline de viagens)</td><td>Viagem.*Normalizado</td></tr>
            <tr><td>sp_RecalcularCustosTodasViagens</td><td>Job (pipeline de viagens)</td><td>Viagem (custos) via sp_CalculaCustosViagem</td></tr>
            <tr><td>sp_AtualizarTodasEstatisticasViagem</td><td>Job (pipeline de viagens)</td><td>ViagemEstatistica (itera dia a dia)</td></tr>
            <tr><td>sp_AtualizarEstatisticasAbastecimentosMesAtual</td><td>Job di rio</td><td>Estat¡sticas mensais/anuais de abastecimento</td></tr>
            <tr><td>sp_RecalcularEstatisticasMotoristas</td><td>Job/manual (mensal)</td><td>Estat¡sticaMotoristasMensal, Rankings, Heatmap</td></tr>
            <tr><td>sp_AtualizarEstatisticasVeiculosMesAtual</td><td>Job di rio</td><td>Snapshots e rankings de ve¡culos (mˆs atual/anterior)</td></tr>
            <tr><td>sp_RecalcularEstatisticasVeiculo*</td><td>Manual/mensal</td><td>Snapshots por categoria/status/modelo/combust¡vel/unidade/ano</td></tr>
            <tr><td>sp_RecalcularEstatisticasVeiculoUsoMensal</td><td>Manual/mensal</td><td>EstatisticaVeiculoUsoMensal</td></tr>
            <tr><td>sp_RecalcularRankingsVeiculoAnual</td><td>Manual/mensal/anual</td><td>Rankings e anos dispon¡veis de ve¡culo</td></tr>
            <tr><td>sp_RecalcularTodasEstatisticasAbastecimentos</td><td>Manual/on-demand</td><td>Estat¡sticas mensais/anuais completas</td></tr>
            <tr><td>sp_CalculaCustosViagem</td><td>Usada por jobs/isolada</td><td>Custos de viagem</td></tr>
            <tr><td>sp_Requisitante_TratarNulos / sp_TratarNulos*</td><td>Administrativo</td><td>Saneamento de dados</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <div class="section-title">
          <svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-triangle-exclamation"></use></svg>
          Observa‡äes e recomenda‡äes
        </div>
        <ul>
          <li>SPs pesadas ("Todas") sÆo para migra‡äes/corre‡äes massivas; evitar em hor rio de pico.</li>
          <li>Pipeline de viagens (sp_JobAtualizacaoViagens) depende das anteriores; agendar em janela de baixa carga.</li>
          <li>"MesAtual" (abastecimento/motorista/ve¡culo) rodam diariamente; retroativos exigem recalculo adicional.</li>
          <li>Adicionar notifica‡äes/monitoramento nos jobs que usam essas SPs.</li>
        </ul>
      </section>

      <section class="card">
        <div class="section-title">
          <svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-file-code"></use></svg>
          Exemplos (SPs de sistema)
        </div>
        <p><strong>sp_tr_SetString</strong> (MERGE em <code>tr_String</code>)</p>
        <code>
CREATE OR ALTER PROCEDURE dbo.sp_tr_SetString<br>
  @Key varchar(255) = 0,<br>
  @Value nvarchar(4000) = 0<br>
AS<br>
BEGIN<br>
  SET NOCOUNT ON;<br>
  MERGE [dbo].[tr_String] AS T<br>
  USING (SELECT @Key as Id, @Value as Value) AS S<br>
    ON (T.Id = S.Id)<br>
  WHEN NOT MATCHED THEN INSERT(Id, Value) VALUES(S.Id, S.Value)<br>
  WHEN MATCHED THEN UPDATE SET T.Value = S.Value;<br>
END
        </code>
        <p style="font-size:12px;color:#555;">Procedures de sistema: <code>sp_tr_SetString</code>, <code>sp_tr_GetString</code> para tradu‡äes/localiza‡Æo.</p>
      </section>

      <section class="card">
        <div class="section-title">
          <svg class="icon" aria-hidden="true" focusable="false"><use href="#fa-list-check"></use></svg>
          Log de modifica‡äes
        </div>
        <ul>
          <li><strong>08/01/2026</strong> - Cria‡Æo da documenta‡Æo inicial das stored procedures. Status: em progresso.</li>
        </ul>
      </section>
    </main>
  </div>
</body>
</html>



