@* ****************************************************************************************
 * âš¡ ARQUIVO: Pages/Intel/AnalyticsDashboard.cshtml
 * --------------------------------------------------------------------------------------
 * ðŸŽ¯ OBJETIVO     : Dashboard principal do sistema exibindo cards de acesso rÃ¡pido Ã s funcionalidades (Agenda, Viagens, VeÃ­culos, Abastecimento, ManutenÃ§Ã£o, Multas, Inserir Fichas MOB)
 * ðŸ“¥ ENTRADAS     : @page, @model AnalyticsDashboardModel, ViewData (Title, PageName, Category1), cliques nos cards de acesso
 * ðŸ“¤ SAÃDAS       : HTML com 8 cards interativos, JavaScript inline para preview de imagem PNG (trim transparÃªncia), feedback visual (cursor wait), SweetAlert tests, redirects para pÃ¡ginas do sistema via links <a href>
 * ðŸ”— CHAMADA POR  : Menu principal (Intel > PÃ¡gina Principal), rota direta /Intel/AnalyticsDashboard
 * ðŸ”„ CHAMA        : /agenda/index, /viagens/upsert, /viagens/index, /veiculo/index, /abastecimento/index, /manutencao/listamanutencao, /multa/listapenalidade, /viagens/fluxopassageiros, JavaScript inline Alerta.TratamentoErroComLinha, SweetAlertInterop (ShowError, ShowWarning, ShowInfo, ShowSuccess, ShowConfirm, ShowTratamentoErroComLinha, ShowPreventionAlert)
 * ðŸ“¦ DEPENDÃŠNCIAS : Bootstrap 5.3.8 (CSS/JS), Font Awesome Duotone icons, ~/css/miscellaneous/reactions/reactions.css, ~/css/miscellaneous/fullcalendar/fullcalendar.bundle.css, ~/css/miscellaneous/jqvmap/jqvmap.bundle.css, ~/css/profilecards.css, ~/css/profilecommon.css, ~/js/custom.js, ~/css/demo-01.css, ~/Images/ (imagens cards e logo), Canvas API (browser trimTransparentPNG), jQuery, SweetAlert2 via SweetAlertInterop, Alerta.TratamentoErroComLinha, data-ftx-loading
 * ðŸ“ OBSERVAÃ‡Ã•ES  : Total: ~673 linhas. CÃ³digo comentado extenso de testes SweetAlert (linhas 104-238) - REMOVER. Possui 3 funÃ§Ãµes JavaScript de teste de alertas comentadas. JavaScript inline complexo para recorte de imagem PNG (~280 linhas) - considerar mover para arquivo externo. Feedback visual de loading nos cards funcional. Bootstrap 5.3.8 carregado via CDN (verificar se jÃ¡ carregado no layout). Logo FrotiX (#logoOriginal) tem trim automÃ¡tico aplicado. CÃ³digo bem estruturado mas com muito lixo comentado. CSS inline excessivo (~110 linhas) - mover para arquivo externo. Imagens hardcoded em ~/Images/ - verificar se existem.
 **************************************************************************************** *@
@page
@model AnalyticsDashboardModel

@{
    ViewData["Title"] = "Indice";
    ViewData["PageName"] = "intel_paginaprincipal";
    ViewData["Category1"] = "Pagina Principal";
    //ViewData["Heading"] = "<i class='subheader-icon fa-duotone fa-home'></i> PÃ¡gina <span class='fw-300'>Inicial</span>";
}

@section HeadBlock {
    <link rel="stylesheet" media="screen, print" href="~/css/miscellaneous/reactions/reactions.css">
    <link rel="stylesheet" media="screen, print" href="~/css/miscellaneous/fullcalendar/fullcalendar.bundle.css">
    <link rel="stylesheet" media="screen, print" href="~/css/miscellaneous/jqvmap/jqvmap.bundle.css">

    <!-- PROFILE STYLES -->
    <link href="~/css/profilecards.css" rel="stylesheet">
    <!-- ./PROFILE STYLES -->
    <!-- COMMON STYLES -->
    <link href="~/css/profilecommon.css" rel="stylesheet">
    <!-- ./COMMON STYLES -->
    <!-- CUSTOM JAVASCRIPT -->
    <script src="~/js/custom.js"></script>
    <!-- ./CUSTOM JAVASCRIPT -->
    <!-- DEMO 01 CSS FILE -->
    <link href="~/css/demo-01.css" rel="stylesheet">
}

<style>
    /* =========================================================================
       FEEDBACK VISUAL: CURSOR AMPULHETA DURANTE CARREGAMENTO
       ========================================================================= */
    body.ftx-loading,
    body.ftx-loading * {
        cursor: wait !important;
    }

    .botaoFormat {
        color: #b29b2b;
    }

        .botaoFormat:hover {
            font-weight: bold;
            box-shadow: 0 0 0.8em #808080;
        }

    .row.display-flex {
        display: flex;
        flex-wrap: wrap;
    }

        .row.display-flex > [class*='col-'] {
            display: flex;
            flex-direction: column;
        }

    #notify {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        min-width: 200px;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 16px;
        color: white;
        font-family: 'Segoe UI', sans-serif;
        display: none;
        z-index: 99999;
    }

    /* FIX: Remove rotaÃ§Ã£o das imagens dos cards */
    .profile-img img {
        transform: none !important;
        transition: transform 0s !important;
    }

    .profile-img:hover img {
        transform: none !important;
    }

    /* FIX: Aproxima logo dos cards */
    #logoOriginal,
    canvas[aria-label="imagem recortada"] {
        margin-bottom: 0 !important;
    }

    .mt-4 {
        margin-top: 0.5rem !important;
    }
</style>

@section SubheaderBlock {
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">

                <div>
                    <img id="logoOriginal"
                         src="~/Images/LogotipoCompletoFrotiXRoxoFundoTransparenteEstreita.png"
                         alt="FrotiX"
                         data-trim
                         data-trim-maxwidth="500"
                         style="display:block;margin:0 auto;max-width:100%;height:auto;" />
                </div>

                @*             <script>

                                // FunÃ§Ã£o para simular o que o C# Alerta.cs faria
                function simularAlertaCS() {
                    // Simula o que acontece quando o C# salva no TempData
                    const alertData = {
                        type: "error",
                        title: "Erro do C#",
                        message: "Este alerta foi 'gerado' pelo Helper Alerta.cs",
                        confirmButton: "OK"
                    };

                    // Simula o processamento que deveria acontecer no Layout
                    if (window.SweetAlertInterop) {
                        switch(alertData.type) {
                            case 'error':
                                SweetAlertInterop.ShowError(alertData.title, alertData.message, alertData.confirmButton);
                                break;
                            case 'success':
                                SweetAlertInterop.ShowSuccess(alertData.title, alertData.message, alertData.confirmButton);
                                break;
                            // ... outros casos
                        }
                    }
                }

                // Testa TratamentoErroComLinha simulando o C#
                function simularTratamentoErroCS() {
                    const alertData = {
                        type: "errorUnexpected",
                        classe: "TesteController.cs",
                        metodo: "TesteFuncao",
                        erro: "SimulaÃ§Ã£o de erro do C#",
                        stack: "System.Exception: Erro simulado\n   at TesteFuncao() in TesteController.cs:line 45\n   at MainMethod() in Program.cs:line 123"
                    };

                    if (window.SweetAlertInterop) {
                        const fakeError = new Error(alertData.erro);
                        fakeError.stack = alertData.stack;
                        SweetAlertInterop.ShowErrorUnexpected(alertData.classe, alertData.metodo, fakeError);
                    }
                }

            </script>

            <!-- Adicione apÃ³s os outros botÃµes -->
            <hr style="margin: 10px 0; border-color: #ddd;">
            <div style="font-size: 11px; color: #666; margin-bottom: 8px; text-align: center;">SimulaÃ§Ã£o C#</div>

            <button onclick="simularAlertaCS()" class="btn btn-outline-danger btn-sm">
                <i class="fa-duotone fa-code"></i> Simular C# Erro
            </button>

            <button onclick="simularTratamentoErroCS()" class="btn btn-outline-dark btn-sm">
                <i class="fa-duotone fa-server"></i> Simular C# TÃ©cnico
            </button> *@

                @*             <!-- Painel de Teste dos Alertas SweetAlert -->
            <div style="position: fixed; top: 10px; right: 10px; z-index: 9999; background: white; padding: 15px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 250px;">
                <h6 style="margin-bottom: 15px; text-align: center; color: #333;">Teste SweetAlert</h6>

                <div style="display: grid; gap: 8px;">
                    <!-- Alertas bÃ¡sicos -->
                    <button onclick="mostrarErro()" class="btn btn-vinho btn-sm" style="width: 100%;">
                        <i class="fa-duotone fa-times-circle"></i> Erro
                    </button>

                    <button onclick="mostrarAlerta()" class="btn btn-terracota btn-sm" style="width: 100%;">
                        <i class="fa-duotone fa-exclamation-triangle"></i> Aviso
                    </button>

                    <button onclick="mostrarInfo()" class="btn btn-info btn-sm" style="width: 100%;">
                        <i class="fa-duotone fa-info-circle"></i> InformaÃ§Ã£o
                    </button>

                    <button onclick="mostrarSucesso()" class="btn btn-verde btn-sm" style="width: 100%;">
                        <i class="fa-duotone fa-check-circle"></i> Sucesso
                    </button>

                    <!-- Alertas especiais -->
                    <button onclick="mostrarConfirmar()" class="btn btn-azul btn-sm" style="width: 100%;">
                        <i class="fa-duotone fa-question-circle"></i> Confirmar
                    </button>

                    <button onclick="mostrarUnexpected()" class="btn btn-dark btn-sm" style="width: 100%;">
                        <i class="fa-duotone fa-bug"></i> Erro TÃ©cnico
                    </button>

                    <button onclick="testarPreventionAlert()" class="btn btn-secondary btn-sm" style="width: 100%;">
                        <i class="fa-duotone fa-shield-alt"></i> Prevention Alert
                    </button>
                </div>

                <!-- BotÃ£o para ocultar o painel -->
                <button onclick="this.parentElement.style.display='none'" style="position: absolute; top: 5px; right: 8px; background: none; border: none; font-size: 16px; color: #999; cursor: pointer;">
                    &times;
                </button>
            </div> *@

                @*             <!-- BotÃµes de teste para os alertas -->
            <div style="position: fixed; top: 10px; right: 10px; z-index: 9999; background: white; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                <h5>Teste de Alertas</h5>
                <button onclick="testarAlertaErro()" class="btn btn-vinho btn-sm">Erro</button>
                <button onclick="testarAlertaSucesso()" class="btn btn-verde btn-sm">Sucesso</button>
                <button onclick="testarAlertaAviso()" class="btn btn-terracota btn-sm">Aviso</button>
                <button onclick="testarAlertaComDetalhes()" class="btn btn-info btn-sm">Com Detalhes</button>
            </div>

            <script>
                function testarAlertaErro() {
                    if (window.GlobalAlert) {
                        GlobalAlert.showError(
                            "Erro no Sistema",
                            "Este Ã© um teste de alerta de erro do sistema."
                        );
                    } else {
                        alert("GlobalAlert nÃ£o estÃ¡ disponÃ­vel");
                    }
                }

                function testarAlertaSucesso() {
                    if (window.GlobalAlert) {
                        GlobalAlert.showSuccess(
                            "OperaÃ§Ã£o Realizada",
                            "A operaÃ§Ã£o foi executada com sucesso!"
                        );
                    } else {
                        alert("GlobalAlert nÃ£o estÃ¡ disponÃ­vel");
                    }
                }

                function testarAlertaAviso() {
                    if (window.GlobalAlert) {
                        GlobalAlert.showWarning(
                            "AtenÃ§Ã£o",
                            "Este Ã© um aviso importante para o usuÃ¡rio."
                        );
                    } else {
                        alert("GlobalAlert nÃ£o estÃ¡ disponÃ­vel");
                    }
                }

                function testarAlertaComDetalhes() {
                    if (window.GlobalAlert) {
                        GlobalAlert.showError(
                            "Erro TÃ©cnico",
                            "Erro ao processar solicitaÃ§Ã£o no MultaController.cs",
                            `System.Exception: Connection timeout
                   at MultaController.ListaMultas(String fase) in C:\\Projeto\\Controllers\\MultaController.cs:line 45
                   at System.Web.Mvc.ActionResult.InvokeAction(ControllerContext controllerContext)`
                        );
                    } else {
                        alert("GlobalAlert nÃ£o estÃ¡ disponÃ­vel");
                    }
                }
            </script> *@

                @*             <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center">
                <button id="btn-ok" class="btn btn-verde" type="button">Toast Verde (3s)</button>
                <button id="btn-err" class="btn btn-vinho" type="button">Toast Vermelho (5s)</button>
                <button id="btn-warn" class="btn btn-terracota" type="button">Toast Amarelo (fixo)</button>
            </div> *@

                <div class="mt-4">
                    <div class="row">
                        <div class="card-container w-100">
                            <div class="container-fluid">
                                <div class="row">

                                    <!-- Agenda -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/agenda/index">
                                                        <img src="~/Images/Schedule.jpg" class="img img-responsive" alt="Agenda">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/agenda/index">Agenda</a>
                                                </div>
                                                <p class="profile-description">Exibe a Agenda.</p>
                                                <div class="profile-icons">
                                                    <a href="/agenda/index">
                                                        <i class="fa-duotone fa-calendar-days"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Nova Viagem -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/viagens/upsert">
                                                        <img src="~/Images/Trip.jpg" class="img img-responsive" alt="Nova Viagem">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/viagens/upsert">Nova Viagem</a>
                                                </div>
                                                <p class="profile-description">Cadastra uma nova Viagem</p>
                                                <div class="profile-icons">
                                                    <a href="/viagens/upsert">
                                                        <i class="fa-duotone fa-location-dot"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- GestÃ£o de Viagens -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/viagens/index">
                                                        <img src="~/Images/GestaoViagens.jpg" class="img img-responsive" alt="GestÃ£o de Viagens">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/viagens/index">GestÃ£o de Viagens</a>
                                                </div>
                                                <p class="profile-description">Gerencia as Viagens Cadastradas</p>
                                                <div class="profile-icons">
                                                    <a href="/viagens/index">
                                                        <i class="fa-duotone fa-car-bus"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- GestÃ£o de VeÃ­culos -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/veiculo/index">
                                                        <img src="~/Images/Veiculos.jpg" class="img img-responsive" alt="GestÃ£o de VeÃ­culos">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/veiculo/index">GestÃ£o de VeÃ­culos</a>
                                                </div>
                                                <p class="profile-description">Gerencia os VeÃ­culos</p>
                                                <div class="profile-icons">
                                                    <a href="/veiculo/index">
                                                        <i class="fa-duotone fa-bus-school"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- GestÃ£o de Abastecimento -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/abastecimento/index">
                                                        <img src="~/Images/Abastecimento.jpg" class="img img-responsive" alt="GestÃ£o de Abastecimento">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/abastecimento/index">GestÃ£o de Abastecimento</a>
                                                </div>
                                                <p class="profile-description">Controla os Abastecimentos</p>
                                                <div class="profile-icons">
                                                    <a href="/abastecimento/index">
                                                        <i class="fa-duotone fa-gas-pump"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- GestÃ£o de ManutenÃ§Ãµes -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/manutencao/listamanutencao">
                                                        <img src="~/Images/Manutencao.jpg" class="img img-responsive" alt="GestÃ£o de ManutenÃ§Ãµes">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/manutencao/listamanutencao">GestÃ£o de ManutenÃ§Ãµes</a>
                                                </div>
                                                <p class="profile-description">Gerencia as ManutenÃ§Ãµes</p>
                                                <div class="profile-icons">
                                                    <a href="/manutencao/listamanutencao">
                                                        <i class="fa-duotone fa-car-wrench"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- GestÃ£o de Multas -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/multa/listapenalidade">
                                                        <img src="~/Images/Multa.jpg" class="img img-responsive" alt="GestÃ£o de Multas">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/multa/listapenalidade">GestÃ£o de Multas</a>
                                                </div>
                                                <p class="profile-description">Gerencia as Penalidades</p>
                                                <div class="profile-icons">
                                                    <a href="/multa/listapenalidade">
                                                        <i class="fa-duotone fa-pen-to-square"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Inserir Fichas MOB -->
                                    <div class="col-md-3">
                                        <div class="profile-card-1">
                                            <div class="profile-content">
                                                <div class="profile-img">
                                                    <a href="/viagens/fluxopassageiros">
                                                        <img src="~/Images/MOB.jpg" class="img img-responsive" alt="Inserir Fichas MOB">
                                                    </a>
                                                </div>
                                                <div class="profile-name">
                                                    <a href="/viagens/fluxopassageiros">Inserir Fichas MOB</a>
                                                </div>
                                                <p class="profile-description">Insere Fichas dos MOBs</p>
                                                <div class="profile-icons">
                                                    <a href="/viagens/fluxopassageiros">
                                                        <i class="fa-duotone fa-bus-school"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div> <!-- /.row -->
                            </div> <!-- /.container-fluid -->
                        </div> <!-- /.card-container -->
                    </div> <!-- /.row -->
                </div> <!-- /.mt-4 -->

            </div> <!-- /.col -->
        </div> <!-- /.row -->
    </div> <!-- /.container -->
}

@section ScriptsBlock {
    
    

    <script>
        // document.getElementById('btn-ok').addEventListener('click', function () {
        //   AppToast.show('Verde', 'OcorrÃªncia baixada com sucesso!');
        // });

        // document.getElementById('btn-err').addEventListener('click', function () {
        //   AppToast.show('Vermelho', 'Falha ao baixar ocorrÃªncia. Tente novamente.', 5000);
        // });

        // document.getElementById('btn-warn').addEventListener('click', function () {
        //   AppToast.show('Amarelo', 'AtenÃ§Ã£o: verifique os campos obrigatÃ³rios.', 0); // fixo
        //   // fecha manualmente apÃ³s 3s sÃ³ para demonstrar:
        //   setTimeout(() => AppToast.close(), 3000);
        // });

        // ====== Alertas de exemplo usando SweetAlertInterop (strings corrigidas) ======
        function mostrarErro() {
            try {
                SweetAlertInterop.ShowError("Falha", "NÃ£o foi possÃ­vel concluir a operaÃ§Ã£o.", "Fechar");
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "mostrarErro", error);
            }
        }

        function mostrarAlerta() {
            try {
                SweetAlertInterop.ShowWarning("AtenÃ§Ã£o", "VocÃª tem certeza que deseja continuar?", "Fechar");
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "mostrarAlerta", error);
            }
        }

        function mostrarInfo() {
            try {
                SweetAlertInterop.ShowInfo("InformaÃ§Ã£o", "O sistema foi atualizado com sucesso.", "Fechar");
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "mostrarInfo", error);
            }
        }

        function mostrarSucesso() {
            try {
                SweetAlertInterop.ShowSuccess("Sucesso", "A operaÃ§Ã£o foi realizada!", "Fechar");
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "mostrarSucesso", error);
            }
        }

        function mostrarConfirmar() {
            try {
                SweetAlertInterop.ShowConfirm("VocÃª tem certeza?", "Confirme para prosseguir.", "Confirmar", "Fechar");
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "mostrarConfirmar", error);
            }
        }

        function mostrarUnexpected() {
            try {
                SweetAlertInterop.ShowTratamentoErroComLinha("AnalyticsDashboard.cshtml", "mostrarUnexpected()");
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "mostrarUnexpected", error);
            }
        }

        async function testarPreventionAlert() {
            try {
                const confirmado = await window.SweetAlertInterop.ShowPreventionAlert("A Data Final estÃ¡ 5 dias ou mais apÃ³s a Inicial. Tem certeza?");
                if (!confirmado) {
                    // UsuÃ¡rio cancelou
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "testarPreventionAlert", error);
            }
        }
    </script>

    <script>
        /* ========= NÃšCLEO: recorta bordas transparentes de PNG ========= */
        function trimTransparentPNG(img, { alphaThreshold = 1 } = {}) {
            try {
                const src = document.createElement('canvas');
                const sctx = src.getContext('2d');

                src.width = img.naturalWidth || img.width;
                src.height = img.naturalHeight || img.height;
                sctx.drawImage(img, 0, 0);

                // Pode lanÃ§ar se CORS bloquear leitura
                let imageData;
                try {
                    imageData = sctx.getImageData(0, 0, src.width, src.height);
                } catch (e) {
                    console.error("Canvas bloqueado por CORS. Ative CORS no servidor ou sirva a imagem do mesmo domÃ­nio.", e);
                    return null;
                }

                const { data, width: w, height: h } = imageData;
                let top = h, left = w, right = -1, bottom = -1;

                for (let y = 0; y < h; y++) {
                    for (let x = 0; x < w; x++) {
                        const a = data[(y * w + x) * 4 + 3];
                        if (a >= alphaThreshold) {
                            if (x < left) left = x;
                            if (x > right) right = x;
                            if (y < top) top = y;
                            if (y > bottom) bottom = y;
                        }
                    }
                }

                // Caso a imagem seja totalmente transparente
                if (right < left || bottom < top) {
                    return null;
                }

                const tw = right - left + 1;
                const th = bottom - top + 1;

                const out = document.createElement('canvas');
                out.width = tw;
                out.height = th;
                out.getContext('2d').drawImage(src, left, top, tw, th, 0, 0, tw, th);
                return out;

            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "trimTransparentPNG", error);
            }
        }

        /* ========= HELPER: aplica o trim num <img> ========= */
        function applyTrimToImg(imgEl, {
            targetWidth,         // opcional: largura final
            maxWidth = 500,      // limite de largura (responsivo)
            alphaThreshold = 1,  // 0â€“255: quanto de opacidade considerar "visÃ­vel"
            replace = true       // true -> troca <img> por <canvas>; false -> insere apÃ³s
        } = {}) {
            try {
                const proxy = new Image();
                // Habilite CORS se for outro domÃ­nio
                if (imgEl.crossOrigin) proxy.crossOrigin = imgEl.crossOrigin;

                proxy.onload = () => {
                    try {
                        const trimmedCanvas = trimTransparentPNG(proxy, { alphaThreshold });
                        if (!trimmedCanvas) {
                            console.warn("Trim nÃ£o executado (CORS ou imagem 100% transparente). Mantendo <img> original.");
                            return;
                        }

                        // Redimensiona mantendo proporÃ§Ã£o (opcional)
                        let finalCanvas = trimmedCanvas;
                        if (targetWidth || maxWidth) {
                            const containerW = imgEl.parentElement ? imgEl.parentElement.clientWidth : trimmedCanvas.width;
                            const desiredW = Math.min(
                                targetWidth || trimmedCanvas.width,
                                maxWidth || trimmedCanvas.width,
                                containerW || (targetWidth || trimmedCanvas.width)
                            );
                            const scale = desiredW / trimmedCanvas.width;
                            const desiredH = Math.round(trimmedCanvas.height * scale);

                            finalCanvas = document.createElement('canvas');
                            finalCanvas.width = desiredW;
                            finalCanvas.height = desiredH;

                            const ctx = finalCanvas.getContext('2d');
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(trimmedCanvas, 0, 0, desiredW, desiredH);
                        }

                        // Responsividade via CSS inline simples
                        finalCanvas.style.maxWidth = "100%";
                        finalCanvas.style.height = "auto";
                        finalCanvas.setAttribute('aria-label', imgEl.alt || 'imagem recortada');

                        if (replace) {
                            imgEl.replaceWith(finalCanvas);
                        } else {
                            imgEl.insertAdjacentElement('afterend', finalCanvas);
                        }

                    } catch (error) {
                        Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "applyTrimToImg.onload", error);
                    }
                };

                proxy.onerror = () => console.error("Falha ao carregar imagem para trim:", imgEl.src);
                proxy.src = imgEl.currentSrc || imgEl.src;

            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "applyTrimToImg", error);
            }
        }

        /* ========= AUTOAPLICAÃ‡ÃƒO =========
           1) Aplica no #logoOriginal
           2) Aplica em qualquer <img data-trim> da pÃ¡gina
        */
        window.addEventListener('DOMContentLoaded', () => {
            try {
                const logo = document.getElementById('logoOriginal');
                if (logo) {
                    applyTrimToImg(logo, { maxWidth: 520, alphaThreshold: 1, replace: true });
                }

                document.querySelectorAll('img[data-trim]').forEach(img => {
                    try {
                        applyTrimToImg(img, {
                            maxWidth: Number(img.dataset.trimMaxwidth) || 480,
                            alphaThreshold: Number(img.dataset.trimAlpha) || 1,
                            replace: img.dataset.trimReplace !== "false"
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "DOMContentLoaded.forEach", error);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("AnalyticsDashboard.cshtml", "DOMContentLoaded", error);
            }
        });

        /* =========================================================================
           FEEDBACK VISUAL: CURSOR AMPULHETA AO CLICAR NOS CARDS
           ========================================================================= */
        (function() {
            'use strict';
            
            // Adiciona evento de clique em todos os links dos cards
            document.addEventListener('click', function(e) {
                try {
                    // Verifica se o clique foi em um link dentro de um card
                    var link = e.target.closest('.profile-card-1 a');
                    if (link && link.href) {
                        // Muda o cursor do body para ampulheta
                        document.body.style.cursor = 'wait';
                        document.documentElement.style.cursor = 'wait';
                        
                        // Adiciona classe para estilizaÃ§Ã£o adicional se necessÃ¡rio
                        document.body.classList.add('ftx-loading');
                        
                        // Muda o cursor do card clicado tambÃ©m
                        var card = link.closest('.profile-card-1');
                        if (card) {
                            card.style.cursor = 'wait';
                            card.querySelectorAll('*').forEach(function(el) {
                                el.style.cursor = 'wait';
                            });
                        }
                    }
                } catch (error) {
                    // Silencioso - nÃ£o queremos quebrar a navegaÃ§Ã£o
                    console.error('Erro ao mudar cursor:', error);
                }
            });
            
            // Restaura o cursor se o usuÃ¡rio voltar para a pÃ¡gina (cache do navegador)
            window.addEventListener('pageshow', function(e) {
                try {
                    if (e.persisted) {
                        document.body.style.cursor = '';
                        document.documentElement.style.cursor = '';
                        document.body.classList.remove('ftx-loading');
                        document.querySelectorAll('.profile-card-1').forEach(function(card) {
                            card.style.cursor = '';
                            card.querySelectorAll('*').forEach(function(el) {
                                el.style.cursor = '';
                            });
                        });
                    }
                } catch (error) {
                    console.error('Erro ao restaurar cursor:', error);
                }
            });
        })();
    </script>
}

