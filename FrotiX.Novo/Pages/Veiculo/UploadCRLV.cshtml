@* ========================================================================================
 * ARQUIVO: Pages/Veiculo/UploadCRLV.cshtml
 * OBJETIVO: Pagina de upload e visualizacao de CRLV (Certificado Registro Licenciamento
 *           Veiculo) documento PDF por veiculo exibindo Syncfusion Uploader async + Syncfusion
 *           PDFViewer renderizando PDF inline, permite motoristas/admins anexar CRLV
 *           digital veiculo para consulta mobile campo evitando carregar documento fisico.
 * ENTRADAS: route /Veiculo/UploadCRLV?id=123 (id do veiculo obrigatorio), model UploadCRLVModel
 *           PageModel (properties: VeiculoId int, Veiculo entity Include Placa/Modelo
 *           exibir header, CRLVExistente string path PDF ja anexado load inicial PDFViewer),
 *           Syncfusion Uploader async POST /Veiculo/SaveCRLV aceita arquivo PDF ate
 *           5MB restricao accept .pdf, retorna JSON {success, fileName, filePath} PDF
 *           salvo servidor
 * SAIDAS: Pagina renderizada com card header (titulo Upload CRLV Veiculo: [Placa Modelo],
 *         icone fa-file-pdf, breadcrumb Frota > Veiculos > Upload CRLV, link Voltar
 *         /Veiculo/Index), card body com: 1. Alert Info topo (instrucoes: Selecione
 *         arquivo PDF do CRLV veiculo tamanho maximo 5MB, PDF sera salvo e vinculado
 *         ao veiculo para consulta, CRLV vigente obrigatorio circular veiculo), 2.
 *         Syncfusion Uploader component (botao Browse seleciona arquivo PDF restricao
 *         accept .pdf maxFileSize 5MB, drag-drop area permite arrastar PDF, async auto-upload
 *         true envia automaticamente apos selecao, progress bar animada durante upload,
 *         success event recebe response JSON fileName/filePath atualiza PDFViewer carrega
 *         novo PDF exibe AppToast Verde CRLV salvo com sucesso, failure event exibe
 *         Alerta.Erro mensagem erro validacao tamanho/extensao), 3. Syncfusion PDFViewer
 *         component (se CRLVExistente not null carrega PDF inicial exibe documento vigente,
 *         senao exibe placeholder Nenhum CRLV anexado upload documento, toolbar topo
 *         botoes Zoom In/Out/Fit Page/Fit Width/Rotate, Print imprime PDF, Download
 *         baixa PDF original, navegacao paginas se CRLV multiplas paginas, scroll vertical
 *         se PDF longo, annotation tools permite adicionar comentarios/highlight no
 *         PDF se necessario marcar informacoes importantes), 4. Botao Excluir CRLV rodape
 *         danger (disabled se CRLVExistente null, click Alerta.Confirmar popup Tem
 *         certeza excluir CRLV?, se Sim POST /Veiculo/DeleteCRLV?id=123 soft delete
 *         seta Veiculo.CRLVPath=null DataExclusaoCRLV=now, success limpa PDFViewer
 *         exibe placeholder exibe AppToast amarelo CRLV excluido)
 * CHAMADA POR: Grid /Veiculo/Index coluna Acoes botao CRLV icone file-pdf azul (link
 *              /Veiculo/UploadCRLV?id=123), botao Upload CRLV em /Veiculo/Upsert form
 *              (abre modal iframe ou redirect), usado por Admins Frota atualizar CRLVs
 *              apos renovacao anual licenciamento, usado por Motoristas mobile consultar
 *              CRLV digital se fiscalizacao solicitar documento estrada
 * CHAMA: PageModel UploadCRLVModel.cshtml.cs: OnGet (recebe id query param valida veiculo
 *        existe carrega Veiculo Include CRLVPath, se CRLVPath not null passa para ViewBag
 *        PDFViewer load inicial, se null PDFViewer vazio), OnPost SaveCRLV (recebe
 *        IFormFile arquivo PDF e VeiculoId hidden field, valida extensao .pdf real
 *        via FileSignature magic bytes nao apenas nome arquivo, valida tamanho max
 *        5MB, valida ContentType application/pdf, gera fileName GUID+.pdf evita conflitos,
 *        salva arquivo wwwroot/uploads/crlv/ usando IWebHostEnvironment.WebRootPath,
 *        atualiza Veiculo entity seta CRLVPath=/uploads/crlv/abc123.pdf DataAtualizacaoCRLV=now,
 *        DbContext.SaveChanges, retorna JSON {success:true, fileName, filePath}),
 *        OnPost DeleteCRLV (recebe id query param, carrega Veiculo verifica CRLVPath
 *        not null, soft delete seta CRLVPath=null DataExclusaoCRLV=now UsuarioExclusaoId=User.Id
 *        mantem historico auditoria, considera deletar arquivo fisico disco se politica
 *        retencao permite senao manter backup, SaveChanges, retorna JSON success),
 *        Syncfusion Uploader component (upload async restricoes accept/maxFileSize,
 *        eventos uploading/success/failure, localization PT-BR), Syncfusion PDFViewer
 *        component (renderiza PDF usando PDF.js library, toolbar zoom/print/download/annotation,
 *        scroll virtual lazy loading paginas grandes), Alerta.Confirmar (confirmacao
 *        exclusao), AppToast.show Verde/Amarelo (feedback success/warning)
 * DEPENDENCIAS: ASP.NET Core Razor Pages 8.0, Syncfusion EJ2 Uploader/PDFViewer 2023.4.2,
 *               Bootstrap 5.3.8, Font Awesome 6 Duotone, jQuery 3.7.1, PDF.js library
 *               (included Syncfusion), EF Core 8.0
 * OBSERVACOES: 352 linhas pagina upload CRLV veiculo. CRLV (Certificado Registro Licenciamento
 *              Veiculo) documento obrigatorio circular veiculo emitido anualmente pelo
 *              DETRAN apos pagamento IPVA/multas/seguro obrigatorio, contem dados veiculo
 *              (Placa, Chassi, Renavam, Proprietario, Marca/Modelo, Ano Fabricacao/Modelo,
 *              Capacidade passageiros/carga, Restricoes judiciais/financeiras), fiscalizacao
 *              transito pode solicitar CRLV motorista deve apresentar sob pena multa
 *              gravissima R$ 293,47 + 7 pontos CNH + apreensao veiculo (Art 232 CTB),
 *              FrotiX permite digitalizar CRLV upload PDF vincula veiculo motoristas
 *              consultam mobile app campo dispensando documento fisico (alguns estados
 *              ja permitem CRLV digital app Carteira Digital Transito aceito fiscalizacao).
 *              Validacao backend ESSENCIAL: verifica extensao arquivo real via FileSignature
 *              magic bytes PDF inicia com %PDF (bytes 25 50 44 46 hex) nao confiar apenas
 *              extensao nome arquivo usuario malicioso pode renomear EXE para .pdf bypassar
 *              validacao client-side, verifica ContentType application/pdf, valida tamanho
 *              max 5MB (CRLV digitalizado scan geralmente 1-2 paginas 500KB-1MB, limite
 *              5MB generoso mas evita uploads abusivos PDFs enormes 100MB+ travam renderizacao).
 *              GUID filename: gera nome arquivo unico abc123-def456-ghi789.pdf evita
 *              conflitos sobrescrever CRLVs de outros veiculos e previne path traversal
 *              attacks (se usar fileName original sanitizar removendo ../ caracteres
 *              especiais). Soft delete: seta CRLVPath=null DataExclusaoCRLV=now UsuarioExclusaoId
 *              mantem auditoria (rastrear quem excluiu CRLV quando para compliance),
 *              considera manter arquivo fisico disco backup 30 dias apos exclusao caso
 *              erro usuario precise recuperar senao deletar arquivo libera espaco disco.
 *              Syncfusion PDFViewer: renderiza PDF client-side usando PDF.js Mozilla
 *              library sem plugin Adobe Reader (funciona todos navegadores modernos),
 *              annotation tools permitem adicionar comentarios/highlight no PDF (exemplo:
 *              destacar data vencimento CRLV 31/12/2026, adicionar nota Renovar IPVA
 *              ate Janeiro 2027, anotacoes salvas separado nao modificam PDF original).
 *              Mobile consulta: motoristas campo acessam FrotiX mobile app /Veiculo/UploadCRLV?id=123
 *              visualizam CRLV digital PDF, se fiscalizacao solicitar documento mostram
 *              tela smartphone oficial aceita (verificar legislacao estadual alguns
 *              estados ainda exigem CRLV fisico outros aceitam digital), considera adicionar
 *              botao Enviar CRLV Email permite motorista enviar PDF proprio email se
 *              preferir ter copia offline. Renovacao anual: CRLV vencimento anual geralmente
 *              mes aniversario final placa (placas finais 1-2 vencem Janeiro, 3-4 Fevereiro,
 *              ...), sistema pode alertar automaticamente Veiculos com CRLV Vencido:
 *              query Where DataAtualizacaoCRLV < 1 year ago exibe dashboard badge vermelho,
 *              Job agendado envia email alerta Admin Frota 30 dias antes vencimento
 *              lista veiculos renovar IPVA obter novo CRLV upload atualizar sistema.
 *              Integracao API DETRAN: futuramente considerar integracao automatica API
 *              DETRAN (se disponibilizada) busca CRLV digital automaticamente via Renavam/Placa
 *              sem necessidade upload manual, atualiza dados veiculo proprietario restricoes
 *              sincroniza base FrotiX com base DETRAN tempo real.
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@
@page
@model FrotiX.Pages.Veiculo.UploadCRLVModel

@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers
@using Syncfusion.EJ2

@{
	ViewData["Title"] = "Veículos (CRLV)";
	ViewData["PageName"] = "veiculo_uploadcrlv";
	ViewData["Heading"] = "<i class='fa-duotone fa-file-alt'></i> Cadastros: <span class='fw-300'>Veículos (CRLV)</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-file-alt";

	// Ajustes do uploader (endpoints) - ADICIONE o veiculoId na URL
	var asyncSettings = new Syncfusion.EJ2.Inputs.UploaderAsyncSettings
	{
		SaveUrl = $"api/UploadCRLV/Save?veiculoId={Model.VeiculoObj.Veiculo.VeiculoId}" ,
		RemoveUrl = $"api/UploadCRLV/Remove?veiculoId={Model.VeiculoObj.Veiculo.VeiculoId}"
	};
}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>@ViewData["Title"]</title>

	<link rel="stylesheet" href="~/css/site.css" />
	<link rel="stylesheet" href="~/css/ej2/bootstrap.css" />
</head>
<body>
	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel">
				<div class="panel-container show">
					<div class="panel-content">
						<div class="col-12 px-3" style="border-bottom:1px solid #325d88">
							<h2 class="text-primary">
								Upload do CRLV Digitalizado - (@(Model.VeiculoObj.Veiculo.Placa))
							</h2>
						</div>

						<div class="col-12 pt-3">
							<div class="container">
								<main role="main" class="pb-3">
									<div id="ControlRegion">
										<div class="col-lg-8 control-section">
											<div class="control_wrapper">
												<ejs-uploader id="UploadFiles"
															  removing="onFileRemove"
															  asyncSettings="@asyncSettings"
															  locale="pt-BR"
															  allowedExtensions=".pdf"
															  actionComplete="onActionComplete">
												</ejs-uploader>
											</div>
										</div>

										<div class="col-lg-4 property-section" style="display:none; visibility:hidden">
											<div id="property" title="Properties">
												<div style="margin-left: 50px; padding-top:25px;">
													<ejs-checkbox id="checkAutoUpload"
																  label="Auto Upload"
																  checked="true"
																  change="onChange">
													</ejs-checkbox>
												</div>
											</div>
										</div>

										<br />
										<br />

										<!-- Viewer inicia oculto e é mostrado após upload ou quando já existe CRLV -->
										<div id="divpdf" style="width:100%; height:0px; visibility:hidden;">
											<ejs-pdfviewer id="pdfviewer"
														   style="height:600px"
														   serviceUrl="/api/PdfViewer"
														   locale="pt-BR">
											</ejs-pdfviewer>
										</div>

										<style>
											.control_wrapper {
												max-width: 400px;
												margin: auto;
											}

											.e-upload {
												width: 100%;
												position: relative;
												margin-top: 15px;
											}

											.control_wrapper .e-upload .e-upload-drag-hover {
												margin: 0;
											}
										</style>

										<script>
											(function() {
												"use strict";

												window.onActionComplete = function(args) {
													try {
														if (!args || !args.fileData || !args.fileData.length) {
															console.warn("onActionComplete sem arquivo.");
															return;
														}

														console.info("Upload concluído:", args.fileData[0].name);

														// Exibe o viewer
														var div = document.getElementById("divpdf");
														if (div) {
															div.style.visibility = "visible";
															div.style.height = "600px";
														}

														// Carrega o PDF do veículo
														$.ajax({
															url: '/api/PdfViewer/GetDocument?id=@Model.VeiculoObj.Veiculo.VeiculoId',
															method: 'POST',
															cache: false,
															processData: false,
															contentType: false
														})
														.done(function (result) {
															try {
																console.log("Documento carregado.");
																var pdfViewer = document.getElementById('pdfviewer');
																if (pdfViewer && pdfViewer.ej2_instances && pdfViewer.ej2_instances[0]) {
																	pdfViewer.ej2_instances[0].load(result, null);
																}
															} catch (error) {
																Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "ajax.done", error);
															}
														})
														.fail(function (msg) {
															try {
																console.log('Erro ao carregar documento: ' + (msg && msg.responseText));
																AppToast.show('Vermelho', "Erro ao carregar documento PDF.", 2000);
															} catch (error) {
																Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "ajax.fail", error);
															}
														});

													} catch (error) {
														Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "onActionComplete", error);
													}
												};

												window.onFileRemove = function(args) {
													try {
														// evita envio do arquivo bruto na remoção
														args.postRawFile = false;
													} catch (error) {
														Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "onFileRemove", error);
													}
												};

												window.onChange = function(args) {
													try {
														var uploadObj = document.getElementById("UploadFiles");
														if (!uploadObj || !uploadObj.ej2_instances) return;

														uploadObj.ej2_instances[0].autoUpload = args.checked;
														uploadObj.ej2_instances[0].clearAll();
													} catch (error) {
														Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "onChange", error);
													}
												};
											})();
										</script>

										<script>
											(function() {
												"use strict";

												var L10n = ej.base.L10n;
												L10n.load({
													"pt-BR": {
														"uploader": {
															"invalidMinFileSize": "O tamanho do arquivo é muito pequeno! Somente são aceitos arquivos com mais de 10kb",
															"invalidMaxFileSize": "O tamanho do arquivo excede 4 MB",
															"invalidFileType": "Tipo de arquivo não permitido",
															"Browse": "Procurar...",
															"Clear": "Limpar",
															"Upload": "Upload",
															"dropFilesHint": "Ou solte os arquivos aqui",
															"uploadFailedMessage": "Falha no upload",
															"uploadSuccessMessage": "Upload bem sucedido",
															"removedSuccessMessage": "Remoção bem sucedida",
															"removedFailedMessage": "Não foi possível remover o arquivo",
															"inProgress": "Enviando",
															"readyToUploadMessage": "Pronto para o upload",
															"remove": "Remover",
															"cancel": "Cancelar",
															"delete": "Apagar arquivo",
															"abort": "Abortar",
															"pauseUpload": "Upload pausado",
															"pause": "Pausar",
															"resume": "Continuar",
															"retry": "Tentar novamente",
															"fileUploadCancel": "Upload cancelado"
														},
														"PdfViewer": {
															"PdfViewer": "Visualizador de PDFs",
															"Cancel": "Cancelar",
															"Download file": "Baixar arquivo",
															"Download": "Baixar",
															"Enter Password": "Entre com a senha.",
															"File Corrupted": "Arquivo Corrompido",
															"File Corrupted Content": "Conteúdo de Arquivo Corrompido.",
															"Fit Page": "Página",
															"Fit Width": "Largura",
															"Automatic": "Automático",
															"Go To First Page": "Ir para a Primeira Página",
															"Invalid Password": "Senha Inválida",
															"Next Page": "Próxima Página",
															"OK": "Ok",
															"Open": "Abrir",
															"Page Number": "Número da Página",
															"Previous Page": "Página Anterior",
															"Go To Last Page": "Ir Para a Última Página",
															"Zoom": "Zoom",
															"Zoom In": "Mais Zoom",
															"Zoom Out": "Menos Zoom",
															"Page Thumbnails": "Miniaturas da Página",
															"Bookmarks": "Favoritos",
															"Print": "Imprimir",
															"Password Protected": "Protegido por Senha",
															"Copy": "Copiar",
															"Text Selection": "Seleção de Texto",
															"Panning": "Habilitar Panning",
															"Text Search": "Buscar Texto",
															"Find in document": "Procurar no Documento",
															"Match case": "Diferenciar maiúsc./minúsc.",
															"Apply": "Aplicar",
															"GoToPage": "Ir para a Página",
															"No matches": "Sem combinações",
															"No Text Found": "Texto não encontrado",
															"Undo": "Desfazer",
															"Redo": "Refazer",
															"Annotation": "Anotação",
															"Highlight": "Realçar",
															"Underline": "Sublinhar",
															"Strikethrough": "Tachar",
															"Delete": "Apagar",
															"Opacity": "Opacidade",
															"Color edit": "Editar Cor",
															"Opacity edit": "Editar Opacidade",
															"Highlight context": "Contexto de realce",
															"Underline context": "Contexto de sublinhado",
															"Strikethrough context": "Contexto de tachado",
															"Server error": "Erro no Servidor",
															"Open text": "Abrir",
															"First text": "Primeiro",
															"Previous text": "Anterior",
															"Next text": "Próximo",
															"Last text": "Último",
															"Zoom in text": "Mais Zoom",
															"Zoom out text": "Menos Zoom",
															"Selection text": "Seleção",
															"Pan text": "Pan",
															"Print text": "Imprimir",
															"Search text": "Buscar",
															"Annotation Edit text": "Editar Anotação"
														}
													}
												});
											})();
										</script>
									</div>

									<br />
									<a href="/Veiculo/Upsert?id=@Model.VeiculoObj.Veiculo.VeiculoId"
									   class="btn btn-voltar form-control float-right"
									   style="cursor:pointer; max-width: 250px;"
									   data-ejtip="Voltar para edição do veículo">
										<i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar para o Veículo
									</a>
									<br /><br />
								</main>
							</div>

							<!-- libs -->
							<script src="~/js/site.js" asp-append-version="true"></script>
							<ejs-scripts></ejs-scripts>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		(function() {
			"use strict";

			// Se já existir CRLV, abre o viewer automaticamente
			$(document).ready(function () {
				try {
					console.log("Página abriu");

					if (@Model.CRLV == 1) {
						var div = document.getElementById("divpdf");
						if (div) {
							div.style.visibility = "visible";
							div.style.height = "600px";
						}

						$.ajax({
							url: '/api/PdfViewer/GetDocument?id=@Model.VeiculoObj.Veiculo.VeiculoId',
							method: 'POST',
							cache: false,
							processData: false,
							contentType: false
						})
						.done(function (result) {
							try {
								console.log("Documento carregado (auto).");
								var pdfViewer = document.getElementById('pdfviewer');
								if (pdfViewer && pdfViewer.ej2_instances && pdfViewer.ej2_instances[0]) {
									pdfViewer.ej2_instances[0].load(result, null);
								}
							} catch (error) {
								Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "document.ready.ajax.done", error);
							}
						})
						.fail(function (msg) {
							try {
								console.log('Erro ao carregar documento: ' + (msg && msg.responseText));
								AppToast.show('Vermelho', "Erro ao carregar documento PDF existente.", 2000);
							} catch (error) {
								Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "document.ready.ajax.fail", error);
							}
						});
					}
				} catch (error) {
					Alerta.TratamentoErroComLinha("UploadCRLV.cshtml", "document.ready", error);
				}
			});
		})();
	</script>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
