@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@* ========================================================================================
 * ARQUIVO: Pages/SetorSolicitante/Upsert.cshtml
 * OBJETIVO: Formulario de criacao e edicao de Setores Solicitantes (estrutura organizacional)
 *           com Syncfusion DropDownList hierarquico para selecao de Setor Pai (permite criar
 *           hierarquia Diretoria > Coordenacao > Divisao > Secao), validacao de campos obrigatorios
 *           (codigo, nome, sigla, nivel hierarquico), checkbox status Ativo, sistema para montar
 *           estrutura organizacional completa do orgao.
 * ENTRADAS: Model FrotiX.Pages.SetorSolicitante.UpsertModel (Id, Codigo, Nome, Sigla, NivelHierarquico
 *           1 a 4, IdSetorPai nullable null para raiz, Status), parametro query string id (edicao
 *           carrega dados existentes), ViewData com lista setores para dropdown Setor Pai (exibe
 *           apenas setores de nivel inferior para evitar ciclos), formulario HTML5 com input text
 *           (codigo, nome, sigla), select nivel hierarquico (1 Diretoria, 2 Coordenacao, 3 Divisao,
 *           4 Secao), Syncfusion DropDownList setor pai com autocomplete (opcional para nivel 1,
 *           obrigatorio para niveis 2-4), checkbox status Ativo checked default
 * SAIDAS: Formulario renderizado com campos preenchidos (edicao) ou vazios (criacao), DropDownList
 *         Setor Pai funcional com autocomplete filtrando apenas setores de nivel inferior ao selecionado
 *         (exemplo: se nivel 3 Divisao, dropdown exibe apenas Coordenacoes nivel 2), validacao
 *         HTML5 frontend (required nos campos obrigatorios, validacao customizada nivel hierarquico
 *         vs setor pai), POST /SetorSolicitante/Upsert (submit salva no banco via IUnitOfWork com
 *         validacao backend previne ciclos hierarquicos), redirect para /SetorSolicitante apos
 *         sucesso com AppToast Verde, erro exibe AppToast Vermelho com mensagem detalhada
 * CHAMADA POR: Link /SetorSolicitante/Upsert (criacao novo sem parametro id), link /SetorSolicitante/Upsert?id=X
 *              (edicao carrega dados existentes), botao + Novo Setor da pagina /SetorSolicitante/Index,
 *              botao Editar no TreeGrid hierarquico, UpsertModel.OnGet metodo backend C# executa
 *              (se id presente carrega dados do banco via IUnitOfWork, se ausente retorna model
 *              vazio, carrega lista setores para dropdown Setor Pai filtrando por nivel)
 * CHAMA: setorsolicitante_upsert.js (arquivo JavaScript externo com inicializacao DropDownList
 *        Syncfusion, handlers de validacao customizada nivel hierarquico vs setor pai, mudanca
 *        de nivel hierarquico recarrega dropdown Setor Pai via AJAX filtrando setores validos,
 *        submit handler valida hierarquia antes de enviar), POST /SetorSolicitante/Upsert endpoint
 *        (backend UpsertModel.OnPost recebe FormData, valida codigo unico, valida nivel hierarquico
 *        vs setor pai previne ciclos, salva entidade SetorSolicitante no banco via IUnitOfWork,
 *        retorna JSON success/error), GET /api/SetorSolicitante/GetSetoresByNivel?nivel=X (retorna
 *        JSON lista de setores filtrados por nivel hierarquico para preencher dropdown Setor Pai
 *        dinamicamente), AppToast.show (notificacoes toast Verde sucesso/Vermelho erro)
 * DEPENDENCIAS: ASP.NET Core Razor Pages 8.0, jQuery 3.7.1, Bootstrap 5.3.8 (cards, form-control,
 *               form-label, form-check, grid row/col), Syncfusion EJ2 ASP.NET Core (DropDownList
 *               para Setor Pai com autocomplete e filtragem dinamica por nivel hierarquico),
 *               setorsolicitante_upsert.js (arquivo JavaScript externo), AppToast.js, IUnitOfWork
 * OBSERVACOES: 201 linhas com formulario hierarquico complexo. Sistema permite construir estrutura
 *              organizacional completa do orgao com 4 niveis hierarquicos: Nivel 1 Diretoria (raiz,
 *              IdSetorPai null), Nivel 2 Coordenacao (pai = Diretoria), Nivel 3 Divisao (pai =
 *              Coordenacao), Nivel 4 Secao (pai = Divisao). Validacao previne ciclos: nao permite
 *              setor ser pai de si mesmo, nao permite nivel hierarquico inconsistente com pai
 *              (exemplo: Divisao nivel 3 nao pode ter pai Secao nivel 4). Dropdown Setor Pai
 *              dinamico: mudanca no select Nivel Hierarquico dispara AJAX GET /api/SetorSolicitante/GetSetoresByNivel
 *              recarregando dropdown com apenas setores validos (nivel imediatamente superior).
 *              Sistema CRITICO para organizacao administrativa usado em multiplos modulos do FrotiX.
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@

@model FrotiX.Pages.SetorSolicitante.UpsertModel

@{
	ViewData["Title"] = "Setores Solicitantes";
	ViewData["PageName"] = "setorsolicitante_upsert";
	ViewData["Heading"] = "<i class='fa-duotone fa-building'></i> Cadastros: <span class='fw-300'>Setores Solicitantes</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-building";
}

<style>
	.form-control-xs {
		height: calc(1em + .775rem + 2px) !important;
		padding: .125rem .25rem !important;
		font-size: .75rem !important;
		line-height: 1.5;
		border-radius: .2rem;
	}

	.label {
		margin-bottom: -5px;
		margin-top: 10px;
	}

	input[type=checkbox] {
		vertical-align: middle;
		position: relative;
		bottom: 1px;
	}
</style>

@section HeadBlock {
}

<form method="post" asp-action="Upsert">
	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel">
				<div class="panel-container show">
					<div class="panel-content">
						<div asp-validation-summary="ModelOnly" class="text-danger"></div>

						@if (Model.SetorSolicitanteObj.SetorSolicitanteId != Guid.Empty)
						{
							<input type="hidden" asp-for="SetorSolicitanteObj.SetorSolicitanteId" />
						}

						<div class="col-12 px-3" style="border-bottom:1px solid #325d88">
							<h2 class="text-primary">
								@(Model.SetorSolicitanteObj.SetorSolicitanteId != Guid.Empty ? "Atualizar " : "Criar ")
								Setor Solicitante
							</h2>
						</div>

						<div class="col-12 pt-3">
							<div class="row">
								<div class="col-8 col-md-3">
									<div class="form-group">
										<label class="label font-weight-bold"
											asp-for="SetorSolicitanteObj.Sigla"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="SetorSolicitanteObj.Sigla"></span>
										<input class="form-control form-control-xs" asp-for="SetorSolicitanteObj.Sigla"
											placeholder="Insira a sigla" />
									</div>
								</div>

								<div class="col-12 col-md-6">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="SetorSolicitanteObj.Nome"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="SetorSolicitanteObj.Nome"></span>
										<input class="form-control form-control-xs" asp-for="SetorSolicitanteObj.Nome"
											placeholder="Insira o nome do setor" />
									</div>
								</div>

								<div class="col-8 col-md-2">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="SetorSolicitanteObj.Ramal"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="SetorSolicitanteObj.Ramal"></span>
										<input class="form-control form-control-xs" asp-for="SetorSolicitanteObj.Ramal"
											placeholder="Insira o ramal" />
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-12 col-md-6">
									<div id="ControlRegion">
										<div class="form-control-xs" style="font-size:13px; width:100%;">
											<label style="font-size:13px;" class="label font-weight-bold">Setor Pai (se
												houver)</label>

											<ejs-dropdowntree id="ddtree" placeholder="Selecione um Setor"
												sortOrder="Ascending" showCheckBox="false" allowMultiSelection="false"
												allowFiltering="true" filterType="Contains"
												filterBarPlaceholder="Procurar..." select="select" change="valueChange"
												ejs-for="@Model.SetorSolicitanteObj.SetorPaiId">
												<e-dropdowntree-fields dataSource="@ViewData["dataSource"]"
													value="SetorSolicitanteId" text="Nome" parentValue="SetorPaiId"
													hasChildren="HasChild">
												</e-dropdowntree-fields>
											</ejs-dropdowntree>
										</div>
									</div>
								</div>
							</div>

							<br />
							<br />
							<br />

							<div class="row">
								<div class="col-12">
									<div class="form-group">
										<label class="font-weight-bold" asp-for="SetorSolicitanteObj.Status">
											<span class="text-danger font-weight-light"
												asp-validation-for="SetorSolicitanteObj.Status"></span>
											<input type="checkbox" class="form-check-input"
												asp-for="SetorSolicitanteObj.Status" /> Ativo/Inativo
										</label>
									</div>
								</div>
							</div>

							<br />

							<div class="form-group row">
								<div class="col-12 col-sm-9 col-md-6">
									<div class="row">
										<div class="col-6">
											<button type="submit" value="Submit" asp-page-handler="Submit"
												class="btn btn-azul btn-submit-spin form-control"
												data-ejtip="@(Model.SetorSolicitanteObj.SetorSolicitanteId != Guid.Empty ? "Atualizar Setor Solicitante" : "Criar Setor Solicitante")">
												<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
												@(Model.SetorSolicitanteObj.SetorSolicitanteId != Guid.Empty ?
																								"Atualizar Setor Solicitante" : "Criar Setor Solicitante")
											</button>
										</div>
										<div class="col-6">
											<a asp-page="./Index" class="btn btn-ftx-fechar form-control"
												data-ftx-loading>
												<i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i>
												Cancelar OperaÃ§Ã£o
											</a>
										</div>
									</div>
								</div>
							</div>
						</div> <!-- /.col-12 pt-3 -->
					</div> <!-- /.panel-content -->
				</div> <!-- /.panel-container -->
			</div> <!-- /.panel -->
		</div> <!-- /.col-xl-12 -->
	</div> <!-- /.row -->
</form>

@section ScriptsBlock {
	
	

	<script type="text/javascript">
		$(document).ready(function () {
			try {
				// PrÃ©-seleciona o Setor Pai, se existir
				document.getElementById("ddtree").ej2_instances[0].value = ["@Model.SetorSolicitanteObj.SetorPaiId"];
			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "document.ready", error);
			}
		});
	</script>

	<script type="text/javascript">
		function valueChange() {
			try {
				var ddTreeObj = document.getElementById("ddtree").ej2_instances[0];
				console.info(ddTreeObj.value + " - " + ddTreeObj.text);
			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "valueChange", error);
			}
		}

		function select(args) {
			try {
				var ddTreeObj = document.getElementById("ddtree").ej2_instances[0];
				console.info(ddTreeObj.value + " - " + ddTreeObj.text);
			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "select", error);
			}
		}
	</script>
}
