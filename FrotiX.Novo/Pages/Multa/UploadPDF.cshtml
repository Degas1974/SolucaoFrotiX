@* ****************************************************************************************
 * âš¡ ARQUIVO: Pages/Multa/UploadPDF.cshtml
 * --------------------------------------------------------------------------------------
 * ðŸŽ¯ OBJETIVO     : PÃ¡gina simples para upload de PDF (genÃ©rico - possivelmente obsoleta ou teste)
 * ðŸ“¥ ENTRADAS     : @page, @model UploadPDFModel, Syncfusion Uploader #uploaderPDF (arquivo .pdf), eventos: success, failure, removing
 * ðŸ“¤ SAÃDAS       : POST /Multa/UploadPDF?handler=Save, DELETE /Multa/UploadPDF?handler=Remove, campo #txtArquivo (nome arquivo), PDFViewer #pdfviewer (exibiÃ§Ã£o)
 * ðŸ”— CHAMADA POR  : Possivelmente obsoleta - nÃ£o encontrado link em outros arquivos analisados
 * ðŸ”„ CHAMA        : /Multa/UploadPDF handlers (Save/Remove), /api/MultaPdfViewer (service), /Upload/{filename} (path PDFs)
 * ðŸ“¦ DEPENDÃŠNCIAS : Syncfusion.EJ2 (Uploader, PDFViewer), Bootstrap 5.3.8 (CDN redundante), Microsoft.AspNetCore.Antiforgery, Font Awesome Duotone
 * ðŸ“ OBSERVAÃ‡Ã•ES  : Total: 118 linhas. SUSPEITA: PÃ¡gina genÃ©rica de upload - pode ser removida se nÃ£o usada (verificar rotas/menu), Bootstrap CDN redundante, CSS inline mÃ­nimo (9 linhas) - aceitÃ¡vel, JavaScript inline pequeno (54 linhas) mas poderia ser extraÃ­do - 3 handlers (onUploadSuccess, onUploadFailure, onFileRemoving), Antiforgery token: adiciona via DOMContentLoaded - correto, PDFViewer inicialmente oculto (display:none) - mostra apÃ³s upload bem-sucedido, MELHORIAS: Falta validaÃ§Ã£o de tamanho arquivo, falta feedback visual durante upload (spinner)
 **************************************************************************************** *@
@page
@model FrotiX.Pages.Multa.UploadPDFModel
@using Syncfusion.EJ2

@{
	ViewData["Title"] = "Upload de PDF";
	ViewData["PageName"] = "multa_uploadpdf";
}

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@Html.AntiForgeryToken()

<style>
	.e-upload {
		width: 100%;
		max-width: 500px;
	}

	.e-pv-toolbar {
		border-radius: .25rem;
	}

	#txtArquivo {
		max-width: 420px;
		margin: 10px 0;
	}
</style>

<h2>Upload de PDF</h2>

<div class="row">
	<div class="col-md-8">
		<ejs-uploader id="uploaderPDF"
					  multiple="false"
					  autoUpload="true"
					  allowedExtensions=".pdf"
					  success="onUploadSuccess"
					  failure="onUploadFailure"
					  removing="onFileRemoving">
			<e-uploader-asyncsettings saveUrl="/Multa/UploadPDF?handler=Save"
									  removeUrl="/Multa/UploadPDF?handler=Remove">
			</e-uploader-asyncsettings>
		</ejs-uploader>

		<input type="text" id="txtArquivo" class="form-control" placeholder="nome do arquivo..." readonly />

		<div id="pdfViewerContainer" style="margin-top: 20px;">
			<ejs-pdfviewer id="pdfviewer"
						   style="height:600px;width:100%;display:none;"
						   serviceUrl="/api/MultaPdfViewer">
			</ejs-pdfviewer>
		</div>
	</div>
</div>

@section ScriptsBlock {

	
	

	<script>
		function onUploadSuccess(args) {
			try {
				if (args.operation === 'upload') {
					const file = args.file;
					if (file && file.name) {
						$("#txtArquivo").val(file.name);

						// Carrega o PDF no viewer
						const pdfPath = "/Upload/" + encodeURIComponent(file.name);
						const pdfViewer = document.getElementById('pdfviewer').ej2_instances[0];

						if (pdfViewer) {
							pdfViewer.load(pdfPath, null);
							$("#pdfviewer").show();
						}

                        AppToast.show("Verde", "Upload concluÃ­do com sucesso!", 2000);
					}
				}
			}
			catch (error) {
				Alerta.TratamentoErroComLinha("UploadPDF.cshtml", "onUploadSuccess", error);
			}
		}

		function onUploadFailure(args) {
			try {
                AppToast.show("Vermelho", "Falha no upload do arquivo!", 3000);
			}
			catch (error) {
				Alerta.TratamentoErroComLinha("UploadPDF.cshtml", "onUploadFailure", error);
			}
		}

		function onFileRemoving(args) {
			try {
				$("#txtArquivo").val('');
				$("#pdfviewer").hide();

				const pdfViewer = document.getElementById('pdfviewer').ej2_instances[0];
				if (pdfViewer) {
					pdfViewer.unload();
				}

                AppToast.show("Amarelo", "Arquivo removido.", 2000);
			}
			catch (error) {
				Alerta.TratamentoErroComLinha("UploadPDF.cshtml", "onFileRemoving", error);
			}
		}

		// Adiciona token anti-CSRF aos uploads
		document.addEventListener('DOMContentLoaded', function () {
			try {
				const uploader = document.getElementById('uploaderPDF');
				if (uploader && uploader.ej2_instances && uploader.ej2_instances[0]) {
					uploader.ej2_instances[0].uploading = function (args) {
						const token = document.getElementsByName('__RequestVerificationToken')[0];
						if (token) {
							args.currentRequest.setRequestHeader('RequestVerificationToken', token.value);
						}
					};
				}
			}
			catch (error) {
				Alerta.TratamentoErroComLinha("UploadPDF.cshtml", "DOMContentLoaded", error);
			}
		});
	</script>
}

