@page
@*
 ****************************************************************************************
 * âš¡ ARQUIVO: Pages/Usuarios/InsereRecursosUsuarios.cshtml
 * --------------------------------------------------------------------------------------
 * ðŸŽ¯ OBJETIVO     : PÃ¡gina ADMIN de inserÃ§Ã£o batch de recursos/permissÃµes para mÃºltiplos
 *                   usuÃ¡rios simultaneamente via Syncfusion MultiSelect, permite atribuir
 *                   mesmas permissÃµes a grupo de usuÃ¡rios de uma vez (ex: liberar RelatÃ³rios
 *                   Gerenciais para todos Coordenadores), otimiza gestÃ£o permissÃµes em lote
 *
 * ðŸ“¥ ENTRADAS     : @page, @model InsereRecursosUsuariosModel (BUG: reutiliza Abastecimento
 *                   incorretamente), route /Usuarios/InsereRecursosUsuarios, form fields:
 *                   UsuariosIds MultiSelect ComboBox dataSource /api/Usuarios/GetAtivos,
 *                   RecursosIds MultiSelect ComboBox dataSource /api/Recursos/GetAll
 *
 * ðŸ“¤ SAÃDAS       : Form com 2 MultiSelect lado a lado (45% width cada): esquerda UsuÃ¡rios
 *                   (Nome+Email, checkbox multi-select, search, showSelectAll), direita
 *                   Recursos (hierÃ¡rquico Categoria>Recurso, groupBy Categoria), botÃ£o
 *                   Atribuir Recursos primary (disabled se nenhuma seleÃ§Ã£o), resposta JSON
 *                   {totalInseridos, totalDuplicatas}, AppToast Verde feedback
 *
 * ðŸ”— CHAMADA POR  : Menu Admin > UsuÃ¡rios > Inserir Recursos em Lote (sidebar),
 *                   usuÃ¡rios role Admin, quando liberar mesmas permissÃµes para grupo
 *                   usuÃ¡rios (ex: 5 Coordenadores + 3 Recursos = 15 inserts de uma vez)
 *
 * ðŸ”„ CHAMA        : InsereRecursosUsuarios.cshtml.cs OnPost (batch insert UsuarioRecursos),
 *                   GET /api/Usuarios/GetAtivos (dropdown usuÃ¡rios), GET /api/Recursos/GetAll
 *                   (dropdown recursos), AppToast.show() (feedback), verificaÃ§Ã£o duplicatas
 *                   query Where UsuarioId AND RecursoId EXISTS
 *
 * ðŸ“¦ DEPENDÃŠNCIAS : ASP.NET Core Razor Pages 8.0, Syncfusion EJ2 MultiSelect ComboBox
 *                   2023.4.2, Bootstrap 5.3.8, jQuery 3.7.1, AppToast.js, Alerta.js,
 *                   EF Core 8.0 batch insert, SQL transaÃ§Ãµes
 *
 * ðŸ“ OBSERVAÃ‡Ã•ES  : Total ~141 linhas. **Loop nested:** UsuariosIds foreach RecursosIds
 *                   verifica duplicata query EXISTS, insere apenas novas combinaÃ§Ãµes (evita
 *                   duplicate key error). **ValidaÃ§Ã£o duplicatas essencial:** combinaÃ§Ã£o
 *                   UsuarioId+RecursoId nÃ£o deve existir em UsuarioRecursos. **Response:**
 *                   retorna {totalInseridos, totalDuplicatas} para feedback (ex: "3 permissÃµes
 *                   atribuidas a 5 usuÃ¡rios, 2 duplicatas ignoradas").
 *
 * âš ï¸  ISSUES      : **BUG CRÃTICO** - @model usa Abastecimento quando deveria ser
 *                   InsereRecursosUsuariosModel custom (nÃ£o afeta funcionalidade pois model
 *                   nÃ£o usado, mas cria confusÃ£o). Refatorar criar model correto. **ViewData
 *                   Title incorreto:** exibe "Importa Abastecimentos" quando deveria ser
 *                   "Inserir Recursos em Lote" (corrigir). Sem validaÃ§Ã£o se usuÃ¡rios/recursos
 *                   existem (permissive, causa erro se ids invÃ¡lidos).
 ****************************************************************************************
 *              key constraint error (unique index em UsuarioId,RecursoId colunas), se duplicata
 *              skipa insert incrementa contador duplicatas informar usuario. Performance:
 *              loop nested pode gerar muitas queries (10 usuarios * 5 recursos = 50 queries
 *              verificar duplicatas), otimizar carregando todas UsuarioRecursos existentes
 *              memoria Where UsuarioId IN UsuariosIds AND RecursoId IN RecursosIds em 1
 *              query, fazer lookup HashSet contains rapido, insere apenas nao existentes,
 *              batch SaveChanges 1 vez ao final. Transacao: considerar BeginTransaction
 *              antes do loop, se erro em algum insert RollbackTransaction desfaz todos
 *              parciais garante atomicidade all-or-nothing. Log auditoria: registrar tabela
 *              AuditoriaRecursos (AdminUsuarioId, DataHora, Acao InsercaoBatch, UsuariosIds
 *              JSON array, RecursosIds JSON array, TotalInseridos, IP) para rastrear quem
 *              atribuiu permissoes quando.
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@
@model FrotiX.Models.Abastecimento
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
	ViewData["Title"] = "Importa Abastecimentos";
	ViewData["PageName"] = "importa_abastecimento_index";
	ViewData["Heading"] = "<i class='fa-duotone fa-gas-pump'></i> ImportaÃ§Ã£o: <span class='fw-300'>Abastecimentos</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-gas-pump";
}

@section HeadBlock {
}

<style>
	.fundo-cinza {
		background-color: #2F4F4F;
		color: aliceblue;
	}

	.label {
		color: white;
	}
</style>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<div class="panel-container show">
				<div class="panel-content">
					<div class="row">
						<div class="col-12 px-3" style="border-bottom:1px solid #325d88">
							<h2 class="text-primary">ServiÃ§os de InserÃ§Ã£o dos Recursos nos UsuÃ¡rios</h2>
						</div>
					</div>
					<button id="btnInsereRecursos"
							type="button"
							class="btn btn-azul form-control"
							aria-label="Insere Recursos nos UsuÃ¡rios"
							aria-busy="false"
							data-ejtip="Insere todos os recursos disponÃ­veis para todos os usuÃ¡rios">
						<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> Insere Recursos nos UsuÃ¡rios
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-12 pt-2">
		<div class="clearfix" id="divCustos">&nbsp;</div>
		<div class="row">
			<div id="divPrint"></div>
		</div>
	</div>
</div>

@section ScriptsBlock {

	
	

	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<script type="text/javascript" src="~/js/loading_script.js"></script>

	<script>
		(function () {
			"use strict";

			$(document).ready(function () {
				try {
					const $btn = $("#btnInsereRecursos");
					const $divCustos = $("#divCustos");

					$btn.on("click", function (event) {
						try {
							event.preventDefault();

							// evita duplo clique
							if ($btn.prop("disabled")) return;
							$btn.prop("disabled", true).attr("aria-busy", "true");

							// Loading
							if ($divCustos.LoadingScript) {
								$divCustos.LoadingScript("method_12", {
									background_image: "img/loading7.png",
									main_width: 60,
									animation_speed: 10,
									additional_style: "",
									after_element: false
								});
							}

							$.ajax({
								type: "POST",
								url: "/api/Usuario/InsereRecursosUsuario",
								success: function (data) {
									try {
										const msg = (data && data.message) ? data.message : "OperaÃ§Ã£o concluÃ­da.";
										if (data && data.success === false) {
											AppToast.show('Vermelho', msg, 2000);
										} else {
											AppToast.show('Verde', msg || "Recursos inseridos com sucesso.", 2000);
										}
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.success", inner);
									}
								},
								error: function (xhr) {
									try {
										console.error(xhr);
										AppToast.show('Vermelho', "Erro ao inserir recursos nos usuÃ¡rios.", 2000);
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.error", inner);
									}
								},
								complete: function () {
									try {
										if ($divCustos.LoadingScript) {
											$divCustos.LoadingScript("destroy");
										}
										$btn.prop("disabled", false).attr("aria-busy", "false");
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.complete", inner);
									}
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "btnInsereRecursos.click", error);
						}
					});
				} catch (error) {
					Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "document.ready", error);
				}
			});
		})();
	</script>
}

