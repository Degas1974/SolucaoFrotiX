@*
 * âš¡ ARQUIVO: Pages/Viagens/Upsert.cshtml
 * --------------------------------------------------------------------------------------
 * ðŸŽ¯ OBJETIVO     : FormulÃ¡rio completo criar/editar viagem com campos viagem (data/hora, motorista, veÃ­culo,
 *                   origem, destino, KM), ficha vistoria (imagem preview), descriÃ§Ã£o viagem (Kendo Editor),
 *                   mÃºltiplos modais (ocorrÃªncias, anexos), validaÃ§Ãµes Syncfusion, integraÃ§Ã£o com DocumentEditor
 * ðŸ“¥ ENTRADAS     : @page /Viagens/Upsert, @model UpsertModel, route parameter id para ediÃ§Ã£o (opcional),
 *                   campos viagem (DateTime DataViagem, MotoristaId, VeiculoId, Origem, Destino, KmPercorrido, etc),
 *                   upload ficha vistoria (imagem jpeg base64), input Kendo Editor descriÃ§Ã£o viagem (sfdt format)
 * ðŸ“¤ SAÃDAS       : POST /api/Viagem/Insere ou Edita (JSON), redirect /Viagens/Index, AppToast feedback,
 *                   modal confirmaÃ§Ã£o finalizaÃ§Ã£o com IA validaÃ§Ã£o Z-Score, preview ficha vistoria, campo descriÃ§Ã£o
 *                   texto rico (Kendo DocumentEditor), aÃ§Ãµes CRUD (salvar, cancelar, deletar)
 * ðŸ”— CHAMADA POR  : Viagens/Index (botÃ£o "Nova Viagem", editar linha viagem), menu principal "Cadastros > Viagens > Upsert"
 * ðŸ”„ CHAMA        : /api/Viagem/Insere, /api/Viagem/Edita, /api/Viagem/Detalhes, ~/js/cadastros/viagem_upsert.js
 *                   (JavaScript ~500 linhas - validaÃ§Ãµes, upload ficha, descriÃ§Ã£o SFDT), Kendo Editor (online),
 *                   Syncfusion DropDowns (MotoristaId, VeiculoId, etc), FileUpload (fichaVistoria),
 *                   AppToast feedback (sucesso/erro), FrotiX helpers
 * ðŸ“¦ DEPENDÃŠNCIAS : ASP.NET Core Razor Pages, UpsertModel (code-behind), Syncfusion EJ2 (DropDowns, DatePicker),
 *                   Kendo Mvc (Editor DocumentEditor SFDT editor), Bootstrap 5, jQuery, viagem_upsert.js,
 *                   AppToast.js (notificaÃ§Ãµes), Alerta.js (tratamento erros), FtxSpin (loading),
 *                   Font Awesome Duotone (fa-route, fa-upload-cloud), CSS inline (card padrÃ£o FrotiX, ~400 linhas)
 * ðŸ“ OBSERVAÃ‡Ã•ES  : Total: ~1100 linhas. ISSUES: CSS inline ~400 linhas (extrair em futuro), JavaScript inline ~100 linhas
 *                   (mover para viagem_upsert.js), Kendo Editor SFDT formato Word Document (complexo, UTF8 encoding),
 *                   preview ficha vistoria dinamicamente (base64 ou default image cache-busting), validaÃ§Ãµes mÃºltiplas,
 *                   IA inteligente Z-Score finalizaÃ§Ã£o (integraÃ§Ã£o AI), sem lazy loading descriÃ§Ã£o SFDT editor.
 *                   ViewData: Title "Viagens", PageName "viagens_upsert", Category1 "Cadastros", PageIcon "fa-route"
 *@

@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers
@using Syncfusion.EJ2.DropDowns;
@using Syncfusion.EJ2;
@using Syncfusion.Data;
@using Syncfusion.EJ2.DocumentEditor;
@using Kendo.Mvc.UI;
@using Kendo.Mvc.Extensions;

@model FrotiX.Pages.Viagens.UpsertModel

@{
// DeclaraÃ§Ã£o das variÃ¡veis que vocÃª vai usar no preview
bool hasBytes = Model.ViagemObj.Viagem.FichaVistoria != null;
// Garante que o browser nÃ£o fique carregando uma versÃ£o em cache
string defaultImg = Url.Content("~/Images/FichaAmarelaNova.JPG")
                    + "?t=" + DateTime.Now.Ticks;

// PrÃ©-calcula src da imagem
string imgSrc;

if (hasBytes)
{
imgSrc = "data:image/jpeg;base64,"
         + Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria);
}
else
{
imgSrc = defaultImg;
}
}

@{
string conteudoSfdt = Model.ViagemObj.Viagem.DescricaoViagemWord != null
    ? System.Text.Encoding.UTF8.GetString(Model.ViagemObj.Viagem.DescricaoViagemWord)
    : "";
}

@Html.AntiForgeryToken()

@{
ViewData["Title"] = "Viagens";
ViewData["PageName"] = "viagens_upsert";
ViewData["Heading"] = "";
ViewData["Category1"] = "Cadastros";
ViewData["PageIcon"] = "fa-duotone fa-route";

ViewData["fieldsMotorista"] = new ComboBoxFieldSettings
{
    Text = "Nome",
    Value = "MotoristaId"
};

ViewData["itemTemplate"] = @"
    <div class='d-flex align-items-center'>
        <img src='${Foto}' style='width:40px; height:40px; border-radius:50%; margin-right:10px;' />
        <span>${Nome}</span>
    </div>";

ViewData["valueTemplate"] = @"
    <div class='d-flex align-items-center'>
        <img src='${Foto}' style='width:30px; height:30px; border-radius:50%; margin-right:10px;' />
        <span>${Nome}</span>
    </div>";
}

@section HeadBlock {
	<style>
/* ======== OUTLINE BRANCO NO BOTÃƒO DO HEADER (PadrÃ£o FrotiX) ======== */
		.ftx-card-header .btn-fundo-laranja {
			outline: 2px solid rgba(255, 255, 255, 0.5) !important;
			outline-offset: 1px;
			transition: all 0.2s ease;
		}

		.ftx-card-header .btn-fundo-laranja:hover {
			outline: 2px solid rgba(255, 255, 255, 0.8) !important;
			outline-offset: 2px;
		}

	</style>
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />
    
    <style>
        /* ======== KENDO EDITOR - ESTILOS ======== */
        .k-editor {
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        .k-editor-content {
            min-height: 280px;
        }

        /* Kendo Editor desabilitado */
        .k-editor.k-disabled {
            opacity: 0.65;
            pointer-events: none;
            background-color: #e9ecef;
        }

        .k-editor.k-disabled .k-editor-content {
            background-color: #f5f5f5;
        }

        .k-editor.k-disabled .k-toolbar {
            background-color: #e9ecef;
        }
    </style>
}

<script>
    //============================== FUNÃ‡Ã•ES (JS) ===========================================

    // Evita submissÃ£o de formulÃ¡rios ao pressionar Enter em certos elementos
    function stopEnterSubmitting(e) {
        try {
            const evt = e || window.event;
            if (!evt) return;
            if ((evt.key && evt.key === 'Enter') || evt.keyCode === 13) {
                const src = evt.target || evt.srcElement;
                if (!src || src.tagName.toLowerCase() !== "div") {
                    if (evt.preventDefault) evt.preventDefault();
                    else evt.returnValue = false;
                }
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "stopEnterSubmitting", error);
        }
    }

    // Toolbar do RTE: injeta AntiForgery no upload de imagem
    function toolbarClick(e) {
        try {
            if (e && e.item && e.item.id && e.item.id.indexOf("Image") >= 0) {
                var up = document.getElementById('rte_upload');
                if (up && up.ej2_instances && up.ej2_instances[0]) {
                    up.ej2_instances[0].uploading = function (args) {
                        const token =
                            document.getElementsByName('__RequestVerificationToken')[0]?.value ||
                            document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                        if (token) {
                            args.currentRequest.setRequestHeader('XSRF-TOKEN', token);
                        }
                    };
                }
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "toolbarClick", error);
        }
    }

    // Templates para o ComboBox de Motoristas
    function onCmbMotoristaCreated() {
        try {
            const combo = document.getElementById('cmbMotorista').ej2_instances[0];

            combo.itemTemplate = function (data) {
                let imgSrc = (data.Foto && data.Foto.startsWith('data:image'))
                    ? data.Foto
                    : '/images/barbudo.jpg';
                return `
                <div class="d-flex align-items-center">
                    <img src="${imgSrc}" alt="Foto" style="height:40px; width:40px; border-radius:50%; margin-right:10px;" />
                    <span>${data.Nome}</span>
                </div>`;
            };

            combo.valueTemplate = function (data) {
                if (!data) return '';
                let imgSrc = (data.Foto && data.Foto.startsWith('data:image'))
                    ? data.Foto
                    : '/images/barbudo.jpg';
                return `
                <div class="d-flex align-items-center">
                    <img src="${imgSrc}" alt="Foto" style="height:30px; width:30px; border-radius:50%; margin-right:10px;" />
                    <span>${data.Nome}</span>
                </div>`;
            };
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "onCmbMotoristaCreated", error);
        }
    }

    function lstFinalidade_Change() {
        try {
            try {
                const finalidadeWidget = $("#ddtFinalidade").data("kendoDropDownList");
                const finalidade = finalidadeWidget?.dataItem()?.Descricao;
                const lstEventoWidget = $("#ddtEventos").data("kendoDropDownTree");
                const btnEvento = document.getElementById("btnEvento");

                // Atualiza o campo hidden
                $("#hiddenFinalidade").val(finalidadeWidget?.value() || "");

                if (finalidade === 'Evento') {
                    if (lstEventoWidget) {
                        lstEventoWidget.enable(true);
                    }
                    if (btnEvento) {
                        btnEvento.style.display = "block";
                        // compat Bootstrap 5
                        btnEvento.setAttribute('data-bs-toggle', 'modal');
                        btnEvento.setAttribute('data-bs-target', '#modalEvento');
                    }
                    $(".esconde-diveventos").show();
                } else {
                    if (lstEventoWidget) {
                        lstEventoWidget.enable(false);
                    }
                    if (btnEvento) btnEvento.style.display = "none";
                    $(".esconde-diveventos").hide();
                }
            } catch (error) {
                TratamentoErroComLinha("Viagem_050", "lstFinalidade_Change", error);
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "lstFinalidade_Change", error);
        }
    }

    // Desativa setor ao selecionar motorista
    function MotoristaValueChange() {
        try {
            try {
                const motoristaId = document.getElementById('cmbMotorista').ej2_instances[0]?.value;
                if (!motoristaId) return;

                const setorHost = document.getElementById('ddtSetor'); // CORRIGIDO (era cmbSetor)
                if (setorHost?.ej2_instances?.length) {
                    setorHost.ej2_instances[0].enabled = false;
                    setorHost.ej2_instances[0].dataBind();
                }
            } catch (error) {
                TratamentoErroComLinha("Viagem_050", "MotoristaValueChange", error);
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "MotoristaValueChange", error);
        }
    }

    // Controla habilitaÃ§Ã£o/desabilitaÃ§Ã£o da seÃ§Ã£o de ocorrÃªncias
    function controlarSecaoOcorrencias(veiculoId) {
        try {
            const secao = document.getElementById('secaoOcorrenciasUpsert');
            const btnAdicionar = document.getElementById('btnAdicionarOcorrenciaUpsert');
            const aviso = document.getElementById('avisoSelecionarVeiculo');
            
            if (!secao) return;
            
            // Se viagem finalizada, manter botÃ£o desabilitado sempre
            if (window.viagemFinalizada === true) {
                if (btnAdicionar) btnAdicionar.disabled = true;
                return;
            }
            
            // Normalizar veiculoId - pode ser string, GUID ou null/undefined
            const temVeiculo = veiculoId && 
                               veiculoId !== '' && 
                               veiculoId !== '00000000-0000-0000-0000-000000000000' &&
                               veiculoId !== null &&
                               veiculoId !== undefined;
            
            if (temVeiculo) {
                // VeÃ­culo selecionado - habilitar seÃ§Ã£o
                secao.classList.remove('ftx-section-disabled');
                if (btnAdicionar) btnAdicionar.disabled = false;
                if (aviso) aviso.style.display = 'none';
            } else {
                // Sem veÃ­culo - desabilitar seÃ§Ã£o
                secao.classList.add('ftx-section-disabled');
                if (btnAdicionar) btnAdicionar.disabled = true;
                if (aviso) aviso.style.display = '';
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "controlarSecaoOcorrencias", error);
        }
    }

    // Gatilho ao trocar veÃ­culo - chamado pelo change do combo
    function VeiculoValueChange() {
        try {
            const cmbVeiculo = document.getElementById('cmbVeiculo');
            if (!cmbVeiculo || !cmbVeiculo.ej2_instances || !cmbVeiculo.ej2_instances[0]) return;
            
            let veiculoId = cmbVeiculo.ej2_instances[0].value;
            if (Array.isArray(veiculoId)) {
                veiculoId = veiculoId[0];
            }
            
            // Controlar seÃ§Ã£o de ocorrÃªncias
            controlarSecaoOcorrencias(veiculoId);
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "VeiculoValueChange", error);
        }
    }

    // Gatilho ao trocar requisitante (normal)
    function RequisitanteValueChange() {
        try {
            try {
                const requisitanteId = document.getElementById('cmbRequisitante').ej2_instances[0]?.value;
                if (!requisitanteId) return;
                // Placeholder para lÃ³gica futura
            } catch (error) {
                TratamentoErroComLinha("Viagem_050", "RequisitanteValueChange", error);
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "RequisitanteValueChange", error);
        }
    }

    // Gatilho ao trocar requisitante (evento)
    function RequisitanteEventoValueChange() {
        try {
            try {
                const requisitanteId = document.getElementById('lstRequisitanteEvento').ej2_instances[0]?.value;
                if (!requisitanteId) return;
                // Placeholder para lÃ³gica futura
            } catch (error) {
                TratamentoErroComLinha("Viagem_050", "RequisitanteEventoValueChange", error);
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "RequisitanteEventoValueChange", error);
        }
    }

    function onVeiculoComboCreated() {
        try {
            try {
                var veiculoCombo = document.getElementById('cmbVeiculo').ej2_instances[0];

                veiculoCombo.itemTemplate = function (data) {
                    return '<div class="d-flex align-items-center">' +
                        '<img src="' + (data.Imagem || '/Images/carro.jpg') + '" alt="Imagem" style="height:30px; width:30px; border-radius:5px; margin-right:10px;" />' +
                        '<span>' + data.Descricao + '</span>' +
                        '</div>';
                };

                veiculoCombo.valueTemplate = function (data) {
                    if (!data) return '';
                    return '<div class="d-flex align-items-center">' +
                        '<img src="' + (data.Imagem || '/Images/carro.jpg') + '" alt="Imagem" style="height:30px; width:30px; border-radius:5px; margin-right:10px;" />' +
                        '<span>' + data.Descricao + '</span>' +
                        '</div>';
                };
            } catch (error) {
                TratamentoErroComLinha("Viagem_050", "onVeiculoComboCreated", error);
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "onVeiculoComboCreated", error);
        }
    }

    function onMotoristaChange(args) {
        try {
            const motoristaId = args?.itemData?.MotoristaId;
            if (!motoristaId) return;
            fetch(`/api/Viagem/FotoMotorista?id=${motoristaId}`)
                .then(resp => resp.json())
                .then(data => {
                    if (data.fotoBase64) {
                        const img = document.getElementById("fotoMotorista");
                        if (img) {
                            img.src = data.fotoBase64;
                            img.style.display = 'block';
                        }
                    }
                });
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "onMotoristaChange", error);
        }
    }

    function VisualizaImagem(input) {
        try {
            if (!input.files || !input.files[0]) return;
            var file = input.files[0];
            if (!file.type.startsWith("image/")) {
                alert("Por favor escolha um arquivo de imagem.");
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("imgViewer").src = e.target.result;
            };
            reader.readAsDataURL(file);
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "VisualizaImagem", error);
        }
    }

	// FunÃ§Ã£o para atualizar imagem no modal
	function atualizarImagemModal()
	{
		const imgSrc = document.getElementById('imgViewerItem').src;
		const modalImg = document.getElementById('imgZoomed');
		if (modalImg)
		{
			modalImg.src = imgSrc;
		}
	}

</script>
<script>
    // ---------------- NormalizaÃ§Ã£o e Similaridade ----------------
    function normalize(str) {
        try {
            if (!str) return "";
            return String(str)
                .normalize("NFKC")
                .replace(/[\u200B-\u200D\uFEFF]/g, "")
                .replace(/\u00A0/g, " ")
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[\s\u00A0]+/g, " ")
                .trim();
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "normalize", error);
        }
    }
    function levenshteinRaw(a, b) {
        try {
            const n = a.length, m = b.length;
            if (n === 0) return m;
            if (m === 0) return n;
            const dp = Array.from({ length: n + 1 }, () => new Array(m + 1).fill(0));
            for (let i = 0; i <= n; i++) dp[i][0] = i;
            for (let j = 0; j <= m; j++) dp[0][j] = j;
            for (let i = 1; i <= n; i++) {
                for (let j = 1; j <= m; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    dp[i][j] = Math.min(
                        dp[i - 1][j] + 1,
                        dp[i][j - 1] + 1,
                        dp[i - 1][j - 1] + cost
                    );
                }
            }
            return dp[n][m];
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "levenshteinRaw", error);
        }
    }
    function similarity(a, b) {
        try {
            const na = normalize(a), nb = normalize(b);
            if (!na && !nb) return 1;
            const dist = levenshteinRaw(na, nb);
            const maxLen = Math.max(na.length, nb.length) || 1;
            return 1 - dist / maxLen; // 0..1
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "similarity", error);
        }
    }

    // ---------------- Helpers EJ2 ----------------
    function getCombo(id) {
        try {
            const host = document.getElementById(id);
            return host?.ej2_instances?.[0] ?? null;
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "getCombo", error);
        }
    }
    function extractTexts(items, fields) {
        try {
            const textField = fields?.text;
            if (!Array.isArray(items)) return [];
            if (items.length && (typeof items[0] === "string" || typeof items[0] === "number")) {
                return items.map(x => String(x));
            }
            return items.map(obj => {
                if (!obj) return "";
                if (textField && obj[textField] != null) return String(obj[textField]);
                if (obj.text != null) return String(obj.text);
                if (obj.value != null) return String(obj.value);
                return "";
            }).filter(x => x !== "");
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "extractTexts", error);
        }
    }
    function getMasterTexts(combo) {
        try {
            if (Array.isArray(combo.__masterTexts) && combo.__masterTexts.length) return combo.__masterTexts;
            let texts = extractTexts(combo.listData, combo.fields);
            if (!texts.length) {
                const ds = combo.dataSource;
                texts = extractTexts(ds?.dataSource?.json ?? ds, combo.fields);
            }
            combo.__masterTexts = texts;
            return texts;
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "getMasterTexts", error);
        }
    }
    function wireMasterCache(combo) {
        try {
            if (!combo.__masterTexts || !combo.__masterTexts.length) {
                combo.__masterTexts = getMasterTexts(combo);
            }
            const prev = combo.dataBound;
            combo.dataBound = function () {
                if (typeof prev === "function") prev.apply(combo, arguments);
                if (!combo.__masterTexts || !combo.__masterTexts.length) {
                    combo.__masterTexts = extractTexts(combo.listData, combo.fields);
                }
            };
            combo.dataBind();
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "wireMasterCache", error);
        }
    }

    // ---------------- Alert helpers ----------------
    function alertInfo(titulo, texto, confirm = "OK") {
        try {
            if (typeof Alerta !== "undefined" && Alerta?.Info) Alerta.Info(titulo, texto, confirm);
            else alert(`${titulo}\n\n${texto}`);
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "alertInfo", error);
        }
    }
    function alertWarn(titulo, texto, confirm = "OK") {
        try {
            if (typeof Alerta !== "undefined" && Alerta?.Warning) Alerta.Warning(titulo, texto, confirm);
            else alert(`${titulo}\n\n${texto}`);
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "alertWarn", error);
        }
    }

    // ---------------- ValidaÃ§Ã£o contra a LISTA (usa master) ----------------
    function validarDuplicadoNaLista(combo, opts) {
        try {
            const {
                infoThreshold = 0.85,
                warnThreshold = 0.92,
                confirmarTexto = "OK",
                incluirSugestao = true,
                autoCanonizar = true
            } = opts || {};

            // Se usuÃ¡rio selecionou opÃ§Ã£o da lista, nÃ£o alerta
            if (Number.isInteger(combo.index) && combo.index >= 0) return;

            const digitado = combo.inputElement ? combo.inputElement.value : combo.value;
            const norm = normalize(digitado);
            if (!norm) return;

            const opcoes = getMasterTexts(combo);
            if (!opcoes.length) return;

            // Igualdade exata -> OK
            const existeExato = opcoes.some(o => String(o) === digitado);
            if (existeExato) return;

            // Igualdade normalizada -> canoniza sem alertar
            const mapaNormParaOriginal = new Map();
            for (const o of opcoes) {
                const n = normalize(o);
                if (!mapaNormParaOriginal.has(n)) mapaNormParaOriginal.set(n, o);
            }
            if (mapaNormParaOriginal.has(norm)) {
                const canonico = mapaNormParaOriginal.get(norm);
                if (autoCanonizar && canonico && digitado !== canonico) {
                    combo.inputElement.value = canonico;
                    if ("text" in combo) combo.text = canonico;
                    if ("value" in combo && (typeof combo.value === "string" || combo.value == null)) combo.value = canonico;
                    combo.dataBind?.();
                }
                return;
            }

            // Fuzzy
            let best = { item: null, score: 0 };
            for (const opt of opcoes) {
                const s = similarity(digitado, opt);
                if (s > best.score) best = { item: opt, score: s };
            }
            if (!best.item) return;

            const pct = (best.score * 100).toFixed(0);
            const id = combo.element?.id || "";
            const tituloBase = id === "cmbOrigem" ? "Origem" : id === "cmbDestino" ? "Destino" : "Item";
            const sugestao = incluirSugestao ? `\nSugestÃ£o: â€œ${best.item}â€ (similaridade ${pct}%).` : "";

            if (best.score >= warnThreshold) {
                alertWarn(`ProvÃ¡vel duplicado â€¢ ${tituloBase}`, `Ã‰ muito provÃ¡vel que jÃ¡ exista na lista.${sugestao}`, confirmarTexto);
            } else if (best.score >= infoThreshold) {
                alertInfo(`SemelhanÃ§a alta â€¢ ${tituloBase}`, `Pode jÃ¡ existir algo parecido na lista.${sugestao}`, confirmarTexto);
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "validarDuplicadoNaLista", error);
        }
    }

    // ---------------- ValidaÃ§Ã£o CRUZADA (Origem x Destino) ----------------
    function validarCruzado(origemCombo, destinoCombo, opts) {
        try {
            const { infoThreshold = 0.85, warnThreshold = 0.92, confirmarTexto = "OK" } = opts || {};

            const origem = origemCombo?.inputElement ? origemCombo.inputElement.value : origemCombo?.value;
            const destino = destinoCombo?.inputElement ? destinoCombo.inputElement.value : destinoCombo?.value;

            const norigem = normalize(origem);
            const ndestino = normalize(destino);
            if (!norigem || !ndestino) return;

            const score = norigem === ndestino ? 1 : similarity(norigem, ndestino);
            const pct = (score * 100).toFixed(0);

            if (score >= warnThreshold) {
                alertWarn("Origem e destino muito parecidos", `Os campos parecem referir-se ao mesmo lugar (similaridade ${pct}%).`, confirmarTexto);
            } else if (score >= infoThreshold) {
                alertInfo("Origem e destino semelhantes", `Verifique se sÃ£o realmente distintos (similaridade ${pct}%).`, confirmarTexto);
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "validarCruzado", error);
        }
    }

    // ---------------- Wire dos dois combos ----------------
    (function boot() {
        try {
            function connect(id, peerId, opts) {
                const c = getCombo(id);
                const p = getCombo(peerId);
                if (!c || !c.inputElement) return false;
                wireMasterCache(c);
                c.inputElement.addEventListener("blur", function () {
                    validarDuplicadoNaLista(c, opts);
                    if (p && p.inputElement) validarCruzado(id === "cmbOrigem" ? c : p, id === "cmbOrigem" ? p : c, opts);
                });
                return true;
            }
            function tryWire() {
                const opts = { infoThreshold: 0.85, warnThreshold: 0.92, autoCanonizar: true };
                const okO = connect("cmbOrigem", "cmbDestino", opts);
                const okD = connect("cmbDestino", "cmbOrigem", opts);
                return okO && okD;
            }
            if (!tryWire()) {
                document.addEventListener("DOMContentLoaded", tryWire, { once: true });
                window.addEventListener("load", () => setTimeout(tryWire, 0), { once: true });
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "boot", error);
        }
    })();

    // Fallback opcional se Alerta nÃ£o estiver carregado
    window.Alerta = window.Alerta || {
        Info: (t, x) => alert(`${t}\n\n${x}`),
        Warning: (t, x) => alert(`${t}\n\n${x}`)
    };

    // ====== Modal de Zoom: carrega a imagem ampliada ======
    document.addEventListener('DOMContentLoaded', function () {
        try {
            var mz = document.getElementById('modalZoom');
            if (mz) {
                mz.addEventListener('show.bs.modal', function () {
                    var src = document.getElementById('imgViewer')?.getAttribute('src') || '';
                    var target = document.getElementById('imgZoomed');
                    if (target) target.setAttribute('src', src);
                });
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalZoom.DCL", error);
        }
    });
</script>

<style>
    /* Header usa padrÃ£o global .ftx-card-header do frotix.css */

    /* ======== SEÃ‡Ã•ES TEMÃTICAS ======== */
    .ftx-section {
        background: linear-gradient(135deg, #fafbfc 0%, #f5f6f7 100%);
        border-radius: 10px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.25rem;
        border: 1px solid rgba(0,0,0,0.06);
        border-left: 4px solid #6c757d;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .ftx-section-title {
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px dashed rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .ftx-section-title i {
        font-size: 1.1rem;
        opacity: 0.85;
    }

    /* Cores das seÃ§Ãµes */
    .ftx-section-periodo { border-left-color: #325d88; }
    .ftx-section-periodo .ftx-section-title { color: #325d88; }

    .ftx-section-trajeto { border-left-color: #2e7d32; }
    .ftx-section-trajeto .ftx-section-title { color: #2e7d32; }

    .ftx-section-evento { border-left-color: #7b1fa2; }
    .ftx-section-evento .ftx-section-title { color: #7b1fa2; }

    .ftx-section-veiculo { border-left-color: #ef6c00; }
    .ftx-section-veiculo .ftx-section-title { color: #ef6c00; }

    .ftx-section-combustivel { border-left-color: #c62828; }
    .ftx-section-combustivel .ftx-section-title { color: #c62828; }

    .ftx-section-solicitante { border-left-color: #00695c; }
    .ftx-section-solicitante .ftx-section-title { color: #00695c; }

    .ftx-section-descricao { border-left-color: #37474f; }
    .ftx-section-descricao .ftx-section-title { color: #37474f; }

    /* ======== Labels e Inputs melhorados ======== */
    .ftx-label {
        font-weight: 600;
        font-size: 0.8rem;
        color: #495057;
        margin-bottom: 0.35rem;
        display: block;
    }

    .ftx-label .text-danger {
        font-size: 0.9em;
    }

    /* Inputs maiores */
    .ftx-section .form-control,
    .ftx-section .e-input-group,
    .ftx-section .e-control-wrapper,
    .ftx-section .e-ddl,
    .ftx-section .e-ddt {
        height: 38px !important;
        min-height: 38px !important;
        font-size: 0.9rem !important;
    }

    /* CorreÃ§Ã£o das bordas dos controles Syncfusion */
    .e-input-group,
    .e-input-group.e-control-wrapper,
    .e-ddl.e-input-group,
    .e-dropdowntree.e-input-group,
    .e-ddt.e-input-group {
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem !important;
    }

    /* ForÃ§a a linha de borda dos controles Syncfusion */
    .e-float-line::before,
    .e-float-line::after {
        background: #ced4da !important;
        height: 1px !important;
    }

    .e-input-group .e-float-line,
    .e-ddl .e-float-line,
    .e-dropdowntree .e-float-line,
    .e-ddt .e-float-line {
        border-bottom: 1px solid #ced4da !important;
    }

    .e-input-group:focus-within,
    .e-ddl.e-input-group:focus-within,
    .e-dropdowntree.e-input-group:focus-within,
    .e-ddt.e-input-group:focus-within {
        border-color: #325d88 !important;
        box-shadow: 0 0 0 0.2rem rgba(50, 93, 136, 0.15) !important;
    }

    .e-input-group:focus-within .e-float-line::before,
    .e-input-group:focus-within .e-float-line::after {
        background: #325d88 !important;
    }

    .ftx-section .form-control:focus {
        border-color: #325d88;
        box-shadow: 0 0 0 0.2rem rgba(50, 93, 136, 0.15);
    }

    /* Valor calculado em destaque - cor sÃ³lida intermediÃ¡ria */
    .ftx-calculated {
        background-color: #c9e0f5 !important;
        border: 1px solid #90caf9;
        font-weight: 600;
        color: #1565c0;
    }

    /* Form group com espaÃ§amento adequado */
    .ftx-section .form-group {
        margin-bottom: 0.75rem;
    }

    .ftx-section .row {
        margin-bottom: 0.5rem;
    }

    /* ======== Inputs e Layout (legado - manter compatibilidade) ======== */
    .form-control-xs {
        height: 38px !important;
        padding: .375rem .5rem !important;
        font-size: .875rem !important;
        line-height: 1.5;
        border-radius: .25rem;
    }

    .label {
        font-weight: 600;
        font-size: 0.8rem;
        color: #495057;
        margin-bottom: 0.35rem;
        margin-top: 0;
    }

    .label i {
        display: none; /* Esconde Ã­cones individuais das labels */
    }

    input[type=checkbox] {
        vertical-align: middle;
        position: relative;
        bottom: 1px;
    }

    .esconde-diveventos {
        display: none;
    }

    .bottom-space {
        margin-bottom: 2rem;
    }

    .icon-space {
        margin-right: 10px;
        display: inline-flex;
        align-items: center;
    }

    img[alt="Foto"]:not([src]) {
        display: none;
    }

    .modal-divider {
        height: 1px;
        border: none;
        background-color: #dee2e6;
        margin: 0.5rem 0;
    }

    /* ======== BotÃµes customizados ======== */
    .btn-vinho {
        background-color: #c82333 !important;
        color: #fff !important;
        border: 1px solid #bd2130 !important;
        transition: background-color 0.2s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        text-decoration: none;
    }
        .btn-vinho:hover,
        .btn-vinho:focus,
        .btn-vinho:active,
        .btn-vinho:focus-visible {
            background-color: #a71d2a !important;
            border-color: #a71d2a !important;
            color: #fff !important;
            outline: none !important;
            box-shadow: none !important;
        }

    .custom-blue-btn {
        background-color: #6c87a3 !important;
        color: #fff !important;
        border: 1px solid #5c748f !important;
        transition: background-color 0.2s ease;
        display: flex;
        justify-content: center;
        align-items: center;
    }
        .custom-blue-btn:hover,
        .custom-blue-btn:focus,
        .custom-blue-btn:active,
        .custom-blue-btn:focus-visible {
            background-color: #5c748f !important;
            color: #fff !important;
            border-color: #5c748f !important;
            outline: none !important;
            box-shadow: none !important;
        }

    /* BotÃ£o primÃ¡rio usado nos modais desta pÃ¡gina */
    .custom-primary-btn {
        background-color: #0d6efd !important;
        color: #fff !important;
        border: 1px solid #0b5ed7 !important;
        transition: background-color .2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .5rem;
    }
        .custom-primary-btn:hover,
        .custom-primary-btn:focus {
            background-color: #0b5ed7 !important;
            border-color: #0a58ca !important;
            color: #fff !important;
        }
        .custom-primary-btn .btn-inner i { font-size: 1rem; }

    /* ======== Syncfusion ComboBox personalizado (motorista) ======== */
    .cmbMotorista_popup .e-dropdownbase .e-list-item {
        min-height: 60px;
        display: flex;
        align-items: center;
        padding-left: 10px;
        transition: background-color 0.3s;
    }
        .cmbMotorista_popup .e-dropdownbase .e-list-item img {
            height: 45px;
            width: 45px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }
        .cmbMotorista_popup .e-dropdownbase .e-list-item:hover {
            background-color: #f0f8ff;
        }
    #cmbMotorista_popup .e-dropdownbase .e-list-item:hover img {
        transform: scale(1.2);
    }
    .cmbMotorista .e-input-group .e-input,
    .cmbMotorista .e-control-wrapper .e-input {
        display: flex;
        align-items: center;
    }
        .cmbMotorista .e-input-group .e-input img,
        .cmbMotorista .e-control-wrapper .e-input img {
            height: 30px;
            width: 30px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 8px;
        }
            /* BalÃ£o laranja bonitÃ£o */
    .e-tooltip-wrap,
    .e-tooltip-wrap.custom-orange-tooltip,
    .e-tooltip-wrap.tooltip-laranja {
        background-color: orange !important;
        color: #fff !important;
        border-radius: 8px !important;
        padding: 8px 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        font-family: 'Segoe UI', sans-serif;
        font-size: 0.95rem;
        z-index: 99999 !important;
    }
        .e-tooltip-wrap .e-tip-content,
        .e-tooltip-wrap.custom-orange-tooltip .e-tip-content,
        .e-tooltip-wrap.tooltip-laranja .e-tip-content {
            color: #fff !important;
            font-weight: 500;
            line-height: 1.4;
            background-color: transparent !important;
        }
        .e-tooltip-wrap .e-tip-arrow,
        .e-tooltip-wrap.custom-orange-tooltip .e-tip-arrow,
        .e-tooltip-wrap.tooltip-laranja .e-tip-arrow {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            width: auto !important;
            height: auto !important;
            min-width: 0 !important;
            min-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .e-tooltip-wrap .e-arrow-tip-inner,
        .e-tooltip-wrap.custom-orange-tooltip .e-arrow-tip-inner,
        .e-tooltip-wrap.tooltip-laranja .e-arrow-tip-inner {
            background: orange !important;
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
        }
        .e-tooltip-wrap .e-tip-arrow svg,
        .e-tooltip-wrap.custom-orange-tooltip .e-tip-arrow svg,
        .e-tooltip-wrap.tooltip-laranja .e-tip-arrow svg {
            display: none !important;
        }
        .e-tooltip-wrap .e-tip-arrow::before,
        .e-tooltip-wrap .e-tip-arrow::after,
        .e-tooltip-wrap .e-arrow-tip-inner::before,
        .e-tooltip-wrap .e-arrow-tip-inner::after {
            background: none !important;
            border: none !important;
            content: none !important;
            box-shadow: none !important;
            outline: none !important;
        }

    /* ======== ZOOM â€“ botÃ£o na imagem ======== */
    .img-zoom-wrapper {
        position: relative;
        display: inline-block;
        width: fit-content;
        inline-size: fit-content;
        width: -moz-fit-content;
    }
    .zoom-btn {
        position: absolute;
        left: -18px;
        bottom: 18px;
        width: 44px;
        height: 44px;
        border: 3px solid #fff;
        outline: none;
        cursor: pointer;
        background: #ff7a00;
        color: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0,0,0,.25);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, filter .12s ease;
        z-index: 2;
    }
        .zoom-btn:hover {
            transform: translateY(-1px);
            background: #ff8f26;
            box-shadow: 0 0 0 3px rgba(255,122,0,.25), 0 8px 18px rgba(0,0,0,.3);
            filter: saturate(1.05);
        }
        .zoom-btn .fa-duotone {
            --fa-primary-color: #ffffff;
            --fa-secondary-color: rgba(255,255,255,.75);
            --fa-secondary-opacity: 1;
            font-size: 1.15rem;
            line-height: 1;
        }

    .modal-zoom {
        max-width: 960px;
    }
    #modalZoom .modal-body {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: .75rem;
    }
    #imgZoomed {
        max-width: 920px;
        width: 100%;
        height: auto;
        max-height: 120vh;
        object-fit: contain;
        cursor: zoom-out;
    }
    .modal-close-floating {
        position: absolute;
        top: .5rem;
        right: .5rem;
        z-index: 5;
        filter: drop-shadow(0 1px 3px rgba(0,0,0,.35));
    }

    /* ValidaÃ§Ã£o sutil */
    :root {
        --ftx-invalid: #dc3545;
        --ftx-glow: rgba(220,53,69,.18);
        --ftx-glow-focus: rgba(220,53,69,.28);
    }
    input.is-invalid,
    textarea.is-invalid {
        border-color: var(--ftx-invalid) !important;
        box-shadow: 0 0 0 .2rem var(--ftx-glow);
        color: var(--ftx-invalid) !important;
    }
        input.is-invalid:focus,
        textarea.is-invalid:focus {
            box-shadow: 0 0 0 .28rem var(--ftx-glow-focus);
        }
    .e-input-group.is-invalid,
    .e-float-input.is-invalid,
    .e-control-wrapper.is-invalid {
        box-shadow: 0 0 0 .2rem var(--ftx-glow);
        border-radius: .25rem;
    }
        .e-input-group.is-invalid:focus-within,
        .e-float-input.is-invalid:focus-within,
        .e-control-wrapper.is-invalid:focus-within {
            box-shadow: 0 0 0 .28rem var(--ftx-glow-focus);
        }
        .e-input-group.is-invalid .e-input,
        .e-float-input.is-invalid input,
        .e-control-wrapper.is-invalid input {
            border-color: var(--ftx-invalid) !important;
            color: var(--ftx-invalid) !important;
        }
        .e-float-input.is-invalid label.e-float-text,
        .e-float-input.is-invalid .e-float-line {
            color: var(--ftx-invalid) !important;
            border-color: var(--ftx-invalid) !important;
        }


    #imgViewerItem {
        display: block;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* ===== BADGES DE OCORRÃŠNCIA ===== */
    .ftx-ocorrencia-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 70px;
        padding: 0.25rem 0.6rem;
        border-radius: 50px;
        color: #fff !important;
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }

    .ftx-ocorrencia-badge-aberta {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        box-shadow: 0 2px 6px rgba(39, 174, 96, 0.35);
    }

    .ftx-ocorrencia-badge-baixada {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        box-shadow: 0 2px 6px rgba(127, 140, 141, 0.35);
    }

    .ftx-ocorrencia-badge-pendente {
        background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        box-shadow: 0 2px 6px rgba(255, 165, 0, 0.35);
    }

    .ftx-ocorrencia-badge-manutencao {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        box-shadow: 0 2px 6px rgba(52, 152, 219, 0.35);
    }
</style>

<!-- FORM PRINCIPAL (MVC) -->
<form method="post" asp-action="Upsert" onkeypress="stopEnterSubmitting(event)" enctype="multipart/form-data">
    <!-- Utiliza container-fluid para maior largura e alinhamento Ã  esquerda -->
    <div class="container-fluid" style="padding-left: 0; margin-left: 0;">
        <div class="row">
            <div class="col-xl-12">
                <div id="panel-1" class="panel ftx-card-styled">
                    <div class="panel-container show">
                        
                        <!-- HEADER DO CARD -->
                        <div class="ftx-card-header">
                            @if (Model.ViagemObj.Viagem.Status == "Realizada" || Model.ViagemObj.Viagem.Status == "Cancelada")
                            {
                                <h2 class="titulo-paginas">
                                    <i class="fa-duotone fa-suitcase-rolling"></i>
                                    Viagem Realizada/Cancelada - EdiÃ§Ã£o nÃ£o permitida
                                </h2>
                            }
                            else
                            {
                                <h2 class="titulo-paginas">
                                    <i class="fa-duotone fa-suitcase-rolling"></i>
                                    @(Model.ViagemObj.Viagem.ViagemId != Guid.Empty ? "Atualizar" : "Criar") Viagem
                                </h2>
                            }
                            <div class="ftx-card-actions">
                                <a href="javascript:void(0)" class="btn btn-fundo-laranja" id="btnVoltarLista" data-ftx-loading>
                                    <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i>
                                    Voltar Ã  Lista
                                </a>
                            </div>
                        </div>

                        <div id="divPainel" class="panel-content">
                            @{
                                // Verificar se viagem estÃ¡ finalizada (Realizada ou Cancelada)
                                bool viagemFinalizada = Model.ViagemObj?.Viagem?.Status == "Realizada" || 
                                                       Model.ViagemObj?.Viagem?.Status == "Cancelada";
                            }
                            <input type="hidden" asp-for="@Model.ViagemObj.Viagem.ViagemId" id="txtViagemId" />

                            <!-- Campo hidden para manter a imagem existente caso nÃ£o haja novo upload -->
                            @if (Model.ViagemObj?.Viagem?.FichaVistoria != null)
                            {
                            <input type="hidden"
                                   asp-for="FichaVistoria"
                                   value="@Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria)" />
                            }

                            <div class="p-3">

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 1: PERÃODO DA VIAGEM
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-periodo">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-calendar-range"></i>
                                        PerÃ­odo da Viagem
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.NoFichaVistoria">
                                                NÂº Ficha Vistoria
                                            </label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.NoFichaVistoria"></span>
                                            @* Container para alternar entre campo numÃ©rico e texto mobile*@
                                            @{
                                                // Determinar se Ã© nova viagem ou ediÃ§Ã£o
                                                bool isNovaViagem = Model.ViagemObj?.Viagem?.ViagemId == null || 
                                                                    Model.ViagemObj.Viagem.ViagemId == Guid.Empty;
                                                // Se Ã© ediÃ§Ã£o, verificar se Ã© viagem mobile (NoFichaVistoria = 0 ou null)
                                                bool isViagemMobile = !isNovaViagem && 
                                                                      (Model.ViagemObj?.Viagem?.NoFichaVistoria == null || 
                                                                       Model.ViagemObj.Viagem.NoFichaVistoria == 0);
                                                // Mostrar campo numÃ©rico se: nova viagem OU ediÃ§Ã£o de viagem web
                                                bool mostrarCampoNumerico = isNovaViagem || !isViagemMobile;
                                            }
                                            <div id="containerNoFichaVistoria">
                                                <input id="txtNoFichaVistoria" 
                                                       class="form-control" 
                                                       asp-for="ViagemObj.Viagem.NoFichaVistoria"
                                                       style="@(mostrarCampoNumerico ? "" : "display: none;")" />
                                                <input id="txtNoFichaVistoriaMobile" 
                                                       class="form-control ftx-calculated" 
                                                       value="(mobile)" 
                                                       disabled 
                                                       style="@(mostrarCampoNumerico ? "display: none;" : "")"
                                                       title="Viagem registrada via FrotiX Mobile" />
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.DataInicial">
                                                Data Inicial
                                            </label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.DataInicial"></span>
                                            <input id="txtDataInicial" class="form-control" asp-for="ViagemObj.Viagem.DataInicial" type="date" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.HoraInicio">
                                                Hora InÃ­cio
                                            </label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.HoraInicio"></span>
                                            <input id="txtHoraInicial" class="form-control" asp-for="ViagemObj.Viagem.HoraInicio" type="time" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.DataFinal">
                                                Data Final
                                            </label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.DataFinal"></span>
                                            <input id="txtDataFinal" class="form-control" asp-for="ViagemObj.Viagem.DataFinal" type="date" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.HoraFim">
                                                Hora Fim
                                            </label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.HoraFim"></span>
                                            <input id="txtHoraFinal" class="form-control" asp-for="ViagemObj.Viagem.HoraFim" type="time" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label">DuraÃ§Ã£o</label>
                                            <input id="txtDuracao" class="form-control ftx-calculated" disabled 
                                                   data-ejtip="Se a <span style='color: #A0522D; font-weight: bold;'>DuraÃ§Ã£o</span> estiver alta, revise o horÃ¡rio e datas" />
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 2: TRAJETO
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-trajeto">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-route"></i>
                                        Trajeto
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-4">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.Finalidade">Finalidade</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.Finalidade"></span>
                                            @(Html.Kendo().DropDownList()
                                                .Name("ddtFinalidade")
                                                .DataTextField("Descricao")
                                                .DataValueField("FinalidadeId")
                                                .OptionLabel("Escolha a Finalidade...")
                                                .Filter("contains")
                                                .Height(200)
                                                .HtmlAttributes(new { style = "width: 100%" })
                                                .BindTo((System.Collections.IEnumerable)ViewData["dataFinalidade"])
                                                .Value(Model.ViagemObj.Viagem.Finalidade)
                                                .Events(e => e.Change("lstFinalidade_Change"))
                                                .Deferred()
                                            )
                                            <input type="hidden" asp-for="ViagemObj.Viagem.Finalidade" id="hiddenFinalidade" />
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.Origem">Origem</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.Origem"></span>
                                            <ejs-combobox id="cmbOrigem" ejs-for="ViagemObj.Viagem.Origem"
                                                          dataSource="@ViewData["ListaOrigem"]"
                                                          placeholder="Selecione ou digite a Origem"
                                                          allowFiltering="true" filterType="Contains"
                                                          allowCustom="true" popupHeight="220px">
                                            </ejs-combobox>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.Destino">Destino</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.Destino"></span>
                                            <ejs-combobox id="cmbDestino" ejs-for="ViagemObj.Viagem.Destino"
                                                          dataSource="@ViewData["ListaDestino"]" placeholder="Selecione ou digite o destino"
                                                          allowFiltering="true" filterType="Contains" allowCustom="true" popupHeight="220px">
                                            </ejs-combobox>
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO EVENTO (ESCONDIDA - aparece quando finalidade = Evento)
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div id="divEvento" class="ftx-section ftx-section-evento esconde-diveventos">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-calendar-star"></i>
                                        Evento
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-6">
                                            <label class="ftx-label">Nome do Evento</label>
                                            <div class="d-flex align-items-end gap-2">
                                                <div class="flex-grow-1">
                                                    <ejs-dropdowntree id="ddtEventos" placeholder="Selecione um Evento..."
                                                                      showCheckBox="false" allowMultiSelection="false"
                                                                      allowFiltering="true" filterType="Contains"
                                                                      filterBarPlaceholder="Procurar..."
                                                                      ejs-for="@Model.ViagemObj.Viagem.EventoId" popupHeight="200px"
                                                                      sortOrder="Ascending">
                                                        <e-dropdowntree-fields dataSource="@ViewData["dataEvento"]" value="EventoId" text="Nome"></e-dropdowntree-fields>
                                                    </ejs-dropdowntree>
                                                </div>
                                                <a class="btn btn-sm fundo-chocolate text-white"
                                                   id="btnEvento"
                                                   style="height: 38px; display: flex; align-items: center;"
                                                   title="Adicionar Evento"
                                                   data-bs-toggle="modal" data-bs-target="#modalEvento">
                                                    <i class="fa-duotone fa-calendar-plus"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 3: MOTORISTA E VEÃCULO
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-veiculo">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-car-side"></i>
                                        Motorista e VeÃ­culo
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">Motorista</label>
                                            <ejs-combobox id="cmbMotorista"
                                                          placeholder="Selecione um Motorista"
                                                          ejs-for="@Model.ViagemObj.Viagem.MotoristaId"
                                                          allowFiltering="true"
                                                          filterType="Contains"
                                                          popupHeight="200px"
                                                          width="100%"
                                                          showClearButton="true"
                                                          dataSource="@ViewData["dataMotorista"]"
                                                          created="onCmbMotoristaCreated"
                                                          change="MotoristaValueChange">
                                                <e-combobox-fields text="Nome" value="MotoristaId"></e-combobox-fields>
                                            </ejs-combobox>
                                        </div>
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">VeÃ­culo</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="flex-grow-1">
                                                    <ejs-combobox id="cmbVeiculo" placeholder="Selecione um VeÃ­culo"
                                                                  allowFiltering="true" filterType="Contains"
                                                                  dataSource="@ViewData["dataVeiculo"]" popupHeight="200px"
                                                                  width="100%" showClearButton="true"
                                                                  ejs-for="@Model.ViagemObj.Viagem.VeiculoId" 
                                                                  change="VeiculoValueChange">
                                                        <e-combobox-fields text="Descricao" value="VeiculoId"></e-combobox-fields>
                                                    </ejs-combobox>
                                                </div>
                                                <!-- BotÃ£o OcorrÃªncias - QUADRADO 42x42 -->
                                                <button type="button"
                                                        id="btnOcorrenciasVeiculo"
                                                        class="btn btn-ocorrencias-viagem text-white disabled"
                                                        disabled
                                                        title="Nenhuma ocorrÃªncia em aberto"
                                                        style="position: relative; flex-shrink: 0; width: 42px; height: 42px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fa-duotone fa-car-burst" style="font-size: 1.2rem;"></i>
                                                    <span id="badgeOcorrenciasVeiculo"
                                                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                                          style="display: none; font-size: 0.65rem;">
                                                        0
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Km Atual - MENOR (col-4 ao invÃ©s de col-6) -->
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.KmAtual">Km Atual</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.KmAtual"></span>
                                            <input readonly id="txtKmAtual" class="form-control ftx-calculated" asp-for="ViagemObj.Viagem.KmAtual" />
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.KmInicial">Km Inicial</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.KmInicial"></span>
                                            <input id="txtKmInicial" class="form-control" asp-for="ViagemObj.Viagem.KmInicial" type="number" />
                                        </div>
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.KmFinal">Km Final</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.KmFinal"></span>
                                            <input id="txtKmFinal" class="form-control" asp-for="ViagemObj.Viagem.KmFinal" type="number" />
                                        </div>
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label">Km Percorrido</label>
                                            <input id="txtKmPercorrido"
                                                   class="form-control ftx-calculated"
                                                   type="number"
                                                   disabled
                                                   data-ejtip="Se a <span style='color: #A0522D; font-weight: bold;'>Quilometragem</span> estiver alta, revise os Km Inicial e Final" />
                                        </div>
                                    </div>
                                </div>
                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 4: COMBUSTÃVEL
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-combustivel">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-gas-pump"></i>
                                        CombustÃ­vel
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <label class="ftx-label ftx-required">CombustÃ­vel Inicial</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.CombustivelInicial"></span>
                                            @(Html.Kendo().DropDownList()
                                                .Name("ddtCombustivelInicial")
                                                .DataTextField("Descricao")
                                                .DataValueField("Nivel")
                                                .BindTo((System.Collections.IEnumerable)ViewData["dataCombustivel"])
                                                .Height(200)
                                                .HtmlAttributes(new { style = "width: 100%" })
                                                .Value(Model.ViagemObj.Viagem.CombustivelInicial)
                                                .Template("<div style='display: flex; align-items: center;'>" +
                                                          "<img src='#: Imagem #' style='width: 24px; height: 24px; margin-right: 8px;' />" +
                                                          "<span>#: Descricao #</span>" +
                                                          "</div>")
                                                .ValueTemplate("<div style='display: flex; align-items: center;'>" +
                                                               "<img src='#: Imagem #' style='width: 20px; height: 20px; margin-right: 8px;' />" +
                                                               "<span>#: Descricao #</span>" +
                                                               "</div>")
                                                .Deferred()
                                            )
                                            <input type="hidden" asp-for="ViagemObj.Viagem.CombustivelInicial" id="hiddenCombustivelInicial" />
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <label class="ftx-label">CombustÃ­vel Final</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.CombustivelFinal"></span>
                                            @(Html.Kendo().DropDownList()
                                                .Name("ddtCombustivelFinal")
                                                .DataTextField("Descricao")
                                                .DataValueField("Nivel")
                                                .BindTo((System.Collections.IEnumerable)ViewData["dataCombustivel"])
                                                .Height(200)
                                                .HtmlAttributes(new { style = "width: 100%" })
                                                .Value(Model.ViagemObj.Viagem.CombustivelFinal)
                                                .Template("<div style='display: flex; align-items: center;'>" +
                                                          "<img src='#: Imagem #' style='width: 24px; height: 24px; margin-right: 8px;' />" +
                                                          "<span>#: Descricao #</span>" +
                                                          "</div>")
                                                .ValueTemplate("<div style='display: flex; align-items: center;'>" +
                                                               "<img src='#: Imagem #' style='width: 20px; height: 20px; margin-right: 8px;' />" +
                                                               "<span>#: Descricao #</span>" +
                                                               "</div>")
                                                .Deferred()
                                            )
                                            <input type="hidden" asp-for="ViagemObj.Viagem.CombustivelFinal" id="hiddenCombustivelFinal" />
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 4B: DOCUMENTOS E ITENS ENTREGUES
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-documentos">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-box-check"></i>
                                        Documentos e Itens Entregues
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusDocumento" name="ViagemObj.Viagem.StatusDocumento" 
                                                       value="@(Model.ViagemObj?.Viagem?.StatusDocumento == "Entregue" ? "Entregue" : "")" />
                                                <input class="form-check-input" type="checkbox" id="chkStatusDocumento" 
                                                       @(Model.ViagemObj?.Viagem?.StatusDocumento == "Entregue" ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidStatusDocumento').value = this.checked ? 'Entregue' : '';">
                                                <label class="form-check-label fw-semibold" for="chkStatusDocumento">
                                                    <i class="fa-duotone fa-file-check me-1 text-success"></i>
                                                    Documento Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusCartaoAbastecimento" name="ViagemObj.Viagem.StatusCartaoAbastecimento" 
                                                       value="@(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimento == "Entregue" ? "Entregue" : "")" />
                                                <input class="form-check-input" type="checkbox" id="chkStatusCartaoAbastecimento" 
                                                       @(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimento == "Entregue" ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidStatusCartaoAbastecimento').value = this.checked ? 'Entregue' : '';">
                                                <label class="form-check-label fw-semibold" for="chkStatusCartaoAbastecimento">
                                                    <i class="fa-duotone fa-credit-card me-1 text-success"></i>
                                                    CartÃ£o Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCintaEntregue" name="ViagemObj.Viagem.CintaEntregue" 
                                                       value="@(Model.ViagemObj?.Viagem?.CintaEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCintaEntregue" 
                                                       @(Model.ViagemObj?.Viagem?.CintaEntregue == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidCintaEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCintaEntregue">
                                                    <i class="fa-duotone fa-link me-1 text-info"></i>
                                                    Cinta Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidTabletEntregue" name="ViagemObj.Viagem.TabletEntregue" 
                                                       value="@(Model.ViagemObj?.Viagem?.TabletEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkTabletEntregue" 
                                                       @(Model.ViagemObj?.Viagem?.TabletEntregue == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidTabletEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkTabletEntregue">
                                                    <i class="fa-duotone fa-tablet me-1 text-info"></i>
                                                    Tablet Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidArlaEntregue" name="ViagemObj.Viagem.ArlaEntregue" 
                                                       value="@(Model.ViagemObj?.Viagem?.ArlaEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkArlaEntregue" 
                                                       @(Model.ViagemObj?.Viagem?.ArlaEntregue == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidArlaEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkArlaEntregue">
                                                    <i class="fa-duotone fa-tint me-1 text-info"></i>
                                                    Arla Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCaboEntregue" name="ViagemObj.Viagem.CaboEntregue" 
                                                       value="@(Model.ViagemObj?.Viagem?.CaboEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCaboEntregue" 
                                                       @(Model.ViagemObj?.Viagem?.CaboEntregue == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidCaboEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCaboEntregue">
                                                    <i class="fa-duotone fa-charging-station me-1 text-info"></i>
                                                    Cabo Entregue
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 4C: OCORRÃŠNCIAS DA VIAGEM
                                     SÃ³ habilitada quando um veÃ­culo for selecionado
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                @{
                                    bool temVeiculoSelecionado = Model.ViagemObj?.Viagem?.VeiculoId != null && 
                                                                  Model.ViagemObj.Viagem.VeiculoId != Guid.Empty;
                                }
                                <div id="secaoOcorrenciasUpsert" class="ftx-section ftx-section-ocorrencias @(temVeiculoSelecionado ? "" : "ftx-section-disabled")">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-triangle-exclamation"></i>
                                        OcorrÃªncias da Viagem
                                        <span id="badgeOcorrenciasUpsert" class="badge bg-danger ms-2" style="display: none;">0</span>
                                    </div>
                                    
                                    <!-- Aviso para selecionar veÃ­culo -->
                                    <div id="avisoSelecionarVeiculo" class="alert alert-warning py-2 mb-3" style="@(temVeiculoSelecionado ? "display: none;" : "")">
                                        <i class="fa-duotone fa-info-circle me-1"></i>
                                        Selecione um <strong>veÃ­culo</strong> para registrar ocorrÃªncias.
                                    </div>
                                    
                                    <!-- BotÃ£o Adicionar OcorrÃªncia -->
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <button type="button" class="btn btn-fundo-laranja" id="btnAdicionarOcorrenciaUpsert" @(temVeiculoSelecionado && !viagemFinalizada ? "" : "disabled")>
                                                <i class="fa-duotone fa-plus me-1"></i>
                                                Registrar OcorrÃªncia
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Lista de OcorrÃªncias -->
                                    <div id="listaOcorrenciasUpsert" class="ocorrencias-lista">
                                        <div id="semOcorrenciasUpsert" class="text-center text-muted py-4">
                                            <i class="fa-duotone fa-circle-check fa-2x mb-2 text-success"></i>
                                            <p class="mb-0">Nenhuma ocorrÃªncia registrada</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Campo hidden para armazenar ocorrÃªncias em JSON -->
                                    <input type="hidden" id="hiddenOcorrenciasJson" name="OcorrenciasJson" />
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 5: SOLICITANTE
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-solicitante">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-building-user"></i>
                                        Solicitante
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">Requisitante</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="flex-grow-1">
                                                    <ejs-combobox id="cmbRequisitante" placeholder="Selecione um Requisitante..."
                                                                  allowFiltering="true" filterType="Contains"
                                                                  dataSource="@ViewData["dataRequisitante"]" popupHeight="200px"
                                                                  width="100%" showClearButton="true" change="RequisitanteValueChange"
                                                                  ejs-for="@Model.ViagemObj.Viagem.RequisitanteId">
                                                        <e-combobox-fields text="Requisitante" value="RequisitanteId"></e-combobox-fields>
                                                    </ejs-combobox>
                                                </div>
                                                <a class="btn btn-sm fundo-chocolate text-white"
                                                   id="btnRequisitante"
                                                   style="height: 38px; display: flex; align-items: center;"
                                                   data-bs-toggle="modal" data-bs-target="#modalRequisitante"
                                                   title="Adicionar Requisitante">
                                                    <i class="fa-duotone fa-user-plus"></i>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.RamalRequisitante">Ramal</label>
                                            <span class="text-danger font-weight-light" asp-validation-for="ViagemObj.Viagem.RamalRequisitante"></span>
                                            <input id="txtRamalRequisitante" class="form-control" asp-for="ViagemObj.Viagem.RamalRequisitante" />
                                        </div>
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">Setor Solicitante</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="flex-grow-1">
                                                    <input id="ddtSetor" style="width: 100%" />
                                                    <input type="hidden" asp-for="ViagemObj.Viagem.SetorSolicitanteId" id="hiddenSetor" />
                                                    <script>
                                                        var setorData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewData["dataSetor"]));
                                                        var setorValue = "@(Model.ViagemObj.Viagem.SetorSolicitanteId?.ToString() ?? "")";
                                                    </script>
                                                </div>
                                                <a hidden
                                                   class="btn btn-verde btn-sm text-white"
                                                   id="btnSetor"
                                                   style="height: 38px; display: flex; align-items: center;"
                                                   data-bs-toggle="modal" data-bs-target="#modalSetor"
                                                   title="Adicionar Setor">
                                                    <i class="fa-duotone fa-house-medical"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 6: DESCRIÃ‡ÃƒO DA VIAGEM
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-descricao">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-file-lines"></i>
                                        DescriÃ§Ã£o da Viagem
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="ftx-label">Passageiros / Carga</label>
                                            <input type="hidden" id="DescricaoViagemWordBase64" name="DescricaoViagemWordBase64" />
                                            <!-- Kendo Editor - Inicializado via JavaScript (kendo-editor-upsert.js) -->
                                            <textarea id="rte" name="ViagemObj.Viagem.Descricao" style="height:320px; width:100%;">@Html.Raw(Model.ViagemObj?.Viagem?.Descricao ?? "")</textarea>
                                            <div id="errorMessage">
                                                <span asp-validation-for="@Model.ViagemObj.Viagem.Descricao"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO 7B: DOCUMENTOS E ITENS DEVOLVIDOS
                                     Para viagens que jÃ¡ serÃ£o fechadas na criaÃ§Ã£o
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="ftx-section ftx-section-devolvidos">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-box-archive"></i>
                                        Documentos e Itens Devolvidos
                                        <small class="text-muted fw-normal ms-2">(preencher se a viagem jÃ¡ foi finalizada)</small>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusDocumentoFinal" name="ViagemObj.Viagem.StatusDocumentoFinal" 
                                                       value="@(Model.ViagemObj?.Viagem?.StatusDocumentoFinal == "Devolvido" ? "Devolvido" : "")" />
                                                <input class="form-check-input" type="checkbox" id="chkStatusDocumentoFinal" 
                                                       @(Model.ViagemObj?.Viagem?.StatusDocumentoFinal == "Devolvido" ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidStatusDocumentoFinal').value = this.checked ? 'Devolvido' : '';">
                                                <label class="form-check-label fw-semibold" for="chkStatusDocumentoFinal">
                                                    <i class="fa-duotone fa-file-check me-1 text-info"></i>
                                                    Documento Devolvido
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusCartaoAbastecimentoFinal" name="ViagemObj.Viagem.StatusCartaoAbastecimentoFinal" 
                                                       value="@(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimentoFinal == "Devolvido" ? "Devolvido" : "")" />
                                                <input class="form-check-input" type="checkbox" id="chkStatusCartaoAbastecimentoFinal" 
                                                       @(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimentoFinal == "Devolvido" ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidStatusCartaoAbastecimentoFinal').value = this.checked ? 'Devolvido' : '';">
                                                <label class="form-check-label fw-semibold" for="chkStatusCartaoAbastecimentoFinal">
                                                    <i class="fa-duotone fa-credit-card me-1 text-info"></i>
                                                    CartÃ£o Devolvido
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCintaDevolvida" name="ViagemObj.Viagem.CintaDevolvida" 
                                                       value="@(Model.ViagemObj?.Viagem?.CintaDevolvida == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCintaDevolvida" 
                                                       @(Model.ViagemObj?.Viagem?.CintaDevolvida == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidCintaDevolvida').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCintaDevolvida">
                                                    <i class="fa-duotone fa-link me-1 text-primary"></i>
                                                    Cinta Devolvida
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidTabletDevolvido" name="ViagemObj.Viagem.TabletDevolvido" 
                                                       value="@(Model.ViagemObj?.Viagem?.TabletDevolvido == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkTabletDevolvido" 
                                                       @(Model.ViagemObj?.Viagem?.TabletDevolvido == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidTabletDevolvido').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkTabletDevolvido">
                                                    <i class="fa-duotone fa-tablet me-1 text-primary"></i>
                                                    Tablet Devolvido
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidArlaDevolvido" name="ViagemObj.Viagem.ArlaDevolvido" 
                                                       value="@(Model.ViagemObj?.Viagem?.ArlaDevolvido == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkArlaDevolvido" 
                                                       @(Model.ViagemObj?.Viagem?.ArlaDevolvido == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidArlaDevolvido').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkArlaDevolvido">
                                                    <i class="fa-duotone fa-tint me-1 text-primary"></i>
                                                    Arla Devolvido
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCaboDevolvido" name="ViagemObj.Viagem.CaboDevolvido" 
                                                       value="@(Model.ViagemObj?.Viagem?.CaboDevolvido == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCaboDevolvido" 
                                                       @(Model.ViagemObj?.Viagem?.CaboDevolvido == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidCaboDevolvido').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCaboDevolvido">
                                                    <i class="fa-duotone fa-charging-station me-1 text-primary"></i>
                                                    Cabo Devolvido
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidArlaDevolvido" name="ViagemObj.Viagem.ArlaDevolvido" 
                                                       value="@(Model.ViagemObj?.Viagem?.ArlaDevolvido == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkArlaDevolvido" 
                                                       @(Model.ViagemObj?.Viagem?.ArlaDevolvido == true ? "checked" : "")
                                                       @(viagemFinalizada ? "disabled" : "")
                                                       onchange="document.getElementById('hidArlaDevolvido').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkArlaDevolvido">
                                                    <i class="fa-duotone fa-tint me-1 text-primary"></i>
                                                    Arla Devolvido
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     SEÃ‡ÃƒO MOBILE: RUBRICAS E OCORRÃŠNCIAS (FrotiX Mobile)
                                     SÃ³ aparece em ediÃ§Ã£o de viagens criadas pelo app mobile (NoFichaVistoria = 0)
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                @{
                                    // Verificar se Ã© ediÃ§Ã£o de viagem mobile
                                    bool isEdicaoViagemMobile = Model.ViagemObj?.Viagem?.ViagemId != null && 
                                                                Model.ViagemObj.Viagem.ViagemId != Guid.Empty &&
                                                                (Model.ViagemObj?.Viagem?.NoFichaVistoria == null || 
                                                                 Model.ViagemObj.Viagem.NoFichaVistoria == 0);
                                }
                                <div id="secaoMobile" class="ftx-section ftx-section-mobile p-3" style="@(isEdicaoViagemMobile ? "" : "display: none;")">
                                    <div class="ftx-section-title" style="color: #9c27b0;">
                                        <i class="fa-duotone fa-mobile-screen-button"></i>
                                        Dados do FrotiX Mobile
                                    </div>
                                    
                                    <div class="row g-3">
                                        <!-- Rubrica Inicial -->
                                        <div class="col-12 col-md-6">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-pen"></i> Rubrica Inicial
                                            </label>
                                            <div id="containerRubricaInicial" class="rubrica-container">
                                                <div id="semRubricaInicial" class="rubrica-vazia">
                                                    <i class="fa-duotone fa-pen fa-2x text-muted"></i>
                                                    <p class="text-muted mb-0 mt-2">Sem rubrica inicial</p>
                                                </div>
                                                <img id="imgRubricaInicial" 
                                                     class="rubrica-imagem" 
                                                     style="display: none;" 
                                                     alt="Rubrica Inicial" />
                                            </div>
                                        </div>
                                        
                                        <!-- Rubrica Final -->
                                        <div class="col-12 col-md-6">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-pen-fancy"></i> Rubrica Final
                                            </label>
                                            <div id="containerRubricaFinal" class="rubrica-container">
                                                <div id="semRubricaFinal" class="rubrica-vazia">
                                                    <i class="fa-duotone fa-pen-fancy fa-2x text-muted"></i>
                                                    <p class="text-muted mb-0 mt-2">Sem rubrica final</p>
                                                </div>
                                                <img id="imgRubricaFinal" 
                                                     class="rubrica-imagem" 
                                                     style="display: none;" 
                                                     alt="Rubrica Final" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                     INFORMAÃ‡Ã•ES DE AUDITORIA
                                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex flex-wrap gap-3 text-muted small">
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioAgendamento))
                                            {
                                                <span id="lblUsuarioAgendamento">
                                                    <i class="fa-duotone fa-user-clock me-1"></i>
                                                    Agendado por: @Model.ViagemObj.NomeUsuarioAgendamento
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioAgendamento" style="display:none;"></span>
                                            }
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioCriacao))
                                            {
                                                <span id="lblUsuarioCriacao">
                                                    <i class="fa-duotone fa-user-plus me-1"></i>
                                                    Criado por: @Model.ViagemObj.NomeUsuarioCriacao
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioCriacao" style="display:none;"></span>
                                            }
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioFinalizacao))
                                            {
                                                <span id="lblUsuarioFinalizacao">
                                                    <i class="fa-duotone fa-user-check me-1"></i>
                                                    Finalizado por: @Model.ViagemObj.NomeUsuarioFinalizacao
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioFinalizacao" style="display:none;"></span>
                                            }
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioCancelamento))
                                            {
                                                <span id="lblUsuarioCancelamento">
                                                    <i class="fa-duotone fa-trash-can-xmark me-1"></i>
                                                    Cancelado por: @Model.ViagemObj.NomeUsuarioCancelamento
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioCancelamento" style="display:none;"></span>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- BotÃ£o de Submit -->
                            <div class="form-group row">
                                <div class="col-12">
                                    <div class="row justify-content-start">
                                        <!-- BotÃ£o visÃ­vel: Cria/Edita Viagem -->
                                        <div id="divSubmit" class="col-12 col-md-4 col-lg-3 pb-2" style="@(viagemFinalizada ? "display:none;" : "")">
                                            @if (Model.ViagemObj.Viagem.ViagemId != Guid.Empty)
                                            {
                                            <button id="btnSubmit"
                                                    type="submit"
                                                    asp-page-handler="Submit"
                                                    class="btn btn-azul btn-submit-spin w-100">
                                                <span class="d-flex justify-content-center align-items-center">
                                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                    <span>Atualizar Viagem</span>
                                                </span>
                                            </button>
                                            }
                                            else
                                            {
                                            <button id="btnSubmit"
                                                    type="submit"
                                                    value="Submit"
                                                    asp-page-handler="Submit"
                                                    class="btn btn-azul btn-submit-spin w-100">
                                                <span class="d-flex justify-content-center align-items-center">
                                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                    <span>Criar Viagem</span>
                                                </span>
                                            </button>
                                            }
                                        </div>

                                        <!-- BotÃ£o Cancelar OperaÃ§Ã£o -->
                                        <div class="col-12 col-md-4 col-lg-3 pb-2">
                                            <a href="javascript:void(0)" class="btn btn-vinho w-100 btn-voltar-lista" data-ftx-loading>
                                                <span class="d-flex justify-content-center align-items-center">
                                                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i>
                                                    <span class="ms-2">Cancelar OperaÃ§Ã£o</span>
                                                </span>
                                            </a>
                                        </div>

                                        <!-- BotÃ£o oculto para submit via JavaScript -->
                                        <div class="col-12" hidden>
                                            @if (Model.ViagemObj.Viagem.ViagemId != Guid.Empty)
                                            {
                                            <button id="btnEscondido"
                                                    type="button"
                                                    data-handler="Edit"
                                                    data-id="@Model.ViagemObj.Viagem.ViagemId"
                                                    class="btn btn-azul form-control">
                                                <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                Atualizar Viagem
                                            </button>
                                            }
                                            else
                                            {
                                            <button id="btnEscondido"
                                                    type="button"
                                                    data-handler="Submit"
                                                    class="btn btn-azul form-control">
                                                <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                Criar Viagem
                                            </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div><!-- Fim de div.panel-content -->
                    </div><!-- Fim de div.panel-container show -->
                </div><!-- Fim de div#panel-1 -->
            </div><!-- Fim de col-xl-12 -->
        </div><!-- Fim de row -->
    </div><!-- Fim de container-fluid -->
</form>
<!-- FIM DO FORM PRINCIPAL -->

@{
    // Reutilizar variÃ¡veis de decisÃ£o (nova viagem vs ediÃ§Ã£o mobile)
    bool isNovaViagemFicha = Model.ViagemObj?.Viagem?.ViagemId == null || 
                             Model.ViagemObj.Viagem.ViagemId == Guid.Empty;
    bool isViagemMobileFicha = !isNovaViagemFicha && 
                               (Model.ViagemObj?.Viagem?.NoFichaVistoria == null || 
                                Model.ViagemObj.Viagem.NoFichaVistoria == 0);
    // Mostrar ficha de vistoria se: nova viagem OU ediÃ§Ã£o de viagem web
    bool mostrarFichaVistoria = isNovaViagemFicha || !isViagemMobileFicha;
}

<!-- INÃCIO: FORM DEDICADO Ã€ FICHA DE VISTORIA (RAZOR PAGES HANDLER) -->
<form method="post" asp-page-handler="InsereFicha" enctype="multipart/form-data" id="formFichaVistoria">
    <div class="container-fluid" id="secaoFichaVistoria" style="padding-left: 0; margin-left: 0; @(mostrarFichaVistoria ? "" : "display: none;")">
        <div class="row bottom-space" style="margin-top: 2rem;">

            <!-- coluna do input -->
            <div class="col-md-6 col-lg-5">
                <label class="d-block label font-weight-bold">Ficha de Vistoria</label>
                <input asp-for="FotoUpload"
                       type="file"
                       id="txtFile"
                       class="form-control mb-3"
                       accept="image/*"
                       onchange="VisualizaImagem(this)" />

                <!-- Campo hidden para o Base64 da nova imagem -->
                <input type="hidden" id="hiddenFoto" name="FotoBase64" value="" />

                <!-- Campo hidden para preservar imagem existente (caso nÃ£o haja novo upload) -->
                @if (Model.ViagemObj?.Viagem?.FichaVistoria != null && Model.ViagemObj.Viagem.FichaVistoria.Length > 0)
                {
                <input type="hidden"
                       id="hiddenFichaExistente"
                       name="FichaVistoriaExistente"
                       value="@Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria)" />
                }
            </div>

            <!-- coluna do preview + botÃ£o -->
            <div class="col-md-6 col-lg-7 d-flex flex-column align-items-start">
                <div class="img-zoom-wrapper">
                    @{
                    string imageSrc = "/images/FichaAmarelaNova.jpg"; // Imagem padrÃ­o/fallback
                    if (Model.ViagemObj?.Viagem?.FichaVistoria != null && Model.ViagemObj.Viagem.FichaVistoria.Length > 0)
                    {
                    imageSrc = $"data:image/jpeg;base64,{Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria)}";
                    }
                    }
                    <img id="imgViewerItem"
                         src="@imageSrc"
                         alt="Ficha de Vistoria"
                         style="max-width: 500px; max-height: 500px; border: 1px solid #ddd; margin-top: .5rem; object-fit: contain;"
                         class="img-thumbnail" />
                    <button type="button"
                            class="zoom-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#modalZoom"
                            aria-label="Ampliar imagem"
                            onclick="atualizarImagemModal()">
						<i class="fa-duotone fa-magnifying-glass-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal para zoom da imagem -->
<div class="modal fade" id="modalZoom" tabindex="-1" aria-labelledby="modalZoomLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-azul">
                <h5 class="modal-title" id="modalZoomLabel">Ficha de Vistoria</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imgZoomed"
                     src="/images/FichaAmarelaNova.jpg"
                     alt="Ficha de Vistoria Ampliada"
                     style="max-width: 100%; height: auto;" />
            </div>
        </div>
    </div>
</div>

<!-- Modal Inserir Evento -->
<div class="modal fade" id="modalEvento" data-backdrop="false" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title">
                    <i class="fa-duotone fa-users"></i>
                    Inserir um novo Evento
                </h4>
            </div>
            <div class="modal-body table-bordered">
                <form id="frmEvento">
                    <div class="row">
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Nome do Evento</label>
                                <input id="txtNomeDoEvento" class="form-control form-control-xs" />
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="form-group">
                                <label class="label font-weight-bold">DescriÃ§Ã£o do Evento</label>
                                <input id="txtDescricaoEvento" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Data Inicial</label>
                                <input id="txtDataInicialEvento" class="form-control form-control-xs" type="date" />
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Data Final</label>
                                <input id="txtDataFinalEvento" class="form-control form-control-xs" type="date" />
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Quantidade de Pessoas</label>
                                <input id="txtQtdPessoas" class="form-control form-control-xs" type="number" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-5 form-control-xs" style="margin: 10px; width: 200px;">
                            <label class="label font-weight-bold">Requisitante do Evento</label>
                            <ejs-dropdowntree id="lstRequisitanteEvento" placeholder="Selecione um Requisitante"
                                              showCheckBox="false" allowMultiSelection="false" allowFiltering="true"
                                              filterType="Contains" filterBarPlaceholder="Procurar..."
                                              popupHeight="200px" change="RequisitanteEventoValueChange">
                                <e-dropdowntree-fields dataSource="@ViewData["dataRequisitante"]"
                                                       value="RequisitanteId" text="Requisitante">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                        <div class="col-5 form-control-xs" style="margin: 10px; width: 200px;">
                            <label class="label font-weight-bold">Setor do Requisitante</label>
                            <ejs-dropdowntree id="ddtSetorRequisitanteEvento" placeholder="Selecione um Setor"
                                              sortOrder="Ascending" showCheckBox="false" allowMultiSelection="false"
                                              allowFiltering="true" filterType="Contains" filterBarPlaceholder="Procurar...">
                                <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                       value="SetorSolicitanteId" text="Nome"
                                                       parentValue="SetorPaiId" hasChildren="HasChild">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                    </div>
                    <br /><br /><br />
                    <div class="modal-footer justify-content-between">
                        <button id="btnInserirEvento"
                                type="submit"
                                value="SUBMIT"
                                class="btn custom-primary-btn">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-down-to-bracket"></i>
                                <span>Inserir Evento</span>
                            </span>
                        </button>
                        <button type="button"
                                class="btn btn-vinho ml-auto ms-auto"
                                data-bs-dismiss="modal" data-bs-dismiss="modal" aria-label="Fechar">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-circle-xmark icon-spin" aria-hidden="true"></i>
                                <span>Fechar</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>

<!-- Modal Inserir Requisitante -->
<div class="modal fade" id="modalRequisitante">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- CabeÃ§alho -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title">
                    <i class="fa-duotone fa-user-plus"></i>
                    Inserir um novo Requisitante
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-divider"></div>

            <!-- Corpo -->
            <div class="modal-body">
                <form id="frmRequisitante">
                    <div class="form-row mb-3">
                        <div class="col-md-2">
                            <label for="txtPonto" class="font-weight-bold">Ponto</label>
                            <input id="txtPonto" class="form-control" />
                        </div>
                        <div class="col-md-8">
                            <label for="txtNome" class="font-weight-bold">Nome do Requisitante</label>
                            <input id="txtNome" class="form-control" />
                        </div>
                        <div class="col-md-2">
                            <label for="txtRamal" class="font-weight-bold">Ramal</label>
                            <input id="txtRamal" class="form-control" />
                        </div>
                    </div>

                    <div class="form-row mb-3">
                        <div class="col-md-8">
                            <label for="txtEmail" class="font-weight-bold">Email</label>
                            <input id="txtEmail" class="form-control" />
                        </div>
                    </div>

                    <div class="form-row mb-4">
                        <div class="col-md-6">
                            <label for="ddtSetorRequisitante" class="font-weight-bold">Setor do Requisitante</label>
                            <ejs-dropdowntree id="ddtSetorRequisitante" placeholder="Selecione um Setor"
                                              sortOrder="Ascending" showCheckBox="false" allowMultiSelection="false"
                                              allowFiltering="true" filterType="Contains" filterBarPlaceholder="Procurar...">
                                <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                       value="SetorSolicitanteId" text="Nome"
                                                       parentValue="SetorPaiId" hasChildren="HasChild">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                    </div>

                    <div class="modal-divider"></div>

                    <div class="modal-footer justify-content-between">
                        <!-- Corrigido o texto do botÃ£o -->
                        <button id="btnInserirRequisitante"
                                class="btn btn-azul"
                                type="submit"
                                value="SUBMIT">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-down-to-bracket"></i>
                                <span>Inserir Requisitante</span>
                            </span>
                        </button>

                        <button type="button"
                                class="btn fundo-vermelho"
                                data-bs-dismiss="modal" data-bs-dismiss="modal" aria-label="Fechar modal">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-circle-xmark icon-spin" aria-hidden="true"></i>
                                <span>Fechar</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Inserir Setor -->
<div class="modal fade" id="modalSetor">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- CabeÃ§alho -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title">Inserir um novo Setor Solicitante</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-divider"></div>

            <!-- Corpo -->
            <div class="modal-body">
                <form id="frmSetor">
                    <div class="form-row mb-3">
                        <div class="col-md-3">
                            <label for="txtSigla" class="font-weight-bold">Sigla</label>
                            <input id="txtSigla" class="form-control" placeholder="Ex: TI, RH" />
                        </div>
                        <div class="col-md-6">
                            <label for="txtNomeSetor" class="font-weight-bold">Nome do Setor</label>
                            <input id="txtNomeSetor" class="form-control" placeholder="Insira o nome completo do setor" />
                        </div>
                        <div class="col-md-3">
                            <label for="txtRamalSetor" class="font-weight-bold">Ramal</label>
                            <input id="txtRamalSetor" class="form-control" placeholder="Ex: 1234" type="number" />
                        </div>
                    </div>

                    <div class="form-row mb-4">
                        <div class="col-md-6">
                            <label for="ddtSetorPai" class="font-weight-bold">Setor Pai (se houver)</label>
                            <ejs-dropdowntree id="ddtSetorPai" placeholder="Selecione um Setor"
                                              sortOrder="Ascending" showCheckBox="false" allowMultiSelection="false"
                                              allowFiltering="true" filterType="Contains" filterBarPlaceholder="Procurar...">
                                <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                       value="SetorSolicitanteId" text="Nome"
                                                       parentValue="SetorPaiId" hasChildren="HasChild">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                    </div>

                    <div class="modal-divider"></div>

                    <div class="modal-footer justify-content-between">
                        <button id="btnInserirSetor"
                                type="submit"
                                value="SUBMIT"
                                class="btn custom-primary-btn">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-down-to-bracket"></i>
                                <span>Inserir Setor</span>
                            </span>
                        </button>

                        <button type="button"
                                class="btn btn-vinho ml-auto ms-auto"
                                data-bs-dismiss="modal" data-bs-dismiss="modal" aria-label="Fechar">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-circle-xmark icon-spin" aria-hidden="true"></i>
                                <span>Fechar</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="toast_container"></div>

<div id="syncfusion-toast"></div>

@* ===============================================================================
   MODAL OCORRÃŠNCIAS DO VEÃCULO (UPSERT)
   ===============================================================================*@
<div class="modal fade" id="modalOcorrenciasVeiculoUpsert" tabindex="-1" aria-labelledby="modalOcorrenciasVeiculoUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h4 class="modal-title d-flex align-items-center gap-2" id="modalOcorrenciasVeiculoUpsertLabel">
                    <i class="fa-duotone fa-car-burst" aria-hidden="true"></i>
                    <span>OcorrÃªncias em Aberto do VeÃ­culo</span>
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <!-- Tabela de OcorrÃªncias -->
                <div class="table-responsive">
                    <table id="tblOcorrenciasVeiculoUpsert" class="table table-bordered table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center" style="width: 50px;">#</th>
                                <th style="width: 28%;">Resumo</th>
                                <th style="width: 30%;">DescriÃ§Ã£o</th>
                                <th class="text-center" style="width: 90px;">Data</th>
                                <th class="text-center" style="width: 90px;">Status</th>
                                <th class="text-center" style="width: 120px;">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@* ===============================================================================
   MODAL IMAGEM DA OCORRÃŠNCIA (UPSERT)
   ===============================================================================*@
<div class="modal fade" id="modalImagemOcorrenciaUpsert" tabindex="-1" aria-labelledby="modalImagemOcorrenciaUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalImagemOcorrenciaUpsertLabel">
                    <i class="fa-duotone fa-image" aria-hidden="true"></i>
                    <span>Imagem da OcorrÃªncia</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body text-center p-3">
                <img id="imgOcorrenciaViewerUpsert"
                     class="img-fluid rounded shadow"
                     style="max-height: 500px; display: none;"
                     alt="Imagem da OcorrÃªncia" />
                <div id="noImageOcorrenciaUpsert" class="p-4 bg-light rounded" style="display: none;">
                    <i class="fa-duotone fa-image fa-4x text-muted mb-3"></i>
                    <p class="text-muted">Nenhuma imagem disponÃ­vel</p>
                </div>
            </div>

            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@*=========================================================================
   MODAL SOLUÃ‡ÃƒO DA OCORRÃŠNCIA (PARA BAIXA) - UPSERT
   =========================================================================*@
<div class="modal fade" id="modalSolucaoOcorrenciaUpsert" tabindex="-1" aria-labelledby="modalSolucaoOcorrenciaUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-verde">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalSolucaoOcorrenciaUpsertLabel">
                    <i class="fa-duotone fa-circle-check" aria-hidden="true"></i>
                    <span>Informar SoluÃ§Ã£o da OcorrÃªncia</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="hiddenOcorrenciaIdSolucaoUpsert" />
                <div class="form-group">
                    <label class="form-label fw-bold">
                        <i class="fa-duotone fa-message-lines me-1"></i>
                        SoluÃ§Ã£o aplicada (opcional)
                    </label>
                    <textarea id="txtSolucaoOcorrenciaUpsert" class="form-control" rows="4" 
                              placeholder="Descreva a soluÃ§Ã£o aplicada para resolver esta ocorrÃªncia..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark me-1"></i> Cancelar
                </button>
                <button type="button" id="btnConfirmarSolucaoUpsert" class="btn btn-verde">
                    <i class="fa-duotone fa-circle-check me-1"></i> Confirmar Baixa
                </button>
            </div>
        </div>
    </div>
</div>

@* ===============================================================================
   OVERLAY LOADING - GRAVANDO VIAGEM (PADRÃƒO FROTIX)
   ===============================================================================*@
<div id="loadingOverlaySalvando" class="ftx-spin-overlay" style="z-index: 999999; cursor: wait; display: none;">
    <div class="ftx-spin-box" style="text-align: center; min-width: 300px;">
        <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" class="ftx-loading-logo" style="display: block;" />
        <div class="ftx-loading-bar"></div>
        <div class="ftx-loading-text">Gravando Viagem...</div>
        <div class="ftx-loading-subtext">Aguarde, por favor</div>
    </div>
</div>

@* ===============================================================================
   MODAL VISUALIZAR OCORRÃŠNCIA DA VIAGEM (MOBILE)
   ===============================================================================*@
<div class="modal fade" id="modalVerOcorrenciaViagem" tabindex="-1" aria-labelledby="modalVerOcorrenciaViagemLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalVerOcorrenciaViagemLabel">
                    <i class="fa-duotone fa-triangle-exclamation" aria-hidden="true"></i>
                    <span>Detalhes da OcorrÃªncia</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="fw-bold text-muted small">Resumo</label>
                        <div id="txtOcorrenciaResumo" class="form-control-plaintext border-bottom"></div>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="fw-bold text-muted small">Data</label>
                        <div id="txtOcorrenciaData" class="form-control-plaintext border-bottom"></div>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="fw-bold text-muted small">Status</label>
                        <div id="divOcorrenciaStatus"></div>
                    </div>
                    <div class="col-12">
                        <label class="fw-bold text-muted small">DescriÃ§Ã£o</label>
                        <div id="txtOcorrenciaDescricao" class="form-control-plaintext border-bottom" style="min-height: 60px;"></div>
                    </div>
                    <div class="col-12" id="divSolucaoOcorrencia" style="display: none;">
                        <label class="fw-bold text-muted small">SoluÃ§Ã£o Aplicada</label>
                        <div id="txtOcorrenciaSolucao" class="form-control-plaintext border-bottom bg-light p-2 rounded"></div>
                    </div>
                    <div class="col-12">
                        <label class="fw-bold text-muted small">Imagem</label>
                        <div class="text-center p-3 bg-light rounded">
                            <img id="imgOcorrenciaViagem" 
                                 class="img-fluid rounded shadow" 
                                 style="max-height: 400px; display: none;" 
                                 alt="Imagem da OcorrÃªncia" />
                            <div id="semImagemOcorrenciaViagem" class="p-4">
                                <i class="fa-duotone fa-image fa-3x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Nenhuma imagem disponÃ­vel</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@*=========================================================================
   MODAL INSERIR OCORRÃŠNCIA (UPSERT)
   =========================================================================*@
<div class="modal fade" id="modalInserirOcorrenciaUpsert" tabindex="-1" aria-labelledby="modalInserirOcorrenciaUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalInserirOcorrenciaUpsertLabel">
                    <i class="fa-duotone fa-triangle-exclamation" aria-hidden="true"></i>
                    <span>Registrar Nova OcorrÃªncia</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <form id="frmOcorrenciaUpsert">
                    <!-- Resumo -->
                    <div class="mb-3">
                        <label for="txtResumoOcorrenciaUpsert" class="form-label fw-semibold">
                            <i class="fa-duotone fa-file-signature me-1 text-warning"></i>
                            Resumo da OcorrÃªncia <span class="text-danger">*</span>
                        </label>
                        <input type="text" id="txtResumoOcorrenciaUpsert" 
                               class="form-control" 
                               placeholder="Ex: ArranhÃ£o na lateral, Pneu furado, Vidro trincado..."
                               maxlength="100" />
                    </div>
                    
                    <!-- DescriÃ§Ã£o -->
                    <div class="mb-3">
                        <label for="txtDescricaoOcorrenciaUpsert" class="form-label fw-semibold">
                            <i class="fa-duotone fa-message-lines me-1 text-info"></i>
                            DescriÃ§Ã£o Detalhada
                        </label>
                        <textarea id="txtDescricaoOcorrenciaUpsert" 
                                  class="form-control" 
                                  rows="3" 
                                  placeholder="Descreva os detalhes da ocorrÃªncia..."></textarea>
                    </div>
                    
                    <!-- Imagem -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fa-duotone fa-camera me-1 text-success"></i>
                            Foto da OcorrÃªncia (opcional)
                        </label>
                        <div class="input-group">
                            <input type="file" id="fileImagemOcorrenciaUpsert"
                                   class="form-control"
                                   accept="image/*" />
                            <button type="button" class="btn btn-vinho" id="btnLimparImagemOcorrenciaUpsert">
                                <i class="fa-duotone fa-xmark"></i>
                            </button>
                        </div>
                        <div id="previewImagemOcorrenciaUpsert" class="mt-2 text-center" style="display: none;">
                            <img id="imgPreviewOcorrenciaUpsert" 
                                 class="img-thumbnail" 
                                 style="max-height: 150px;" 
                                 alt="Preview" />
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark me-1"></i> Cancelar
                </button>
                <button type="button" id="btnConfirmarOcorrenciaUpsert" class="btn btn-fundo-laranja">
                    <i class="fa-duotone fa-plus me-1"></i> Adicionar OcorrÃªncia
                </button>
            </div>
        </div>
    </div>
</div>

@*=========================================================================
   MODAL VER IMAGEM OCORRÃŠNCIA (UPSERT)
   =========================================================================*@
<div class="modal fade" id="modalVerImagemOcorrenciaUpsert" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-azul">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fa-duotone fa-image" aria-hidden="true"></i>
                    <span>Imagem da OcorrÃªncia</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="imgViewerOcorrenciaUpsert" 
                     class="img-fluid rounded shadow" 
                     style="max-height: 500px;" 
                     alt="Imagem da OcorrÃªncia" />
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark me-1"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== SEÃ‡ÃƒO DOCUMENTOS ===== */
    .ftx-section-documentos {
        border-left: 4px solid #198754;
        background: linear-gradient(135deg, #f0fff4 0%, #e6ffed 100%);
    }

    .ftx-section-documentos .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }

    /* ===== SEÃ‡ÃƒO DOCUMENTOS DEVOLVIDOS ===== */
    .ftx-section-devolvidos {
        border-left: 4px solid #0dcaf0;
        background: linear-gradient(135deg, #f0faff 0%, #e6f7ff 100%);
    }

    .ftx-section-devolvidos .ftx-section-title {
        color: #0aa2c0;
    }

    .ftx-section-devolvidos .form-check-input:checked {
        background-color: #0dcaf0;
        border-color: #0dcaf0;
    }

    /* ===== SEÃ‡ÃƒO OCORRÃŠNCIAS ===== */
    .ftx-section-ocorrencias {
        border-left: 4px solid #fd7e14;
        background: linear-gradient(135deg, #fff8f0 0%, #fff3e6 100%);
        transition: opacity 0.3s, filter 0.3s;
    }

    /* Estado desabilitado da seÃ§Ã£o de ocorrÃªncias */
    .ftx-section-ocorrencias.ftx-section-disabled {
        opacity: 0.6;
        pointer-events: none;
        filter: grayscale(30%);
    }

    .ftx-section-ocorrencias.ftx-section-disabled .ftx-section-title {
        color: #6c757d;
    }

    .ftx-section-ocorrencias.ftx-section-disabled .ocorrencias-lista {
        background: #f8f9fa;
    }

    /* Permitir interaÃ§Ã£o com o aviso mesmo desabilitado */
    .ftx-section-ocorrencias.ftx-section-disabled .alert {
        pointer-events: auto;
        opacity: 1;
    }

    .ocorrencias-lista {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        min-height: 100px;
        max-height: 300px;
        overflow-y: auto;
    }

    .ocorrencia-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

    .ocorrencia-item:last-child {
        border-bottom: none;
    }

    .ocorrencia-item:hover {
        background-color: #f8f9fa;
    }

    .ocorrencia-info {
        flex: 1;
    }

    .ocorrencia-resumo {
        font-weight: 600;
        color: #333;
    }

    .ocorrencia-descricao {
        font-size: 0.85rem;
        color: #666;
        margin-top: 2px;
    }

    .ocorrencia-acoes {
        display: flex;
        gap: 0.5rem;
    }

    .ocorrencia-acoes .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    .badge-ocorrencias {
        font-size: 0.85rem;
    }

    /* Modal header terracota */
    .modal-header-terracota {
        background: linear-gradient(135deg, #fd7e14 0%, #e55e00 100%);
        color: #fff;
    }

    /* ===== SEÃ‡ÃƒO MOBILE ===== */
    .ftx-section-mobile {
        border-left: 4px solid #9c27b0;
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
    }

    .rubrica-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .rubrica-vazia {
        text-align: center;
    }

    .rubrica-imagem {
        max-width: 100%;
        max-height: 160px;
        object-fit: contain;
        border-radius: 4px;
    }

    /* Badges de status das ocorrÃªncias */
    .ftx-status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 70px;
        padding: 0.25rem 0.6rem;
        border-radius: 50px;
        color: #fff !important;
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }

    .ftx-status-aberta {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        box-shadow: 0 2px 6px rgba(39, 174, 96, 0.35);
    }

    .ftx-status-baixada {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        box-shadow: 0 2px 6px rgba(127, 140, 141, 0.35);
    }

    .ftx-status-pendente {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        box-shadow: 0 2px 6px rgba(243, 156, 18, 0.35);
    }

    /* BotÃµes de aÃ§Ã£o da tabela de ocorrÃªncias */
    .btn-ver-ocorrencia {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-ver-ocorrencia:hover {
        background: linear-gradient(135deg, #2980b9 0%, #1f6391 100%);
        transform: scale(1.05);
    }

    .btn-ver-ocorrencia:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Ajuste do texto truncado nas colunas */
    #tblOcorrenciasViagem td {
        vertical-align: middle;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #tblOcorrenciasViagem td:hover {
        white-space: normal;
        word-wrap: break-word;
    }

    /* Cards de documentos/itens */
    #secaoMobile .card-header {
        font-size: 0.9rem;
    }

    #secaoMobile .form-check-label {
        font-size: 0.85rem;
    }
</style>

@section ScriptsBlock {

	<script>

		// Passando ParÃ¢metros pro Javascript
		const ViagemId = "@(Model.ViagemObj.Viagem?.ViagemId.ToString() ?? "")";
		window.viagemId = ViagemId;

		// Status da viagem para controle de desabilitaÃ§Ã£o
		window.viagemStatus = "@(Model.ViagemObj?.Viagem?.Status ?? "")";
		window.viagemFinalizada = @Json.Serialize(Model.ViagemObj?.Viagem?.Status == "Realizada" || Model.ViagemObj?.Viagem?.Status == "Cancelada");

		// ConfiguraÃ§Ã£o dos eventos change para atualizar campos hidden dos controles Kendo
		// Aguarda Kendo estar disponÃ­vel antes de inicializar widgets
		function initKendoWidgets() {
			try {
				// CombustÃ­vel Inicial
				var combInicialWidget = $("#ddtCombustivelInicial").data("kendoDropDownList");
				if (combInicialWidget) {
					combInicialWidget.bind("change", function() {
						$("#hiddenCombustivelInicial").val(this.value() || "");
					});
				}

				// CombustÃ­vel Final
				var combFinalWidget = $("#ddtCombustivelFinal").data("kendoDropDownList");
				if (combFinalWidget) {
					combFinalWidget.bind("change", function() {
						$("#hiddenCombustivelFinal").val(this.value() || "");
					});
				}

				// Inicializar Kendo DropDownTree para Setor (hierÃ¡rquico)
				if (typeof setorData !== 'undefined' && typeof kendo !== 'undefined') {
					// Construir estrutura hierÃ¡rquica
					var hierarchicalData = buildHierarchy(setorData);

					$("#ddtSetor").kendoDropDownTree({
						placeholder: "Selecione um Setor",
						dataTextField: "Nome",
						dataValueField: "SetorSolicitanteId",
						enabled: false,
						dataSource: {
							data: hierarchicalData,
							schema: {
								model: {
									id: "SetorSolicitanteId",
									hasChildren: "HasChild",
									children: "items"
								}
							}
						},
						value: setorValue,
						change: function(e) {
							$("#hiddenSetor").val(this.value() || "");
						}
					});
				}
			} catch (error) {
				if (window.Alerta && typeof Alerta.TratamentoErroComLinha === 'function') {
					Alerta.TratamentoErroComLinha("Upsert.cshtml", "initKendoWidgets", error);
				} else {
					console.error('[Viagem Upsert] Erro ao inicializar widgets Kendo:', error);
				}
			}
		}

		// FunÃ§Ã£o auxiliar para construir hierarquia
		function buildHierarchy(flatData) {
			try {
				var roots = [];
				var lookup = {};

				// Criar lookup por ID
				flatData.forEach(function(item) {
					lookup[item.SetorSolicitanteId] = { ...item, items: [] };
				});

				// Construir Ã¡rvore
				flatData.forEach(function(item) {
					if (item.SetorPaiId && item.SetorPaiId !== "00000000-0000-0000-0000-000000000000") {
						var parent = lookup[item.SetorPaiId];
						if (parent) {
							parent.items.push(lookup[item.SetorSolicitanteId]);
						} else {
							roots.push(lookup[item.SetorSolicitanteId]);
						}
					} else {
						roots.push(lookup[item.SetorSolicitanteId]);
					}
				});

				return roots;
			} catch (error) {
				if (window.Alerta && typeof Alerta.TratamentoErroComLinha === 'function') {
					Alerta.TratamentoErroComLinha("Upsert.cshtml", "buildHierarchy", error);
				} else {
					console.error('[Viagem Upsert] Erro ao construir hierarquia:', error);
				}
				return [];
			}
		}

	</script>

	
	

	<!-- Kendo UI - Scripts e estilos servidos localmente via NuGet (Kendo.Mvc) -->
	@(Html.Kendo().DeferredScripts())

	<!-- InicializaÃ§Ã£o dos widgets Kendo APÃ“S o DeferredScripts -->
	<script>
		$(document).ready(function() {
			// Aguarda um tick para garantir que os widgets Kendo estejam inicializados
			setTimeout(function() {
				if (typeof initKendoWidgets === 'function') {
					initKendoWidgets();
				}
			}, 100);
		});
	</script>

	<!-- Kendo Editor Helper - InicializaÃ§Ã£o do editor -->
	<script src="~/js/viagens/kendo-editor-upsert.js" asp-append-version="true"></script>

	<!-- ValidaÃ§Ã£o IA - Validador Evolutivo de FinalizaÃ§Ã£o -->
	<script src="~/js/validacao/ValidadorFinalizacaoIA.js" asp-append-version="true"></script>

	<script src="~/js/cadastros/ViagemUpsert.js" asp-append-version="true"></script>

	<script>
		// ===== DETECÃ‡ÃƒO DE MUDANÃ‡AS E CONFIRMAÃ‡ÃƒO AO SAIR =====
		$(document).ready(function () {
			try {
				// Salva o estado inicial do formulÃ¡rio para detectar mudanÃ§as
				var estadoInicial = $('form').serialize();
				var formularioAlterado = false;

				// Detecta mudanÃ§as no formulÃ¡rio
				$('form').on('change input', 'input, select, textarea', function () {
					try {
						formularioAlterado = ($('form').serialize() !== estadoInicial);
					} catch (error) {
						Alerta.TratamentoErroComLinha("Viagem_Upsert.cshtml", "form.change", error);
					}
				});

				// FunÃ§Ã£o para verificar e redirecionar
				function verificarEVoltar() {
					try {
						if (formularioAlterado) {
							Alerta.Confirmar(
								"Descartar AlteraÃ§Ãµes?",
								"VocÃª fez alteraÃ§Ãµes no formulÃ¡rio que ainda nÃ£o foram salvas. Deseja realmente descartar essas mudanÃ§as?",
								"Sim, descartar",
								"Cancelar"
							).then(function (confirmado) {
								try {
									if (confirmado) {
										window.location.href = '/Viagens';
									}
								} catch (error) {
									Alerta.TratamentoErroComLinha("Viagem_Upsert.cshtml", "verificarEVoltar.confirmar.then", error);
								}
							});
						} else {
							window.location.href = '/Viagens';
						}
					} catch (error) {
						Alerta.TratamentoErroComLinha("Viagem_Upsert.cshtml", "verificarEVoltar", error);
					}
				}

				// Intercepta clique no botÃ£o Voltar Ã  Lista (header)
				$('#btnVoltarLista').on('click', function (e) {
					try {
						e.preventDefault();
						verificarEVoltar();
					} catch (error) {
						Alerta.TratamentoErroComLinha("Viagem_Upsert.cshtml", "btnVoltarLista.click", error);
					}
				});

				// Intercepta clique no botÃ£o Voltar Ã  Lista (rodapÃ©)
				$('.btn-voltar-lista').on('click', function (e) {
					try {
						e.preventDefault();
						verificarEVoltar();
					} catch (error) {
						Alerta.TratamentoErroComLinha("Viagem_Upsert.cshtml", "btn-voltar-lista.click", error);
					}
				});

			} catch (error) {
				Alerta.TratamentoErroComLinha("Viagem_Upsert.cshtml", "document.ready.voltarLista", error);
			}
		});
	</script>

}

