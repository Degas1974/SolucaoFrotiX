@*
 * ‚ö° ARQUIVO: Pages/Viagens/ListaEventos.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : P√°gina listagem e gest√£o de eventos de viagens (ocorr√™ncias registradas durante
 *                   viagens) com DataTable avan√ßado, filtros m√∫ltiplos (data, viagem, tipo evento, gravidade),
 *                   modals detalhes evento, a√ß√µes editar/visualizar, integra√ß√£o Stimulsoft Reports
 * üì• ENTRADAS     : @page /Viagens/ListaEventos, @model ListaEventosModel, ViewData com listas (filtros),
 *                   DataTable #tblEventos (AJAX GET /api/Viagem/ListaEventos), filtros Syncfusion DropDowns
 *                   (DataInicio/DataFim DatePicker, TipoEvento ComboBox, GravidadeEvento ComboBox),
 *                   bot√£o "Novo Evento"
 * üì§ SA√çDAS       : Panel ftx-card-header com heading (fa-calendar-users "Eventos"), DataTable #tblEventos
 *                   com colunas (Data, Viagem ID, Tipo Evento, Gravidade, Descri√ß√£o, Motorista, A√ß√µes),
 *                   modal detalhes evento (descri√ß√£o, fotos, anexos), redirects /Viagens/Upsert ou
 *                   /Viagens/UpsertEvento, AppToast feedback, CSS inline ~200 linhas (header gradient animate)
 * üîó CHAMADA POR  : Menu "Viagens > Eventos", navega√ß√£o sidebar, link em Viagens/Index modal ocorr√™ncias,
 *                   bot√£o "Novo Evento" cria√ß√£o r√°pida
 * üîÑ CHAMA        : /api/Viagem/ListaEventos (AJAX GET DataTable), /api/Viagem/DeleteEvento (DELETE confirm),
 *                   ./UpsertEvento (link editar), Stimulsoft MVC Viewer (relat√≥rios eventos),
 *                   CSS .ftx-card-header animate gradient, ViewData (Title, PageName, Heading, Category1, PageIcon)
 * üì¶ DEPEND√äNCIAS : ASP.NET Core Razor Pages, ListaEventosModel (code-behind), DataTables jQuery plugin,
 *                   Syncfusion EJ2 (DropDowns, DatePicker, Grid - importados mas nem todos usados),
 *                   Bootstrap 5, jQuery, AppToast.js, Alerta.js, Font Awesome Duotone, CSS custom
 *                   (ftx-card-header with gradient animation), Stimulsoft Reports viewer
 * üìù OBSERVA√á√ïES  : Total: ~400 linhas. Page intermedi√°ria eventos viagens. CSS inline ~150 linhas
 *                   (header gradient animation 8s infinite, titulo-paginas font-family Outfit weight 900).
 *                   ViewData config: Title "Eventos", PageName "viagens_listaeventos", Heading
 *                   "fa-calendar-users Cadastros: Eventos", Category1 "Cadastros", PageIcon "fa-calendar-users".
 *                   @section HeadBlock: CSS externo ftx-card-styled.css (via link), keyframes headerGradientShift
 *                   (0%/50%/100% background-position), @keyframes corrija (@@keyframes CSS Razor),
 *                   IIFE jQuery ready no final (@section ScriptsBlock) carrega lista eventos via AJAX.
 *@

@page

@using FrotiX.Repository.IRepository
@using Syncfusion.EJ2
@using Stimulsoft.Report.Mvc

@{
    ViewData["Title"] = "Eventos";
    ViewData["PageName"] = "viagens_listaeventos";
    ViewData["Heading"] = "<i class='fa-duotone fa-calendar-users'></i> Cadastros: <span class='fw-300'>Eventos</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-calendar-users";
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />
}

<style>
    /* ======== ANIMA√á√ÉO SUAVE DO HEADER ======== */
    @@keyframes headerGradientShift {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }

    /* ======== CORRE√á√ÉO DO HEADER DO CARD ======== */
    .ftx-card-header {
        background: linear-gradient(135deg, #325d88 0%, #2a4d73 25%, #3d6f9e 50%, #2a4d73 75%, #325d88 100%);
        background-size: 400% 400%;
        animation: headerGradientShift 8s ease infinite;
    }

    /* ======== CORRE√á√ÉO DA FONTE DO T√çTULO ======== */
    .ftx-card-header .titulo-paginas {
        font-family: 'Outfit', sans-serif !important;
        font-weight: 900 !important;
        font-size: 1.925rem !important;
        color: #ffffff !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25) !important;
    }

    /* √çcone do header - padr√£o FrotiX removido, usa CSS global */

    /* ======== OUTLINE BRANCO NO BOT√ÉO DO HEADER (j√° definido no frotix.css para) ======== */

    /* ======== BOT√ïES DE A√á√ÉO - ESPA√áAMENTO VERTICAL ======== */
    #tblEventos td:last-child .text-center {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 6px;
    }

    /* ======== BOT√ÉO EXCLUIR DESABILITADO (evento com viagens) ======== */
    #tblEventos .btn.disabled,
    #tblEventos a.btn.disabled,
    #tblEventos .text-center .btn.disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
        pointer-events: auto !important; /* Permite tooltip mesmo desabilitado */
    }

    #tblEventos .btn.disabled:hover,
    #tblEventos a.btn.disabled:hover {
        background-color: #6c757d !important;
        transform: none !important; /* Remove efeito de hover */
    }

    /* ======== MODAIS DE CUSTO - 20% MENORES ======== */
    #modalCusto .modal-dialog.modal-xl {
        max-width: 920px !important;
    }

    #modalCusto .modal-body,
    #modalCusto .modal-header,
    #modalCusto .modal-footer {
        padding: 0.8rem 1rem;
    }

    #modalCusto .modal-body .h5,
    #modalCusto .modal-body h5,
    #modalCusto .modal-body h6 {
        font-size: 0.9rem;
    }

    #modalCusto .stat-card,
    #modalCusto .custo-card {
        padding: 0.8rem;
    }

    #modalCusto .stat-icon,
    #modalCusto .custo-icon {
        font-size: 1.6rem;
    }

    #modalCusto .stat-valor,
    #modalCusto .custo-valor {
        font-size: 0.9rem;
    }

    #modalDetalhes .modal-dialog.modal-lg {
        max-width: 640px !important;
    }

    #modalDetalhes .modal-body,
    #modalDetalhes .modal-header,
    #modalDetalhes .modal-footer {
        padding: 0.8rem 1rem;
    }

    #modalDetalhes .card-body {
        padding: 0.8rem;
    }

    #modalDetalhes h4,
    #modalDetalhes h5,
    #modalDetalhes h6 {
        font-size: 0.9rem;
    }

    #modalDetalhes .fa-2x {
        font-size: 1.6em;
    }

    #modalDetalhes .fa-3x {
        font-size: 2.4em;
    }

    /* ======== BOT√ÉO DETALHES - 20% MAIS SUAVE ======== */
    #tblViagensModal .btn-detalhes-viagem,
    .btn-detalhes-viagem.fundo-roxo {
        background-color: #6B2FA2 !important;
        box-shadow: 0 0 6px rgba(107,47,162,.4), 0 2px 4px rgba(107,47,162,.25) !important;
    }

    #tblViagensModal .btn-detalhes-viagem:hover,
    .btn-detalhes-viagem.fundo-roxo:hover {
        background-color: #5A199B !important;
        box-shadow: 0 0 18px rgba(107,47,162,.6), 0 4px 10px rgba(107,47,162,.4) !important;
    }

    /* ======== ESTILOS FrotiX - TABELA ======== */
    #tblEventos_wrapper .row {
        margin-top: .25rem;
        margin-bottom: .5rem;
    }

    #tblEventos_wrapper .dataTables_length,
    #tblEventos_wrapper .dt-buttons,
    #tblEventos_wrapper .dataTables_filter {
        margin-top: .25rem;
        margin-bottom: .25rem;
    }

    /* ======== HEADER DO DATATABLE - AZUL SLATE (20% mais claro que header) ======== */
    #tblEventos thead th {
        background-color: #4a6fa5 !important;
        color: #fff !important;
        font-weight: 600;
        border-color: #3d5d8a !important;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    #tblEventos thead th:hover {
        background-color: #5a7fb5 !important;
    }

    /* √çcones de ordena√ß√£o - tblEventos */
    #tblEventos thead .sorting:before,
    #tblEventos thead .sorting:after,
    #tblEventos thead .sorting_asc:before,
    #tblEventos thead .sorting_asc:after,
    #tblEventos thead .sorting_desc:before,
    #tblEventos thead .sorting_desc:after {
        color: rgba(255, 255, 255, 0.7) !important;
    }

    #tblEventos thead .sorting_asc:before,
    #tblEventos thead .sorting_desc:after {
        color: #fff !important;
    }

    /* √çcones de ordena√ß√£o - tblViagensModal */
    #tblViagensModal thead .sorting:before,
    #tblViagensModal thead .sorting:after,
    #tblViagensModal thead .sorting_asc:before,
    #tblViagensModal thead .sorting_asc:after,
    #tblViagensModal thead .sorting_desc:before,
    #tblViagensModal thead .sorting_desc:after {
        color: rgba(255, 255, 255, 0.7) !important;
    }

    #tblViagensModal thead .sorting_asc:before,
    #tblViagensModal thead .sorting_desc:after {
        color: #fff !important;
    }
</style>

<form>
    <div class="row">
        <div class="col-xl-12">
            <!-- ============================================
                 PANEL FrotiX COM HEADER ESTILIZADO
                 ============================================ -->
            <div id="panel-1" class="panel ftx-card-styled">
                <div class="panel-container show">
                    
                    <!-- HEADER DO CARD - PADR√ÉO FrotiX -->
                    <div class="ftx-card-header">
                        <h2 class="titulo-paginas">
                            <i class="fa-duotone fa-calendar-users"></i>
                            Gest√£o de Eventos
                        </h2>
                        <div class="ftx-card-actions">
                            <a href="/Viagens/UpsertEvento" class="btn btn-fundo-laranja" data-ftx-loading>
                                <i class="fa-duotone fa-clone-plus icon-pulse me-1"></i>
                                Adicionar Evento
                            </a>
                        </div>
                    </div>
                    <!-- FIM: Card Header -->

                    <div class="panel-content">
                        <div class="box-body">
                            <div id="divEventos" class="mt-3">
                                <table id="tblEventos" class="table table-bordered table-striped mt-2 ftx-table" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Evento</th>
                                            @* <th>Descri√ß√£o</th> *@
                                            <th>In√≠cio</th>
                                            <th>Fim</th>
                                            <th>Participantes</th>
                                            @* <th>Requisitante</th> *@
                                            <th>Setor Requisitante</th>
                                            <th>Custo</th>
                                            <th>Status</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Custo -->
    <div class="modal fade" id="modalCusto" tabindex="-1" aria-labelledby="modalCustoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header modal-header-dinheiro">
                    <h5 class="modal-title" id="modalCustoLabel">
                        <i class="fa-duotone fa-money-check-dollar"></i> Custo do Evento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <!-- T√≠tulo do Evento -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h4 id="tituloEventoCusto" class="text-primary mb-0"></h4>
                            <small id="periodoEventoCusto" class="text-muted"></small>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Tabela de Viagens -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="fs-5 mb-3">
                                <i class="fa-duotone fa-route"></i> Viagens associadas ao Evento
                            </h5>
                            <div class="table-responsive">
                                <table id="tblViagensModal" class="table table-striped table-bordered table-sm w-100">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Vistoria</th>
                                            <th>Data</th>
                                            <th>In√≠cio</th>
                                            <th>Requisitante</th>
                                            <th>Setor</th>
                                            <th>Motorista</th>
                                            <th>Ve√≠culo</th>
                                            <th class="text-end">Custo</th>
                                            <th class="text-center">Detalhes</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ß√£o de Estat√≠sticas das Viagens -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="text-success mb-3">
                                <i class="fa-duotone fa-chart-bar"></i> Estat√≠sticas das Viagens Realizadas
                            </h5>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="text-info">
                                    <i class="fa-duotone fa-car"></i> Total de Viagens
                                </label>
                                <input type="text" id="totalViagensModal"
                                       class="form-control text-center font-weight-bold"
                                       readonly value="0"
                                       style="background-color: #e3f2fd;" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="text-success">
                                    <i class="fa-duotone fa-dollar-sign"></i> Valor Total do Evento
                                </label>
                                <input type="text" id="custoTotalViagensModal"
                                       class="form-control text-center font-weight-bold"
                                       readonly value="R$ 0,00"
                                       style="background-color: #e8f5e9;" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="text-warning">
                                    <i class="fa-duotone fa-chart-line"></i> Custo M√©dio por Viagem
                                </label>
                                <input type="text" id="custoMedioViagemModal"
                                       class="form-control text-center font-weight-bold"
                                       readonly value="R$ 0,00"
                                       style="background-color: #fff3e0;" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                        <i class="fa-duotone fa-circle-xmark icon-space"></i>
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- /Modal de Custo -->

    <!-- ============================================
         MODAL DE DETALHAMENTO DE CUSTOS
         ============================================ -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-dinheiro">
                    <h5 class="modal-title text-white" id="modalDetalhesLabel">
                        <i class="fa-duotone fa-money-check-dollar"></i> Detalhamento de Custos da Viagem
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <!-- Nome do Evento -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 id="nomeEventoDetalhes" class="text-primary mb-0"></h4>
                        </div>
                    </div>

                    <!-- Tempo de Viagem -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fa-duotone fa-clock text-primary"></i> Tempo de Viagem
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-2">
                                                <small class="text-muted d-block">Data/Hora Inicial</small>
                                                <span id="dataHoraInicialDetalhes" class="fw-bold">--</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-2">
                                                <small class="text-muted d-block">Data/Hora Final</small>
                                                <span id="dataHoraFinalDetalhes" class="fw-bold">--</span>
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="my-2" />
                                    <div class="text-center">
                                        <small class="text-muted d-block">Tempo Total</small>
                                        <h4 id="tempoTotalDetalhes" class="mb-0 text-primary fw-bold">0,00 horas</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cards de Custos -->
                    <div class="row mb-3">
                        <!-- Custo Motorista -->
                        <div class="col-md-4">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <i class="fa-duotone fa-user-tie fa-2x text-primary mb-2"></i>
                                    <h6 class="text-muted mb-2">Custo com Motorista</h6>
                                    <h5 id="custoMotoristaDetalhes" class="mb-0 text-primary fw-bold">R$ 0,00</h5>
                                </div>
                            </div>
                        </div>

                        <!-- Custo Ve√≠culo -->
                        <div class="col-md-4">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <i class="fa-duotone fa-car fa-2x text-success mb-2"></i>
                                    <h6 class="text-muted mb-2">Custo com Ve√≠culo</h6>
                                    <h5 id="custoVeiculoDetalhes" class="mb-0 text-success fw-bold">R$ 0,00</h5>
                                </div>
                            </div>
                        </div>

                        <!-- Custo Combust√≠vel -->
                        <div class="col-md-4">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <i class="fa-duotone fa-gas-pump fa-2x text-warning mb-2"></i>
                                    <h6 class="text-muted mb-2">Custo com Combust√≠vel</h6>
                                    <h5 id="custoCombustivelDetalhes" class="mb-0 text-warning fw-bold">R$ 0,00</h5>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Custo Total -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="card-body text-center py-4">
                                    <i class="fa-duotone fa-sack-dollar fa-3x mb-2"></i>
                                    <h5 class="mb-2">Custo Total da Viagem</h5>
                                    <h2 id="custoTotalDetalhes" class="mb-0 fw-bold">R$ 0,00</h2>
                                    <small class="opacity-75">Soma de todos os custos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                        <i class="fa-duotone fa-circle-xmark icon-space"></i>
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- /Modal de Detalhamento de Custos -->

    <!-- ============================================
         OVERLAY DE LOADING - PADR√ÉO FROTIX
         ============================================ -->
    <div id="loadingOverlayEventos" class="ftx-spin-overlay" style="z-index: 999999; cursor: wait; display: flex;">
        <div class="ftx-spin-box" style="text-align: center; min-width: 300px;">
            <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" class="ftx-loading-logo" style="display: block;" />
            <div class="ftx-loading-bar"></div>
            <div class="ftx-loading-text" id="loadingMessage">Carregando P√°gina...</div>
            <div class="ftx-loading-subtext">Aguarde, por favor</div>
        </div>
    </div>
    <!-- /Overlay de Loading -->

</form>

@section ScriptsBlock
{
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <link href="https://cdn.kendostatic.com/2022.1.412/styles/kendo.default-main.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.kendostatic.com/2022.1.412/js/jszip.min.js"></script>
    <script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.all.min.js"></script>
    <script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.aspnetmvc.min.js"></script>
    <script src="https://cdn.kendostatic.com/2022.1.412/js/cultures/kendo.culture.pt-BR.min.js"></script>
    <script src="https://cdn.kendostatic.com/2022.1.412/js/messages/kendo.messages.pt-BR.min.js"></script>
    <script>
        try {
            if (window.kendo && kendo.culture) {
                kendo.culture("pt-BR");
            }
        } catch (error) {
            console.warn("Kendo pt-BR: falha ao aplicar cultura.", error);
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
    </script>
    <script type="text/javascript" src="js/loading_script.js"></script>
    <script type="text/javascript" src="js/cadastros/listaeventos.js"></script>

    <script>
        $(document).ready(function () {
            try {
                mostrarLoading('Carregando P√°gina...');
                ListaTodosEventos();

                // Apaga evento
                $(document).on('click', '.btn-apagar', function () {
                    try {
                        const id = $(this).data('id');

                        Alerta.Confirmar(
                            "Confirmar Exclus√£o",
                            "Voc√™ tem certeza que deseja apagar este evento? N√£o ser√° poss√≠vel recuperar os dados eliminados!",
                            "Sim, excluir",
                            "Cancelar"
                        ).then(function (confirmed) {
                            try {
                                if (!confirmed) return;

                                $.ajax({
                                    url: '/api/Viagem/ApagaEvento',
                                    type: 'GET',
                                    data: { eventoId: id },
                                    contentType: 'application/json; charset=utf-8',
                                    dataType: 'json',
                                    success: function (data) {
                                        try {
                                            if (data.success) {
                                                AppToast.show('Verde', data.message, 2000);
                                                $('#tblEventos').DataTable().ajax.reload(null, false);
                                            } else {
                                                AppToast.show('Vermelho', data.message, 3000);
                                            }
                                        } catch (error) {
                                            Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "btn-apagar.ajax.success", error);
                                        }
                                    },
                                    error: function (err) {
                                        try {
                                            console.log(err);
                                            AppToast.show('Vermelho', 'Ocorreu um erro ao apagar.', 3000);
                                        } catch (error) {
                                            Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "btn-apagar.ajax.error", error);
                                        }
                                    }
                                });
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "btn-apagar.Confirmar.then", error);
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "btn-apagar.click", error);
                    }
                });

                // Atualiza Status
                $(document).on('click', '.updateStatusEvento', function () {
                    try {
                        const url = $(this).data('url');
                        const $btn = $(this);

                        $.get(url, function (data) {
                            try {
                                if (data.success) {
                                    AppToast.show('Verde', "Status alterado com sucesso!", 2000);

                                    if (data.type === 1) {
                                        // Agora est√° Ativo
                                        $btn.removeClass('fundo-cinza').addClass('btn-verde');
                                        $btn.html('<i class="fa-duotone fa-circle-check me-1"></i>Ativo');
                                        $btn.attr('data-ejtip', 'Clique para Inativar');
                                    } else {
                                        // Agora est√° Inativo
                                        $btn.removeClass('btn-verde').addClass('fundo-cinza');
                                        $btn.html('<i class="fa-duotone fa-circle-xmark me-1"></i>Inativo');
                                        $btn.attr('data-ejtip', 'Clique para Ativar');
                                    }
                                } else {
                                    AppToast.show('Vermelho', 'Algo deu errado!', 3000);
                                }
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "updateStatusEvento.get.callback", error);
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "updateStatusEvento.click", error);
                    }
                });

                // Abre Modal de Custo do Evento
                $(document).on('click', '.btn-custo-evento', function () {
                    try {
                        const eventoId = $(this).data('id');

                        console.log('Clique no bot√£o de custo, ID:', eventoId);

                        if (!eventoId) {
                            console.error('ID do evento n√£o encontrado');
                            AppToast.show('Vermelho', 'Erro ao abrir modal: ID n√£o encontrado', 3000);
                            return;
                        }

                        // Armazena o ID do evento
                        eventoIdAtual = eventoId;

                        // Carrega os dados do evento
                        carregarDadosEvento(eventoId);

                        // Mostra loading padr√£o FrotiX
                        mostrarLoading('Carregando Viagens Associadas...');

                        // Inicializa ou recarrega a tabela de viagens
                        if (tabelaViagensModal) {
                            tabelaViagensModal.ajax.reload(null, false);
                        } else {
                            inicializarTabelaViagensModal();
                        }

                        // Abre o modal programaticamente
                        const modalElement = document.getElementById('modalCusto');
                        if (modalElement) {
                            const modal = new bootstrap.Modal(modalElement);
                            modal.show();
                        } else {
                            console.error('Modal n√£o encontrado no DOM');
                        }

                    } catch (error) {
                        Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "btn-custo-evento.click", error);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "document.ready", error);
            }
        });
    </script>

    <script>
        // Fun√ß√µes de Loading - Padr√£o FrotiX (Overlay)
        function mostrarLoading(mensagem = 'Carregando Eventos...') {
            $('#loadingMessage').text(mensagem);
            $('#loadingOverlayEventos').css('display', 'flex');
        }

        function esconderLoading() {
            $('#loadingOverlayEventos').css('display', 'none');
        }

        function ListaTodosEventos() {
            try {
                // Mostra loading IMEDIATAMENTE
                mostrarLoading('Carregando Eventos...');

                // Reset DataTable se j√° existir
                const dtExists = $.fn.DataTable.isDataTable('#tblEventos');
                if (dtExists) {
                    $('#tblEventos').DataTable().clear().destroy();
                }
                $('#tblEventos tbody').empty();

                // Define formato de data (se plugin estiver dispon√≠vel)
                if ($.fn.dataTable.moment) {
                    $.fn.dataTable.moment('DD/MM/YYYY');
                } else if (typeof DataTable !== 'undefined' && DataTable.datetime) {
                    DataTable.datetime('DD/MM/YYYY');
                }

                $('#tblEventos').DataTable({
                    serverSide: true,  // ‚≠ê ATIVA PAGINA√á√ÉO SERVER-SIDE
                    processing: true,  // ‚≠ê MOSTRA INDICADOR DE PROCESSAMENTO
                    order: [[1, 'desc']], // Ordenar por Data Inicial decrescente
                    autoWidth: false,
                    dom: 'Bfrtip',
                    lengthMenu: [
                        [10, 25, 50, -1],
                        ['10 linhas', '25 linhas', '50 linhas', 'Todas as Linhas']
                    ],
                    buttons: [
                        'pageLength',
                        'excel',
                        {
                            extend: 'pdfHtml5',
                            orientation: 'landscape',
                            pageSize: 'LEGAL'
                        }
                    ],
                    pageLength: 25,  // ‚≠ê TAMANHO PADR√ÉO DA P√ÅGINA
                    columnDefs: [
                        { targets: 0, className: "text-left", width: "22%" }, // Evento
                        { targets: 1, className: "text-center", width: "3%" }, // In√≠cio
                        { targets: 2, className: "text-center", width: "3%" }, // Fim
                        { targets: 3, className: "text-center", width: "3%" }, // Participantes
                        {
                            targets: 4, className: "text-left", width: "18%", // Setor Requisitante
                            render: function (data, type, full) {
                                return `
                                    <div class="text-center">
                                        <a data-ejtip="&#129489; (${full.nomeRequisitanteHTML})"
                                           style="cursor:pointer;"
                                           data-id='${data}'>
                                           ${full.nomeSetor}
                                        </a>
                                    </div>`;
                            }
                        },
                        { targets: 5, className: "text-right", width: "7%" }, // Custo
                        { targets: 6, className: "text-center", width: "7%" }, // Status
                        { targets: 7, className: "text-center", width: "15%" }  // A√ß√£o
                    ],
                    responsive: true,
                    ajax: {
                        url: "/api/viagem/listaeventos",
                        type: "GET",
                        datatype: "json",
                        data: function(d) {
                            // Envia par√¢metros de ordena√ß√£o para o servidor
                            if (d.order && d.order.length > 0) {
                                return {
                                    draw: d.draw,
                                    start: d.start,
                                    length: d.length,
                                    orderColumn: d.order[0].column,
                                    orderDir: d.order[0].dir
                                };
                            }
                            // Valores padr√£o caso n√£o haja ordena√ß√£o definida
                            return {
                                draw: d.draw,
                                start: d.start,
                                length: d.length,
                                orderColumn: 1,  // Padr√£o: coluna "In√≠cio"
                                orderDir: 'desc' // Padr√£o: decrescente
                            };
                        },
                        error: function (xhr, error, thrown) {
                            try {
                                // Esconde loading em caso de erro
                                esconderLoading();
                                console.error('Erro no DataTable:', error);
                                AppToast.show('Vermelho', 'Erro ao carregar dados', 3000);
                            } catch (err) {
                                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "tblEventos.ajax.error", err);
                            }
                        }
                    },
                    initComplete: function() {
                        // Esconde loading quando DataTable terminar
                        esconderLoading();
                    },
                    columns: [
                        { data: "nome" },
                        {
                            data: "dataInicial",
                            render: function (data) {
                                try {
                                    if (!data) return '-';
                                    const date = new Date(data);
                                    const dia = date.getDate().toString().padStart(2, '0');
                                    const mes = (date.getMonth() + 1).toString().padStart(2, '0');
                                    const ano = date.getFullYear();
                                    return `${dia}/${mes}/${ano}`;
                                } catch (error) {
                                    return '-';
                                }
                            }
                        },
                        {
                            data: "dataFinal",
                            render: function (data) {
                                try {
                                    if (!data) return '-';
                                    const date = new Date(data);
                                    const dia = date.getDate().toString().padStart(2, '0');
                                    const mes = (date.getMonth() + 1).toString().padStart(2, '0');
                                    const ano = date.getFullYear();
                                    return `${dia}/${mes}/${ano}`;
                                } catch (error) {
                                    return '-';
                                }
                            }
                        },
                        { data: "qtdParticipantes" },
                        { data: "nomeSetor" },
                        {
                            data: "custoViagem",
                            render: function (data) {
                                try {
                                    if (!data || data === 0) {
                                        return '<span class="text-muted">R$ 0,00</span>';
                                    }
                                    return parseFloat(data).toLocaleString('pt-BR', {
                                        style: 'currency',
                                        currency: 'BRL'
                                    });
                                } catch (error) {
                                    return 'R$ 0,00';
                                }
                            }
                        },
                        {
                            data: "status",
                            searchable: false,
                            render: function (data, type, row) {
                                try {
                                    if (data === 1) {
                                        return `<a href="javascript:void(0)" 
                                                   class="updateStatusEvento btn btn-verde btn-xs text-white" 
                                                   data-url="/api/ViagemEvento/UpdateStatusEvento?Id=${row.eventoId}"
                                                   data-ejtip="Clique para Inativar">
                                                    <i class="fa-duotone fa-circle-check me-1"></i>Ativo
                                                </a>`;
                                    } else {
                                        return `<a href="javascript:void(0)" 
                                                   class="updateStatusEvento btn fundo-cinza btn-xs text-white" 
                                                   data-url="/api/ViagemEvento/UpdateStatusEvento?Id=${row.eventoId}"
                                                   data-ejtip="Clique para Ativar">
                                                    <i class="fa-duotone fa-circle-xmark me-1"></i>Inativo
                                                </a>`;
                                    }
                                } catch (error) {
                                    return '<span class="badge bg-secondary">-</span>';
                                }
                            }
                        },
                        {
                            data: "eventoId",
                            orderable: false,
                            searchable: false,
                            render: function (data, type, row) {
                                try {
                                    // Verifica se h√° viagens associadas ao evento
                                    var temViagens = row.viagensCount > 0;
                                    var btnApagarClasse = temViagens
                                        ? "btn btn-secondary text-white btn-icon-28 disabled"
                                        : "btn btn-vinho text-white btn-icon-28 btn-apagar";
                                    var btnApagarTooltip = temViagens
                                        ? `Este evento possui ${row.viagensCount} viagem(ns) associada(s) e n√£o pode ser exclu√≠do`
                                        : "Apagar Evento";
                                    var btnApagarDataId = temViagens ? "" : `data-id="${data}"`;

                                    return `
                                    <div class="text-center">
                                        <a href="/Viagens/UpsertEvento?id=${data}"
                                           class="btn btn-azul text-white btn-icon-28"
                                           data-ejtip="Editar Evento">
                                            <i class="fa-duotone fa-pen-to-square"></i>
                                        </a>
                                        <a class="btn btn-foto text-white btn-icon-28 btn-custo-evento"
                                           data-ejtip="Ver Custo do Evento"
                                           data-id="${data}">
                                            <i class="fa-duotone fa-money-check-dollar"></i>
                                        </a>
                                        <a class="${btnApagarClasse}"
                                           data-ejtip="${btnApagarTooltip}"
                                           ${btnApagarDataId}>
                                            <i class="fa-duotone fa-trash"></i>
                                        </a>
                                    </div>`;
                                } catch (error) {
                                    Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "render.acao", error);
                                    return '';
                                }
                            }
                        }
                    ],
                    language: {
                        emptyTable: "Nenhum registro encontrado",
                        info: "Mostrando de _START_ at√© _END_ de _TOTAL_ registros",
                        infoEmpty: "Mostrando 0 at√© 0 de 0 registros",
                        infoFiltered: "(Filtrados de _MAX_ registros)",
                        infoThousands: ".",
                        loadingRecords: "Carregando...",
                        processing: "Processando...",
                        zeroRecords: "Nenhum registro encontrado",
                        search: "Pesquisar",
                        paginate: {
                            next: "Pr√≥ximo",
                            previous: "Anterior",
                            first: "Primeiro",
                            last: "√öltimo"
                        },
                        aria: {
                            sortAscending: ": Ordenar colunas de forma ascendente",
                            sortDescending: ": Ordenar colunas de forma descendente"
                        },
                        select: {
                            rows: { "_": "Selecionado %d linhas", "1": "Selecionado 1 linha" },
                            cells: { "1": "1 c√©lula selecionada", "_": "%d c√©lulas selecionadas" },
                            columns: { "1": "1 coluna selecionada", "_": "%d colunas selecionadas" }
                        },
                        buttons: {
                            copySuccess: { "1": "Uma linha copiada com sucesso", "_": "%d linhas copiadas com sucesso" },
                            collection: "Cole√ß√£o",
                            colvis: "Visibilidade da Coluna",
                            colvisRestore: "Restaurar Visibilidade",
                            copy: "Copiar",
                            copyKeys: "Pressione Ctrl ou ‚åò + C para copiar. Esc para cancelar.",
                            copyTitle: "Copiar para a √Årea de Transfer√™ncia",
                            csv: "CSV",
                            excel: "Excel",
                            pageLength: { "-1": "Mostrar todos os registros", "_": "Mostrar %d registros" },
                            pdf: "PDF",
                            print: "Imprimir"
                        },
                        autoFill: {
                            cancel: "Cancelar",
                            fill: "Preencher todas as c√©lulas com",
                            fillHorizontal: "Preencher horizontalmente",
                            fillVertical: "Preencher verticalmente"
                        },
                        lengthMenu: "Exibir _MENU_ resultados por p√°gina",
                        searchBuilder: {
                            add: "Adicionar Condi√ß√£o",
                            button: { "0": "Construtor de Pesquisa", "_": "Construtor de Pesquisa (%d)" },
                            clearAll: "Limpar Tudo",
                            condition: "Condi√ß√£o",
                            conditions: {
                                date: { after: "Depois", before: "Antes", between: "Entre", empty: "Vazio", equals: "Igual", not: "N√£o", notBetween: "N√£o Entre", notEmpty: "N√£o Vazio" },
                                number: { between: "Entre", empty: "Vazio", equals: "Igual", gt: "Maior Que", gte: "Maior ou Igual a", lt: "Menor Que", lte: "Menor ou Igual a", not: "N√£o", notBetween: "N√£o Entre", notEmpty: "N√£o Vazio" },
                                string: { contains: "Cont√©m", empty: "Vazio", endsWith: "Termina Com", equals: "Igual", not: "N√£o", notEmpty: "N√£o Vazio", startsWith: "Come√ßa Com" },
                                array: { contains: "Cont√©m", empty: "Vazio", equals: "Igual √†", not: "N√£o", notEmpty: "N√£o vazio", without: "N√£o possui" }
                            },
                            data: "Data",
                            deleteTitle: "Excluir regra de filtragem",
                            logicAnd: "E",
                            logicOr: "Ou",
                            title: { "0": "Construtor de Pesquisa", "_": "Construtor de Pesquisa (%d)" },
                            value: "Valor",
                            leftTitle: "Crit√©rios Externos",
                            rightTitle: "Crit√©rios Internos"
                        },
                        searchPanes: {
                            clearMessage: "Limpar Tudo",
                            collapse: { "0": "Pain√©is de Pesquisa", "_": "Pain√©is de Pesquisa (%d)" },
                            count: "{total}",
                            countFiltered: "{shown} ({total})",
                            emptyPanes: "Nenhum Painel de Pesquisa",
                            loadMessage: "Carregando Pain√©is de Pesquisa...",
                            title: "Filtros Ativos"
                        },
                        thousands: ".",
                        datetime: {
                            previous: "Anterior",
                            next: "Pr√≥ximo",
                            hours: "Hora",
                            minutes: "Minuto",
                            seconds: "Segundo",
                            amPm: ["am", "pm"],
                            unknown: "-",
                            months: {
                                "0": "Janeiro", "1": "Fevereiro", "2": "Mar√ßo", "3": "Abril",
                                "4": "Maio", "5": "Junho", "6": "Julho", "7": "Agosto",
                                "8": "Setembro", "9": "Outubro", "10": "Novembro", "11": "Dezembro"
                            },
                            weekdays: ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinte-feira", "Sexta-feira", "S√°bado"]
                        },
                        editor: {
                            close: "Fechar",
                            create: { button: "Novo", submit: "Criar", title: "Criar novo registro" },
                            edit: { button: "Editar", submit: "Atualizar", title: "Editar registro" },
                            error: { system: "Ocorreu um erro no sistema." },
                            multi: {
                                noMulti: "Essa entrada pode ser editada individualmente",
                                restore: "Desfazer altera√ß√µes",
                                title: "M√∫ltiplos valores",
                                info: "Itens selecionados cont√™m valores diferentes para esta entrada."
                            },
                            remove: {
                                button: "Remover",
                                confirm: { "_": "Tem certeza que quer deletar %d linhas?", "1": "Tem certeza que quer deletar 1 linha?" },
                                submit: "Remover",
                                title: "Remover registro"
                            }
                        },
                        decimal: ","
                    },
                    width: "100%"
                });

            } catch (error) {
                // Esconde loading em caso de erro
                esconderLoading();
                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "ListaTodosEventos", error);
            }
        }

        // ==========================================
        // MODAL DE CUSTO DO EVENTO
        // ==========================================

        let tabelaViagensModal = null;
        let eventoIdAtual = null;

        // Limpa dados quando o modal √© fechado
        $('#modalCusto').on('hidden.bs.modal', function () {
            try {
                eventoIdAtual = null;
                $('#tituloEventoCusto').text('');
                $('#periodoEventoCusto').text('');
                $('#valorTotalEventoModal').val('R$ 0,00');
                $('#totalViagensModal').val('0');
                $('#custoTotalViagensModal').val('R$ 0,00');
                $('#custoMedioViagemModal').val('R$ 0,00');
            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "modalCusto.hidden", error);
            }
        });

        // Fun√ß√£o para carregar dados b√°sicos do evento
        function carregarDadosEvento(eventoId) {
            try {
                $.ajax({
                    url: '/api/ViagemEvento/ObterPorId',
                    type: 'GET',
                    data: { id: eventoId },
                    success: function (response) {
                        try {
                            if (response.success && response.data) {
                                const evento = response.data;

                                // Atualiza t√≠tulo (camelCase: nome)
                                $('#tituloEventoCusto').text(evento.nome || 'Evento sem nome');

                                // Formata e exibe per√≠odo (camelCase: dataInicial, dataFinal)
                                const dataInicio = evento.dataInicial ? formatarData(evento.dataInicial) : '-';
                                const dataFim = evento.dataFinal ? formatarData(evento.dataFinal) : '-';
                                $('#periodoEventoCusto').text(`Per√≠odo: ${dataInicio} a ${dataFim}`);

                            } else {
                                console.warn('Dados do evento n√£o encontrados');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "carregarDadosEvento.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        try {
                            console.error('Erro ao carregar dados do evento:', error);
                            Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "carregarDadosEvento.error", error);
                        } catch (err) {
                            console.error('Erro no tratamento de erro:', err);
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "carregarDadosEvento", error);
            }
        }

        // Fun√ß√£o para inicializar a tabela de viagens do modal
        function inicializarTabelaViagensModal() {
            try {
                tabelaViagensModal = $('#tblViagensModal').DataTable({
                    lengthChange: false,
                    searching: false,
                    ordering: false,
                    deferRender: true,
                    responsive: true,
                    processing: false,
                    ajax: {
                        url: "/api/viagem/listaviagensevento",
                        type: "GET",
                        data: function () {
                            return { Id: eventoIdAtual };
                        },
                        dataSrc: 'data',
                        complete: function (data) {
                            try {
                                console.log('Viagens carregadas:', data.responseJSON?.data?.length);
                                carregarEstatisticasViagensModal();
                                
                                // Esconde loading padr√£o FrotiX
                                esconderLoading();
                                
                                // Garante que o backdrop do modalCusto permane√ßa
                                setTimeout(function() {
                                    if ($('#modalCusto').hasClass('show') && !$('.modal-backdrop').length) {
                                        $('body').append('<div class="modal-backdrop fade show"></div>');
                                    }
                                }, 100);
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "tabelaViagensModal.ajax.complete", error);
                            }
                        },
                        error: function (xhr, status, error) {
                            try {
                                console.error('Erro ao carregar viagens:', error);
                                
                                // Esconde loading mesmo em caso de erro
                                esconderLoading();
                                
                                // Garante que o backdrop do modalCusto permane√ßa
                                setTimeout(function() {
                                    if ($('#modalCusto').hasClass('show') && !$('.modal-backdrop').length) {
                                        $('body').append('<div class="modal-backdrop fade show"></div>');
                                    }
                                }, 100);
                                
                                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "tabelaViagensModal.ajax.error", error);
                            } catch (err) {
                                console.error('Erro no tratamento de erro:', err);
                            }
                        }
                    },
                    columns: [
                        {
                            data: "noFichaVistoria",
                            className: "text-center",
                            width: "8%",
                            render: function (data) {
                                return data || '-';
                            }
                        },
                        {
                            data: "dataInicial",
                            className: "text-center",
                            width: "10%",
                            render: function (data) {
                                try {
                                    if (!data) return '-';
                                    const date = new Date(data);
                                    const dia = date.getDate().toString().padStart(2, '0');
                                    const mes = (date.getMonth() + 1).toString().padStart(2, '0');
                                    const ano = date.getFullYear();
                                    return `${dia}/${mes}/${ano}`;
                                } catch (error) {
                                    return '-';
                                }
                            }
                        },
                        {
                            data: "horaInicio",
                            className: "text-center",
                            width: "8%",
                            render: function (data) {
                                try {
                                    if (!data) return '-';
                                    const date = new Date(data);
                                    const horas = date.getHours().toString().padStart(2, '0');
                                    const minutos = date.getMinutes().toString().padStart(2, '0');
                                    return `${horas}:${minutos}`;
                                } catch (error) {
                                    return '-';
                                }
                            }
                        },
                        {
                            data: "nomeRequisitante",
                            className: "text-left",
                            width: "15%"
                        },
                        {
                            data: "nomeSetor",
                            className: "text-left",
                            width: "15%"
                        },
                        {
                            data: "nomeMotorista",
                            className: "text-left",
                            width: "15%",
                            render: function (data) {
                                return data || '<span class="text-muted">-</span>';
                            }
                        },
                        {
                            data: "placa",
                            className: "text-center",
                            width: "10%",
                            render: function (data) {
                                return data || '<span class="text-muted">-</span>';
                            }
                        },
                        {
                            data: "custoViagem",
                            className: "text-end",
                            width: "12%",
                            render: function (data) {
                                try {
                                    if (!data || data === 0) {
                                        return '<span class="text-muted">R$ 0,00</span>';
                                    }
                                    return formatarMoeda(data);
                                } catch (error) {
                                    return 'R$ 0,00';
                                }
                            }
                        },
                        {
                            data: "viagemId",  // ‚úÖ CORRETO!
                            className: "text-center",
                            width: "7%",
                            orderable: false,
                            render: function (data, type, row) {
                                return `
                                    <a class="btn fundo-roxo text-white btn-icon-28 btn-detalhes-viagem"
                                       data-id="${data}"
                                       data-ejtip="Detalhamento de Custos">
                                        <i class="fa-duotone fa-file-invoice-dollar"></i>
                                    </a>
                                `;
                            }
                        }
                    ],
                    language: {
                        emptyTable: "Nenhuma viagem encontrada para este evento",
                        info: "Mostrando de _START_ at√© _END_ de _TOTAL_ viagens",
                        infoEmpty: "Mostrando 0 at√© 0 de 0 viagens",
                        infoFiltered: "(Filtradas de _MAX_ viagens)",
                        loadingRecords: "Carregando...",
                        processing: "Processando...",
                        zeroRecords: "Nenhuma viagem encontrada",
                        paginate: {
                            next: "Pr√≥ximo",
                            previous: "Anterior",
                            first: "Primeiro",
                            last: "√öltimo"
                        }
                    },
                    pageLength: 6,
                    dom: 'rtip'
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "inicializarTabelaViagensModal", error);
            }
        }

        // Fun√ß√£o para carregar estat√≠sticas das viagens
        function carregarEstatisticasViagensModal() {
            try {
                $.ajax({
                    url: "/api/viagem/ObterTotalCustoViagensEvento",
                    type: "GET",
                    data: { Id: eventoIdAtual },
                    success: function (response) {
                        try {
                            if (response.success) {
                                // Preencher campos de estat√≠sticas
                                $("#totalViagensModal").val(response.totalViagens || 0);
                                $("#custoTotalViagensModal").val(response.totalCustoFormatado || "R$ 0,00");

                                // Calcular e preencher m√©dia
                                const media = response.custoMedioFormatado ||
                                    formatarMoeda(response.totalViagens > 0 ? response.totalCusto / response.totalViagens : 0);
                                $("#custoMedioViagemModal").val(media);

                                console.log('Estat√≠sticas carregadas:', response);
                            } else {
                                // Valores padr√£o em caso de falha
                                $("#totalViagensModal").val("0");
                                $("#custoTotalViagensModal").val("R$ 0,00");
                                $("#custoMedioViagemModal").val("R$ 0,00");
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "carregarEstatisticasViagensModal.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        try {
                            console.error('Erro ao carregar estat√≠sticas:', error);
                            // Valores padr√£o em caso de erro
                            $("#totalViagensModal").val("0");
                            $("#custoTotalViagensModal").val("R$ 0,00");
                            $("#custoMedioViagemModal").val("R$ 0,00");
                        } catch (err) {
                            console.error('Erro no tratamento de erro:', err);
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "carregarEstatisticasViagensModal", error);
            }
        }

        // Fun√ß√£o auxiliar para formatar moeda
        function formatarMoeda(valor) {
            try {
                if (!valor && valor !== 0) return "R$ 0,00";
                return parseFloat(valor).toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            } catch (error) {
                return "R$ 0,00";
            }
        }

        // Fun√ß√£o auxiliar para formatar data
        function formatarData(data) {
            try {
                if (!data) return '-';
                const date = new Date(data);
                const dia = date.getDate().toString().padStart(2, '0');
                const mes = (date.getMonth() + 1).toString().padStart(2, '0');
                const ano = date.getFullYear();
                return `${dia}/${mes}/${ano}`;
            } catch (error) {
                return '-';
            }
        }

    </script>

    <script>
        // ============================================
        // EVENT HANDLER: Abre Modal de Detalhamento
        // ============================================
        $(document).ready(function () {
            try {
                $(document).on('click', '.btn-detalhes-viagem', function () {
                    try {
                        const viagemId = $(this).data('id');

                        console.log('Clique no bot√£o de detalhamento, Viagem ID:', viagemId);

                        if (!viagemId) {
                            console.error('ID da viagem n√£o encontrado');
                            AppToast.show('Vermelho', 'Erro ao abrir modal: ID n√£o encontrado', 3000);
                            return;
                        }

                        // Carrega detalhamento de custos
                        carregarDetalhamentoCustos(viagemId);

                        // Abre o modal programaticamente
                        const modalElement = document.getElementById('modalDetalhes');
                        if (modalElement) {
                            const modal = new bootstrap.Modal(modalElement);
                            modal.show();
                        } else {
                            console.error('Modal n√£o encontrado no DOM');
                        }

                    } catch (error) {
                        Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "btn-detalhes-viagem.click", error);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("ListaEventos.cshtml", "btn-detalhes-viagem.document.ready", error);
            }
        });
    </script>
}
