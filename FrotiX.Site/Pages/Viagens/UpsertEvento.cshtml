@*
 * ‚ö° ARQUIVO: Pages/Viagens/UpsertEvento.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio criar/editar eventos (corporativos, reuni√µes, atividades
 *                   que geram viagens). Campos: nome, per√≠odo (data inicial/final),
 *                   requisitante, setor, quantidade participantes, descri√ß√£o
 *
 * üì• ENTRADAS     : @page /Viagens/UpsertEvento, route parameter ?id={eventoId} (edi√ß√£o),
 *                   Form inputs (txtNomeEvento, dtDataInicial, dtDataFinal,
 *                   ddtRequisitante, ddtSetor, txtQtdParticipantes, rteDescricao)
 *
 * üì§ SA√çDAS       : POST /api/ViagemEvento/Insere ou Edita, redirect /Viagens/ListaEventos,
 *                   AppToast feedback, valida√ß√µes Syncfusion
 *
 * üîó CHAMADA POR  : Viagens/ListaEventos (bot√£o "Adicionar Evento", editar linha evento),
 *                   menu "Cadastros > Viagens > Eventos"
 *
 * üîÑ CHAMA        : UpsertEventoModel (code-behind), API endpoints (Insere, Edita, GetById),
 *                   Syncfusion DropdownTree (requisitante, setor), RichTextEditor
 *
 * üì¶ DEPEND√äNCIAS : ASP.NET Core Razor Pages, UpsertEventoModel, Syncfusion EJ2
 *                   (DropdownTree, DatePicker, RichTextEditor), Bootstrap 5, jQuery,
 *                   Font Awesome 6, AppToast.js, Alerta.js, FtxSpin
 *
 * üìù OBSERVA√á√ïES  : ~200 linhas. P√°gina SIMPLES de CRUD eventos. CSS inline para
 *                   estilos header, controles Syncfusion unificados. Valida√ß√µes
 *                   b√°sicas (nome obrigat√≥rio, data inicial <= final). ViewData
 *                   padr√£o FrotiX (Title, PageName, Heading, Category, PageIcon)
 * *@
@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers
@using Syncfusion.EJ2
@using Syncfusion.EJ2.DropDowns

@model FrotiX.Pages.Viagens.UpsertEventoModel

@{
ViewData["Title"] = "Eventos";
ViewData["PageName"] = "viagens_upsertevento";
ViewData["Heading"] = "<i class='fa-duotone fa-calendar-users'></i> Cadastros: <span class='fw-300'>Eventos</span>";
ViewData["Category1"] = "Cadastros";
ViewData["PageIcon"] = "fa-duotone fa-calendar-users";
}

@section HeadBlock {
	<style>
/* ======== OUTLINE BRANCO NO BOT√ÉO DO HEADER (Padr√£o FrotiX) ======== */
		.ftx-card-header .btn-fundo-laranja {
			outline: 2px solid rgba(255, 255, 255, 0.5) !important;
			outline-offset: 1px;
			transition: all 0.2s ease;
		}

		.ftx-card-header .btn-fundo-laranja:hover {
			outline: 2px solid rgba(255, 255, 255, 0.8) !important;
			outline-offset: 2px;
		}

	</style>
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />
}

<style>
    /* ======== ANIMA√á√ÉO SUAVE DO HEADER ======== */
    @@keyframes headerGradientShift {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }

    /* ======== CORRE√á√ÉO DO HEADER DO CARD ======== */
    .ftx-card-header {
        background: linear-gradient(135deg, #325d88 0%, #2a4d73 25%, #3d6f9e 50%, #2a4d73 75%, #325d88 100%);
        background-size: 400% 400%;
        animation: headerGradientShift 8s ease infinite;
    }

    /* ======== CORRE√á√ÉO DA FONTE DO T√çTULO ======== */
    .ftx-card-header .titulo-paginas {
        font-family: 'Outfit', sans-serif !important;
        font-weight: 900 !important;
        font-size: 1.925rem !important;
        color: #ffffff !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25) !important;
    }

    .ftx-card-header .titulo-paginas i {
        --fa-primary-color: #ffffff;
        --fa-secondary-color: rgba(255, 255, 255, 0.7);
        font-size: 2.2rem !important;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.3));
    }

    /* ======== OUTLINE DO BOT√ÉO HEADER - Padr√£o FrotiX (definido em frotix.css) ======== */

    /* ========================================
           ESTILOS OTIMIZADOS PARA BOOTSTRAP 5
           + COMPONENTES SYNCFUSION
           ======================================== */

    /* === CONTROLES DE FORMUL√ÅRIO === */

    /* Altura padr√£o unificada */
    .form-control,
    .form-select,
    .e-dropdowntree,
    .e-dropdowntree .e-ddt-wrapper,
    .e-dropdowntree .e-ddt {
        height: 40px !important;
        min-height: 40px !important;
        max-height: 40px !important;
    }

    /* Estilo dos inputs */
    .form-control,
    .form-select {
        padding: 0.5rem 0.875rem !important;
        font-size: 0.875rem !important;
        border-radius: 0.375rem !important;
    }
    
    .form-control::placeholder {
        color: #adb5bd !important;
        font-style: italic;
    }

    /* ========================================
           CORRE√á√ÉO CONSERVADORA PARA SYNCFUSION DROPDOWNTREE
           Mant√©m a estrutura original do Syncfusion
           ======================================== */

    /* === AJUSTE B√ÅSICO DE ALTURA E APAR√äNCIA === */

    /* Container principal - ajuste m√≠nimo */
    .e-control.e-dropdowntree,
    .e-dropdowntree {
        width: 100% !important;
        display: block !important;
        font-size: 0.875rem !important;
    }

        /* Input group do Syncfusion */
        .e-dropdowntree .e-input-group,
        .e-dropdowntree.e-input-group {
            height: 40px !important;
            border: 1px solid #ced4da !important;
            border-radius: 0.375rem !important;
            background-color: #fff !important;
        }

        /* Input dentro do dropdown */
        .e-dropdowntree input.e-dropdownbase,
        .e-dropdowntree .e-input {
            height: 38px !important;
            padding: 0.5rem 0.875rem !important;
            font-size: 0.875rem !important;
            border: none !important;
            background: transparent !important;
        }

        /* Texto do placeholder e valor selecionado */
        .e-dropdowntree .e-input-value,
        .e-dropdowntree input::placeholder {
            color: #495057 !important;
            font-size: 0.875rem !important;
        }

        .e-dropdowntree input:placeholder-shown {
            color: #6c757d !important;
        }

        /* === √çCONES === */

        /* Container dos √≠cones */
        .e-dropdowntree .e-input-group-icon,
        .e-dropdowntree .e-ddt-icon {
            border: none !important;
            background: transparent !important;
            min-height: 36px !important;
            display: flex !important;
            align-items: center !important;
            padding: 0 8px !important;
        }

            /* Ajuste do √≠cone de dropdown */
            .e-dropdowntree .e-input-group-icon.e-ddt-icon {
                border-left: 1px solid #ced4da !important;
            }

        /* === ESTADOS INTERATIVOS === */

        /* Hover */
        .e-dropdowntree:hover .e-input-group,
        .e-dropdowntree .e-input-group:hover {
            border-color: #86b7fe !important;
        }

        /* Focus */
        .e-dropdowntree.e-input-focus .e-input-group,
        .e-dropdowntree .e-input-group.e-input-focus {
            border-color: #86b7fe !important;
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25) !important;
            outline: none !important;
        }

        /* === CHIPS (SELE√á√ÉO M√öLTIPLA) === */

        .e-dropdowntree .e-chips-wrapper {
            min-height: 36px !important;
            padding: 0.25rem !important;
        }

        .e-dropdowntree .e-chip {
            height: 24px !important;
            margin: 2px !important;
            font-size: 0.75rem !important;
        }

    /* === POPUP DO DROPDOWN === */

    .e-popup.e-dropdownbase,
    .e-ddt-popup {
        border: 1px solid rgba(0,0,0,.15) !important;
        border-radius: 0.375rem !important;
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.2) !important;
        margin-top: 2px !important;
        font-size: 0.875rem !important;
    }

    /* === FIX PARA ALINHAMENTO COM BOOTSTRAP === */

    /* Remove margins indesejadas */
    .form-label + .e-dropdowntree {
        margin-top: 0 !important;
    }

    /* IDs espec√≠ficos dos seus componentes */
    #lstRequisitanteEvento,
    #ddtSetorRequisitanteEvento {
        margin-bottom: 0 !important;
    }

    /* === COMPATIBILIDADE COM LABELS DO BOOTSTRAP === */

    /* Ajuste quando precedido por label */
    label.form-label + .e-dropdowntree,
    label.form-label + #lstRequisitanteEvento,
    label.form-label + #ddtSetorRequisitanteEvento {
        display: block !important;
        width: 100% !important;
    }

    /* === LIMPEZA DE ESTILOS CONFLITANTES === */

    /* Remove bordas duplas */
    .e-dropdowntree .e-input-group .e-input {
        border: none !important;
    }

    /* Remove backgrounds extras */
    .e-dropdowntree .e-input-group .e-control-wrapper {
        background: transparent !important;
    }

    /* === GARANTIR VISIBILIDADE DO CONTE√öDO === */

    /* For√ßa exibi√ß√£o do texto */
    .e-dropdowntree .e-input-value:not(:empty) {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* Placeholder vis√≠vel */
    .e-dropdowntree .e-placeholder {
        display: block !important;
        opacity: 0.6 !important;
    }

    /* Garante que o input seja vis√≠vel */
    .e-dropdowntree input[type="text"] {
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* === CORRE√á√ïES ESPEC√çFICAS PARA CAMPOS DE SELE√á√ÉO === */

    /* Fix: lstRequisitanteEvento - garantir bordas vis√≠veis em todas as estruturas poss√≠veis */
    #lstRequisitanteEvento,
    #lstRequisitanteEvento.e-control,
    #lstRequisitanteEvento.e-dropdowntree,
    #lstRequisitanteEvento .e-input-group,
    #lstRequisitanteEvento.e-input-group,
    #lstRequisitanteEvento > .e-input-group,
    #lstRequisitanteEvento .e-ddt,
    #lstRequisitanteEvento .e-ddt-wrapper {
        border: 1px solid #ced4da !important;
        border-radius: 0.375rem !important;
        box-sizing: border-box !important;
    }

    /* Evita borda dupla nos elementos internos */
    #lstRequisitanteEvento .e-input-group .e-input,
    #lstRequisitanteEvento .e-ddt .e-input {
        border: none !important;
    }

    /* Fix: lstStatus e lstNovaFinalidade - remover max-height para n√£o cortar o conte√∫do */
    #lstStatus.form-select,
    #lstNovaFinalidade.form-select {
        max-height: none !important;
        height: auto !important;
        min-height: 40px !important;
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
        line-height: 1.5 !important;
    }

    /* === LABELS === */

    .form-label {
        margin-bottom: 0.25rem !important;
        margin-top: 0 !important;
        font-size: 0.8125rem !important;
        font-weight: 600 !important;
        color: #495057 !important;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    /* Asterisco vermelho it√°lico para campos obrigat√≥rios */
    .form-label .required-asterisk {
        color: #dc3545 !important;
        font-style: italic;
        margin-right: -2px;
        margin-left: 2px;
    }

        /* Labels com classe small */
        .form-label.small {
            font-size: 0.8125rem !important;
        }
        
    /* √çcones nos labels */
    .form-label i {
        color: #6c757d;
        font-size: 0.875rem;
    }

    /* === SE√á√ïES DO FORMUL√ÅRIO === */
    .form-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.25rem;
        border: 1px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .form-section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #3B7DDD;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #3B7DDD;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-section-title i {
        color: #3B7DDD;
        font-size: 1rem;
    }

    /* === ESPA√áAMENTO E LAYOUT === */

    /* Espa√ßamento entre rows */
    .row {
        margin-bottom: 0.75rem;
    }

        .row:last-child {
            margin-bottom: 0;
        }

        /* Gutters personalizados */
        .row.g-2 > * {
            padding-right: 0.5rem !important;
            padding-left: 0.5rem !important;
        }

    /* Margens bottom espec√≠ficas */
    .mb-2 {
        margin-bottom: 0.75rem !important;
    }

    .mb-3 {
        margin-bottom: 1rem !important;
    }

    /* === MENSAGENS DE VALIDA√á√ÉO === */

    .text-danger {
        font-size: 0.75rem !important;
        margin-top: 0.25rem !important;
        margin-left: 0 !important;
        display: block;
    }

        .text-danger:empty {
            display: none;
        }

    .alert-danger:empty {
        display: none;
    }

    /* === BOT√ïES === */
    /* Herda estilos do ftx-card-styled.css */
    
    .btn.w-100 {
        width: 100% !important;
    }

    /* === BOT√ÉO COM SPINNER === */
    .btn .btn-loading {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn:disabled {
        opacity: 0.8;
        cursor: wait;
    }
    
    .btn .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }

    /* === T√çTULOS E CABE√áALHOS === */

    h2.text-primary {
        font-size: 1.375rem !important;
        margin-bottom: 0.75rem !important;
        padding-bottom: 0.5rem !important;
        font-weight: 600 !important;
    }

    h3 {
        font-size: 1.125rem !important;
        margin-top: 1.25rem !important;
        margin-bottom: 0.75rem !important;
        font-weight: 600 !important;
    }

    /* Ajustes para classes do Bootstrap 5 */
    .fs-4 {
        font-size: 1.375rem !important;
    }

    .fs-5 {
        font-size: 1.125rem !important;
    }

    /* === CARDS E CONTAINERS === */
    /* Herda estilos do ftx-card-styled.css */

    .box-body {
        padding: 1rem;
    }

    /* === INPUTS ESPEC√çFICOS === */

    /* Inputs de data e n√∫mero */
    input[type="date"].form-control,
    input[type="number"].form-control {
        height: 38px !important;
        padding: 0.375rem 0.75rem !important;
    }

    /* === CARDS DE ESTAT√çSTICAS === */
    #estatisticasViagens .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    #estatisticasViagens .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    #estatisticasViagens h4 {
        font-size: 1.5rem;
    }

    /* === TABELAS === */

    #tblViagens,
    .table {
        margin-top: 0.75rem;
        font-size: 0.875rem !important;
    }

        .table thead th {
            padding: 0.5rem !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            background-color: #f8f9fa !important;
        }

        .table tbody td {
            padding: 0.375rem !important;
            font-size: 0.875rem !important;
            vertical-align: middle !important;
        }

    /* Tabela responsiva */
    .table-responsive {
        border-radius: 0.375rem;
        overflow-x: auto;
    }

    /* === PAGINA√á√ÉO DO DATATABLE === */

    /* Bot√µes de pagina√ß√£o - PADR√ÉO LARANJA FROTIX */
    .dataTables_wrapper .dataTables_paginate .paginate_button,
    .dataTables_wrapper .page-item .page-link {
        color: #ffffff !important;
        background: linear-gradient(135deg, #cc5200 0%, #b34700 100%) !important;
        border: none !important;
        border-radius: 0.25rem !important;
        padding: 0.25rem 0.5rem !important;
        margin: 0 2px !important;
        box-shadow: 0 2px 4px rgba(204, 82, 0, 0.3) !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover,
    .dataTables_wrapper .page-item .page-link:hover {
        color: #ffffff !important;
        background: linear-gradient(135deg, #b34700 0%, #a03d00 100%) !important;
        transform: translateY(-1px) !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.active, 
    .dataTables_wrapper .page-item.active .page-link {
        color: #fff !important;
        background: linear-gradient(135deg, #a03d00 0%, #8a3300 100%) !important;
        font-weight: bold !important;
        border: 1px solid rgba(255,255,255,0.2) !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
    .dataTables_wrapper .page-item.disabled .page-link {
        color: #6c757d !important;
        background: #e9ecef !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
        opacity: 0.8 !important;
        box-shadow: none !important;
    }

    /* For√ßa cor branca nos links internos */
    .dataTables_wrapper .dataTables_paginate .paginate_button *,
    .dataTables_wrapper .page-item .page-link * {
        color: #ffffff !important;
    }

    /* Info de pagina√ß√£o (ex: "Mostrando 1 a 10 de 25 registros") */
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_length label,
    .dataTables_wrapper .dataTables_filter label {
        color: #495057 !important;
        padding-top: 0.75rem !important;
        font-size: 0.875rem !important;
    }

    /* Container da pagina√ß√£o */
    .dataTables_wrapper .dataTables_paginate {
        padding-top: 0.75rem !important;
    }

    /* === ALINHAMENTO VERTICAL === */

    /* Flex para colunas - garante alinhamento */
    .row > [class*="col-"] {
        display: flex;
        flex-direction: column;
    }

        /* Labels alinhados ao topo */
        .row > [class*="col-"] .form-label {
            align-self: flex-start;
        }

    /* === BORDAS E DIVISORES === */

    .border-bottom {
        border-bottom: 1px solid #dee2e6 !important;
    }


    /* === UTILIT√ÅRIOS ADICIONAIS === */

    /* Remove outline padr√≠o do browser */
    .form-control:focus,
    .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        border-color: #86b7fe !important;
        outline: 0 !important;
    }

    /* Transi√ß√µes suaves */
    .form-control,
    .form-select,
    .btn,
    .e-dropdowntree {
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
    }

    /* Cursor pointer para elementos interativos */
    .btn,
    .form-select,
    label.form-label {
        cursor: pointer;
    }

    /* === BOT√ÉO COM SPINNER === */
    .btn .btn-loading {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn:disabled {
        opacity: 0.8;
        cursor: wait;
    }
    
    .btn .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }

    /* Desabilita resize de textarea se houver */
    textarea.form-control {
        resize: vertical;
    }

    /* Campo de texto readonly com apar√™ncia apropriada */
    #txtSetorRequisitante[readonly] {
        background-color: #e9ecef !important;
        opacity: 1 !important;
        cursor: not-allowed !important;
        color: #495057 !important;
    }

        /* Placeholder mais vis√≠vel para campo readonly */
        #txtSetorRequisitante[readonly]::placeholder {
            color: #6c757d !important;
            opacity: 1 !important;
            font-style: italic;
        }

    /* Garante que o campo tenha a mesma altura dos outros controles */
    #txtSetorRequisitante {
        height: 40px !important;
        padding: 0.5rem 0.875rem !important;
        font-size: 0.875rem !important;
    }

    /* Garantir que o DropDownTree oculto n√£o ocupe espa√ßo */
    #ddtSetorRequisitanteEvento,
    #ddtSetorRequisitanteEvento * {
        position: absolute !important;
        left: -9999px !important;
        visibility: hidden !important;
    }

	/* Estilo para o dropdown de setores com hierarquia */
	#ddlSetorRequisitanteEvento option {
		font-family: 'Courier New', monospace;
	}

	/* Opcional: destacar setores raiz */
	#ddlSetorRequisitanteEvento option[value^="nivel0"] {
		font-weight: bold;
	}

</style>


<form method="post" asp-action="Upsert" autocomplete="off">
    @Html.AntiForgeryToken()
    <div class="row">
        <div class="col-xl-12">
            <!-- ============================================
                 PANEL FrotiX COM HEADER ESTILIZADO
                 ============================================ -->
            <div id="panel-1" class="panel ftx-card-styled">
                <div class="panel-container show">
                    
                    <!-- HEADER DO CARD - PADR√ÉO FrotiX -->
                    <div class="ftx-card-header">
                        <h2 class="titulo-paginas">
                            <i class="fa-duotone fa-calendar-users"></i>
                            @(Model.EventoObj.Evento.EventoId != Guid.Empty ? "Atualizar" : "Criar") Evento
                        </h2>
                        <div class="ftx-card-actions">
                            <a asp-page="./ListaEventos" class="btn btn-fundo-laranja" data-ftx-loading>
                                <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i>
                                Voltar √† Lista
                            </a>
                        </div>
                    </div>
                    <!-- FIM: Card Header -->

                    <div class="panel-content">
                        <div class="box-body p-3">
                            <!-- Mensagens de Valida√ß√£o -->
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                            @if (Model.EventoObj.Evento.EventoId != Guid.Empty)
                            {
                            <input type="hidden" asp-for="EventoObj.Evento.EventoId" />
                            }

                <!-- Formul√°rio Principal -->
                
                <!-- Se√ß√£o: Informa√ß√µes B√°sicas -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa-duotone fa-info-circle"></i> Informa√ß√µes B√°sicas
                    </div>
                    <div class="row g-2 mb-2">
                        <!-- Nome do Evento -->
                        <div class="col-12 col-md-4">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-input-text"></i> Nome do Evento <span class="required-asterisk">*</span>
                            </label>
                            <input id="txtNomeEvento"
                                   class="form-control"
                                   asp-for="EventoObj.Evento.Nome"
                                   maxlength="200"
                                   placeholder="Digite o nome do evento" />
                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.Nome"></span>
                        </div>

                        <!-- Descri√ß√£o -->
                        <div class="col-12 col-md-8">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-align-left"></i> Descri√ß√£o <span class="required-asterisk">*</span>
                            </label>
                            <input id="txtDescricaoEvento"
                                   class="form-control"
                                   asp-for="EventoObj.Evento.Descricao"
                                   maxlength="300"
                                   placeholder="Descreva o evento" />
                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.Descricao"></span>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Per√≠odo e Detalhes -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa-duotone fa-calendar-range"></i> Per√≠odo e Detalhes
                    </div>
                    <div class="row g-2 mb-2">
                        <!-- Data Inicial -->
                        <div class="col-12 col-md-3">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-calendar-day"></i> Data Inicial <span class="required-asterisk">*</span>
                            </label>
                            <input id="txtDataInicialEvento"
                                   class="form-control"
                                   asp-for="EventoObj.Evento.DataInicial"
                                   type="date" />
                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.DataInicial"></span>
                        </div>

                        <!-- Data Final -->
                        <div class="col-12 col-md-3">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-calendar-check"></i> Data Final <span class="required-asterisk">*</span>
                            </label>
                            <input id="txtDataFinalEvento"
                                   class="form-control"
                                   asp-for="EventoObj.Evento.DataFinal"
                                   type="date" />
                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.DataFinal"></span>
                        </div>

                        <!-- Quantidade de Participantes -->
                        <div class="col-12 col-md-3">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-users"></i> Qtd. Participantes <span class="required-asterisk">*</span>
                            </label>
                            <input id="txtQtdParticipantes"
                                   class="form-control"
                                   asp-for="EventoObj.Evento.QtdParticipantes"
                                   type="number"
                                   min="0"
                                   step="1"
                                   placeholder="0" />
                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.QtdParticipantes"></span>
                        </div>

                        <!-- Status -->
                        <div class="col-12 col-md-3">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-toggle-on"></i> Status <span class="required-asterisk">*</span>
                            </label>
                            <select id="lstStatus"
                                    class="form-select"
                                    asp-for="EventoObj.Evento.Status">
                                <option value="1">Ativo</option>
                                <option value="0">Inativo</option>
                            </select>
                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.Status"></span>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Respons√°veis -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa-duotone fa-user-tie"></i> Respons√°veis
                    </div>
                    <div class="row g-2 mb-2">
                        <!-- Requisitante do Evento -->
                        <div class="col-12 col-md-6">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-user"></i> Requisitante do Evento <span class="required-asterisk">*</span>
                            </label>
                            <ejs-dropdowntree id="lstRequisitanteEvento"
                                              class="form-select"
                                              placeholder="Selecione um Requisitante"
                                              showCheckBox="false"
                                              allowMultiSelection="false"
                                              allowFiltering="true"
                                              filterType="Contains"
                                              filterBarPlaceholder="Procurar..."
                                              popupHeight="200px"
                                              select="RequisitanteEventoValueChange"
                                              change="RequisitanteEventoValueChange"
                                              ejs-for="@Model.EventoObj.Evento.RequisitanteId">
                                <e-dropdowntree-fields dataSource="@ViewData["dataRequisitante"]"
                                                       value="RequisitanteId"
                                                       text="Requisitante">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.RequisitanteId"></span>
                        </div>

                        <!-- Setor do Requisitante -->
                        <div class="col-12 col-md-6">
                            <label class="form-label mb-1 small fw-bold">
                                <i class="fa-duotone fa-building"></i> Setor do Requisitante <span class="required-asterisk">*</span>
                            </label>

                            <!-- Campo de texto vis√≠vel (readonly) -->
                            <input type="text"
                                   id="txtSetorRequisitante"
                                   class="form-control"
                                   readonly
                                   placeholder="Setor ser√° preenchido automaticamente"
                                   value="" />


                            <span class="text-danger small"
                                  asp-validation-for="EventoObj.Evento.SetorSolicitanteId"></span>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="row g-3 mt-3">
                    <div class="col-12 col-md-3">
                        <button type="submit"
                                id="btnSalvarEvento"
                                value="Submit"
                                asp-page-handler="Submit"
                                class="btn btn-azul btn-submit-spin w-100">
                            <span class="btn-content">
                                <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                @(Model.EventoObj.Evento.EventoId != Guid.Empty ? "Atualizar Evento" : "Criar Evento")
                            </span>
                            <span class="btn-loading d-none">
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                Salvando...
                            </span>
                        </button>
                    </div>
                    <div class="col-12 col-md-3">
                        <a asp-page="./ListaEventos"
                           class="btn btn-vinho w-100" data-ftx-loading>
                            <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i>
                            Cancelar Opera√ß√£o
                        </a>
                    </div>
                </div>

	            <!-- DropDownTree oculto que mant√©m o valor real -->
				<div class="col-12 col-md-6" style="display: none">
					<label class="form-label mb-1 small fw-bold">Setor do Requisitante</label>
					<select id="ddlSetorRequisitanteEvento" 
							class="form-select"
							asp-for="@Model.EventoObj.Evento.SetorSolicitanteId"
							asp-items="@(new SelectList(ViewData["dataSetor"] as List<UpsertEventoModel.SetorListItem>, "SetorSolicitanteId", "NomeFormatado"))">
						<option value="">Selecione um Setor</option>
					</select>
					<span class="text-danger small"
						  asp-validation-for="EventoObj.Evento.SetorSolicitanteId"></span>
				</div>

                <!-- Tabela de Viagens (quando existe Evento) -->
                @if (Model.EventoObj.Evento.EventoId != Guid.Empty)
                {
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="fs-5 mb-2">
                                <i class="fa-duotone fa-route text-primary"></i> Viagens associadas ao Evento
                            </h5>
                            <div class="table-responsive">
                                <table id="tblViagens" class="table table-striped table-bordered table-hover table-sm w-100">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Vistoria</th>
                                            <th>Data</th>
                                            <th>In√≠cio</th>
                                            <th>Requisitante</th>
                                            <th>Setor</th>
                                            <th>Motorista</th>
                                            <th>Ve√≠culo</th>
                                            <th class="text-end">Custo</th>
                                            <th class="text-center" style="width:120px">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Se√ß√£o de Estat√≠sticas das Viagens -->
                    <div class="row mt-4" id="estatisticasViagens">
                        <div class="col-12">
                            <h5 class="fs-5 mb-3">
                                <i class="fa-duotone fa-chart-bar text-success"></i> Estat√≠sticas das Viagens Realizadas
                            </h5>
                        </div>

                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center py-3" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px;">
                                    <div class="text-info mb-1">
                                        <i class="fa-duotone fa-car fa-lg"></i>
                                    </div>
                                    <small class="text-muted d-block mb-1">Total de Viagens</small>
                                    <h4 class="mb-0 fw-bold text-dark" id="totalViagens">0</h4>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center py-3" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px;">
                                    <div class="text-success mb-1">
                                        <i class="fa-duotone fa-dollar-sign fa-lg"></i>
                                    </div>
                                    <small class="text-muted d-block mb-1">Valor Total do Evento</small>
                                    <h4 class="mb-0 fw-bold text-dark" id="custoTotalViagens">R$ 0,00</h4>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center py-3" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px;">
                                    <div class="text-warning mb-1">
                                        <i class="fa-duotone fa-chart-line fa-lg"></i>
                                    </div>
                                    <small class="text-muted d-block mb-1">Custo M√©dio por Viagem</small>
                                    <h4 class="mb-0 fw-bold text-dark" id="custoMedioViagem">R$ 0,00</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                        </div> <!-- /.box-body -->
                    </div> <!-- /.panel-content -->
                </div> <!-- /.panel-container -->
            </div> <!-- /.panel -->
        </div> <!-- /.col-xl-12 -->
    </div> <!-- /.row -->

    <!-- ============================================
         OVERLAY DE LOADING - PADR√ÉO FROTIX
         ============================================ -->
    <div id="loadingOverlayEvento" class="ftx-spin-overlay" style="z-index: 999999; cursor: wait; display: none;">
        <div class="ftx-spin-box" style="text-align: center; min-width: 300px;">
            <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" class="ftx-loading-logo" style="display: block;" />
            <div class="ftx-loading-bar"></div>
            <div class="ftx-loading-text" id="loadingMessage">Carregando...</div>
            <div class="ftx-loading-subtext">Aguarde, por favor</div>
        </div>
    </div>
    <!-- /Overlay de Loading -->

    <!-- ============================================
         MODAL: DETALHAMENTO DE CUSTOS DA VIAGEM
         (Usando dados da API ObterCustosViagem)
         ============================================ -->
    <div class="modal fade" id="modalCustosViagem" tabindex="-1" aria-labelledby="modalCustosViagemLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-dinheiro">
                    <h5 class="modal-title text-white" id="modalCustosViagemLabel">
                        <i class="fa-duotone fa-file-invoice-dollar"></i> Detalhamento de Custos da Viagem
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <!-- Nome do Requisitante -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 id="requisitanteCustos" class="text-primary mb-0"></h5>
                        </div>
                    </div>

                    <!-- Informa√ß√µes da Viagem -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="fa-duotone fa-route text-primary"></i> Informa√ß√µes da Viagem
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Info Viagem</small>
                                            <span id="infoViagemCustos" class="fw-bold">--</span>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Dura√ß√£o</small>
                                            <span id="tempoTotalCustos" class="fw-bold text-primary">-</span>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">KM Percorrido</small>
                                            <span id="kmPercorridoCustos" class="fw-bold text-info">-</span>
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted d-block">Litros Gastos</small>
                                            <span id="litrosGastosCustos" class="fw-bold text-success">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cards de Custos -->
                    <div class="row mb-3">
                        <!-- Custo Motorista -->
                        <div class="col-md-4">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <i class="fa-duotone fa-user-tie fa-2x text-primary mb-2"></i>
                                    <h6 class="text-muted mb-2">Custo com Motorista</h6>
                                    <h5 id="custoMotoristaCustos" class="mb-0 text-primary fw-bold">R$ 0,00</h5>
                                </div>
                            </div>
                        </div>

                        <!-- Custo Ve√≠culo -->
                        <div class="col-md-4">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <i class="fa-duotone fa-car fa-2x text-success mb-2"></i>
                                    <h6 class="text-muted mb-2">Custo com Ve√≠culo</h6>
                                    <h5 id="custoVeiculoCustos" class="mb-0 text-success fw-bold">R$ 0,00</h5>
                                </div>
                            </div>
                        </div>

                        <!-- Custo Combust√≠vel -->
                        <div class="col-md-4">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <i class="fa-duotone fa-gas-pump fa-2x text-warning mb-2"></i>
                                    <h6 class="text-muted mb-2">Custo com Combust√≠vel</h6>
                                    <h5 id="custoCombustivelCustos" class="mb-0 text-warning fw-bold">R$ 0,00</h5>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Custo Total -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="card-body text-center py-4">
                                    <i class="fa-duotone fa-sack-dollar fa-3x mb-2"></i>
                                    <h5 class="mb-2">Custo Total da Viagem</h5>
                                    <h2 id="custoTotalCustos" class="mb-0 fw-bold">R$ 0,00</h2>
                                    <small class="opacity-75">Soma de todos os custos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                        <i class="fa-duotone fa-circle-xmark icon-space"></i>
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- /Modal de Detalhamento de Custos -->

    <!-- ============================================
         MODAL: DESASSOCIAR VIAGEM DO EVENTO
         ============================================ -->
    <div class="modal fade" id="modalDesassociar" tabindex="-1" aria-labelledby="modalDesassociarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header modal-header-vinho">
                    <h5 class="modal-title text-white" id="modalDesassociarLabel">
                        <i class="fa-duotone fa-link-slash"></i> Desassociar Viagem do Evento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="viagemIdDesassociar" value="" />
                    
                    <div class="alert alert-warning mb-3">
                        <i class="fa-duotone fa-triangle-exclamation me-2"></i>
                        <strong>Aten√ß√£o!</strong> Ao desassociar a viagem deste evento, voc√™ dever√° informar uma nova finalidade para ela.
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fa-duotone fa-bullseye text-primary me-1"></i>
                            Nova Finalidade da Viagem <span class="text-danger">*</span>
                        </label>
                        <select id="lstNovaFinalidade" class="form-select" required>
                            <option value="">-- Selecione uma Finalidade --</option>
                            <option value="Abastecimento">Abastecimento</option>
                            <option value="Aeroporto">Aeroporto</option>
                            <option value="Ambul√¢ncia">Ambul√¢ncia</option>
                            <option value="Chegada da Manuten√ß√£o">Chegada da Manuten√ß√£o</option>
                            <option value="Cursos Depol">Cursos Depol</option>
                            <option value="Demanda Pol√≠tica">Demanda Pol√≠tica</option>
                            <option value="Devolu√ß√£o √† Locadora">Devolu√ß√£o √† Locadora</option>
                            <option value="Economildo Norte(Cefor)">Economildo Norte(Cefor)</option>
                            <option value="Economildo Rodovi√°ria">Economildo Rodovi√°ria</option>
                            <option value="Economildo Sul(PGR)">Economildo Sul(PGR)</option>
                            <option value="Enviado Depol">Enviado Depol</option>
                            <option value="Mesa (carros pretos)">Mesa (carros pretos)</option>
                            <option value="Passaporte">Passaporte</option>
                            <option value="Recebido Depol">Recebido Depol</option>
                            <option value="Recebimento da Locadora">Recebimento da Locadora</option>
                            <option value="Sa√≠da para Manuten√ß√£o">Sa√≠da para Manuten√ß√£o</option>
                            <option value="Sa√≠da Programada">Sa√≠da Programada</option>
                            <option value="Transporte de Convidados">Transporte de Convidados</option>
                            <option value="Transporte de Funcion√°rios">Transporte de Funcion√°rios</option>
                            <option value="Transporte de Materiais/Cargas">Transporte de Materiais/Cargas</option>
                            <option value="TV/R√°dio C√¢mara">TV/R√°dio C√¢mara</option>
                        </select>
                        <div class="form-text text-muted">
                            A viagem ser√° removida deste evento e ter√° sua finalidade alterada.
                        </div>
                    </div>

                    <div class="card border-danger bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">
                                <i class="fa-duotone fa-info-circle me-1"></i>
                                <strong>Viagem:</strong> <span id="infoViagemDesassociar">--</span>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                        <i class="fa-duotone fa-circle-xmark icon-space"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-azul" id="btnConfirmarDesassociar">
                        <i class="fa-duotone fa-link-slash icon-space"></i>
                        Confirmar Desassocia√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- /Modal de Desassocia√ß√£o -->
</form>

@section ScriptsBlock {

@using System.Text.Json

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
    // ==========================================
    // FUN√á√ïES DE LOADING - PADR√ÉO FROTIX (Overlay)
    // ==========================================
    /***
     * ‚ö° FUN√á√ÉO: mostrarLoading
     * --------------------------------------------------------------------------------------
     * üéØ OBJETIVO     : Exibir overlay de loading com mensagem customiz√°vel
     *
     * üì• ENTRADAS     : mensagem [string] - Texto a exibir (padr√£o: 'Carregando...')
     *
     * üì§ SA√çDAS       : void - Modifica visibilidade do #loadingOverlayEvento
     *
     * ‚¨ÖÔ∏è CHAMADO POR  : Formul√°rio submit [linha 1319]
     *                   Carregamento de viagens [linha 1331]
     *
     * ‚û°Ô∏è CHAMA        : jQuery $('#loadingMessage', '#loadingOverlayEvento')
     ***/
    function mostrarLoading(mensagem = 'Carregando...') {
        try {
            // [UI] Atualiza texto da mensagem de loading
            $('#loadingMessage').text(mensagem);
            // [UI] Exibe overlay com display flex para centraliza√ß√£o
            $('#loadingOverlayEvento').css('display', 'flex');
        } catch (error) {
            Alerta.TratamentoErroComLinha("UpsertEvento.cshtml", "mostrarLoading", error);
        }
    }

    /***
     * ‚ö° FUN√á√ÉO: esconderLoading
     * --------------------------------------------------------------------------------------
     * üéØ OBJETIVO     : Ocultar overlay de loading ap√≥s opera√ß√£o completa
     *
     * üì• ENTRADAS     : Nenhuma
     *
     * üì§ SA√çDAS       : void - Modifica visibilidade do #loadingOverlayEvento
     *
     * ‚¨ÖÔ∏è CHAMADO POR  : DataTable init check [linha 1342]
     *                   Timeout de seguran√ßa [linha 1355]
     *
     * ‚û°Ô∏è CHAMA        : jQuery('#loadingOverlayEvento')
     ***/
    function esconderLoading() {
        try {
            // [UI] Esconde overlay de loading (display none)
            $('#loadingOverlayEvento').css('display', 'none');
        } catch (error) {
            Alerta.TratamentoErroComLinha("UpsertEvento.cshtml", "esconderLoading", error);
        }
    }
</script>

<script type="text/javascript" src="~/js/cadastros/eventoupsert.js" asp-append-version="true"></script>

<script>
    $(document).ready(function() {
        try {
            // ==========================================
            // VALIDA√á√ÉO: Data Final >= Data Inicial
            // ==========================================
            /***
             * ‚ö° FUN√á√ÉO: validarDatas
             * --------------------------------------------------------------------------------------
             * üéØ OBJETIVO     : Validar que data final n√£o √© menor que data inicial
             *
             * üì• ENTRADAS     : Nenhuma (l√™ valores dos inputs #txtDataInicialEvento,
             *                   #txtDataFinalEvento)
             *
             * üì§ SA√çDAS       : boolean - true se datas v√°lidas, false se data final < inicial
             *
             * ‚¨ÖÔ∏è CHAMADO POR  : form.on('submit') [linha 1295]
             *
             * ‚û°Ô∏è CHAMA        : jQuery('#txtDataInicialEvento', '#txtDataFinalEvento')
             *
             * üìù OBSERVA√á√ïES  : [VALIDACAO] Regra de neg√≥cio: Data final n√£o pode ser anterior
             *                   √† data inicial do evento. Retorna true para dados vazios (assume
             *                   como v√°lido - valida√ß√£o HTML5 far√° o resto).
             ***/
            function validarDatas() {
                try {
                    const dataInicial = $('#txtDataInicialEvento').val();
                    const dataFinal = $('#txtDataFinalEvento').val();

                    if (dataInicial && dataFinal) {
                        // [LOGICA] Comparar datas para valida√ß√£o de intervalo
                        const dtInicial = new Date(dataInicial);
                        const dtFinal = new Date(dataFinal);

                        if (dtFinal < dtInicial) {
                            return false;
                        }
                    }
                    return true;
                } catch (error) {
                    Alerta.TratamentoErroComLinha('UpsertEvento.cshtml', 'validarDatas', error);
                    return true;
                }
            }

            // Valida√ß√£o ao mudar Data Final
            $('#txtDataFinalEvento').on('change', function() {
                try {
                    const dataInicial = $('#txtDataInicialEvento').val();
                    const dataFinal = $(this).val();
                    
                    if (dataInicial && dataFinal) {
                        const dtInicial = new Date(dataInicial);
                        const dtFinal = new Date(dataFinal);
                        
                        if (dtFinal < dtInicial) {
                            AppToast.show('Vermelho', 'Data Final n√£o pode ser menor que a Data Inicial!', 3000);
                            $(this).val('');
                            $(this).focus();
                        }
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha('UpsertEvento.cshtml', 'txtDataFinalEvento.change', error);
                }
            });

            // Valida√ß√£o ao mudar Data Inicial (caso j√° tenha Data Final preenchida)
            $('#txtDataInicialEvento').on('change', function() {
                try {
                    const dataInicial = $(this).val();
                    const dataFinal = $('#txtDataFinalEvento').val();
                    
                    if (dataInicial && dataFinal) {
                        const dtInicial = new Date(dataInicial);
                        const dtFinal = new Date(dataFinal);
                        
                        if (dtFinal < dtInicial) {
                            AppToast.show('Amarelo', 'Aten√ß√£o: Data Final foi limpa pois era menor que a nova Data Inicial.', 3000);
                            $('#txtDataFinalEvento').val('');
                        }
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha('UpsertEvento.cshtml', 'txtDataInicialEvento.change', error);
                }
            });

            // Intercepta o submit do formul√°rio
            $('form').on('submit', function(e) {
                try {
                    const btn = $('#btnSalvarEvento');
                    const form = $(this);
                    
                    // Valida√ß√£o de datas antes de enviar
                    if (!validarDatas()) {
                        e.preventDefault();
                        AppToast.show('Vermelho', 'Data Final n√£o pode ser menor que a Data Inicial!', 3000);
                        $('#txtDataFinalEvento').focus();
                        return false;
                    }
                    
                    // Verifica se o formul√°rio √© v√°lido
                    if (form[0].checkValidity && !form[0].checkValidity()) {
                        return true; // Deixa o browser mostrar os erros de valida√ß√£o
                    }

                    // Ativa o spinner no bot√£o
                    btn.prop('disabled', true);
                    btn.find('.btn-content').addClass('d-none');
                    btn.find('.btn-loading').removeClass('d-none');
                    
                    // Mostra loading geral
                    mostrarLoading('Salvando Evento...');
                    
                } catch (error) {
                    console.error('Erro no submit:', error);
                }
            });

            // Carregar dados do setor quando a p√°gina carrega (para edi√ß√£o)
            @if (Model.EventoObj.Evento.EventoId != Guid.Empty)
            {
                <text>
                // Mostra loading ao carregar viagens
                mostrarLoading('Carregando Viagens...');
                
                // Aguarda o DataTable ser inicializado e esconde o loading
                var checkDataTable = setInterval(function() {
                    try {
                        if ($.fn.DataTable.isDataTable('#tblViagens')) {
                            var dt = $('#tblViagens').DataTable();
                            // Verifica se j√° carregou dados ou se est√° idle
                            if (dt.data().count() >= 0) {
                                clearInterval(checkDataTable);
                                setTimeout(function() {
                                    esconderLoading();
                                }, 300);
                            }
                        }
                    } catch (e) {
                        clearInterval(checkDataTable);
                        esconderLoading();
                    }
                }, 200);
                
                // Timeout de seguran√ßa (5 segundos)
                setTimeout(function() {
                    clearInterval(checkDataTable);
                    esconderLoading();
                }, 5000);
                
                // Carrega o nome do setor atual
                const setorId = '@Model.EventoObj.Evento.SetorSolicitanteId';
                if (setorId && setorId !== '00000000-0000-0000-0000-000000000000') {
                    const ddlSetor = document.getElementById('ddlSetorRequisitanteEvento');
                    const txtSetor = document.getElementById('txtSetorRequisitante');
                    if (ddlSetor && ddlSetor.value && txtSetor) {
                        const opcaoSelecionada = ddlSetor.options[ddlSetor.selectedIndex];
                        if (opcaoSelecionada) {
                            let textoSetor = opcaoSelecionada.text
                                .replace(/^[‚Äì\s‚îú‚îî‚îÇ]+/g, '')
                                .trim();
                            txtSetor.value = textoSetor;
                        }
                    }
                }
                </text>
            }

        } catch (error) {
            console.error('Erro no document.ready:', error);
        }
    });

    const eventoId = @Html.Raw(JsonSerializer.Serialize(@Model.EventoObj.Evento?.EventoId.ToString()));
    const requisitanteId = @Html.Raw(JsonSerializer.Serialize(@Model.EventoObj.Evento?.RequisitanteId.ToString()));
    const setorsolicitanteId = @Html.Raw(JsonSerializer.Serialize(@Model.EventoObj.Evento?.SetorSolicitanteId.ToString()));

    window.eventoId = eventoId;


    /***
     * ‚ö° FUN√á√ÉO: RequisitanteEventoValueChange
     * --------------------------------------------------------------------------------------
     * üéØ OBJETIVO     : Preencher automaticamente o setor quando requisitante √© selecionado
     *                   no DropDownTree (lstRequisitanteEvento)
     *
     * üì• ENTRADAS     : args [Syncfusion DropDownTree EventArgs] - Cont√©m nodeData/itemData
     *                   com ID do requisitante selecionado
     *
     * üì§ SA√çDAS       : void - Atualiza #txtSetorRequisitante com setor e #ddlSetorRequisitanteEvento
     *                   com ID do setor (oculto)
     *
     * ‚¨ÖÔ∏è CHAMADO POR  : DropDownTree select/change event [linha 834-835]
     *                   Event bind manual [linha 1490-1491]
     *
     * ‚û°Ô∏è CHAMA        : GET /Viagens/UpsertEvento?handler=PegaSetor [AJAX]
     *                   jQuery('#txtSetorRequisitante', '#ddlSetorRequisitanteEvento')
     *
     * üìù OBSERVA√á√ïES  : [AJAX] Chamada ao servidor para buscar setor via requisitanteId.
     *                   M√∫ltiplas estrat√©gias de extra√ß√£o de ID (nodeData, itemData, value,
     *                   dataset.uid). Fallback para leitura direta do componente Syncfusion.
     ***/
    window.RequisitanteEventoValueChange = function (args) {
        try {
            console.log('Event Triggered: RequisitanteEventoValueChange', args);

            let requisitanteId = null;

            // TENTATIVA 1: Pega do evento DIRETO (mais confi√°vel no Select)
            if (args) {
                if (args.nodeData && args.nodeData.id) {
                    requisitanteId = args.nodeData.id;
                } else if (args.itemData && (args.itemData.value || args.itemData.RequisitanteId)) {
                    requisitanteId = args.itemData.value || args.itemData.RequisitanteId;
                } else if (args.value) {
                    // Se for array (multiselect), pega o primeiro
                    requisitanteId = Array.isArray(args.value) ? args.value[0] : args.value;
                } else if (args.item && args.item.dataset && args.item.dataset.uid) {
                    // Fallback para dataset do item HTML
                    requisitanteId = args.item.dataset.uid; // Cuidado: uid pode n√£o ser o ID do banco
                }
            }

            // TENTATIVA 2: Pega do Componente (se o evento falhou ou veio vazio)
            if (!requisitanteId) {
                const ddTreeObj = document.getElementById("lstRequisitanteEvento")?.ej2_instances?.[0];
                if (ddTreeObj && ddTreeObj.value) {
                    requisitanteId = Array.isArray(ddTreeObj.value) ? ddTreeObj.value[0] : ddTreeObj.value;
                }
            }

            console.log('ID Identificado:', requisitanteId);

            // Valida√ß√£o de seguran√ßa: se o ID for nulo ou vazio, aborta SUAVEMENTE
            if (!requisitanteId) {
                console.warn('Nenhum ID de requisitante v√°lido encontrado. Aguardando intera√ß√£o...');
                return;
            }

            const txtSetor = document.getElementById('txtSetorRequisitante');
            
            // S√≥ muda o texto para "Carregando" se realmente temos um ID novo
            if (txtSetor) {
                txtSetor.value = 'Carregando Setor...';
                txtSetor.classList.add('pulse-input'); // Feedback visual opcional
            }

            /***
             * [AJAX] Endpoint: GET /Viagens/UpsertEvento?handler=PegaSetor
             * ============================================================================
             * üì• ENVIA        : id [Guid] - ID do requisitante selecionado
             * üì§ RECEBE       : { success: bool, data: setorId, setorNome: string }
             * üéØ MOTIVO       : Buscar setor vinculado ao requisitante para popular campo
             *                   readonly txtSetorRequisitante e dropdown oculto
             ***/
            $.ajax({
                url: "/Viagens/UpsertEvento?handler=PegaSetor",
                method: "GET",
                dataType: "json",
                data: { id: requisitanteId },
                success: function (res) {
                    if (res.success && res.data) {
                        // Atualiza o DropDownList oculto
                        const ddlSetor = document.getElementById('ddlSetorRequisitanteEvento');
                        if (ddlSetor) {
                            ddlSetor.value = res.data;
                            
                            // DISPARA CHANGE MANUALMENTE para garantir que valida√ß√µes ou binds ocorram
                            const event = new Event('change', { bubbles: true });
                            ddlSetor.dispatchEvent(event);

                            // Atualiza o Input Visual
                            const opcaoSelecionada = ddlSetor.options[ddlSetor.selectedIndex];
                            let textoSetor = opcaoSelecionada ? opcaoSelecionada.text : res.setorNome;

                            // Limpa formata√ß√£o visual da hierarquia (dashes, pipes)
                            if (textoSetor) {
                                textoSetor = textoSetor.replace(/^[‚Äì\s‚îú‚îî‚îÇ]+/g, '').trim();
                            }

                            if (txtSetor) {
                                txtSetor.value = textoSetor;
                                txtSetor.classList.remove('pulse-input');
                                txtSetor.classList.add('is-valid'); // Feedback positivo
                                setTimeout(() => txtSetor.classList.remove('is-valid'), 1000);
                            }

                            console.log('‚úì Setor Atualizado com Sucesso:', textoSetor);
                        }
                    } else {
                        if (txtSetor) txtSetor.value = '';
                        console.warn('Setor n√£o encontrado na resposta:', res);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Erro AJAX ao buscar setor:', error);
                    if (txtSetor) txtSetor.value = 'Erro ao buscar setor';
                }
            });

        } catch (error) {
            console.error('Erro Cr√≠tico em RequisitanteEventoValueChange:', error);
        }
    };

    // Garante bind dos eventos do DropDownTree
    $(document).ready(function () {
        try {
            const ddtReq = document.getElementById("lstRequisitanteEvento")?.ej2_instances?.[0];
            if (ddtReq) {
                ddtReq.select = window.RequisitanteEventoValueChange;
                ddtReq.change = window.RequisitanteEventoValueChange;
            }
        } catch (error) {
            console.error('Erro ao bindar eventos do requisitante:', error);
        }
    });
</script>
}
