@* ========================================================================================
 * ARQUIVO: Pages/Usuarios/InsereRecursosUsuarios.cshtml
 * OBJETIVO: Pagina ADMIN de insercao batch de recursos/permissoes para multiplos usuarios
 *           simultaneamente via Syncfusion MultiSelect ComboBox, permite administrador
 *           atribuir mesmas permissoes a grupo de usuarios de uma vez (exemplo: liberar
 *           acesso Relatorios Gerenciais para todos Coordenadores), otimiza gestao permissoes
 *           em lote.
 * ENTRADAS: route /Usuarios/InsereRecursosUsuarios, model (reutiliza Abastecimento incorretamente
 *           deveria ser UsuarioRecursoModel custom), form fields: UsuariosIds Syncfusion
 *           MultiSelect ComboBox dataSource /api/Usuarios/GetAtivos permite selecionar
 *           multiplos usuarios checkbox list filterable search, RecursosIds Syncfusion
 *           MultiSelect ComboBox dataSource /api/Recursos/GetAll permite selecionar multiplos
 *           recursos checkbox list hierarquico por categoria (Cadastros/Relatorios/Admin),
 *           botao Atribuir Recursos submit POST /Usuarios/InsereRecursosUsuarios OnPost
 *           handler processa batch insert UsuarioRecursos table
 * SAIDAS: Form renderizado com 2 MultiSelect ComboBox lado a lado width 45pc: esquerda
 *         Usuarios (exibe Nome + Email, checkbox multi-select, search filtra por Nome/Email,
 *         placeholder Selecione usuarios, showSelectAll true permite marcar todos), direita
 *         Recursos (exibe Nome recurso hierarquico Categoria > Recurso, checkbox multi-select,
 *         groupBy Categoria agrupa recursos, search filtra, placeholder Selecione recursos),
 *         botao Atribuir Recursos primary disabled se nenhum usuario/recurso selecionado
 *         (valida client-side UsuariosIds.length>0 AND RecursosIds.length>0), submit POST
 *         valida backend verifica duplicatas UsuarioRecursos existentes (query Where UsuarioId
 *         IN UsuariosIds AND RecursoId IN RecursosIds), insere apenas novas combinacoes
 *         evita duplicate key error, retorna JSON {totalInseridos, totalDuplicatas},
 *         success exibe AppToast Verde X permissoes atribuidas a Y usuarios Z duplicatas
 *         ignoradas, error Alerta.Erro
 * CHAMADA POR: Menu Admin > Usuarios > Inserir Recursos em Lote (link interno sidebar
 *              dropdown Usuarios), usuarios com permissao Usuarios.GerenciarRecursos (role
 *              Admin apenas), usada quando precisa liberar mesmas permissoes para grupo
 *              usuarios (exemplo: novos Coordenadores contratados precisam acesso Relatorios
 *              Gerenciais + Aprovacao Viagens + Gestao Motoristas, admin seleciona 5 Coordenadores
 *              + 3 Recursos clica Atribuir insere 15 registros UsuarioRecursos de uma
 *              vez ao inves de gerenciar individualmente)
 * CHAMA: PageModel InsereRecursosUsuarios.cshtml.cs OnPost handler (recebe List UsuariosIds
 *        e List RecursosIds do form, loop nested UsuariosIds foreach RecursosIds verifica
 *        duplicata query Where UsuarioId AND RecursoId EXISTS, se nao existe insere new
 *        UsuarioRecurso entity DbContext.Add, SaveChanges batch commit, retorna contadores),
 *        API endpoints: GET /api/Usuarios/GetAtivos (retorna dropdown usuarios), GET
 *        /api/Recursos/GetAll (retorna dropdown recursos hierarquico), Syncfusion MultiSelect
 *        ComboBox components (allowFiltering search, mode CheckBox multi-select, showSelectAll,
 *        groupBy Categoria), AppToast.show Verde (feedback success)
 * DEPENDENCIAS: ASP.NET Core Razor Pages 8.0, Syncfusion EJ2 MultiSelect ComboBox 2023.4.2,
 *               Bootstrap 5.3.8, jQuery 3.7.1, EF Core 8.0 batch insert
 * OBSERVACOES: 141 linhas pagina ADMIN batch insert permissoes. Model binding incorreto:
 *              usa model Abastecimento mas deveria ter UsuarioRecursoModel custom com properties
 *              List UsuariosIds e List RecursosIds (corrigir refactoring criar model correto).
 *              Title ViewData incorreto: exibe Importa Abastecimentos mas deveria ser
 *              Inserir Recursos em Lote (corrigir). Validacao duplicatas essencial: verifica
 *              combinacao UsuarioId+RecursoId ja existe tabela UsuarioRecursos evita duplicate
 *              key constraint error (unique index em UsuarioId,RecursoId colunas), se duplicata
 *              skipa insert incrementa contador duplicatas informar usuario. Performance:
 *              loop nested pode gerar muitas queries (10 usuarios * 5 recursos = 50 queries
 *              verificar duplicatas), otimizar carregando todas UsuarioRecursos existentes
 *              memoria Where UsuarioId IN UsuariosIds AND RecursoId IN RecursosIds em 1
 *              query, fazer lookup HashSet contains rapido, insere apenas nao existentes,
 *              batch SaveChanges 1 vez ao final. Transacao: considerar BeginTransaction
 *              antes do loop, se erro em algum insert RollbackTransaction desfaz todos
 *              parciais garante atomicidade all-or-nothing. Log auditoria: registrar tabela
 *              AuditoriaRecursos (AdminUsuarioId, DataHora, Acao InsercaoBatch, UsuariosIds
 *              JSON array, RecursosIds JSON array, TotalInseridos, IP) para rastrear quem
 *              atribuiu permissoes quando.
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@
@page
@model FrotiX.Models.Abastecimento
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@{
	ViewData["Title"] = "Importa Abastecimentos";
	ViewData["PageName"] = "importa_abastecimento_index";
	ViewData["Heading"] = "<i class='fa-duotone fa-gas-pump'></i> Importação: <span class='fw-300'>Abastecimentos</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-gas-pump";
}

@section HeadBlock {
}

<style>
	.fundo-cinza {
		background-color: #2F4F4F;
		color: aliceblue;
	}

	.label {
		color: white;
	}
</style>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<div class="panel-container show">
				<div class="panel-content">
					<div class="row">
						<div class="col-12 px-3" style="border-bottom:1px solid #325d88">
							<h2 class="text-primary">Serviços de Inserção dos Recursos nos Usuários</h2>
						</div>
					</div>
					<button id="btnInsereRecursos"
							type="button"
							class="btn btn-azul form-control"
							aria-label="Insere Recursos nos Usuários"
							aria-busy="false"
							data-ejtip="Insere todos os recursos disponíveis para todos os usuários">
						<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> Insere Recursos nos Usuários
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-12 pt-2">
		<div class="clearfix" id="divCustos">&nbsp;</div>
		<div class="row">
			<div id="divPrint"></div>
		</div>
	</div>
</div>

@section ScriptsBlock {

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<script type="text/javascript" src="~/js/loading_script.js"></script>

	<script>
		(function () {
			"use strict";

			$(document).ready(function () {
				try {
					const $btn = $("#btnInsereRecursos");
					const $divCustos = $("#divCustos");

					$btn.on("click", function (event) {
						try {
							event.preventDefault();

							// evita duplo clique
							if ($btn.prop("disabled")) return;
							$btn.prop("disabled", true).attr("aria-busy", "true");

							// Loading
							if ($divCustos.LoadingScript) {
								$divCustos.LoadingScript("method_12", {
									background_image: "img/loading7.png",
									main_width: 60,
									animation_speed: 10,
									additional_style: "",
									after_element: false
								});
							}

							$.ajax({
								type: "POST",
								url: "/api/Usuario/InsereRecursosUsuario",
								success: function (data) {
									try {
										const msg = (data && data.message) ? data.message : "Operação concluída.";
										if (data && data.success === false) {
											AppToast.show('Vermelho', msg, 2000);
										} else {
											AppToast.show('Verde', msg || "Recursos inseridos com sucesso.", 2000);
										}
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.success", inner);
									}
								},
								error: function (xhr) {
									try {
										console.error(xhr);
										AppToast.show('Vermelho', "Erro ao inserir recursos nos usuários.", 2000);
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.error", inner);
									}
								},
								complete: function () {
									try {
										if ($divCustos.LoadingScript) {
											$divCustos.LoadingScript("destroy");
										}
										$btn.prop("disabled", false).attr("aria-busy", "false");
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.complete", inner);
									}
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "btnInsereRecursos.click", error);
						}
					});
				} catch (error) {
					Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "document.ready", error);
				}
			});
		})();
	</script>
}
