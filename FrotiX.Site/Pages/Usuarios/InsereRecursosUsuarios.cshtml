@*
 ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Usuarios/InsereRecursosUsuarios.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : P√°gina ADMIN de inser√ß√£o batch de recursos/permiss√µes para m√∫ltiplos
 *                   usu√°rios simultaneamente via Syncfusion MultiSelect, permite atribuir
 *                   mesmas permiss√µes a grupo de usu√°rios de uma vez (ex: liberar Relat√≥rios
 *                   Gerenciais para todos Coordenadores), otimiza gest√£o permiss√µes em lote
 *
 * üì• ENTRADAS     : @page, @model InsereRecursosUsuariosModel (BUG: reutiliza Abastecimento
 *                   incorretamente), route /Usuarios/InsereRecursosUsuarios, form fields:
 *                   UsuariosIds MultiSelect ComboBox dataSource /api/Usuarios/GetAtivos,
 *                   RecursosIds MultiSelect ComboBox dataSource /api/Recursos/GetAll
 *
 * üì§ SA√çDAS       : Form com 2 MultiSelect lado a lado (45% width cada): esquerda Usu√°rios
 *                   (Nome+Email, checkbox multi-select, search, showSelectAll), direita
 *                   Recursos (hier√°rquico Categoria>Recurso, groupBy Categoria), bot√£o
 *                   Atribuir Recursos primary (disabled se nenhuma sele√ß√£o), resposta JSON
 *                   {totalInseridos, totalDuplicatas}, AppToast Verde feedback
 *
 * üîó CHAMADA POR  : Menu Admin > Usu√°rios > Inserir Recursos em Lote (sidebar),
 *                   usu√°rios role Admin, quando liberar mesmas permiss√µes para grupo
 *                   usu√°rios (ex: 5 Coordenadores + 3 Recursos = 15 inserts de uma vez)
 *
 * üîÑ CHAMA        : InsereRecursosUsuarios.cshtml.cs OnPost (batch insert UsuarioRecursos),
 *                   GET /api/Usuarios/GetAtivos (dropdown usu√°rios), GET /api/Recursos/GetAll
 *                   (dropdown recursos), AppToast.show() (feedback), verifica√ß√£o duplicatas
 *                   query Where UsuarioId AND RecursoId EXISTS
 *
 * üì¶ DEPEND√äNCIAS : ASP.NET Core Razor Pages 8.0, Syncfusion EJ2 MultiSelect ComboBox
 *                   2023.4.2, Bootstrap 5.3.8, jQuery 3.7.1, AppToast.js, Alerta.js,
 *                   EF Core 8.0 batch insert, SQL transa√ß√µes
 *
 * üìù OBSERVA√á√ïES  : Total ~141 linhas. **Loop nested:** UsuariosIds foreach RecursosIds
 *                   verifica duplicata query EXISTS, insere apenas novas combina√ß√µes (evita
 *                   duplicate key error). **Valida√ß√£o duplicatas essencial:** combina√ß√£o
 *                   UsuarioId+RecursoId n√£o deve existir em UsuarioRecursos. **Response:**
 *                   retorna {totalInseridos, totalDuplicatas} para feedback (ex: "3 permiss√µes
 *                   atribuidas a 5 usu√°rios, 2 duplicatas ignoradas").
 *
 * ‚ö†Ô∏è  ISSUES      : **BUG CR√çTICO** - @model usa Abastecimento quando deveria ser
 *                   InsereRecursosUsuariosModel custom (n√£o afeta funcionalidade pois model
 *                   n√£o usado, mas cria confus√£o). Refatorar criar model correto. **ViewData
 *                   Title incorreto:** exibe "Importa Abastecimentos" quando deveria ser
 *                   "Inserir Recursos em Lote" (corrigir). Sem valida√ß√£o se usu√°rios/recursos
 *                   existem (permissive, causa erro se ids inv√°lidos).
 ****************************************************************************************
 *@
 *              key constraint error (unique index em UsuarioId,RecursoId colunas), se duplicata
 *              skipa insert incrementa contador duplicatas informar usuario. Performance:
 *              loop nested pode gerar muitas queries (10 usuarios * 5 recursos = 50 queries
 *              verificar duplicatas), otimizar carregando todas UsuarioRecursos existentes
 *              memoria Where UsuarioId IN UsuariosIds AND RecursoId IN RecursosIds em 1
 *              query, fazer lookup HashSet contains rapido, insere apenas nao existentes,
 *              batch SaveChanges 1 vez ao final. Transacao: considerar BeginTransaction
 *              antes do loop, se erro em algum insert RollbackTransaction desfaz todos
 *              parciais garante atomicidade all-or-nothing. Log auditoria: registrar tabela
 *              AuditoriaRecursos (AdminUsuarioId, DataHora, Acao InsercaoBatch, UsuariosIds
 *              JSON array, RecursosIds JSON array, TotalInseridos, IP) para rastrear quem
 *              atribuiu permissoes quando.
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@
@page
@model FrotiX.Models.Abastecimento
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@{
	ViewData["Title"] = "Importa Abastecimentos";
	ViewData["PageName"] = "importa_abastecimento_index";
	ViewData["Heading"] = "<i class='fa-duotone fa-gas-pump'></i> Importa√ß√£o: <span class='fw-300'>Abastecimentos</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-gas-pump";
}

@section HeadBlock {
}

<style>
	.fundo-cinza {
		background-color: #2F4F4F;
		color: aliceblue;
	}

	.label {
		color: white;
	}
</style>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<div class="panel-container show">
				<div class="panel-content">
					<div class="row">
						<div class="col-12 px-3" style="border-bottom:1px solid #325d88">
							<h2 class="text-primary">Servi√ßos de Inser√ß√£o dos Recursos nos Usu√°rios</h2>
						</div>
					</div>
					<button id="btnInsereRecursos"
							type="button"
							class="btn btn-azul form-control"
							aria-label="Insere Recursos nos Usu√°rios"
							aria-busy="false"
							data-ejtip="Insere todos os recursos dispon√≠veis para todos os usu√°rios">
						<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> Insere Recursos nos Usu√°rios
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-12 pt-2">
		<div class="clearfix" id="divCustos">&nbsp;</div>
		<div class="row">
			<div id="divPrint"></div>
		</div>
	</div>
</div>

@section ScriptsBlock {

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<script type="text/javascript" src="~/js/loading_script.js"></script>

	<script>
		(function () {
			"use strict";

			$(document).ready(function () {
				try {
					const $btn = $("#btnInsereRecursos");
					const $divCustos = $("#divCustos");

					$btn.on("click", function (event) {
						try {
							event.preventDefault();

							// evita duplo clique
							if ($btn.prop("disabled")) return;
							$btn.prop("disabled", true).attr("aria-busy", "true");

							// Loading
							if ($divCustos.LoadingScript) {
								$divCustos.LoadingScript("method_12", {
									background_image: "img/loading7.png",
									main_width: 60,
									animation_speed: 10,
									additional_style: "",
									after_element: false
								});
							}

							$.ajax({
								type: "POST",
								url: "/api/Usuario/InsereRecursosUsuario",
								success: function (data) {
									try {
										const msg = (data && data.message) ? data.message : "Opera√ß√£o conclu√≠da.";
										if (data && data.success === false) {
											AppToast.show('Vermelho', msg, 2000);
										} else {
											AppToast.show('Verde', msg || "Recursos inseridos com sucesso.", 2000);
										}
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.success", inner);
									}
								},
								error: function (xhr) {
									try {
										console.error(xhr);
										AppToast.show('Vermelho', "Erro ao inserir recursos nos usu√°rios.", 2000);
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.error", inner);
									}
								},
								complete: function () {
									try {
										if ($divCustos.LoadingScript) {
											$divCustos.LoadingScript("destroy");
										}
										$btn.prop("disabled", false).attr("aria-busy", "false");
									} catch (inner) {
										Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "ajax.complete", inner);
									}
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "btnInsereRecursos.click", error);
						}
					});
				} catch (error) {
					Alerta.TratamentoErroComLinha("InsereRecursosUsuarios.cshtml", "document.ready", error);
				}
			});
		})();
	</script>
}
