@* ========================================================================================
 * ARQUIVO: Pages/Usuarios/Index.cshtml
 * OBJETIVO: Pagina principal de gestao de usuarios do sistema FrotiX exibindo DataTable
 *           jQuery paginado server-side com filtros, modais para CRUD completo (Novo/Editar/Visualizar/Excluir),
 *           busca AJAX, sistema CRITICO para administracao de acessos e permissoes.
 * ENTRADAS: route /Usuarios/Index, ViewData (Title, PageName, Heading), DataTable ajax
 *           GET /api/Usuarios/GetAll retorna JSON usuarios paginado server-side (parameters:
 *           draw, start, length, search[value], order[0][column]/order[0][dir]), filtros
 *           toolbar: TextBox busca nome/email/CPF, CheckBox ApenasMotoristasAtivos, ComboBox
 *           Perfil (Admin/Coordenador/Operador/Motorista/Consulta), botao Filtrar trigger
 *           reload DataTable
 * SAIDAS: Pagina renderizada com card header (titulo Gestao de Usuarios, icone fa-users,
 *         breadcrumb Admin > Usuarios), card body com: 1. Toolbar filtros (search box
 *         global, CheckBox ApenasMotoristasAtivos toggle, ComboBox Perfil multi-select,
 *         botao Filtrar primary, botao Limpar Filtros secondary, botao Novo Usuario success
 *         abre modal), 2. DataTable jQuery plugin (colunas: Id hidden, Foto avatar circular
 *         40x40px, Nome, Email, CPF masked, Perfil badge colorido, Status badge Ativo
 *         Verde/Inativo Cinza, UltimoAcesso datetime relativo, Acoes 4 botoes icones:
 *         Visualizar eye azul abre modal readonly, Editar pencil amarelo abre modal form,
 *         Recursos key verde link /Usuarios/Recursos?id=123 gerencia permissoes, Excluir
 *         trash vermelho Alerta.Confirmar soft delete), server-side processing pageLength
 *         25 sortable filterable, language PT-BR, responsive collapse mobile), 3. Modal
 *         Novo/Editar Usuario (form com Foto Upload Dropzone, Nome/Email/CPF/Telefone
 *         inputs masked, Senha/ConfirmaSenha password strength meter, Perfil dropdown,
 *         Motorista toggle se true exibe campos adicionais CNH/Categoria/ValidadeCNH,
 *         Ativo checkbox, submit POST /api/Usuarios/Save AJAX valida insere/atualiza,
 *         success fecha modal exibe AppToast Verde reload DataTable), 4. Modal Visualizar
 *         Usuario (readonly exibe dados completos usuario incluindo DataCriacao/UltimoAcesso/CriadoPor,
 *         lista Recursos com permissoes badge pills, botao Fechar)
 * CHAMADA POR: Menu Admin > Usuarios (link interno sidebar), usuarios com permissao Usuarios.Gerenciar
 *              (role Admin apenas), pagina CRITICA controle de acesso sistema
 * CHAMA: API UsuariosController: GET /api/Usuarios/GetAll (query EF Core Where filters
 *        Ativo/Perfil/SearchTerm LIKE Nome OR Email OR CPF, Include Perfil/Recursos,
 *        paginacao server-side Skip/Take, retorna JSON DataTables format), POST /api/Usuarios/Save
 *        (recebe JSON usuario valida Email unique CPF valido, hash Senha BCrypt, upload
 *        Foto Dropzone salva wwwroot/uploads/usuarios/, insere/atualiza Usuarios table,
 *        retorna JSON success), DELETE /api/Usuarios/Delete (soft delete seta Excluido=true
 *        DataExclusao=now UsuarioExclusaoId=User.Id, retorna JSON success), GET /api/Usuarios/GetById
 *        (carrega usuario completo Include Recursos para modal Visualizar, retorna JSON),
 *        DataTable jQuery plugin (ajax server-side processing, language PT-BR), Alerta.Confirmar
 *        (confirmacao exclusao), AppToast.show Verde (feedback success), Dropzone (upload
 *        foto drag-drop), jQuery Mask Plugin (mascaras CPF/Telefone), password strength
 *        meter zxcvbn library
 * DEPENDENCIAS: ASP.NET Core Razor Pages 8.0, DataTables 1.13.4 jQuery plugin, Bootstrap
 *               5.3.8 modals, Font Awesome 6 Duotone, jQuery 3.7.1, jQuery Mask Plugin,
 *               Dropzone.js upload foto, zxcvbn password strength, EF Core 8.0, BCrypt.Net
 *               hash senha
 * OBSERVACOES: 220 linhas pagina CRITICA admin usuarios. DataTable server-side essencial
 *              tabela Usuarios pode ter milhares registros client-side seria lento. Hash
 *              senha BCrypt obrigatorio NUNCA salvar senha plain text banco (BCrypt.HashPassword
 *              gera salt automatico protege rainbow table attacks). Soft delete recomendado:
 *              seta Excluido=true mantem historico auditoria, queries filtram Where Excluido=false.
 *              Email unique constraint banco evita duplicatas. CPF validacao digitos verificadores
 *              client-side e backend. Perfil define permissoes globais: Admin acesso total,
 *              Coordenador gerencia setores/viagens, Operador CRUD basico, Motorista readonly
 *              suas viagens, Consulta readonly geral. Recursos permissoes granulares por
 *              tela/funcionalidade gerenciadas em /Usuarios/Recursos?id=123 (tabela UsuarioRecursos
 *              M:N Usuarios-Recursos define quais menus/acoes usuario pode acessar, Navigation
 *              TreeView filtra menus por UsuarioRecursos).
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@
@page
@model FrotiX.Pages.Usuarios.IndexModel

@{
    ViewData["Title"] = "Gestão de Usuários";
    ViewData["PageName"] = "usuarios_index";
    ViewData["Heading"] = "<i class='fa-duotone fa-users'></i> Cadastros: <span class='fw-300'>Usuários</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-users";
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

    <style>
        /* ===== CORRECAO: HEADER DA TABELA USUARIOS ===== */
        /* Sobrescreve o gradiente escuro do ftx-card-styled.css */
        #tblUsuario thead,
        #tblUsuario thead tr {
            background: linear-gradient(180deg, #4a6fa5 0%, #3d5f8f 100%) !important;
        }

        #tblUsuario thead th {
            background: transparent !important;
            color: #fff !important;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none !important;
        }

        /* ===== MODAL CONTROLE DE ACESSO ===== */
        #modalControleAcesso .modal-dialog {
            max-width: 900px;
        }

        #modalControleAcesso .modal-header {
            background: linear-gradient(180deg, #3D5771 0%, #2d4559 100%);
            border-bottom: none;
            padding: 1rem 1.5rem;
        }

        #modalControleAcesso .modal-header .modal-title {
            color: #fff !important;
        }

        #modalControleAcesso .modal-header .modal-title i {
            color: #fff !important;
        }

        /* ===== MODAL FOTO ===== */
        #modalFoto .modal-dialog {
            max-width: 500px;
        }

        #modalFoto .modal-header {
            background: linear-gradient(180deg, #2F4F4F 0%, #1a3030 100%);
            border-bottom: none;
            padding: 1rem 1.5rem;
        }

        #modalFoto .modal-header .modal-title {
            color: #fff !important;
        }

        #modalFoto .modal-header .modal-title i {
            color: #fff !important;
        }

        .img-foto-usuario {
            width: 100%;
            max-width: 300px;
            border: 3px solid #dee2e6;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .no-foto-placeholder {
            width: 200px;
            height: 200px;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            background: linear-gradient(180deg, #f8f9fa, #fff);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .no-foto-placeholder i {
            color: #adb5bd;
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .no-foto-placeholder p {
            color: #6c757d;
            font-style: italic;
            margin: 0;
        }

        /* ===== RESPONSIVO ===== */
        @@media (max-width: 768px) {
            #modalControleAcesso .modal-dialog,
            #modalFoto .modal-dialog {
                max-width: 95%;
                margin: 1rem auto;
            }
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel ftx-card-styled">
            <div class="panel-container show">

                <!-- Header Padrão FrotiX com Botão à Direita -->
                <div class="ftx-card-header d-flex justify-content-between align-items-center">
                    <h2 class="titulo-paginas mb-0">
                        <i class="fa-duotone fa-users"></i>
                        Cadastros: Gestão de Usuários
                    </h2>
                    <a href="/Usuarios/Upsert" class="btn btn-fundo-laranja" data-ftx-loading>
                        <i class="fa-duotone fa-clone-plus icon-pulse me-1"></i> Adicionar Usuário
                    </a>
                </div>

                <div class="panel-content">
                    <div class="box-body">
                        <table id="tblUsuario" class="table table-bordered table-striped table-hover ftx-table" width="100%">
                            <thead>
                                <tr>
                                    <th>Usuário</th>
                                    <th>Ponto</th>
                                    <th>Detentor Carga</th>
                                    <th>Status</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* ================ Modal Controle de Acesso ================ *@
<div class="modal fade" id="modalControleAcesso" tabindex="-1" aria-labelledby="tituloControleAcesso" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="tituloControleAcesso">
                    <i class="fa-duotone fa-shield-keyhole"></i>
                    Gestão de Recursos do Usuário
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtUsuarioIdRecurso" />

                <div class="alert alert-info mb-3">
                    <i class="fa-duotone fa-circle-info me-2"></i>
                    <strong id="txtNomeUsuarioRecurso"></strong> - Clique nos botões para conceder ou remover acesso aos recursos.
                </div>

                <table id="tblRecursos" class="table table-bordered table-striped table-hover ftx-table" width="100%">
                    <thead>
                        <tr>
                            <th>Nome do Recurso</th>
                            <th class="text-center" style="width: 130px;">Status do Acesso</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@* ================ Modal Foto do Usuário ================ *@
<div class="modal fade" id="modalFoto" tabindex="-1" aria-labelledby="tituloFoto" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloFoto">
                    <i class="fa-duotone fa-id-badge"></i>
                    Foto do Usuário
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <h6 id="txtNomeUsuarioFoto" class="text-muted mb-3"></h6>
                <div id="divFotoContainer">
                    <!-- Foto ou placeholder será inserido via JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script src="~/js/cadastros/usuario-index.js" asp-append-version="true"></script>
}
