@page

@* ========================================================================================
 * ARQUIVO: Pages/Contrato/Index.cshtml
 * OBJETIVO: Pagina de listagem e gestao completa de contratos com DataTable jQuery, sistema
 *           INTELIGENTE de validacao de dependencias antes da exclusao (verifica 7 entidades
 *           linkadas: veiculosContrato, encarregados, operadores, lavadores, motoristas,
 *           empenhos, notasFiscais) e gestao dinamica de status Ativo/Inativo com bloqueio
 *           automatico de acoes (botoes Documentos/Itens/Repactuacao desabilitados quando
 *           contrato esta inativo, hrefs removidos, tooltips atualizados).
 * ENTRADAS: Model FrotiX.Pages.Contrato.IndexModel (code-behind C#), DataTable hash tblContrato
 *           vazio populado via AJAX, botoes CRUD delegados via jQuery (classe .btn-editar
 *           para edicao redireciona /Contrato/Upsert?id=X, classe .btn-delete para exclusao
 *           com confirmacao SweetAlert2, classe .updateStatusContrato para toggle Ativo/Inativo,
 *           classe .btn-documentos para modal de upload documentos, classe .btn-itens para
 *           /Contrato/ItensContrato, classe .btn-repactuacao para /Contrato/RepactuacaoContrato),
 *           atributos data-id e data-status nos botoes, onclick events delegados no document.body
 * SAIDAS: DataTable hash tblContrato renderizado com 11 colunas (Numero do Contrato texto,
 *         Objeto descricao, Empresa Contratada, Data Inicio formatada DD/MM/YYYY, Data Termino
 *         formatada DD/MM/YYYY, Valor Total formatado moeda R$, Status badge Verde Ativo/Cinza
 *         Inativo, Acoes com 6 botoes: Editar/Excluir/Status/Documentos/Itens/Repactuacao),
 *         botoes com estados dinamicos (habilitados/desabilitados baseado em data-status),
 *         links para /Contrato/Upsert (criacao novo/edicao existente), /Contrato/ItensContrato
 *         (gestao de itens do contrato), /Contrato/RepactuacaoContrato (reajustes de preco),
 *         modal hash modalDocumentosContrato (upload/visualizacao de anexos PDF/imagens),
 *         exportacoes Excel/PDF via DataTables buttons extension, POST /api/Contrato/Delete
 *         (exclusao com validacao de dependencias), GET /api/Contrato/VerificarDependencias
 *         (retorna JSON com 7 contadores de entidades linkadas), PUT /api/Contrato/UpdateStatus
 *         (toggle Ativo/Inativo), notificacoes AppToast verde/vermelho, alertas SweetAlert2
 * CHAMADA POR: Route /Contrato via diretiva page, navegacao sidebar menu principal (Cadastros >
 *              Contratos), link direto URL, IndexModel.OnGet metodo backend C# executa no
 *              carregamento da pagina (code-behind ASP.NET Core Razor Pages)
 * CHAMA: contrato.js (arquivo JavaScript externo 462 linhas com logica COMPLEXA incluindo
 *        funcao loadList para carregar DataTable via AJAX GET /api/Contrato/GetAll, delete
 *        handler com validacao de dependencias chamando GET /api/Contrato/VerificarDependencias
 *        antes de confirmar exclusao exibindo mensagem detalhada se impedido, status toggle
 *        handler PUT /api/Contrato/UpdateStatus com atualizacao visual dinamica dos botoes de
 *        acao habilitando/desabilitando baseado no novo status, documentos handler abrindo modal),
 *        endpoints API REST /api/Contrato/VerificarDependencias GET (retorna objeto JSON com
 *        7 propriedades: veiculosContrato int, encarregados int, operadores int, lavadores int,
 *        motoristas int, empenhos int, notasFiscais int, total int calculado), /api/Contrato/Delete
 *        POST (so executa se VerificarDependencias.total == 0), /api/Contrato/UpdateStatus PUT
 *        (recebe id e novo status booleano), Alerta.Warning (funcao do Alerta.js wrapper do
 *        SweetAlert2 para exibir aviso quando exclusao impedida listando dependencias),
 *        Alerta.Confirmar (confirmacao antes de deletar), Alerta.TratamentoErroComLinha (catch
 *        de erros AJAX com numero da linha), AppToast.show (notificacoes toast Verde sucesso/Vermelho
 *        erro), window.ejTooltip.refresh (atualiza tooltips Syncfusion EJ2 apos mudanca de status),
 *        DataTables API completa (initialization, column rendering customizado, buttons extension,
 *        responsive, pageLength)
 * DEPENDENCIAS: ASP.NET Core Razor Pages 8.0, jQuery 3.7.1, DataTables 1.13.x plugin (Excel/PDF
 *               export via buttons extension, responsive mode, column defs customizados),
 *               Bootstrap 5.3.8 (cards arredondados, badges, modals, grid system, botoes),
 *               Syncfusion EJ2 ASP.NET Core (tooltips via atributo data-ejtip, window.ejTooltip.refresh
 *               API), contrato.js (arquivo JavaScript externo na pasta wwwroot/js com 462 linhas
 *               de logica CRUD complexa), Alerta.js (wrapper customizado do SweetAlert2 para
 *               Warning/Confirmar/Erro/TratamentoErroComLinha), AppToast.js (sistema de notificacoes
 *               toast Verde/Vermelho com posicao top-right), Font Awesome 6 Duotone (icones
 *               fa-file-contract, fa-edit, fa-trash, fa-file-pdf, fa-list, fa-dollar-sign)
 * OBSERVACOES: 361 linhas total com layout customizado FrotiX consistente (header com fundo
 *              azul escuro hash 3D5771 e gradient radial sutil, body com gradient vertical
 *              azul claro, cards arredondados border-radius 14px, botoes com efeito outline
 *              branco 2px no hover/focus). Sistema INTELIGENTE de gestao de contratos:
 *              (1) Validacao de dependencias ANTES de excluir previne erros de integridade
 *              referencial verificando 7 entidades linkadas (veiculosContrato, encarregados,
 *              operadores, lavadores, motoristas, empenhos, notasFiscais), se alguma tiver
 *              registros vinculados exibe mensagem detalhada via Alerta.Warning listando
 *              quantidades e impede exclusao. (2) Status dinamico: quando contrato muda para
 *              Inativo, JavaScript atualiza visualmente os botoes de acoes adicionando classe
 *              .disabled, removendo atributo href dos links, alterando tooltips para Bloqueado
 *              por Contrato Inativo, garantindo que acoes criticas (Documentos/Itens/Repactuacao)
 *              nao sejam executadas em contratos inativos. (3) Section HeadBlock extensa (120+
 *              linhas CSS inline) customiza cores (azul escuro header, gradient body, badges
 *              verde/cinza status), hover effects (outline branco botoes, background buttons
 *              acoes), tooltips (posicionamento, cores, setas). (4) Botao laranja + Novo Contrato
 *              com icone fa-file-contract no header com efeito outline branco. (5) DataTable
 *              carregado via AJAX na funcao loadList do contrato.js (tabela vazia no HTML,
 *              populada dinamicamente com JSON do backend). (6) Try-catch aninhado em todos os
 *              handlers JavaScript para tratamento robusto de erros (catch interno para parsing
 *              JSON, catch externo para erros AJAX, ambos chamando Alerta.TratamentoErroComLinha).
 *              Sistema CRITICO para gestao contratual no FrotiX usado para controlar todos os
 *              contratos de terceirizacao de frota (detalhes de empresas contratadas, vigencia,
 *              valores, itens, repactuacoes, documentos anexos). ATENCAO: Modal de documentos
 *              referenciado mas nao implementado neste arquivo (provavelmente em partial separado).
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@
@model FrotiX.Pages.Contrato.IndexModel

@{
    ViewData["Title"] = "Contratos";
    ViewData["PageName"] = "contrato_index";
    ViewData["Heading"] = "";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-file-contract";
}

@section HeadBlock {
    <style>
/* ======== OUTLINE BRANCO NO BOTÃO DO HEADER (Padrão FrotiX) ======== */
		.ftx-card-header .btn-fundo-laranja {
			outline: 2px solid rgba(255, 255, 255, 0.5) !important;
			outline-offset: 1px;
			transition: all 0.2s ease;
		}

		.ftx-card-header .btn-fundo-laranja:hover {
			outline: 2px solid rgba(255, 255, 255, 0.8) !important;
			outline-offset: 2px;
		}

        /* ===== CARD CONTAINER ===== */
        .ftx-card-contrato {
            border: none;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            background: #fff;
            margin-bottom: 1.5rem;
        }

        .ftx-card-contrato .ftx-card-body {
            padding: 1.5rem;
            background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
        }

        /* ===== CORES DE FUNDO PARA BOTÕES ===== */
        .fundo-cinza {
            background-color: #2F4F4F !important;
            color: #fff !important;
            box-shadow: 0 2px 6px rgba(47, 79, 79, 0.35);
        }

        .fundo-cinza:hover {
            background-color: #253A3A !important;
            box-shadow: 0 4px 10px rgba(47, 79, 79, 0.45);
        }

        .fundo-chocolate {
            background-color: #7B3F00 !important;
            color: #fff !important;
            box-shadow: 0 2px 6px rgba(123, 63, 0, 0.35);
        }

        .fundo-chocolate:hover {
            background-color: #5a2e00 !important;
            box-shadow: 0 4px 10px rgba(123, 63, 0, 0.45);
        }

        /* ===== BTN-INFO (PDF) COM GLOW ===== */
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
            border: none !important;
            box-shadow: 0 2px 6px rgba(23, 162, 184, 0.4);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%) !important;
            box-shadow: 0 4px 10px rgba(23, 162, 184, 0.55);
        }

        /* ===== DATATABLE ESTILIZAÇÃO ===== */
        #tblContrato {
            font-size: 0.85rem;
        }

        #tblContrato thead th {
            background: linear-gradient(135deg, #325d88 0%, #3d6f9e 100%);
            color: #fff;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.75rem 0.5rem;
            border: none;
            white-space: nowrap;
        }

        #tblContrato tbody td {
            padding: 0.6rem 0.5rem;
            vertical-align: middle;
            border-color: #e9ecef;
        }

        #tblContrato tbody tr:hover {
            background-color: rgba(50, 93, 136, 0.05);
        }

        /* ===== BOTÕES DE AÇÃO NA TABELA ===== */
        .ftx-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }

        .ftx-actions .btn,
        .ftx-actions .btn-icon-28 {
            width: 28px;
            height: 28px;
            padding: 0 !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            border: none;
            color: #fff !important;
        }

        .ftx-actions .btn:hover,
        .ftx-actions .btn-icon-28:hover {
            transform: translateY(-2px);
        }

        /* Glow por cor de botão */
        .ftx-actions .btn-azul {
            box-shadow: 0 2px 6px rgba(50, 93, 136, 0.35);
        }
        .ftx-actions .btn-azul:hover {
            box-shadow: 0 4px 10px rgba(50, 93, 136, 0.5);
        }

        .ftx-actions .btn-vinho {
            box-shadow: 0 2px 6px rgba(114, 47, 55, 0.35);
        }
        .ftx-actions .btn-vinho:hover {
            box-shadow: 0 4px 10px rgba(114, 47, 55, 0.5);
        }

        .ftx-actions .btn-info {
            box-shadow: 0 2px 6px rgba(23, 162, 184, 0.35);
        }
        .ftx-actions .btn-info:hover {
            box-shadow: 0 4px 10px rgba(23, 162, 184, 0.5);
        }

        .ftx-actions .fundo-cinza {
            box-shadow: 0 2px 6px rgba(47, 79, 79, 0.35);
        }
        .ftx-actions .fundo-cinza:hover {
            box-shadow: 0 4px 10px rgba(47, 79, 79, 0.5);
        }

        .ftx-actions .fundo-chocolate {
            box-shadow: 0 2px 6px rgba(123, 63, 0, 0.35);
        }
        .ftx-actions .fundo-chocolate:hover {
            box-shadow: 0 4px 10px rgba(123, 63, 0, 0.5);
        }

        /* ===== BOTÕES DESABILITADOS (quando contrato inativo) ===== */
        /* IMPORTANTE: Forçar pointer-events:auto para permitir tooltips */
        .ftx-actions .btn.disabled,
        .ftx-actions .btn.disabled:hover,
        .ftx-actions .btn.disabled:focus {
            pointer-events: auto !important;
            opacity: 0.5;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ===== TOOLTIP BOOTSTRAP ESTILO SYNCFUSION (para quebra de linha) ===== */
        .tooltip-ftx-syncfusion .tooltip-inner {
            background-color: #4a6b8a !important;
            color: #ffffff !important;
            border: 1px solid #7a8a9a !important;
            border-radius: 8px !important;
            padding: 8px 12px !important;
            font-size: 13px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            text-align: left !important;
            white-space: normal !important;
            line-height: 1.4 !important;
            max-width: 300px !important;
        }
        .tooltip-ftx-syncfusion .tooltip-arrow {
            display: none !important;
        }

        /* ===== BADGE DE STATUS (sem degradê - Padrão FrotiX) ===== */
        .ftx-badge-status {
            font-size: 0.65rem;
            padding: 0.4rem 0.7rem;
            border-radius: 5px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            min-width: 75px;
            min-height: 26px;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .ftx-badge-status:hover {
            transform: translateY(-1px);
            cursor: pointer;
        }

        .ftx-badge-status i {
            font-size: 0.6rem;
        }

        /* Ativo = Verde Militar */
        .ftx-badge-status.btn-verde {
            background-color: #4A5D23 !important;
            color: #fff !important;
            border: none;
        }

        .ftx-badge-status.btn-verde:hover {
            background-color: #3d4d1c !important;
        }

        /* Inativo = Cinza Chumbo */
        .ftx-badge-status.fundo-cinza {
            background-color: #4A4A4A !important;
            color: #fff !important;
        }

        .ftx-badge-status.fundo-cinza:hover {
            background-color: #3a3a3a !important;
        }

        /* ===== WRAPPER DO DATATABLE ===== */
        .dataTables_wrapper .dataTables_filter input {
            border-radius: 6px;
            border: 1px solid #cbd5e0;
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
        }

        .dataTables_wrapper .dataTables_filter input:focus {
            border-color: #325d88;
            box-shadow: 0 0 0 3px rgba(50, 93, 136, 0.15);
            outline: none;
        }

        .dataTables_wrapper .dataTables_length select {
            border-radius: 6px;
            border: 1px solid #cbd5e0;
            padding: 0.3rem 0.5rem;
            font-size: 0.85rem;
        }

        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_length label,
        .dataTables_wrapper .dataTables_filter label {
            font-size: 0.85rem;
            color: #4a5568;
        }

        /* ===== RESPONSIVIDADE ===== */
        @@media (max-width: 768px) {
            .ftx-card-contrato .ftx-card-body {
                padding: 1rem;
            }

            #tblContrato {
                font-size: 0.8rem;
            }

            .ftx-actions .btn {
                width: 26px;
                height: 26px;
                font-size: 0.75rem;
            }
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <!-- Card FrotiX -->
        <div class="ftx-card-contrato">
            <!-- Header do Card - Usa padrão global ftx-card-header -->
            <div class="ftx-card-header">
                <h2 class="titulo-paginas">
                    <i class="fa-duotone fa-file-contract"></i>
                    Contratos
                </h2>
                <div class="ftx-card-actions">
                    <a href="/Contrato/Upsert" class="btn btn-fundo-laranja" data-ftx-loading>
                        <i class="fa-duotone fa-clone-plus icon-pulse me-1"></i>
                        Adicionar Contrato
                    </a>
                </div>
            </div>

            <!-- Body do Card -->
            <div class="ftx-card-body">
                <div class="table-responsive">
                    <table id="tblContrato" class="table table-bordered table-striped ftx-table" width="100%">
                        <thead>
                            <tr>
                                <th>Contrato</th>
                                <th>Processo</th>
                                <th>Objeto</th>
                                <th>Empresa</th>
                                <th>Vigência</th>
                                <th>(R$) Anual</th>
                                <th>(R$) Mensal</th>
                                <th>Prorrogação</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script src="~/js/cadastros/contrato.js" asp-append-version="true"></script>
}
