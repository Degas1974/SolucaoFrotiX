@* ****************************************************************************************
 * 笞｡ ARQUIVO: Pages/Multa/ExibePDFComprovante.cshtml
 * --------------------------------------------------------------------------------------
 * 識 OBJETIVO     : Pﾃ｡gina de visualizaﾃｧﾃ｣o PDF do comprovante de pagamento de multa/penalidade com
 *                   Syncfusion EJ2 PDFViewer, carrega /DadosEditaveis/Multas/{ComprovantePDF}, botﾃ｣o voltar
 *                   ./ListaPenalidade, stopEnterSubmitting prevention, error handling AppToast/Alerta.
 * 踏 ENTRADAS     : @page route /Multa/ExibePDFComprovante, @model ExibePDFComprovanteModel (code-behind),
 *                   Model.MultaObj.Multa.NumInfracao (int nﾃｺmero infraﾃｧﾃ｣o), Model.MultaObj.Multa.ComprovantePDF
 *                   (string filename PDF), form onkeypress stopEnterSubmitting
 * 豆 SAﾃ好AS       : Panel com botﾃ｣o center absolute btn-voltar "Voltar ﾃ Lista" link ./ListaPenalidade,
 *                   h2 text-primary "Registro de Pagamento da Infraﾃｧﾃ｣o nﾂｺ: {NumInfracao}", div #pdfContainer
 *                   height 800px, <ejs-pdfviewer id="pdfViewer" serviceUrl="/api/PdfViewer" documentPath=""
 *                   height:100%>, JavaScript DOMContentLoaded pdfViewer.load(caminho) ou alert danger "PDF nﾃ｣o
 *                   disponﾃｭvel", Bootstrap 5 CDN (REDUNDANTE!)
 * 迫 CHAMADA POR  : Link "Ver Comprovante" em ListaPenalidade DataTable, route /Multa/ExibePDFComprovante,
 *                   ExibePDFComprovanteModel.OnGet(id) (code-behind), botﾃｵes aﾃｧﾃ｣o multa pages
 * 売 CHAMA        : ExibePDFComprovanteModel (code-behind Multa/ExibePDFComprovante.cshtml.cs),
 *                   Model.MultaObj.Multa (properties NumInfracao, ComprovantePDF), ./ListaPenalidade (link voltar),
 *                   /api/PdfViewer (Syncfusion PDF service API backend), /DadosEditaveis/Multas/{filename}.pdf
 *                   (PDF static files), Syncfusion EJ2 PDFViewer component (ejs-pdfviewer TagHelper),
 *                   ej2_instances[0] (Syncfusion instance accessor), pdfViewer.load(path, null), AppToast.show
 *                   (FrotiX toast), Alerta.TratamentoErroComLinha (error handler), ViewData (Title/PageName/Heading/
 *                   Category1/PageIcon), Font Awesome Duotone (fa-cash-register, fa-rotate-left), Bootstrap 5 CDN
 *                   (jsdelivr.net v5.3.8), AntiForgeryToken, stopEnterSubmitting(window.event), form enctype
 *                   multipart/form-data (Nﾃグ usado! sem file input), data-ftx-loading
 * 逃 DEPENDﾃ劾CIAS : ASP.NET Core Razor Pages, ExibePDFComprovanteModel (code-behind), Syncfusion EJ2 ASP.NET Core
 *                   PDFViewer component (ejs-pdfviewer TagHelper, /api/PdfViewer service, ej2_instances accessor),
 *                   Bootstrap 5 CDN (REDUNDANTE), Font Awesome Duotone, CSS inline (.center absolute transform),
 *                   JavaScript DOMContentLoaded, AppToast.show (FrotiX custom), Alerta.TratamentoErroComLinha
 *                   (error handler FrotiX), AntiForgeryToken, data-ftx-loading, asp-page link TagHelper
 * 統 OBSERVAﾃﾃ髭S  : 107 linhas. Pﾃ｡gina visualizaﾃｧﾃ｣o PDF comprovante pagamento multa. ViewData config:
 *                   - Title: "Pagamento da Penalidade"
 *                   - PageName: "notificacao_index" (ERRADO! deve ser "multa_exibepdfcomprovante")
 *                   - Heading: "<i class='fa-duotone fa-cash-register'></i> Infraﾃｧﾃｵes: <span class='fw-300'>Registro de Pagamento da Penalidade - PDF</span>"
 *                   - Category1: "Infraﾃｧﾃｵes"
 *                   - PageIcon: "fa-duotone fa-cash-register"
 *                   @Html.AntiForgeryToken() linha 2 (FORA do form! deve mover dentro <form> ou remover).
 *                   @section HeadBlock: CSS inline .center {position:absolute; left:50%; top:30px;
 *                   transform:translate(-50%,-50%); padding:10px;} (botﾃ｣o voltar posicionado absolute topo centro).
 *                   Form method POST asp-action="Upsert" (Nﾃグ faz sentido! pﾃ｡gina sﾃｳ visualiza PDF, sem inputs, sem submit)
 *                   enctype multipart/form-data (Nﾃグ usado! sem file input) onkeypress stopEnterSubmitting.
 *                   Botﾃ｣o voltar: col-12 col-md-4 center (absolute) asp-page="./ListaPenalidade" btn-voltar
 *                   data-ftx-loading fa-rotate-left icon-space icon-rotate-left "Voltar ﾃ Lista". H2 border-bottom
 *                   #325d88 text-primary "Registro de Pagamento da Infraﾃｧﾃ｣o nﾂｺ: {Model.MultaObj?.Multa?.NumInfracao}".
 *                   Div #pdfContainer height 800px: <ejs-pdfviewer id="pdfViewer" style="height:100%"
 *                   serviceUrl="/api/PdfViewer" documentPath=""/> (documentPath vazio - serﾃ｡ preenchido JavaScript).
 *                   @section ScriptsBlock: **Bootstrap 5 CDN REDUNDANTE** (v5.3.8 CSS + JS bundle).
 *                   JavaScript:
 *                   1. **stopEnterSubmitting(e)**: previne Enter submit, try-catch Alerta.TratamentoErroComLinha
 *                      ("ExibePDFComprovante.cshtml", "stopEnterSubmitting", error)
 *                   2. **DOMContentLoaded**: var arquivoPdf = '@(Model.MultaObj?.Multa?.ComprovantePDF ?? "")';
 *                      string Razor interpolation (se ComprovantePDF null usa ""), verifica !arquivoPdf (se vazio
 *                      AppToast.show "Arquivo de comprovante nﾃ｣o encontrado para esta infraﾃｧﾃ｣o" Vermelho 3000ms,
 *                      innerHTML pdfContainer alert-danger "PDF nﾃ｣o disponﾃｭvel", return), caminho =
 *                      "/DadosEditaveis/Multas/" + arquivoPdf (path static file), pdfViewer =
 *                      document.getElementById('pdfViewer').ej2_instances[0] (Syncfusion instance accessor),
 *                      if pdfViewer exists: pdfViewer.load(caminho, null) (carrega PDF), else AppToast.show
 *                      "Erro ao inicializar o visualizador de PDF" Vermelho, try-catch Alerta.TratamentoErroComLinha
 *                      ("ExibePDFComprovante.cshtml", "DOMContentLoaded", error)
 *                   **PROBLEMAS**:
 *                   1. PageName "notificacao_index" ERRADO (deve ser "multa_exibepdfcomprovante")
 *                   2. AntiForgeryToken fora do form (mover dentro ou remover)
 *                   3. Form asp-action="Upsert" method POST (Nﾃグ faz sentido - sﾃｳ visualiza, remover form tag)
 *                   4. Enctype multipart/form-data Nﾃグ usado (sem file input)
 *                   5. Bootstrap CDN redundante (remover)
 *                   **ARQUIVO RELACIONADO**: ExibePDFPenalidade.cshtml (QUASE IDﾃ劾CTICO - mesmo cﾃｳdigo, mesmo
 *                   campo ComprovantePDF - DUPLICAﾃﾃグ?), ExibePDFAutuacao.cshtml (variante campo AutuacaoPDF).
 **************************************************************************************** *@
@page
@Html.AntiForgeryToken()
@model FrotiX.Pages.Multa.ExibePDFComprovanteModel

@{
	ViewData["Title"] = "Pagamento da Penalidade";
	ViewData["PageName"] = "notificacao_index";
	ViewData["Heading"] = "<i class='fa-duotone fa-cash-register'></i> Infraﾃｧﾃｵes: <span class='fw-300'>Registro de Pagamento da Penalidade - PDF</span>";
	ViewData["Category1"] = "Infraﾃｧﾃｵes";
	ViewData["PageIcon"] = "fa-duotone fa-cash-register";
}

@section HeadBlock {
	<style>
		.center {
			position: absolute;
			left: 50%;
			top: 30px;
			transform: translate(-50%, -50%);
			padding: 10px;
		}
	</style>
}

<form method="post" asp-action="Upsert" onkeypress="stopEnterSubmitting(window.event)" enctype="multipart/form-data">
	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel">
				<div class="panel-container show">
					<br />
					<div class="col-12 col-md-4 center">
						<a asp-page="./ListaPenalidade" class="btn btn-voltar form-control" data-ftx-loading>
							<i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i>
							Voltar ﾃ Lista
						</a>
					</div>

					<br />
					<div class="col-12 px-3" style="border-bottom:1px solid #325d88">
						<h2 class="text-primary">
							@($"Registro de Pagamento da Infraﾃｧﾃ｣o nﾂｺ: {Model.MultaObj?.Multa?.NumInfracao}")
						</h2>
					</div>

					<div id="divPainel" class="panel-content">
						<div id="pdfContainer" style="height: 800px;">
							<ejs-pdfviewer id="pdfViewer"
										   style="height:100%"
										   serviceUrl="/api/PdfViewer"
										   documentPath="">
							</ejs-pdfviewer>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</form>

@section ScriptsBlock {
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script>
		// Evita submit com ENTER em campos de formulﾃ｡rio
		function stopEnterSubmitting(e) {
			try {
				e = e || window.event;
				if (e && (e.key === 'Enter' || e.keyCode === 13)) {
					const src = e.target || e.srcElement;
					if (src && src.tagName && src.tagName.toLowerCase() !== "div") {
						if (e.preventDefault) e.preventDefault();
						else e.returnValue = false;
					}
				}
			}
			catch (error) {
				Alerta.TratamentoErroComLinha("ExibePDFComprovante.cshtml", "stopEnterSubmitting", error);
			}
		}

		document.addEventListener('DOMContentLoaded', function () {
			try {
				var arquivoPdf = '@(Model.MultaObj?.Multa?.ComprovantePDF ?? "")';

				if (!arquivoPdf) {
					AppToast.show('Arquivo de comprovante nﾃ｣o encontrado para esta infraﾃｧﾃ｣o.', 'Vermelho', 3000);
					document.getElementById('pdfContainer').innerHTML = "<div class='alert alert-danger text-center mt-5'>PDF nﾃ｣o disponﾃｭvel.</div>";
					return;
				}

				var caminho = "/DadosEditaveis/Multas/" + arquivoPdf;
				var pdfViewer = document.getElementById('pdfViewer').ej2_instances[0];

				if (pdfViewer) {
					pdfViewer.load(caminho, null);
				}
				else {
					AppToast.show('Erro ao inicializar o visualizador de PDF.', 'Vermelho', 3000);
				}
			}
			catch (error) {
				Alerta.TratamentoErroComLinha("ExibePDFComprovante.cshtml", "DOMContentLoaded", error);
			}
		});
	</script>
}
