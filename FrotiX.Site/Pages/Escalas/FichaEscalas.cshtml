@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Escalas/FichaEscalas.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Exibir ficha de escala (relat√≥rio) com dados consolidados, filtros per√≠odo, export PDF/Impress√£o
 * üì• ENTRADAS     : @page, @model FichaEscalasModel, filtros (dataInicio, dataFim, escalaId), clique bot√£o gerar/exportar
 * üì§ SA√çDAS       : HTML relat√≥rio formatado (print-friendly), bot√µes export PDF (jsPDF), imprimir (window.print), dados escala
 * üîó CHAMADA POR  : Menu Escalas ‚Üí Ficha de Escala, link ListaEscala
 * üîÑ CHAMA        : /api/Escalas/ObterFicha, jsPDF (export), window.print (impress√£o)
 * üì¶ DEPEND√äNCIAS : jsPDF, html2canvas, Bootstrap 5, jQuery, Google Fonts Outfit, CSS print-friendly inline
 * üìù OBSERVA√á√ïES  : Total: 838 linhas. ISSUES: CSS inline ~250 linhas (estilos relat√≥rio), JavaScript inline ~150 linhas (export/print), sem lazy loading dados (carrega tudo), export PDF sem progress indicator, layout quebra com muitos dados
 **************************************************************************************** *@
@page
@model FrotiX.Pages.Escalas.FichaEscalasModel
@{
    ViewData["Title"] = "Ficha de Escala";
    ViewData["PageName"] = "ficha_escala";
    Layout = "_Layout";
    var dataEscala = Model.DataEscala ?? DateTime.Today;
    var diaSemana = dataEscala.ToString("dddd", new System.Globalization.CultureInfo("pt-BR"));
    diaSemana = char.ToUpper(diaSemana[0]) + diaSemana.Substring(1);

    // Agrupar escalas por turno e tipo de servi√ßo (excluindo indispon√≠veis)
    var servicosGeraisMatutino = Model.Escalas
        .Where(e => e.NomeTurno == "Matutino" && e.NomeServico == "Servi√ßos Gerais" && e.StatusMotorista != "Indispon√≠vel")
        .OrderBy(e => e.HoraInicio).ToList();
    
    var economildoMatutino = Model.Escalas
        .Where(e => e.NomeTurno == "Matutino" && e.NomeServico == "Economildo" && e.StatusMotorista != "Indispon√≠vel")
        .OrderBy(e => e.HoraInicio).ToList();
    
    var servicosGeraisVespertino = Model.Escalas
        .Where(e => e.NomeTurno == "Vespertino" && e.NomeServico == "Servi√ßos Gerais" && e.StatusMotorista != "Indispon√≠vel")
        .OrderBy(e => e.HoraInicio).ToList();
    
    var economildoVespertino = Model.Escalas
        .Where(e => e.NomeTurno == "Vespertino" && e.NomeServico == "Economildo" && e.StatusMotorista != "Indispon√≠vel")
        .OrderBy(e => e.HoraInicio).ToList();
    
    var servicosGeraisNoturno = Model.Escalas
        .Where(e => e.NomeTurno == "Noturno" && e.NomeServico == "Servi√ßos Gerais" && e.StatusMotorista != "Indispon√≠vel")
        .OrderBy(e => e.HoraInicio).ToList();

    // Indispon√≠veis separados por motivo
    var ferias = Model.Escalas.Where(e => e.MotivoCobertura == "F√©rias" && e.StatusMotorista == "Indispon√≠vel").ToList();
    var folgas = Model.Escalas.Where(e => e.MotivoCobertura == "Folga" && e.StatusMotorista == "Indispon√≠vel").ToList();
    var faltas = Model.Escalas.Where(e => e.MotivoCobertura == "Falta" && e.StatusMotorista == "Indispon√≠vel").ToList();
    var recessos = Model.Escalas.Where(e => e.MotivoCobertura == "Recesso" && e.StatusMotorista == "Indispon√≠vel").ToList();
    var atestados = Model.Escalas.Where(e => e.MotivoCobertura == "Atestado" && e.StatusMotorista == "Indispon√≠vel").ToList();
    
    // Combinar folgas, faltas, recessos e atestados
    var afastamentos = folgas.Concat(faltas).Concat(recessos).Concat(atestados).ToList();
}

<style>
    /* ============================================= */
    /* ESTILOS DE IMPRESS√ÉO / EXPORTA√á√ÉO PDF        */
    /* ============================================= */
    @@media print {
        /* Configura√ß√£o da p√°gina com margens */
        @@page {
            margin: 10mm;
            size: A4 portrait;
        }

        /* Configura√ß√µes gerais */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            font-size: 9pt;
            background: #fff !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        /* ESCONDE ELEMENTOS NO-PRINT - MUITO ESPEC√çFICO */
        .no-print,
        .no-print *,
        div.no-print,
        div.no-print *,
        .no-print label,
        .no-print input,
        .no-print button,
        .no-print a,
        [class*="no-print"],
        [class*="no-print"] * {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        /* ESCONDE ELEMENTOS DO LAYOUT */
        header,
        footer,
        nav,
        aside,
        .sidebar,
        .navbar,
        .nav,
        .menu,
        .breadcrumb,
        #sidebar,
        .sidebar-wrapper,
        .main-header,
        .main-footer,
        .content-header {
            display: none !important;
        }

        /* Container principal */
        .container-fluid,
        .container,
        main,
        .content,
        .content-wrapper {
            padding: 0 !important;
            margin: 0 !important;
            background: #fff !important;
            width: 100% !important;
            max-width: none !important;
        }

        /* Ficha container */
        .ficha-container {
            padding: 3mm !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: none !important;
            background: #fff !important;
        }

        /* Tabelas - fundo branco nas c√©lulas (EXCETO cabe√ßalhos) */
        .ficha-table tbody,
        .ficha-table tbody td,
        .afastamento-table tbody,
        .afastamento-table tbody td,
        .afastamento-box,
        .afastamentos-container,
        .observacoes-box {
            background: #fff !important;
            background-color: #fff !important;
        }

        /* ========================================= */
        /* ELEMENTOS QUE DEVEM MANTER COR           */
        /* ========================================= */
        .section-header,
        td.section-header,
        .ficha-table .section-header,
        .ficha-table td.section-header {
            background-color: #2c3e50 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .ficha-table thead tr:last-child th {
            background-color: #4a6278 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .afastamento-header {
            background-color: #2c3e50 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .afastamento-table th {
            background-color: #4a6278 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Quadradinhos de sa√≠das */
        .saida-box {
            border: 1px solid #000 !important;
            background-color: #fff !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .saida-box.preenchido {
            background-color: #000 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .saida-box.hachurado {
            background: repeating-linear-gradient(
                45deg,
                #666,
                #666 2px,
                #fff 2px,
                #fff 4px
            ) !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Selo de cobertura */
        .selo-cobertura {
            background: linear-gradient(145deg, #5dade2, #2980b9) !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Evita quebra de p√°gina no meio das tabelas */
        table {
            page-break-inside: avoid;
        }

        .afastamentos-container {
            page-break-inside: avoid;
        }

        .observacoes-box {
            page-break-inside: avoid;
        }
    }

    /* ============================================= */
    /* ESTILOS NORMAIS DA P√ÅGINA                    */
    /* ============================================= */
    .ficha-container {
        font-family: Arial, sans-serif;
        background: white;
        max-width: 1200px;
        margin: 0 auto;
    }

    .ficha-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 10pt;
    }

    .ficha-table th, .ficha-table td {
        border: 1px solid #000;
        padding: 4px 6px;
        text-align: left;
    }

    /* Cabe√ßalho principal - Azul Petr√≥leo */
    .section-header {
        background-color: #2c3e50;
        color: white;
        font-weight: bold;
        text-align: center;
        font-size: 11pt;
    }

    /* Sub-cabe√ßalho - 30% mais claro */
    .ficha-table thead tr:last-child th {
        background-color: #4a6278;
        color: white;
    }

    .col-horario { width: 60px; text-align: center; }
    .col-qtd { width: 40px; text-align: center; }
    .col-motorista { width: 180px; }
    .col-saidas { width: 100px; }
    .col-veiculo { width: 80px; text-align: center; }
    .col-lotacao { width: 120px; }
    .col-fim { width: 60px; text-align: center; }

    /* Quadradinhos de sa√≠das */
    .saidas-container {
        display: flex;
        gap: 2px;
    }
    .saida-box {
        width: 14px;
        height: 14px;
        border: 1px solid #000;
        display: inline-block;
    }
    .saida-box.preenchido {
        background-color: #000;
    }
    .saida-box.hachurado {
        background: repeating-linear-gradient(
            45deg,
            #666,
            #666 2px,
            #fff 2px,
            #fff 4px
        );
    }

    /* Selo de Cobertura */
    .selo-cobertura {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(145deg, #5dade2, #2980b9);
        color: white;
        font-size: 10px;
        font-weight: bold;
        margin-left: 5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Se√ß√µes de f√©rias/afastamentos */
    .afastamentos-container {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }
    .afastamento-box {
        flex: 1;
        border: 1px solid #000;
    }
    .afastamento-header {
        background-color: #2c3e50;
        color: white;
        font-weight: bold;
        padding: 5px;
        text-align: center;
        border-bottom: 1px solid #000;
        font-size: 10pt;
    }
    .afastamento-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
    }
    .afastamento-table th {
        background-color: #4a6278;
        color: white;
    }
    .afastamento-table th, .afastamento-table td {
        border: 1px solid #000;
        padding: 3px 5px;
    }

    /* Observa√ß√µes */
    .observacoes-box {
        border: 1px solid #000;
        padding: 8px;
        margin-top: 15px;
        min-height: 80px;
    }
    .observacoes-header {
        font-weight: bold;
        margin-bottom: 5px;
    }
</style>

<div class="container-fluid">
    <!-- Bot√µes de controle - TUDO no-print -->
    <div class="no-print mb-3 d-flex gap-2">
        <a href="/Escalas/ListaEscala" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <button class="btn btn-primary" onclick="window.print()">
            <i class="fas fa-print"></i> Imprimir
        </button>
        <button class="btn btn-danger" id="btnExportarPDF">
            <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
        <label for="dataFiltro" class="mb-0 ms-auto">Data:</label>
        <input type="date" id="dataFiltro" class="form-control" style="width: 160px;" 
               value="@dataEscala.ToString("yyyy-MM-dd")" 
               onchange="filtrarPorData()" />
    </div>

    <div class="ficha-container" id="fichaConteudo">
        
        <!-- SERVI√áOS GERAIS - MATUTINO -->
        @if (servicosGeraisMatutino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">
                            SERVI√áOS GERAIS - MATUTINO - @dataEscala.ToString("dd/MM/yyyy") - @diaSemana
                        </td>
                    </tr>
                    <tr>
                        <th class="col-horario">HOR√ÅRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SA√çDAS</th>
                        <th class="col-veiculo">VE√çCULO</th>
                        <th class="col-lotacao">LOTA√á√ÉO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int qtdSGM = 0; }
                    @foreach (var escala in servicosGeraisMatutino)
                    {
                        qtdSGM++;
                        var ehCobertor = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitular = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdSGM</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertor)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitular">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box @(i < escala.NumeroSaidas ? "preenchido" : "")"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- ECONOMILDO MATUTINO -->
        @if (economildoMatutino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">ECONOMILDO MATUTINO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HOR√ÅRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SA√çDAS</th>
                        <th class="col-veiculo">VE√çCULO</th>
                        <th class="col-lotacao">LOTA√á√ÉO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int qtdEM = 0; }
                    @foreach (var escala in economildoMatutino)
                    {
                        qtdEM++;
                        var ehCobertorEM = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularEM = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdEM</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorEM)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularEM">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @* Economildo sempre tem todos os quadradinhos hachurados *@
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box hachurado"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- SERVI√áOS GERAIS - VESPERTINO -->
        @if (servicosGeraisVespertino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">SERVI√áOS GERAIS - VESPERTINO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HOR√ÅRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SA√çDAS</th>
                        <th class="col-veiculo">VE√çCULO</th>
                        <th class="col-lotacao">LOTA√á√ÉO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int qtdSGV = 0; }
                    @foreach (var escala in servicosGeraisVespertino)
                    {
                        qtdSGV++;
                        var ehCobertorSGV = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularSGV = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdSGV</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorSGV)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularSGV">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box @(i < escala.NumeroSaidas ? "preenchido" : "")"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- ECONOMILDO VESPERTINO -->
        @if (economildoVespertino.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">ECONOMILDO VESPERTINO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HOR√ÅRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SA√çDAS</th>
                        <th class="col-veiculo">VE√çCULO</th>
                        <th class="col-lotacao">LOTA√á√ÉO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int qtdEV = 0; }
                    @foreach (var escala in economildoVespertino)
                    {
                        qtdEV++;
                        var ehCobertorEV = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularEV = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdEV</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorEV)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularEV">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box hachurado"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- SERVI√áOS GERAIS - NOTURNO -->
        @if (servicosGeraisNoturno.Any())
        {
            <table class="ficha-table">
                <thead>
                    <tr>
                        <td colspan="7" class="section-header">SERVI√áOS GERAIS - NOTURNO</td>
                    </tr>
                    <tr>
                        <th class="col-horario">HOR√ÅRIO</th>
                        <th class="col-qtd">QTD</th>
                        <th class="col-motorista">MOTORISTA</th>
                        <th class="col-saidas">SA√çDAS</th>
                        <th class="col-veiculo">VE√çCULO</th>
                        <th class="col-lotacao">LOTA√á√ÉO</th>
                        <th class="col-fim">Seg/Sexta</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int qtdSGN = 0; }
                    @foreach (var escala in servicosGeraisNoturno)
                    {
                        qtdSGN++;
                        var ehCobertorSGN = Model.EhCobertor(escala.MotoristaId);
                        var nomeTitularSGN = Model.ObterNomeTitular(escala.MotoristaId);
                        <tr>
                            <td class="col-horario">@escala.HoraInicio?.Substring(0, 5)</td>
                            <td class="col-qtd">@qtdSGN</td>
                            <td class="col-motorista">
                                @escala.NomeMotorista
                                @if (ehCobertorSGN)
                                {
                                    <span class="selo-cobertura" title="Cobertura de @nomeTitularSGN">C</span>
                                }
                            </td>
                            <td class="col-saidas">
                                <div class="saidas-container">
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        <span class="saida-box @(i < escala.NumeroSaidas ? "preenchido" : "")"></span>
                                    }
                                </div>
                            </td>
                            <td class="col-veiculo">@(escala.Placa ?? "")</td>
                            <td class="col-lotacao">@escala.Lotacao</td>
                            <td class="col-fim">@escala.HoraFim?.Substring(0, 5)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- SE√á√ïES DE F√âRIAS E AFASTAMENTOS -->
        <div class="afastamentos-container">
            <!-- F√âRIAS -->
            <div class="afastamento-box">
                <div class="afastamento-header">
                    F√âRIAS - @DateTime.Now.ToString("MMMM yyyy", new System.Globalization.CultureInfo("pt-BR")).ToUpper()
                </div>
                <table class="afastamento-table">
                    <thead>
                        <tr>
                            <th style="width: 60%;">F√âRIAS / POSTO</th>
                            <th style="width: 40%;">COBERTURA</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (ferias.Any())
                        {
                            @foreach (var item in ferias)
                            {
                                <tr>
                                    <td>@item.NomeMotoristaTitular</td>
                                    <td>@(item.NomeMotoristaCobertor ?? "N√£o definido")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2" class="text-center text-muted">Nenhum motorista de f√©rias</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- FOLGAS, FALTAS, RECESSOS E ATESTADOS -->
            <div class="afastamento-box">
                <div class="afastamento-header">
                    FOLGAS / FALTAS / RECESSOS / ATESTADOS
                </div>
                <table class="afastamento-table">
                    <thead>
                        <tr>
                            <th style="width: 35%;">MOTORISTA</th>
                            <th style="width: 35%;">MOTIVO / PER√çODO</th>
                            <th style="width: 30%;">COBERTURA</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (afastamentos.Any())
                        {
                            @foreach (var item in afastamentos)
                            {
                                var periodoStr = "";
                                if (item.DataInicio.HasValue && item.DataFim.HasValue)
                                {
                                    periodoStr = $" ({item.DataInicio.Value:dd/MM} at√© {item.DataFim.Value:dd/MM})";
                                }
                                <tr>
                                    <td>@item.NomeMotoristaTitular</td>
                                    <td>@item.MotivoCobertura@periodoStr</td>
                                    <td>@(item.NomeMotoristaCobertor ?? "N√£o definido")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center text-muted">Nenhum afastamento registrado</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- OBSERVA√á√ïES DO DIA -->
        <div class="observacoes-box">
            <div class="observacoes-header">OBSERVA√á√ïES:</div>
            <div id="observacoesConteudo">
                <!-- Carregado via JS -->
            </div>
        </div>

    </div>
</div>

@section ScriptsBlock {
    <script>
        // ===================================================================
        // FichaEscalas - Scripts Inline
        // ===================================================================

        // Fun√ß√£o global para filtrar por data
        function filtrarPorData() {
            try {
                var dataInput = document.getElementById('dataFiltro');
                if (dataInput && dataInput.value) {
                    window.location.href = '/Escalas/FichaEscalas?DataEscala=' + dataInput.value;
                }
            } catch (error) {
                console.error('Erro em filtrarPorData:', error);
                if (typeof Alerta !== 'undefined') {
                    Alerta.TratamentoErroComLinha("FichaEscalas", "filtrarPorData", error);
                }
            }
        }

        // Fun√ß√£o global para exportar PDF
        function exportarPDF() {
            try {
                console.log('Exportando PDF...');
                window.print();
            } catch (error) {
                console.error('Erro em exportarPDF:', error);
                if (typeof Alerta !== 'undefined') {
                    Alerta.TratamentoErroComLinha("FichaEscalas", "exportarPDF", error);
                }
            }
        }

        // Fun√ß√£o para carregar observa√ß√µes
        function carregarObservacoesFicha() {
            try {
                var dataInput = document.getElementById('dataFiltro');
                if (!dataInput || !dataInput.value) {
                    console.warn('Campo dataFiltro n√£o encontrado ou vazio');
                    return;
                }

                var dataParam = dataInput.value;
                console.log('Buscando observa√ß√µes para:', dataParam);

                $.ajax({
                    url: '/api/Escala/GetObservacoesDia',
                    type: 'GET',
                    data: { data: dataParam },
                    success: function (response) {
                        try {
                            console.log('Resposta observa√ß√µes:', response);
                            var container = document.getElementById('observacoesConteudo');
                            if (!container) {
                                console.warn('Container observacoesConteudo n√£o encontrado');
                                return;
                            }

                            if (response.success && response.data && response.data.length > 0) {
                                var html = '';
                                response.data.forEach(function (obs) {
                                    html += '<div style="margin-bottom: 5px;">';
                                    if (obs.titulo) {
                                        html += '<strong>' + obs.titulo + ':</strong> ';
                                    }
                                    html += (obs.descricao || '');
                                    html += '</div>';
                                });
                                container.innerHTML = html;
                                console.log('Observa√ß√µes carregadas:', response.data.length);
                            } else {
                                container.innerHTML = '<span class="text-muted">Nenhuma observa√ß√£o para este dia</span>';
                                console.log('Nenhuma observa√ß√£o encontrada');
                            }
                        } catch (error) {
                            console.error('Erro ao processar observa√ß√µes:', error);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Erro ao carregar observa√ß√µes:', error);
                        console.error('Status:', xhr.status);
                        var container = document.getElementById('observacoesConteudo');
                        if (container) {
                            container.innerHTML = '<span class="text-muted">Erro ao carregar observa√ß√µes</span>';
                        }
                    }
                });
            } catch (error) {
                console.error('Erro em carregarObservacoesFicha:', error);
            }
        }

        // Executar quando documento estiver pronto
        $(document).ready(function () {
            try {
                console.log('FichaEscalas inicializando...');

                // Carregar observa√ß√µes do dia
                carregarObservacoesFicha();

                // Configurar bot√£o de exportar PDF
                $('#btnExportarPDF').off('click').on('click', function (e) {
                    e.preventDefault();
                    exportarPDF();
                });

                console.log('FichaEscalas inicializado com sucesso');

            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
            }
        });

        console.log('FichaEscalas scripts carregados');
    </script>
}
