@*****************************************************************************************
 * ‚ö° ARQUIVO: Users.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : P√°gina de gerenciamento de usu√°rios do Identity com DataTable
 *                   edit√°vel, permitindo CRUD via AJAX e visualiza√ß√£o de status.
 *
 * üì• ENTRADAS     : Intera√ß√µes do usu√°rio no grid (criar/editar/excluir),
 *                   filtros/ordena√ß√£o/pagina√ß√£o do DataTables.
 *
 * üì§ SA√çDAS       : HTML + JavaScript que renderiza tabela e consome a API /api/users.
 *
 * üîó CHAMADA POR  : Rota Razor Pages /Authorization/Users.
 *
 * üîÑ CHAMA        : /api/users (GET/POST/PUT/DELETE), plugin DataTableEdit.
 *
 * üì¶ DEPEND√äNCIAS : DataTables, datatables.bundle.js, plugin DataTableEdit, alerta (JS).
 *
 * üìù OBSERVA√á√ïES  : Colunas Id e ConcurrencyStamp ficam ocultas; EmailConfirmed e
 *                   LockoutEnabled s√£o exibidos como checkbox desabilitado.
 *****************************************************************************************@

@page
@model UserModel
@{
    ViewData["Title"] = "Users";
    ViewData["PageName"] = "authorization_users";
    ViewData["Heading"] = "<i class='fal fa-shield-alt'></i> Authorization: <span class='fw-300'>Users</span>";
    ViewData["Category1"] = "Authorization";
    ViewData["PageIcon"] = "fa-shield-alt";
}

@section HeadBlock {
    <link rel="stylesheet" media="screen, print" href="~/css/datagrid/datatables/datatables.bundle.css">
    <link rel="stylesheet" media="screen, print" href="~/css/formplugins/select2/select2.bundle.css">
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <div class="panel-container show">
                <div class="panel-content">
                    <table id="dt-list" class="table table-bordered table-hover table-striped w-100"></table>
                </div>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script src="~/js/datagrid/datatables/datatables.bundle.js"></script>
    @* <script src="~/js/formplugins/select2/select2.bundle.js"></script> *@
    <script>
        /****************************************************************************************
         * ‚ö° FUN√á√ÉO: Inicializa√ß√£o DataTable de Users (Usu√°rios do Sistema)
         * --------------------------------------------------------------------------------------
         * üéØ OBJETIVO     : Gerenciar usu√°rios do sistema (ASP.NET Identity) com CRUD completo
         *                   via DataTable edit√°vel, incluindo controle de email confirmado,
         *                   telefone e status de bloqueio (LockOut).
         * üì• ENTRADAS     : Nenhuma (fun√ß√£o auto-execut√°vel no document.ready).
         * üì§ SA√çDAS       : DataTable renderizada na div #dt-list com opera√ß√µes CRUD de usu√°rios.
         * üîó CHAMADA POR  : Evento de UI (document.ready do jQuery).
         * üîÑ CHAMA        : DataTableEdit() (plugin customizado), $.ajax() para API /api/users.
         * üì¶ DEPEND√äNCIAS : jQuery, DataTables, datatables.bundle.js, plugin DataTableEdit.
         ****************************************************************************************/
        $(function () {
            try {
                const endpoint = "/api/users";
                const trueFalseOptions = ["false", "true"];

                // [DOC] Inicializa DataTable com plugin customizado para gerenciar usu√°rios do Identity
                $('#dt-list').DataTableEdit({
                    ajax: endpoint,
                    columns: [
                        { title: "Id", data: "id", type: "readonly", visible: false, searchable: false },
                        { title: "ConcurrencyStamp", data: "concurrencyStamp", type: "readonly", visible: false, searchable: false },
                        { title: "Nome do Usu√°rio", data: "userName", type: "readonly", searchable: true },
                        { title: "Email", data: "email", searchable: true },
                        {
                            title: "Confirmed",
                            data: "emailConfirmed",
                            className: "text-center col-1",
                            type: "select",
                            options: trueFalseOptions,
                            // [DOC] Renderiza checkbox desabilitado para visualiza√ß√£o de email confirmado
                            render: function (data) {
                                return `<input type="checkbox" name="emailConfirmed" disabled ${data ? "checked" : ""}>`;
                            }
                        },
                        { title: "PhoneNumber", data: "phoneNumber", searchable: true },
                        {
                            title: "LockOut",
                            data: "lockoutEnabled",
                            className: "text-center col-1",
                            type: "select",
                            options: trueFalseOptions,
                            // [DOC] Renderiza checkbox desabilitado para visualiza√ß√£o de status de bloqueio
                            render: function (data) {
                                return `<input type="checkbox" name="lockoutEnabled" disabled ${data ? "checked" : ""}>`;
                            }
                        }
                    ],

                    // [DOC] Callback para adicionar novo usu√°rio via POST no endpoint
                    onAddRow: function (table, rowdata, success, error) {
                        try {
                            $.ajax({
                                url: endpoint,
                                type: 'POST',
                                data: rowdata,
                                success: success,
                                error: function(xhr, status, errorMsg) {
                                    alerta.erro('Erro ao adicionar usu√°rio: ' + (xhr.responseJSON?.message || errorMsg));
                                    if (error) error(xhr, status, errorMsg);
                                }
                            });
                        } catch (ex) {
                            alerta.erro('Erro ao processar adi√ß√£o de usu√°rio: ' + ex.message);
                            console.error('Erro onAddRow:', ex);
                        }
                    },

                    // [DOC] Callback para deletar usu√°rio existente via DELETE no endpoint
                    onDeleteRow: function (table, rowdata, success, error) {
                        try {
                            $.ajax({
                                url: endpoint,
                                type: 'DELETE',
                                data: rowdata,
                                success: success,
                                error: function(xhr, status, errorMsg) {
                                    alerta.erro('Erro ao deletar usu√°rio: ' + (xhr.responseJSON?.message || errorMsg));
                                    if (error) error(xhr, status, errorMsg);
                                }
                            });
                        } catch (ex) {
                            alerta.erro('Erro ao processar exclus√£o de usu√°rio: ' + ex.message);
                            console.error('Erro onDeleteRow:', ex);
                        }
                    },

                    // [DOC] Callback para editar usu√°rio existente via PUT no endpoint
                    onEditRow: function (table, rowdata, success, error) {
                        try {
                            $.ajax({
                                url: endpoint,
                                type: 'PUT',
                                data: rowdata,
                                success: success,
                                error: function(xhr, status, errorMsg) {
                                    alerta.erro('Erro ao editar usu√°rio: ' + (xhr.responseJSON?.message || errorMsg));
                                    if (error) error(xhr, status, errorMsg);
                                }
                            });
                        } catch (ex) {
                            alerta.erro('Erro ao processar edi√ß√£o de usu√°rio: ' + ex.message);
                            console.error('Erro onEditRow:', ex);
                        }
                    }
                });
            } catch (erro) {
                alerta.erro('Erro ao inicializar DataTable de Usu√°rios: ' + erro.message);
                console.error('Erro na inicializa√ß√£o:', erro);
            }
        });
    </script>
}
