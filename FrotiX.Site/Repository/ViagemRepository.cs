/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘ ğŸš€ ARQUIVO: ViagemRepository.cs                                                                    â•‘
   â•‘ ğŸ“‚ CAMINHO: Repository/                                                                            â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ ğŸ¯ OBJETIVO DO ARQUIVO:                                                                            â•‘
   â•‘    RepositÃ³rio para entidade Viagem com operaÃ§Ãµes CRUD e consultas especializadas.                â•‘
   â•‘    Inclui paginaÃ§Ã£o otimizada via ViewViagens e utilitÃ¡rios de correÃ§Ã£o em lote.                   â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ ğŸ“‹ MÃ‰TODOS DISPONÃVEIS:                                                                            â•‘
   â•‘    â€¢ ViagemRepository(FrotiXDbContext db)                                                          â•‘
   â•‘    â€¢ GetViagemListForDropDown()                                                                    â•‘
   â•‘    â€¢ Update(Viagem viagem)                                                                         â•‘
   â•‘    â€¢ GetDistinctOrigensAsync()                                                                     â•‘
   â•‘    â€¢ GetDistinctDestinosAsync()                                                                    â•‘
   â•‘    â€¢ CorrigirOrigemAsync(List<string> origensAntigas, string novaOrigem)                           â•‘
   â•‘    â€¢ CorrigirDestinoAsync(List<string> destinosAntigos, string novoDestino)                        â•‘
   â•‘    â€¢ BuscarViagensRecorrenciaAsync(Guid id)                                                        â•‘
   â•‘    â€¢ GetViagensEventoPaginadoAsync(Guid eventoId, int page, int pageSize)                          â•‘
   â•‘    â€¢ GetQuery(Expression<Func<Viagem, bool>> filter = null)                                        â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ âš ï¸ OBSERVAÃ‡Ã•ES:                                                                                     â•‘
   â•‘    A paginaÃ§Ã£o usa ViewViagens para reduzir JOINs complexos e aplica AsNoTracking.                 â•‘
   â•‘    HÃ¡ logs de performance com Stopwatch e tratamento de erro centralizado.                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/
using FrotiX.Data;
using FrotiX.Models;
using FrotiX.Repository.IRepository;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using NPOI.SS.Formula.Functions;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Threading.Tasks;

namespace FrotiX.Repository
{
    /// <summary>
    /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    /// â”‚ ğŸ¯ CLASSE: ViagemRepository                                                                   â”‚
    /// â”‚ ğŸ“¦ HERDA DE: Repository<Viagem>                                                               â”‚
    /// â”‚ ğŸ”Œ IMPLEMENTA: IViagemRepository                                                              â”‚
    /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    ///
    /// RepositÃ³rio responsÃ¡vel por operaÃ§Ãµes e consultas de viagens.
    /// Disponibiliza listagens, correÃ§Ãµes em lote e paginaÃ§Ã£o otimizada.
    /// </summary>
    public class ViagemRepository : Repository<Viagem>, IViagemRepository
    {
        private new readonly FrotiXDbContext _db;

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: ViagemRepository                                                             â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : UnitOfWork, Services, Controllers                                     â”‚
        /// â”‚    â¡ï¸ CHAMA       : base(db)                                                             â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Inicializar o repositÃ³rio com o contexto do banco de dados.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¥ <b>PARÃ‚METROS:</b><br/>
        ///    db - Contexto do banco de dados da aplicaÃ§Ã£o.
        /// </para>
        /// </summary>
        /// <param name="db">InstÃ¢ncia de <see cref="FrotiXDbContext"/>.</param>
        public ViagemRepository(FrotiXDbContext db) : base(db)
        {
            _db = db;
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: GetViagemListForDropDown                                                     â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Controllers, Services, UI (DropDowns)                                â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbContext.Viagem, OrderBy, Select                                    â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Obter lista de viagens para composiÃ§Ã£o de dropdowns.
        ///    Ordena por data inicial.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¤ <b>RETORNO:</b><br/>
        ///    IEnumerable&lt;SelectListItem&gt; - Itens prontos para seleÃ§Ã£o em UI.
        /// </para>
        /// </summary>
        /// <returns>Lista de itens de seleÃ§Ã£o para viagens.</returns>
        public IEnumerable<SelectListItem> GetViagemListForDropDown()
        {
            return _db.Viagem
                .OrderBy(o => o.DataInicial)
                .Select(i => new SelectListItem()
                {
                    Text = i.Descricao ,
                    Value = i.ViagemId.ToString()
                });
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: Update                                                                        â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Controllers, Services                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : _db.Update, _db.SaveChanges                                           â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Atualizar os dados de uma viagem no banco de dados.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¥ <b>PARÃ‚METROS:</b><br/>
        ///    viagem - Entidade contendo os dados atualizados.
        /// </para>
        /// </summary>
        /// <param name="viagem">Entidade <see cref="Viagem"/> com dados atualizados.</param>
        public new void Update(Viagem viagem)
        {
            _db.Update(viagem);
            _db.SaveChanges();
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: GetDistinctOrigensAsync                                                      â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Services, Controllers                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbContext.Viagem, Where, Select, Distinct, OrderBy, ToListAsync      â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Obter lista de origens distintas das viagens cadastradas.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¤ <b>RETORNO:</b><br/>
        ///    Task&lt;List&lt;string&gt;&gt; - Lista de origens Ãºnicas.
        /// </para>
        /// </summary>
        /// <returns>Lista de origens distintas.</returns>
        public async Task<List<string>> GetDistinctOrigensAsync()
        {
            return await _db.Viagem
                .Where(v => !string.IsNullOrEmpty(v.Origem))
                .Select(v => v.Origem)
                .Distinct()
                .OrderBy(o => o)
                .ToListAsync();
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: GetDistinctDestinosAsync                                                     â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Services, Controllers                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbContext.Viagem, Where, Select, Distinct, OrderBy, ToListAsync      â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Obter lista de destinos distintos das viagens cadastradas.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¤ <b>RETORNO:</b><br/>
        ///    Task&lt;List&lt;string&gt;&gt; - Lista de destinos Ãºnicos.
        /// </para>
        /// </summary>
        /// <returns>Lista de destinos distintos.</returns>
        public async Task<List<string>> GetDistinctDestinosAsync()
        {
            return await _db.Viagem
                .Where(v => !string.IsNullOrEmpty(v.Destino))
                .Select(v => v.Destino)
                .Distinct()
                .OrderBy(d => d)
                .ToListAsync();
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: CorrigirOrigemAsync                                                          â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Services, Controllers                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbContext.Viagem, Where, ToListAsync, SaveChangesAsync               â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Corrigir origens em lote, substituindo por um novo valor.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¥ <b>PARÃ‚METROS:</b><br/>
        ///    origensAntigas - Lista de origens a serem substituÃ­das<br/>
        ///    novaOrigem - Novo valor de origem
        /// </para>
        /// </summary>
        /// <param name="origensAntigas">Lista de origens a corrigir.</param>
        /// <param name="novaOrigem">Novo valor de origem.</param>
        public async Task CorrigirOrigemAsync(List<string> origensAntigas , string novaOrigem)
        {
            var viagens = await _db.Viagem
                .Where(v => origensAntigas.Contains(v.Origem))
                .ToListAsync();

            foreach (var viagem in viagens)
            {
                viagem.Origem = novaOrigem;
            }

            await _db.SaveChangesAsync();
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: CorrigirDestinoAsync                                                         â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Services, Controllers                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbContext.Viagem, Where, ToListAsync, SaveChangesAsync               â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Corrigir destinos em lote, substituindo por um novo valor.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¥ <b>PARÃ‚METROS:</b><br/>
        ///    destinosAntigos - Lista de destinos a serem substituÃ­dos<br/>
        ///    novoDestino - Novo valor de destino
        /// </para>
        /// </summary>
        /// <param name="destinosAntigos">Lista de destinos a corrigir.</param>
        /// <param name="novoDestino">Novo valor de destino.</param>
        public async Task CorrigirDestinoAsync(List<string> destinosAntigos , string novoDestino)
        {
            var viagens = await _db.Viagem
                .Where(v => destinosAntigos.Contains(v.Destino))
                .ToListAsync();

            foreach (var viagem in viagens)
            {
                viagem.Destino = novoDestino;
            }

            await _db.SaveChangesAsync();
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: BuscarViagensRecorrenciaAsync                                                 â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Services, Controllers                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbContext.Viagem.FindAsync, Where, OrderBy, ToListAsync               â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Buscar viagens de recorrÃªncia com base no EventoId.
        ///    Retorna a viagem original quando nÃ£o hÃ¡ recorrÃªncia.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¥ <b>PARÃ‚METROS:</b><br/>
        ///    id - Identificador da viagem base.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¤ <b>RETORNO:</b><br/>
        ///    Task&lt;List&lt;Viagem&gt;&gt; - Lista de viagens relacionadas.
        /// </para>
        /// </summary>
        /// <param name="id">Identificador da viagem base.</param>
        /// <returns>Lista de viagens relacionadas.</returns>
        public async Task<List<Viagem>> BuscarViagensRecorrenciaAsync(Guid id)
        {
            var viagemOriginal = await _db.Viagem.FindAsync(id);
            if (viagemOriginal == null)
                return new List<Viagem>();

            if (viagemOriginal.EventoId.HasValue)
            {
                return await _db.Viagem
                    .Where(v => v.EventoId == viagemOriginal.EventoId.Value)
                    .OrderBy(v => v.DataInicial)
                    .ToListAsync();
            }

            return new List<Viagem> { viagemOriginal };
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: GetViagensEventoPaginadoAsync                                                 â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Services, Controllers                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbContext.Viagem, DbContext.ViewViagens, AsNoTracking, Stopwatch      â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Obter viagens de um evento com paginaÃ§Ã£o otimizada e dados completos da ViewViagens.
        ///    Separa o COUNT da consulta principal para reduzir custo de JOINs.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¥ <b>PARÃ‚METROS:</b><br/>
        ///    eventoId - Identificador do evento<br/>
        ///    page - PÃ¡gina atual (1-based)<br/>
        ///    pageSize - Quantidade de registros por pÃ¡gina
        /// </para>
        ///
        /// <para>
        /// ğŸ“¤ <b>RETORNO:</b><br/>
        ///    Task&lt;(List&lt;ViagemEventoDto&gt; viagens, int totalItems)&gt; - Lista paginada e total.
        /// </para>
        /// </summary>
        /// <param name="eventoId">Identificador do evento.</param>
        /// <param name="page">PÃ¡gina atual (1-based).</param>
        /// <param name="pageSize">Tamanho da pÃ¡gina.</param>
        /// <returns>Lista de viagens e total de itens.</returns>
        public async Task<(List<ViagemEventoDto> viagens, int totalItems)> GetViagensEventoPaginadoAsync(
            Guid eventoId ,
            int page ,
            int pageSize
        )
        {
            try
            {
                var swTotal = System.Diagnostics.Stopwatch.StartNew();
                var swCount = System.Diagnostics.Stopwatch.StartNew();

                // COUNT otimizado na tabela Viagem
                var totalItems = await _db.Viagem
                    .Where(v => v.EventoId == eventoId && v.Status == "Realizada")
                    .CountAsync();

                swCount.Stop();
                Console.WriteLine($"[SQL COUNT] {totalItems} registros - {swCount.ElapsedMilliseconds}ms");

                if (totalItems == 0)
                {
                    return (new List<ViagemEventoDto>(), 0);
                }

                var swQuery = System.Diagnostics.Stopwatch.StartNew();

                // Buscar IDs das viagens paginadas
                var viagemIds = await _db.Viagem
                    .Where(v => v.EventoId == eventoId && v.Status == "Realizada")
                    .OrderByDescending(v => v.DataInicial)
                    .ThenByDescending(v => v.HoraInicio)
                    .Skip((page - 1) * pageSize)
                    .Take(pageSize)
                    .Select(v => v.ViagemId)
                    .ToListAsync();

                // Buscar dados completos da ViewViagens apenas para os IDs paginados
                var viagens = await _db.ViewViagens
                    .Where(vv => viagemIds.Contains(vv.ViagemId))
                    .Select(vv => new ViagemEventoDto
                    {
                        ViagemId = vv.ViagemId , // âœ… ADICIONADO!
                        EventoId = vv.EventoId ?? Guid.Empty ,
                        NoFichaVistoria = vv.NoFichaVistoria ?? 0 ,
                        NomeRequisitante = vv.NomeRequisitante ?? "" ,
                        NomeSetor = vv.NomeSetor ?? "" ,
                        NomeMotorista = vv.NomeMotorista ?? "" ,
                        DescricaoVeiculo = vv.DescricaoVeiculo ?? "" ,
                        CustoViagem = (decimal)(vv.CustoViagem ?? 0) ,
                        DataInicial = vv.DataInicial ?? DateTime.MinValue ,
                        HoraInicio = vv.HoraInicio ,
                        Placa = vv.Placa ?? ""
                    })
                    .AsNoTracking()
                    .ToListAsync();

                // Reordenar no lado do cliente (jÃ¡ sÃ£o poucos registros)
                viagens = viagens
                    .OrderByDescending(v => v.DataInicial)
                    .ThenByDescending(v => v.HoraInicio)
                    .ToList();

                swQuery.Stop();
                Console.WriteLine($"[SQL QUERY] {viagens.Count} registros - {swQuery.ElapsedMilliseconds}ms");

                swTotal.Stop();
                Console.WriteLine($"[TOTAL] {swTotal.ElapsedMilliseconds}ms\n");

                return (viagens, totalItems);
            }
            catch (Exception error)
            {
                Console.WriteLine($"[ERRO SQL] {error.Message}");
                Alerta.TratamentoErroComLinha("ViagemRepository.cs" , "GetViagensEventoPaginadoAsync" , error);
                throw;
            }
        }

        /// <summary>
        /// â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        /// â”‚ âš¡ MÃ‰TODO: GetQuery                                                                     â”‚
        /// â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        /// â”‚    â¬…ï¸ CHAMADO POR : Services, Controllers                                                 â”‚
        /// â”‚    â¡ï¸ CHAMA       : DbSet.Where                                                          â”‚
        /// â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        ///
        /// <para>
        /// ğŸ¯ <b>OBJETIVO:</b><br/>
        ///    Retornar IQueryable para composiÃ§Ã£o de queries sem materializaÃ§Ã£o.
        ///    Ãštil para Count(), Min(), Max(), etc.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¥ <b>PARÃ‚METROS:</b><br/>
        ///    filter - Filtro opcional para composiÃ§Ã£o da consulta.
        /// </para>
        ///
        /// <para>
        /// ğŸ“¤ <b>RETORNO:</b><br/>
        ///    IQueryable&lt;Viagem&gt; - Consulta base para composiÃ§Ã£o posterior.
        /// </para>
        /// </summary>
        /// <param name="filter">Filtro opcional.</param>
        /// <returns>Consulta base para composiÃ§Ã£o.</returns>
        public IQueryable<Viagem> GetQuery(Expression<Func<Viagem , bool>> filter = null)
        {
            IQueryable<Viagem> query = dbSet;

            if (filter != null)
            {
                query = query.Where(filter);
            }

            return query;
        }
    }
}
