# Log de Conversa - Correção de Erros no Dashboard de Abastecimento

**Data:** 15/01/2026
**Hora Início:** 04:52
**Hora Término:** 06:30
**Objetivo:** Corrigir erros identificados no Dashboard de Abastecimento.

---

## Resumo Executivo

Corrigidos quatro problemas no Dashboard de Abastecimento:

### Problema 1: Erro CLDR (percentSign)
Gráficos Syncfusion EJ2 Charts falhavam ao renderizar devido à ausência de dados CLDR para formatação de números em pt-BR.

**Erro:** `TypeError: Cannot read properties of undefined (reading 'percentSign')`

**Solução:** Carregamento síncrono de dados CLDR no início do arquivo `dashboard-abastecimento.js`.

### Problema 2: Erro 400 nas abas Mensal e Veículo
Ao clicar nas abas "Consumo Mensal" ou "Consumo por Veículo", a API retornava erro 400 porque o parâmetro `ano` era enviado vazio.

**Erro:** `GET /api/abastecimento/DashboardMensal?ano=&mes= 400 (Bad Request)`

**Solução:** Seleção automática do **ano mais recente** E do **mês mais recente** com registros quando o usuário acessa as abas pela primeira vez.

### Problema 3: Anos/Meses sem dados aparecendo nas listas
As listas de anos e meses mostravam opções sem registros de abastecimento (ex: 2026 aparecia mas não tinha dados).

**Causa:** API retornava todos os anos/meses da tabela de estatísticas sem filtrar por `ValorTotal > 0`.

**Solução:** Filtrar no backend para retornar apenas anos e meses COM registros.

### Problema 4: Tabela "Resumo Por Ano" mostrava anos vazios
A tabela de resumo mostrava anos sem registros (ex: 2026 com valor R$ 0).

**Solução:** Adicionar filtro `.Where(r => r.valor > 0)` na query de `resumoPorAno`.

### Problema 5: Falta de feedback quando não há dados
Quando uma consulta não retornava registros, o usuário não era informado.

**Solução:** Adicionar Toast warning (laranja) quando `valorTotal === 0`.

---

## Problema Identificado

### Sintomas
- Ao carregar a página `/Abastecimento/DashboardAbastecimento`, múltiplos erros eram exibidos
- Os gráficos não renderizavam corretamente
- Erros em 4 funções de renderização de gráficos:
  - `renderizarChartValorCategoria`
  - `renderizarChartValorLitro`
  - `renderizarChartLitrosMes`
  - `renderizarChartConsumoMes`

### Causa Raiz
O Syncfusion EJ2 Charts carregado via CDN (`ej2-base.min.js`, `ej2-charts.min.js`) precisa de dados CLDR para formatar números. A função `loadSyncfusionLocalization()` no `_Layout.cshtml` carrega esses dados de forma assíncrona, mas os scripts do Dashboard executavam antes dos dados CLDR estarem disponíveis.

### Stack Trace Completo
```
TypeError: Cannot read properties of undefined (reading 'percentSign')
at t.numberFormatter (ej2-base.min.js)
at t.getNumberFormat (ej2-base.min.js)
at e.calculateVisibleLabels (ej2-charts.min.js)
at e.calculateRangeAndInterval (ej2-charts.min.js)
at e.measureDefinition (ej2-charts.min.js)
at e.measureColumnAxis/measureRowAxis (ej2-charts.min.js)
at e.measureAxis (ej2-charts.min.js)
at o.calculateBounds (ej2-charts.min.js)
at o.refreshBound (ej2-charts.min.js)
at o.processData (ej2-charts.min.js)
```

---

## Solução Implementada

### Arquivo Modificado - JavaScript
- `wwwroot/js/dashboards/dashboard-abastecimento.js`

### Alteração 1: CLDR Síncrono
Adicionado bloco de inicialização CLDR **síncrona** no início do arquivo (IIFE - Immediately Invoked Function Expression):

```javascript
// ====== CONFIGURAÇÃO CLDR PARA SYNCFUSION CHARTS ======
// Carrega dados CLDR de forma síncrona para evitar erro "percentSign undefined"
(function initCldrForCharts() {
    try {
        if (typeof ej !== 'undefined' && ej.base) {
            // Dados CLDR mínimos para pt-BR
            const numberingSystemsData = { ... };
            const numbersData = { ... };
            const currenciesData = { ... };

            ej.base.loadCldr(numberingSystemsData, numbersData, currenciesData);
            ej.base.setCulture('pt-BR');
            ej.base.setCurrencyCode('BRL');
            console.log('✅ CLDR pt-BR carregado de forma síncrona');
        }
    } catch (e) {
        console.warn('⚠️ Erro ao carregar CLDR para charts:', e);
    }
})();
```

### Alteração 2: Toast Warning para Consultas Vazias
Adicionado nas funções `executarCarregamentoMensal` e `executarCarregamentoVeiculo`:

```javascript
// Verificar se a consulta retornou dados
if (!data || data.valorTotal === 0 || data.valorTotal === null) {
    const nomesMeses = ['', 'Janeiro', 'Fevereiro', ...];
    const periodo = mes ? nomesMeses[parseInt(mes)] + '/' + ano : ano;
    AppToast.show('orange', 'Não há registros de abastecimento para ' + periodo, 5000);
}
```

### Arquivo Modificado - Controller
- `Controllers/AbastecimentoController.DashboardAPI.cs`

### Alteração 3: Filtrar Anos Disponíveis
```csharp
// ANTES:
var anosDisponiveis = _context.AnosDisponiveisAbastecimento
    .OrderByDescending(a => a.Ano)
    .Select(a => a.Ano)
    .ToList();

// DEPOIS:
var anosDisponiveis = _context.EstatisticaAbastecimentoMensal
    .Where(e => e.ValorTotal > 0)
    .GroupBy(e => e.Ano)
    .Select(g => g.Key)
    .OrderByDescending(a => a)
    .ToList();
```

### Alteração 4: Filtrar Resumo Por Ano
```csharp
// ANTES:
var resumoPorAno = _context.EstatisticaAbastecimentoMensal
    .GroupBy(e => e.Ano)
    .Select(g => new { ano = g.Key, valor = g.Sum(...), litros = g.Sum(...) })
    .OrderBy(r => r.ano)
    .ToList();

// DEPOIS:
var resumoPorAno = _context.EstatisticaAbastecimentoMensal
    .GroupBy(e => e.Ano)
    .Select(g => new { ano = g.Key, valor = g.Sum(...), litros = g.Sum(...) })
    .Where(r => r.valor > 0) // ← ADICIONADO
    .OrderBy(r => r.ano)
    .ToList();
```

### Alteração 5: Filtrar Meses Disponíveis
```csharp
// ANTES:
var mesesEstatisticos = _context.EstatisticaAbastecimentoMensal
    .Where(e => e.Ano == ano)
    .Select(e => e.Mes)
    .Distinct()
    .OrderBy(m => m)
    .ToList();

// DEPOIS:
var mesesEstatisticos = _context.EstatisticaAbastecimentoMensal
    .Where(e => e.Ano == ano && e.ValorTotal > 0) // ← ADICIONADO filtro
    .Select(e => e.Mes)
    .Distinct()
    .OrderBy(m => m)
    .ToList();
```

---

## Arquivos Alterados

| Arquivo | Ação | Descrição |
|---------|------|-----------|
| `wwwroot/js/dashboards/dashboard-abastecimento.js` | Modificado | Linhas 7-77: Bloco CLDR síncrono |
| `wwwroot/js/dashboards/dashboard-abastecimento.js` | Modificado | Função `carregarDadosMensais`: Auto-seleção de ano e mês |
| `wwwroot/js/dashboards/dashboard-abastecimento.js` | Modificado | Função `carregarDadosVeiculo`: Auto-seleção de ano e mês |
| `wwwroot/js/dashboards/dashboard-abastecimento.js` | Criada | Função `executarCarregamentoMensal`: Execução + Toast warning |
| `wwwroot/js/dashboards/dashboard-abastecimento.js` | Criada | Função `executarCarregamentoVeiculo`: Execução + Toast warning |
| `wwwroot/js/dashboards/dashboard-abastecimento.js` | Criada | Função `popularMesesDoAnoECarregar`: Popular meses e carregar dados |
| `Controllers/AbastecimentoController.DashboardAPI.cs` | Modificado | Linha 33: Filtrar anos com `ValorTotal > 0` |
| `Controllers/AbastecimentoController.DashboardAPI.cs` | Modificado | Linha 71: Filtrar resumoPorAno com `valor > 0` |
| `Controllers/AbastecimentoController.DashboardAPI.cs` | Modificado | Linha 1509: Filtrar meses com `ValorTotal > 0` |
| `Conversas/2026.01.15 - Correcao Erros Dashboard Abastecimento.md` | Atualizado | Registro da conversa |

---

## Decisões Técnicas

1. **Por que carregamento síncrono?**
   - O carregamento assíncrono via `loadSyncfusionLocalization()` não garante ordem de execução
   - Scripts do CDN no `ScriptsBlock` executam antes do `DOMContentLoaded` do Layout

2. **Por que dados inline em vez de fetch?**
   - Evita race condition com carregamento assíncrono
   - Dados CLDR mínimos são pequenos (~1KB)
   - Garante disponibilidade imediata antes de qualquer gráfico

3. **Por que não modificar o Layout?**
   - Alteração localizada no arquivo do Dashboard é mais segura
   - Não afeta outras páginas que podem ter ordem diferente de carregamento

4. **Por que filtrar por ValorTotal > 0 no backend?**
   - A tabela de estatísticas pode ter registros com valor 0 (meses/anos sem abastecimentos reais)
   - Filtrar no backend evita processar dados desnecessários
   - Garante que os dropdowns só mostrem opções válidas

5. **Por que usar Toast laranja para dados vazios?**
   - Laranja (orange) indica aviso, não erro
   - Informa o usuário sem assustar
   - Segue padrão visual do sistema FrotiX

---

## Testes Recomendados

1. Acessar `/Abastecimento/DashboardAbastecimento`
2. Verificar console para mensagem: `✅ CLDR pt-BR carregado de forma síncrona`
3. Confirmar que gráficos renderizam sem erros na aba "Consumo Geral"
4. **Verificar que lista de anos NÃO contém 2026** (ou outros anos sem dados)
5. **Verificar que "Resumo Por Ano" NÃO mostra anos com valor R$ 0**
6. Clicar na aba "Consumo Mensal" - deve selecionar ano 2025 e mês Novembro automaticamente
7. Clicar na aba "Consumo por Veículo" - deve selecionar ano 2025 e mês Novembro automaticamente
8. **Verificar lista de meses** - deve mostrar apenas meses com registros (não Dezembro se não houver dados)
9. Verificar formatação de valores (R$ X.XXX,XX)
10. **Testar consulta sem dados** - deve aparecer Toast laranja

---

## Observações

- Os diagnósticos do IDE sobre variáveis não usadas (`xhr`, `status`, `idx`) são hints pré-existentes, não relacionados a esta correção
- A solução é defensiva: se `ej.base` não existir, a execução continua normalmente
- A seleção automática pega o ano mais recente (primeiro da lista) e o mês mais recente (último da lista de meses disponíveis)
- O filtro `ValorTotal > 0` é aplicado na tabela `EstatisticaAbastecimentoMensal` que é mais confiável que `AnosDisponiveisAbastecimento`

---

## Tarefas Pendentes

- [x] Corrigir erro CLDR percentSign
- [x] Corrigir erro 400 na aba Consumo Mensal
- [x] Corrigir erro 400 na aba Consumo por Veículo
- [x] Filtrar anos disponíveis (apenas anos com dados)
- [x] Filtrar meses disponíveis (apenas meses com dados)
- [x] Filtrar "Resumo Por Ano" (excluir anos vazios)
- [x] Adicionar Toast warning para consultas sem dados
- [ ] Testar as correções no ambiente de desenvolvimento

---

**Última atualização**: 15/01/2026 06:30
**Responsável**: Claude Code
