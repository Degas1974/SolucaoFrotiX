# Confer√™ncia do Banco de Dados

## Resumo Executivo

Sessao iniciada com registro ativo confirmado. Preparacao para gerar DDL a partir
dos modelos do FrotiX.Site.OLD e consolidar script unico de producao, seguindo as
regras do projeto e FrotiX.sql como referencia.

---

## ‚è±Ô∏è Informa√ß√µes da Sess√£o

| ‚è±Ô∏è Tempo | üìã Detalhes |
|----------|-------------|
| **In√≠cio** | 2026-02-11 06:43:02 |
| **T√©rmino** | (em andamento) |
| **Dura√ß√£o** | (em andamento) |
| **IA** | Genie AI |
| **Continua√ß√£o de** | Conversa nova |

---

## üìÅ Arquivos Alterados

| A√ß√£o | Arquivo | Motivo |
|------|---------|--------|
| ‚úèÔ∏è Modificado | `FrotiX.Site.OLD/Conversas/[2026.02.11]-[06.43] - [Confer√™ncia do Banco de Dados] - [Genie AI].md` | Registro incremental da sess√£o iniciado |
| ‚úèÔ∏è Modificado | `FrotiX.Site.OLD/FrotiX.sql` | Adicionado DDL para tabelas e views faltantes a partir dos modelos |
| ‚úèÔ∏è Modificado | `script.sql` | Script unico de producao/dev para criar tabelas e views faltantes |
| ‚úèÔ∏è Modificado | `FrotiX.Site.OLD/Pages/Viagens/Upsert.cshtml` | Revertido alteracoes nao relacionadas do commit anterior |
| ‚úèÔ∏è Modificado | `FrotiX.Site.OLD/wwwroot/js/cadastros/ViagemUpsert.js` | Revertido alteracoes nao relacionadas do commit anterior |
| ‚úèÔ∏è Modificado | `FrotiX.Site.OLD/wwwroot/js/cadastros/agendamento_viagem.js` | Revertido alteracoes nao relacionadas do commit anterior |
| ‚ûï Criado | `_gen_model_schema_check.py` | Artefato de apoio da analise de schema |
| ‚ûï Criado | `_schema_check_db_extra_columns.sql` | Script auxiliar de comparacao de colunas |
| ‚ûï Criado | `_schema_check_extra_objects.sql` | Script auxiliar de objetos extras no banco |
| ‚ûï Criado | `_schema_check_missing_objects.sql` | Script auxiliar de objetos faltantes no banco |
| ‚ûï Criado | `_schema_check_model_extra_columns.sql` | Script auxiliar de colunas extras nos modelos |
| ‚ûï Criado | `_tmp_model_schema_check.py` | Script temporario de verificacao de schema |
| ‚ûï Criado | `_tmp_model_schema_check.sql` | Script temporario de verificacao de schema |
| ‚ûï Criado | `_tmp_model_schema_check_filtered.sql` | Script temporario filtrado |
| ‚ûï Criado | `_tmp_model_schema_check_filtered_fixed.sql` | Script temporario filtrado (fix) |
| ‚ûï Criado | `_tmp_model_schema_check_filtered_fixed_views.sql` | Script temporario filtrado (views) |
| ‚ûï Criado | `_tmp_model_schema_check_filtered_fixed_views_all.sql` | Script temporario filtrado (views all) |
| ‚ûï Criado | `logs/audit.jsonl` | Log auxiliar da analise |
| ‚ûï Criado | `schema_check_db_extra_columns.csv` | Export de colunas extras no banco |
| ‚ûï Criado | `schema_check_extra_objects.csv` | Export de objetos extras no banco |
| ‚ûï Criado | `schema_check_missing_objects.csv` | Export de objetos faltantes no banco |
| ‚ûï Criado | `schema_check_model_extra_columns.csv` | Export de colunas extras nos modelos |

**Legenda:** ‚ûï Criado | ‚úèÔ∏è Modificado | üóëÔ∏è Removido

---

## üêõ Problemas Encontrados e Solu√ß√µes

| # | Problema | Causa Raiz | Solu√ß√£o | Li√ß√£o Aprendida |
|---|---------|------------|---------|-----------------|
| 1 | (nenhum) | (nenhum) | (nenhum) | Nenhum problema encontrado nesta sess√£o |

---

## üîß Decis√µes T√©cnicas

### 1. Gerar views a partir dos modelos
| Aspecto | Detalhe |
|---------|---------|
| **Decis√£o** | Criar definicoes SQL para views faltantes a partir do nome/props dos modelos e joins esperados |
| **Justificativa** | Nao ha definicoes SQL dessas views no repositorio; seguir instrucao de gerar a partir dos modelos |
| **Alternativas** | Aguardar SQL oficial do banco; gerar views placeholder apenas com NULLs |
| **Impacto** | Views criadas com logica inferida; revisar se necessario no banco de producao |

### 2. Manter artefatos auxiliares no commit
| Aspecto | Detalhe |
|---------|---------|
| **Decis√£o** | Manter scripts e CSVs auxiliares no commit conforme instrucao do usuario |
| **Justificativa** | Preservar evidencias da auditoria e insumos de comparacao |
| **Alternativas** | Remover artefatos e manter apenas DDLs principais |
| **Impacto** | Repositorio passa a conter arquivos de apoio da analise |

### 3. Adicionar rollback ao schema sync
| Aspecto | Detalhe |
|---------|---------|
| **Decis√£o** | Incluir rollback manual para desfazer views, FKs, indexes/stats e tabelas criadas no schema sync |
| **Justificativa** | Permitir reversao rapida caso o patch precise ser desfeito em producao |
| **Alternativas** | Manter rollback apenas para o trecho antigo de flags de viagem |
| **Impacto** | script.sql passa a ter rollback abrangente para o bloco de schema sync |

### 4. Validacao de dados antes do drop
| Aspecto | Detalhe |
|---------|---------|
| **Decis√£o** | Bloquear o rollback se houver dados nas tabelas do schema sync |
| **Justificativa** | Evitar perda de dados inadvertida ao executar rollback manual |
| **Alternativas** | Manter rollback com drops diretos sem validacao |
| **Impacto** | Rollback falha com erro claro quando alguma tabela tem registros |

### 5. Guardas para backfill e indice de URL
| Aspecto | Detalhe |
|---------|---------|
| **Decis√£o** | Proteger backfill quando colunas legadas nao existirem e substituir indice por hash de URL |
| **Justificativa** | Evitar erro 207 em bancos onde colunas ja foram removidas e contornar limite de 1700 bytes do indice |
| **Alternativas** | Manter UPDATE sem guardas e indice direto em Url | 
| **Impacto** | Backfill nao falha sem colunas legadas e indice passa a usar UrlHash |

### 6. Reverter arquivos nao relacionados
| Aspecto | Detalhe |
|---------|---------|
| **Decis√£o** | Reverter alteracoes em arquivos fora do escopo do script.sql |
| **Justificativa** | Evitar misturar mudancas nao revisadas no mesmo commit |
| **Alternativas** | Manter os arquivos alterados no commit | 
| **Impacto** | Arquivos retornam ao estado anterior ao commit 7082a44c |

---

## üìã Tarefas Pendentes

- [x] Gerar DDL a partir dos modelos C# (tabelas e views)
- [x] Atualizar FrotiX.sql com as alteracoes validadas
- [x] Consolidar script.sql unico para producao
- [x] Adicionar rollback manual para schema sync no script.sql

---

## üîÑ Continuidade

| Item | Detalhe |
|------|---------|
| **Pr√≥ximos Passos** | (preencher ao finalizar) |
| **Contexto Necess√°rio** | (preencher ao finalizar) |
| **Arquivos-Chave** | (preencher ao finalizar) |
| **Riscos/Alertas** | (preencher ao finalizar) |

---

## ‚úÖ Status Final

‚è≥ **CONVERSA EM ANDAMENTO**

---

*Conversa iniciada em: 2026-02-11 06:43:02*
