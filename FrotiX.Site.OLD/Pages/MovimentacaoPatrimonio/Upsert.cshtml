@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/MovimentacaoPatrimonio/Upsert.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio criar/editar movimenta√ß√£o de patrim√¥nio (origem readonly, destino edit√°vel)
 * üì• ENTRADAS     : @page, @model UpsertModel, campos: cmbPatrimonio, dataMov, StatusCheckbox, SetorOrigem (readonly), cmbSetorDestino, cmbSecoesDestino
 * üì§ SA√çDAS       : POST /api/Patrimonio/CreateMovimentacao ou UpdateMovimentacao, redirect para Index, AppToast feedback
 * üîó CHAMADA POR  : Index.cshtml (bot√£o "Inserir Movimenta√ß√£o", edi√ß√£o via API), menu navega√ß√£o
 * üîÑ CHAMA        : /api/Patrimonio/GetMovimentacao (edi√ß√£o), /api/Patrimonio/CreateMovimentacao, /api/Patrimonio/UpdateMovimentacao, ~/js/cadastros/movimentacaopatrimonio.js
 * üì¶ DEPEND√äNCIAS : Syncfusion.EJ2 (ComboBox, DatePicker, Checkbox), Bootstrap 5.3.8 (CDN redundante), Font Awesome Duotone
 * üìù OBSERVA√á√ïES  : Total: 532 linhas. PROBLEMA: Bootstrap CDN redundante (j√° no layout), CSS inline grande (142 linhas) - pode ser extra√≠do, JavaScript inline extenso (300+ linhas) - deveria estar no movimentacaopatrimonio.js, DUPLICA√á√ÉO: Fun√ß√µes carregarDadosMovimentacao e salvarMovimentacao inline quando deveriam estar no JS externo, BUG POTENCIAL: Valida√ß√£o "se√ß√£o destino == se√ß√£o origem" n√£o considera setor (linha 456), Hidden fields: MovimentacaoPatrimonioId, SetorOrigemId, SecaoOrigemId, PatrimonioId - correto
 **************************************************************************************** *@
@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Syncfusion.EJ2

@model FrotiX.Pages.MovimentacaoPatrimonio.UpsertModel

@{
    ViewData["Title"] = "Movimenta√ß√£o de Patrim√¥nio";
    ViewData["PageName"] = "movimentacaopatrimonio_upsert";
    ViewData["Heading"] = "<i class='fa-duotone fa-conveyor-belt-boxes'></i> Cadastros: <span class='fw-300'>Movimenta√ß√£o de Patrim√¥nio</span>";
    ViewData["Category1"] = "Movimenta√ß√µes";
    ViewData["PageIcon"] = "fa-conveyor-belt-boxes";
}

<style>
    :root {
        --ctrl-h: 40px;
        --ctrl-pad-y: .375rem;
        --ctrl-pad-x: .75rem;
        --ctrl-radius: .25rem;
        --accent-orange-dark: #C24E00;
    }

    .control-height,
    .form-control {
        height: var(--ctrl-h) !important;
        padding: var(--ctrl-pad-y) var(--ctrl-pad-x) !important;
        font-size: 1rem !important;
        line-height: 1.5 !important;
        border-radius: var(--ctrl-radius) !important;
    }

    .e-control-wrapper.e-input-group,
    .e-input-group.e-control-wrapper {
        height: var(--ctrl-h) !important;
        border-radius: var(--ctrl-radius) !important;
        background-color: #fff !important;
        border: 1px solid #ced4da !important;
    }

        .e-control-wrapper.e-input-group input.e-input {
            height: calc(var(--ctrl-h) - 2px) !important;
            line-height: calc(var(--ctrl-h) - 2px) !important;
            padding: var(--ctrl-pad-y) var(--ctrl-pad-x) !important;
            font-size: 1rem !important;
            background: transparent !important;
            border: none !important;
        }

    .e-input-group-icon,
    .e-clear-icon,
    .e-ddl-icon {
        height: calc(var(--ctrl-h) - 2px) !important;
        line-height: calc(var(--ctrl-h) - 2px) !important;
        min-height: calc(var(--ctrl-h) - 2px) !important;
    }

    .e-control-wrapper.e-input-focus,
    .e-input-group.e-control-wrapper.e-input-focus {
        border-color: #80bdff !important;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25) !important;
    }

    .e-input-group::before,
    .e-input-group::after {
        display: none !important;
    }

    .section-legend {
        display: flex;
        align-items: center;
        gap: .5rem;
        margin: 0 0 .5rem 0;
        font-weight: 700;
        font-size: 1.05rem;
    }

        .section-legend .legend-note {
            font-weight: 500;
            font-size: .9rem;
            color: #6c757d;
        }

    .label {
        margin-bottom: .25rem;
        margin-top: .25rem;
        font-weight: 600;
    }

    input[type=checkbox] {
        vertical-align: middle;
        position: relative;
        bottom: 1px;
    }

    .escondido {
        display: none;
    }

    .espacofundo {
        padding-bottom: 20px;
    }

    .status-switch {
        margin-top: 32px;
    }

    .page-header {
        border-bottom: 1px solid #325d88;
    }

    .section-legend.text-orange-dark {
        color: var(--accent-orange-dark) !important;
    }

        .section-legend.text-orange-dark .fa-duotone {
            --fa-primary-color: var(--accent-orange-dark);
            --fa-secondary-color: var(--accent-orange-dark);
        }
</style>

<form id="formsMovimentacaoPatrimonio">
    <div class="row espacofundo">
        <div class="col-xl-12">
            <div id="panel-1" class="panel">
                <div id="painelfundo" class="panel-container show espacofundo">
                    <div class="panel-content">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <!-- IDs Hidden -->
                        <input type="hidden" id="MovimentacaoPatrimonioId"
                               value="@(Model.MovimentacaoPatrimonioObj?.MovimentacaoPatrimonio?.MovimentacaoPatrimonioId ?? Guid.Empty)" />
                        <input type="hidden" id="SetorOrigemId" value="" />
                        <input type="hidden" id="SecaoOrigemId" value="" />
                        <input type="hidden" id="PatrimonioId" value="" />

                        <!-- Cabe√ßalho -->
                        <div class="col-12 px-3 page-header">
                            <h2 class="titulo-pagina my-2">
                                <i class="fa-duotone fa-exchange"></i>
                                &nbsp;<span id="tituloFormulario">Nova Movimenta√ß√£o de Patrim√¥nio</span>
                            </h2>
                        </div>

                        <div class="col-12 pt-3">
                            <!-- Linha 1: Patrim√¥nio, Data e Status -->
                            <div class="row mb-3">
                                <div class="col-12 col-md-6">
                                    <div class="form-group">
                                        <label class="label" for="cmbPatrimonio">Patrim√¥nio *</label>
                                        <input id="cmbPatrimonio" style="width: 100%;" />
                                    </div>
                                </div>

                                <div class="col-12 col-md-4">
                                    <div class="form-group">
                                        <label class="label" for="dataMov">Data da Movimenta√ß√£o *</label>
                                        <input id="dataMov" name="DataMovimentacao" style="width: 100%;" />
                                    </div>
                                </div>

                                <div class="col-12 col-md-2">
                                    <div class="status-switch">
                                        <label for="StatusCheckbox" class="status-title me-2">Status:</label>
                                        <ejs-checkbox id="StatusCheckbox"
                                                      name="StatusCheckbox"
                                                      change="onEJ2CheckboxChange">
                                        </ejs-checkbox>
                                        <label id="StatusCheckboxLabel"
                                               class="status-label ms-2"
                                               for="StatusCheckbox"></label>
                                    </div>
                                </div>
                            </div>

                            <!-- Linha 2: ORIGEM (somente leitura) -->
                            <fieldset class="mb-3">
                                <legend class="section-legend text-orange-dark">
                                    <i class="fa-duotone fa-location-dot"></i>
                                    Origem <span class="legend-note">onde est√°</span>
                                </legend>
                                <div class="row">
                                    <div class="col-12 col-md-6">
                                        <div class="form-group">
                                            <label class="label" for="SetorOrigem">Setor (Origem)</label>
                                            <input id="SetorOrigem"
                                                   type="text"
                                                   class="form-control control-height"
                                                   disabled
                                                   readonly />
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <div class="form-group">
                                            <label class="label" for="SecaoOrigem">Se√ß√£o (Origem)</label>
                                            <input id="SecaoOrigem"
                                                   type="text"
                                                   class="form-control control-height"
                                                   disabled
                                                   readonly />
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Linha 3: DESTINO -->
                            <fieldset class="mb-4">
                                <legend class="section-legend text-orange-dark">
                                    <i class="fa-duotone fa-arrow-right-arrow-left"></i>
                                    Destino <span class="legend-note">para onde vai</span>
                                </legend>
                                <div class="row">
                                    <div class="col-12 col-md-6">
                                        <div class="form-group">
                                            <label class="label" for="cmbSetorDestino">Setor (Destino) *</label>
                                            <input id="cmbSetorDestino" style="width: 100%;" />
                                        </div>
                                    </div>

                                    <div class="col-12 col-md-6" id="divSecaoDestino">
                                        <div class="form-group">
                                            <label class="label" for="cmbSecoesDestino">Se√ß√£o (Destino) *</label>
                                            <input id="cmbSecoesDestino" style="width: 100%;" />
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="form-group row">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-8">
                                            <button type="button"
                                                    id="btnSalvar"
                                                    class="btn btn-azul btn-submit-spin form-control me-4"
                                                    style="max-width:300px; display:inline-block"
                                                    data-ejtip="Salvar a movimenta√ß√£o de patrim√¥nio">
                                                <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>&nbsp;&nbsp;
                                                <span id="textoBotaoSalvar">Criar Movimenta√ß√£o</span>
                                            </button>

                                            <a asp-page="./Index"
                                               class="btn btn-ftx-fechar form-control"
                                               style="max-width:300px; display:inline-block"
                                               data-ftx-loading>
                                                <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar Opera√ß√£o
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section ScriptsBlock {

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script src="~/js/cadastros/movimentacaopatrimonio.js" asp-append-version="true"></script>

    <script>
    (function () {
        try {
            $("#cmbPatrimonio").kendoComboBox({
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "Selecione o Patrim\u00f4nio",
                filter: "contains",
                height: 200
            });

            $("#cmbSetorDestino").kendoComboBox({
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "Selecione o Setor de Destino",
                filter: "contains",
                height: 200
            });

            $("#cmbSecoesDestino").kendoComboBox({
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "Primeiro selecione o Setor de Destino",
                filter: "contains",
                height: 200
            });

            // ================================================================
            // KENDO DATEPICKER INIT - Migrado de Syncfusion ejs-datepicker
            // ================================================================

            $("#dataMov").kendoDatePicker({
                format: "dd/MM/yyyy",
                culture: "pt-BR",
                dateInput: { format: "dd/MM/yyyy", messages: { year: "yyyy", month: "MM", day: "dd" } },
                placeholder: "dd/mm/aaaa"
            });
        } catch (error) {
            Alerta.TratamentoErroComLinha("MovimentacaoPatrimonio/Upsert.cshtml", "kendoControls.init", error);
        }
    })();
    </script>

    <script>
        $(document).ready(function () {
            try {
                // Verificar se √© edi√ß√£o
                var movimentacaoId = $('#MovimentacaoPatrimonioId').val();
                var isEdicao = movimentacaoId && movimentacaoId !== '00000000-0000-0000-0000-000000000000';

                if (isEdicao) {
                    $('#tituloFormulario').text('Atualizar Movimenta√ß√£o');
                    $('#textoBotaoSalvar').text('Atualizar Movimenta√ß√£o');
                    carregarDadosMovimentacao(movimentacaoId);
                }

                // Handler do bot√£o salvar
                $('#btnSalvar').on('click', function (e) {
                    try {
                        e.preventDefault();
                        salvarMovimentacao();
                    }
                    catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnSalvar.click", error);
                    }
                });

                // Prevenir submit com Enter
                $('#formsMovimentacaoPatrimonio').on('keypress', function (e) {
                    try {
                        if (e.key === 'Enter' || e.keyCode === 13) {
                            var src = e.target || e.srcElement;
                            if (src.tagName.toLowerCase() !== 'textarea' && src.tagName.toLowerCase() !== 'button') {
                                e.preventDefault();
                                return false;
                            }
                        }
                    }
                    catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "formsMovimentacaoPatrimonio.keypress", error);
                    }
                });
            }
            catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "document.ready", error);
            }
        });

        function carregarDadosMovimentacao(id) {
            try {
                $.ajax({
                    url: '/api/Patrimonio/GetMovimentacao',
                    type: 'GET',
                    data: { id: id },
                    success: function (res) {
                        try {
                            if (res && res.success) {
                                var data = res.data;

                                // Preencher campos hidden
                                $('#SetorOrigemId').val(data.setorOrigemId || '');
                                $('#SecaoOrigemId').val(data.secaoOrigemId || '');
                                $('#PatrimonioId').val(data.patrimonioId || '');

                                // Preencher campos visuais
                                $('#SetorOrigem').val(data.setorOrigemNome || '');
                                $('#SecaoOrigem').val(data.secaoOrigemNome || '');

                                // Atualizar combos EJ2
                                setTimeout(function () {
                                    try {
                                        var cmbPatrimonio = $("#cmbPatrimonio").data("kendoComboBox");
                                        if (cmbPatrimonio) cmbPatrimonio.value(data.patrimonioId || "");

                                        var cmbSetorDestino = $("#cmbSetorDestino").data("kendoComboBox");
                                        if (cmbSetorDestino) cmbSetorDestino.value(data.setorDestinoId || "");

                                        var cmbSecaoDestino = $("#cmbSecoesDestino").data("kendoComboBox");
                                        if (cmbSecaoDestino) cmbSecaoDestino.value(data.secaoDestinoId || "");

                                        var datePicker = document.getElementById('dataMov')?.ej2_instances?.[0];
                                        if (datePicker && data.dataMovimentacao) {
                                            datePicker.value = new Date(data.dataMovimentacao);
                                        }
                                    }
                                    catch (error) {
                                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "carregarDadosMovimentacao.setTimeout", error);
                                    }
                                }, 500);
                            }
                        }
                        catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "carregarDadosMovimentacao.success", error);
                        }
                    },
                    error: function (err) {
                        try {
                            console.error('Erro ao carregar movimenta√ß√£o:', err);
                            AppToast.show("Vermelho", "Erro ao carregar dados da movimenta√ß√£o", 2000);
                        }
                        catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "carregarDadosMovimentacao.error", error);
                        }
                    }
                });
            }
            catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "carregarDadosMovimentacao", error);
            }
        }

        function salvarMovimentacao() {
            try {
                // Coletar dados dos componentes EJ2
                var cmbPatrimonio = $("#cmbPatrimonio").data("kendoComboBox");
                var cmbSetorDestino = $("#cmbSetorDestino").data("kendoComboBox");
                var cmbSecaoDestino = $("#cmbSecoesDestino").data("kendoComboBox");
                var datePicker = document.getElementById('dataMov')?.ej2_instances?.[0];
                var statusCheckbox = document.getElementById('StatusCheckbox')?.ej2_instances?.[0];

                // Montar objeto de dados
                var dados = {
                    movimentacaoPatrimonioId: $('#MovimentacaoPatrimonioId').val(),
                    patrimonioId: (cmbPatrimonio ? cmbPatrimonio.value() : null) || $('#PatrimonioId').val(),
                    dataMovimentacao: datePicker?.value ? datePicker.value.toISOString() : null,
                    setorOrigemId: $('#SetorOrigemId').val(),
                    secaoOrigemId: $('#SecaoOrigemId').val(),
                    setorDestinoId: cmbSetorDestino ? cmbSetorDestino.value() : null,
                    secaoDestinoId: cmbSecaoDestino ? cmbSecaoDestino.value() : null,
                    statusPatrimonio: statusCheckbox?.checked || false
                };

                // Valida√ß√µes
                var erros = [];

                if (!dados.patrimonioId || dados.patrimonioId === '') {
                    erros.push('O Patrim√¥nio n√£o pode estar em branco!');
                }

                if (!dados.dataMovimentacao) {
                    erros.push('A data n√£o pode estar em branco!');
                }

                if (!dados.setorOrigemId || dados.setorOrigemId === '') {
                    erros.push('O setor de origem n√£o pode estar em branco!');
                }

                if (!dados.secaoOrigemId || dados.secaoOrigemId === '') {
                    erros.push('A se√ß√£o de origem n√£o pode estar em branco!');
                }

                if (!dados.setorDestinoId || dados.setorDestinoId === '') {
                    erros.push('O setor de destino n√£o pode estar em branco!');
                }

                if (!dados.secaoDestinoId || dados.secaoDestinoId === '') {
                    erros.push('A se√ß√£o de destino n√£o pode estar em branco!');
                }

                if (dados.secaoDestinoId && dados.secaoOrigemId && dados.secaoDestinoId === dados.secaoOrigemId) {
                    erros.push('A se√ß√£o de destino n√£o pode ser a mesma que a se√ß√£o de origem!');
                }

                if (erros.length > 0) {
                    Alerta.Erro('Erro no formul√°rio', erros.join('\n'), 'OK');
                    return;
                }

                // Determinar URL e m√©todo
                var isEdicao = dados.movimentacaoPatrimonioId &&
                    dados.movimentacaoPatrimonioId !== '00000000-0000-0000-0000-000000000000';

                var url = isEdicao ? '/api/Patrimonio/UpdateMovimentacao' : '/api/Patrimonio/CreateMovimentacao';

                // Enviar dados via AJAX
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(dados),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (res) {
                        try {
                            if (res.success) {
                                AppToast.show("Verde", res.message || (isEdicao ? 'Movimenta√ß√£o atualizada com sucesso!' : 'Movimenta√ß√£o registrada com sucesso!'), 3000);
                                setTimeout(function () {
                                    try {
                                        window.location.href = '/MovimentacaoPatrimonio/Index';
                                    }
                                    catch (error) {
                                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarMovimentacao.success.setTimeout", error);
                                    }
                                }, 1500);
                            } else {
                                AppToast.show("Vermelho", res.message || 'Erro ao salvar movimenta√ß√£o', 5000);
                            }
                        }
                        catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarMovimentacao.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        try {
                            console.error('Erro ao salvar:', error);
                            AppToast.show("Vermelho", "Erro ao salvar movimenta√ß√£o. Verifique os dados e tente novamente.", 5000);
                        }
                        catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarMovimentacao.error", error);
                        }
                    }
                });
            }
            catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarMovimentacao", error);
            }
        }
    </script>

}
