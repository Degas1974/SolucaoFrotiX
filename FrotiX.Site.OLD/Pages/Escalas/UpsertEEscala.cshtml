@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Escalas/UpsertEEscala.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio criar/editar Escala tipo E (Especial?) com campos espec√≠ficos, valida√ß√µes, dropdowns
 * üì• ENTRADAS     : @page, @model UpsertEEscalaModel, campos escala tipo E (descri√ß√£o, per√≠odo, recursos), route parameter id para edi√ß√£o
 * üì§ SA√çDAS       : POST asp-page-handler="Submit|Edit", redirect ./ListaEscala, AppToast feedback
 * üîó CHAMADA POR  : ListaEscala (bot√£o "Adicionar Escala E", editar linha tipo E)
 * üîÑ CHAMA        : asp-page-handler="Submit" (POST create), asp-page-handler="Edit" (POST update), ./ListaEscala (redirect)
 * üì¶ DEPEND√äNCIAS : Syncfusion EJ2 (DatePicker, ComboBox, MultiSelect), Bootstrap 5, jQuery, ASP.NET TagHelpers, Google Fonts Outfit
 * üìù OBSERVA√á√ïES  : Total: 508 linhas. ISSUES: CSS inline ~160 linhas (padr√£o FrotiX), JavaScript inline ~90 linhas (valida√ß√µes), fun√ß√£o toCamelCase inline (duplicada), DUPLICA√á√ÉO com UpsertCEscala (90% c√≥digo id√™ntico), valida√ß√µes fracas, sem loading state submit. SUGEST√ÉO: Unificar UpsertCEscala e UpsertEEscala em um √∫nico Upsert.cshtml com par√¢metro tipo
 **************************************************************************************** *@
@page
@model FrotiX.Pages.Escalas.UpsertEEscalaModel
@{
    ViewData["Title"] = "Editar Escala";
    ViewData["PageName"] = "editar_escala";
}

<style>
    .status-checkbox {
        margin: 10px;
        padding: 15px;
        border-radius: 5px;
        transition: all 0.3s;
    }

        .status-checkbox.active-disponivel {
            background-color: #d4edda;
            border: 2px solid #28a745;
        }

        .status-checkbox.active-indisponivel {
            background-color: #f8d7da;
            border: 2px solid #dc3545;
        }

        .status-checkbox.active-economildo {
            background-color: #d1ecf1;
            border: 2px solid #17a2b8;
        }

        .status-checkbox.active-servico {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
        }

        .status-checkbox.active-reservado {
            background-color: #e2e3e5;
            border: 2px solid #6c757d;
        }

        .status-checkbox.active-viagem {
            background-color: #cfe2ff;
            border: 2px solid #0d6efd;
        }

    .indisponibilidade-section, .servico-section, .economildo-section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .contador-viagens {
        font-size: 3rem;
        font-weight: bold;
        color: #007bff;
    }
</style>

<div class="row mb-3">
    <div class="col-md-9">
        <h2><i class="fas fa-edit"></i> @ViewData["Title"]</h2>
    </div>
    <div class="col-md-3 text-end">
        <a asp-page="./ListaEscala" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<!-- Card de Status Atual -->
<div class="card mb-3 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Status Atual da Escala</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 text-center">
                <h6>Motorista</h6>
                <h4>@Model.NomeMotorista</h4>
                <span class="badge bg-@(Model.StatusMotorista == "Dispon√≠vel" ? "success" :
                                                         Model.StatusMotorista == "Em Viagem" ? "primary" :
                                                         Model.StatusMotorista == "Indispon√≠vel" ? "danger" :
                                                         Model.StatusMotorista == "Em Servi√ßo" ? "warning" : "info")">
                    @Model.StatusMotorista
                </span>
            </div>
            <div class="col-md-4 text-center">
                <h6>Ve√≠culo</h6>
                <h4>@Model.DescricaoVeiculo</h4>
            </div>
            <div class="col-md-4 text-center">
                <h6>N√∫mero de Sa√≠das Hoje</h6>
                <div class="contador-viagens">@Model.NumeroSaidas</div>
            </div>
        </div>
    </div>
</div>

<!-- POST via AJAX em EditarEscala.js -->
<form id="formEditarEscala" method="post">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <input type="hidden" id="hiddenEscalaDiaId" name="EscalaDiaId" value="@Model.EscalaDiaId" />
    <input type="hidden" id="hiddenMotoristaId" name="MotoristaId" value="@Model.MotoristaId" />
    <input type="hidden" id="hiddenNumeroSaidas" name="NumeroSaidas" value="@Model.NumeroSaidas" />

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Dados da Escala</h5>
        </div>
        <div class="card-body">
            <!-- Linha 1: Motorista e Ve√≠culo -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="MotoristaId" class="control-label required">
                            <i class="fas fa-user"></i> Motorista
                        </label>
                        <ejs-dropdownlist id="motoristaId" name="MotoristaId"
                                          dataSource="@Model.MotoristaList"
                                          value="@Model.MotoristaId"
                                          placeholder="Selecione o motorista"
                                          allowFiltering="true"
                                          floatLabelType="Auto"
                                          enabled="false">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <small class="text-muted">O motorista n√£o pode ser alterado ap√≥s a cria√ß√£o da escala</small>
                        <span asp-validation-for="MotoristaId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="VeiculoId" class="control-label">
                            <i class="fas fa-car"></i> Ve√≠culo
                        </label>
                        <ejs-dropdownlist id="veiculoId" name="VeiculoId"
                                          dataSource="@Model.VeiculoList"
                                          value="@Model.VeiculoId"
                                          placeholder="Selecione o ve√≠culo"
                                          allowFiltering="true"
                                          floatLabelType="Auto">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="veiculoNaoDefinido" name="VeiculoNaoDefinido" 
                                   @(Model.VeiculoId == null || Model.VeiculoId == Guid.Empty ? "checked" : "") />
                            <label class="form-check-label" for="veiculoNaoDefinido">
                                <i class="fas fa-ban text-muted"></i> Ve√≠culo n√£o definido
                            </label>
                        </div>
                        <span asp-validation-for="VeiculoId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Linha 2: Data e Turno -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="DataEscala" class="control-label required">
                            <i class="fas fa-calendar-day"></i> Data
                        </label>
                        <ejs-datepicker id="dataEscala" name="DataEscala"
                                        value="@Model.DataEscala"
                                        format="dd/MM/yyyy"
                                        placeholder="Selecione a data"
                                        floatLabelType="Auto"></ejs-datepicker>
                        <span asp-validation-for="DataEscala" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="TurnoId" class="control-label required">
                            <i class="fas fa-clock"></i> Turno
                        </label>
                        <ejs-dropdownlist id="turnoId" name="TurnoId"
                                          dataSource="@Model.TurnoList"
                                          value="@Model.TurnoId"
                                          placeholder="Selecione o turno"
                                          floatLabelType="Auto">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <span asp-validation-for="TurnoId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Linha 3: Hor√°rios -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="HoraInicio" class="control-label required">
                            <i class="fas fa-hourglass-start"></i> Hora In√≠cio
                        </label>
                        <ejs-timepicker id="horaInicio" name="HoraInicio"
                                       value="@Model.HoraInicio"
                                       placeholder="Hora in√≠cio"
                                       format="HH:mm"
                                       step="30"
                                       floatLabelType="Auto"></ejs-timepicker>
                        <span asp-validation-for="HoraInicio" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="HoraFim" class="control-label required">
                            <i class="fas fa-hourglass-end"></i> Hora Fim
                        </label>
                        <ejs-timepicker id="horaFim" name="HoraFim"
                                       value="@Model.HoraFim"
                                       placeholder="Hora fim"
                                       format="HH:mm"
                                       step="30"
                                       floatLabelType="Auto"></ejs-timepicker>
                        <span asp-validation-for="HoraFim" class="text-danger"></span>
                    </div>
                </div>
                          
            </div>

            <!-- Dias da Semana -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="control-label">
                        <i class="fas fa-calendar-week"></i> Dias da Semana (escalas futuras)
                    </label>
                    <div class="dias-semana-container">
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Segunda" id="segunda" />
                            <label for="segunda">Segunda-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Terca" id="terca" />
                            <label for="terca">Ter√ßa-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Quarta" id="quarta" />
                            <label for="quarta">Quarta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Quinta" id="quinta" />
                            <label for="quinta">Quinta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Sexta" id="sexta" />
                            <label for="sexta">Sexta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Sabado" id="sabado" />
                            <label for="sabado">S√°bado</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Domingo" id="domingo" />
                            <label for="domingo">Domingo</label>
                        </div>
                    </div>
                    <small class="form-text text-muted">
                        Altera√ß√µes nos dias da semana afetam escalas futuras (a partir de hoje)
                    </small>
                </div>
            </div>

            <!-- Linha 4: Tipo Servi√ßo e Lota√ß√£o -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="TipoServicoId" class="control-label required">
                            <i class="fas fa-briefcase"></i> Tipo de Servi√ßo
                        </label>
                        <ejs-dropdownlist id="tipoServicoId" name="TipoServicoId"
                                          dataSource="@Model.TipoServicoList"
                                          value="@Model.TipoServicoId"
                                          placeholder="Selecione o tipo de servi√ßo"
                                          floatLabelType="Auto">
                            <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                        </ejs-dropdownlist>
                        <span asp-validation-for="TipoServicoId" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Motorista -->
    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-toggle-on"></i> Status do Motorista</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.StatusMotorista == "Em Viagem" ? "active-viagem" : "")" id="statusViagem">
                        <div class="form-check">
                            <input type="radio" name="StatusMotorista" value="Em Viagem" 
                                   @(Model.StatusMotorista == "Em Viagem" ? "checked" : "") 
                                   class="form-check-input" disabled />
                            <label class="form-check-label">
                                <i class="fas fa-car text-primary"></i> Em Viagem
                            </label>
                        </div>
                        <small class="text-muted">Autom√°tico</small>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaIndisponivel ? "active-indisponivel" : "")" id="statusIndisponivel">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaIndisponivel" class="form-check-input" />
                            <label asp-for="MotoristaIndisponivel" class="form-check-label">
                                <i class="fas fa-times-circle text-danger"></i> Indispon√≠vel
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaEconomildo ? "active-economildo" : "")" id="statusEconomildo">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaEconomildo" class="form-check-input" />
                            <label asp-for="MotoristaEconomildo" class="form-check-label">
                                <i class="fas fa-dollar-sign text-info"></i> Economildo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaEmServico ? "active-servico" : "")" id="statusServico">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaEmServico" class="form-check-input" />
                            <label asp-for="MotoristaEmServico" class="form-check-label">
                                <i class="fas fa-briefcase text-warning"></i> Em Servi√ßo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox @(Model.MotoristaReservado ? "active-reservado" : "")" id="statusReservado">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaReservado" class="form-check-input" />
                            <label asp-for="MotoristaReservado" class="form-check-label">
                                <i class="fas fa-lock text-secondary"></i> Reservado
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.StatusMotorista == "Em Viagem")
            {
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> O status "Em Viagem" √© atualizado automaticamente quando o motorista inicia ou finaliza uma viagem.
                </div>
            }

            <!-- Se√ß√£o de Indisponibilidade -->
            <div class="indisponibilidade-section" id="indisponibilidadeSection" style="@(Model.MotoristaIndisponivel ? "display: block;" : "")">
                <h6><i class="fas fa-calendar-times"></i> Configurar Indisponibilidade</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="CategoriaIndisponibilidade">
                                <i class="fas fa-tag"></i> Motivo
                            </label>
                            <ejs-dropdownlist id="categoriaIndisponibilidade" name="CategoriaIndisponibilidade"
                                              value="@Model.CategoriaIndisponibilidade"
                                              dataSource='@(new List<object> {
                                                                                           new { text = "Folga", value = "Folga" },
                                                                                           new { text = "F√©rias", value = "F√©rias" },
                                                                                           new { text = "Recesso", value = "Recesso" },
                                                                                           new { text = "Falta", value = "Falta"},
                                                                                           new { text = "Atestado", value = "Atestado"}
                                                                                       })'
                                              placeholder="Selecione a categoria">
                                <e-dropdownlist-fields text="text" value="value"></e-dropdownlist-fields>
                            </ejs-dropdownlist>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DataInicioIndisponibilidade">
                                <i class="fas fa-calendar-day"></i> Data Inicial
                            </label>
                            <ejs-datepicker id="dataInicioIndisponibilidade" name="DataInicioIndisponibilidade"
                                            value="@Model.DataInicioIndisponibilidade"
                                            format="dd/MM/yyyy"
                                            placeholder="Data in√≠cio"></ejs-datepicker>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DataFimIndisponibilidade">
                                <i class="fas fa-calendar-day"></i> Data Final
                            </label>
                            <ejs-datepicker id="dataFimIndisponibilidade" name="DataFimIndisponibilidade"
                                            value="@Model.DataFimIndisponibilidade"
                                            format="dd/MM/yyyy"
                                            placeholder="Data fim"></ejs-datepicker>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="MotoristaCobertorId">
                                <i class="fas fa-user-shield"></i> Motorista Cobertor
                            </label>
                            <ejs-dropdownlist id="motoristaCobertorId" name="MotoristaCobertorId"
                                              dataSource="@Model.MotoristaList"
                                              value="@Model.MotoristaCobertorId"
                                              placeholder="Selecione o cobertor"
                                              allowFiltering="true">
                                <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                            </ejs-dropdownlist>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Economildo -->

            <div class="economildo-section" id="economildoSection" style="@(Model.MotoristaEconomildo ? "display: block;" : "")">
                <h6><i class="fas fa-user-tie"></i> Configurar Economildo</h6>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label asp-for="Lotacao" class="control-label">
                                <i class="fas fa-map-marker-alt"></i> Lota√ß√£o
                            </label>
                            <ejs-dropdownlist id="lotacao" name="Lotacao"
                                              dataSource="@Model.LotacaoList"
                                              value="@Model.Lotacao"
                                              placeholder="Selecione a lota√ß√£o"
                                              floatLabelType="Auto">
                             <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                             </ejs-dropdownlist>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Se√ß√£o de Em Servi√ßo -->
            <div class="servico-section" id="servicoSection" style="@(Model.MotoristaEmServico ? "display: block;" : "")">
                <h6><i class="fas fa-user-tie"></i> Configurar Servi√ßo Fixo</h6>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label asp-for="RequisitanteId">
                                <i class="fas fa-user-tie"></i> Requisitante
                            </label>
                            <ejs-dropdownlist id="requisitanteId" name="RequisitanteId"
                                              dataSource="@Model.RequisitanteList"
                                              value="@Model.RequisitanteId"
                                              placeholder="Selecione o requisitante"
                                              allowFiltering="true">
                                <e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
                            </ejs-dropdownlist>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Observa√ß√µes -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Observa√ß√µes</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label asp-for="Observacoes" class="control-label">
                    <i class="fas fa-comment"></i> Observa√ß√µes
                </label>
                <ejs-textbox id="observacoes" name="Observacoes"
                             value="@Model.Observacoes"
                             multiline="true"
                             placeholder="Digite as observa√ß√µes..."
                             floatLabelType="Auto"></ejs-textbox>
            </div>
        </div>
    </div>

    <!-- Bot√µes de A√ß√£o -->
    <div class="row mt-3">
        <div class="col-12">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Salvar Altera√ß√µes
            </button>
            <!-- ‚úÖ CORRIGIDO: asp-action ‚Üí asp-page -->
            <a asp-page="./ListaEscala" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="button" class="btn btn-danger float-end" onclick="excluirEscala('@Model.EscalaDiaId')">
                <i class="fas fa-trash"></i> Excluir Escala
            </button>
        </div>
    </div>
</form>

@section ScriptsBlock {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    
    <script src="~/js/cadastros/EditarEscala.js" asp-append-version="true"></script>
}
