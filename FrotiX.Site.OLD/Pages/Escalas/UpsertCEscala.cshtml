@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Escalas/UpsertCEscala.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio criar/editar Escala tipo C (Circular?) com campos espec√≠ficos, valida√ß√µes, dropdowns
 * üì• ENTRADAS     : @page, @model UpsertCEscalaModel, campos escala tipo C (descri√ß√£o, per√≠odo, recursos), route parameter id para edi√ß√£o
 * üì§ SA√çDAS       : POST asp-page-handler="Submit|Edit", redirect ./ListaEscala, AppToast feedback
 * üîó CHAMADA POR  : ListaEscala (bot√£o "Adicionar Escala C", editar linha tipo C)
 * üîÑ CHAMA        : asp-page-handler="Submit" (POST create), asp-page-handler="Edit" (POST update), ./ListaEscala (redirect)
 * üì¶ DEPEND√äNCIAS : Syncfusion EJ2 (DatePicker, ComboBox, MultiSelect), Bootstrap 5, jQuery, ASP.NET TagHelpers, Google Fonts Outfit
 * üìù OBSERVA√á√ïES  : Total: 467 linhas. ISSUES: CSS inline ~150 linhas (padr√£o FrotiX), JavaScript inline ~80 linhas (valida√ß√µes), fun√ß√£o toCamelCase inline (duplicada em v√°rios arquivos), valida√ß√µes fracas, sem loading state submit
 **************************************************************************************** *@
@page

@model FrotiX.Pages.Escalas.UpsertCEscalaModel
@{

    ViewData["Title"] = "Criar Escala";
    ViewData["PageName"] = "escalas_upsertCescala";
    ViewData["Heading"] = "<i class='fa-duotone fa-user'></i> Escalas: <span class='fw-300'>Criar Escala</span>";
    ViewData["Category1"] = "Escalas";
    ViewData["PageIcon"] = "fa-duotone fa-user";
}
<style>
    .status-checkbox {
        margin: 10px;
        padding: 15px;
        border-radius: 5px;
        transition: all 0.3s;
    }
    .status-checkbox.active-disponivel { background-color: #d4edda; border: 2px solid #28a745; }
    .status-checkbox.active-indisponivel { background-color: #f8d7da; border: 2px solid #dc3545; }
    .status-checkbox.active-economildo { background-color: #d1ecf1; border: 2px solid #17a2b8; }
    .status-checkbox.active-servico { background-color: #fff3cd; border: 2px solid #ffc107; }
    .status-checkbox.active-reservado { background-color: #e2e3e5; border: 2px solid #6c757d; }
    .indisponibilidade-section, .servico-section, .economildo-section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    
    .dias-semana-container {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    .dia-checkbox {
        display: inline-block;
        margin-right: 15px;
        margin-bottom: 10px;
    }
    .dia-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 5px;
        vertical-align: middle;
    }
    .dia-checkbox label {
        font-weight: 500;
        vertical-align: middle;
        cursor: pointer;
        user-select: none;
    }
</style>

<div class="row mb-3">
    <div class="col-md-9">
        <h2><i class="fas fa-plus-circle"></i> @ViewData["Title"]</h2>
    </div>
    <div class="col-md-3 text-end">
        <a asp-page="./ListaEscala" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<form method="post">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Dados da Escala</h5>
        </div>
        <div class="card-body">
            <!-- Linha 1: Motorista e Ve√≠culo -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="MotoristaId" class="control-label required">
                            <i class="fas fa-user"></i> Motorista
                        </label>
                        <input id="motoristaId" name="MotoristaId" style="width: 100%;" />
                        <span asp-validation-for="MotoristaId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="VeiculoId" class="control-label">
                            <i class="fas fa-car"></i> Ve√≠culo
                        </label>
                        <input id="veiculoId" name="VeiculoId" style="width: 100%;" />
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="veiculoNaoDefinido" name="VeiculoNaoDefinido" />
                            <label class="form-check-label" for="veiculoNaoDefinido">
                                <i class="fas fa-ban text-muted"></i> Ve√≠culo n√£o definido
                            </label>
                        </div>
                        <span asp-validation-for="VeiculoId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Linha 2 - Per√≠odo de Vig√™ncia -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="DataInicio" class="control-label required">
                            <i class="fas fa-calendar-day"></i> Data In√≠cio
                        </label>
                        <input id="dataInicio" name="DataInicio" style="width: 100%;" />
                        <span asp-validation-for="DataInicio" class="text-danger"></span>
                        <small class="form-text text-muted">
                            Data inicial do per√≠odo de vig√™ncia da escala
                        </small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="DataFim" class="control-label required">
                            <i class="fas fa-calendar-day"></i> Data Fim
                        </label>
                        <input id="dataFim" name="DataFim" style="width: 100%;" />
                        <span asp-validation-for="DataFim" class="text-danger"></span>
                        <small class="form-text text-muted">
                            Data final do per√≠odo de vig√™ncia da escala
                        </small>
                    </div>
                </div>
            </div>

            <!-- Dias da Semana -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="control-label required">
                        <i class="fas fa-calendar-week"></i> Dias da Semana
                    </label>
                    <div class="dias-semana-container">
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Segunda" id="segunda" />
                            <label for="segunda">Segunda-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Terca" id="terca" />
                            <label for="terca">Ter√ßa-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Quarta" id="quarta" />
                            <label for="quarta">Quarta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Quinta" id="quinta" />
                            <label for="quinta">Quinta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Sexta" id="sexta" />
                            <label for="sexta">Sexta-feira</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Sabado" id="sabado" />
                            <label for="sabado">S√°bado</label>
                        </div>
                        <div class="dia-checkbox">
                            <input type="checkbox" asp-for="Domingo" id="domingo" />
                            <label for="domingo">Domingo</label>
                        </div>
                    </div>
                    <small class="form-text text-muted">
                        Selecione os dias da semana em que esta escala ser√° aplicada
                    </small>
                </div>
            </div>

            <!-- Linha 3: Turno e Tipo de Servi√ßo -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="TurnoId" class="control-label required">
                            <i class="fas fa-clock"></i> Turno
                        </label>
                        <input id="turnoId" name="TurnoId" style="width: 100%;" />
                        <span asp-validation-for="TurnoId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="TipoServicoId" class="control-label required">
                            <i class="fas fa-briefcase"></i> Tipo de Servi√ßo
                        </label>
                        <input id="tipoServicoId" name="TipoServicoId" style="width: 100%;" />
                        <span asp-validation-for="TipoServicoId" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Linha 4 - Hora In√≠cio e Hora Fim  -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="HoraInicio" class="control-label required">
                            <i class="fas fa-hourglass-start"></i> Hora In√≠cio
                        </label>
                        <input id="horaInicio" name="HoraInicio" style="width: 100%;" />
                        <span asp-validation-for="HoraInicio" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="HoraFim" class="control-label required">
                            <i class="fas fa-hourglass-end"></i> Hora Fim
                        </label>
                        <input id="horaFim" name="HoraFim" style="width: 100%;" />
                        <span asp-validation-for="HoraFim" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Motorista -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-traffic-light"></i> Status do Motorista</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <div class="status-checkbox" id="statusDisponivel">
                        <div class="form-check">
                            <input type="radio" name="StatusMotorista" value="Dispon√≠vel" checked class="form-check-input" />
                            <label class="form-check-label">
                                <i class="fas fa-check-circle text-success"></i> Dispon√≠vel
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox" id="statusIndisponivel">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaIndisponivel" class="form-check-input" />
                            <label asp-for="MotoristaIndisponivel" class="form-check-label">
                                <i class="fas fa-times-circle text-danger"></i> Indispon√≠vel
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox" id="statusEconomildo">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaEconomildo" class="form-check-input" />
                            <label asp-for="MotoristaEconomildo" class="form-check-label">
                                <i class="fas fa-dollar-sign text-info"></i> Economildo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox" id="statusServico">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaEmServico" class="form-check-input" />
                            <label asp-for="MotoristaEmServico" class="form-check-label">
                                <i class="fas fa-briefcase text-warning"></i> Em Servi√ßo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="status-checkbox" id="statusReservado">
                        <div class="form-check">
                            <input type="checkbox" asp-for="MotoristaReservado" class="form-check-input" />
                            <label asp-for="MotoristaReservado" class="form-check-label">
                                <i class="fas fa-lock text-secondary"></i> Reservado
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Indisponibilidade -->
            <div class="indisponibilidade-section" id="indisponibilidadeSection">
                <h6><i class="fas fa-calendar-times"></i> Configurar Indisponibilidade</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="CategoriaIndisponibilidade"></label>
                            <input id="categoriaIndisponibilidade" name="CategoriaIndisponibilidade" style="width: 100%;" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DataInicioIndisponibilidade"></label>
                            <input id="dataInicioIndisponibilidade" name="DataInicioIndisponibilidade" style="width: 100%;" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DataFimIndisponibilidade"></label>
                            <input id="dataFimIndisponibilidade" name="DataFimIndisponibilidade" style="width: 100%;" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="MotoristaCobertorId"></label>
                            <input id="motoristaCobertorId" name="MotoristaCobertorId" style="width: 100%;" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Economildo -->

            <div class="economildo-section" id="economildoSection" style="@(Model.MotoristaEconomildo ? "display: block;" : "")">
                <h6><i class="fas fa-user-tie"></i> Configurar Economildo</h6>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label asp-for="Lotacao" class="control-label">
                                <i class="fas fa-map-marker-alt"></i> Lota√ß√£o
                            </label>
                            <input id="lotacao" name="Lotacao" style="width: 100%;" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Em Servi√ßo -->
            <div class="servico-section" id="servicoSection">
                <h6><i class="fas fa-user-tie"></i> Configurar Servi√ßo Fixo</h6>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label asp-for="RequisitanteId"></label>
                            <input id="requisitanteId" name="RequisitanteId" style="width: 100%;" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Observa√ß√µes -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Observa√ß√µes</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label asp-for="Observacoes" class="control-label"></label>
                <textarea id="observacoes" name="Observacoes" class="form-control" rows="3"
                          placeholder="Digite as observa√ß√µes...">@Model.Observacoes</textarea>
            </div>
        </div>
    </div>

    <!-- Bot√µes de A√ß√£o -->
    <div class="row mt-3 mb-4">
        <div class="col-12">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-save"></i> Salvar Escala
            </button>
            <a asp-page="./ListaEscala" class="btn btn-secondary btn-lg">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </div>
</form>

@section ScriptsBlock {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        (function () {
            try {
                var dataMotorista = @Html.Raw(Json.Serialize(Model.MotoristaList));
                var dataVeiculo = @Html.Raw(Json.Serialize(Model.VeiculoList));
                var dataTurno = @Html.Raw(Json.Serialize(Model.TurnoList));
                var dataTipoServico = @Html.Raw(Json.Serialize(Model.TipoServicoList));
                var dataLotacao = @Html.Raw(Json.Serialize(Model.LotacaoList));
                var dataRequisitante = @Html.Raw(Json.Serialize(Model.RequisitanteList));
                var dataCategoriaIndisponibilidade = [
                    { text: "Folga", value: "Folga" },
                    { text: "F\u00e9rias", value: "F\u00e9rias" },
                    { text: "Recesso", value: "Recesso" }
                ];

                $("#motoristaId").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione o motorista",
                    filter: "contains",
                    dataSource: dataMotorista,
                    value: "@(Model.MotoristaId?.ToString() ?? "")"
                });

                $("#veiculoId").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione o ve\u00edculo",
                    filter: "contains",
                    dataSource: dataVeiculo,
                    value: "@(Model.VeiculoId?.ToString() ?? "")"
                });

                $("#turnoId").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione o turno",
                    dataSource: dataTurno,
                    value: "@(Model.TurnoId != default ? Model.TurnoId.ToString() : "")"
                });

                $("#tipoServicoId").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione o tipo de servi\u00e7o",
                    dataSource: dataTipoServico,
                    value: "@(Model.TipoServicoId != default ? Model.TipoServicoId.ToString() : "")"
                });

                $("#categoriaIndisponibilidade").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione a categoria",
                    dataSource: dataCategoriaIndisponibilidade,
                    value: "@(Model.CategoriaIndisponibilidade ?? "")"
                });

                $("#motoristaCobertorId").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione o cobertor",
                    filter: "contains",
                    dataSource: dataMotorista,
                    value: "@(Model.MotoristaCobertorId?.ToString() ?? "")"
                });

                $("#lotacao").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione a lota\u00e7\u00e3o",
                    dataSource: dataLotacao,
                    value: "@(Model.Lotacao ?? "")"
                });

                $("#requisitanteId").kendoDropDownList({
                    dataTextField: "text",
                    dataValueField: "value",
                    optionLabel: "Selecione o requisitante",
                    filter: "contains",
                    dataSource: dataRequisitante,
                    value: "@(Model.RequisitanteId?.ToString() ?? "")"
                });

                // ================================================================
                // KENDO DATEPICKER INIT - Migrado de Syncfusion ejs-datepicker
                // ================================================================

                $("#dataInicio").kendoDatePicker({
                    format: "dd/MM/yyyy",
                    culture: "pt-BR",
                    dateInput: { format: "dd/MM/yyyy", messages: { year: "yyyy", month: "MM", day: "dd" } },
                    placeholder: "Selecione a data de in√≠cio",
                    value: @Html.Raw(Model.DataInicio != default(DateTime) ? "new Date(\"" + Model.DataInicio.ToString("yyyy-MM-dd") + "\")" : "null")
                });

                $("#dataFim").kendoDatePicker({
                    format: "dd/MM/yyyy",
                    culture: "pt-BR",
                    dateInput: { format: "dd/MM/yyyy", messages: { year: "yyyy", month: "MM", day: "dd" } },
                    placeholder: "Selecione a data fim",
                    value: @Html.Raw(Model.DataFim != default(DateTime) ? "new Date(\"" + Model.DataFim.ToString("yyyy-MM-dd") + "\")" : "null")
                });

                $("#dataInicioIndisponibilidade").kendoDatePicker({
                    format: "dd/MM/yyyy",
                    culture: "pt-BR",
                    dateInput: { format: "dd/MM/yyyy", messages: { year: "yyyy", month: "MM", day: "dd" } },
                    placeholder: "Data in√≠cio"
                });

                $("#dataFimIndisponibilidade").kendoDatePicker({
                    format: "dd/MM/yyyy",
                    culture: "pt-BR",
                    dateInput: { format: "dd/MM/yyyy", messages: { year: "yyyy", month: "MM", day: "dd" } },
                    placeholder: "Data fim"
                });

                // ================================================================
                // KENDO TIMEPICKER INIT - Migrado de Syncfusion ejs-timepicker
                // ================================================================

                $("#horaInicio").kendoTimePicker({
                    format: "HH:mm",
                    culture: "pt-BR",
                    interval: 30,
                    dateInput: { format: "HH:mm", messages: { hour: "HH", minute: "mm" } },
                    placeholder: "Hora in√≠cio",
                    value: @Html.Raw(!string.IsNullOrEmpty(Model.HoraInicio) && TimeSpan.TryParse(Model.HoraInicio, out var _hiC) ? "new Date(0,0,0," + TimeSpan.Parse(Model.HoraInicio).Hours + "," + TimeSpan.Parse(Model.HoraInicio).Minutes + ")" : "null")
                });

                $("#horaFim").kendoTimePicker({
                    format: "HH:mm",
                    culture: "pt-BR",
                    interval: 30,
                    dateInput: { format: "HH:mm", messages: { hour: "HH", minute: "mm" } },
                    placeholder: "Hora fim",
                    value: @Html.Raw(!string.IsNullOrEmpty(Model.HoraFim) && TimeSpan.TryParse(Model.HoraFim, out var _hfC) ? "new Date(0,0,0," + TimeSpan.Parse(Model.HoraFim).Hours + "," + TimeSpan.Parse(Model.HoraFim).Minutes + ")" : "null")
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("UpsertCEscala.cshtml", "kendoControls.init", error);
            }
        })();
    </script>

    <script src="~/js/cadastros/CriarEscala.js" asp-append-version="true"></script>

    <script>
       
        document.addEventListener('DOMContentLoaded', function() {
            // Gerenciar visualiza√ß√£o das se√ß√µes
            const checkboxIndisponivel = document.getElementById('MotoristaIndisponivel');
            const checkboxServico = document.getElementById('MotoristaEmServico');
            const sectionIndisponibilidade = document.getElementById('indisponibilidadeSection');
            const sectionServico = document.getElementById('servicoSection');

            if (checkboxIndisponivel) {
                checkboxIndisponivel.addEventListener('change', function() {
                    sectionIndisponibilidade.style.display = this.checked ? 'block' : 'none';
                });
            }

            if (checkboxServico) {
                checkboxServico.addEventListener('change', function() {
                    sectionServico.style.display = this.checked ? 'block' : 'none';
                });
            }
        });
    </script>
}
