@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Multa/UpsertAutuacao.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio criar/editar notifica√ß√£o de autua√ß√£o de multa (dados infra√ß√£o, ve√≠culo, motorista, PDFs, observa√ß√µes)
 * üì• ENTRADAS     : @page, @model UpsertMultaModel, campos: NumInfracao, Data, Hora, Valores (AteVencimento/PosVencimento), Localizacao, lstInfracao, lstStatus, lstOrgao, lstEmpenhos, lstVeiculo, lstMotorista, uploads (uploaderAutuacao), RTE observa√ß√µes
 * üì§ SA√çDAS       : POST (handler=Submit ou Edit), redirect para ListaAutuacao, AppToast feedback, modal #modalFicha (ficha vistoria PNG)
 * üîó CHAMADA POR  : ListaAutuacao (bot√£o "Adicionar Autua√ß√£o", editar linha), menu navega√ß√£o
 * üîÑ CHAMA        : (assumido) /api/Multa/CreateAutuacao ou UpdateAutuacao, /api/MultaUpload/save|remove, /api/Viagem/SaveImage (RTE), ~/js/cadastros/upsert_autuacao.js, ~/js/viagens/kendo-editor-upsert.js
 * üì¶ DEPEND√äNCIAS : Syncfusion.EJ2 (ComboBox, DropDownList, DatePicker, Uploader, PDFViewer), Kendo UI 2022.1.412 (Editor RTE - Telerik), Bootstrap 5.3.8 (CDN redundante), jsPDF 2.5.1 (modal baixar PDF ficha), Font Awesome Duotone
 * üìù OBSERVA√á√ïES  : Total: 768 linhas. PROBLEMA: Bootstrap CDN redundante, CSS inline grande (361 linhas) - extrair, JavaScript inline massivo (407 linhas) - DEVE extrair (parseCurrencyBR, moeda, formatCurrencyBR, spinners, valores), H√çBRIDO: Usa Syncfusion + Kendo Editor (inconsist√™ncia - padronizar), BUG POTENCIAL: form.addEventListener('submit') + btn.addEventListener('click') - pode causar double submit, Campos valor: usa hidden fields (hdnValorAteVencimento/PosVencimento) para enviar valores parseados - correto, Modal ficha vistoria: exibe PNG, bot√£o baixar PDF (btnBaixarPDF usa jsPDF) - funcional mas complexo, Uploader autua√ß√£o: serviceUrl="/api/MultaPdfViewer" - correto, RTE: Kendo Editor (Telerik) - requer licen√ßa? Verificar
 **************************************************************************************** *@
@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers
@using Newtonsoft.Json
@using Syncfusion.EJ2
@model FrotiX.Pages.Multa.UpsertMultaModel

@{
	ViewData["Title"] = "Notifica√ß√µes";
	ViewData["PageName"] = "multa_upsertautuacao";
	ViewData["Heading"] = "<i class='fa-duotone fa-pen-to-square'></i> Cadastros: <span class='fw-300'>Notifica√ß√£o de Autua√ß√£o</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-pen-to-square";
}

@section HeadBlock {
	<link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

	<style>
		/* ====== ANIMA√á√ÉO WIGGLE FROTIX ====== */
		@@keyframes buttonWiggle {
			0% {
				transform: translateY(0) rotate(0deg);
			}

			25% {
				transform: translateY(-2px) rotate(-1deg);
			}

			50% {
				transform: translateY(-3px) rotate(0deg);
			}

			75% {
				transform: translateY(-2px) rotate(1deg);
			}

			100% {
				transform: translateY(0) rotate(0deg);
			}
		}

		/* ====== VARI√ÅVEIS LOCAIS ====== */
		:root {
			--ftx-autuacao-azul: #3D5771;
			--ftx-autuacao-azul-dark: #2d4559;
			--ftx-autuacao-vinho: #722f37;
			--ftx-autuacao-vinho-dark: #5a252c;
			--ftx-autuacao-verde: #2E8B57;
			--ftx-autuacao-verde-dark: #236B43;
			--ftx-autuacao-terracota: #A0522D;
			--ftx-autuacao-terracota-dark: #8B4513;
		}

		/* ===== FORM CONTROLS ===== */
		.form-control-xs {
			height: calc(1em + .775rem + 10px) !important;
			padding: .125rem .5rem !important;
			font-size: .8rem !important;
			line-height: 1.5;
			border-radius: .35rem;
			border: 1px solid #ced4da;
			transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
		}

		.form-control-xs:focus {
			border-color: var(--ftx-autuacao-azul);
			box-shadow: 0 0 0 0.15rem rgba(61, 87, 113, 0.2);
		}

		.label {
			margin-bottom: 2px;
			margin-top: 10px;
			font-size: 0.8rem;
			color: #495057;
		}

		/* Asterisco campos obrigat√≥rios */
		.label-required::after {
			content: " *";
			color: #dc3545;
			font-size: 0.7rem;
			/* 2px menor que o label (0.8rem - 2px aprox 0.7rem) */
			font-weight: bold;
			vertical-align: top;
		}

		/* ====== √çCONE DUOTONE NO HEADER ====== */
		.ftx-card-header .titulo-paginas i {
			--fa-primary-color: #fff !important;
			--fa-secondary-color: #C67750 !important;
		}

		input[type=checkbox] {
			vertical-align: middle;
			position: relative;
			bottom: 1px;
		}

		.btn-largura {
			width: 100px;
			height: 100px;
		}

		.img {
			width: 100%;
		}

		.e-upload {
			width: 100%;
		}

		.e-pv-toolbar {
			border-radius: .25rem;
		}

		/* ====== BOT√ïES DE A√á√ÉO - COM SOMBREADO FORTE ====== */
		.btn-azul {
			background-color: var(--ftx-autuacao-azul) !important;
			border: none !important;
			color: #fff !important;
			border-radius: .375rem !important;
			transition: all .3s ease, transform .2s ease !important;
			box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35), 0 2px 4px rgba(0, 0, 0, 0.2) !important;
		}

		.btn-azul:hover {
			background-color: var(--ftx-autuacao-azul-dark) !important;
			color: #fff !important;
			animation: buttonWiggle 0.5s ease-in-out !important;
			box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4), 0 3px 6px rgba(0, 0, 0, 0.25) !important;
		}

		.btn-azul:active,
		.btn-azul:focus {
			transform: translateY(0) scale(1) !important;
			color: #fff !important;
		}

		.btn-vinho {
			background-color: var(--ftx-autuacao-vinho) !important;
			border: none !important;
			color: #fff !important;
			border-radius: .375rem !important;
			transition: all .3s ease, transform .2s ease !important;
			box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35), 0 2px 4px rgba(0, 0, 0, 0.2) !important;
		}

		.btn-vinho:hover {
			background-color: var(--ftx-autuacao-vinho-dark) !important;
			color: #fff !important;
			animation: buttonWiggle 0.5s ease-in-out !important;
			box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4), 0 3px 6px rgba(0, 0, 0, 0.25) !important;
		}

		.btn-vinho:active,
		.btn-vinho:focus {
			transform: translateY(0) scale(1) !important;
			color: #fff !important;
		}

		.btn-verde {
			background-color: var(--ftx-autuacao-verde) !important;
			border: none !important;
			color: #fff !important;
			border-radius: .375rem !important;
			transition: all .3s ease, transform .2s ease !important;
			box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35), 0 2px 4px rgba(0, 0, 0, 0.2) !important;
		}

		.btn-verde:hover {
			background-color: var(--ftx-autuacao-verde-dark) !important;
			color: #fff !important;
			animation: buttonWiggle 0.5s ease-in-out !important;
			box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4), 0 3px 6px rgba(0, 0, 0, 0.25) !important;
		}

		.btn-verde:active,
		.btn-verde:focus {
			transform: translateY(0) scale(1) !important;
			color: #fff !important;
		}

		/* ====== BOT√ïES PEQUENOS (INPUT-GROUP) ====== */
		.input-group .btn-sm {
			padding: 0.25rem 0.5rem;
			font-size: 0.8rem;
			border-radius: .375rem !important;
		}

		/* ===== ESTILOS DO MODAL FICHA - PADR√ÉO FROTIX ===== */
		#modalFicha .modal-dialog {
			max-width: 650px;
		}

		#modalFicha .modal-content {
			border: none;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		#modalFicha .modal-header {
			background: linear-gradient(180deg, var(--ftx-autuacao-azul) 0%, var(--ftx-autuacao-azul-dark) 100%);
			border-bottom: none;
			padding: 1rem 1.5rem;
		}

		#modalFicha .modal-header .modal-title {
			color: #fff !important;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			font-size: 1.1rem;
		}

		#modalFicha .modal-header .modal-title i {
			color: #fff !important;
			filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
			--fa-primary-color: #fff;
			--fa-secondary-color: rgba(255, 255, 255, 0.7);
		}

		#modalFicha .modal-header .btn-close-white {
			filter: brightness(0) invert(1);
			opacity: 0.85;
			transition: all 0.2s ease;
		}

		#modalFicha .modal-header .btn-close-white:hover {
			opacity: 1;
			transform: rotate(90deg);
		}

		#modalFicha .modal-body {
			padding: 0;
			background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
		}

		#modalFicha #divImagemFicha {
			max-height: 600px;
			overflow: auto;
			padding: 1rem;
		}

		#modalFicha #imgFichaVistoria {
			max-width: 100%;
			height: auto;
			border: 1px solid #dee2e6;
			border-radius: 8px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		}

		#modalFicha .modal-footer {
			border-top: 1px solid rgba(0, 0, 0, 0.08);
			padding: 0.875rem 1.25rem;
			background: #f8f9fa;
			gap: 0.5rem;
		}

		/* ====== BOT√ïES DOS MODAIS - COM SOMBREADO FORTE ====== */
		.btn-modal-fechar {
			background-color: var(--ftx-autuacao-vinho) !important;
			color: #fff !important;
			border: none;
			padding: 0.5rem 1.25rem;
			border-radius: .375rem;
			font-weight: 600;
			font-size: 0.875rem;
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			transition: all .3s ease, transform .2s ease !important;
			box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35), 0 2px 4px rgba(0, 0, 0, 0.2) !important;
		}

		.btn-modal-fechar:hover {
			background-color: var(--ftx-autuacao-vinho-dark) !important;
			color: #fff !important;
			animation: buttonWiggle 0.5s ease-in-out !important;
			box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4), 0 3px 6px rgba(0, 0, 0, 0.25) !important;
		}

		.btn-modal-fechar:active,
		.btn-modal-fechar:focus {
			transform: translateY(0) scale(1) !important;
		}

		.btn-modal-confirmar {
			background-color: var(--ftx-autuacao-azul) !important;
			color: #fff !important;
			border: none;
			padding: 0.5rem 1.25rem;
			border-radius: .375rem;
			font-weight: 600;
			font-size: 0.875rem;
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			transition: all .3s ease, transform .2s ease !important;
			box-shadow: 0 3px 6px rgba(0, 0, 0, 0.35), 0 2px 4px rgba(0, 0, 0, 0.2) !important;
		}

		.btn-modal-confirmar:hover {
			background-color: var(--ftx-autuacao-azul-dark) !important;
			color: #fff !important;
			animation: buttonWiggle 0.5s ease-in-out !important;
			box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4), 0 3px 6px rgba(0, 0, 0, 0.25) !important;
		}

		.btn-modal-confirmar:active,
		.btn-modal-confirmar:focus {
			transform: translateY(0) scale(1) !important;
		}

		/* ====== SPINNER NOS BOT√ïES ====== */
		.btn .spinner-border {
			width: 1rem;
			height: 1rem;
			border-width: 2px;
		}

		.btn:disabled {
			opacity: 0.65;
			cursor: not-allowed;
			box-shadow: none !important;
			animation: none !important;
		}

		/* ===== PDF VIEWER ===== */
		#pdfviewer {
			border: 1px solid #dee2e6;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
		}

		/* ===== RICH TEXT EDITOR ===== */
		.e-richtexteditor {
			border-radius: 8px;
			overflow: hidden;
		}

		/* ===== SYNCFUSION COMBOBOX/DROPDOWN AJUSTES ===== */
		.e-input-group {
			border-radius: .35rem !important;
		}

		.e-input-group:not(.e-disabled):not(.e-float-icon-left)::before,
		.e-input-group:not(.e-disabled):not(.e-float-icon-left)::after {
			background: var(--ftx-autuacao-azul) !important;
		}

		/* ===== UPLOADER SYNCFUSION ===== */
		.e-upload .e-upload-files {
			border-radius: 6px;
		}

		.e-upload .e-file-select-wrap {
			border-radius: 6px;
		}

		/* ===== AJUSTES RESPONSIVOS ===== */
		@@media (max-width: 768px) {
			#modalFicha .modal-dialog {
				max-width: 95%;
				margin: 1rem auto;
			}

			.btn-azul,
			.btn-vinho,
			.btn-verde {
				font-size: 0.85rem;
				padding: 0.5rem 1rem;
			}
		}
	</style>
}

<form method="post" onkeypress='stopEnterSubmitting(window.event)' enctype="multipart/form-data" autocomplete="off">
	@Html.AntiForgeryToken()
	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel ftx-card-styled">
				<div class="panel-container show">

					<!-- Header Padr√£o FrotiX -->
					<div class="ftx-card-header d-flex justify-content-between align-items-center">
						<h2 class="titulo-paginas mb-0">
							<i class="fa-duotone fa-user-police-tie"></i>
							@(Model.MultaObj.Multa.MultaId != Guid.Empty ? "Atualizar " : "Criar ") Autua√ß√£o
						</h2>
						<div class="ftx-card-actions">
							<a asp-page="/Multa/ListaAutuacao" class="btn btn-header-orange" data-ftx-loading>
								<i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i>
								Voltar √† Lista
							</a>
						</div>
					</div>

					<div class="panel-content">
						<div id="divPainel" class="p-3">

							<div asp-validation-summary="ModelOnly" class="text-danger">
								@if (Model.MultaObj.Multa.MultaId != Guid.Empty)
								{
									<input type="hidden" asp-for="MultaObj.Multa.MultaId" />
								}
							</div>

							<input type="text" id="txtFase" asp-for="MultaObj.Multa.Fase" hidden />

							<div class="row">
								<div class="col-12 col-md-4 col-xl-2">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="MultaObj.Multa.NumInfracao"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="MultaObj.Multa.NumInfracao"></span>
										<input id="txtNumInfracao" class="form-control form-control-xs"
											asp-for="MultaObj.Multa.NumInfracao" />
									</div>
								</div>
								<div class="col-6 col-md-2 col-xl-2">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="MultaObj.Multa.Data"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="MultaObj.Multa.Data"></span>
										<input id="txtDataInfracao" class="form-control form-control-xs"
											asp-for="MultaObj.Multa.Data" type="date" />
									</div>
								</div>
								<div class="col-6 col-md-2 col-xl-2">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="MultaObj.Multa.Hora"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="MultaObj.Multa.Hora"></span>
										<input id="txtHoraInfracao" class="form-control form-control-xs"
											asp-for="MultaObj.Multa.Hora" type="time" />
									</div>
								</div>
								<div class="col-6 col-md-2 col-xl-2">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="MultaObj.Multa.DataNotificacao"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="MultaObj.Multa.DataNotificacao"></span>
										<input id="txtDataNotificacao" class="form-control form-control-xs"
											asp-for="MultaObj.Multa.DataNotificacao" type="date" />
									</div>
								</div>
								<div class="col-6 col-md-2 col-xl-2">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="MultaObj.Multa.DataLimite"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="MultaObj.Multa.DataLimite"></span>
										<input id="txtDataLimite" class="form-control form-control-xs"
											asp-for="MultaObj.Multa.DataLimite" type="date" />
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-12 col-md-4 col-xl-4">
									<label class="label font-weight-bold label-required"
										asp-for="MultaObj.Multa.ValorAteVencimento"></label>
									<span class="text-danger"
										asp-validation-for="MultaObj.Multa.ValorAteVencimento"></span>
									<input id="txtValorAteVencimento" class="form-control form-control-xs"
										style="text-align: right;" onkeypress="return moeda(this,'.',',',event)"
										placeholder="R$ 0,00" />
									<input type="hidden" asp-for="MultaObj.Multa.ValorAteVencimento"
										id="hdnValorAteVencimento" />
								</div>
								<div class="col-12 col-md-4 col-xl-4">
									<label class="label font-weight-bold label-required"
										asp-for="MultaObj.Multa.ValorPosVencimento"></label>
									<span class="text-danger"
										asp-validation-for="MultaObj.Multa.ValorPosVencimento"></span>
									<input id="txtValorPosVencimento" class="form-control form-control-xs"
										style="text-align: right;" onkeypress="return moeda(this,'.',',',event)"
										placeholder="R$ 0,00" />
									<input type="hidden" asp-for="MultaObj.Multa.ValorPosVencimento"
										id="hdnValorPosVencimento" />
								</div>
							</div>

							<div class="row pb-12">
								<div class="col-12">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="MultaObj.Multa.Localizacao"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="MultaObj.Multa.Localizacao"></span>
										<input id="txtLocalizacao" class="form-control form-control-xs"
											asp-for="MultaObj.Multa.Localizacao" />
									</div>
								</div>
							</div>

							<div class="row pb-12">
								<div class="col-10">
									<div class="form-group">
										<label class="label font-weight-bold label-required">Infra√ß√£o</label>
										<input id="lstInfracao" name="MultaObj.Multa.TipoMultaId" style="width: 100%;" />
									</div>
								</div>
								<div class="col-2">
									<div class="form-group">
										<label class="label font-weight-bold label-required"
											asp-for="MultaObj.Multa.Status"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="MultaObj.Multa.Status"></span>
										<input id="lstStatus" name="MultaObj.Multa.Status" style="width: 100%;" />
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-12 col-md-6 col-xl-4">
									<label class="label font-weight-bold label-required">√ìrg√£o Autuante</label>
									<input id="lstOrgao" name="MultaObj.Multa.OrgaoAutuanteId" style="width: 100%;" />
								</div>
								<div class="col-12 col-md-6 col-xl-4">
									<label class="label font-weight-bold">Empenho do √ìrg√£o</label>
									<input id="lstEmpenhos" name="MultaObj.Multa.EmpenhoMultaId" style="width: 100%;" />
									<input id="txtEmpenhoMultaId" class="form-control form-control-xs"
										asp-for="MultaObj.Multa.EmpenhoMultaId" hidden />
								</div>
								<div class="col-6 col-md-3 col-xl-2">
									<label class="label font-weight-bold">Saldo do Empenho</label>
									<input id="txtSaldoEmpenho" class="form-control form-control-xs" disabled
										style="text-align:right" />
								</div>
							</div>

							<div class="row">
								<div class="col-12 col-md-6 col-xl-4">
									<label class="label font-weight-bold label-required">Ve√≠culo</label>
									<input id="lstVeiculo" name="MultaObj.Multa.VeiculoId" style="width: 100%;" />
								</div>
								<div class="col-6 col-md-3 col-xl-2">
									<label class="label font-weight-bold">Contrato do Ve√≠culo</label>
									<input id="lstContratoVeiculo" name="MultaObj.Multa.ContratoVeiculoId" style="width: 100%;" />
								</div>
								<div class="col-6 col-md-3 col-xl-2">
									<label class="label font-weight-bold">Ata do Ve√≠culo</label>
									<input id="lstAtaVeiculo" name="MultaObj.Multa.AtaVeiculoId" style="width: 100%;" />
								</div>
								<div class="col-3 col-md-3 col-xl-3">
									<label class="label font-weight-bold"
										asp-for="MultaObj.Multa.NoFichaVistoria"></label>
									<span class="text-danger font-weight-light"
										asp-validation-for="MultaObj.Multa.NoFichaVistoria"></span>
									<div class="input-group">
										<button class="btn btn-verde btn-sm btnViagem" type="button"
											data-ejtip="Procurar Viagem">
											<i class="fa-duotone fa-route"></i>
										</button>
										<input id="txtNoFichaVistoria" class="form-control form-control-xs" disabled />
										<button class="btn btn-azul btn-sm btnFicha" type="button">
											<i class="fa-duotone fa-clipboard-list"></i>
										</button>
										<input id="txtNoFichaVistoriaEscondido" class="form-control form-control-xs"
											asp-for="MultaObj.Multa.NoFichaVistoria" hidden />
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-12 col-md-6 col-xl-4">
									<label class="label font-weight-bold label-required">Motorista</label>
									<input id="lstMotorista" name="MultaObj.Multa.MotoristaId" style="width: 100%;" />
								</div>
								<div class="col-12 col-md-6 col-xl-4">
									<label class="label font-weight-bold">Contrato do Motorista</label>
									<input id="lstContratoMotorista" name="MultaObj.Multa.ContratoMotoristaId" style="width: 100%;" />
								</div>
							</div>

							<br />

							<!-- UPLOAD E VIEWER -->
							<div class="row">
								<div class="col-md-12 col-xl-10">
									<label class="label font-weight-bold">Notifica√ß√£o de Autua√ß√£o (PDF)</label>

									<ejs-uploader id="uploaderAutuacao" name="UploadFiles" multiple="false"
										autoUpload="true" allowedExtensions=".pdf">
										<e-uploader-asyncsettings saveUrl="/api/MultaUpload/save"
											removeUrl="/api/MultaUpload/remove">
										</e-uploader-asyncsettings>
									</ejs-uploader>

									<input id="txtAutuacaoPDF" class="form-control form-control-xs"
										asp-for="MultaObj.Multa.AutuacaoPDF" hidden />

									<!-- PDFViewer ser√° inicializado via JavaScript ap√≥s CLDR estar pronto -->
									<div id="pdfviewer" style="height:500px;width:100%;margin-top:10px;"></div>
								</div>
							</div>

							<br />

							<div class="row">
								<div class="col-md-12 col-xl-10 control-section">
									<div class="control-wrapper">
										<div>
											<label class="label font-weight-bold">Observa√ß√µes a respeito da
												Multa</label>
											<!-- Kendo Editor (Telerik) - Substituindo Syncfusion -->
											<textarea id="rte" name="MultaObj.Multa.Observacao"
												style="height:150px; width:100%;">@Html.Raw(Model.MultaObj?.Multa?.Observacao ?? "")</textarea>
											<div id="errorMessage">
												<span asp-validation-for="@Model.MultaObj.Multa.Observacao"></span>
											</div>
										</div>
									</div>
								</div>
							</div>

							<br />
							<br />

							<!-- BOT√ïES DE A√á√ÉO -->
							<div class="form-group row">
								<div class="col-12">
									<div class="row">
										<div id="divSubmit" class="col-12 col-md-4 pb-2">
											@if (Model.MultaObj.Multa.MultaId != Guid.Empty)
											{
												<button id="btnSubmit" type="submit" asp-page-handler="Edit"
													asp-route-id="@Model.MultaObj.Multa.MultaId"
													class="btn btn-azul btn-submit-spin form-control">
													<span class="spinner-border spinner-border-sm d-none" role="status"
														aria-hidden="true"></span>
													<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
													<span class="btn-text">Atualizar Autua√ß√£o</span>
												</button>
											}
											else
											{
												<button id="btnSubmit" type="submit" value="Submit"
													asp-page-handler="Submit"
													class="btn btn-azul btn-submit-spin form-control">
													<span class="spinner-border spinner-border-sm d-none" role="status"
														aria-hidden="true"></span>
													<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
													<span class="btn-text">Criar Autua√ß√£o</span>
												</button>
											}
										</div>

										<div class="col-12" hidden>
											@if (Model.MultaObj.Multa.MultaId != Guid.Empty)
											{
												<button id="btnEscondido" type="submit" asp-page-handler="Edit"
													asp-route-id="@Model.MultaObj.Multa.MultaId"
													class="btn btn-azul form-control">
													<span class="d-flex justify-content-center align-items-center">
														<i
															class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i><span>&nbsp;Atualizar
															Autua√ß√£o</span>
													</span>
												</button>
											}
											else
											{
												<button id="btnEscondido" type="submit" value="Submit"
													asp-page-handler="Submit" class="btn btn-azul form-control">
													<span class="d-flex justify-content-center align-items-center">
														<i
															class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i><span>&nbsp;Criar
															Autua√ß√£o</span>
													</span>
												</button>
											}
										</div>

										<div class="col-12 col-md-4">
											<a asp-page="./ListaAutuacao" class="btn btn-ftx-fechar form-control"
												data-ftx-loading>
												<i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i>
												<span>Cancelar Opera√ß√£o</span>
											</a>
										</div>
									</div>
								</div>
							</div>

						</div><!-- /p-3 -->
					</div>
				</div>
			</div>
		</div>
	</div>
</form>

@* ================ Modal Ficha de Vistoria - Padr√£o FrotiX ================ *@
<div class="modal fade" id="modalFicha" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
	data-bs-keyboard="false">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="DynamicModalLabelFicha">
					<i class="fa-duotone fa-file-lines"></i>
					Ficha de Vistoria
				</h4>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
					aria-label="Fechar"></button>
			</div>
			<div class="modal-body text-center">
				<div id="divImagemFicha">
					<img id="imgFichaVistoria" style="max-width: 100%; height: auto;" alt="Ficha de Vistoria" />
				</div>
			</div>
			<div class="modal-footer">
				<button id="btnBaixarPDF" type="button" class="btn btn-modal-confirmar" data-ejtip="Baixar como PDF">
					<span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
					<i class="fa-duotone fa-file-pdf"></i>
					<span class="btn-text">Baixar PDF</span>
				</button>
				<button id="btnFecharModalFicha" type="button" class="btn btn-modal-fechar" data-bs-dismiss="modal"
					data-ejtip="Fechar modal">
					<i class="fa-duotone fa-xmark"></i>
					Fechar
				</button>
			</div>
		</div>
	</div>
</div>


@section ScriptsBlock {

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
		crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
		crossorigin="anonymous"></script>

	<!-- [KENDO] Inicializa√ß√£o dos ComboBoxes/DropDownLists ‚Äî migrados de Syncfusion EJ2 -->
	<script>
		(function () {
			try {
				var dataInfracao = @Html.Raw(Json.Serialize(ViewData["dataInfracao"]));
				var dataStatus = @Html.Raw(Json.Serialize(ViewData["dataStatus"]));
				var dataOrgao = @Html.Raw(Json.Serialize(ViewData["dataOrgao"]));
				var dataTodosEmpenhos = @Html.Raw(Json.Serialize(ViewData["dataTodosEmpenhos"]));
				var dataVeiculo = @Html.Raw(Json.Serialize(ViewData["dataVeiculo"]));
				var dataContratoVeiculos = @Html.Raw(Json.Serialize(ViewData["dataContratoVeiculos"]));
				var dataAtaVeiculos = @Html.Raw(Json.Serialize(ViewData["dataAtaVeiculos"]));
				var dataMotorista = @Html.Raw(Json.Serialize(ViewData["dataMotorista"]));
				var dataContratoMotoristas = @Html.Raw(Json.Serialize(ViewData["dataContratoMotoristas"]));

				// DropDownList: lstInfracao
				$("#lstInfracao").kendoDropDownList({
					dataTextField: "descricao",
					dataValueField: "tipoMultaId",
					optionLabel: "Selecione uma Infra√ß√£o...",
					filter: "contains",
					dataSource: dataInfracao,
					height: 220,
					value: "@(Model.MultaObj.Multa?.TipoMultaId?.ToString() ?? "")"
				});

				// ComboBox: lstStatus
				$("#lstStatus").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "statusId",
					placeholder: "Status...",
					filter: "contains",
					dataSource: dataStatus,
					height: 200,
					value: "@(Model.MultaObj.Multa?.Status?.ToString() ?? "")"
				});

				// ComboBox: lstOrgao
				$("#lstOrgao").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "orgaoId",
					placeholder: "Selecione um √ìrg√£o",
					filter: "contains",
					dataSource: dataOrgao,
					height: 200,
					value: "@(Model.MultaObj.Multa?.OrgaoAutuanteId?.ToString() ?? "")"
				});

				// DropDownList: lstEmpenhos
				$("#lstEmpenhos").kendoDropDownList({
					dataTextField: "notaEmpenho",
					dataValueField: "empenhoMultaId",
					optionLabel: "Selecione um Empenho...",
					filter: "contains",
					dataSource: dataTodosEmpenhos,
					height: 220,
					value: "@(Model.MultaObj.Multa?.EmpenhoMultaId?.ToString() ?? "")"
				});

				// ComboBox: lstVeiculo
				$("#lstVeiculo").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "veiculoId",
					placeholder: "Selecione um Ve√≠culo",
					filter: "contains",
					dataSource: dataVeiculo,
					height: 200,
					value: "@(Model.MultaObj.Multa?.VeiculoId?.ToString() ?? "")"
				});

				// ComboBox: lstContratoVeiculo (disabled)
				$("#lstContratoVeiculo").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "contratoId",
					placeholder: "Selecione um Contrato",
					filter: "contains",
					dataSource: dataContratoVeiculos,
					height: 200,
					enable: false,
					value: "@(Model.MultaObj.Multa?.ContratoVeiculoId?.ToString() ?? "")"
				});

				// ComboBox: lstAtaVeiculo (disabled)
				$("#lstAtaVeiculo").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "ataId",
					placeholder: "Selecione uma Ata",
					filter: "contains",
					dataSource: dataAtaVeiculos,
					height: 200,
					enable: false,
					value: "@(Model.MultaObj.Multa?.AtaVeiculoId?.ToString() ?? "")"
				});

				// ComboBox: lstMotorista
				$("#lstMotorista").kendoComboBox({
					dataTextField: "nome",
					dataValueField: "motoristaId",
					placeholder: "Selecione um Motorista",
					filter: "contains",
					dataSource: dataMotorista,
					height: 200,
					value: "@(Model.MultaObj.Multa?.MotoristaId?.ToString() ?? "")"
				});

				// ComboBox: lstContratoMotorista (disabled)
				$("#lstContratoMotorista").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "contratoId",
					placeholder: "Selecione um Contrato",
					filter: "contains",
					dataSource: dataContratoMotoristas,
					height: 200,
					enable: false,
					value: "@(Model.MultaObj.Multa?.ContratoMotoristaId?.ToString() ?? "")"
				});

			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "kendoControls.init", error);
			}
		})();
	</script>

	<script>
		const MultaId = "@(Model.MultaObj.Multa?.MultaId.ToString() ?? "")";
		window.multaId = MultaId;
	</script>

	<!-- Configura√ß√£o de cultura j√° feita globalmente em _ScriptsBasePlugins.cshtml -->

	<!-- Kendo UI: usa vers√£o global 2025.2.520 de _ScriptsBasePlugins (cultura pt-BR j√° configurada) -->

	<!-- Kendo Editor Helper -->
	<script src="~/js/viagens/kendo-editor-upsert.js" asp-append-version="true"></script>

	<script>
		// ===== UTILIT√ÅRIOS =====
		// Converte valor BR para n√∫mero (ex: "10.000,50" -> 10000.50)
		function parseCurrencyBR(str) {
			try {
				if (!str) return 0;
				let limpo = String(str)
					.replace(/\s/g, '')
					.replace('R$', '')
					.replace(/\./g, '')
					.replace(',', '.');
				return parseFloat(limpo) || 0;
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "parseCurrencyBR", error);
				return 0;
			}
		}

		// Fun√ß√£o de formata√ß√£o de moeda (√∫ltimos 2 d√≠gitos = centavos)
		// Para R$ 1.000,00 digite 100000
		function moeda(input, sep, dec, event) {
			try {
				let digitado = "",
					i = j = 0,
					tamanho = tamanho2 = 0,
					limpo = ajustado = "",
					tecla = window.Event ? event.which : event.keyCode;

				if (tecla === 13 || tecla === 8) return true;

				digitado = String.fromCharCode(tecla);

				if ("0123456789".indexOf(digitado) === -1) return false;

				// Remove o prefixo R$ para processar apenas n√∫meros
				let valorAtual = input.value.replace('R$ ', '');

				for (tamanho = valorAtual.length, i = 0;
					i < tamanho && (valorAtual.charAt(i) === "0" || valorAtual.charAt(i) === dec);
					i++);

				for (limpo = ""; i < tamanho; i++) {
					if ("0123456789".indexOf(valorAtual.charAt(i)) !== -1) {
						limpo += valorAtual.charAt(i);
					}
				}

				limpo += digitado;
				tamanho = limpo.length;

				if (tamanho === 0) {
					input.value = "";
				} else if (tamanho === 1) {
					input.value = "R$ 0" + dec + "0" + limpo;
				} else if (tamanho === 2) {
					input.value = "R$ 0" + dec + limpo;
				} else {
					for (ajustado = "", j = 0, i = tamanho - 3; i >= 0; i--) {
						if (j === 3) {
							ajustado += sep;
							j = 0;
						}
						ajustado += limpo.charAt(i);
						j++;
					}

					input.value = "R$ ";
					tamanho2 = ajustado.length;

					for (i = tamanho2 - 1; i >= 0; i--) {
						input.value += ajustado.charAt(i);
					}

					input.value += dec + limpo.substr(tamanho - 2, tamanho);
				}

				return false;
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "moeda", error);
				return false;
			}
		}

		// Formata n√∫mero para exibi√ß√£o BR (ex: 10000.50 -> "R$ 10.000,50")
		function formatCurrencyBR(valor) {
			try {
				if (!valor && valor !== 0) return "";
				return "R$ " + parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "formatCurrencyBR", error);
				return "";
			}
		}
	</script>

	<script src="~/js/cadastros/upsert_autuacao.js" asp-append-version="true"></script>

	<script>
		// ===== INICIALIZA√á√ÉO DOS CAMPOS DE VALOR =====
		document.addEventListener('DOMContentLoaded', function () {
			try {
				// Carrega valores iniciais formatados nos campos vis√≠veis
				const hdnAteVenc = document.getElementById('hdnValorAteVencimento');
				const hdnPosVenc = document.getElementById('hdnValorPosVencimento');
				const txtAteVenc = document.getElementById('txtValorAteVencimento');
				const txtPosVenc = document.getElementById('txtValorPosVencimento');

				if (hdnAteVenc && txtAteVenc && hdnAteVenc.value) {
					txtAteVenc.value = formatCurrencyBR(hdnAteVenc.value);
				}
				if (hdnPosVenc && txtPosVenc && hdnPosVenc.value) {
					txtPosVenc.value = formatCurrencyBR(hdnPosVenc.value);
				}

				// Antes do submit, converte valores para os campos hidden
				const form = document.querySelector('form');
				if (form) {
					form.addEventListener('submit', function (e) {
						try {
							if (txtAteVenc && hdnAteVenc) {
								hdnAteVenc.value = parseCurrencyBR(txtAteVenc.value);
							}
							if (txtPosVenc && hdnPosVenc) {
								hdnPosVenc.value = parseCurrencyBR(txtPosVenc.value);
							}
						} catch (error) {
							Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "form.submit.valores", error);
						}
					});
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "DOMContentLoaded-Valores", error);
			}
		});
	</script>

	<script>
		// ===== SPINNER NOS BOT√ïES DE SUBMIT =====
		document.addEventListener('DOMContentLoaded', function () {
			try {
				const form = document.querySelector('form');
				const btnSubmit = document.getElementById('btnSubmit');

				if (form && btnSubmit) {
					// Usa o evento submit do form para garantir que o envio aconte√ßa primeiro
					form.addEventListener('submit', function (e) {
						try {
							const spinner = btnSubmit.querySelector('.spinner-border');
							const icon = btnSubmit.querySelector('i');
							const btnText = btnSubmit.querySelector('.btn-text');

							if (spinner && icon) {
								spinner.classList.remove('d-none');
								icon.classList.add('d-none');
								if (btnText) btnText.textContent = 'Salvando...';
								// Desabilita ap√≥s um pequeno delay para permitir o submit
								setTimeout(function () {
									btnSubmit.disabled = true;
								}, 100);
							}
						} catch (error) {
							Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "form.submit.spinner", error);
						}
					});
				}

				const btnBaixarPDF = document.getElementById('btnBaixarPDF');
				if (btnBaixarPDF) {
					btnBaixarPDF.addEventListener('click', function () {
						try {
							const spinner = this.querySelector('.spinner-border');
							const icon = this.querySelector('i');
							const btnText = this.querySelector('.btn-text');

							if (spinner && icon) {
								spinner.classList.remove('d-none');
								icon.classList.add('d-none');
								if (btnText) btnText.textContent = 'Gerando...';

								// Restaura ap√≥s 3 segundos (tempo estimado para gerar PDF)
								setTimeout(() => {
									spinner.classList.add('d-none');
									icon.classList.remove('d-none');
									if (btnText) btnText.textContent = 'Baixar PDF';
								}, 3000);
							}
						} catch (error) {
							Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "btnBaixarPDF.click", error);
						}
					});
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertAutuacao.cshtml", "DOMContentLoaded-Spinners", error);
			}
		});
	</script>
}
