@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@* ========================================================================================
 * ARQUIVO: Pages/Requisitante/Upsert.cshtml
 * OBJETIVO: Formulario de criacao e edicao de requisitantes com Syncfusion DropDownTree para
 *           selecao de Setor Solicitante hierarquico (arvore de setores), validacao de campos
 *           obrigatorios (nome, CPF, email, telefone, setor), mascara de CPF/telefone, checkbox
 *           status Ativo, sistema padrao FrotiX para gerenciar pessoas autorizadas a requisitar veiculos.
 * ENTRADAS: Model FrotiX.Pages.Requisitante.UpsertModel (code-behind C# com propriedades Id, Nome,
 *           CPF, Email, Telefone, SetorSolicitanteId, Status), parametro query string id (edicao
 *           carrega dados existentes via OnGet, ausente indica criacao), ViewData com lista
 *           setores hierarquica carregada no OnGet via IUnitOfWork, formulario HTML5 com input text
 *           (nome, CPF mascara XXX.XXX.XXX-XX, email, telefone mascara (XX) XXXXX-XXXX), Syncfusion
 *           DropDownTree (setor solicitante exibe arvore hierarquica de setores com expand/collapse),
 *           checkbox (status Ativo checked default), botoes Salvar POST form/Cancelar volta /Requisitante
 * SAIDAS: Formulario renderizado com campos preenchidos (edicao) ou vazios (criacao), DropDownTree
 *         funcional exibindo arvore de setores com expand/collapse, validacao HTML5 frontend
 *         (required nos campos obrigatorios, pattern email/telefone), validacao JavaScript
 *         customizada (CPF valido 11 digitos com calculo verificadores, email formato correto,
 *         telefone mascara valida), POST /Requisitante/Upsert (submit envia FormData com validacao
 *         backend, salva entidade Requisitante no banco via IUnitOfWork), redirect para /Requisitante
 *         apos sucesso com notificacao AppToast Verde, erro exibe AppToast Vermelho
 * CHAMADA POR: Link /Requisitante/Upsert (criacao novo sem parametro id), link /Requisitante/Upsert?id=X
 *              (edicao carrega dados existentes), botao + Novo Requisitante da pagina /Requisitante/Index,
 *              botao Editar na coluna Acoes do DataTable tblRequisitante, UpsertModel.OnGet metodo
 *              backend C# executa no carregamento (se id presente carrega dados do banco via
 *              IUnitOfWork, se ausente retorna model vazio, carrega lista setores hierarquica)
 * CHAMA: requisitante_upsert.js (arquivo JavaScript externo com inicializacao do DropDownTree
 *        Syncfusion, handlers de validacao customizada campos, mascara CPF/telefone via jQuery
 *        Mask Plugin, submit handler capturando FormData e enviando via AJAX POST), POST /Requisitante/Upsert
 *        endpoint (backend UpsertModel.OnPost recebe FormData, valida CPF/email/telefone, salva
 *        entidade Requisitante no banco via IUnitOfWork, retorna JSON com success/error),
 *        AppToast.show (notificacoes toast Verde sucesso/Vermelho erro), funcoes utilitarias
 *        JavaScript (validarCPF calculo verificadores, validarEmail regex, formatarTelefone mascara)
 * DEPENDENCIAS: ASP.NET Core Razor Pages 8.0, jQuery 3.7.1, Bootstrap 5.3.8 (cards, form-control,
 *               form-label, form-check checkbox, grid row/col, botoes), Syncfusion EJ2 ASP.NET Core
 *               (DropDownTree para exibir arvore hierarquica de setores com expand/collapse,
 *               configuracao TreeSettings para hierarquia parentId), jQuery Mask Plugin (mascara
 *               CPF XXX.XXX.XXX-XX, telefone (XX) XXXXX-XXXX ou (XX) XXXX-XXXX), requisitante_upsert.js
 *               (arquivo JavaScript externo), AppToast.js (notificacoes toast), Font Awesome 6
 *               Duotone (icone fa-user-check), IUnitOfWork (Entity Framework Core para acesso ao banco)
 * OBSERVACOES: 415 linhas com formulario completo padrao FrotiX (layout responsivo col-md-6, cards
 *              arredondados, labels em negrito, inputs com form-control, validacao frontend/backend).
 *              DropDownTree Syncfusion exibe arvore hierarquica de Setores Solicitantes permitindo
 *              selecionar setor especifico navegando pela estrutura organizacional (Diretoria >
 *              Coordenacao > Divisao > Secao). Sistema gerencia pessoas autorizadas a requisitar
 *              veiculos para viagens oficiais (servidores, gestores, diretores) vinculando requisitante
 *              a setor solicitante da organizacao. Requisitantes sao usados na Agenda de viagens
 *              como solicitantes das viagens. Validacao CPF completa: verifica 11 digitos numericos,
 *              calcula digitos verificadores, impede CPFs invalidos (000.000.000-00, sequencias repetidas).
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@

@model FrotiX.Pages.Requisitante.UpsertModel

@{
	ViewData["Title"] = "Requisitantes";
	ViewData["PageName"] = "requisitante_upsert";
	ViewData["Heading"] = "<i class='fa-duotone fa-user-tie'></i> Cadastros: <span class='fw-300'>Requisitantes</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-user-tie";

	var isEdit = Model.RequisitanteObj.Requisitante.RequisitanteId != Guid.Empty;
	var pageTitle = isEdit ? "Atualizar Requisitante" : "Criar Requisitante";
}

@section HeadBlock {
	<style>
		/* ====== HEADER AZUL PADRÃO FROTIX ====== */
		.ftx-card-header {
			background-color: #3D5771;
			padding: 1rem 1.5rem;
			display: flex;
			align-items: center;
			justify-content: space-between;
			flex-wrap: wrap;
			gap: 1rem;
			border-radius: 8px 8px 0 0;
			position: relative;
			overflow: hidden;
		}

		.ftx-card-header::before {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 100%;
			height: 100%;
			background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
			animation: shimmer 3s infinite;
		}

		@@keyframes shimmer {
			0% { left: -100%; }
			100% { left: 100%; }
		}

		.ftx-card-header .titulo-paginas {
			color: #fff !important;
			font-family: 'Outfit', sans-serif;
			font-weight: 900;
			font-size: 1.5rem;
			margin: 0;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
			position: relative;
			z-index: 1;
		}

		.ftx-card-header .titulo-paginas i.fa-duotone {
			font-size: 1.75rem;
			filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
		}

		.ftx-card-actions {
			position: relative;
			z-index: 1;
		}

		/* ====== OUTLINE BRANCO NO BOTÃO LARANJA DO HEADER ====== */
		.ftx-card-header .btn-fundo-laranja {
			outline: 2px solid rgba(255, 255, 255, 0.5) !important;
			outline-offset: 1px;
			transition: all 0.2s ease;
		}

		.ftx-card-header .btn-fundo-laranja:hover {
			outline: 2px solid rgba(255, 255, 255, 0.8) !important;
			outline-offset: 2px;
		}

		/* ====== PANEL CONTENT ====== */
		.panel-content {
			padding: 1.25rem;
			background: #f8f9fa;
		}

		/* ====== SEÇÃO COM CARD LEVE ====== */
		.ftx-section {
			background: #fff;
			border-radius: 8px;
			margin-bottom: 1rem;
			box-shadow: 0 1px 3px rgba(0,0,0,0.06);
			overflow: hidden;
		}

		.ftx-section-header {
			background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
			padding: 0.6rem 1rem;
			border-bottom: 1px solid #e9ecef;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.ftx-section-header i {
			--fa-primary-color: #3D5771;
			--fa-secondary-color: #6b8ba3;
			--fa-secondary-opacity: 0.7;
			font-size: 0.95rem;
		}

		.ftx-section-header span {
			font-family: 'Outfit', sans-serif;
			font-weight: 600;
			font-size: 0.85rem;
			color: #3D5771;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.ftx-section-body {
			padding: 1rem;
		}

		/* ====== FORM CONTROLS - ALTURA UNIFORME ====== */
		.ftx-form-control {
			height: 38px !important;
			padding: 0.375rem 0.75rem !important;
			font-size: 0.875rem !important;
			border-radius: 0.375rem;
			border: 1px solid #ced4da;
		}

		.ftx-form-control:focus {
			border-color: #3D5771;
			box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.25);
		}

		/* ====== LABELS ====== */
		.ftx-label {
			font-weight: 600;
			font-size: 0.8rem;
			color: #495057;
			margin-bottom: 0.25rem;
			display: block;
		}

		/* ====== DROPDOWN TREE - ALTURA UNIFORME ====== */
		.e-ddl.e-input-group,
		.e-ddl.e-input-group.e-control-wrapper {
			height: 38px !important;
		}

		.e-ddl.e-input-group input.e-input,
		.e-ddl.e-input-group.e-control-wrapper input.e-input {
			height: 36px !important;
			font-size: 0.875rem !important;
		}

		/* ====== CHECKBOX ESTILIZADO ====== */
		.ftx-config-card {
			background: #f8f9fa;
			border: 1px solid #e9ecef;
			border-radius: 8px;
			padding: 0.75rem 1rem;
			display: flex;
			align-items: center;
			gap: 0.6rem;
			transition: all 0.2s ease;
			cursor: pointer;
		}

		.ftx-config-card:hover {
			border-color: #3D5771;
			background: #fff;
		}

		.ftx-config-card .form-check-input {
			width: 1.1rem;
			height: 1.1rem;
			cursor: pointer;
			margin: 0;
		}

		.ftx-config-card .form-check-input:checked {
			background-color: #38A169;
			border-color: #38A169;
		}

		.ftx-config-card label {
			font-weight: 500;
			font-size: 0.85rem;
			color: #495057;
			cursor: pointer;
			margin: 0;
		}

		/* ====== BOTÕES DE AÇÃO ====== */
		.ftx-actions-row {
			display: flex;
			gap: 1rem;
			margin-top: 1.5rem;
		}

		.ftx-actions-row .btn {
			min-width: 180px;
			height: 42px;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
		}

		/* ====== RESPONSIVO ====== */
		@@media (max-width: 768px) {
			.ftx-card-header {
				flex-direction: column;
				text-align: center;
			}

			.ftx-card-header .titulo-paginas {
				font-size: 1.2rem;
			}

			.ftx-actions-row {
				flex-direction: column;
			}

			.ftx-actions-row .btn {
				width: 100%;
			}
		}
	</style>
}

<form method="post" asp-action="Upsert">
	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel">
				<div class="panel-container show">

					<!-- HEADER AZUL PADRÃO FROTIX -->
					<div class="ftx-card-header">
						<h2 class="titulo-paginas">
							<i class="fa-duotone fa-user-tie"></i>
							@pageTitle
						</h2>
						<div class="ftx-card-actions">
							<a href="/Requisitante" class="btn btn-fundo-laranja" data-ftx-loading>
								<i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i>
								Voltar à Lista
							</a>
						</div>
					</div>

					<!-- CONTEÚDO -->
					<div class="panel-content">
						<div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

						@if (isEdit)
						{
							<input type="hidden" asp-for="RequisitanteObj.Requisitante.RequisitanteId" />
						}

						<!-- SEÇÃO: DADOS DO REQUISITANTE -->
						<div class="ftx-section">
							<div class="ftx-section-header">
								<i class="fa-duotone fa-id-card"></i>
								<span>Dados do Requisitante</span>
							</div>
							<div class="ftx-section-body">
								<div class="row g-3">
									<div class="col-12 col-md-2">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Ponto"></label>
										<span class="text-danger small" asp-validation-for="RequisitanteObj.Requisitante.Ponto"></span>
										<input class="form-control ftx-form-control" asp-for="RequisitanteObj.Requisitante.Ponto" placeholder="Ex: p_123" />
									</div>

									<div class="col-12 col-md-4">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Nome"></label>
										<span class="text-danger small" asp-validation-for="RequisitanteObj.Requisitante.Nome"></span>
										<input class="form-control ftx-form-control" asp-for="RequisitanteObj.Requisitante.Nome" placeholder="Nome do requisitante" />
									</div>

									<div class="col-6 col-md-2">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Ramal"></label>
										<span class="text-danger small" asp-validation-for="RequisitanteObj.Requisitante.Ramal"></span>
										<input class="form-control ftx-form-control" asp-for="RequisitanteObj.Requisitante.Ramal" type="number" placeholder="Ramal" />
									</div>

									<div class="col-12 col-md-4">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Email"></label>
										<span class="text-danger small" asp-validation-for="RequisitanteObj.Requisitante.Email"></span>
										<input class="form-control ftx-form-control" asp-for="RequisitanteObj.Requisitante.Email" type="email" placeholder="email@exemplo.com" />
									</div>
								</div>

								<div class="row g-3 mt-2">
									<div class="col-12 col-md-6">
										<label class="ftx-label">Setor Solicitante</label>
										<input id="ddtree"
											   name="RequisitanteObj.Requisitante.SetorSolicitanteId"
											   style="width: 100%;" />
									</div>
								</div>
							</div>
						</div>

						<!-- SEÇÃO: STATUS -->
						<div class="ftx-section">
							<div class="ftx-section-header">
								<i class="fa-duotone fa-toggle-on"></i>
								<span>Status</span>
							</div>
							<div class="ftx-section-body">
								<div class="ftx-config-card" style="max-width: 200px;">
									<input type="checkbox" class="form-check-input" asp-for="RequisitanteObj.Requisitante.Status" id="chkStatus" />
									<label for="chkStatus">Ativo</label>
								</div>
							</div>
						</div>

						<!-- BOTÕES DE AÇÃO -->
						<div class="ftx-actions-row">
							@if (isEdit)
							{
								<button type="submit"
										asp-page-handler="Edit"
										asp-route-id="@Model.RequisitanteObj.Requisitante.RequisitanteId"
										class="btn btn-azul btn-submit-spin"
										data-ejtip="Atualizar Requisitante">
									<i class="fa-duotone fa-floppy-disk icon-pulse"></i>
									Atualizar Requisitante
								</button>
							}
							else
							{
								<button type="submit"
										value="Submit"
										asp-page-handler="Submit"
										class="btn btn-azul btn-submit-spin"
										data-ejtip="Criar Requisitante">
									<i class="fa-duotone fa-floppy-disk icon-pulse"></i>
									Criar Requisitante
								</button>
							}

							<a asp-page="./Index" class="btn btn-ftx-fechar" data-ftx-loading>
								<i class="fa-duotone fa-circle-xmark icon-pulse"></i>
								Cancelar Operação
							</a>
						</div>

					</div> <!-- /.panel-content -->
				</div> <!-- /.panel-container -->
			</div> <!-- /.panel -->
		</div> <!-- /.col-xl-12 -->
	</div> <!-- /.row -->
</form>

@section ScriptsBlock {
	<script type="text/javascript">
		(function () {
			try {
				var dataSource = @Html.Raw(Json.Serialize(ViewData["dataSource"]));
				var setorId = "@Model.RequisitanteObj.Requisitante.SetorSolicitanteId";

				KendoDDTHelper.initHierarchical({
					selector: "#ddtree",
					flatData: dataSource,
					idField: "setorSolicitanteId",
					parentField: "setorPaiId",
					textField: "nome",
					valueField: "setorSolicitanteId",
					placeholder: "Selecione um Setor",
					value: setorId,
					change: function (e) {
						try {
							var ddt = KendoDDTHelper.getInstance("#ddtree");
							if (ddt) {
								console.info(ddt.value() + " - " + ddt.text());
							}
						} catch (error) {
							Alerta.TratamentoErroComLinha("Upsert.cshtml", "valueChange", error);
						}
					}
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "kendoDDT.init", error);
			}
		})();	</script>
}