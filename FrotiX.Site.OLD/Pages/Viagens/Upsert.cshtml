@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers
@using Syncfusion.EJ2.DropDowns;
@using Syncfusion.EJ2;
@using Syncfusion.Data;
@using Syncfusion.EJ2.DocumentEditor;

@model FrotiX.Pages.Viagens.UpsertModel

@{
    // Declaração das variáveis que você vai usar no preview
    bool hasBytes = Model.ViagemObj.Viagem.FichaVistoria != null;
    // Garante que o browser não fique carregando uma versão em cache
    string defaultImg = Url.Content("~/Images/FichaAmarelaNova.JPG")
    + "?t=" + DateTime.Now.Ticks;

    // Pré-calcula src da imagem
    string imgSrc;

    if (hasBytes)
    {
        imgSrc = "data:image/jpeg;base64,"
                                         + Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria);
    }
    else
    {
        imgSrc = defaultImg;
    }
}

@{
    string conteudoSfdt = Model.ViagemObj.Viagem.DescricaoViagemWord != null
                    ? System.Text.Encoding.UTF8.GetString(Model.ViagemObj.Viagem.DescricaoViagemWord)
    : "";
}

@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "Viagens";
    ViewData["PageName"] = "viagens_upsert";
    ViewData["Heading"] = "";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-route";

    ViewData["fieldsMotorista"] = new ComboBoxFieldSettings
    {
        Text = "Nome",
        Value = "MotoristaId"
    };

    ViewData["itemTemplate"] = @"
    <div class='d-flex align-items-center'>
        <img src='${Foto}' style='width:40px; height:40px; border-radius:50%; margin-right:10px;' />
        <span>${Nome}</span>
    </div>";

    ViewData["valueTemplate"] = @"
    <div class='d-flex align-items-center'>
        <img src='${Foto}' style='width:30px; height:30px; border-radius:50%; margin-right:10px;' />
        <span>${Nome}</span>
    </div>";
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />
    <link href="~/css/viagens/viagem-upsert.css" rel="stylesheet" asp-append-version="true" />
}

<!-- FORM PRINCIPAL (MVC) -->
<form method="post" asp-action="Upsert" onkeypress="stopEnterSubmitting(event)" enctype="multipart/form-data">
    <!-- Utiliza container-fluid para maior largura e alinhamento à esquerda -->
    <div class="container-fluid" style="padding-left: 0; margin-left: 0;">
        <div class="row">
            <div class="col-xl-12">
                <div id="panel-1" class="panel ftx-card-styled">
                    <div class="panel-container show">

                        <!-- HEADER DO CARD -->
                        <div class="ftx-card-header">
                            @if (Model.ViagemObj.Viagem.Status == "Realizada" || Model.ViagemObj.Viagem.Status ==
                                                        "Cancelada")
                            {
                                <h2 class="titulo-paginas">
                                    <i class="fa-duotone fa-suitcase-rolling"></i>
                                    Viagem Realizada/Cancelada - Edição não permitida
                                </h2>
                            }
                            else
                            {
                                <h2 class="titulo-paginas">
                                    <i class="fa-duotone fa-suitcase-rolling"></i>
                                    @(Model.ViagemObj.Viagem.ViagemId != Guid.Empty ? "Atualizar" : "Criar") Viagem
                                </h2>
                            }
                            <div class="ftx-card-actions">
                                <a href="javascript:void(0)" class="btn btn-fundo-laranja" id="btnVoltarLista"
                                    data-ftx-loading>
                                    <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i>
                                    Voltar à Lista
                                </a>
                            </div>
                        </div>

                        <div id="divPainel" class="panel-content">
                            @{
                                // Verificar se viagem está finalizada (Realizada ou Cancelada)
                                bool viagemFinalizada = Model.ViagemObj?.Viagem?.Status == "Realizada" ||
                                Model.ViagemObj?.Viagem?.Status == "Cancelada";

                                // Verificar se é edição de viagem com dados do FrotiX Mobile
                                bool isEdicaoViagemMobile = Model.ViagemObj?.Viagem?.ViagemId != Guid.Empty &&
                                (Model.ViagemObj?.Viagem?.Rubrica != null ||
                                Model.ViagemObj?.Viagem?.RubricaFinal != null);
                            }
                            <input type="hidden" asp-for="@Model.ViagemObj.Viagem.ViagemId" id="txtViagemId" />

                            <!-- Campo hidden para manter a imagem existente caso não haja novo upload -->
                            @if (Model.ViagemObj?.Viagem?.FichaVistoria != null)
                            {
                                <input type="hidden" asp-for="FichaVistoria"
                                    value="@Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria)" />
                            }

                            <div class="p-3">

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 1: PERÍODO DA VIAGEM
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-periodo">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-calendar-range"></i>
                                        Período da Viagem
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.NoFichaVistoria">
                                                Nº Ficha Vistoria
                                            </label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.NoFichaVistoria"></span>
                                            @* Container para alternar entre campo numérico e texto mobile *@
                                            @{
                                                // Determinar se é nova viagem ou edição
                                                bool isNovaViagem = Model.ViagemObj?.Viagem?.ViagemId == null ||
                                                Model.ViagemObj.Viagem.ViagemId == Guid.Empty;
                                                // Se é edição, verificar se é viagem mobile (NoFichaVistoria = 0 ou null)
                                                bool isViagemMobile = !isNovaViagem &&
                                                (Model.ViagemObj?.Viagem?.NoFichaVistoria == null ||
                                                Model.ViagemObj.Viagem.NoFichaVistoria == 0);
                                                // Mostrar campo numérico se: nova viagem OU edição de viagem web
                                                bool mostrarCampoNumerico = isNovaViagem || !isViagemMobile;
                                            }
                                            <div id="containerNoFichaVistoria">
                                                <input id="txtNoFichaVistoria" class="form-control"
                                                    asp-for="ViagemObj.Viagem.NoFichaVistoria"
                                                    style="@(mostrarCampoNumerico ? "" : "display: none;")" />
                                                <input id="txtNoFichaVistoriaMobile" class="form-control ftx-calculated"
                                                    value="(mobile)" disabled
                                                    style="@(mostrarCampoNumerico ? "display: none;" : "")"
                                                    title="Viagem registrada via FrotiX Mobile" />
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label ftx-required"
                                                asp-for="ViagemObj.Viagem.DataInicial">
                                                Data Inicial
                                            </label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.DataInicial"></span>
                                            <input id="txtDataInicial" name="ViagemObj.Viagem.DataInicial" 
                                                style="width: 100%; height: 38px;" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label ftx-required" asp-for="ViagemObj.Viagem.HoraInicio">
                                                Hora Início
                                            </label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.HoraInicio"></span>
                                            <input id="txtHoraInicial" name="ViagemObj.Viagem.HoraInicio" 
                                                style="width: 100%; height: 38px;" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.DataFinal">
                                                Data Final
                                            </label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.DataFinal"></span>
                                            <input id="txtDataFinal" name="ViagemObj.Viagem.DataFinal" 
                                                placeholder="dd/MM/yyyy"
                                                style="width: 100%; height: 38px;" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.HoraFim">
                                                Hora Fim
                                            </label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.HoraFim"></span>
                                            <input id="txtHoraFinal" name="ViagemObj.Viagem.HoraFim" 
                                                placeholder="HH:mm"
                                                style="width: 100%; height: 38px;" />
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label">Duração</label>
                                            <input id="txtDuracao" class="form-control ftx-calculated" disabled
                                                data-ejtip="Se a <span style='color: #A0522D; font-weight: bold;'>Duração</span> estiver alta, revise o horário e datas" />
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 2: TRAJETO
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-trajeto">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-route"></i>
                                        Trajeto
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-4">
                                            <label class="ftx-label ftx-required"
                                                asp-for="ViagemObj.Viagem.Finalidade">Finalidade</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.Finalidade"></span>
                                            <input id="ddlFinalidade"
                                                name="ViagemObj.Viagem.Finalidade"
                                                style="width: 100%;" />
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <label class="ftx-label ftx-required"
                                                asp-for="ViagemObj.Viagem.Origem">Origem</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.Origem"></span>
                                            <ejs-combobox id="cmbOrigem" ejs-for="ViagemObj.Viagem.Origem"
                                                dataSource="@ViewData["ListaOrigem"]"
                                                placeholder="Selecione ou digite a Origem" allowFiltering="true"
                                                filterType="Contains" allowCustom="true" popupHeight="220px">
                                            </ejs-combobox>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <label class="ftx-label ftx-required"
                                                asp-for="ViagemObj.Viagem.Destino">Destino</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.Destino"></span>
                                            <ejs-combobox id="cmbDestino" ejs-for="ViagemObj.Viagem.Destino"
                                                dataSource="@ViewData["ListaDestino"]"
                                                placeholder="Selecione ou digite o destino" allowFiltering="true"
                                                filterType="Contains" allowCustom="true" popupHeight="220px">
                                            </ejs-combobox>
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO EVENTO (ESCONDIDA - aparece quando finalidade = Evento)
                                     ═══════════════════════════════════════════════════════════ -->
                                <div id="divEvento" class="ftx-section ftx-section-evento esconde-diveventos">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-calendar-star"></i>
                                        Evento
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-6">
                                            <label class="ftx-label">Nome do Evento</label>
                                            <div class="d-flex align-items-end gap-2">
                                                <div class="flex-grow-1">
                                                    <input id="ddlEvento"
                                                        name="ViagemObj.Viagem.EventoId"
                                                        style="width: 100%;" />
                                                </div>
                                                <a class="btn btn-sm fundo-chocolate text-white" id="btnEvento"
                                                    style="height: 38px; display: flex; align-items: center;"
                                                    title="Adicionar Evento" data-bs-toggle="modal"
                                                    data-bs-target="#modalEvento">
                                                    <i class="fa-duotone fa-calendar-plus"></i>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-2">
                                            <label class="ftx-label">Data Início</label>
                                            <input id="txtEventoDataInicio" class="form-control ftx-calculated" readonly />
                                        </div>
                                        <div class="col-12 col-md-2">
                                            <label class="ftx-label">Data Fim</label>
                                            <input id="txtEventoDataFim" class="form-control ftx-calculated" readonly />
                                        </div>
                                        <div class="col-12 col-md-2">
                                            <label class="ftx-label">Qtd Participantes</label>
                                            <input id="txtEventoQtdParticipantes" class="form-control ftx-calculated" readonly />
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 3: MOTORISTA E VEÍCULO
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-veiculo">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-car-side"></i>
                                        Motorista e Veículo
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">Motorista</label>
                                            <input id="cmbMotorista" name="ViagemObj.Viagem.MotoristaId" style="width: 100%;" />
                                        </div>
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">Veículo</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="flex-grow-1">
                                                    <ejs-combobox id="cmbVeiculo" placeholder="Selecione um Veículo"
                                                        allowFiltering="true" filterType="Contains"
                                                        dataSource="@ViewData["dataVeiculo"]" popupHeight="200px"
                                                        width="100%" showClearButton="true"
                                                        ejs-for="@Model.ViagemObj.Viagem.VeiculoId"
                                                        change="VeiculoValueChange">
                                                        <e-combobox-fields text="Descricao"
                                                            value="VeiculoId"></e-combobox-fields>
                                                    </ejs-combobox>
                                                </div>
                                                <!-- Botão Ocorrências - QUADRADO 42x42 -->
                                                <button type="button" id="btnOcorrenciasVeiculo"
                                                    class="btn btn-ocorrencias-viagem text-white disabled" disabled
                                                    title="Nenhuma ocorrência em aberto"
                                                    style="position: relative; flex-shrink: 0; width: 42px; height: 42px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fa-duotone fa-car-burst" style="font-size: 1.2rem;"></i>
                                                    <span id="badgeOcorrenciasVeiculo"
                                                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                                        style="display: none; font-size: 0.65rem;">
                                                        0
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Km Atual - MENOR (col-4 ao invés de col-6) -->
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.KmAtual">Km Atual</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.KmAtual"></span>
                                            <input readonly id="txtKmAtual" class="form-control ftx-calculated"
                                                asp-for="ViagemObj.Viagem.KmAtual" />
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label ftx-required"
                                                asp-for="ViagemObj.Viagem.KmInicial">Km Inicial</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.KmInicial"></span>
                                            <input id="txtKmInicial" class="form-control"
                                                asp-for="ViagemObj.Viagem.KmInicial" type="number" />
                                        </div>
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label" asp-for="ViagemObj.Viagem.KmFinal">Km Final</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.KmFinal"></span>
                                            <input id="txtKmFinal" class="form-control"
                                                asp-for="ViagemObj.Viagem.KmFinal" type="number" />
                                        </div>
                                        <div class="col-4 col-md-2">
                                            <label class="ftx-label">Km Percorrido</label>
                                            <input id="txtKmPercorrido" class="form-control ftx-calculated"
                                                type="number" disabled
                                                data-ejtip="Se a <span style='color: #A0522D; font-weight: bold;'>Quilometragem</span> estiver alta, revise os Km Inicial e Final" />
                                        </div>
                                    </div>
                                </div>
                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 4: COMBUSTÍVEL
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-combustivel">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-gas-pump"></i>
                                        Combustível
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <label class="ftx-label ftx-required">Combustível Inicial</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.CombustivelInicial"></span>
                                            <input id="ddlCombustivelInicial"
                                                name="ViagemObj.Viagem.CombustivelInicial"
                                                style="width: 100%;" />
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <label class="ftx-label">Combustível Final</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.CombustivelFinal"></span>
                                            <input id="ddlCombustivelFinal"
                                                name="ViagemObj.Viagem.CombustivelFinal"
                                                style="width: 100%;" />
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 4B: DOCUMENTOS E ITENS ENTREGUES
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-documentos">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-box-check"></i>
                                        Documentos e Itens Entregues
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusDocumento"
                                                    name="ViagemObj.Viagem.StatusDocumento"
                                                    value="@(Model.ViagemObj?.Viagem?.StatusDocumento == "Entregue" ? "Entregue" : "")" />
                                                <input class="form-check-input" type="checkbox" id="chkStatusDocumento"
                                                    @(Model.ViagemObj?.Viagem?.StatusDocumento == "Entregue" ? "checked" : "") @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidStatusDocumento').value = this.checked ? 'Entregue' : '';">
                                                <label class="form-check-label fw-semibold" for="chkStatusDocumento">
                                                    <i class="fa-duotone fa-file-check me-1 text-success"></i>
                                                    Documento
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusCartaoAbastecimento"
                                                    name="ViagemObj.Viagem.StatusCartaoAbastecimento"
                                                    value="@(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimento == "Entregue" ? "Entregue" : "")" />
                                                <input class="form-check-input" type="checkbox"
                                                    id="chkStatusCartaoAbastecimento"
                                                    @(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimento == "Entregue" ?
                                                                                                        "checked" : "") @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidStatusCartaoAbastecimento').value = this.checked ? 'Entregue' : '';">
                                                <label class="form-check-label fw-semibold"
                                                    for="chkStatusCartaoAbastecimento">
                                                    <i class="fa-duotone fa-credit-card me-1 text-success"></i>
                                                    Cartão Abastecimento
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCintaEntregue"
                                                    name="ViagemObj.Viagem.CintaEntregue"
                                                    value="@(Model.ViagemObj?.Viagem?.CintaEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCintaEntregue"
                                                    @(Model.ViagemObj?.Viagem?.CintaEntregue == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidCintaEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCintaEntregue">
                                                    <i class="fa-duotone fa-link me-1 text-info"></i>
                                                    Cinta Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidTabletEntregue"
                                                    name="ViagemObj.Viagem.TabletEntregue"
                                                    value="@(Model.ViagemObj?.Viagem?.TabletEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkTabletEntregue"
                                                    @(Model.ViagemObj?.Viagem?.TabletEntregue == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidTabletEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkTabletEntregue">
                                                    <i class="fa-duotone fa-tablet me-1 text-info"></i>
                                                    Tablet Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCaboEntregue"
                                                    name="ViagemObj.Viagem.CaboEntregue"
                                                    value="@(Model.ViagemObj?.Viagem?.CaboEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCaboEntregue"
                                                    @(Model.ViagemObj?.Viagem?.CaboEntregue == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidCaboEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCaboEntregue">
                                                    <i class="fa-duotone fa-plug me-1 text-warning"></i>
                                                    Cabo Entregue
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidArlaEntregue"
                                                    name="ViagemObj.Viagem.ArlaEntregue"
                                                    value="@(Model.ViagemObj?.Viagem?.ArlaEntregue == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkArlaEntregue"
                                                    @(Model.ViagemObj?.Viagem?.ArlaEntregue == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidArlaEntregue').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkArlaEntregue">
                                                    <i class="fa-duotone fa-gas-pump me-1 text-success"></i>
                                                    Arla Entregue
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 4C: OCORRÊNCIAS DA VIAGEM
                                     Só habilitada quando um veículo for selecionado
                                     ═══════════════════════════════════════════════════════════ -->
                                @{
                                    bool temVeiculoSelecionado = Model.ViagemObj?.Viagem?.VeiculoId != null &&
                                    Model.ViagemObj.Viagem.VeiculoId != Guid.Empty;
                                }
                                <div id="secaoOcorrenciasUpsert"
                                    class="ftx-section ftx-section-ocorrencias @(temVeiculoSelecionado ? "" : "ftx-section-disabled")">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-triangle-exclamation"></i>
                                        Ocorrências da Viagem
                                        <span id="badgeOcorrenciasUpsert" class="badge bg-danger ms-2"
                                            style="display: none;">0</span>
                                    </div>

                                    <!-- Aviso para selecionar veículo -->
                                    <div id="avisoSelecionarVeiculo" class="alert alert-warning py-2 mb-3"
                                        style="@(temVeiculoSelecionado ? "display: none;" : "")">
                                        <i class="fa-duotone fa-info-circle me-1"></i>
                                        Selecione um <strong>veículo</strong> para registrar ocorrências.
                                    </div>

                                    <!-- Botão Adicionar Ocorrência -->
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <button type="button" class="btn btn-fundo-laranja"
                                                id="btnAdicionarOcorrenciaUpsert" @(temVeiculoSelecionado &&
                                                                                                                                  !viagemFinalizada ? "" : "disabled")>
                                                <i class="fa-duotone fa-plus me-1"></i>
                                                Registrar Ocorrência
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Lista de Ocorrências -->
                                    <div id="listaOcorrenciasUpsert" class="ocorrencias-lista">
                                        <div id="semOcorrenciasUpsert" class="text-center text-muted py-4">
                                            <i class="fa-duotone fa-circle-check fa-2x mb-2 text-success"></i>
                                            <p class="mb-0">Nenhuma ocorrência registrada</p>
                                        </div>
                                    </div>

                                    <!-- Campo hidden para armazenar ocorrências em JSON -->
                                    <input type="hidden" id="hiddenOcorrenciasJson" name="OcorrenciasJson" />
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 5: SOLICITANTE
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-solicitante">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-building-user"></i>
                                        Solicitante
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">Requisitante</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="flex-grow-1">
                                                    <ejs-combobox id="cmbRequisitante"
                                                        placeholder="Selecione um Requisitante..." allowFiltering="true"
                                                        filterType="Contains" dataSource="@ViewData["dataRequisitante"]"
                                                        popupHeight="200px" width="100%" showClearButton="true"
                                                        change="RequisitanteValueChange"
                                                        ejs-for="@Model.ViagemObj.Viagem.RequisitanteId">
                                                        <e-combobox-fields text="Requisitante"
                                                            value="RequisitanteId"></e-combobox-fields>
                                                    </ejs-combobox>
                                                </div>
                                                <a class="btn btn-sm fundo-chocolate text-white" id="btnRequisitante"
                                                    style="height: 38px; display: flex; align-items: center;"
                                                    data-bs-toggle="modal" data-bs-target="#modalRequisitante"
                                                    title="Adicionar Requisitante">
                                                    <i class="fa-duotone fa-user-plus"></i>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <label class="ftx-label ftx-required"
                                                asp-for="ViagemObj.Viagem.RamalRequisitante">Ramal</label>
                                            <span class="text-danger font-weight-light"
                                                asp-validation-for="ViagemObj.Viagem.RamalRequisitante"></span>
                                            <input id="txtRamalRequisitante" class="form-control"
                                                asp-for="ViagemObj.Viagem.RamalRequisitante" />
                                        </div>
                                        <div class="col-12 col-md-5">
                                            <label class="ftx-label ftx-required">Setor Solicitante</label>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="flex-grow-1">
                                                    <ejs-dropdowntree id="ddtSetor" placeholder="Selecione um Setor"
                                                        enabled="false" sortOrder="Ascending" showCheckBox="false"
                                                        allowMultiSelection="false" allowFiltering="true"
                                                        filterType="Contains" filterBarPlaceholder="Procurar..."
                                                        ejs-for="@Model.ViagemObj.Viagem.SetorSolicitanteId">
                                                        <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                            value="SetorSolicitanteId" text="Nome"
                                                            parentValue="SetorPaiId"
                                                            hasChildren="HasChild"></e-dropdowntree-fields>
                                                    </ejs-dropdowntree>
                                                </div>
                                                <a hidden class="btn btn-verde btn-sm text-white" id="btnSetor"
                                                    style="height: 38px; display: flex; align-items: center;"
                                                    data-bs-toggle="modal" data-bs-target="#modalSetor"
                                                    title="Adicionar Setor">
                                                    <i class="fa-duotone fa-house-medical"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 6: DESCRIÇÃO DA VIAGEM
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-descricao">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-file-lines"></i>
                                        Descrição da Viagem
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="ftx-label">Passageiros / Carga</label>
                                            <input type="hidden" id="DescricaoViagemWordBase64"
                                                name="DescricaoViagemWordBase64" />
                                            <!-- Kendo Editor - Substitui Syncfusion RTE -->
                                            <textarea id="rte" name="ViagemObj.Viagem.Descricao"
                                                style="height:320px; width:100%;">@Html.Raw(Model.ViagemObj?.Viagem?.Descricao ?? "")</textarea>
                                            <div id="errorMessage">
                                                <span asp-validation-for="@Model.ViagemObj.Viagem.Descricao"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     SEÇÃO 7B: DOCUMENTOS E ITENS DEVOLVIDOS
                                     Para viagens que já serão fechadas na criação
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="ftx-section ftx-section-devolvidos">
                                    <div class="ftx-section-title">
                                        <i class="fa-duotone fa-box-archive"></i>
                                        Documentos e Itens Devolvidos
                                        <small class="text-muted fw-normal ms-2">(preencher se a viagem já foi
                                            finalizada)</small>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusDocumentoFinal"
                                                    name="ViagemObj.Viagem.StatusDocumentoFinal"
                                                    value="@(Model.ViagemObj?.Viagem?.StatusDocumentoFinal == "Devolvido" ? "Devolvido" : "")" />
                                                <input class="form-check-input" type="checkbox"
                                                    id="chkStatusDocumentoFinal"
                                                    @(Model.ViagemObj?.Viagem?.StatusDocumentoFinal == "Devolvido" ?
                                                                                                        "checked" : "") @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidStatusDocumentoFinal').value = this.checked ? 'Devolvido' : '';">
                                                <label class="form-check-label fw-semibold"
                                                    for="chkStatusDocumentoFinal">
                                                    <i class="fa-duotone fa-file-check me-1 text-info"></i>
                                                    Documento
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidStatusCartaoAbastecimentoFinal"
                                                    name="ViagemObj.Viagem.StatusCartaoAbastecimentoFinal"
                                                    value="@(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimentoFinal == "Devolvido" ? "Devolvido" : "")" />
                                                <input class="form-check-input" type="checkbox"
                                                    id="chkStatusCartaoAbastecimentoFinal"
                                                    @(Model.ViagemObj?.Viagem?.StatusCartaoAbastecimentoFinal ==
                                                                                                        "Devolvido" ? "checked" : "") @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidStatusCartaoAbastecimentoFinal').value = this.checked ? 'Devolvido' : '';">
                                                <label class="form-check-label fw-semibold"
                                                    for="chkStatusCartaoAbastecimentoFinal">
                                                    <i class="fa-duotone fa-credit-card me-1 text-info"></i>
                                                    Cartão Abastecimento
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCintaDevolvida"
                                                    name="ViagemObj.Viagem.CintaDevolvida"
                                                    value="@(Model.ViagemObj?.Viagem?.CintaDevolvida == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCintaDevolvida"
                                                    @(Model.ViagemObj?.Viagem?.CintaDevolvida == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidCintaDevolvida').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCintaDevolvida">
                                                    <i class="fa-duotone fa-link me-1 text-primary"></i>
                                                    Cinta Devolvida
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidTabletDevolvido"
                                                    name="ViagemObj.Viagem.TabletDevolvido"
                                                    value="@(Model.ViagemObj?.Viagem?.TabletDevolvido == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkTabletDevolvido"
                                                    @(Model.ViagemObj?.Viagem?.TabletDevolvido == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidTabletDevolvido').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkTabletDevolvido">
                                                    <i class="fa-duotone fa-tablet me-1 text-primary"></i>
                                                    Tablet Devolvido
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidCaboDevolvido"
                                                    name="ViagemObj.Viagem.CaboDevolvido"
                                                    value="@(Model.ViagemObj?.Viagem?.CaboDevolvido == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkCaboDevolvido"
                                                    @(Model.ViagemObj?.Viagem?.CaboDevolvido == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidCaboDevolvido').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkCaboDevolvido">
                                                    <i class="fa-duotone fa-plug me-1 text-warning"></i>
                                                    Cabo Devolvido
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="form-check form-switch">
                                                <input type="hidden" id="hidArlaDevolvido"
                                                    name="ViagemObj.Viagem.ArlaDevolvido"
                                                    value="@(Model.ViagemObj?.Viagem?.ArlaDevolvido == true ? "true" : "false")" />
                                                <input class="form-check-input" type="checkbox" id="chkArlaDevolvido"
                                                    @(Model.ViagemObj?.Viagem?.ArlaDevolvido == true ? "checked" : "")
                                                    @(viagemFinalizada ? "disabled" : "")
                                                    onchange="document.getElementById('hidArlaDevolvido').value = this.checked ? 'true' : 'false';">
                                                <label class="form-check-label fw-semibold" for="chkArlaDevolvido">
                                                    <i class="fa-duotone fa-gas-pump me-1 text-success"></i>
                                                    Arla Devolvido
                                                </label>
                                            </div>
                                        </div>
                                    </div><!-- Fim da row g-3 -->
                                </div><!-- Fim do card ftx-section-devolvidos -->
                                }
                                <div id="secaoMobile" class="ftx-section ftx-section-mobile p-3"
                                    style="@(isEdicaoViagemMobile ? "" : "display: none;")">
                                    <div class="ftx-section-title" style="color: #9c27b0;">
                                        <i class="fa-duotone fa-mobile-screen-button"></i>
                                        Dados do FrotiX Mobile
                                    </div>

                                    <div class="row g-3">
                                        <!-- Rubrica Inicial -->
                                        <div class="col-12 col-md-6">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-pen"></i> Rubrica Inicial
                                            </label>
                                            <div id="containerRubricaInicial" class="rubrica-container">
                                                <div id="semRubricaInicial" class="rubrica-vazia">
                                                    <i class="fa-duotone fa-pen fa-2x text-muted"></i>
                                                    <p class="text-muted mb-0 mt-2">Sem rubrica inicial</p>
                                                </div>
                                                <img id="imgRubricaInicial" class="rubrica-imagem"
                                                    style="display: none;" alt="Rubrica Inicial" />
                                            </div>
                                        </div>

                                        <!-- Rubrica Final -->
                                        <div class="col-12 col-md-6">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-pen-fancy"></i> Rubrica Final
                                            </label>
                                            <div id="containerRubricaFinal" class="rubrica-container">
                                                <div id="semRubricaFinal" class="rubrica-vazia">
                                                    <i class="fa-duotone fa-pen-fancy fa-2x text-muted"></i>
                                                    <p class="text-muted mb-0 mt-2">Sem rubrica final</p>
                                                </div>
                                                <img id="imgRubricaFinal" class="rubrica-imagem" style="display: none;"
                                                    alt="Rubrica Final" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ═══════════════════════════════════════════════════════════
                                     INFORMAÇÕES DE AUDITORIA
                                     ═══════════════════════════════════════════════════════════ -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex flex-wrap gap-3 text-muted small">
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioAgendamento))
                                            {
                                                <span id="lblUsuarioAgendamento">
                                                    <i class="fa-duotone fa-user-clock me-1"></i>
                                                    Agendado por: @Model.ViagemObj.NomeUsuarioAgendamento
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioAgendamento" style="display:none;"></span>
                                            }
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioCriacao))
                                            {
                                                <span id="lblUsuarioCriacao">
                                                    <i class="fa-duotone fa-user-plus me-1"></i>
                                                    Criado por: @Model.ViagemObj.NomeUsuarioCriacao
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioCriacao" style="display:none;"></span>
                                            }
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioFinalizacao))
                                            {
                                                <span id="lblUsuarioFinalizacao">
                                                    <i class="fa-duotone fa-user-check me-1"></i>
                                                    Finalizado por: @Model.ViagemObj.NomeUsuarioFinalizacao
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioFinalizacao" style="display:none;"></span>
                                            }
                                            @if (!string.IsNullOrEmpty(Model.ViagemObj.NomeUsuarioCancelamento))
                                            {
                                                <span id="lblUsuarioCancelamento">
                                                    <i class="fa-duotone fa-trash-can-xmark me-1"></i>
                                                    Cancelado por: @Model.ViagemObj.NomeUsuarioCancelamento
                                                </span>
                                            }
                                            else
                                            {
                                                <span id="lblUsuarioCancelamento" style="display:none;"></span>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- Botão de Submit -->
                                <div class="form-group row">
                                    <div class="col-12">
                                        <div class="row justify-content-start">
                                            <!-- Botão visível: Cria/Edita Viagem -->
                                            <div id="divSubmit" class="col-12 col-md-4 col-lg-3 pb-2"
                                                style="@(viagemFinalizada ? "display:none;" : "")">
                                                @if (Model.ViagemObj.Viagem.ViagemId != Guid.Empty)
                                                {
                                                    <button id="btnSubmit" type="submit" asp-page-handler="Submit"
                                                        class="btn btn-azul btn-submit-spin w-100">
                                                        <span class="d-flex justify-content-center align-items-center">
                                                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                            <span>Atualizar Viagem</span>
                                                        </span>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button id="btnSubmit" type="submit" value="Submit"
                                                        asp-page-handler="Submit"
                                                        class="btn btn-azul btn-submit-spin w-100">
                                                        <span class="d-flex justify-content-center align-items-center">
                                                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                            <span>Criar Viagem</span>
                                                        </span>
                                                    </button>
                                                }
                                            </div>

                                            <!-- Botão Cancelar Operação -->
                                            <div class="col-12 col-md-4 col-lg-3 pb-2">
                                                <a href="javascript:void(0)"
                                                    class="btn btn-vinho w-100 btn-voltar-lista" data-ftx-loading>
                                                    <span class="d-flex justify-content-center align-items-center">
                                                        <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i>
                                                        <span class="ms-2">Cancelar Operação</span>
                                                    </span>
                                                </a>
                                            </div>

                                            <!-- Botão oculto para submit via JavaScript -->
                                            <div class="col-12" hidden>
                                                @if (Model.ViagemObj.Viagem.ViagemId != Guid.Empty)
                                                {
                                                    <button id="btnEscondido" type="button" data-handler="Edit"
                                                        data-id="@Model.ViagemObj.Viagem.ViagemId"
                                                        class="btn btn-azul form-control">
                                                        <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                        Atualizar Viagem
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button id="btnEscondido" type="button" data-handler="Submit"
                                                        class="btn btn-azul form-control">
                                                        <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
                                                        Criar Viagem
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div><!-- Fim de div.panel-content -->
                        </div><!-- Fim de div.panel-container show -->
                    </div><!-- Fim de div#panel-1 -->
                </div><!-- Fim de col-xl-12 -->
            </div><!-- Fim de row -->
        </div><!-- Fim de container-fluid -->
</form>
<!-- FIM DO FORM PRINCIPAL -->

@{
    // Reutilizar variáveis de decisão (nova viagem vs edição mobile)
    bool isNovaViagemFicha = Model.ViagemObj?.Viagem?.ViagemId == null ||
    Model.ViagemObj.Viagem.ViagemId == Guid.Empty;
    bool isViagemMobileFicha = !isNovaViagemFicha &&
    (Model.ViagemObj?.Viagem?.NoFichaVistoria == null ||
    Model.ViagemObj.Viagem.NoFichaVistoria == 0);
    // Mostrar ficha de vistoria se: nova viagem OU edição de viagem web
    bool mostrarFichaVistoria = isNovaViagemFicha || !isViagemMobileFicha;
}

<!-- INÍCIO: FORM DEDICADO À FICHA DE VISTORIA (RAZOR PAGES HANDLER) -->
<form method="post" asp-page-handler="InsereFicha" enctype="multipart/form-data" id="formFichaVistoria">
    <div class="container-fluid" id="secaoFichaVistoria"
        style="padding-left: 0; margin-left: 0; @(mostrarFichaVistoria ? "" : "display: none;")">
        <div class="row bottom-space" style="margin-top: 2rem;">

            <!-- coluna do input -->
            <div class="col-md-6 col-lg-5">
                <label class="d-block label font-weight-bold">Ficha de Vistoria</label>
                <input asp-for="FotoUpload" type="file" id="txtFile" class="form-control mb-3" accept="image/*"
                    onchange="VisualizaImagem(this)" />

                <!-- Campo hidden para o Base64 da nova imagem -->
                <input type="hidden" id="hiddenFoto" name="FotoBase64" value="" />

                <!-- Campo hidden para preservar imagem existente (caso não haja novo upload) -->
                @if (Model.ViagemObj?.Viagem?.FichaVistoria != null && Model.ViagemObj.Viagem.FichaVistoria.Length > 0)
                {
                    <input type="hidden" id="hiddenFichaExistente" name="FichaVistoriaExistente"
                        value="@Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria)" />
                }
            </div>

            <!-- coluna do preview + botão -->
            <div class="col-md-6 col-lg-7 d-flex flex-column align-items-start">
                <div class="img-zoom-wrapper">
                    @{
                        string imageSrc = "/images/FichaAmarelaNova.jpg"; // Imagem padrío/fallback
                        if (Model.ViagemObj?.Viagem?.FichaVistoria != null && Model.ViagemObj.Viagem.FichaVistoria.Length >
                        0)
                        {
                            imageSrc = $"data:image/jpeg;base64,{Convert.ToBase64String(Model.ViagemObj.Viagem.FichaVistoria)}";
                        }
                    }
                    <img id="imgViewerItem" src="@imageSrc" alt="Ficha de Vistoria"
                        style="max-width: 500px; max-height: 500px; border: 1px solid #ddd; margin-top: .5rem; object-fit: contain;"
                        class="img-thumbnail" />
                    <button type="button" class="zoom-btn" data-bs-toggle="modal" data-bs-target="#modalZoom"
                        aria-label="Ampliar imagem" onclick="atualizarImagemModal()">
                        <i class="fa-duotone fa-magnifying-glass-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal para zoom da imagem -->
<div class="modal fade" id="modalZoom" tabindex="-1" aria-labelledby="modalZoomLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-azul">
                <h5 class="modal-title" id="modalZoomLabel">Ficha de Vistoria</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imgZoomed" src="/images/FichaAmarelaNova.jpg" alt="Ficha de Vistoria Ampliada"
                    style="max-width: 100%; height: auto;" />
            </div>
        </div>
    </div>
</div>

<!-- Modal Inserir Evento -->
<div class="modal fade" id="modalEvento" data-backdrop="false" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title">
                    <i class="fa-duotone fa-users"></i>
                    Inserir um novo Evento
                </h4>
            </div>
            <div class="modal-body table-bordered">
                <form id="frmEvento">
                    <div class="row">
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Nome do Evento</label>
                                <input id="txtNomeDoEvento" class="form-control form-control-xs" />
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="form-group">
                                <label class="label font-weight-bold">Descrição do Evento</label>
                                <input id="txtDescricaoEvento" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Data Inicial</label>
                                <input id="txtDataInicialEvento" class="form-control form-control-xs" placeholder="dd/MM/yyyy" />
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Data Final</label>
                                <input id="txtDataFinalEvento" class="form-control form-control-xs" placeholder="dd/MM/yyyy" />
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label class="label font-weight-bold">Quantidade de Pessoas</label>
                                <input id="txtQtdPessoas" class="form-control form-control-xs" type="number" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-5 form-control-xs" style="margin: 10px; width: 200px;">
                            <label class="label font-weight-bold">Requisitante do Evento</label>
                            <ejs-dropdowntree id="lstRequisitanteEvento" placeholder="Selecione um Requisitante"
                                showCheckBox="false" allowMultiSelection="false" allowFiltering="true"
                                filterType="Contains" filterBarPlaceholder="Procurar..." popupHeight="200px"
                                change="RequisitanteEventoValueChange">
                                <e-dropdowntree-fields dataSource="@ViewData["dataRequisitante"]" value="RequisitanteId"
                                    text="Requisitante">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                        <div class="col-5 form-control-xs" style="margin: 10px; width: 200px;">
                            <label class="label font-weight-bold">Setor do Requisitante</label>
                            <ejs-dropdowntree id="ddtSetorRequisitanteEvento" placeholder="Selecione um Setor"
                                sortOrder="Ascending" showCheckBox="false" allowMultiSelection="false"
                                allowFiltering="true" filterType="Contains" filterBarPlaceholder="Procurar...">
                                <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]" value="SetorSolicitanteId"
                                    text="Nome" parentValue="SetorPaiId" hasChildren="HasChild">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                    </div>
                    <br /><br /><br />
                    <div class="modal-footer justify-content-between">
                        <button id="btnInserirEvento" type="submit" value="SUBMIT" class="btn custom-primary-btn">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-down-to-bracket"></i>
                                <span>Inserir Evento</span>
                            </span>
                        </button>
                        <button type="button" class="btn btn-vinho ml-auto ms-auto" data-bs-dismiss="modal"
                            data-bs-dismiss="modal" aria-label="Fechar">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-circle-xmark icon-spin" aria-hidden="true"></i>
                                <span>Fechar</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>

<!-- Modal Inserir Requisitante -->
<div class="modal fade" id="modalRequisitante">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Cabeçalho -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title">
                    <i class="fa-duotone fa-user-plus"></i>
                    Inserir um novo Requisitante
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>

            <div class="modal-divider"></div>

            <!-- Corpo -->
            <div class="modal-body">
                <form id="frmRequisitante">
                    <div class="form-row mb-3">
                        <div class="col-md-2">
                            <label for="txtPonto" class="font-weight-bold">Ponto</label>
                            <input id="txtPonto" class="form-control" />
                        </div>
                        <div class="col-md-8">
                            <label for="txtNome" class="font-weight-bold">Nome do Requisitante</label>
                            <input id="txtNome" class="form-control" />
                        </div>
                        <div class="col-md-2">
                            <label for="txtRamal" class="font-weight-bold">Ramal</label>
                            <input id="txtRamal" class="form-control" />
                        </div>
                    </div>

                    <div class="form-row mb-3">
                        <div class="col-md-8">
                            <label for="txtEmail" class="font-weight-bold">Email</label>
                            <input id="txtEmail" class="form-control" />
                        </div>
                    </div>

                    <div class="form-row mb-4">
                        <div class="col-md-6">
                            <label for="ddtSetorRequisitante" class="font-weight-bold">Setor do Requisitante</label>
                            <ejs-dropdowntree id="ddtSetorRequisitante" placeholder="Selecione um Setor"
                                sortOrder="Ascending" showCheckBox="false" allowMultiSelection="false"
                                allowFiltering="true" filterType="Contains" filterBarPlaceholder="Procurar...">
                                <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]" value="SetorSolicitanteId"
                                    text="Nome" parentValue="SetorPaiId" hasChildren="HasChild">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                    </div>

                    <div class="modal-divider"></div>

                    <div class="modal-footer justify-content-between">
                        <!-- Corrigido o texto do botão -->
                        <button id="btnInserirRequisitante" class="btn btn-azul" type="submit" value="SUBMIT">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-down-to-bracket"></i>
                                <span>Inserir Requisitante</span>
                            </span>
                        </button>

                        <button type="button" class="btn fundo-vermelho" data-bs-dismiss="modal" data-bs-dismiss="modal"
                            aria-label="Fechar modal">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-circle-xmark icon-spin" aria-hidden="true"></i>
                                <span>Fechar</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Inserir Setor -->
<div class="modal fade" id="modalSetor">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Cabeçalho -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title">Inserir um novo Setor Solicitante</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>

            <div class="modal-divider"></div>

            <!-- Corpo -->
            <div class="modal-body">
                <form id="frmSetor">
                    <div class="form-row mb-3">
                        <div class="col-md-3">
                            <label for="txtSigla" class="font-weight-bold">Sigla</label>
                            <input id="txtSigla" class="form-control" placeholder="Ex: TI, RH" />
                        </div>
                        <div class="col-md-6">
                            <label for="txtNomeSetor" class="font-weight-bold">Nome do Setor</label>
                            <input id="txtNomeSetor" class="form-control"
                                placeholder="Insira o nome completo do setor" />
                        </div>
                        <div class="col-md-3">
                            <label for="txtRamalSetor" class="font-weight-bold">Ramal</label>
                            <input id="txtRamalSetor" class="form-control" placeholder="Ex: 1234" type="number" />
                        </div>
                    </div>

                    <div class="form-row mb-4">
                        <div class="col-md-6">
                            <label for="ddtSetorPai" class="font-weight-bold">Setor Pai (se houver)</label>
                            <ejs-dropdowntree id="ddtSetorPai" placeholder="Selecione um Setor" sortOrder="Ascending"
                                showCheckBox="false" allowMultiSelection="false" allowFiltering="true"
                                filterType="Contains" filterBarPlaceholder="Procurar...">
                                <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]" value="SetorSolicitanteId"
                                    text="Nome" parentValue="SetorPaiId" hasChildren="HasChild">
                                </e-dropdowntree-fields>
                            </ejs-dropdowntree>
                        </div>
                    </div>

                    <div class="modal-divider"></div>

                    <div class="modal-footer justify-content-between">
                        <button id="btnInserirSetor" type="submit" value="SUBMIT" class="btn custom-primary-btn">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-down-to-bracket"></i>
                                <span>Inserir Setor</span>
                            </span>
                        </button>

                        <button type="button" class="btn btn-vinho ml-auto ms-auto" data-bs-dismiss="modal"
                            data-bs-dismiss="modal" aria-label="Fechar">
                            <span class="btn-inner">
                                <i class="fa-duotone fa-circle-xmark icon-spin" aria-hidden="true"></i>
                                <span>Fechar</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="toast_container"></div>

<div id="syncfusion-toast"></div>

@* ===============================================================================
   MODAL OCORRÊNCIAS DO VEÍCULO (UPSERT)
   =============================================================================== *@
<div class="modal fade" id="modalOcorrenciasVeiculoUpsert" tabindex="-1"
    aria-labelledby="modalOcorrenciasVeiculoUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h4 class="modal-title d-flex align-items-center gap-2" id="modalOcorrenciasVeiculoUpsertLabel">
                    <i class="fa-duotone fa-car-burst" aria-hidden="true"></i>
                    <span>Ocorrências em Aberto do Veículo</span>
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <!-- Tabela de Ocorrências -->
                <div class="table-responsive">
                    <table id="tblOcorrenciasVeiculoUpsert" class="table table-bordered table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center" style="width: 50px;">#</th>
                                <th style="width: 28%;">Resumo</th>
                                <th style="width: 30%;">Descrição</th>
                                <th class="text-center" style="width: 90px;">Data</th>
                                <th class="text-center" style="width: 90px;">Status</th>
                                <th class="text-center" style="width: 120px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@* ===============================================================================
   MODAL IMAGEM DA OCORRÊNCIA (UPSERT)
   =============================================================================== *@
<div class="modal fade" id="modalImagemOcorrenciaUpsert" tabindex="-1"
    aria-labelledby="modalImagemOcorrenciaUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalImagemOcorrenciaUpsertLabel">
                    <i class="fa-duotone fa-image" aria-hidden="true"></i>
                    <span>Imagem da Ocorrência</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>

            <div class="modal-body text-center p-3">
                <img id="imgOcorrenciaViewerUpsert" class="img-fluid rounded shadow"
                    style="max-height: 500px; display: none;" alt="Imagem da Ocorrência" />
                <div id="noImageOcorrenciaUpsert" class="p-4 bg-light rounded" style="display: none;">
                    <i class="fa-duotone fa-image fa-4x text-muted mb-3"></i>
                    <p class="text-muted">Nenhuma imagem disponível</p>
                </div>
            </div>

            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@*=========================================================================
   MODAL SOLUÇÃO DA OCORRÊNCIA (PARA BAIXA) - UPSERT
   =========================================================================*@
<div class="modal fade" id="modalSolucaoOcorrenciaUpsert" tabindex="-1"
    aria-labelledby="modalSolucaoOcorrenciaUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-verde">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalSolucaoOcorrenciaUpsertLabel">
                    <i class="fa-duotone fa-circle-check" aria-hidden="true"></i>
                    <span>Informar Solução da Ocorrência</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="hiddenOcorrenciaIdSolucaoUpsert" />
                <div class="form-group">
                    <label class="form-label fw-bold">
                        <i class="fa-duotone fa-message-lines me-1"></i>
                        Solução aplicada (opcional)
                    </label>
                    <textarea id="txtSolucaoOcorrenciaUpsert" class="form-control" rows="4"
                        placeholder="Descreva a solução aplicada para resolver esta ocorrência..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark me-1"></i> Cancelar
                </button>
                <button type="button" id="btnConfirmarSolucaoUpsert" class="btn btn-verde">
                    <i class="fa-duotone fa-circle-check me-1"></i> Confirmar Baixa
                </button>
            </div>
        </div>
    </div>
</div>

@* ===============================================================================
   OVERLAY LOADING - GRAVANDO VIAGEM (PADRÃO FROTIX)
   =============================================================================== *@
<div id="loadingOverlaySalvando" class="ftx-spin-overlay" style="z-index: 999999; cursor: wait; display: none;">
    <div class="ftx-spin-box" style="text-align: center; min-width: 300px;">
        <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" class="ftx-loading-logo"
            style="display: block;" />
        <div class="ftx-loading-bar"></div>
        <div class="ftx-loading-text">Gravando Viagem...</div>
        <div class="ftx-loading-subtext">Aguarde, por favor</div>
    </div>
</div>

@* ===============================================================================
   MODAL VISUALIZAR OCORRÊNCIA DA VIAGEM (MOBILE)
   =============================================================================== *@
<div class="modal fade" id="modalVerOcorrenciaViagem" tabindex="-1" aria-labelledby="modalVerOcorrenciaViagemLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalVerOcorrenciaViagemLabel">
                    <i class="fa-duotone fa-triangle-exclamation" aria-hidden="true"></i>
                    <span>Detalhes da Ocorrência</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="fw-bold text-muted small">Resumo</label>
                        <div id="txtOcorrenciaResumo" class="form-control-plaintext border-bottom"></div>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="fw-bold text-muted small">Data</label>
                        <div id="txtOcorrenciaData" class="form-control-plaintext border-bottom"></div>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="fw-bold text-muted small">Status</label>
                        <div id="divOcorrenciaStatus"></div>
                    </div>
                    <div class="col-12">
                        <label class="fw-bold text-muted small">Descrição</label>
                        <div id="txtOcorrenciaDescricao" class="form-control-plaintext border-bottom"
                            style="min-height: 60px;"></div>
                    </div>
                    <div class="col-12" id="divSolucaoOcorrencia" style="display: none;">
                        <label class="fw-bold text-muted small">Solução Aplicada</label>
                        <div id="txtOcorrenciaSolucao"
                            class="form-control-plaintext border-bottom bg-light p-2 rounded"></div>
                    </div>
                    <div class="col-12">
                        <label class="fw-bold text-muted small">Imagem</label>
                        <div class="text-center p-3 bg-light rounded">
                            <img id="imgOcorrenciaViagem" class="img-fluid rounded shadow"
                                style="max-height: 400px; display: none;" alt="Imagem da Ocorrência" />
                            <div id="semImagemOcorrenciaViagem" class="p-4">
                                <i class="fa-duotone fa-image fa-3x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Nenhuma imagem disponível</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@*=========================================================================
   MODAL INSERIR OCORRÊNCIA (UPSERT)
   =========================================================================*@
<div class="modal fade" id="modalInserirOcorrenciaUpsert" tabindex="-1"
    aria-labelledby="modalInserirOcorrenciaUpsertLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-terracota">
                <h5 class="modal-title d-flex align-items-center gap-2" id="modalInserirOcorrenciaUpsertLabel">
                    <i class="fa-duotone fa-triangle-exclamation" aria-hidden="true"></i>
                    <span>Registrar Nova Ocorrência</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <form id="frmOcorrenciaUpsert">
                    <!-- Resumo -->
                    <div class="mb-3">
                        <label for="txtResumoOcorrenciaUpsert" class="form-label fw-semibold">
                            <i class="fa-duotone fa-file-signature me-1 text-warning"></i>
                            Resumo da Ocorrência <span class="text-danger">*</span>
                        </label>
                        <input type="text" id="txtResumoOcorrenciaUpsert" class="form-control"
                            placeholder="Ex: Arranhão na lateral, Pneu furado, Vidro trincado..." maxlength="100" />
                    </div>

                    <!-- Descrição -->
                    <div class="mb-3">
                        <label for="txtDescricaoOcorrenciaUpsert" class="form-label fw-semibold">
                            <i class="fa-duotone fa-message-lines me-1 text-info"></i>
                            Descrição Detalhada
                        </label>
                        <textarea id="txtDescricaoOcorrenciaUpsert" class="form-control" rows="3"
                            placeholder="Descreva os detalhes da ocorrência..."></textarea>
                    </div>

                    <!-- Imagem -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fa-duotone fa-camera me-1 text-success"></i>
                            Foto da Ocorrência (opcional)
                        </label>
                        <div class="input-group">
                            <input type="file" id="fileImagemOcorrenciaUpsert" class="form-control" accept="image/*" />
                            <button type="button" class="btn btn-vinho" id="btnLimparImagemOcorrenciaUpsert">
                                <i class="fa-duotone fa-xmark"></i>
                            </button>
                        </div>
                        <div id="previewImagemOcorrenciaUpsert" class="mt-2 text-center" style="display: none;">
                            <img id="imgPreviewOcorrenciaUpsert" class="img-thumbnail" style="max-height: 150px;"
                                alt="Preview" />
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark me-1"></i> Cancelar
                </button>
                <button type="button" id="btnConfirmarOcorrenciaUpsert" class="btn btn-fundo-laranja">
                    <i class="fa-duotone fa-plus me-1"></i> Adicionar Ocorrência
                </button>
            </div>
        </div>
    </div>
</div>

@*=========================================================================
   MODAL VER IMAGEM OCORRÊNCIA (UPSERT)
   =========================================================================*@
<div class="modal fade" id="modalVerImagemOcorrenciaUpsert" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-azul">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fa-duotone fa-image" aria-hidden="true"></i>
                    <span>Imagem da Ocorrência</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="imgViewerOcorrenciaUpsert" class="img-fluid rounded shadow" style="max-height: 500px;"
                    alt="Imagem da Ocorrência" />
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark me-1"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>


@section ScriptsBlock {
    <!-- Kendo Editor Helper -->
    <script src="~/js/viagens/kendo-editor-upsert.js" asp-append-version="true"></script>

    <!-- Kendo DateTime Helper -->
    <script src="~/js/agendamento/utils/kendo-datetime.js" asp-append-version="true"></script>

    <!-- Validação IA - Validador Evolutivo de Finalização -->
    <script src="~/js/validacao/ValidadorFinalizacaoIA.js" asp-append-version="true"></script>

    <script src="~/js/cadastros/ViagemUpsert.js" asp-append-version="true"></script>

    <script>
        (function () {
            try {
                var context = {
                    dataFinalidade: @Html.Raw(Json.Serialize(ViewData["dataFinalidade"])),
                    dataCombustivel: @Html.Raw(Json.Serialize(ViewData["dataCombustivel"])),
                    dataEvento: @Html.Raw(Json.Serialize(ViewData["dataEvento"])),
                    dataMotorista: @Html.Raw(Json.Serialize(ViewData["dataMotorista"])),
                    valores: {
                        viagemId: "@(Model.ViagemObj?.Viagem?.ViagemId.ToString() ?? "")",
                        status: "@(Model.ViagemObj?.Viagem?.Status ?? "")",
                        finalidade: "@(Model.ViagemObj?.Viagem?.Finalidade ?? "")",
                        eventoId: "@(Model.ViagemObj?.Viagem?.EventoId?.ToString() ?? "")",
                        motoristaId: "@(Model.ViagemObj?.Viagem?.MotoristaId?.ToString() ?? "")",
                        combustivelInicial: "@(Model.ViagemObj?.Viagem?.CombustivelInicial ?? "")",
                        combustivelFinal: "@(Model.ViagemObj?.Viagem?.CombustivelFinal ?? "")"
                    },
                    datas: {
                        dataInicial: @Html.Raw(Model.ViagemObj?.Viagem?.DataInicial != null ?
                            $"new Date({Model.ViagemObj.Viagem.DataInicial.Value.Year}, {Model.ViagemObj.Viagem.DataInicial.Value.Month - 1}, {Model.ViagemObj.Viagem.DataInicial.Value.Day})" :
                            "null"),
                        dataFinal: @Html.Raw(Model.ViagemObj?.Viagem?.DataFinal != null ?
                            $"new Date({Model.ViagemObj.Viagem.DataFinal.Value.Year}, {Model.ViagemObj.Viagem.DataFinal.Value.Month - 1}, {Model.ViagemObj.Viagem.DataFinal.Value.Day})" :
                            "null"),
                        horaInicio: @Html.Raw(Model.ViagemObj?.Viagem?.HoraInicio != null ?
                            $"new Date(0,0,0,{Model.ViagemObj.Viagem.HoraInicio.Value.Hour},{Model.ViagemObj.Viagem.HoraInicio.Value.Minute})" :
                            "null"),
                        horaFim: @Html.Raw(Model.ViagemObj?.Viagem?.HoraFim != null ?
                            $"new Date(0,0,0,{Model.ViagemObj.Viagem.HoraFim.Value.Hour},{Model.ViagemObj.Viagem.HoraFim.Value.Minute})" :
                            "null")
                    }
                };

                window.viagemId = context.valores.viagemId;
                window.viagemStatus = context.valores.status;
                window.viagemFinalizada = @Json.Serialize(Model.ViagemObj?.Viagem?.Status == "Realizada" || Model.ViagemObj?.Viagem?.Status == "Cancelada");
                window.viagemUpsertContext = context;

                if (typeof initViagemUpsertPage === "function")
                {
                    initViagemUpsertPage(context);
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "initViagemUpsertContext", error);
            }
        })();
    </script>

}
