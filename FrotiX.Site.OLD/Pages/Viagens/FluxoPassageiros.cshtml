@*
 ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Viagens/FluxoPassageiros.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : P√°gina de an√°lise de fluxo passageiros por rotas/per√≠odos com
 *                   Syncfusion Grid paginado + Stimulsoft Report visualizador, identifica
 *                   rotas mais demandadas para planejamento otimizado viagens, gest√£o
 *                   demanda transporte corporativo
 *
 * üì• ENTRADAS     : @page, route /Viagens/FluxoPassageiros, filtros toolbar: DatePicker
 *                   DataInicio/DataFim (per√≠odo), ComboBox Origem/Destino cascading
 *                   (cidades), ComboBox SetorSolicitante (departamento), Checkbox
 *                   ApenasViagensRecorrentes, bot√£o Analisar Fluxo trigger GET
 *                   /api/Viagens/GetFluxoPassageiros
 *
 * üì§ SA√çDAS       : Page com card header (An√°lise Fluxo de Passageiros, √≠cone fa-route),
 *                   Toolbar filtros (DatePicker range, 2 ComboBox Origem/Destino,
 *                   ComboBox SetorSolicitante, Checkbox ApenasRecorrentes, bot√£o
 *                   Analisar), Syncfusion Grid (colunas: Origem, Destino, QuantidadeViagens,
 *                   TotalPassageiros, PassageirosPorViagem, DiasAtivos, Frequ√™nciaMedia,
 *                   PrincipaisSetores badges, CustoTotal, CustoM√©dioPorPassageiro,
 *                   Status Recorrente/Espor√°dica, A√ß√µes), groupBy Origem, server-side
 *                   paging 50/p√°gina, bot√£o Gerar Relat√≥rio (Stimulsoft MRT report)
 *
 * üîó CHAMADA POR  : Menu Viagens > An√°lises > Fluxo Passageiros (sidebar),
 *              usuarios com permissao Viagens.AnalisarFluxo (role Admin ou Coordenador),
 *              usado para planejamento viagens identificar rotas demanda alta programar
 *              viagens regulares fixas otimizar recursos
 * CHAMA: API ViagensController GET /api/Viagens/GetFluxoPassageiros (query EF Core
 *        Viagens Join Itinerarios Join Passageiros, Where DataViagem between DataInicio/DataFim
 *        AND Origem/Destino filters, Group By Origem,Destino aggregate COUNT Viagens,
 *        SUM Passageiros, AVG Passageiros per viagem, COUNT DISTINCT Date dias ativos,
 *        calcula FrequenciaMedia=TotalViagens/DiasAtivos, Include SetorSolicitante
 *        group count top 3, SUM CustoTotal, calcula CustoMedio/Passageiro, classifica
 *        Status Recorrente se Frequencia>1viagem/dia senao Esporadica, paginacao
 *        server-side Skip/Take, retorna JSON), Stimulsoft Report Viewer (carrega
 *        MRT template, passa DataSet fluxos array, renderiza report), Syncfusion Grid/DatePicker/ComboBox
 *        components
 * DEPENDENCIAS: Syncfusion EJ2 Grid/DatePicker/ComboBox 2023.4.2, Stimulsoft Reports.Web
 *               2023.3.1, Bootstrap 5.3.8, EF Core 8.0
 * OBSERVACOES: 532 linhas pagina analise fluxo passageiros. Identifica rotas recorrentes
 *              demanda alta (Origem Sao Paulo > Destino Campinas 150 viagens mes 600
 *              passageiros frequencia 5 viagens/dia = Recorrente, considerar programar
 *              viagem fixa diaria horarios fixos otimiza planejamento reduz custos
 *              ad-hoc). Identifica rotas esporadicas baixa demanda (Origem Osasco >
 *              Destino Sorocaba 5 viagens mes 10 passageiros frequencia 0.16 viagens/dia
 *              = Esporadica, manter sob demanda nao vale viagem fixa). Custo medio
 *              por passageiro permite comparar eficiencia rotas (rota A R$ 15/passageiro
 *              eficiente ocupacao alta, rota B R$ 50/passageiro ineficiente ocupacao
 *              baixa considerar consolidar viagens ou usar transporte alternativo taxi
 *              se mais barato). PrincipaisSetores identifica quais departamentos mais
 *              utilizam rota (Rh 40pc, TI 30pc, Financeiro 20pc permite direcionar
 *              comunicacao interna divulgar horarios viagens setores interessados).
 *              Grid groupBy Origem collapse/expand facilita navegacao (agrupa todas
 *              rotas mesma origem Sao Paulo collapsed mostra apenas 1 linha Sao Paulo
 *              (25 destinos), expand mostra 25 linhas detalhadas Sao Paulo>Campinas,
 *              Sao Paulo>Santos, ...). Report Stimulsoft permite gestores gerar PDF
 *              profissional analise fluxo incluir apresentacoes executivas planejamento
 *              estrategico frota.
 * REGRA: nunca use o simbolo arroba dentro deste bloco de comentario
 ======================================================================================== *@
@page

@using FrotiX.Repository.IRepository
@using Syncfusion.EJ2
@using Stimulsoft.Report.Mvc;

@inject IUnitOfWork _unitOfWork

@{
@functions {
	public void OnGet()
	{
		FrotiX.Pages.Viagens.IndexModel.Initialize(_unitOfWork);
		ViewData["lstVeiculos"] = new ListaEconomildos(_unitOfWork).VeiculosList();
		ViewData["lstMotoristas"] = new ListaMotoristaMOB(_unitOfWork).MotoristaList();
	}
}
}

@model FrotiX.Models.Viagem

@{
	ViewData["Title"] = "Viagens";
	ViewData["PageName"] = "viagens_fluxopassageiros";
	ViewData["Heading"] = "<i class='fa-duotone fa-clipboard-list-check'></i> Cadastros: <span class='fw-300'>Fluxo de Passageiros dos Economildos</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-clipboard-list-check";
}

<style>
	/* Header animado com background gradiente */
	.header-economildo {
		position: relative;
		background: linear-gradient(135deg, #325d88 0%, #2F4F4F 50%, #325d88 100%);
		padding: 1.5rem 1.25rem;
		margin: -1rem -1rem 1.5rem -1rem;
		border-radius: 8px 8px 0 0;
		overflow: hidden;
		box-shadow: 0 4px 12px rgba(47, 79, 79, 0.15);
	}

	/* Efeito de brilho animado */
	.header-economildo::before {
		content: '';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 100%;
		background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
		animation: ftxHeaderShine 4s ease-in-out infinite;
		pointer-events: none;
	}

	/* T√≠tulo do header */
	.header-economildo h1 {
		font-family: 'Outfit', sans-serif;
		font-weight: 900;
		font-size: 2rem;
		line-height: 1.25;
		margin: 0;
		display: flex;
		align-items: center;
		gap: 0.75rem;
		color: #ffffff;
		text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
		position: relative;
		z-index: 1;
	}

	.header-economildo h1 i.fa-duotone {
		--fa-primary-color: #C67750;
		--fa-secondary-color: #ffffff;
		--fa-secondary-opacity: 0.9;
		font-size: 2.4rem;
		line-height: 1;
		filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.35));
	}

	/* Separador de se√ß√£o */
	.secao-titulo {
		border-bottom: 2px solid #325d88;
		padding-bottom: 0.75rem;
		margin-bottom: 1.5rem;
	}

	.secao-titulo h3 {
		font-family: 'Outfit', sans-serif;
		font-weight: 700;
		font-size: 1.35rem;
		color: #325d88;
		margin: 0;
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.secao-titulo h3 i {
		font-size: 1.5rem;
		color: #597272;
	}

	/* Igualar altura dos campos - aumentar os nativos para 34px */
	#txtData,
	#lstMOB,
	#lstResponsavel {
		height: 34px !important;
		padding: 0.375rem 0.75rem !important;
		font-size: 0.875rem !important;
	}

	/* Ajustar altura dos Syncfusion para 34px tamb√©m */
	.e-small.e-input-group.e-control-wrapper,
	.e-small.e-input-group.e-control-wrapper .e-input,
	.e-small .e-ddl.e-input-group {
		height: 34px !important;
		line-height: 34px !important;
	}

	.e-small.e-input-group.e-control-wrapper input.e-input {
		height: 34px !important;
		line-height: 1.5 !important;
		padding: 0.375rem 0.75rem !important;
		font-size: 0.875rem !important;
	}

	.e-small .e-input-group-icon {
		min-height: 34px !important;
		line-height: 34px !important;
	}

	/* Anima√ß√£o de spinning para o √≠cone do bot√£o */
	.icon-pulse {
		animation: pulseIcon 1.5s ease-in-out infinite;
	}

	@@keyframes pulseIcon {
		0% {
			transform: scale(1);
		}
		50% {
			transform: scale(1.15);
		}
		100% {
			transform: scale(1);
		}
	}

	.fundo-cinza {
		background-color: #2F4F4F;
		color: aliceblue;
	}

	/* ================================================================
	   GRIDS SYNCFUSION - HEADER AZUL PADR√ÉO FROTIX
	   ================================================================ */
	#grdIda .e-gridheader,
	#grdVolta .e-gridheader {
		background-color: #4a6fa5 !important;
	}

	#grdIda .e-gridheader .e-headercell,
	#grdVolta .e-gridheader .e-headercell {
		background-color: #4a6fa5 !important;
		color: #ffffff !important;
		text-transform: uppercase !important;
		font-weight: 600 !important;
		font-size: 0.85rem !important;
		letter-spacing: 0.3px !important;
	}

	#grdIda .e-gridheader .e-headercelldiv,
	#grdVolta .e-gridheader .e-headercelldiv {
		color: #ffffff !important;
	}

	/* √çcones de ordena√ß√£o em branco */
	#grdIda .e-gridheader .e-sortfilterdiv .e-icons,
	#grdVolta .e-gridheader .e-sortfilterdiv .e-icons,
	#grdIda .e-gridheader .e-icon-ascending,
	#grdIda .e-gridheader .e-icon-descending,
	#grdVolta .e-gridheader .e-icon-ascending,
	#grdVolta .e-gridheader .e-icon-descending {
		color: #ffffff !important;
	}

	/* Hover no header */
	#grdIda .e-gridheader .e-headercell:hover,
	#grdVolta .e-gridheader .e-headercell:hover {
		background-color: #3d5f8a !important;
	}

	/* ================================================================
	   BOT√ÉO INSERIR LINHA - 50% MAIOR
	   ================================================================ */
	.btn-insere-linha {
		width: 51px !important;      /* 34px * 1.5 = 51px */
		height: 51px !important;
		padding: 0 !important;
		display: flex !important;
		align-items: center !important;
		justify-content: center !important;
		border-radius: 6px !important;
		margin-bottom: -8px;         /* Ajuste para alinhar com input de 34px */
	}

	.btn-insere-linha i {
		font-size: 1.5rem !important;
		--fa-primary-color: #ffffff;
		--fa-secondary-color: #b8d4e8;
		--fa-secondary-opacity: 0.8;
	}

	.btn-insere-linha:hover i {
		transform: scale(1.1);
		transition: transform 0.2s ease;
	}
</style>

<script>
	//------ Indica um Item Sendo Escolhido -------------
	//==================================================
	function DefineEscolhaVeiculo() {
		try {
			var veiculos = $("#lstVeiculos").data("kendoComboBox");
			return veiculos;
		} catch (error) {
			Alerta.TratamentoErroComLinha("FluxoPassageiros.cshtml", "DefineEscolhaVeiculo", error);
		}
	}

	function DefineEscolhaData() {
		try {
			// reservado para futuras regras
		} catch (error) {
			Alerta.TratamentoErroComLinha("FluxoPassageiros.cshtml", "DefineEscolhaData", error);
		}
	}

	//------ Fun√ß√£o de Escolha do ComboBox Ve√≠culos ------------------
	//================================================================
	function VeiculosValueChange() {
		try {
			// reservado para futuras regras
		} catch (error) {
			Alerta.TratamentoErroComLinha("FluxoPassageiros.cshtml", "VeiculosValueChange", error);
		}
	}
</script>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<div class="panel-container show">
				<div class="panel-content">
					<!-- Header Animado -->
					<div class="header-economildo">
						<h1>
							<i class="fa-duotone fa-clipboard-list-check"></i>
							Inser√ß√£o dos Registros dos Economildos
						</h1>
					</div>

					<div class="box-body">
						<div class="secao-titulo">
							<h3>
								<i class="fa-duotone fa-calendar-check"></i>
								Escolha a Data e o respectivo Economildo para registrar suas viagens
							</h3>
						</div>

						<div class="col-12" id="divEscolhas">
							<!-- Lembrete: ideal mover para JS dedicado -->
							<script>
								document.addEventListener('DOMContentLoaded', function () {
									try {
										// [KENDO] Popup-on-focus √© configurado via Kendo events no init block (ScriptsBlock)
										// Nenhuma configura√ß√£o Syncfusion necess√°ria aqui
										console.log('[KENDO] FluxoPassageiros: ComboBoxes inicializados via ScriptsBlock');
									} catch (error) {
										Alerta.TratamentoErroComLinha("FluxoPassageiros.cshtml", "DOMContentLoaded", error);
									}
								});
							</script>

							<div class="form-group row align-items-end">
								<div class="col-2">
									<label class="label font-weight-bold color-black">Escolha uma Data</label>
									<input id="txtData" class="form-control form-control-xs" type="date" />
								</div>

								<div class="col-4">
									<label class="label font-weight-bold color-black">Placa do Economildo</label>
									<input id="lstVeiculos" name="lstVeiculos" style="width: 100%;" />
								</div>

								<div class="col-4">
									<label class="label font-weight-bold color-black">Motorista do Economildo</label>
									<input id="lstMotoristas" name="lstMotoristas" style="width: 100%;" />
								</div>

								<div class="col-2">
									<label class="label font-weight-bold">Indique o MOB</label>
									<select class="form-control form-control-xs" id="lstMOB">
										<option value=""></option>
										<option value="Rodoviaria">Rodovi√°ria</option>
										<option value="Cefor">Cefor</option>
										<option value="PGR">PGR</option>
									</select>
								</div>
							</div>

							<div class="form-group row align-items-end mt-3">
								<div class="col-3">
									<label class="label font-weight-bold">Respons√°vel pelo Registro</label>
									<select class="form-control form-control-xs" id="lstResponsavel">
										<option value=""></option>
										<option value="Angela">Angela</option>
										<option value="Greciane">Greciane</option>
										<option value="Milena">Milena</option>
									</select>
								</div>

								<div class="col-4">
									<button id="btnInsereFicha" type="button" class="btn btn-azul form-control form-control-xs">
										<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> Insere Ficha
									</button>
								</div>
							</div>
						</div> <!-- /divEscolhas -->

						<br />

						<div class="secao-titulo" hidden="hidden" id="divTitulo">
							<h3>
								<i class="fa-duotone fa-route"></i>
								Informe todas as viagens de Ida e Volta do referido Economildo
							</h3>
						</div>

						<div class="row" hidden="hidden" id="divInsercao">
							<div class="col-10">
								<div class="panel-content">
									<div class="box-body">
										<div class="row">
											<div class="col-3">
												<div class="form-group">
													<label class="label font-weight-bold">Ida/Volta</label>
													<select class="form-control form-control-xs" id="lstIdaVolta">
														<option value="IDA">Ida</option>
														<option value="VOLTA">Volta</option>
													</select>
												</div>
											</div>

											<div class="col-2 col-sm-2">
												<label class="label font-weight-bold color-black">Hora In√≠cio</label>
												<input id="txtHoraInicio" class="form-control form-control-xs" type="time" />
											</div>

											<div class="col-2 col-sm-2">
												<label class="label font-weight-bold color-black">Hora Fim</label>
												<input id="txtHoraFim" class="form-control form-control-xs" type="time" />
											</div>

											<div class="col-2 col-sm-2">
												<label class="label font-weight-bold color-black">Quantidade</label>
												<input id="txtQtd" class="form-control form-control-xs" type="number" />
											</div>

											<div class="col-1 d-flex align-items-end">
												<a class="btn btn-azul text-white btnFicha btn-insere-linha"
												   id="btnInsere"
												   href="#"
												   style="cursor: pointer;"
												   data-ejtip="Insere a Linha na Tabela">
													<i class="fa-duotone fa-circle-plus"></i>
												</a>
											</div>
										</div>
									</div>
								</div>
							</div> <!-- /col-10 -->
						</div> <!-- /divInsercao -->

						<div class="row" hidden="hidden" id="divRegistro">
							<div class="col-6">
								<div class="panel-content">
									<div class="box-body">
										<h3 id="TituloIdas">Viagens de Ida</h3>
										@{
											List<object> colsida = new List<object> { new { field = "horainicioida" , direction = "Ascending" } };
										}
										<ejs-grid id="grdIda" toolbar="@(new List<string>() { "Delete" })" GridLines="Both" allowSorting="true">
											<e-grid-editSettings allowAdding="true"
																 allowDeleting="true"
																 allowEditing="true"
																 newRowPosition="Bottom"
																 showDeleteConfirmDialog="true"></e-grid-editSettings>
											<e-grid-sortsettings columns="colsida"></e-grid-sortsettings>
											<e-grid-columns>
												<e-grid-column field="horainicioida" headerText="Hora" textAlign="Center" width="30" allowEditing="true"></e-grid-column>
												<e-grid-column field="horafimida" headerText="Hora" textAlign="Center" width="30" allowEditing="true"></e-grid-column>
												<e-grid-column field="qtdpassageirosida" headerText="Quantidade" textAlign="Center" width="20" allowEditing="true"></e-grid-column>
											</e-grid-columns>
										</ejs-grid>
									</div>
								</div>
							</div>

							<div class="col-6">
								<div class="panel-content">
									<div class="box-body">
										<h3 id="TituloVoltas">Viagens de Volta</h3>
										@{
											List<object> colsvolta = new List<object> { new { field = "horainiciovolta" , direction = "Ascending" } };
										}
										<ejs-grid id="grdVolta" toolbar="@(new List<string>() { "Delete" })" GridLines="Both" allowSorting="true">
											<e-grid-editSettings allowAdding="true"
																 allowDeleting="true"
																 allowEditing="true"
																 newRowPosition="Bottom"
																 showDeleteConfirmDialog="true"></e-grid-editSettings>
											<e-grid-sortsettings columns="colsvolta"></e-grid-sortsettings>
											<e-grid-columns>
												<e-grid-column field="horainiciovolta" headerText="Hora" textAlign="Center" width="30" allowEditing="true"></e-grid-column>
												<e-grid-column field="horafimvolta" headerText="Hora" textAlign="Center" width="30" allowEditing="true"></e-grid-column>
												<e-grid-column field="qtdpassageirosvolta" headerText="Quantidade" textAlign="Center" width="20" allowEditing="true"></e-grid-column>
											</e-grid-columns>
										</ejs-grid>
									</div>
									<br />
								</div>
							</div>
						</div> <!-- /divRegistro -->

						<div class="form-group row" hidden="hidden" id="divBotao">
							<div class="col-9">
								<div class="row">
									<div class="col-6">
										<button id="btnSubmite" type="button" class="btn btn-azul form-control">
											<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> Registrar Viagens
										</button>
									</div>
									<div class="col-6">
										<button id="btnCancela" type="button" class="btn btn-vinho form-control">
											<i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Cancela Inser√ß√£o
										</button>
									</div>
								</div>
							</div>
						</div>

					</div> <!-- /box-body -->
				</div> <!-- /panel-content -->
			</div> <!-- /panel-container -->
		</div> <!-- /panel -->
	</div> <!-- /col-xl-12 -->

	<input id="txtHoraInicioAnteriorIda" class="form-control form-control-xs" type="time" hidden="hidden" />
	<input id="txtHoraFimAnteriorIda" class="form-control form-control-xs" type="time" hidden="hidden" />
	<input id="txtQtdAnteriorIda" class="form-control form-control-xs" type="number" hidden="hidden" />

	<input id="txtHoraInicioAnteriorVolta" class="form-control form-control-xs" type="time" hidden="hidden" />
	<input id="txtHoraFimAnteriorVolta" class="form-control form-control-xs" type="time" hidden="hidden" />
	<input id="txtQtdAnteriorVolta" class="form-control form-control-xs" type="number" hidden="hidden" />
</div>

@section ScriptsBlock {
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script>
		(function () {
			try {
				var dataVeiculos = @Html.Raw(Json.Serialize(ViewData["lstVeiculos"]));
				var dataMotoristas = @Html.Raw(Json.Serialize(ViewData["lstMotoristas"]));

				$("#lstVeiculos").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "id",
					placeholder: "Selecione um Ve√≠culo",
					filter: "contains",
					dataSource: dataVeiculos,
					height: 250,
					clearButton: true,
					open: function(e) { /* popup-on-focus via Kendo event */ }
				});

				$("#lstMotoristas").kendoComboBox({
					dataTextField: "descricao",
					dataValueField: "id",
					placeholder: "Selecione um Motorista",
					filter: "contains",
					dataSource: dataMotoristas,
					height: 250,
					clearButton: true,
					open: function(e) { /* popup-on-focus via Kendo event */ }
				});

				console.log("[KENDO] FluxoPassageiros: 2 ComboBoxes inicializados");
			} catch (error) {
				Alerta.TratamentoErroComLinha("FluxoPassageiros.cshtml", "kendoComboBox.init", error);
			}
		})();
	</script>
	<script src="/js/cadastros/fluxopassageiros.js" asp-append-version="true"></script>
}
