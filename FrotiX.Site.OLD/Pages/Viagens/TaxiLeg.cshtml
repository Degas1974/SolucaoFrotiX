@*
 * ‚ö° ARQUIVO: Pages/Viagens/TaxiLeg.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : P√°gina de edi√ß√£o/cria√ß√£o de viagens (Legacy "TaxiLeg") com suporte a:
 *                   ficha vistoria upload, requisitante/setor dropdowns, motorista/ve√≠culo,
 *                   hor√°rios, quilometragem, combust√≠vel inicial/final, descri√ß√£o Word Editor
 *
 * üì• ENTRADAS     : Model FrotiX.Pages.Viagens.TaxiLegModel, @page /Viagens/TaxiLeg,
 *                   Form inputs (txtNoFichaVistoria, txtDataInicial, txtHoraInicial,
 *                   lstFinalidade, txtOrigem, lstMotorista, lstVeiculo, txtKmInicial,
 *                   ddtCombustivelInicial, ddtRequisitante, txtRamalRequisitante,
 *                   ddtSetor, txtFile upload ficha, Kendo RichTextEditor descri√ß√£o)
 *
 * üì§ SA√çDAS       : Renderiza√ß√£o p√°gina profile-card-1 (legacy design), modal requisitante,
 *                   modal setor, form POST /Viagens/Upsert com valida√ß√µes JavaScript,
 *                   preview ficha vistoria img #imgViewer
 *
 * üîó CHAMADA POR  : Link menu Viagens > Adicionar/Editar, rota /Viagens/Upsert?id={viagem_id}
 *                   ou /Viagens/Upsert (novo)
 *
 * üîÑ CHAMA        : TaxiLegModel (code-behind), API endpoints (FichaExistente, PegaSetor,
 *                   PegaRamal, VerificaMotoristaViagem, VerificaVeiculoViagem,
 *                   PegaKmAtualVeiculo, AdicionarRequisitante, AdicionarSetor, PegaFicha),
 *                   Kendo RichTextEditor, Syncfusion DropdownTree
 *
 * üì¶ DEPEND√äNCIAS : ASP.NET Core Razor Pages, TaxiLegModel, Syncfusion EJ2 DropdownTree/RTE,
 *                   Kendo UI RichTextEditor, jQuery, Bootstrap 5 (legacy profile-card),
 *                   Font Awesome 6 Duotone, fetch/AJAX $.ajax, moment.js (date validation)
 *
 * üìù OBSERVA√á√ïES  : 1217 linhas. P√°gina COMPLEXA com valida√ß√µes lado-cliente extensas
 *                   (12+ focusout handlers para valida√ß√£o data/hora/km), 2 modais (requisitante,
 *                   setor), AJAX handlers m√∫ltiplos, ficha vistoria upload com preview
 *                   base64, descri√ß√£o Word Editor (SFDT format). Legacy design profile-card
 *                   (n√£o FrotiX-aligned). Valida√ß√µes duplicadas (data final < data inicial
 *                   2 vezes). SweetAlert confirmations antiquadas (swal em vez de Alerta).
 * *@
@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers
@using Syncfusion.EJ2
@model FrotiX.Pages.Viagens.TaxiLegModel
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "Viagens";
    ViewData["PageName"] = "viagem_index";
    ViewData["Heading"] = "<i class='fa-duotone fa-route'></i> Cadastros: <span class='fw-300'>Viagens</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-route";
}

<style>
    .form-control-xs {
        height: calc(1em + .775rem + 10px) !important;
        padding: .125rem .25rem !important;
        font-size: .75rem !important;
        line-height: 1.5;
        border-radius: .2rem;
    }

    .label {
        margin-bottom: -5px;
        margin-top: 10px;
    }

    input[type=checkbox] {
        vertical-align: middle;
        position: relative;
        bottom: 1px;
    }

    .btn-largura {
        width: 100px;
        height: 100px;
    }
</style>

@section HeadBlock {
    @* <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" /> *@
    @* <link rel="stylesheet" href="~/css/microtip.css" /> *@
    <!-- DEMO 01 CSS FILE ----------------------------------------------------------------------->
    <link href="~/css/demo-01.css" rel="stylesheet" />
}

<script>
    function stopEnterSubmitting(e) {
        try {
            if (e.key === 'Enter') {
                const src = e.target || e.srcElement;
                if (src && src.tagName && src.tagName.toLowerCase() !== 'div') {
                    e.preventDefault();
                    return false;
                }
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "stopEnterSubmitting", error);
        }
    }
</script>

<div class="profile-card-1">
    <div class="profile-content">
        <!-- PROFILE COVER PHOTO -->
        <img src="~/Images/profile-bg-1.jpg" class="img img-responsive" alt="Capa" />
        <div class="profile-content">
            <!-- PROFILE PHOTO -->
            <img src="~/assets/img/profile-7.jpg" class="img img-responsive" alt="Perfil" />
            <!-- PROFILE NAME -->
            <div class="profile-name">JOHN DOE</div>
            <!-- PROFILE OVERVIEW -->
            <div class="row">
                <div class="col-xs-6">
                    <div class="profile-overview">
                        <p>TEAM</p>
                        <h5>Royal Challengers</h5>
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="profile-overview">
                        <p>RACES</p>
                        <h5>50</h5>
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="profile-overview">
                        <p>WON</p>
                        <h5>32</h5>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="profile-overview">
                        <p>COUNTRY</p>
                        <h5>India</h5>
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="profile-overview">
                        <p>CHAMPION</p>
                        <h5>5</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="profile-img">
        <img src="~/Images/Schedule.jpg" class="img img-responsive" alt="Agenda" />
    </div>
    <div class="profile-name">John Doe</div>
    <div class="profile-address">johndoedesigner</div>
    <p class="profile-description">
        Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor.
    </p>
    <div class="profile-icons">
        <a href="#" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
        <a href="#" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
        <a href="#" aria-label="LinkedIn"><i class="fa fa-linkedin"></i></a>
    </div>
</div>

<!-- Modal Inserir Requisitante -->
<div class="modal fade" id="modalRequisitante">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title" id="DynamicModalLabel">Inserir um novo Requisitante</h4>
            </div>
            <div class="modal-body table-bordered">
                <form id="frmRequisitante">
                    <div class="row">
                        <div class="col-2">
                            <div class="form-group">
                                <label class="label font-weight-bold">Ponto</label>
                                <input id="txtPonto" class="form-control form-control-xs" />
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="form-group">
                                <label class="label font-weight-bold">Nome do Requisitante</label>
                                <input id="txtNome" class="form-control form-control-xs" />
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="form-group">
                                <label class="label font-weight-bold">Ramal</label>
                                <input id="txtRamal" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-8">
                            <div class="form-group">
                                <label class="label font-weight-bold">Email</label>
                                <input id="txtEmail" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div id="ControlRegion">
                            <div class="form-control-xs" style="margin: 0 auto; width: 400px;">
                                <label class="label font-weight-bold">Setor do Requisitante</label>
                                <input id="ddtSetorRequisitante" style="width: 100%;" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnInserirRequisitante" class="btn btn-azul" type="submit" value="SUBMIT">
                            Inserir Requisitante
                        </button>
                        <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                            <i class="fa-duotone fa-circle-xmark icon-space"></i> Fechar
                        </button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>

<!-- Modal Inserir Setor -->
<div class="modal fade" id="modalSetor">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title" id="DynamicModalLabel">Inserir um novo Setor Solicitante</h4>
            </div>
            <div class="modal-body table-bordered">
                <form id="frmSetor">
                    <div class="row">
                        <div class="col-3">
                            <div class="form-group">
                                <label class="label font-weight-bold">Sigla</label>
                                <input id="txtSigla" class="form-control form-control-xs" placeholder="Insira a sigla" />
                            </div>
                        </div>
                        <div class="col-7">
                            <div class="form-group">
                                <label class="label font-weight-bold">Nome do Setor</label>
                                <input id="txtNomeSetor" class="form-control form-control-xs" placeholder="Insira o nome do setor" />
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="form-group">
                                <label class="label font-weight-bold">Ramal</label>
                                <input id="txtRamalSetor" class="form-control form-control-xs" placeholder="Insira o ramal" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div id="ControlRegion">
                            <div class="form-control-xs" style="margin: 0 auto; width: 400px;">
                                <label class="label font-weight-bold">Setor Pai (se houver)</label>
                                <input id="ddtSetorPai" style="width: 100%;" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnInserirSetor" class="btn btn-azul" type="submit" value="SUBMIT">
                            Inserir Setor
                        </button>
                        <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                            <i class="fa-duotone fa-circle-xmark icon-space"></i> Fechar
                        </button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script type="text/javascript">
        // Inicializar Kendo DropDownTree para Setor
        (function () {
            try {
                var dataSetor = @Html.Raw(Json.Serialize(ViewData["dataSetor"]));

                KendoDDTHelper.initHierarchical({
                    selector: "#ddtSetorRequisitante",
                    flatData: dataSetor,
                    placeholder: "Selecione um Setor"
                });

                KendoDDTHelper.initHierarchical({
                    selector: "#ddtSetorPai",
                    flatData: dataSetor,
                    placeholder: "Selecione um Setor"
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "kendoDDT.init", error);
            }
        })();

        window.onload = function () {
            try {
                if ('@Model.ViagemObj.Viagem.CombustivelInicial' != null) {
                    var ddlCombInicial = $("#ddtCombustivelInicial").data("kendoDropDownList");
                    if (ddlCombInicial) ddlCombInicial.value('@Model.ViagemObj.Viagem.CombustivelInicial');
                }
                if ('@Model.ViagemObj.Viagem.ViagemId' === '00000000-0000-0000-0000-000000000000') {
                    document.getElementById("txtDataInicial").value = moment(Date()).format("YYYY-MM-DD");
                    // document.getElementById("txtHoraInicial").value = moment(Date()).format("HH:mm");
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "onload", error);
            }
        };
                // Controla o Submit do formul√°rio atrav√©s de bot√µes escondidos (permite a valida√ß√£o via javascript)
        // =================================================================================================
        $("#btnSubmit").click(function (event) {
            try {
                event.preventDefault();

                if (document.getElementById("txtNoFichaVistoria").value === "") {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "O n√∫mero da Ficha de Vistoria √© obrigat√≥rio",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                if (document.getElementById("txtDataInicial").value === "") {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "A Data Inicial √© obrigat√≥ria",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                if (document.getElementById("txtHoraInicial").value === "") {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "A Hora Inicial √© obrigat√≥ria",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                var ddlFinalidade = $("#lstFinalidade").data("kendoDropDownList");
                if (!ddlFinalidade || !ddlFinalidade.value()) {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "A Finalidade √© obrigat√≥ria",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                if (document.getElementById("txtOrigem").value === "") {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "A Origem √© obrigat√≥ria",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                var cmbMotorista = $("#lstMotorista").data("kendoComboBox");
                if (!cmbMotorista || !cmbMotorista.value()) {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "O Motorista √© obrigat√≥rio",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                var cmbVeiculo = $("#lstVeiculo").data("kendoComboBox");
                if (!cmbVeiculo || !cmbVeiculo.value()) {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "O Ve√≠culo √© obrigat√≥rio",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                if (document.getElementById("txtKmInicial").value === "") {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "A Quilometragem Inicial √© obrigat√≥ria",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                var ddlCombInicial = $("#ddtCombustivelInicial").data("kendoDropDownList");
                if (!ddlCombInicial || !ddlCombInicial.value()) {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "O N√≠vel de Combust√≠vel Inicial √© obrigat√≥rio",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                var cmbRequisitante = $("#ddtRequisitante").data("kendoComboBox");
                if (!cmbRequisitante || !cmbRequisitante.value()) {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "O Requisitante √© obrigat√≥rio",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                if (document.getElementById("txtRamalRequisitante").value === "") {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "O Ramal do Requisitante √© obrigat√≥rio",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                var setorVal = KendoDDTHelper.getValue("#ddtSetor");
                if (!setorVal) {
                    swal({
                        title: "Informa√ß√£o Ausente",
                        text: "O Setor Solicitante √© obrigat√≥rio",
                        icon: "error",
                        buttons: { ok: "Ok" }
                    });
                    return;
                }

                $("#btnEscondido").click();
            } catch (error) {
                Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "#btnSubmit.click", error);
            }
        });

        $(document).ready(function () {
            try {
                if ('@Model.ViagemObj.Viagem.ViagemId' === '00000000-0000-0000-0000-000000000000') {
                    document.getElementById("txtDataInicial").value = moment(Date()).format("YYYY-MM-DD");
                    document.getElementById("txtHoraInicial").value = moment(Date()).format("HH:mm");
                    document.getElementById("divFicha").style.display = 'none';
                }

                // Bloqueia controles caso a viagem j√° tenha sido realizada ou cancelada
                if ('@Model.ViagemObj.Viagem.Status' === 'Realizada' || '@Model.ViagemObj.Viagem.Status' === 'Cancelada') {
                    var childNodes = document.getElementById("divPainel").getElementsByTagName('*');
                    for (var node of childNodes) {
                        node.disabled = true;
                    }

                    // Desabilitar controles Kendo
                    var rteEditor = $("#rte").data("kendoEditor");
                    if (rteEditor) { /* Kendo Editor n√£o tem enable/disable nativo, readonly via body */ rteEditor.body.contentEditable = false; }
                    var cmbMot = $("#lstMotorista").data("kendoComboBox");
                    if (cmbMot) cmbMot.enable(false);
                    var cmbVeic = $("#lstVeiculo").data("kendoComboBox");
                    if (cmbVeic) cmbVeic.enable(false);
                    var cmbReq = $("#ddtRequisitante").data("kendoComboBox");
                    if (cmbReq) cmbReq.enable(false);
                    KendoDDTHelper.enable("#ddtSetor", false);
                    var ddlCombI = $("#ddtCombustivelInicial").data("kendoDropDownList");
                    if (ddlCombI) ddlCombI.enable(false);
                    var ddlCombF = $("#ddtCombustivelFinal").data("kendoDropDownList");
                    if (ddlCombF) ddlCombF.enable(false);
                    var ddlFin = $("#lstFinalidade").data("kendoDropDownList");
                    if (ddlFin) ddlFin.enable(false);

                    document.getElementById("divSubmit").style.display = 'none';
                    $("#btnSubmit").hide();
                }

                // Atualiza Controles Kendo da P√°gina
                if ('@Model.ViagemObj.Viagem.CombustivelInicial' != null) {
                    var ddlCI = $("#ddtCombustivelInicial").data("kendoDropDownList");
                    if (ddlCI) ddlCI.value('@Model.ViagemObj.Viagem.CombustivelInicial');
                }
                if ('@Model.ViagemObj.Viagem.CombustivelFinal' != null) {
                    var ddlCF = $("#ddtCombustivelFinal").data("kendoDropDownList");
                    if (ddlCF) ddlCF.value('@Model.ViagemObj.Viagem.CombustivelFinal');
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "document.ready", error);
            }
        });
    </script>

    <script type="text/javascript">
        $("#txtNoFichaVistoria").focusout(function () {
            if (document.getElementById("txtNoFichaVistoria").value === '') {
                return;
            }

            try {
                // Verifica se N√∫mero da Ficha j√° foi cadastrado
                $.ajax({
                    url: "/Viagens/Upsert?handler=FichaExistente",
                    method: "GET",
                    datatype: "json",
                    data: { id: document.getElementById("txtNoFichaVistoria").value },
                    success: function (res) {
                        var ExisteFicha = [res.data];
                        if (ExisteFicha[0] === true) {
                            swal({
                                title: "Alerta na Ficha de Vistoria",
                                text: "J√° existe uma Ficha inserida com esta numera√ß√£o!",
                                icon: "warning",
                                buttons: { ok: "Ok" }
                            });
                            return;
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "success", error);
            }
        });

        // Verifica se Data Final √© menor que Data Inicial
        $("#txtDataFinal").focusout(function () {
            var DataInicial = $("#txtDataInicial").val();
            var DataFinal = $("#txtDataFinal").val();

            if (DataFinal === '') {
                return;
            }

            if (DataFinal < DataInicial) {
                $("#txtDataFinal").val('');
                swal({
                    title: "Erro na Data",
                    text: "A data final deve ser maior que a inicial!",
                    icon: "error",
                    buttons: { ok: "Ok" }
                });
            }
        });

        // Verifica se Data Inicial √© maior que Data Final
        $("#txtDataInicial").focusout(function () {
            var DataInicial = $("#txtDataInicial").val();
            var DataFinal = $("#txtDataFinal").val();

            if (DataInicial === '' || DataFinal === '') {
                return;
            }

            if (DataInicial > DataFinal) {
                $("#txtDataInicial").val('');
                swal({
                    title: "Erro na Data",
                    text: "A data inicial deve ser menor que a final!",
                    icon: "error",
                    buttons: { ok: "Ok" }
                });
            }
        });

        // Verifica se Hora Final √© menor que Hora Inicial e se tem Data Final
        $("#txtHoraFinal").focusout(function () {
            var HoraInicial = $("#txtHoraInicial").val();
            var HoraFinal = $("#txtHoraFinal").val();
            var DataInicial = $("#txtDataInicial").val();
            var DataFinal = $("#txtDataFinal").val();

            if (DataFinal === '') {
                $("#txtHoraFinal").val('');
                swal({
                    title: "Erro na Hora Final",
                    text: "Preencha a Data Final para poder preencher a Hora Final!",
                    icon: "error",
                    buttons: { ok: "Ok" }
                });
            }

            if ((HoraFinal < HoraInicial) && (DataInicial === DataFinal)) {
                $("#txtHoraFinal").val('');
                swal({
                    title: "Erro na Hora",
                    text: "A hora final deve ser maior que a inicial!",
                    icon: "error",
                    buttons: { ok: "Ok" }
                });
            }
        });

        // Verifica se Hora Inicial √© maior que Hora Final
        $("#txtHoraInicial").focusout(function () {
            var HoraInicial = $("#txtHoraInicial").val();
            var HoraFinal = $("#txtHoraFinal").val();

            if (HoraFinal === '') {
                return;
            }

            if (HoraInicial > HoraFinal) {
                $("#txtHoraInicial").val('');
                swal({
                    title: "Erro na Hora",
                    text: "A hora inicial deve ser menor que a final!",
                    icon: "error",
                    buttons: { ok: "Ok" }
                });
            }
        });

        // Verifica se KM Final √© menor que KM Inicial
        $("#txtKmFinal").focusout(function () {
            var kmInicial = parseInt($("#txtKmInicial").val());
            var kmFinal = parseInt($("#txtKmFinal").val());

            if (kmFinal < kmInicial) {
                $("#txtKmFinal").val('');
                swal({
                    title: "Erro na Quilometragem",
                    text: "A quilometragem final deve ser maior que a inicial!",
                    icon: "error",
                    buttons: { ok: "Ok" }
                });
            }

            if ((kmFinal - kmInicial) > 100) {
                swal({
                    title: "Alerta na Quilometragem",
                    text: "A quilometragem final excede em 100km a inicial!",
                    icon: "warning",
                    buttons: { ok: "Ok" }
                });
            }
        });

        // Verifica se KM Inicial √© maior que KM Final
        $("#txtKmInicial").focusout(function () {
            var kmInicial = parseInt($("#txtKmInicial").val());
            var kmFinal = parseInt($("#txtKmFinal").val());

            if (kmInicial > kmFinal) {
                $("#txtKmInicial").val('');
                swal({
                    title: "Erro na Quilometragem",
                    text: "A quilometragem inicial deve ser menor que a final!",
                    icon: "error",
                    buttons: { ok: "Ok" }
                });
            }
        });

        function toolbarClick(e) {
            try {
            // Kendo Editor n√£o usa rte_upload/ej2_instances ‚Äî upload via imageBrowser
            // (mantido como stub para compatibilidade)
            }
        }

        $(document).ready(function () {
            try {
                KendoDDTHelper.setValue("#ddtSetor", "@Model.ViagemObj.Viagem.SetorSolicitanteId");
                var cmbReqMain = $("#ddtRequisitante").data("kendoComboBox");
                if (cmbReqMain) cmbReqMain.value("@Model.ViagemObj.Viagem.RequisitanteId");

                // Configura a Exibi√ß√£o do Modal de Requisitantes
                $("#modalRequisitante").modal({
                    keyboard: true,
                    backdrop: "static",
                    show: false
                }).on("hide.bs.modal", function () {
                    KendoDDTHelper.setValue("#ddtSetorRequisitante", null);
                    $("#txtPonto").val('');
                    $("#txtNome").val('');
                    $("#txtRamal").val('');
                    $("#txtEmail").val('');
                });

                // Configura a Exibi√ß√£o do Modal de Setores
                $("#modalSetor").modal({
                    keyboard: true,
                    backdrop: "static",
                    show: false
                }).on("hide.bs.modal", function () {
                    KendoDDTHelper.setValue("#ddtSetorPai", null);
                    $("#txtSigla").val('');
                    $("#txtNomeSetor").val('');
                    $("#txtRamalSetor").val('');
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "document.ready", error);
            }
        });
    </script>

    <script type="text/javascript">
        // Preenche Lista de Requisitantes Ap√≥s Inser√ß√£o de um novo
        function PreencheListaRequisitantes() {
            try {
                $.ajax({
                    url: "/Viagens/Upsert?handler=AJAXPreencheListaRequisitantes",
                    method: "GET",
                    datatype: "json",
                    success: function (res) {
                        var RequisitanteList = res.data.map(function(item) {
                            return { requisitanteId: item.requisitanteId, requisitante: item.requisitante };
                        });

                        var cmbReq = $("#ddtRequisitante").data("kendoComboBox");
                        if (cmbReq) {
                            cmbReq.setDataSource(new kendo.data.DataSource({ data: RequisitanteList }));
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "PreencheListaRequisitantes", error);
            }
        }
            // Preenche Lista de Setores Ap√≥s Inser√ß√£o de um novo
    function PreencheListaSetores() {
        try {
            $.ajax({
                url: "/Viagens/Upsert?handler=AJAXPreencheListaSetores",
                method: "GET",
                datatype: "json",
                success: function (res) {
                    // Atualizar o DropDownTree principal com dados novos do servidor
                    KendoDDTHelper.setDataSource("#ddtSetor", res.data);
                    // Atualizar tamb√©m os DDTs nos modais
                    KendoDDTHelper.setDataSource("#ddtSetorRequisitante", res.data);
                    KendoDDTHelper.setDataSource("#ddtSetorPai", res.data);
                }
            });
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "PreencheListaSetores", error);
        }
    }

    // Escolheu um Requisitante
    function RequisitanteValueChange() {
        try {
            var cmbReq = $("#ddtRequisitante").data("kendoComboBox");
            if (!cmbReq || !cmbReq.value()) return;

            var requisitanteid = String(cmbReq.value());

            // Pega Setor Padr√£o do Requisitante
            $.ajax({
                url: "/Viagens/Upsert?handler=PegaSetor",
                method: "GET",
                datatype: "json",
                data: { id: requisitanteid },
                success: function (res) {
                    KendoDDTHelper.setValue("#ddtSetor", res.data);
                }
            });

            // Pega Ramal do Requisitante
            $.ajax({
                url: "/Viagens/Upsert?handler=PegaRamal",
                method: "GET",
                datatype: "json",
                data: { id: requisitanteid },
                success: function (res) {
                    var s = document.getElementById("txtRamalRequisitante");
                    s.value = res.data;
                }
            });
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "RequisitanteValueChange", error);
        }
    }

    // Escolheu um Motorista
    function MotoristaValueChange() {
        try {
            var cmbMot = $("#lstMotorista").data("kendoComboBox");
            if (!cmbMot || !cmbMot.value()) return;

            var motoristaid = String(cmbMot.value());

            // Verifica se Motorista est√° em alguma viagem
            $.ajax({
                url: "/Viagens/Upsert?handler=VerificaMotoristaViagem",
                method: "GET",
                datatype: "json",
                data: { id: motoristaid },
                success: function (res) {
                    if (res.data) {
                        swal({
                            title: "Motorista em Viagem",
                            text: "Este motorista encontra-se em uma viagem n√£o terminada!",
                            icon: "warning",
                            buttons: { ok: "Ok" }
                        });
                    }
                }
            });
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "MotoristaValueChange", error);
        }
    }

    // Escolheu um Ve√≠culo
    function VeiculoValueChange() {
        try {
            var cmbVeic = $("#lstVeiculo").data("kendoComboBox");
            if (!cmbVeic || !cmbVeic.value()) return;

            var veiculoid = String(cmbVeic.value());

            // Verifica se o ve√≠culo est√° em alguma viagem
            $.ajax({
                url: "/Viagens/Upsert?handler=VerificaVeiculoViagem",
                method: "GET",
                datatype: "json",
                data: { id: veiculoid },
                success: function (res) {
                    if (res.data) {
                        swal({
                            title: "Ve√≠culo em Viagem",
                            text: "Este ve√≠culo encontra-se em uma viagem n√£o terminada!",
                            icon: "warning",
                            buttons: { ok: "Ok" }
                        });
                    }
                }
            });

            // Pega Km Atual do Ve√≠culo
            $.ajax({
                url: "/Viagens/Upsert?handler=PegaKmAtualVeiculo",
                method: "GET",
                datatype: "json",
                data: { id: veiculoid },
                success: function (res) {
                    var kmAtual = document.getElementById("txtKmAtual");
                    kmAtual.value = res.data;
                }
            });
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "VeiculoValueChange", error);
        }
    }

    function valueChange() {
        try {
            // reservado
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "valueChange", error);
        }
    }

    function select(args) {
        try {
            // reservado
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "select", error);
        }
    }

    function ddtCombustivelChange() {
        try {
            // reservado
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "ddtCombustivelChange", error);
        }
    }
</script>

<script>
    // Bot√£o InserirRequisitante do Modal
    // ===================================
    $("#btnInserirRequisitante").click(function (e) {
        try {
            e.preventDefault();

            if ($("#txtPonto").val() === "") {
                swal({
                    title: "Aten√ß√£o",
                    text: "O Ponto do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: { close: "Fechar" }
                });
                return;
            }

            if ($("#txtNome").val() === "") {
                swal({
                    title: "Aten√ß√£o",
                    text: "O Nome do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: { close: "Fechar" }
                });
                return;
            }

            if ($("#txtRamal").val() === "") {
                swal({
                    title: "Aten√ß√£o",
                    text: "O Ramal do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: { close: "Fechar" }
                });
                return;
            }

            var setorVal = KendoDDTHelper.getValue("#ddtSetorRequisitante");
            if (!setorVal) {
                swal({
                    title: "Aten√ß√£o",
                    text: "O Setor do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: { close: "Fechar" }
                });
                return;
            }

            var setorSolicitanteId = String(setorVal);
            var objRequisitante = JSON.stringify({
                "Nome": $('#txtNome').val(),
                "Ponto": $('#txtPonto').val(),
                "Ramal": $('#txtRamal').val(),
                "Email": $('#txtEmail').val(),
                "SetorSolicitanteId": setorSolicitanteId
            });

            $.ajax({
                type: "post",
                url: "/api/Viagem/AdicionarRequisitante",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: objRequisitante,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());
                },
                success: function (data) {
                    AppToast.show('Verde', data.message);
                    PreencheListaRequisitantes();
                    $("#modalRequisitante").modal('hide');
                },
                error: function (data) {
                    console.log(data);
                    alert('error');
                }
            });
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "#btnInserirRequisitante.click", error);
        }
    });

    // Bot√£o InserirSetor do Modal
    // ============================
    $("#btnInserirSetor").click(function (e) {
        try {
            e.preventDefault();

            if ($("#txtNomeSetor").val() === "") {
                swal({
                    title: "Aten√ß√£o",
                    text: "O Nome do Setor √© obrigat√≥rio!",
                    icon: "error",
                    buttons: { close: "Fechar" }
                });
                return;
            }

            if ($("#txtRamalSetor").val() === "") {
                swal({
                    title: "Aten√ß√£o",
                    text: "O Ramal do Setor √© obrigat√≥rio!",
                    icon: "error",
                    buttons: { close: "Fechar" }
                });
                return;
            }

            var setorPaiId = null;
            var ddtPaiVal = KendoDDTHelper.getValue("#ddtSetorPai");

            if (ddtPaiVal) {
                setorPaiId = String(ddtPaiVal);
            }

            var objSetor = JSON.stringify({
                "Nome": $('#txtNomeSetor').val(),
                "Ramal": $('#txtRamalSetor').val(),
                "Sigla": $('#txtSigla').val(),
                "SetorPaiId": setorPaiId
            });

            $.ajax({
                type: "post",
                url: "/api/Viagem/AdicionarSetor",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: objSetor,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());
                },
                success: function (data) {
                    AppToast.show('Verde', data.message);
                    PreencheListaSetores();
                    $("#modalSetor").modal('hide');
                },
                error: function (data) {
                    console.log(data);
                    alert('error');
                }
            });
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "#btnInserirSetor.click", error);
        }
    });

    // Syncfusion L10n.load removido ‚Äî Kendo Editor usa localiza√ß√£o pr√≥pria via kendo-editor-upsert.js

    // Carrega a foto no controle e redimensiona o painel
    // ==================================================
    $("#txtFile").change(function (event) {
        try {
            var files = event.target.files;
            $("#imgViewer").attr("src", window.URL.createObjectURL(files[0]));
            $("#painelfundo").css({ "padding-bottom:": "200px" });
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "#txtFile.change", error);
        }
    });

    $(document).ready(function () {
        try {
            if ('@Model.ViagemObj.Viagem.ViagemId' != '00000000-0000-0000-0000-000000000000') {
                $.ajax({
                    type: "GET",
                    url: "/api/Viagem/PegaFicha",
                    success: function (data) {
                        if (data.fichaVistoria != null) {
                            $('#imgViewer').attr('src', "data:image/jpg;base64," + data.fichaVistoria);
                        } else {
                            $('#imgViewer').attr('src', "/Images/FichaAmarelaNova.jpg");
                        }
                    },
                    error: function (data) {
                        console.log('Error:', data);
                    }
                });
            } else {
                $('#imgViewer').attr('src', "/Images/FichaAmarelaNova.jpg");
                // Se quiser preencher o file input programaticamente, precisa de um fluxo com fetch/blob
                // Mantido apenas o placeholder acima.
            }
        } catch (error) {
            Alerta.TratamentoErroComLinha("TaxiLeg.cshtml", "document.ready", error);
        }
    });
</script>
}
