@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Abastecimento/PBI.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Exibir iframe embarcado do Power BI com relat√≥rio "Frotix Atualizado - Relat√≥rio por Ve√≠culo"
 * üì• ENTRADAS     : @page, @model TaxiLegModel (nomenclatura incorreta), nenhum par√¢metro adicional
 * üì§ SA√çDAS       : Iframe do Power BI (900px altura), formul√°rio com modal legados n√£o utilizados
 * üîó CHAMADA POR  : Menu "Gr√°ficos > Abastecimento"
 * üîÑ CHAMA        : https://app.powerbi.com/view?r=eyJrIjoiNmVhZjNhYTktZGYwNy00NDdkLTk5NGEtNTc2NzU1OTUzMjEwIiwidCI6IjU2MjFkNjRmLTRjZjgtNDdmNS1iMzc5LTJiMmFiNzljMWM1ZiJ9
 * üì¶ DEPEND√äNCIAS : Power BI embedded, Syncfusion EJ2 (legado n√£o usado), toastr (legado n√£o usado)
 * üìù OBSERVA√á√ïES  : Total: ~600 linhas. ISSUES: C√≥digo LEGADO MASSIVO (95% n√£o usado) - modais, forms, JavaScript de Viagens copiados incorretamente. Model incorreto (@model TaxiLegModel). CSS e scripts desnecess√°rios. Funcional mas precisa limpeza total
 **************************************************************************************** *@
@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers
@using Syncfusion.EJ2
@model FrotiX.Pages.Viagens.TaxiLegModel
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "Abastecimento";
    ViewData["PageName"] = "abastecimento_pbi";
    ViewData["Heading"] = "<i class='fa-duotone fa-chart-user'></i> Gr√°ficos: <span class='fw-300'>Abastecimento</span>";
    ViewData["Category1"] = "Gr√°ficos";
    ViewData["PageIcon"] = "fa-duotone fa-chart-user";
}

<style>
    .form-control-xs {
        height: calc(1em + .775rem + 10px) !important;
        padding: .125rem .25rem !important;
        font-size: .75rem !important;
        line-height: 1.5;
        border-radius: .2rem;
    }

    .label {
        margin-bottom: -5px;
        margin-top: 10px;
    }

    input[type=checkbox] {
        vertical-align: middle;
        position: relative;
        bottom: 1px;
    }

    .btn-largura {
        width: 100px;
        height: 100px;
    }
</style>

@section HeadBlock {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    @* <link rel="stylesheet" href="~/css/microtip.css" /> *@

}

<script>
    function stopEnterSubmitting(e) {
        if (e.keyCode == 13) {
            var src = e.srcElement || e.target;

            console.log(src.tagName.toLowerCase());

            if (src.tagName.toLowerCase() != "div") {
                if (e.preventDefault) {
                    e.preventDefault();
                } else {
                    e.returnValue = false;
                }
            }
        }
    }
</script>

<form method="post" asp-action="FichasAntigas" onkeypress='stopEnterSubmitting(window.event)' enctype="multipart/form-data">
    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel">
                <div class="panel-container show">
                    <div id="divPainel" class="panel-content">

                        <iframe title="Frotix Atualizado - Relat√≥rio por Ve√≠culo" width="100%" height="900" src="https://app.powerbi.com/view?r=eyJrIjoiNmVhZjNhYTktZGYwNy00NDdkLTk5NGEtNTc2NzU1OTUzMjEwIiwidCI6IjU2MjFkNjRmLTRjZjgtNDdmNS1iMzc5LTJiMmFiNzljMWM1ZiJ9" frameborder="0" allowFullScreen="true"></iframe>
                </div>
            </div>
        </div>
    </div>
</form>


<!-- Modal Inserir Requisitante -->
<div class="modal fade" id="modalRequisitante">
    <div class="modal-dialog modal-lg" role="document">

        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title" id="DynamicModalLabel">Inserir um novo Requisitante</h4>
            </div>


            <div class="modal-body table-bordered">
                <!-- Dynamic Data is displayed in this part of the modal body -->
                <!-- Modal body id = "modal_body" (note underscore) -->
                <form id="frmRequisitante">
                    <div class="row">
                        <div class="col-2">
                            <div class="form-group">
                                <label class="label font-weight-bold">Ponto</label>
                                <input id="txtPonto" class="form-control form-control-xs" />
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="form-group">
                                <label class="label font-weight-bold">Nome do Requisitante</label>
                                <input id="txtNome" class="form-control form-control-xs" />
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="form-group">
                                <label class="label font-weight-bold">Ramal</label>
                                <input id="txtRamal" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div class="col-8">
                            <div class="form-group">
                                <label class="label font-weight-bold">Email</label>
                                <input id="txtEmail" class="form-control form-control-xs" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div id="ControlRegion">
                            <div class="form-control-xs" style="margin: 0 auto; width: 400px;">
                                <label class="label font-weight-bold">Setor do Requisitante</label>
                                <input id="ddtSetorRequisitante" style="width: 100%;" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnInserirRequisitante" class="btn btn-azul" type="submit" value="SUBMIT">Inserir Requisitante</button>
                        <button type="button" class="btn btn-vinho" data-bs-dismiss="modal"><i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar</button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>


<!-- Modal Inserir Setor -->
<div class="modal fade" id="modalSetor">
    <div class="modal-dialog modal-lg" role="document">

        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header modal-header-azul">
                <h4 class="modal-title" id="DynamicModalLabel">Inserir um novo Setor Solicitante</h4>
            </div>


            <div class="modal-body table-bordered">
                <!-- Dynamic Data is displayed in this part of the modal body -->
                <!-- Modal body id = "modal_body" (note underscore) -->
                <form id="frmSetor">
                    <div class="row">
                        <div class="col-3">
                            <div class="form-group">
                                <label class="label font-weight-bold">Sigla</label>
                                <input id="txtSigla" class="form-control form-control-xs" placeholder="Insira a sigla" />
                            </div>
                        </div>
                        <div class="col-7">
                            <div class="form-group">
                                <label class="label font-weight-bold">Nome do Setor</label>
                                <input id="txtNomeSetor" class="form-control form-control-xs" placeholder="Insira o nome do setor" />
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="form-group">
                                <label class="label font-weight-bold">Ramal</label>
                                <input id="txtRamalSetor" class="form-control form-control-xs" placeholder="Insira o ramal" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="row">
                        <div id="ControlRegion">
                            <div class="form-control-xs" style="margin: 0 auto; width: 400px;">
                                <label class="label font-weight-bold">Setor Pai (se houver)</label>
                                <input id="ddtSetorPai" style="width: 100%;" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="btnInserirSetor" class="btn btn-azul" type="submit" value="SUBMIT">Inserir Setor</button>
                        <button type="button" class="btn btn-vinho" data-bs-dismiss="modal"><i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar</button>
                    </div>
                </form>
            </div>
            <!-- Modal footer -->
        </div>
    </div>
</div>



@section ScriptsBlock
{
    <script type="text/javascript">
        // Inicializar Kendo DropDownTree para Setor
        (function () {
            try {
                var dataSetor = @Html.Raw(Json.Serialize(ViewData["dataSetor"]));

                KendoDDTHelper.initHierarchical({
                    selector: "#ddtSetorRequisitante",
                    flatData: dataSetor,
                    placeholder: "Selecione um Setor"
                });

                KendoDDTHelper.initHierarchical({
                    selector: "#ddtSetorPai",
                    flatData: dataSetor,
                    placeholder: "Selecione um Setor"
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "kendoDDT.init", error);
            }
        })();

        window.onload = function () {
            try {
                if ('@Model.ViagemObj.Viagem.CombustivelInicial' != null) {
                    var ddlCombInicial = $("#ddtCombustivelInicial").data("kendoDropDownList");
                    if (ddlCombInicial) ddlCombInicial.value('@Model.ViagemObj.Viagem.CombustivelInicial');
                }
                if ('@Model.ViagemObj.Viagem.ViagemId' === '00000000-0000-0000-0000-000000000000') {
                    document.getElementById("txtDataInicial").value = moment(Date()).format("YYYY-MM-DD");
                    // document.getElementById("txtHoraInicial").value = moment(Date()).format("HH:mm");
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "onload", error);
            }
        };


        //Controla o Submit do formul√°rio atrav√©s de bot√µes escondidos (permite a valida√ß√£o via javascript)
        //=================================================================================================
        $("#btnSubmit").click(function (event) {

            event.preventDefault()


            if (document.getElementById("txtNoFichaVistoria").value === "") {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "O n√∫mero da Ficha de Vistoria √© obrigat√≥rio",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            if (document.getElementById("txtDataInicial").value === "") {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "A Data Inicial √© obrigat√≥ria",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            if (document.getElementById("txtHoraInicial").value === "") {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "A Hora Inicial √© obrigat√≥ria",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            var ddlFinalidade = $("#lstFinalidade").data("kendoDropDownList");
            if (!ddlFinalidade || !ddlFinalidade.value()) {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "A Finalidade √© obrigat√≥ria",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            if (document.getElementById("txtOrigem").value === "") {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "A Origem √© obrigat√≥ria",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            var cmbMotorista = $("#lstMotorista").data("kendoComboBox");
            if (!cmbMotorista || !cmbMotorista.value()) {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "O Motorista √© obrigat√≥rio",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            var cmbVeiculo = $("#lstVeiculo").data("kendoComboBox");
            if (!cmbVeiculo || !cmbVeiculo.value()) {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "O Ve√≠culo √© obrigat√≥rio",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            if (document.getElementById("txtKmInicial").value === "") {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "A Quilometragem Inicial √© obrigat√≥ria",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            var ddlCombInicial = $("#ddtCombustivelInicial").data("kendoDropDownList");

            console.log(ddlCombInicial ? ddlCombInicial.value() : null);

            if (ddlCombInicial && ddlCombInicial.value() != "tanquevazio" && ddlCombInicial.value() != "tanqueumquarto" && ddlCombInicial.value() != "tanquemeiotanque" && ddlCombInicial.value() != "tanquetresquartos" && ddlCombInicial.value() != "tanquecheio") {
                console.log("Compust√≠vel Inicial: " + ddlCombInicial.value());
            }

            if (!ddlCombInicial || !ddlCombInicial.value()) {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "O N√≠vel de Combust√≠vel Inicial √© obrigat√≥rio",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            var cmbRequisitante = $("#ddtRequisitante").data("kendoComboBox");
            if (!cmbRequisitante || !cmbRequisitante.value()) {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "O Requisitante √© obrigat√≥rio",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            if (document.getElementById("txtRamalRequisitante").value === "") {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "O Ramal do Requisitante √© obrigat√≥rio",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            var setorVal = KendoDDTHelper.getValue("#ddtSetor");
            if (!setorVal) {
                swal({
                    title: "Informa√ß√£o Ausente",
                    text: "O Setor Solicitante √© obrigat√≥rio",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
                return;
            }

            $("#btnEscondido").click();

        });



        $(document).ready(function () {

            if ('@Model.ViagemObj.Viagem.ViagemId' === '00000000-0000-0000-0000-000000000000')
            {
                document.getElementById("txtDataInicial").value = moment(Date()).format("YYYY-MM-DD");
                document.getElementById("txtHoraInicial").value = moment(Date()).format("HH:mm");
                document.getElementById("divFicha").style.display = 'none';

            }

            //Bloqueia controles caso a viagem j√° tenha sido realizada ou cancelada
            if ('@Model.ViagemObj.Viagem.Status' === 'Realizada' || '@Model.ViagemObj.Viagem.Status' === 'Cancelada') {

                var childNodes = document.getElementById("divPainel").getElementsByTagName('*');
                for (var node of childNodes) {
                    node.disabled = true;
                }

                var rteEditor = $("#rte").data("kendoEditor");
                if (rteEditor) { rteEditor.body.contentEditable = false; }
                var cmbMot = $("#lstMotorista").data("kendoComboBox");
                if (cmbMot) cmbMot.enable(false);
                var cmbVeic = $("#lstVeiculo").data("kendoComboBox");
                if (cmbVeic) cmbVeic.enable(false);
                var cmbReq = $("#ddtRequisitante").data("kendoComboBox");
                if (cmbReq) cmbReq.enable(false);
                KendoDDTHelper.enable("#ddtSetor", false);
                var ddlCombI = $("#ddtCombustivelInicial").data("kendoDropDownList");
                if (ddlCombI) ddlCombI.enable(false);
                var ddlCombF = $("#ddtCombustivelFinal").data("kendoDropDownList");
                if (ddlCombF) ddlCombF.enable(false);
                var ddlFin = $("#lstFinalidade").data("kendoDropDownList");
                if (ddlFin) ddlFin.enable(false);

                document.getElementById("divSubmit").style.display = 'none';
                $("#btnSubmit").hide();

            }


            //Atualiza Controles Kendo da P√°gina
            if ('@Model.ViagemObj.Viagem.CombustivelInicial' != null) {

                var ddlCI = $("#ddtCombustivelInicial").data("kendoDropDownList");
                if (ddlCI) ddlCI.value('@Model.ViagemObj.Viagem.CombustivelInicial');

            }

            if ('@Model.ViagemObj.Viagem.CombustivelFinal' != null) {

                var ddlCF = $("#ddtCombustivelFinal").data("kendoDropDownList");
                if (ddlCF) ddlCF.value('@Model.ViagemObj.Viagem.CombustivelFinal');

            }

        });

    </script>


    <script type="text/javascript">


        $("#txtNoFichaVistoria").focusout(function () {

            if (document.getElementById("txtNoFichaVistoria").value === '') {
                return;
            }

            var noFichaVistoria = document.getElementById("txtNoFichaVistoria").value;


            ////Verifica se N√∫mero da Ficha est√° muito diferente do √∫ltimo inserido
            //$.ajax({
            //    url: "/Viagens/Upsert?handler=VerificaFicha",
            //    method: "GET",
            //    datatype: "json",
            //    data: { id: document.getElementById("txtNoFichaVistoria").value },
            //    success: function (res) {

            //        var maxFichaVistoria = [res.data];

            //        console.log("NoFichaVistoria: " + noFichaVistoria);
            //        console.log("MAxFichaVistoria: " + maxFichaVistoria);

            //        if ((noFichaVistoria > (parseInt(maxFichaVistoria) + 100))) {
            //            swal({
            //                title: "Alerta na Ficha de Vistoria",
            //                text: "O n√∫mero inserido difere em +100 da √∫ltima Ficha inserida!",
            //                icon: "warning",
            //                buttons: true,
            //                
            //                buttons: {
            //                    ok: "Ok"
            //                }
            //            })

            //            return;
            //        }

            //        if ((noFichaVistoria < (parseInt(maxFichaVistoria) - 100))) {
            //            swal({
            //                title: "Alerta na Ficha de Vistoria",
            //                text: "O n√∫mero inserido difere em -100 da √∫ltima Ficha inserida!",
            //                icon: "warning",
            //                buttons: true,
            //                
            //                buttons: {
            //                    ok: "Ok"
            //                }
            //            })

            //            return;
            //        }

            //        //debugger;
            //    }
            //})


            //Verifica se N√∫mero da Ficha j√° foi cadastrado
            $.ajax({
                url: "/Viagens/Upsert?handler=FichaExistente",
                method: "GET",
                datatype: "json",
                data: { id: document.getElementById("txtNoFichaVistoria").value },
                success: function (res) {

                    var ExisteFicha = [res.data];

                    console.log("Data: " + [res.data]);
                    console.log("ExisteFicha: " + ExisteFicha);

                    //debugger;

                    if (ExisteFicha[0] === true) {
                        swal({
                            title: "Alerta na Ficha de Vistoria",
                            text: "J√° existe uma Ficha inserida com esta numera√ß√£o!",
                            icon: "warning",
                            buttons: true,
                            
                            buttons: {
                                ok: "Ok"
                            }
                        })

                        return;
                    }

                    //debugger;
                }
            })


        });


        //Verifica se Data Final √© menor que Data Inicial
        $("#txtDataFinal").focusout(function () {

            DataInicial = $("#txtDataInicial").val();
            DataFinal = $("#txtDataFinal").val();

            if (DataFinal === '') {
                return;
            }

            if ((DataFinal < DataInicial)) {
                $("#txtDataFinal").val('');
                swal({
                    title: "Erro na Data",
                    text: "A data final deve ser maior que a inicial!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })

            }
        });

        //Verifica se Data Inicial √© maior que Data Final
        $("#txtDataInicial").focusout(function () {

            DataInicial = $("#txtDataInicial").val();
            DataFinal = $("#txtDataFinal").val();

            if (DataInicial === '' || DataFinal === '') {
                return;
            }

            if ((DataInicial > DataFinal)) {
                $("#txtDataInicial").val('');
                swal({
                    title: "Erro na Data",
                    text: "A data inicial deve ser menor que a final!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })

            }
        });

        //Verifica se Hora Final √© menor que Hora Inicial e se tem Data Final
        $("#txtHoraFinal").focusout(function () {

            HoraInicial = $("#txtHoraInicial").val();
            HoraFinal = $("#txtHoraFinal").val();
            DataInicial = $("#txtDataInicial").val();
            DataFinal = $("#txtDataFinal").val();

            console.log(HoraInicial);
            console.log(HoraFinal);
            console.log(DataFinal);

            if (DataFinal === '') {
                $("#txtHoraFinal").val('');
                swal({
                    title: "Erro na Hora Final",
                    text: "Preencha a Data Final para poder preencher a Hora Final!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })
            }

            if ((HoraFinal < HoraInicial) && (DataInicial === DataFinal)) {
                $("#txtHoraFinal").val('');
                swal({
                    title: "Erro na Hora",
                    text: "A hora final deve ser maior que a inicial!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })

            }
        });

        //Verifica se Hora inicial √© maior que Hora final
        $("#txtHoraInicial").focusout(function () {

            HoraInicial = $("#txtHoraInicial").val();
            HoraFinal = $("#txtHoraFinal").val();

            console.log(HoraInicial);
            console.log(HoraFinal);

            if (HoraFinal === '') {
                return;
            }

            if (HoraInicial > HoraFinal) {
                $("#txtHoraInicial").val('');
                swal({
                    title: "Erro na Hora",
                    text: "A hora inicial deve ser menor que a final!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })

            }
        });


        //Verifica se KM Final √© menor que KM Inicial
        $("#txtKmFinal").focusout(function () {

            kmInicial = parseInt($("#txtKmInicial").val());
            kmFinal = parseInt($("#txtKmFinal").val());

            if (kmFinal < kmInicial) {
                $("#txtKmFinal").val('');
                swal({
                    title: "Erro na Quilometragem",
                    text: "A quilometragem final deve ser maior que a inicial!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })

            }


            if ((kmFinal - kmInicial) > 100) {
                swal({
                    title: "Alerta na Quilometragem",
                    text: "A quilometragem final excede em 100km a inicial!",
                    icon: "warning",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })

            }



        });


        //Verifica se KM Inicial √© maior que KM Inicial
        $("#txtKmInicial").focusout(function () {

            kmInicial = parseInt($("#txtKmInicial").val());
            kmFinal = parseInt($("#txtKmFinal").val());

            if (kmInicial > kmFinal) {
                $("#txtKmInicial").val('');
                swal({
                    title: "Erro na Quilometragem",
                    text: "A quilometragem inicial deve ser menor que a final!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        ok: "Ok"
                    }
                })

            }
        });

        //Verifica se KM Inicial √© menor ou diferente de KM Atual
        //$("#txtKmInicial").focusout(function () {

        //    if ($("#txtKmInicial").val() === '' || $("#txtKmInicial").val() === null) {
        //        return;
        //    }

        //    kmInicial = parseInt($("#txtKmInicial").val());
        //    kmAtual = parseInt($("#txtKmAtual").val());

        //    console.log(kmInicial);

        //    if (kmInicial < kmAtual) {
        //        $("#txtKmInicial").val('');
        //        swal({
        //            title: "Erro na Quilometragem",
        //            text: "A quilometragem inicial deve ser maior que a atual!",
        //            icon: "error",
        //            buttons: true,
        //            
        //            buttons: {
        //                ok: "Ok"
        //            }
        //        })
        //        return;
        //    }

        //    if (kmInicial != kmAtual) {
        //        //$("#txtKmInicial").val('');
        //        swal({
        //            title: "Erro na Quilometragem",
        //            text: "A quilometragem inicial n√£o confere com a atual!",
        //            icon: "warning",
        //            buttons: true,
        //            
        //            buttons: {
        //                ok: "Ok"
        //            }
        //        })
        //        return;
        //    }

        //});


        function toolbarClick(e) {
            try {
            // Kendo Editor n√£o usa rte_upload/ej2_instances ‚Äî upload via imageBrowser
            // (mantido como stub para compatibilidade)
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "toolbarClick", error);
            }
        }

        $(document).ready(function () {


            KendoDDTHelper.setValue("#ddtSetor", "@Model.ViagemObj.Viagem.SetorSolicitanteId");
            var cmbReqMain = $("#ddtRequisitante").data("kendoComboBox");
            if (cmbReqMain) cmbReqMain.value("@Model.ViagemObj.Viagem.RequisitanteId");

            //Configura a Exibi√ß√£o do Modal de Requisitantes
            //==============================================
            $("#modalRequisitante").modal({
                keyboard: true,
                backdrop: "static",
                show: false,

            }).on("show.bs.modal", function (event) {


            }).on("hide.bs.modal", function (event) {
                KendoDDTHelper.setValue("#ddtSetorRequisitante", null);
                $("#txtPonto").val('');
                $("#txtNome").val('');
                $("#txtRamal").val('');
                $("#txtEmail").val('');
            });

            //Configura a Exibi√ß√£o do Modal de Setores
            //========================================
            $("#modalSetor").modal({
                keyboard: true,
                backdrop: "static",
                show: false,

            }).on("show.bs.modal", function (event) {


            }).on("hide.bs.modal", function (event) {
                KendoDDTHelper.setValue("#ddtSetorPai", null);
                $("#txtSigla").val('');
                $("#txtNomeSetor").val('');
                $("#txtRamalSetor").val('');
            });

        });

    </script>

    <script type="text/javascript">


        //Preenche Lista de Requisitantes Ap√≥s Inser√ß√£o de um novo
        function PreencheListaRequisitantes() {
            try {
                $.ajax({
                    url: "/Viagens/Upsert?handler=AJAXPreencheListaRequisitantes",
                    method: "GET",
                    datatype: "json",
                    success: function (res) {
                        var RequisitanteList = res.data.map(function(item) {
                            return { requisitanteId: item.requisitanteId, requisitante: item.requisitante };
                        });

                        var cmbReq = $("#ddtRequisitante").data("kendoComboBox");
                        if (cmbReq) {
                            cmbReq.setDataSource(new kendo.data.DataSource({ data: RequisitanteList }));
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "PreencheListaRequisitantes", error);
            }
        }

        //Preenche Lista de Setores Ap√≥s Inser√ß√£o de um novo
        function PreencheListaSetores() {
            try {
                $.ajax({
                    url: "/Viagens/Upsert?handler=AJAXPreencheListaSetores",
                    method: "GET",
                    datatype: "json",
                    success: function (res) {
                        // Atualizar o DropDownTree principal com dados novos do servidor
                        KendoDDTHelper.setDataSource("#ddtSetor", res.data);
                        // Atualizar tamb√©m os DDTs nos modais
                        KendoDDTHelper.setDataSource("#ddtSetorRequisitante", res.data);
                        KendoDDTHelper.setDataSource("#ddtSetorPai", res.data);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "PreencheListaSetores", error);
            }
        }

        //Escolheu um Requisitante
        function RequisitanteValueChange() {
            try {
                var cmbReq = $("#ddtRequisitante").data("kendoComboBox");
                if (!cmbReq || !cmbReq.value()) return;

                var requisitanteid = String(cmbReq.value());

                //Pega Setor Padr√≠o do Requisitante
                $.ajax({
                    url: "/Viagens/Upsert?handler=PegaSetor",
                    method: "GET",
                    datatype: "json",
                    data: { id: requisitanteid },
                    success: function (res) {
                        KendoDDTHelper.setValue("#ddtSetor", res.data);
                    }
                });

                //Pega Ramal do Requisitante
                $.ajax({
                    url: "/Viagens/Upsert?handler=PegaRamal",
                    method: "GET",
                    datatype: "json",
                    data: { id: requisitanteid },
                    success: function (res) {
                        var s = document.getElementById("txtRamalRequisitante");
                        s.value = res.data;
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "RequisitanteValueChange", error);
            }
        }

        //Escolheu um Motorista
        function MotoristaValueChange() {
            try {
                var cmbMot = $("#lstMotorista").data("kendoComboBox");
                if (!cmbMot || !cmbMot.value()) return;

                var motoristaid = String(cmbMot.value());

                //Verifica se Motorista est√° em alguma viagem
                $.ajax({
                    url: "/Viagens/Upsert?handler=VerificaMotoristaViagem",
                    method: "GET",
                    datatype: "json",
                    data: { id: motoristaid },
                    success: function (res) {
                        if (res.data) {
                            swal({
                                title: "Motorista em Viagem",
                                text: "Este motorista encontra-se em uma viagem n√£o terminada!",
                                icon: "warning",
                                buttons: { ok: "Ok" }
                            });
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "MotoristaValueChange", error);
            }
        }

        //Escolheu um Ve√≠culo
        function VeiculoValueChange() {
            try {
                var cmbVeic = $("#lstVeiculo").data("kendoComboBox");
                if (!cmbVeic || !cmbVeic.value()) return;

                var veiculoid = String(cmbVeic.value());

                //Verifica se o ve√≠culo est√° em alguma viagem
                $.ajax({
                    url: "/Viagens/Upsert?handler=VerificaVeiculoViagem",
                    method: "GET",
                    datatype: "json",
                    data: { id: veiculoid },
                    success: function (res) {
                        if (res.data) {
                            swal({
                                title: "Ve√≠culo em Viagem",
                                text: "Este ve√≠culo encontra-se em uma viagem n√£o terminada!",
                                icon: "warning",
                                buttons: { ok: "Ok" }
                            });
                        }
                    }
                });

                //Pega Km Atual do Ve√≠culo
                $.ajax({
                    url: "/Viagens/Upsert?handler=PegaKmAtualVeiculo",
                    method: "GET",
                    datatype: "json",
                    data: { id: veiculoid },
                    success: function (res) {
                        var kmAtual = document.getElementById("txtKmAtual");
                        kmAtual.value = res.data;
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("PBI.cshtml", "VeiculoValueChange", error);
            }
        }

        function valueChange() {
            //    var ddTreeObj = document.getElementById("ddtree").ej2_instances[0];
            //    console.info(ddTreeObj.value + " - " + ddTreeObj.text);
        }

        function select(args) {
            //    var ddTreeObj = document.getElementById("ddtree").ej2_instances[0];
            //    console.info(ddTreeObj.value + " - " + ddTreeObj.text);
        }

        function ddtCombustivelChange() {

            //var ddtCombustivel = document.getElementById("ddtCombustivel").ej2_instances[0];
            //console.log(ddtCombustivel.value);

        }

    </script>

    <script>

        // Bot√£o InserirRequisitante do Modal
        //===================================
        $("#btnInserirRequisitante").click(function (e) {

            e.preventDefault();

            if ($("#txtPonto").val() === "") {
                swal({
                    title: 'Aten√ß√£o',
                    text: "O Ponto do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            if ($("#txtNome").val() === "") {
                swal({
                    title: 'Aten√ß√£o',
                    text: "O Nome do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            if ($("#txtRamal").val() === "") {
                swal({
                    title: 'Aten√ß√£o',
                    text: "O Ramal do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            var setorVal = KendoDDTHelper.getValue("#ddtSetorRequisitante");
            if (!setorVal) {
                swal({
                    title: 'Aten√ß√£o',
                    text: "O Setor do Requisitante √© obrigat√≥rio!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            var setorSolicitanteId = String(setorVal);

            var objRequisitante = JSON.stringify({ "Nome": $('#txtNome').val(), "Ponto": $('#txtPonto').val(), "Ramal": $('#txtRamal').val(), "Email": $('#txtEmail').val(), "SetorSolicitanteId": setorSolicitanteId })

            $.ajax({
                type: "post",
                url: "/api/Viagem/AdicionarRequisitante",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: objRequisitante,

                success: function (data) {
                    AppToast.show('Verde', data.message);
                    PreencheListaRequisitantes();
                    $("#modalRequisitante").hide();

                },
                error: function (data) {
                    alert('error');
                    console.log(data);
                }
            });
        });


        // Bot√£o InserirSetor do Modal
        //============================
        $("#btnInserirSetor").click(function (e) {

            e.preventDefault();

            if ($("#txtNomeSetor").val() === "") {
                swal({
                    title: 'Aten√ß√£o',
                    text: "O Nome do Setor √© obrigat√≥rio!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            if ($("#txtRamalSetor").val() === "") {
                swal({
                    title: 'Aten√ß√£o',
                    text: "O Ramal do Seor √© obrigat√≥rio!",
                    icon: "error",
                    buttons: true,
                    
                    buttons: {
                        close: "Fechar",
                    }
                });
                return
            };

            var setorPaiId = null;
            var ddtPaiVal = KendoDDTHelper.getValue("#ddtSetorPai");

            if (ddtPaiVal) {
                setorPaiId = String(ddtPaiVal);
            }

            if ((setorPaiId === null)) {
                var objSetor = JSON.stringify({ "Nome": $('#txtNomeSetor').val(), "Ramal": $('#txtRamalSetor').val(), "Sigla": $('#txtSigla').val() })
            }
            else {
                var objSetor = JSON.stringify({ "Nome": $('#txtNomeSetor').val(), "Ramal": $('#txtRamalSetor').val(), "Sigla": $('#txtSigla').val(), "SetorPaiId": setorPaiId })
            };

            console.log(objSetor);

            $.ajax({
                type: "post",
                url: "/api/Viagem/AdicionarSetor",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: objSetor,

                success: function (data) {
                    AppToast.show('Verde', data.message);
                    PreencheListaSetores();
                    $("#modalSetor").hide();
                    //location.reload();

                },
                error: function (data) {
                    alert('error');
                    console.log(data);
                }
            });
        });


        // Syncfusion L10n.load removido ‚Äî Kendo Editor usa localiza√ß√£o pr√≥pria via kendo-editor-upsert.js


        //Carrega a foto no controle e redimensiona o painel
        //==================================================
        $("#txtFile").change(function (event) {
            var files = event.target.files;
            $("#imgViewer").attr("src", window.URL.createObjectURL(files[0]));
            $("#painelfundo").css({
                "padding-bottom:": "200px"
            });
        });


        $(document).ready(function () {
            if ('@Model.ViagemObj.Viagem.ViagemId' != '00000000-0000-0000-0000-000000000000') {
                console.info("Foto do Editar");
                console.info('@Model.ViagemObj.Viagem.FichaVistoria');
                $.ajax({
                    type: "GET",
                    url: "/api/Viagem/PegaFicha",
                    success: function (data) {
                        console.info(data);

                        if (data.fichaVistoria != null) {
                            $('#imgViewer').attr('src', "data:image/jpg;base64," + data.fichaVistoria + "");
                        }
                        else
                        {
                            $('#imgViewer').attr('src', "/Images/FichaAmarelaNova.jpg");
                        }

                    },
                    error: function (data) {
                        console.log('Error:', data);
                    }
                });
            } else {
                console.info("Foto do Inserir");
                var origin = window.location.origin
                console.info(origin + "/Images/FichaAmarelaNova.jpg");
                $('#imgViewer').attr('src', "/Images/FichaAmarelaNova.jpg");


                let list = new DataTransfer();
                let file = new File(["content"], origin + "/Images/FichaAmarelaNova.jpg");
                list.items.add(file);
                let myFileList = list.files;
                document.querySelector('.image-url').files = myFileList;
                //$('#txtFile').attr('value', origin + "/Images/barbudo.jpg");

            }
        });


    </script>

}
