@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/Abastecimento/UpsertCupons.cshtml
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Criar/editar registros de cupons de abastecimento com upload de PDF
 * üì• ENTRADAS     : @page, @model UpsertCuponsModel, id do registro (query string para edi√ß√£o)
 * üì§ SA√çDAS       : Form com upload Kendo, preview PDF, Kendo Editor para observa√ß√µes
 * üîó CHAMADA POR  : Menu "Cadastros > Cupons", bot√£o "Novo" da lista RegistraCupons
 * üîÑ CHAMA        : /api/Abastecimento/SavePDF (POST), /api/Abastecimento/RemovePDF (DELETE)
 * üì¶ DEPEND√äNCIAS : Kendo Upload, Kendo Editor, Kendo PDFViewer, tiraacento_001.js, jQuery
 * üìù OBSERVA√á√ïES  : Migrado Syncfusion RTE ‚Üí Kendo Editor em 13/02/2026
 **************************************************************************************** *@
@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model FrotiX.Pages.Abastecimento.UpsertCuponsModel

@{
	ViewData["Title"] = "Registro de Cupons";
	ViewData["PageName"] = "abastecimento_registracupons";
	ViewData["Heading"] = "<i class='fa-duotone fa-scroll'></i> Cadastros: <span class='fw-300'>Registra Cupons de Abastecimento</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-scroll";
}

<style>
	.form-control-xs {
		height: calc(1em + .775rem + 10px) !important;
		padding: .125rem .25rem !important;
		font-size: .75rem !important;
		line-height: 1.5;
		border-radius: .2rem;
	}

	.label {
		margin-bottom: -5px;
		margin-top: 10px;
	}

	input[type=checkbox] {
		vertical-align: middle;
		position: relative;
		bottom: 1px;
	}

	.btn-largura {
		width: 100px;
		height: 100px;
	}

	.fundo-chocolate {
		background-color: #7B3F00;
		color: white;
	}
</style>

@* CSS Kendo UI j√° carregado via _ScriptsBasePlugins.cshtml (vers√£o 2025.2.520) *@

<form method="post" onkeypress="stopEnterSubmitting(event)" enctype="multipart/form-data">
	@Html.AntiForgeryToken()

	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel">
				<!-- ===== HEADER FROTIX ===== -->
				<div class="ftx-card-header">
					<h2 class="titulo-paginas">
						<i class="fa-duotone fa-scroll"></i>
						@(Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId != Guid.Empty ?
												"Atualizar " : "Registrar ")
						Cupons de Abastecimento
					</h2>
				</div>

				<div class="panel-container show">
					<div id="divPainel" class="panel-content">
						<div asp-validation-summary="ModelOnly" class="text-danger">
							@if (Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId !=
														Guid.Empty)
							{
								<input type="hidden"
									asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId" />
							}
						</div>

						<div class="p-3">
							<div class="row">
								<div class="col-6 col-md-2 col-xl-2">
									<div class="form-group">
										<label class="label font-weight-bold ftx-label label-required"
											asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.DataRegistro"></label>
										<span class="text-danger font-weight-light"
											asp-validation-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.DataRegistro"></span>
										<input id="txtDataRegistro" class="form-control form-control-xs"
											asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.DataRegistro"
											type="date" />
									</div>
								</div>
							</div>

							<br />

							<div class="row">
								<div class="col-md-12 col-xl-10 control-section">
									<div class="control-wrapper">
										<div>
											<input type="file" name="files" id="pdf" />
											<input id="txtRegistroPDF" class="form-control form-control-xs"
												asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF"
												hidden="hidden" />
											<div id="PDFContainer">
												<div id="pdfViewer"></div>
											</div>
										</div>
										<br />
									</div>
								</div>
							</div>

							<br />

							<div class="row">
								<div class="col-md-12 col-xl-10 control-section">
									<div class="control-wrapper">
										<div>
											<label class="label font-weight-bold">Observa√ß√µes a respeito do
												Registro</label>
									<textarea id="rte" name="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.Observacoes"
										style="height: 150px;">@(Model.RegistroCupomAbastecimentoObj?.RegistroCupomAbastecimento?.Observacoes ?? "")</textarea>
											<div id="errorMessage">
												<span
													asp-validation-for="@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.Observacoes"></span>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div class="row pb-5"></div>
							<div class="row"></div>
							<div class="row pb-5"></div>

							<div class="form-group row">
								<div class="col-12">
									<div class="row">
										<div id="divSubmit" class="col-12 col-md-4 pb-2">
											@if
																						(Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId
																						!= Guid.Empty)
											{
												<button id="btnSubmit" type="submit" asp-page-handler="Edit"
													asp-route-id="@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId"
													class="btn btn-azul btn-submit-spin form-control">
													<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
													Atualizar Cupom
												</button>
											}
											else
											{
												<button id="btnSubmit" type="submit" value="Submit"
													asp-page-handler="Submit"
													class="btn btn-azul btn-submit-spin form-control">
													<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
													Criar Cupom
												</button>
											}
										</div>

										<div class="col-12" hidden>
											@if
																						(Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId
																						!= Guid.Empty)
											{
												<button id="btnEscondido" type="submit" asp-page-handler="Edit"
													asp-route-id="@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId"
													class="btn btn-azul form-control">
													<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
													Atualizar Cupom
												</button>
											}
											else
											{
												<button id="btnEscondido" type="submit" value="Submit"
													asp-page-handler="Submit" class="btn btn-azul form-control">
													<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
													Criar Cupom
												</button>
											}
										</div>

										<div class="col-12 col-md-4">
											<a asp-page="./RegistraCupons" class="btn btn-ftx-fechar form-control"
												data-ftx-loading><i
													class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i>
												Cancelar Opera√ß√£o</a>
										</div>

										<br />
									</div>
								</div>
							</div>
						</div> <!-- .p-3 -->
					</div> <!-- #divPainel -->
				</div> <!-- .panel-container -->
			</div> <!-- #panel-1 -->
		</div> <!-- .col-xl-12 -->
	</div> <!-- .row -->
</form>

@section ScriptsBlock {
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

	<!-- PDF.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
	<script>
		window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
	</script>

	<script src="~/js/cadastros/tiraacento_001.js"></script>

	<script>
		function stopEnterSubmitting(e) {
			try {
				try {
					if (e.keyCode === 13) {
						var src = e.srcElement || e.target;

						console.log(src && src.tagName ? src.tagName.toLowerCase() : 'unknown');

						if (src && src.tagName && src.tagName.toLowerCase() !== "div") {
							if (e.preventDefault) {
								e.preventDefault();
							} else {
								e.returnValue = false;
							}
						}
					}
				} catch (error) {
					Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "stopEnterSubmitting", error);
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "stopEnterSubmitting", error);
			}
		}
	</script>

	<script>
		// Controla o Submit do formul√°rio atrav√©s de bot√µes escondidos (permite a valida√ß√£o via javascript)
		// ================================================================================================
		$("#btnSubmit").on("click", function (event) {
			try {
				event.preventDefault();

				if (document.getElementById("txtDataRegistro").value === "") {
					Alerta.Erro("Informa√ß√£o Ausente", "A Data do Registro √© obrigat√≥ria");
					return;
				}

				$("#btnEscondido").trigger("click");
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "#btnSubmit.click", error);
			}
		});
	</script>

	<script>
		$(document).ready(function () {
			try {
				if ('@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId' !== '00000000-0000-0000-0000-000000000000') {
					// Visualiza o PDF, se houver
					if ('@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF' != null &&
						'@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF' !== '') {
						$("#pdfViewer").kendoPDFViewer({
							pdfjsProcessing: {
								file: "/DadosEditaveis/Cupons/" + '@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF'
							},
							width: "100%",
							height: 400
						}).data("kendoPDFViewer");
					}
				} else {
					document.getElementById("txtDataRegistro").setAttribute('value', '');
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "document.ready", error);
			}
		});
	</script>

	<script>
		/****************************************************************************************
		 * ‚ö° INICIALIZA√á√ÉO: Kendo Editor para Observa√ß√µes
		 * --------------------------------------------------------------------------------------
		 * üéØ OBJETIVO     : Inicializar Kendo Editor no textarea #rte para observa√ß√µes do cupom
		 * üì• ENTRADAS     : Elemento textarea#rte
		 * üì§ SA√çDAS       : Widget Kendo Editor configurado com toolbar completa
		 * üîó CHAMADA POR  : Carregamento da p√°gina
		 ****************************************************************************************/
		(function () {
			try {
				$("#rte").kendoEditor({
					tools: [
						"bold", "italic", "underline", "strikethrough",
						"separator",
						"justifyLeft", "justifyCenter", "justifyRight", "justifyFull",
						"separator",
						"insertUnorderedList", "insertOrderedList",
						"separator",
						"indent", "outdent",
						"separator",
						"createLink", "unlink",
						"separator",
						"fontName", "fontSize",
						"separator",
						"foreColor", "backColor",
						"separator",
						"cleanFormatting",
						"separator",
						"viewHtml"
					],
					resizable: { content: true, toolbar: false },
					messages: {
						bold: "Negrito",
						italic: "It√°lico",
						underline: "Sublinhado",
						strikethrough: "Tachado",
						justifyLeft: "Alinhar √† esquerda",
						justifyCenter: "Centralizar",
						justifyRight: "Alinhar √† direita",
						justifyFull: "Justificar",
						insertUnorderedList: "Lista",
						insertOrderedList: "Lista numerada",
						indent: "Aumentar recuo",
						outdent: "Diminuir recuo",
						createLink: "Inserir link",
						unlink: "Remover link",
						fontName: "Fonte",
						fontSize: "Tamanho",
						foreColor: "Cor do texto",
						backColor: "Cor de fundo",
						cleanFormatting: "Limpar formata√ß√£o",
						viewHtml: "Ver HTML"
					}
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "kendoEditor.init", error);
			}
		})();
	</script>

	<script>
		/****************************************************************************************
		 * ‚ö° INICIALIZA√á√ÉO: Kendo Upload para PDF de Cupons
		 * --------------------------------------------------------------------------------------
		 * üéØ OBJETIVO     : Configurar upload de PDF desabilitando drag-drop e inicializando
		 *                   o widget kendoUpload com valida√ß√£o de extens√£o .pdf
		 * üì• ENTRADAS     : Elemento #pdf
		 * üì§ SA√çDAS       : Widget Kendo Upload configurado
		 * üîó CHAMADA POR  : $(document).ready()
		 * üìù OBSERVA√á√ïES  : C√≥digo movido para $(document).ready() para garantir que
		 *                   kendo.ui.Upload est√° dispon√≠vel antes de modificar o prot√≥tipo
		 ****************************************************************************************/
		$(document).ready(function() {
			try {
				// [KENDO] Desabilita o Drop Zone (modifica prot√≥tipo do Kendo Upload)
				if (typeof kendo !== 'undefined' && kendo.ui && kendo.ui.Upload) {
					kendo.ui.Upload.fn._supportsDrop = function () {
						return false;
					};
				}

				// [KENDO] Inicializa o Upload do PDF
				$("#pdf").kendoUpload({
					async: {
						saveUrl: "/Abastecimento/UpsertCupons?handler=SavePDF",
						removeUrl: "/Abastecimento/UpsertCupons?handler=RemovePDF"
					},
					localization: {
						select: "Selecione o Registro de Cupons de Abastecimento...",
						headerStatusUploaded: "Arquivo Carregado",
						uploadSuccess: "Arquivo Carregado com Sucesso"
					},
					validation: {
						allowedExtensions: [".pdf"]
					},
					success: onSuccess
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "kendoUpload.init", error);
			}
		});

		/****************************************************************************************
		 * ‚ö° FUN√á√ÉO: onSuccess
		 * --------------------------------------------------------------------------------------
		 * üéØ OBJETIVO     : Callback executado ap√≥s upload bem-sucedido do PDF
		 * üì• ENTRADAS     : e [object] - Evento do Kendo Upload com dados dos arquivos
		 * üì§ SA√çDAS       : Renderiza PDF no viewer
		 * üîó CHAMADA POR  : kendoUpload success event
		 ****************************************************************************************/
		function onSuccess(e) {
			try {
				// [UI] Remove a DIV para excluir o PDF escolhido anteriormente
				$("#pdfViewer").remove();

				// [UI] Cria DIV do PDF
				$("#PDFContainer").append("<div id='pdfViewer'></div>");

				// [DADOS] Informa√ß√µes sobre os arquivos enviados
				var files = e.files;

				$.each(files, function () {
					console.log(this.name);

					// [DADOS] Remove acentos e caracteres especiais do nome do arquivo
					document.getElementById("txtRegistroPDF").setAttribute('value', TiraAcento(this.name));

					console.log(document.getElementById("txtRegistroPDF").value);

					// [KENDO] Inicializa o PDFViewer com o arquivo carregado
					$("#pdfViewer").kendoPDFViewer({
						pdfjsProcessing: {
							file: "/DadosEditaveis/Cupons/" + document.getElementById("txtRegistroPDF").value
						},
						width: "100%",
						height: 400
					}).data("kendoPDFViewer");
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "onSuccess", error);
			}
		}
	</script>
}
