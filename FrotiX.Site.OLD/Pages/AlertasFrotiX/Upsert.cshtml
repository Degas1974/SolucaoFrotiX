@* ****************************************************************************************
 * ‚ö° ARQUIVO: Pages/AlertasFrotiX/Upsert.cshtml (900 linhas + JavaScript inline complexo)
 * --------------------------------------------------------------------------------------
 * üéØ OBJETIVO     : Formul√°rio completo de cria√ß√£o e edi√ß√£o de alertas com sistema avan√ßado de recorr√™ncia V2
 * üì• ENTRADAS     : @page "/AlertasFrotiX/Upsert?id={AlertaId}" (opcional), @model UpsertModel, Model properties (Alerta, TiposList, FrequenciaList, UsuariosList, isEdicao), Form inputs (Syncfusion EJ2 TextBox, DropDownList, MultiSelect, DatePicker, TimePicker), Calendar modal (sele√ß√£o m√∫ltipla datas)
 * üì§ SA√çDAS       : HTML Form <form method="post" asp-page-handler="Submit/Edit">, POST tradicional, JavaScript preview mensagem, redirecionamento /AlertasFrotiX/AlertasFrotiX
 * üîó CHAMADA POR  : Bot√£o "Adicionar Alerta" em AlertasFrotiX.cshtml, Links de edi√ß√£o nas DataTables, Menu navega√ß√£o (Cadastros ‚Üí Alertas)
 * üîÑ CHAMA        : ~/js/cadastros/alertas_upsert.js, ~/js/cadastros/alertas_recorrencia.js, ~/css/alertaupsert.css, PageHandlers (OnPostSubmit, OnPostEdit)
 * üì¶ DEPEND√äNCIAS : Syncfusion EJ2 ASP.NET Core (commercial license): ejs-textbox, ejs-dropdownlist, ejs-multiselect, ejs-datepicker, ejs-timepicker, jQuery, Bootstrap 5.3.8 (modal calend√°rio), Google Fonts Outfit, Custom CSS alertaupsert.css, Custom JS Alerta.TratamentoErroComLinha()
 * üìù OBSERVA√á√ïES  : Total: 900 linhas. BUGS: TimePicker race condition (m√∫ltiplos event handlers created/open/rendered), Recorr√™ncia V2 sem valida√ß√£o cruzada (Semanal sem dias, Mensal sem datas), Calendar modal sem limite datas (sele√ß√£o retroativa infinita), MultiSelect usu√°rios sem lazy loading (performance +1000 usu√°rios), Form validation client-side fraca, CSS inline ~100 linhas conflita com alertaupsert.css, JavaScript inline ~100 linhas (l√≥gica calend√°rio deveria estar em alertas_upsert.js), Sem debounce no preview mensagem, DatePicker ranges n√£o respeitam fuso hor√°rio
 **************************************************************************************** *@
@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Syncfusion.EJ2

@model FrotiX.Pages.AlertasFrotiX.UpsertModel

@{
	ViewData["Title"] = Model.AlertasFrotiXId == Guid.Empty ? "Novo Alerta" : "Editar Alerta";
	ViewData["PageName"] = "alertasfrotix_upsert";
	ViewData["Heading"] = "<i class='fa-duotone fa-bell'></i> Sistema: <span class='fw-300'>Alertas</span>";
	ViewData["Category1"] = "Alertas";
	ViewData["PageIcon"] = "fa-duotone fa-bell";
}

@section HeadBlock {
	<link rel="stylesheet" href="~/css/alertaupsert.css" asp-append-version="true" />
	<style>
		/* Estilos espec√≠ficos para controles de recorr√™ncia */
		#divRecorrenciaAlerta .section-card {
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			margin-top: 1rem;
		}
		#divRecorrenciaAlerta .section-card-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 0.75rem 1rem;
			border-radius: 8px 8px 0 0;
			font-weight: 600;
		}
		#divRecorrenciaAlerta .section-card-body {
			padding: 1rem;
		}
	</style>
}

<script>
	// Captura erros globais
	window.onerror = function(msg, url, line, col, error) {
		try {
			console.error('Erro Global:', {
				mensagem: msg,
				arquivo: url,
				linha: line,
				coluna: col,
				erro: error
			});
			return true;
		} catch (err) {
			Alerta.TratamentoErroComLinha("Upsert.cshtml", "window.onerror", err);
			return true;
		}
	};

	// Monitora erros de Promise
	window.addEventListener('unhandledrejection', function(e) {
		try {
			console.error('Promise rejeitada:', e.reason);
			e.preventDefault();
		} catch (error) {
			Alerta.TratamentoErroComLinha("Upsert.cshtml", "unhandledrejection", error);
		}
	});
</script>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<!-- ===== HEADER FROTIX ===== -->
			<div class="ftx-card-header">
				<h2 class="titulo-paginas">
					<i class="fa-duotone fa-bell-plus"></i>
					@(Model.AlertasFrotiXId == Guid.Empty ? "Cadastrar Novo Alerta" : "Editar Alerta")
				</h2>
			</div>

			<div class="panel-container show">
				<div class="panel-content">
					<form id="formAlerta" method="post">
						<input type="hidden" id="AlertasFrotiXId" name="AlertasFrotiXId" value="@Model.AlertasFrotiXId" />

						<!-- Se√ß√£o: Informa√ß√µes B√°sicas -->
						<div class="section-legend">
							<i class="fa-duotone fa-info-circle"></i>
							<span>Informa√ß√µes B√°sicas</span>
						</div>

						<div class="row">
							<div class="col-md-8">
								<label class="label required-field">T√≠tulo do Alerta</label>
								<input type="text" id="Titulo" name="Titulo" class="form-control"
									   placeholder="Digite o t√≠tulo do alerta"
									   value="@Model.Titulo" />
								<span class="text-danger field-validation-valid" data-valmsg-for="Titulo"></span>
							</div>

							<div class="col-md-4">
								<label class="label required-field">Prioridade</label>
								<input id="Prioridade" name="Prioridade" style="width: 100%;" />
								<span class="text-danger field-validation-valid" data-valmsg-for="Prioridade"></span>
							</div>
						</div>

						<div class="row mt-3">
							<div class="col-md-12">
								<label class="label required-field">Descri√ß√£o</label>
								<textarea id="Descricao" name="Descricao" class="form-control" rows="3"
										  placeholder="Digite a descri√ß√£o detalhada do alerta">@Model.Descricao</textarea>
								<span class="text-danger field-validation-valid" data-valmsg-for="Descricao"></span>
							</div>
						</div>

						<!-- Se√ß√£o: Tipo de Alerta -->
						<div class="section-legend">
							<i class="fa-duotone fa-tags"></i>
							<span>Tipo de Alerta</span>
							<span class="legend-note">(Selecione o tipo)</span>
						</div>

						<div class="row mb-3">
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="1" data-ejtip="Selecionar tipo: Agendamento">
									<i class="fa-duotone fa-calendar-check" style="color: #0ea5e9;"></i>
									<div>Agendamento</div>
									<span class="preview-badge" style="background-color: #0ea5e9;">Agendamento</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="2" data-ejtip="Selecionar tipo: Manuten√ß√£o">
									<i class="fa-duotone fa-screwdriver-wrench" style="color: #f59e0b;"></i>
									<div>Manuten√ß√£o</div>
									<span class="preview-badge" style="background-color: #f59e0b;">Manuten√ß√£o</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="3" data-ejtip="Selecionar tipo: Motorista">
									<i class="fa-duotone fa-id-card-clip" style="color: #14b8a6;"></i>
									<div>Motorista</div>
									<span class="preview-badge" style="background-color: #14b8a6;">Motorista</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="4" data-ejtip="Selecionar tipo: Ve√≠culo">
									<i class="fa-duotone fa-car-bus" style="color: #7c3aed;"></i>
									<div>Ve√≠culo</div>
									<span class="preview-badge" style="background-color: #7c3aed;">Ve√≠culo</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="5" data-ejtip="Selecionar tipo: An√∫ncio">
									<i class="fa-duotone fa-bullhorn" style="color: #dc2626;"></i>
									<div>An√∫ncio</div>
									<span class="preview-badge" style="background-color: #dc2626;">An√∫ncio</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="6" data-ejtip="Selecionar tipo: Diversos">
									<i class="fa-duotone fa-circle-info" style="color: #6c757d;"></i>
									<div>Diversos</div>
									<span class="preview-badge" style="background-color: #6c757d;">Diversos</span>
								</div>
							</div>
						</div>
						<input type="hidden" id="TipoAlerta" name="TipoAlerta" value="@((int)Model.TipoAlerta)" />

						<!-- Se√ß√£o: V√≠nculos (aparece dinamicamente) -->
						<div id="secaoVinculos" style="display: none;">
							<div class="section-legend">
								<i class="fa-duotone fa-link"></i>
								<span>V√≠nculos</span>
								<span class="legend-note">(Opcional)</span>
							</div>

							<div class="row">
								<div class="col-md-6" id="divViagem" style="display: none;">
									<label class="label">Agendamento Relacionado</label>
								<input id="ViagemId" name="ViagemId" style="width: 100%;" />
								<div class="col-md-6" id="divManutencao" style="display: none;">
									<label class="label">Manuten√ß√£o Relacionada</label>
								<input id="ManutencaoId" name="ManutencaoId" style="width: 100%;" />
								<div class="col-md-6" id="divMotorista" style="display: none;">
									<label class="label">Motorista Relacionado</label>
								<input id="MotoristaId" name="MotoristaId" style="width: 100%;" />
								<div class="col-md-6" id="divVeiculo" style="display: none;">
									<label class="label">Ve√≠culo Relacionado</label>
								<input id="VeiculoId" name="VeiculoId" style="width: 100%;" />
								</div>
							</div>
						</div>

						<!-- Se√ß√£o: Configura√ß√µes de Exibi√ß√£o -->
						<div class="section-legend">
							<i class="fa-duotone fa-clock"></i>
							<span>Configura√ß√µes de Exibi√ß√£o</span>
						</div>

						<!-- Linha 1: Tipo de Exibi√ß√£o (sempre vis√≠vel) -->
						<div class="row">
							<div class="col-md-4">
								<label class="label required-field">Tipo de Exibi√ß√£o</label>
								<input id="TipoExibicao" style="width: 100%;" />
							</div>
						</div>

						<!-- Linha 2: Campos din√¢micos de Data/Hor√°rio/Expira√ß√£o -->
						<div class="row mt-3" id="rowCamposExibicao">
							<!-- Data de Exibi√ß√£o (TipoExibicao 3, 4, 5, 6, 7, 8) -->
							<div class="col-md-2" id="divDataExibicao" style="display: none;">
								<label class="label" id="lblDataExibicao">Data de Exibi√ß√£o</label>
								<input id="DataExibicao" name="DataExibicao" style="width: 100%;" />
							</div>

							<!-- Hor√°rio de Exibi√ß√£o (TipoExibicao 2, 3, 4, 5, 6, 7, 8) -->
							<div class="col-md-2" id="divHorarioExibicao" style="display: none;">
								<label class="label" id="lblHorarioExibicao">Hor√°rio de Exibi√ß√£o</label>
								<input id="HorarioExibicao" name="HorarioExibicao" style="width: 100%;" />
								<span class="text-danger field-validation-valid" data-valmsg-for="HorarioExibicao"></span>
							</div>

							<!-- Data de Expira√ß√£o (Todos os tipos) -->
							<div class="col-md-2" id="divDataExpiracao" style="display: none;">
								<label class="label">Data de Expira√ß√£o</label>
								<input id="DataExpiracao" name="DataExpiracao" style="width: 100%;" />
							</div>
						</div>

						<!-- ============================================================ -->
						<!-- SE√á√ÉO: CONFIGURA√á√ïES DE RECORR√äNCIA V2                       -->
						<!-- Controle via TipoExibicao (valores 4-8 s√£o recorrentes)     -->
						<!-- DataExibicao = in√≠cio, DataExpiracao = fim                   -->
						<!-- ============================================================ -->

						<!-- Campos de Recorr√™ncia (aparecem dinamicamente baseado em TipoExibicao) -->
						<div class="row mt-3" id="rowCamposRecorrencia">
							<!-- lstDiasAlerta - Dias da Semana (TipoExibicao = 5 Semanal ou 6 Quinzenal) -->
							<div class="col-md-6" id="divDiasAlerta" style="display: none;">
								<label class="label font-weight-bold">
									Dias da Semana
									<i class="fa-duotone fa-calendar-week field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<select id="lstDiasAlerta" name="DiasSemana" multiple="multiple" style="width: 100%;"></select>
							</div>

							<!-- lstDiasMesAlerta - Dia do M√™s (TipoExibicao = 7 Mensal) -->
							<div class="col-md-2" id="divDiaMesAlerta" style="display: none;">
								<label class="label font-weight-bold">
									Dia do M√™s
									<i class="fa-duotone fa-calendar-clock field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<input id="lstDiasMesAlerta" name="DiaMesRecorrencia" style="width: 100%;" />
							</div>
						</div>

						<!-- Calend√°rio para Dias Variados (TipoExibicao = 8) -->
						<div class="row mt-3" id="calendarContainerAlerta" style="display: none;">
							<div class="col-md-4 col-lg-3">
								<label class="label font-weight-bold d-block mb-2">
									Selecione as Datas
									<i class="fa-duotone fa-calendar-days field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<div style="position: relative; display: inline-block;">
									<!-- Badge laranja no canto superior direito do calend√°rio (40% dentro, 60% fora) -->
									<span id="badgeDatasSelecionadas" style="
										position: absolute;
										top: -10px;
										right: -10px;
										background: #ff8800;
										color: white;
										border-radius: 50%;
										width: 28px;
										height: 28px;
										display: none;
										align-items: center;
										justify-content: center;
										font-size: 12px;
										font-weight: 700;
										z-index: 100;
										box-shadow: 0 2px 4px rgba(0,0,0,0.2);
										border: 2px solid white;">0</span>
									
									<!-- Calend√°rio Syncfusion (sem card) -->
									<div id="calDatasSelecionadasAlerta"></div>
									
									<input type="hidden" id="DatasSelecionadas" name="DatasSelecionadas" value="@Model.DatasSelecionadas" />
								</div>
							</div>
						</div>

						<!-- FIM DA SE√á√ÉO DE RECORR√äNCIA -->

						<!-- Se√ß√£o: Destinat√°rios -->
						<div class="section-legend">
							<i class="fa-duotone fa-users"></i>
							<span>Destinat√°rios</span>
							<span class="legend-note">(Selecione os usu√°rios que receber√£o o alerta)</span>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label class="label required-field">Usu√°rios</label>
								<select id="UsuariosIds" name="UsuariosIds" multiple="multiple" style="width: 100%;"></select>
								<span class="text-danger field-validation-valid" data-valmsg-for="UsuariosIds"></span>
							</div>
						</div>

						<!-- Bot√µes de A√ß√£o -->
						<div class="row mt-4">
							<div class="col-md-12 d-flex justify-content-end gap-2">
								<button type="button" class="btn btn-ftx-fechar form-control" onclick="window.location.href='/AlertasFrotiX'" data-ftx-loading>
									<i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar Opera√ß√£o
								</button>
								<button type="submit" class="btn btn-azul btn-submit-spin form-control">
									<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
									@(Model.AlertasFrotiXId == Guid.Empty ? "Criar Alerta" : "Atualizar Alerta")
								</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

@section ScriptsBlock {
	<script src="~/js/alertasfrotix/alertas_upsert.js" asp-append-version="true"></script>
	<script src="~/js/alertasfrotix/alertas_recorrencia.js" asp-append-version="true"></script>

	<script>
		(function () {
			try {
				// ================================================================
				// KENDO DROPDOWNLIST INIT - Migrado de Syncfusion ejs-dropdownlist
				// ================================================================

				var dataPrioridade = @Html.Raw(Json.Serialize(Model.PrioridadesList));
				var dataViagens = @Html.Raw(Json.Serialize(Model.ViagensListCompleta));
				var dataManutencoes = @Html.Raw(Json.Serialize(Model.ManutencoesListCompleta));
				var dataMotoristas = @Html.Raw(Json.Serialize(Model.MotoristasList));
				var dataVeiculos = @Html.Raw(Json.Serialize(Model.VeiculosList));
				var dataTipoExibicao = @Html.Raw(Json.Serialize(Model.TipoExibicaoList));

				// Prioridade
				$("#Prioridade").kendoDropDownList({
					dataTextField: "text",
					dataValueField: "value",
					optionLabel: "Selecione a prioridade",
					dataSource: dataPrioridade,
					value: "@((int)Model.Prioridade)"
				});

				// ViagemId (Agendamento Relacionado)
				$("#ViagemId").kendoDropDownList({
					dataTextField: "dataInicial",
					dataValueField: "viagemId",
					optionLabel: "Selecione o agendamento",
					dataSource: dataViagens,
					filter: "contains",
					height: 400,
					value: "@(Model.ViagemId?.ToString() ?? "")"
				});

				// ManutencaoId
				$("#ManutencaoId").kendoDropDownList({
					dataTextField: "numOS",
					dataValueField: "manutencaoId",
					optionLabel: "Selecione a manuten√ß√£o",
					dataSource: dataManutencoes,
					filter: "contains",
					value: "@(Model.ManutencaoId?.ToString() ?? "")"
				});

				// MotoristaId
				$("#MotoristaId").kendoDropDownList({
					dataTextField: "text",
					dataValueField: "value",
					optionLabel: "Selecione o motorista",
					dataSource: dataMotoristas,
					filter: "contains",
					value: "@(Model.MotoristaId?.ToString() ?? "")"
				});

				// VeiculoId
				$("#VeiculoId").kendoDropDownList({
					dataTextField: "text",
					dataValueField: "value",
					optionLabel: "Selecione o ve√≠culo",
					dataSource: dataVeiculos,
					filter: "contains",
					value: "@(Model.VeiculoId?.ToString() ?? "")"
				});

				// TipoExibicao
				$("#TipoExibicao").kendoDropDownList({
					dataTextField: "text",
					dataValueField: "value",
					optionLabel: "Quando exibir o alerta",
					dataSource: dataTipoExibicao,
					filter: "contains",
					height: 300,
					value: "@((int)Model.TipoExibicao)"
				});

				// lstDiasMesAlerta (Dia do Mes - datasource gerado localmente)
				var dataDiasMes = [];
				for (var i = 1; i <= 31; i++) {
					dataDiasMes.push({ text: i.toString(), value: i });
				}
				$("#lstDiasMesAlerta").kendoDropDownList({
					dataTextField: "text",
					dataValueField: "value",
					optionLabel: "Selecione...",
					dataSource: dataDiasMes,
					height: 250,
					value: "@(Model.DiaMesRecorrencia?.ToString() ?? "")"
				});

			} catch (error) {
				console.error('Erro na inicializacao Kendo DropDownLists:', error);
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "kendoDropDownList.init", error);
			}
		})();
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			try {
				// ================================================================
				// KENDO DATEPICKER / TIMEPICKER / MULTISELECT INIT
				// Migrado de Syncfusion ejs-datepicker, ejs-timepicker, ejs-multiselect
				// ================================================================

				// DataExibicao
				$("#DataExibicao").kendoDatePicker({
					format: "dd/MM/yyyy",
					culture: "pt-BR",
					dateInput: { format: "dd/MM/yyyy", messages: { year: "yyyy", month: "MM", day: "dd" } },
					placeholder: "Selecione",
					value: @Html.Raw(Model.DataExibicao.HasValue ? "new Date(\"" + Model.DataExibicao.Value.ToString("yyyy-MM-dd") + "\")" : "null")
				});

				// DataExpiracao
				$("#DataExpiracao").kendoDatePicker({
					format: "dd/MM/yyyy",
					culture: "pt-BR",
					dateInput: { format: "dd/MM/yyyy", messages: { year: "yyyy", month: "MM", day: "dd" } },
					placeholder: "Selecione",
					value: @Html.Raw(Model.DataExpiracao.HasValue ? "new Date(\"" + Model.DataExpiracao.Value.ToString("yyyy-MM-dd") + "\")" : "null")
				});

				// HorarioExibicao
				$("#HorarioExibicao").kendoTimePicker({
					format: "HH:mm",
					culture: "pt-BR",
					interval: 15,
					dateInput: { format: "HH:mm", messages: { hour: "HH", minute: "mm" } },
					placeholder: "Selecione",
					value: @Html.Raw(Model.HorarioExibicao.HasValue ? "new Date(0,0,0," + Model.HorarioExibicao.Value.Hours + "," + Model.HorarioExibicao.Value.Minutes + ")" : "null")
				});

				// DataSource para dias da semana
				var dataDiasSemana = [
					{ Text: 'Domingo', Value: 0 },
					{ Text: 'Segunda-Feira', Value: 1 },
					{ Text: 'Ter√ßa-Feira', Value: 2 },
					{ Text: 'Quarta-Feira', Value: 3 },
					{ Text: 'Quinta-Feira', Value: 4 },
					{ Text: 'Sexta-Feira', Value: 5 },
					{ Text: 'S√°bado', Value: 6 }
				];

				// lstDiasAlerta (MultiSelect)
				$("#lstDiasAlerta").kendoMultiSelect({
					dataTextField: "Text",
					dataValueField: "Value",
					placeholder: "Selecione os dias...",
					dataSource: dataDiasSemana,
					autoClose: false,
					height: 250
				});

				// UsuariosIds (MultiSelect)
				var dataUsuarios = @Html.Raw(Json.Serialize(Model.UsuariosList));
				var usuariosPreSelecionados = @Html.Raw(Json.Serialize(Model.UsuariosIds));

				$("#UsuariosIds").kendoMultiSelect({
					dataTextField: "Text",
					dataValueField: "Value",
					placeholder: "Selecione os usu√°rios",
					dataSource: dataUsuarios,
					autoClose: false,
					value: usuariosPreSelecionados
				});

				// Inicializar Calendario para datas variadas
				if (typeof initCalendarioAlerta === 'function') {
					initCalendarioAlerta();
				}

				// Verificar estado inicial (modo edicao)
				if (typeof verificarEstadoRecorrenciaAlerta === 'function') {
					verificarEstadoRecorrenciaAlerta();
				}

			} catch (error) {
				console.error('Erro na inicializa√ß√£o:', error);
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "DOMContentLoaded.kendoControls", error);
			}
		});
	</script>

	<!-- TimePicker Kendo init j√° feito acima - bloco ej2_instances removido -->

	<!-- flatpickr bloco removido - TimePicker agora √© Kendo -->
}
