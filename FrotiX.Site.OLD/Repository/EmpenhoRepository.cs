/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘ ğŸš€ ARQUIVO: EmpenhoRepository.cs                                                                   â•‘
   â•‘ ğŸ“‚ CAMINHO: Repository/                                                                            â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ ğŸ¯ OBJETIVO DO ARQUIVO:                                                                            â•‘
   â•‘    RepositÃ³rio para notas de empenho orÃ§amentÃ¡rio vinculadas a contratos.                          â•‘
   â•‘    Fornece listagem com JOIN de contrato e atualizaÃ§Ã£o de registros.                               â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ ğŸ“‹ MÃ‰TODOS DISPONÃVEIS:                                                                            â•‘
   â•‘    â€¢ EmpenhoRepository(FrotiXDbContext db)                                                         â•‘
   â•‘    â€¢ GetEmpenhoListForDropDown()                                                                   â•‘
   â•‘    â€¢ Update(Empenho empenho)                                                                       â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ âš ï¸ OBSERVAÃ‡Ã•ES:                                                                                     â•‘
   â•‘    A listagem utiliza JOIN com Contrato e usa ContratoId como Value.                               â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using FrotiX.Data;
using FrotiX.Models;
using FrotiX.Repository.IRepository;
using Microsoft.AspNetCore.Mvc.Rendering;

namespace FrotiX.Repository
    {
    
    // â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    // â”‚ ğŸ¯ CLASSE: EmpenhoRepository                                                                  â”‚
    // â”‚ ğŸ“¦ HERDA DE: Repository                                                              â”‚
    // â”‚ ğŸ”Œ IMPLEMENTA: IEmpenhoRepository                                                             â”‚
    // â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    
    // RepositÃ³rio responsÃ¡vel por notas de empenho orÃ§amentÃ¡rio.
    // Centraliza listagens para UI e atualizaÃ§Ã£o de registros.
    
    public class EmpenhoRepository : Repository<Empenho>, IEmpenhoRepository
        {
        private new readonly FrotiXDbContext _db;

        
        // â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        // â”‚ âš¡ MÃ‰TODO: EmpenhoRepository                                                             â”‚
        // â”‚ ğŸ”— RASTREABILIDADE:                                                                      â”‚
        // â”‚    â¬…ï¸ CHAMADO POR : UnitOfWork, Services, Controllers                                     â”‚
        // â”‚    â¡ï¸ CHAMA       : base(db)                                                             â”‚
        // â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        
        // ğŸ¯ OBJETIVO:
        // Inicializar o repositÃ³rio com o contexto do banco de dados.
        
        
        
        // ğŸ“¥ PARÃ‚METROS:
        // db - Contexto do banco de dados da aplicaÃ§Ã£o.
        
        
        // Param db: InstÃ¢ncia de <see cref="FrotiXDbContext"/>.
        public EmpenhoRepository(FrotiXDbContext db) : base(db)
            {
            _db = db;
            }


        /********************************************************************************************
         * âš¡ MÃ‰TODO: GetEmpenhoListForDropDown
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ğŸ¯ OBJETIVO     : Retornar lista de notas de empenho com contrato para dropdown UI
         *
         * ğŸ“¥ ENTRADAS     : Nenhum parÃ¢metro
         *
         * ğŸ“¤ SAÃDAS       : IEnumerable<SelectListItem> - Notas formatadas com ano/nÃºmero contrato
         *
         * â¬…ï¸ CHAMADO POR  : Controllers de Empenho, FormulÃ¡rios de seleÃ§Ã£o
         *
         * â¡ï¸ CHAMA        : DbContext.Empenho, DbContext.Contrato, LINQ Join/OrderBy/Select
         *
         * ğŸ“ OBSERVAÃ‡Ã•ES  : [LOGICA] Join manual: Empenho + Contrato para enriquecimento de dados
         *                   Value Ã© ContratoId, nÃ£o EmpenhoId - para filtrar por contrato
         *********************************************************************************************/
        public IEnumerable<SelectListItem> GetEmpenhoListForDropDown()
            {
            // [LOGICA] Query com 3 operaÃ§Ãµes encadeadas:
            // 1. Join: Empenho com Contrato (chave: ContratoId)
            // 2. OrderBy: OrdenaÃ§Ã£o por nota de empenho
            // 3. Select: TransformaÃ§Ã£o em SelectListItem com formataÃ§Ã£o
            return _db.Empenho
            .Join(_db.Contrato,
                empenho => empenho.ContratoId,
                contrato => contrato.ContratoId,
                (empenho, contrato) => new { empenho, contrato })
            .OrderBy(o => o.empenho.NotaEmpenho)
            .Select(i => new SelectListItem()
                {
                // [DADOS] FormataÃ§Ã£o: NotaEmpenho (AnoContrato/NumeroContrato)
                Text = i.empenho.NotaEmpenho + "(" + i.contrato.AnoContrato + "/" + i.contrato.NumeroContrato + ")",
                // [LOGICA] Value Ã© ContratoId para filtrar por contrato associado
                Value = i.contrato.ContratoId.ToString()
                });
            }


        /********************************************************************************************
         * âš¡ MÃ‰TODO: Update
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * ğŸ¯ OBJETIVO     : Atualizar registro de empenho no banco de dados
         *
         * ğŸ“¥ ENTRADAS     : empenho [Empenho] - Entidade com dados atualizados
         *
         * ğŸ“¤ SAÃDAS       : void - AlteraÃ§Ãµes persistidas no DbContext
         *
         * â¬…ï¸ CHAMADO POR  : UnitOfWork.SaveAsync(), Controllers de ediÃ§Ã£o de Empenho
         *
         * â¡ï¸ CHAMA        : DbContext.Update(), DbContext.SaveChanges()
         *********************************************************************************************/
        public new void Update(Empenho empenho)
            {
            // [DB] Localizar entidade no contexto
            var objFromDb = _db.Empenho.FirstOrDefault(s => s.EmpenhoId == empenho.EmpenhoId);

            // [DB] Marcar como modificada e persistir
            _db.Update(empenho);
            _db.SaveChanges();

            }
        }
    }
